<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Среħа 2024 - Система управления документами</title>
    
    <!-- ПРОСТАЯ СИСТЕМА ОТЛАДКИ -->
    <script>
        // Простая функция для вывода логов прямо на форму
        window.showStatus = function(message, color = '#00ff00') {
            const debugMessages = document.getElementById('debugMessages');
            if (debugMessages) {
                const time = new Date().toLocaleTimeString();
                const line = document.createElement('div');
                line.style.color = color;
                line.style.marginBottom = '5px';
                line.textContent = `[${time}] ${message}`;
                debugMessages.appendChild(line);
                debugMessages.scrollTop = debugMessages.scrollHeight;
            }
            console.log(message);
        };
        
        // Перехватываем ошибки
        window.addEventListener('error', (e) => {
            showStatus(`❌ ОШИБКА: ${e.message}`, '#ff0000');
            showStatus(`Файл: ${e.filename}:${e.lineno}`, '#ff0000');
        });
        
        // Показываем что скрипт загрузился
        window.addEventListener('DOMContentLoaded', () => {
            showStatus('✅ JavaScript загружен', '#00ff00');
            showStatus('✅ DOMContentLoaded сработал', '#00ff00');
            
            // Проверяем Tauri
            if (window.__TAURI__) {
                showStatus('✅ Tauri API найден', '#00ff00');
            } else if (window.__TAURI_INTERNALS__) {
                showStatus('✅ Tauri INTERNALS найден', '#00ff00');
            } else {
                showStatus('❌ Tauri API НЕ НАЙДЕН!', '#ff0000');
            }
            
            // Проверяем window.api
            setTimeout(() => {
                if (window.api) {
                    showStatus('✅ window.api загружен', '#00ff00');
                    if (window.api.auth) {
                        showStatus('✅ window.api.auth существует', '#00ff00');
                    } else {
                        showStatus('❌ window.api.auth НЕ НАЙДЕН!', '#ff0000');
                    }
                } else {
                    showStatus('❌ window.api НЕ ЗАГРУЖЕН!', '#ff0000');
                    showStatus('tauri-adapter.js не загрузился', '#ff0000');
                }
            }, 1000);
        });
    </script>
    
    <!-- PDF.js для работы с PDF файлами -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- SheetJS для экспорта в Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafb; min-height: 100vh; padding: 0; color: #0a1628; }
        .container { max-width: 100%; margin: 0 auto; background: white; box-shadow: none; overflow: hidden; border: none; }
        .header { background: #114A9F; color: white; padding: 48px 60px; display: flex; align-items: center; gap: 30px; position: relative; overflow: hidden; }
        .header h1 { font-size: 36px; margin-bottom: 12px; font-weight: 700; letter-spacing: -1px; position: relative; z-index: 1; }
        .header p { opacity: 0.85; font-size: 16px; font-weight: 400; position: relative; z-index: 1; }
        .logo { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.12); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; color: white; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); position: relative; z-index: 1; }
        .nav-tabs { display: flex; background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 0 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); flex-wrap: nowrap; overflow-x: auto; }
        .nav-tab { flex: 1 1 auto; min-width: fit-content; padding: 18px 12px; text-align: center; background: none; border: none; cursor: pointer; font-size: 13px; font-weight: 500; color: #6b7280; transition: all 0.3s ease; border-bottom: 3px solid transparent; position: relative; white-space: nowrap; }
        .nav-tab.active { color: #114A9F; border-bottom: 3px solid #114A9F; font-weight: 600; }
        .nav-tab:hover:not(.active) { color: #114A9F; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #1e293b; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s ease; background: #ffffff; font-weight: 400; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #114A9F; box-shadow: 0 0 0 4px rgba(17, 74, 159, 0.08); background: #fafbfc; }
        .btn { padding: 14px 32px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-right: 12px; margin-bottom: 12px; letter-spacing: 0.3px; }
        .btn-primary { background: #114A9F; color: white; box-shadow: 0 4px 14px rgba(17, 74, 159, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 74, 159, 0.4); background: #0d3a7f; }
        .btn-success { background: #114A9F; color: white; box-shadow: 0 4px 14px rgba(17, 74, 159, 0.3); }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(17, 74, 159, 0.4); background: #0d3a7f; }
        .btn-danger { background: #ffffff; color: #dc2626; border: 2px solid #fecaca; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1); font-weight: 600; }
        .btn-danger:hover { background: #fef2f2; border-color: #fca5a5; transform: translateY(-1px); }
        .btn-secondary { background: #f1f5f9; color: #475569; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); font-weight: 600; }
        .btn-secondary:hover { background: #e2e8f0; color: #334155; transform: translateY(-1px); }
        .table-container { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .table-container.scrollable { max-height: 400px; overflow-y: auto; }
        .table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .table th { background: #212529; color: white; padding: 15px 10px; text-align: left; font-weight: 600; }
        .table td { padding: 12px 10px; border-bottom: 1px solid #dee2e6; }
        .table tr:hover { background: #f8f9fa; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #114A9F; color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 14px rgba(17, 74, 159, 0.3); }
        .stat-card .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 8px; color: white !important; }
        .stat-card .stat-label { font-size: 14px; opacity: 0.95; color: white !important; }
        .chart-container { background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .chart-title { font-size: 20px; font-weight: bold; color: #212529; margin-bottom: 20px; text-align: center; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-list { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px solid #e9ecef; }
        .invoice-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; transition: background 0.3s ease; }
        .invoice-item:hover { background: #f8f9fa; }
        .invoice-item:last-child { border-bottom: none; }
        .invoice-info { flex: 1; }
        .invoice-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .invoice-status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #212529; color: white; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid; position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; }
        .alert-success { background: #f8f9fa; color: #212529; border-color: #6c757d; }
        .alert-danger { background: #f8f9fa; color: #212529; border-color: #212529; }
        .section-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #e9ecef; }
        .company-info { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-items { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .delivery-items { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .totals { margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px; border: 2px solid #dee2e6; }
        .totals-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .totals-final { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #212529; margin-top: 15px; padding-top: 15px; border-top: 2px solid #212529; }
        .preview { background: white; border: 2px solid #dee2e6; border-radius: 12px; padding: 30px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .searchable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .searchable-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .searchable-input:focus {
            outline: none;
            border-color: #212529;
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item.selected {
            background: #212529;
            color: white;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            border: 2px solid #dee2e6;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #212529, #343a40);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        .login-form h2 {
            text-align: center;
            color: #212529;
            margin-bottom: 25px;
        }
        .login-error {
            color: #dc3545;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* ==========================================
           МОДАЛЬНОЕ ОКНО ПРОФИЛЯ КЛИЕНТА - НОВАЯ ВЕРСИЯ
           ========================================== */
        
        .client-profile-modal {
            width: 90% !important;
            max-width: 1300px !important;
            height: 92vh !important;
            max-height: 92vh !important;
            margin: 4vh auto !important;
            padding: 0 !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
        }

        /* Заголовок модального окна профиля - фиксированный */
        .client-profile-modal .client-card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #114A9F 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
            margin: 0;
            min-height: 90px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Футер модального окна профиля - фиксированный */
        .client-profile-modal .modal-footer {
            flex-shrink: 0;
            background: #ffffff;
            border-top: 2px solid #e9ecef;
            padding: 18px 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }

        /* Заголовок в карточке клиента (на странице списка) */
        .client-card .client-card-header {
            background: #114A9F;
            margin: -24px -24px 20px -24px;
            padding: 24px 28px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        /* Аватар клиента */
        .client-avatar {
            width: 65px;
            height: 65px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: bold;
            border: 3px solid rgba(255,255,255,0.4);
            flex-shrink: 0;
        }

        /* Информация о клиенте в заголовке */
        .client-title-info {
            flex: 1;
            min-width: 0;
        }

        .client-title-info h2 {
            margin: 0 0 6px 0;
            font-size: 26px;
            font-weight: 700;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.2;
        }

        .client-title-info p {
            margin: 0;
            opacity: 0.92;
            font-size: 15px;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }

        /* Контейнер секций - скроллируемая область */
        .profile-sections {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            padding: 32px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #f5f7fa;
            flex: 1;
            min-height: 0;
            align-content: start;
        }
        
        /* Стилизация скроллбара */
        .profile-sections::-webkit-scrollbar {
            width: 10px;
        }
        
        .profile-sections::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 10px;
        }
        
        .profile-sections::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%);
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .profile-sections::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0d3a7f 0%, #0a2d5f 100%);
        }

        /* Секция профиля */
        .profile-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e3e8ef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            height: fit-content;
            transition: box-shadow 0.3s ease;
        }

        .profile-section:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* Секция на всю ширину (статистика) */
        .profile-section[style*="grid-column"] {
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        /* Заголовки секций */
        .profile-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 17px;
            font-weight: 700;
            border-bottom: 3px solid #114A9F;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Поле данных */
        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #f0f3f7;
            gap: 20px;
        }

        .profile-field:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .profile-field-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 13px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .profile-field-value {
            color: #2c3e50;
            font-size: 14px;
            font-weight: 500;
            text-align: right;
            flex: 1;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.5;
        }

        /* Адрес */
        .profile-address {
            background: #f8fafc;
            border-radius: 10px;
            padding: 18px;
            border: 1px solid #e3e8ef;
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            color: #2c3e50;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.6;
            font-weight: 500;
        }

        .maps-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            align-self: flex-start;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        }

        .maps-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        /* Контакты */
        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e3e8ef;
            transition: all 0.2s ease;
        }
        

        .contact-item:hover {
            background: #ffffff;
            border-color: #114A9F;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .contact-item.clickable-contact {
            cursor: pointer;
        }

        .contact-item.clickable-contact:hover {
            background: #e8f4fd;
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .contact-item.clickable-contact:active {
            transform: translateY(0);
        }

        .contact-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .contact-icon.phone { background: #e8f5e9; color: #2e7d32; }
        .contact-icon.email { background: #e3f2fd; color: #114A9F; }
        .contact-icon.telegram { background: #e1f5fe; color: #114A9F; }
        .contact-icon.instagram { background: #fce4ec; color: #c2185b; }

        .contact-value {
            font-size: 13px;
            color: #2c3e50;
            font-weight: 500;
            overflow-wrap: break-word;
            word-break: break-word;
            flex: 1;
        }

        /* Теги сотрудничества */
        .collaboration-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .collab-tag {
            background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
        }

        .collab-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .collab-tag.installment { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .collab-tag.showcase { background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%); }
        .collab-tag.bar { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }

        .stat-card {
            background: #114A9F;
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 24px rgba(30, 58, 138, 0.4);
            background: #0d3a7f;
        }

        .stat-card .stat-number {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white !important;
        }

        .stat-card .stat-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.95;
            line-height: 1.4;
            color: white !important;
        }

        /* Заметки */
        .profile-notes {
            background: #f8fafc;
            border-radius: 10px;
            padding: 18px;
            border: 1px solid #e3e8ef;
            font-size: 14px;
            line-height: 1.6;
            color: #2c3e50;
            max-height: 100px;
            overflow-y: auto;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* График заказов клиента */
        #clientMonthlyChart {
            min-height: 220px;
        }
        
        #clientMonthlyChart::-webkit-scrollbar {
            height: 8px;
        }
        
        #clientMonthlyChart::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 10px;
        }
        
        #clientMonthlyChart::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #114A9F 0%, #0d3a7f 100%);
            border-radius: 10px;
        }
        
        #clientMonthlyChart::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #0d3a7f 0%, #114A9F 100%);
        }

        /* Таблица товаров клиента */
        #clientProductsTable table {
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #clientProductsTable::-webkit-scrollbar {
            height: 8px;
        }
        
        #clientProductsTable::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 10px;
        }
        
        #clientProductsTable::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #114A9F 0%, #0d3a7f 100%);
            border-radius: 10px;
        }
        
        #clientProductsTable::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(90deg, #0d3a7f 0%, #114A9F 100%);
        }

        /* Список истории списаний */
        #deductHistoryList::-webkit-scrollbar {
            width: 8px;
        }
        
        #deductHistoryList::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 10px;
        }
        
        #deductHistoryList::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%);
            border-radius: 10px;
        }
        
        #deductHistoryList::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #f5576c 0%, #f093fb 100%);
        }

        /* Селектор периода */
        .period-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e3e8ef;
        }

        .period-selector label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .period-selector select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 2px solid #e3e8ef;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .period-selector select:focus {
            outline: none;
            border-color: #114A9F;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Стили для сворачиваемой формы */
        .collapsible-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .section-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 20px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        /* Форма редактирования в модальном окне */
        .client-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            padding: 32px;
            background: #f5f7fa;
        }

        .form-section {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e3e8ef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .form-section h4 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 17px;
            font-weight: 700;
            border-bottom: 3px solid #114A9F;
            padding-bottom: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-actions {
            padding: 18px 32px;
            border-top: 2px solid #e9ecef;
            background: #ffffff;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }
        
        /* Улучшенные стили для кнопок в модальном окне */
        .client-profile-modal .btn {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        
        .client-profile-modal .btn-primary {
            background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .client-profile-modal .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
        }
        
        .client-profile-modal .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .client-profile-modal .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }
        
        .client-profile-modal .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .client-profile-modal .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
        }

        /* Стили для вкладок истории */
        .history-tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0;
        }

        .history-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-tab:hover {
            background: #f8f9fa;
            color: #333;
        }

        .history-tab.active {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .history-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
        }

        /* Стили для списка пользователей */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #333;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .user-details h5 {
            margin: 0 0 5px 0;
            color: #333;
            font-weight: 600;
        }

        .user-details p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==========================================
           АДАПТИВНОСТЬ МОДАЛЬНОГО ОКНА ПРОФИЛЯ
           ========================================== */
        
        /* Для экранов 1366px и меньше (ноутбуки) */
        @media screen and (max-width: 1400px) {
            .client-profile-modal {
                width: 95% !important;
                max-width: 1200px !important;
            }
            
            .profile-sections {
                padding: 28px;
                gap: 20px;
            }
            
            #logsModal .modal-content {
                max-width: 85vw !important;
                width: 700px !important;
                max-height: 80vh !important;
                margin: 3vh auto !important;
            }
        }
        
        /* Для маленьких экранов по высоте */
        @media screen and (max-height: 800px) {
            .client-profile-modal {
                height: 95vh !important;
                max-height: 95vh !important;
                margin: 2.5vh auto !important;
            }
            
            .client-profile-modal .client-card-header {
                padding: 18px 28px;
                min-height: 75px;
            }
            
            .client-avatar {
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            
            .client-title-info h2 {
                font-size: 22px;
            }
            
            .profile-sections {
                padding: 24px;
            }
            
            .modal-content {
                margin: 1% auto;
                max-height: 98vh;
                padding: 15px;
            }
            
            #clientDataPreview {
                padding: 10px;
                margin-top: 10px;
                max-height: 150px;
            }
        }
        
        /* Планшеты и средние экраны (до 1200px) */
        @media screen and (max-width: 1200px) {
            .profile-sections {
                gap: 18px;
                padding: 24px;
            }
            
            .profile-section {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Планшеты в портретной ориентации (до 900px) */
        @media screen and (max-width: 900px) {
            .client-profile-modal {
                width: 96% !important;
                height: 94vh !important;
                max-height: 94vh !important;
                margin: 3vh auto !important;
            }
            
            .profile-sections {
                grid-template-columns: 1fr !important;
                padding: 20px;
                gap: 20px;
            }
            
            .profile-section {
                padding: 18px;
            }
            
            .client-profile-modal .client-card-header {
                padding: 16px 20px;
                min-height: 70px;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }

            .client-form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .form-section {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        /* Мобильные устройства (до 600px) */
        @media screen and (max-width: 600px) {
            .client-profile-modal {
                width: 98% !important;
                height: 96vh !important;
                max-height: 96vh !important;
                margin: 2vh auto !important;
            }
            
            .client-profile-modal .client-card-header {
                padding: 14px 16px;
                min-height: 65px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .client-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .client-title-info h2 {
                font-size: 20px;
            }
            
            .client-title-info p {
                font-size: 13px;
            }
            
            .profile-sections {
                padding: 16px;
                gap: 16px;
            }
            
            .profile-section {
                padding: 16px;
            }
            
            .profile-section h3 {
                font-size: 15px;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .client-profile-modal .modal-footer {
                padding: 14px 16px;
                flex-wrap: wrap;
            }
            
            /* Адаптивность для графика клиента на мобильных */
            #clientMonthlyChart {
                min-height: 200px;
            }
            
            #clientMonthlyChart > div {
                gap: 8px !important;
                padding: 15px !important;
            }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
            margin: 0;
        }
        .close {
            background: none;
            border: none;
            font-size: 30px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .close:hover {
            background: #f8f9fa;
            color: #212529;
        }
        .reservation-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .reservation-checkbox input[type="checkbox"] {
            transform: scale(1.2);
            margin: 0;
        }
        
        .reservation-checkbox label {
            font-size: 12px;
            color: #666;
            margin: 0;
            text-align: center;
        }

        /* Стили для опций создания рачуна */
        .racun-option:hover {
            border-color: #17a2b8 !important;
            background: rgba(23, 162, 184, 0.05) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.15);
        }

        /* Стили для контейнера карточек клиентов */
        .clients-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 20px;
            padding: 10px;
            align-items: start;
        }

        /* Стили для карточек клиентов */
        .client-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(10, 36, 99, 0.08);
            min-height: 400px;
            max-height: fit-content;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }
        
        .client-card:hover {
            border-color: #114A9F;
            box-shadow: 0 12px 36px rgba(30, 58, 138, 0.15);
            transform: translateY(-4px);
        }

        .client-card[style*="display: none"] {
            display: none !important;
        }
        
        .client-card.editing {
            border-color: #28a745;
            box-shadow: 0 4px 20px rgba(40,167,69,0.3);
        }
        
        .client-card-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .client-name {
            flex: 1 1 100%;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.3;
        }
        
        .client-card-body {
            margin: 15px 0;
            flex: 1;
            overflow: hidden;
        }
        
        .client-info-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .client-info-row:hover {
            background: #f8f9fa;
        }
        
        .client-info-label {
            font-weight: 600;
            color: #666;
            font-size: 13px;
        }
        
        .client-info-value {
            color: #333;
            font-size: 14px;
            word-break: break-word;
        }
        
        .client-edit-form {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #28a745;
        }
        
        .client-edit-form.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }
        
        .client-card-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .client-card-actions .btn {
            width: 100%;
            margin: 0;
            padding: 6px 8px;
            font-size: 12px;
            white-space: nowrap;
            text-align: center;
            justify-content: center;
        }
        
        /* Адаптивность для контейнера карточек */
        @media (max-width: 1400px) {
            .clients-cards-container {
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            }
        }

        @media (max-width: 900px) {
            .clients-cards-container {
                grid-template-columns: 1fr;
            }
        }

        .client-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            margin-left: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .client-badge.required {
            background: rgba(255, 255, 255, 0.95);
            color: #114A9F;
            border: 1px solid rgba(255, 255, 255, 0.7);
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .nav-tab { min-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .invoice-items { grid-template-columns: 1fr; }
            .delivery-items { grid-template-columns: 1fr; }
            
            /* Адаптация модального окна логов для мобильных */
            #logsModal .modal-content {
                max-width: 95vw !important;
                width: 95vw !important;
                max-height: 90vh !important;
                margin: 2vh auto !important;
            }
            
            #logsModal .modal-footer {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            #logsModal .modal-footer button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        /* Стили для склада */
        .warehouse-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .product-group {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .group-header {
            padding: 15px 20px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
            gap: 15px;
        }

        .group-header:hover {
            background: #dee2e6;
        }

        .group-header > div:first-child {
            flex: 1;
            min-width: 0;
        }

        .group-header h4 {
            margin: 0 0 8px 0;
            color: #333;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            line-height: 1.4;
        }

        .group-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }

        .group-code-badge {
            background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .group-status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .group-status-rejection {
            background: #dc3545;
            color: white;
        }
        
        .group-status-replacement {
            background: #fd7e14;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .group-status-replacement:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(253, 126, 20, 0.4);
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            display: inline-block;
        }

        /* Адаптивность для заголовков групп */
        @media (max-width: 768px) {
            .group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .group-header h4 {
                font-size: 16px;
                width: 100%;
            }

            .group-info {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            .group-expand-icon {
                position: absolute;
                top: 15px;
                right: 20px;
            }
        }

        .group-expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .group-expanded .group-expand-icon {
            transform: rotate(90deg);
        }

        .group-content {
            padding: 20px;
            display: none;
            border-top: 1px solid #dee2e6;
        }

        .group-expanded .group-content {
            display: block;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .remaining-percentage {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .remaining-percentage.low {
            color: #dc3545;
        }

        .remaining-percentage.medium {
            color: #ffc107;
        }

        .add-products-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .products-in-group {
            margin-top: 15px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .quantity-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .group-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .group-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Подсветка обязательных полей */
        .required-field {
            background-color: #F4E285 !important;
            border-color: #F4E285 !important;
        }

        .required-field-error {
            background-color: #F4A259 !important;
            border-color: #F4A259 !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Стили для лейблов обязательных полей */
        .required-label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        /* Стили для вкладок типа пользователя */
        .user-type-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .user-type-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-type-tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .user-type-tab.active {
            background: white;
            color: #212529;
            border-bottom-color: #212529;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-form-section {
            transition: opacity 0.3s ease;
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        /* Улучшенные стили для модального окна добавления пользователя */
        #addUserModal .modal-content {
            max-width: 600px;
            width: 90%;
            margin: 8% auto;
        }

        #addUserModal .form-group {
            margin-bottom: 20px;
        }

        #addUserModal .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            display: block;
        }

        #addUserModal .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        #addUserModal .form-group input:focus {
            outline: none;
            border-color: #212529;
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }

        /* Стили для превью данных клиента */
        #clientDataPreview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease-in;
            max-height: 200px;
            overflow-y: auto;
        }

        #clientDataPreview h4 {
            color: #28a745;
            font-size: 16px;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #clientPreviewData {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 14px;
        }

        #clientPreviewData > div {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        #clientPreviewData strong {
            color: #495057;
            font-weight: 600;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Адаптивность для экранов 1366x768 */
        @media (max-width: 1366px) {
            #addUserModal .modal-content {
                max-width: 550px;
                margin: 5% auto;
            }

            .user-type-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            .user-form-section {
                padding: 18px;
            }

            #clientPreviewData {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            #addUserModal .modal-content {
                width: 95%;
                margin: 3% auto;
            }

            .user-type-tabs {
                flex-direction: column;
            }

            .user-type-tab {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .user-type-tab.active {
                border-right-color: #212529;
                border-bottom-color: transparent;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            #addUserModal .modal-footer {
                flex-direction: column;
                gap: 8px;
            }

            #addUserModal .modal-footer button {
                width: 100%;
            }
        }

        /* Дополнительные стили для улучшения UX */
        .user-type-tab span {
            margin-right: 8px;
            font-size: 16px;
        }

        .form-row .form-group:last-child {
            margin-bottom: 0;
        }

        #addUserModal .modal-body {
            padding: 0;
        }

        #addUserModal .user-form-section {
            margin: 0;
        }

        /* Стили для статусов документов */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-accepted {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        /* Модальное окно подтверждения удаления */
        .delete-confirm-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.2s ease;
        }
        
        .delete-confirm-content {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 15% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
            overflow: hidden;
        }
        
        .delete-confirm-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .delete-confirm-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .delete-confirm-body {
            padding: 30px 25px;
        }
        
        .delete-confirm-message {
            font-size: 16px;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .delete-confirm-details {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .delete-confirm-details strong {
            color: #dc3545;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .delete-confirm-details div {
            color: #495057;
            font-size: 15px;
            margin-bottom: 5px;
        }
        
        .delete-confirm-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .delete-confirm-footer button {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .delete-confirm-btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .delete-confirm-btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        .delete-confirm-btn-delete {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .delete-confirm-btn-delete:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Форма авторизации -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">СР</div>
                <h1>Среħа 2024</h1>
                <p>Система управления документами</p>
            </div>
            <div class="login-form">
                <h2>Вход в систему</h2>
                
                <!-- РЕЖИМ ОТЛАДКИ -->
                <div style="background: #00ff00; color: #000; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: bold; text-align: center; display: none;">
                    🔍 РЕЖИМ ОТЛАДКИ АКТИВЕН<br>
                    <span style="font-size: 12px; font-weight: normal;">Нажмите F12 чтобы увидеть логи</span>
                </div>
                
                <div class="form-group">
                    <label>Логин:</label>
                    <input type="text" id="loginUsername" placeholder="Введите логин" value="">
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="loginPassword" placeholder="Введите пароль" value="" onkeypress="if(event.key === 'Enter') authenticate()">
                </div>
                <button class="btn btn-primary" onclick="console.log('🖱️ Кнопка нажата!'); authenticate()">Войти</button>
                <div id="loginError" class="login-error" style="display: none;">Неверный логин или пароль</div>
                
                <!-- СТАТУС ОТЛАДКИ (скрыт) -->
                <div id="debugStatus" style="margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; font-family: monospace; font-size: 14px; color: #00ff00; max-height: 300px; overflow-y: auto; display: none;">
                    <div style="color: #ffa500; font-weight: bold; margin-bottom: 10px;">📊 СТАТУС ЗАГРУЗКИ:</div>
                    <div id="debugMessages">Ожидание...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 80px; height: auto; border-radius: 12px;">
            <div>
                <h1>Среħа 2024 ДОО</h1>
                <p>Система управления инвойсами и отпремницами</p>
                <p style="font-size: 14px; opacity: 0.8;">Београд, Стари Град, Мајке Јевросиме 35 | МБ: 22019309 | ПИБ: 114407658</p>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="openLogsModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">📋</span>
                    Логи
                </button>
                <button class="btn btn-secondary" onclick="openAddUserModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">👤</span>
                    Добавить пользователя
                </button>
                <button class="btn btn-secondary" onclick="openEditUsersModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">⚙️</span>
                    Редактировать пользователя
                </button>
                <button class="btn btn-danger" onclick="logout()" style="background: rgba(220,53,69,0.8); color: white; border-color: rgba(220,53,69,0.8);">
                    <span style="font-size: 16px; margin-right: 5px;">🚪</span>
                    Выход
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clients')">Клиенты</button>
            <button class="nav-tab" onclick="showTab('products')">Товары</button>
            <button class="nav-tab" onclick="showTab('warehouse')">Склад</button>
            <button class="nav-tab" onclick="showTab('invoice')">Документы</button>
            <button class="nav-tab" onclick="showTab('orders')">Заказы</button>
            <button class="nav-tab" onclick="showTab('expenses')">Расходы</button>
            <button class="nav-tab" onclick="showTab('statistics')">Статистика</button>
        </div>

        <!-- Клиенты -->
        <div id="clients" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Управление клиентами</h2>
                <button class="btn btn-primary" onclick="toggleClientForm()" id="toggleFormBtn">
                    <span id="toggleIcon">➕</span> Добавить клиента
                </button>
            </div>

            <!-- Поиск и фильтры -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                <div style="flex: 1; min-width: 250px;">
                    <input type="text" id="clientSearchInput" placeholder="🔍 Поиск клиента по названию..." style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" oninput="filterClients()">
                </div>
                <div style="min-width: 200px;">
                    <select id="clientTypeFilter" style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" onchange="filterClients()">
                        <option value="">🏢 Все типы клиентов</option>
                        <option value="Бар">🍺 Бар</option>
                        <option value="Ресторан">🍽️ Ресторан</option>
                        <option value="Отель">🏨 Отель</option>
                        <option value="Кальянная">💨 Кальянная</option>
                        <option value="Кафе">☕ Кафе</option>
                        <option value="Чайная">🍵 Чайная</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="resetClientFilters()" style="padding: 10px 20px;">
                    🔄 Сбросить
                </button>
            </div>
            
            <!-- Сворачиваемая форма создания клиента -->
            <div id="clientFormSection" class="collapsible-section" style="display: none;">
                <div class="section-header">
                    <h3>Создание нового клиента</h3>
                </div>
                
                <div class="client-form-grid">
                    <!-- Основная информация -->
                    <div class="form-section">
                        <h4>📋 Основная информация</h4>
                        <div class="form-group">
                            <label>Название компании *</label>
                            <input type="text" id="clientName" placeholder="Название компании">
                        </div>
                        <div class="form-group">
                            <label>Юридическое название *</label>
                            <input type="text" id="clientLegalName" placeholder="Полное юридическое название">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Матични број *</label>
                                <input type="text" id="clientMB" placeholder="Матични број">
                            </div>
                            <div class="form-group">
                                <label>ПИБ *</label>
                                <input type="text" id="clientPIB" placeholder="ПИБ">
                            </div>
                            <div class="form-group">
                                <label>Аббревиатура (4-5 букв)</label>
                                <input type="text" id="clientAbbreviation" placeholder="SVDA" maxlength="5" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 5)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Тип клиента</label>
                            <select id="clientType">
                                <option value="">Выберите тип</option>
                                <option value="Бар">🍺 Бар</option>
                                <option value="Ресторан">🍽️ Ресторан</option>
                                <option value="Отель">🏨 Отель</option>
                                <option value="Кальянная">💨 Кальянная</option>
                                <option value="Кафе">☕ Кафе</option>
                                <option value="Чайная">🍵 Чайная</option>
                            </select>
                        </div>
                        <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label>Контактное лицо</label>
                                <input type="text" id="clientContactPerson" placeholder="Имя контактного лица">
                            </div>
                            <div class="form-group">
                                <label>Статус контакта</label>
                                <select id="clientContactPersonStatus">
                                    <option value="">Не указан</option>
                                    <option value="Владелец">👑 Владелец</option>
                                    <option value="Директор">👔 Директор</option>
                                    <option value="Управляющий">📋 Управляющий</option>
                                    <option value="Закупщик">🛒 Закупщик</option>
                                    <option value="Бармен">🍸 Бармен</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Банковский счет</label>
                                <input type="text" id="clientBank" placeholder="Номер банковского счета">
                            </div>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="form-section">
                        <h4>📍 Адрес</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="manualAddressInput" style="width: auto;">
                                Ручной ввод адреса
                            </label>
                        </div>
                        
                        <!-- Автоматический ввод адреса -->
                        <div id="autoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Город *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientCity" placeholder="Введите название города..." autocomplete="off">
                                        <div class="dropdown-menu" id="clientCityDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Община *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientMunicipalityDropdown"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Улица *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientStreetDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Номер дома</label>
                                    <input type="text" id="clientHouseNumber" placeholder="Номер дома">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ручной ввод адреса -->
                        <div id="manualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>Полный адрес *</label>
                                <textarea id="clientManualAddress" placeholder="Введите полный адрес (например: Beograd, Stari grad, Knez Mihailova 5)" rows="3" style="resize: vertical;"></textarea>
                                <small style="color: #666; font-size: 12px;">Укажите полный адрес в произвольной форме</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ссылка на Google Maps</label>
                            <input type="text" id="clientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="form-section">
                        <h4>📞 Контактные данные</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Телефон</label>
                                <input type="text" id="clientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="clientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="clientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="clientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- Условия сотрудничества -->
                    <div class="form-section">
                        <h4>🤝 Условия сотрудничества</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                <input type="checkbox" id="clientInstallment" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 500;">Рассрочка оплаты</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                <input type="checkbox" id="clientShowcase" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 500;">Витрина</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                <input type="checkbox" id="clientBar" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 500;">Бар</span>
                            </label>
                        </div>
                        <div class="form-group" style="max-width: 200px;">
                            <label>Срок рассрочки (дни)</label>
                            <input type="text" id="clientInstallmentTerm" placeholder="Например: 30">
                        </div>
                        <div class="form-group">
                            <label>Примечания</label>
                            <textarea id="clientNotes" placeholder="Дополнительные примечания о клиенте" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="addClient()">✅ Добавить клиента</button>
                    <button class="btn btn-secondary" onclick="clearClientForm()">🗑️ Очистить форму</button>
                    <button class="btn btn-secondary" onclick="toggleClientForm()">❌ Свернуть</button>
                </div>
            </div>
            
            <!-- Блок логов удаления клиентов -->
            <div id="clientDeleteDebugBlock" style="display: none; margin-bottom: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; font-family: monospace; font-size: 13px; color: #00ff00; max-height: 300px; overflow-y: auto; border: 2px solid #333;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="color: #ffa500; font-weight: bold;">🗑️ ЛОГИ УДАЛЕНИЯ КЛИЕНТОВ:</div>
                    <button onclick="clearClientDeleteLogs()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">✕ Очистить</button>
                </div>
                <div id="clientDeleteMessages">Ожидание...</div>
            </div>
            
            <div id="clientsCardsContainer" class="clients-cards-container">
                <!-- Здесь будут карточки клиентов -->
            </div>
        </div>

        <!-- Товары -->
        <div id="products" class="tab-content">
            <h2>Управление товарами</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="toggleProductForm()" id="toggleProductFormBtn">
                    <span id="toggleProductIcon">➕</span> Добавить товар
                </button>
                <button class="btn btn-secondary" onclick="toggleCategoryManager()" id="toggleCategoryManagerBtn" style="background: #6c757d; color: white;">
                    <span id="toggleCategoryIcon">⚙️</span> Управление категориями
                </button>
            </div>
            
            <!-- Форма управления категориями (справа) -->
            <div id="categoryManagerSection" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #e9ecef;">
                <h3 style="margin-bottom: 20px; color: #114A9F;">⚙️ Управление категориями и субкатегориями</h3>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Категории -->
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 15px; color: #333;">📁 Категории</h4>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Новая категория</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newCategoryName" placeholder="Название категории" style="flex: 1;">
                                <button class="btn btn-success" onclick="addNewCategory()" style="white-space: nowrap;">➕ Добавить</button>
                            </div>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                            <table class="table" style="margin-bottom: 0;">
                                <thead>
                                    <tr><th>Название</th><th style="width: 80px;">Действия</th></tr>
                                </thead>
                                <tbody id="categoriesListBody">
                                    <!-- Категории загружаются динамически -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Субкатегории -->
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h4 style="margin-bottom: 15px; color: #333;">📂 Субкатегории</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label>Категория</label>
                            <select id="subcategoryCategorySelect" onchange="loadSubcategoriesForManager()">
                                <option value="">Выберите категорию</option>
                                <!-- Категории загружаются динамически -->
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Новая субкатегория</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newSubcategoryName" placeholder="Название субкатегории" style="flex: 1;">
                                <button class="btn btn-success" onclick="addNewSubcategory()" style="white-space: nowrap;">➕ Добавить</button>
                            </div>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                            <table class="table" style="margin-bottom: 0;">
                                <thead>
                                    <tr><th>Название</th><th style="width: 80px;">Действия</th></tr>
                                </thead>
                                <tbody id="subcategoriesListBody">
                                    <!-- Субкатегории загружаются динамически -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-secondary" onclick="toggleCategoryManager()">❌ Закрыть</button>
                </div>
            </div>
            
            <div id="productFormSection" style="display: none; margin-top: 20px;">
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Внутренний код *</label>
                        <input type="text" id="productInternalCode" placeholder="INT-001">
                    </div>
                    <div class="form-group">
                        <label>Код товара *</label>
                        <input type="text" id="productCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="productName" placeholder="Tieguanyin/Zeleni Čaj 210g">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Стоимость без НДС (RSD) *</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01" onblur="this.value = formatPrice(this.value)">
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="productCategory" onchange="updateSubcategoryOptions('productSubcategory', this.value)">
                            <option value="">Выберите категорию</option>
                            <!-- Категории загружаются динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Субкатегория</label>
                        <select id="productSubcategory">
                            <option value="">Сначала выберите категорию</option>
                            <!-- Субкатегории загружаются при выборе категории -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Вес (г)</label>
                        <input type="number" id="productWeight" placeholder="210" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Поставщик</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="productSupplierSearch" placeholder="Введите поставщика..." autocomplete="off" oninput="filterSupplierDropdown('productSupplierSearch', 'productSupplierDropdown')">
                            <input type="hidden" id="productSupplier" value="">
                            <div class="dropdown-menu" id="productSupplierDropdown"></div>
                        </div>
                        <small style="color: #666;">Начните вводить для поиска или введите нового поставщика</small>
                    </div>
                    <div class="form-group">
                        <label>Для клиента (опционально)</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="productClientSearch" placeholder="Введите клиента..." autocomplete="off">
                            <input type="hidden" id="productClient" value="">
                            <div class="dropdown-menu" id="productClientDropdown"></div>
                        </div>
                        <small style="color: #666;">Если выбрать клиента, товар появится у него во вкладке «Продукты»</small>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="addProduct()">✅ Добавить товар</button>
                <button class="btn btn-secondary" onclick="clearProductForm()">🔄 Очистить форму</button>
                <button class="btn btn-secondary" onclick="toggleProductForm()">❌ Свернуть</button>
            <button class="btn btn-success" onclick="showAllProductsForAdmin()" id="showAllProductsBtn" style="margin-left: 10px; display: none;">📋 Показать все товары</button>
            </div>
            </div>
            
            <!-- Панель поиска и фильтров -->
            <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e3e8ef;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: end;">
                    <!-- Поиск по названию -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">🔍 Поиск по названию</label>
                        <input type="text" id="productSearchInput" placeholder="Введите название товара..." 
                               oninput="filterAndSortProducts()" 
                               style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;">
                    </div>
                    
                    <!-- Сортировка -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">📊 Сортировка</label>
                        <select id="productSortFilter" onchange="filterAndSortProducts()" 
                                style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                            <option value="name_asc">По названию (А-Я)</option>
                            <option value="name_desc">По названию (Я-А)</option>
                            <option value="price_asc">Цена (по возрастанию)</option>
                            <option value="price_desc">Цена (по убыванию)</option>
                        </select>
                    </div>
                    
                    <!-- Фильтр по субкатегории -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">📂 Субкатегория</label>
                        <select id="productSubcategoryFilter" onchange="filterAndSortProducts()" 
                                style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                            <option value="">Все субкатегории</option>
                            <!-- Субкатегории загружаются динамически -->
                        </select>
                    </div>
                    
                    <!-- Фильтр по пользователю -->
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">👤 Пользователь</label>
                        <select id="productUserFilter" onchange="filterAndSortProducts()" 
                                style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                            <option value="">Все товары</option>
                            <option value="company">Компания продавец</option>
                        </select>
                    </div>
                </div>
                
                <!-- Кнопка сброса фильтров -->
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <span id="productsCountLabel" style="color: #666; font-size: 13px;">Найдено товаров: 0</span>
                    <button onclick="resetProductFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: background 0.2s;">
                        🔄 Сбросить фильтры
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr><th>Код</th><th>Название</th><th>Цена (RSD)</th><th>Категория</th><th>Субкатегория</th><th>Вес (г)</th><th>Пользователь</th><th>Действия</th></tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Склад -->
        <div id="warehouse" class="tab-content">
            <h2>Управление складом</h2>
            
            <!-- Виджеты запасов чая -->
            <div class="tea-stock-widgets" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Черный чай -->
                <div class="tea-stock-widget" style="background: #114A9F; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 14px rgba(17, 74, 159, 0.3);">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: white;">Черный чай</h3>
                    <div class="stock-amount" style="font-size: 24px; font-weight: bold; margin-bottom: 15px; color: white;">
                        <span id="blackTeaStock">0</span> г
                    </div>
                    <button class="btn btn-primary" onclick="openTeaStockModal('Crni Čaj')" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                        📦 Пополнить запас
                    </button>
                </div>
                
                <!-- Зеленый чай -->
                <div class="tea-stock-widget" style="background: white; color: #114A9F; padding: 20px; border-radius: 12px; text-align: center; border: 3px solid #114A9F; box-shadow: 0 4px 14px rgba(17, 74, 159, 0.2);">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #114A9F;">Зеленый чай</h3>
                    <div class="stock-amount" style="font-size: 24px; font-weight: bold; margin-bottom: 15px; color: #114A9F;">
                        <span id="greenTeaStock">0</span> г
                    </div>
                    <button class="btn btn-primary" onclick="openTeaStockModal('Zeleni Čaj')">
                        📦 Пополнить запас
                    </button>
                </div>
            </div>
            
            <!-- Кнопки для управления формами -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="toggleGroupCreationForm()" id="toggleGroupCreationBtn" style="padding: 12px 32px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);">
                    <span id="toggleGroupCreationIcon">➕</span> Создать новую группу
                </button>
                <button class="btn btn-success" onclick="toggleAdditionForm()" style="padding: 12px 32px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                    ➕ Добавить к существующей группе
                </button>
            </div>
            
            <!-- Форма создания группы товаров (сворачиваемая) -->
            <div class="warehouse-section" id="groupCreationForm" style="display: none; border: 2px solid #114A9F;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #114A9F; margin: 0;">📦 Создать новую группу товаров</h3>
                    <button class="btn btn-secondary" onclick="toggleGroupCreationForm()" style="padding: 8px 16px;">✕ Закрыть</button>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Код группы *</label>
                        <input type="text" id="groupCode" placeholder="GRP-001" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Название группы *</label>
                        <input type="text" id="groupName" placeholder="Зеленый чай премиум">
                    </div>
                    <div class="form-group">
                        <label>Поставщик</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="groupSupplierSearch" placeholder="Введите поставщика..." autocomplete="off" oninput="filterSupplierDropdown('groupSupplierSearch', 'groupSupplierDropdown')">
                            <input type="hidden" id="groupSupplier" value="">
                            <div class="dropdown-menu" id="groupSupplierDropdown"></div>
                        </div>
                        <small style="color: #666;">Начните вводить для поиска</small>
                    </div>
                    <div class="form-group">
                        <label>Дата отгрузки</label>
                        <input type="date" id="groupShipmentDate">
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; margin-top: 15px;">
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="groupCategory" onchange="loadGroupSubcategories()">
                            <option value="">Выберите категорию</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Субкатегория</label>
                        <select id="groupSubcategory">
                            <option value="">Сначала выберите категорию</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;"></div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Количество</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupQuantityType" style="flex: 0 0 80px;" onchange="calculateInitialStock()">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="groupQuantity" placeholder="1000" style="flex: 1;" oninput="calculateInitialStock()">
                            <span id="quantityUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Списание при поступлении</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupDeductionType" style="flex: 0 0 100px;" onchange="updateDeductionUnit()">
                                <option value="percentage">%</option>
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="groupDeduction" placeholder="5" value="5" step="0.1" style="flex: 1;" oninput="calculateInitialStock()">
                            <span id="deductionUnit" style="align-self: center; color: #666; min-width: 30px;">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Резервации на месяц</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupReservationType" style="flex: 0 0 80px;">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="groupReservation" placeholder="100" style="flex: 1;" oninput="calculateInitialStock()">
                            <span id="reservationUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <div style="padding: 12px; background: #e3f2fd; border-radius: 8px; flex: 1; border-left: 4px solid #114A9F;">
                            <div style="font-size: 12px; color: #1976d2; margin-bottom: 5px; font-weight: 600;">📊 Поступит на склад:</div>
                            <div id="calculatedStock" style="font-size: 20px; font-weight: 700; color: #1976d2;">0 г</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="createProductGroup()">Создать группу</button>
                    <button class="btn btn-secondary" onclick="clearGroupForm()">Очистить форму</button>
                </div>
            </div>

            <!-- Форма добавления к существующей группе -->
            <div class="warehouse-section" id="groupAdditionForm" style="display: none; margin-top: 30px; border: 2px solid #28a745;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #28a745;">📦 Добавить к существующей группе</h3>
                    <button class="btn btn-secondary" onclick="closeAdditionForm()" style="padding: 8px 16px;">✕ Закрыть</button>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Код группы *</label>
                        <input type="text" id="addGroupCode" placeholder="GRP-001" style="text-transform: uppercase;" oninput="checkExistingGroup()">
                        <div id="groupCodeStatus" style="margin-top: 8px; font-size: 13px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Дата отгрузки (опционально)</label>
                        <input type="date" id="addShipmentDate">
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Количество *</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="addQuantityType" style="flex: 0 0 80px;" onchange="calculateAdditionStock()">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="addQuantity" placeholder="1000" style="flex: 1;" oninput="calculateAdditionStock()">
                            <span id="addQuantityUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Списание при поступлении</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="addDeductionType" style="flex: 0 0 100px;" onchange="updateAddDeductionUnit()">
                                <option value="percentage">%</option>
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="addDeduction" placeholder="5" value="5" step="0.1" style="flex: 1;" oninput="calculateAdditionStock()">
                            <span id="addDeductionUnit" style="align-self: center; color: #666; min-width: 30px;">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Резервации на месяц</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="addReservationType" style="flex: 0 0 80px;">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="addReservation" placeholder="100" style="flex: 1;" oninput="calculateAdditionStock()">
                            <span id="addReservationUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <div style="padding: 12px; background: #d4edda; border-radius: 8px; flex: 1; border-left: 4px solid #28a745;">
                            <div style="font-size: 12px; color: #155724; margin-bottom: 5px; font-weight: 600;">📊 Будет добавлено на склад:</div>
                            <div id="calculatedAddStock" style="font-size: 20px; font-weight: 700; color: #155724;">0 г</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="addToExistingGroup()" style="padding: 12px 24px; font-size: 16px;">
                        ➕ Добавить к группе
                    </button>
                    <button class="btn btn-secondary" onclick="clearAdditionForm()">Очистить форму</button>
                </div>
            </div>

            <!-- Список групп товаров -->
            <div class="warehouse-section" style="margin-top: 30px;">
                <!-- Вкладки Склад / Списано -->
                <div class="warehouse-tabs" style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #dee2e6;">
                    <button class="warehouse-tab-btn active" onclick="switchWarehouseTab('active')" id="warehouseActiveTabBtn" style="padding: 12px 30px; border: none; background: #114A9F; color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; margin-right: 5px;">
                        📦 Склад
                    </button>
                    <button class="warehouse-tab-btn" onclick="switchWarehouseTab('written-off')" id="warehouseWrittenOffTabBtn" style="padding: 12px 30px; border: none; background: #e9ecef; color: #495057; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                        🗑️ Списано
                    </button>
                </div>
                
                <!-- Контент вкладки Склад -->
                <div id="warehouseActiveContent">
                    <h3>Группы товаров</h3>
                
                    <!-- Поиск и фильтры групп -->
                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e3e8ef;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <!-- Поиск по названию/коду -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">🔍 Поиск по названию или коду</label>
                            <input type="text" id="groupSearchInput" placeholder="Введите название или код группы..." 
                                   oninput="filterAndSortGroups()" 
                                   style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;">
                        </div>
                        
                        <!-- Фильтр по категории -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">📁 Категория</label>
                            <select id="groupCategoryFilter" onchange="filterAndSortGroups()" 
                                    style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                                <option value="">Все категории</option>
                            </select>
                        </div>
                        
                        <!-- Фильтр по поставщику -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">🏭 Поставщик</label>
                            <select id="groupSupplierFilter" onchange="filterAndSortGroups()" 
                                    style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                                <option value="">Все поставщики</option>
                            </select>
                        </div>
                        
                        <!-- Сортировка -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">📊 Сортировка</label>
                            <select id="groupSortFilter" onchange="filterAndSortGroups()" 
                                    style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                                <option value="name_asc">По названию (А-Я)</option>
                                <option value="name_desc">По названию (Я-А)</option>
                                <option value="code_asc">По коду (А-Я)</option>
                                <option value="code_desc">По коду (Я-А)</option>
                                <option value="quantity_asc">По остатку (меньше)</option>
                                <option value="quantity_desc">По остатку (больше)</option>
                                <option value="date_asc">По дате (старые)</option>
                                <option value="date_desc">По дате (новые)</option>
                            </select>
                        </div>
                        
                        <!-- Кнопка сброса -->
                        <button class="btn btn-secondary" onclick="resetGroupFilters()" 
                                style="padding: 10px 20px; border-radius: 8px; white-space: nowrap;">
                            🔄 Сбросить
                        </button>
                    </div>
                    
                    <!-- Счётчик результатов -->
                    <div style="margin-top: 10px; font-size: 13px; color: #666;">
                        Найдено групп: <span id="groupsCountDisplay" style="font-weight: 600; color: #114A9F;">0</span>
                    </div>
                </div>
                
                <div id="productGroupsList">
                    <!-- Здесь будут отображаться группы товаров -->
                </div>
                </div>
                
                <!-- Контент вкладки Списано -->
                <div id="warehouseWrittenOffContent" style="display: none;">
                    <h3>Списанные группы</h3>
                    
                    <!-- Поиск и фильтры списанных -->
                    <div style="margin: 20px 0; padding: 20px; background: #fff5f5; border-radius: 12px; border: 1px solid #f5c6cb;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #721c24; font-size: 13px;">🔍 Поиск</label>
                                <input type="text" id="writtenOffSearchInput" placeholder="Поиск по названию или коду..." 
                                       oninput="filterWrittenOffGroups()" 
                                       style="width: 100%; padding: 10px 14px; border: 2px solid #f5c6cb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #721c24; font-size: 13px;">📋 Причина</label>
                                <select id="writtenOffReasonFilter" onchange="filterWrittenOffGroups()" 
                                        style="width: 100%; padding: 10px 14px; border: 2px solid #f5c6cb; border-radius: 8px; font-size: 14px; background: white;">
                                    <option value="">Все причины</option>
                                    <option value="rejection">Отказ</option>
                                    <option value="replacement">Замена</option>
                                    <option value="manual">Списание</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #721c24; font-size: 13px;">📊 Сортировка</label>
                                <select id="writtenOffSortFilter" onchange="filterWrittenOffGroups()" 
                                        style="width: 100%; padding: 10px 14px; border: 2px solid #f5c6cb; border-radius: 8px; font-size: 14px; background: white;">
                                    <option value="date_desc">По дате (новые)</option>
                                    <option value="date_asc">По дате (старые)</option>
                                    <option value="name_asc">По названию (А-Я)</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="resetWrittenOffFilters()" style="padding: 10px 20px; border-radius: 8px;">
                                🔄 Сбросить
                            </button>
                        </div>
                        <div style="margin-top: 10px; font-size: 13px; color: #721c24;">
                            Списано групп: <span id="writtenOffCountDisplay" style="font-weight: 600;">0</span>
                        </div>
                    </div>
                    
                    <div id="writtenOffGroupsList">
                        <p style="text-align: center; color: #666; margin: 40px 0;">Нет списанных групп</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Создать инвойс -->
        <div id="invoice" class="tab-content">
            <!-- Внутренние вкладки -->
            <div class="invoice-inner-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">
                <button class="inner-tab-btn active" onclick="switchInvoiceInnerTab('invoice-form')" id="invoiceFormTabBtn" style="padding: 10px 25px; border: none; background: #114A9F; color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                    📄 Создать инвойс
                </button>
                <button class="inner-tab-btn" onclick="switchInvoiceInnerTab('delivery-form')" id="deliveryFormTabBtn" style="padding: 10px 25px; border: none; background: #e9ecef; color: #495057; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px;">
                    🚚 Создать отпремницу
                </button>
            </div>
            
            <!-- Вкладка создания инвойса -->
            <div id="invoice-form-content" class="inner-tab-content">
                <h2>Создать инвойс</h2>
            
                <div class="company-info">
                <h3>Поставщик</h3>
                <p><strong>Среħа 2024 ДОО Београд (Стари Град)</strong></p>
                <p>Матични број: 22019309 | ПИБ: 114407658</p>
                <p>Седиште: Београд, Стари Град, Мајке Јевросиме 35</p>
                <p>Рачун: 190-0000000085540-29 (Alta Banka)</p>
            </div>

            <div class="section-card">
                <h3>Основные данные</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Номер инвойса *</label>
                        <input type="text" id="invoiceNumber" placeholder="1-DDMMYYYY">
                    </div>
                    <div class="form-group">
                        <label>Дата *</label>
                        <input type="date" id="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label>Срок оплаты *</label>
                        <input type="date" id="invoiceDueDate">
                    </div>
                    <div class="form-group">
                        <label>Клиент *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="invoiceClientSearch" placeholder="Введите название клиента..." autocomplete="off">
                            <input type="hidden" id="invoiceClient" value="">
                            <div class="dropdown-menu" id="invoiceClientDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Способ доставки</label>
                        <select id="invoiceDelivery">
                            <option value="сопствени превоз">Сопствени превоз</option>
                            <option value="курирска служба">Курирская служба</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>НДС (%)</label>
                        <select id="invoiceVAT">
                            <option value="0">0%</option>
                            <option value="20">20%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Позив на број</label>
                        <input type="text" id="invoiceReference" placeholder="97-12345678" maxlength="20">
                        <small style="color: #666; font-size: 12px;">Опционально. Например: 97-12345678</small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="differentDeliveryAddress" style="width: auto;">
                            Адрес доставки отличается от адреса седишта
                        </label>
                    </div>
                </div>
            </div>

            <!-- Адрес доставки -->
            <div id="deliveryAddressSection" class="section-card" style="display: none;">
                <h3>Адрес доставки</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Город *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryCity" placeholder="Введите название города..." autocomplete="off">
                            <div class="dropdown-menu" id="deliveryCityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Община *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryMunicipalityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Улица *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryStreetDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Номер дома</label>
                        <input type="text" id="deliveryHouseNumber" placeholder="Номер дома">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>Товары</h3>
                <div id="invoiceItems">
                    <div class="invoice-items">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                                <input type="hidden" class="invoice-product" value="">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="invoice-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Цена (RSD)</label>
                            <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Сумма (RSD)</label>
                            <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="reservation-checkbox">
                            <input type="checkbox" class="invoice-reservation" id="reservation-0">
                            <label for="reservation-0">Резервация</label>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addInvoiceItem()">Добавить товар</button>
                
                <div class="totals">
                    <div class="totals-row">
                        <span>Подтотал:</span>
                        <span id="invoiceSubtotal">0.00 RSD</span>
                    </div>
                    <div class="totals-row">
                        <span>НДС:</span>
                        <span id="invoiceVATAmount">0.00 RSD</span>
                    </div>
                    <div class="totals-final">
                        <span>ИТОГО:</span>
                        <span id="invoiceTotal">0.00 RSD</span>
                    </div>
                </div>
            </div>

            <!-- Поле для ввода оплаты по предрачуну -->
            <div style="max-width: 600px; margin: 20px auto; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block;">Оплата по предрачуну (за уплату):</label>
                    <input type="number" id="predracunPayment" placeholder="Введите сумму к оплате" step="0.01" min="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ced4da; border-radius: 6px;" oninput="updatePaymentInfo()">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">Эта сумма будет указана в документе как "За уплату" (предрачун) или "Плаћено" и "За уплату" (рачун)</small>
                </div>
            </div>

            <!-- Debug блок для логов создания инвойса -->
            <div id="invoiceDebugBlock" style="background: #000; color: #0f0; padding: 15px; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto; border: 2px solid #0f0; border-radius: 5px; display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <strong style="color: #0ff;">📋 ЛОГИ СОЗДАНИЯ ИНВОЙСА</strong>
                    <button onclick="document.getElementById('invoiceDebugBlock').style.display='none'" style="background: #f00; color: #fff; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px;">✕</button>
                </div>
                <div id="invoiceDebugContent" style="white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="generateInvoice()">Сгенерировать предрачун</button>
                <button class="btn btn-primary" onclick="generateRacun('button')">Создать рачун</button>
                <button class="btn btn-success" id="confirmInvoiceBtn">Утвердить предрачун</button>
                <button class="btn btn-secondary" onclick="generateDeliveryFromInvoice()">Создать отпремницу</button>
            </div>
            
            <div id="invoicePreview" class="preview" style="display: none;">
                <h3>Предпросмотр инвойса</h3>
                <div id="invoiceContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportInvoiceToPDF()">Экспорт PDF</button>
                    <button class="btn btn-secondary" onclick="downloadInvoiceAsHTML()">Скачать HTML</button>
                    <button class="btn btn-secondary" onclick="copyInvoiceToClipboard()">Копировать</button>
                </div>
                <div id="invoiceConfirmMessage" style="display: none; margin-top: 15px;" class="alert alert-success">
                    Инвойс утвержден и добавлен в статистику продаж!
                </div>
            </div>
            </div>
            
            <!-- Вкладка создания отпремницы -->
            <div id="delivery-form-content" class="inner-tab-content" style="display: none;">
                <h2>Создать отпремницу</h2>
            
                <div class="company-info">
                    <h3>Отправитель</h3>
                    <p><strong>Среħа 2024 ДОО Београд (Стари Град)</strong></p>
                    <p>Матични број: 22019309 | ПИБ: 114407658</p>
                    <p>Седиште: Београд, Стари Град, Мајке Јевросиме 35</p>
                </div>

                <div class="section-card">
                    <h3>Основные данные</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Номер отпремницы *</label>
                            <input type="text" id="deliveryNumber" placeholder="1-DDMMYYYY">
                        </div>
                        <div class="form-group">
                            <label>Дата *</label>
                            <input type="date" id="deliveryDate">
                        </div>
                        <div class="form-group">
                            <label>Срок поставки *</label>
                            <input type="date" id="deliveryDueDate">
                        </div>
                        <div class="form-group">
                            <label>Получатель *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input" id="deliveryClientSearch" placeholder="Введите название получателя..." autocomplete="off">
                                <input type="hidden" id="deliveryClient" value="">
                                <div class="dropdown-menu" id="deliveryClientDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Способ доставки</label>
                            <select id="deliveryMethod">
                                <option value="сопствени превоз">Сопствени превоз</option>
                                <option value="курирска служба">Курирская служба</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="otpremnicaDifferentAddress" style="width: auto;">
                                Адрес доставки отличается от адреса седишта
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Адрес доставки для отпремницы -->
                <div id="otpremnicaDeliveryAddressSection" class="section-card" style="display: none;">
                    <h3>Адрес доставки</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Город *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input" id="otpremnicaDeliveryCity" placeholder="Введите название города..." autocomplete="off">
                                <div class="dropdown-menu" id="otpremnicaDeliveryCityDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Община *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input" id="otpremnicaDeliveryMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                                <div class="dropdown-menu" id="otpremnicaDeliveryMunicipalityDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Улица *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input" id="otpremnicaDeliveryStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                                <div class="dropdown-menu" id="otpremnicaDeliveryStreetDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Номер дома</label>
                            <input type="text" id="otpremnicaDeliveryHouseNumber" placeholder="Номер дома">
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <h3>Товары</h3>
                    <div id="deliveryItems">
                        <div class="delivery-items">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Товар *</label>
                                <div class="searchable-select">
                                    <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                                    <input type="hidden" class="delivery-product" value="">
                                    <div class="dropdown-menu delivery-product-dropdown"></div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Количество</label>
                                <input type="number" class="delivery-quantity" value="1" min="1">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Единица</label>
                                <input type="text" class="delivery-unit" value="ком" readonly>
                            </div>
                            <div style="padding-top: 25px;">
                                <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addDeliveryItem()">Добавить товар</button>
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="generateDelivery()">Сгенерировать отпремницу</button>
                    <button class="btn btn-success" onclick="confirmDelivery()">Утвердить отпремницу</button>
                </div>
            
                <div id="deliveryPreview" class="preview" style="display: none;">
                    <h3>Предпросмотр отпремницы</h3>
                    <div id="deliveryContent"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="printDelivery()">Экспорт PDF</button>
                    </div>
                </div>

                <div class="invoice-list" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Утвержденные отпремницы</h3>
                        <div class="form-group" style="margin: 0; width: 300px;">
                            <select id="deliveryClientFilter" style="margin: 0;" onchange="filterDeliveriesByClient()">
                                <option value="">Все клиенты</option>
                            </select>
                        </div>
                    </div>
                    <div id="confirmedDeliveriesList">
                        <p style="text-align: center; color: #666;">Нет утвержденных отпремниц</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Заказы -->
        <div id="orders" class="tab-content">
            <h2>Заказы</h2>
            <div class="section-card">
                <h3>Поступившие заказы</h3>
                <div class="table-container">
                    <table class="table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>№ заказа</th>
                                <th>Клиент</th>
                                <th>Дата</th>
                                <th>Товары</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666;">Заказы не найдены</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Расходы -->
        <div id="expenses" class="tab-content">
            <!-- Секция: Поставщики -->
            <div class="section-card" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">🏭 Поставщики</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="toggleSupplierSectorManager()" id="toggleSectorManagerBtn">
                            ⚙️ Управление секторами
                        </button>
                        <button class="btn btn-primary" onclick="toggleSupplierForm()" id="toggleSupplierFormBtn">
                            <span id="toggleSupplierIcon">➕</span> Добавить поставщика
                        </button>
                    </div>
                </div>

                <!-- Поиск и фильтры -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="supplierSearchInput" placeholder="🔍 Поиск поставщика по названию..." style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" oninput="filterSuppliers()">
                    </div>
                    <div style="min-width: 200px;">
                        <select id="supplierSectorFilter" style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" onchange="filterSuppliers()">
                            <option value="">🏭 Все секторы</option>
                            <!-- Секторы загружаются динамически -->
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="resetSupplierFilters()" style="padding: 10px 20px;">
                        🔄 Сбросить
                    </button>
                </div>

                <!-- Форма управления секторами (скрыта по умолчанию) -->
                <div id="sectorManagerSection" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #e9ecef;">
                    <h3 style="margin-bottom: 20px; color: #114A9F;">⚙️ Управление секторами и продукцией</h3>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Секторы -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 15px; color: #333;">🏭 Секторы</h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Новый сектор</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newSectorName" placeholder="Название сектора" style="flex: 1;">
                                    <button class="btn btn-success" onclick="addNewSector()" style="white-space: nowrap;">➕ Добавить</button>
                                </div>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                                <table class="table" style="margin-bottom: 0;">
                                    <thead>
                                        <tr><th>Название</th><th style="width: 80px;">Действия</th></tr>
                                    </thead>
                                    <tbody id="sectorsListBody">
                                        <!-- Секторы загружаются динамически -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Продукция -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 15px; color: #333;">📦 Продукция</h4>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label>Сектор</label>
                                <select id="productSectorSelect" onchange="loadProductsForSectorManager()">
                                    <option value="">Выберите сектор</option>
                                    <!-- Секторы загружаются динамически -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Новая продукция</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newSupplierProductName" placeholder="Название продукции" style="flex: 1;">
                                    <button class="btn btn-success" onclick="addNewSupplierProduct()" style="white-space: nowrap;">➕ Добавить</button>
                                </div>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                                <table class="table" style="margin-bottom: 0;">
                                    <thead>
                                        <tr><th>Название</th><th style="width: 80px;">Действия</th></tr>
                                    </thead>
                                    <tbody id="supplierProductsListBody">
                                        <!-- Продукция загружается динамически -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="toggleSupplierSectorManager()">❌ Закрыть</button>
                    </div>
                </div>

                <!-- Сворачиваемая форма создания поставщика -->
                <div id="supplierFormSection" class="collapsible-section" style="display: none;">
                    <div class="section-header">
                        <h3>Создание нового поставщика</h3>
                    </div>
                    
                    <div class="client-form-grid">
                        <!-- Основная информация -->
                        <div class="form-section">
                            <h4>📋 Основная информация</h4>
                            <div class="form-group">
                                <label>Название компании *</label>
                                <input type="text" id="supplierName" placeholder="Название поставщика">
                            </div>
                            <div class="form-group">
                                <label>Юридическое название</label>
                                <input type="text" id="supplierLegalName" placeholder="Полное юридическое название">
                            </div>
                            <div class="form-group">
                                <label>Страна *</label>
                                <select id="supplierCountry" onchange="onSupplierCountryChange()">
                                    <option value="">Выберите страну</option>
                                    <!-- Страны загружаются динамически -->
                                </select>
                            </div>
                            <div class="form-row" id="supplierRegFieldsRow">
                                <div class="form-group" id="supplierMBGroup">
                                    <label id="supplierMBLabel">Матични број</label>
                                    <input type="text" id="supplierMB" placeholder="Матични број">
                                </div>
                                <div class="form-group" id="supplierPIBGroup">
                                    <label id="supplierPIBLabel">ПИБ</label>
                                    <input type="text" id="supplierPIB" placeholder="ПИБ">
                                </div>
                            </div>
                            <!-- Скрытое поле для рег. номера (для не-сербских компаний) -->
                            <div class="form-group" id="supplierRegNumberGroup" style="display: none;">
                                <label>Рег. номер</label>
                                <input type="text" id="supplierRegNumber" placeholder="Регистрационный номер компании">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Сектор *</label>
                                    <select id="supplierSector" onchange="updateSupplierProductOptions()">
                                        <option value="">Выберите сектор</option>
                                        <!-- Секторы загружаются динамически -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Продукция</label>
                                    <select id="supplierProduct">
                                        <option value="">Сначала выберите сектор</option>
                                        <!-- Продукция загружается при выборе сектора -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Контактное лицо</label>
                                    <input type="text" id="supplierContactPerson" placeholder="Имя контактного лица">
                                </div>
                                <div class="form-group">
                                    <label>Статус контакта</label>
                                    <select id="supplierContactPersonStatus">
                                        <option value="">Не указан</option>
                                        <option value="Владелец">👑 Владелец</option>
                                        <option value="Директор">👔 Директор</option>
                                        <option value="Менеджер">📋 Менеджер</option>
                                        <option value="Логист">🚚 Логист</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Банковский счет</label>
                                <input type="text" id="supplierBank" placeholder="Номер банковского счета">
                            </div>
                        </div>

                        <!-- Адрес и контакты -->
                        <div class="form-section">
                            <h4>📍 Адрес и контакты</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Город</label>
                                    <input type="text" id="supplierCity" placeholder="Город">
                                </div>
                                <div class="form-group">
                                    <label>Адрес</label>
                                    <input type="text" id="supplierAddress" placeholder="Полный адрес">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ссылка на Google Maps</label>
                                <input type="text" id="supplierGoogleMaps" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Телефон</label>
                                    <input type="text" id="supplierPhone" placeholder="+381 XX XXX XXXX">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="supplierEmail" placeholder="email@example.com">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Telegram</label>
                                    <input type="text" id="supplierTelegram" placeholder="@username">
                                </div>
                                <div class="form-group">
                                    <label>Instagram</label>
                                    <input type="text" id="supplierInstagram" placeholder="@username">
                                </div>
                                <div class="form-group">
                                    <label>WeChat</label>
                                    <input type="text" id="supplierWechat" placeholder="WeChat ID">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Веб-сайт</label>
                                <input type="text" id="supplierWebsite" placeholder="https://example.com">
                            </div>
                            <div class="form-group">
                                <label>Примечания</label>
                                <textarea id="supplierNotes" placeholder="Дополнительные примечания о поставщике" rows="3" style="resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="addSupplier()">✅ Добавить поставщика</button>
                        <button class="btn btn-secondary" onclick="clearSupplierForm()">🗑️ Очистить форму</button>
                        <button class="btn btn-secondary" onclick="toggleSupplierForm()">❌ Свернуть</button>
                    </div>
                </div>

                <!-- Карточки поставщиков -->
                <div id="suppliersCardsContainer" class="clients-cards-container">
                    <!-- Здесь будут карточки поставщиков -->
                </div>
            </div>

            <!-- Секция: Расход / Поставки -->
            <div class="section-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📦 Поставки</h2>
                    <button class="btn btn-primary" onclick="toggleShipmentForm()" id="toggleShipmentFormBtn">
                        <span id="toggleShipmentIcon">➕</span> Добавить партию
                    </button>
                </div>

                <!-- Форма добавления партии (скрыта по умолчанию) -->
                <div id="shipmentFormSection" style="display: none; background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #ffc107; padding-bottom: 15px;">
                        📦 Новая партия товаров
                        <button onclick="toggleShipmentForm()" style="margin-left: auto; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                    </h3>

                    <!-- Даты -->
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>📅 Дата отправки *</label>
                            <input type="date" id="shipmentSendDate">
                        </div>
                        <div class="form-group">
                            <label>📅 Дата приёма</label>
                            <input type="date" id="shipmentReceiveDate">
                        </div>
                    </div>

                    <!-- Товары партии -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                            🛒 Товары в партии
                            <span id="shipmentItemsCount" style="background: #ffc107; color: #333; padding: 2px 10px; border-radius: 12px; font-size: 12px;">0</span>
                        </h4>

                        <!-- Добавление товара -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Товар (группа со склада) * <button type="button" onclick="showAllShipmentProducts()" style="font-size: 11px; padding: 2px 8px; margin-left: 10px;">📋 Все группы</button></label>
                                    <div style="position: relative;">
                                        <input type="text" id="shipmentProductSearch" placeholder="🔍 Поиск по названию или коду..." autocomplete="off" oninput="filterShipmentProducts()" onfocus="showAllShipmentProducts()">
                                        <div id="shipmentProductDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; background: white; border: 2px solid #ffc107; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15);"></div>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>🏭 Поставщик</label>
                                    <div style="position: relative;">
                                        <input type="text" id="shipmentItemSupplierSearch" placeholder="Поставщик товара..." autocomplete="off" oninput="filterShipmentItemSuppliers()">
                                        <div id="shipmentItemSupplierDropdown" class="supplier-dropdown" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 0.7fr 1fr 0.7fr 0.5fr; gap: 10px; align-items: flex-end;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Количество *</label>
                                    <input type="number" id="shipmentProductQuantity" placeholder="0" step="0.01" min="0">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Ед. изм.</label>
                                    <select id="shipmentProductUnit">
                                        <option value="кг">кг</option>
                                        <option value="г">г</option>
                                        <option value="шт">шт</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Цена за ед. (RSD) *</label>
                                    <input type="number" id="shipmentProductPrice" placeholder="0.00" step="0.01" min="0">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>НДС товара</label>
                                    <select id="shipmentProductVAT">
                                        <option value="0">0%</option>
                                        <option value="10">10%</option>
                                        <option value="20" selected>20%</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" onclick="addShipmentItem()" style="height: 42px; white-space: nowrap;">
                                    ➕
                                </button>
                            </div>
                        </div>

                        <!-- Список товаров -->
                        <div id="shipmentItemsList" style="max-height: 350px; overflow-y: auto;">
                            <div style="text-align: center; padding: 30px; color: #999;">
                                <span style="font-size: 32px;">📋</span>
                                <p>Добавьте товары в партию</p>
                            </div>
                        </div>

                        <!-- Итого товаров -->
                        <div id="shipmentItemsTotal" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Товары (без НДС):</span>
                                    <span id="shipmentProductsSubtotal" style="font-weight: 600;">0 RSD</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>НДС товаров:</span>
                                    <span id="shipmentProductsVATTotal" style="font-weight: 600; color: #17a2b8;">0 RSD</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">Итого товары:</span>
                                    <span id="shipmentProductsTotal" style="font-weight: 700; color: #28a745;">0 RSD</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Логистика и доп. расходы -->
                    <div id="shipmentLogisticsSection" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">🚚 Логистика и дополнительные расходы</h4>
                        
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 0.8fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>🚚 Доставка (RSD)</label>
                                <input type="number" id="shipmentDeliveryCost" placeholder="0.00" step="0.01" min="0" oninput="updateShipmentTotals()">
                            </div>
                            <div class="form-group">
                                <label>🛃 Таможня (RSD)</label>
                                <input type="number" id="shipmentCustomsCost" placeholder="0.00" step="0.01" min="0" oninput="updateShipmentTotals()">
                            </div>
                            <div class="form-group">
                                <label>🏥 Санпид (RSD)</label>
                                <input type="number" id="shipmentSanitaryCost" placeholder="0.00" step="0.01" min="0" oninput="updateShipmentTotals()">
                            </div>
                            <div class="form-group">
                                <label>📝 Прочие (RSD)</label>
                                <input type="number" id="shipmentOtherCost" placeholder="0.00" step="0.01" min="0" oninput="updateShipmentTotals()">
                            </div>
                            <div class="form-group">
                                <label>НДС логистики</label>
                                <select id="shipmentLogisticsVAT" onchange="updateShipmentTotals()">
                                    <option value="0">0%</option>
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                </select>
                            </div>
                        </div>

                        <!-- Доп. расходы с описанием -->
                        <div id="shipmentExtraExpensesList" style="margin-bottom: 15px;">
                            <!-- Дополнительные расходы будут добавлены здесь -->
                        </div>
                        <button class="btn btn-secondary" onclick="addShipmentExtraExpense()" style="margin-bottom: 15px;">
                            ➕ Добавить доп. расход
                        </button>

                        <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Логистика (без НДС):</span>
                                    <span id="shipmentLogisticsSubtotal" style="font-weight: 600;">0 RSD</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>НДС логистики:</span>
                                    <span id="shipmentLogisticsVATTotal" style="font-weight: 600; color: #17a2b8;">0 RSD</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 700;">Итого логистика:</span>
                                    <span id="shipmentLogisticsTotal" style="font-weight: 700; color: #28a745;">0 RSD</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="toggleShipmentLogistics()" id="toggleLogisticsBtn" style="margin-bottom: 20px;">
                        🚚 Добавить логистику и расходы
                    </button>

                    <!-- Финансовые условия -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">💰 Дополнительно</h4>
                        
                        <div class="form-grid" style="grid-template-columns: 1fr 2fr; gap: 15px;">
                            <div class="form-group">
                                <label>Комиссия (RSD)</label>
                                <input type="number" id="shipmentCommission" placeholder="0.00" step="0.01" min="0" oninput="updateShipmentTotals()">
                            </div>
                            <div class="form-group">
                                <label>Примечание</label>
                                <input type="text" id="shipmentNote" placeholder="Комментарий к партии...">
                            </div>
                        </div>
                    </div>

                    <!-- Итоговая сумма -->
                    <div style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ОБЩАЯ СТОИМОСТЬ ПАРТИИ</div>
                                <div style="font-size: 28px; font-weight: 700;" id="shipmentGrandTotal">0 RSD</div>
                            </div>
                            <div style="text-align: right; font-size: 13px; opacity: 0.9;">
                                <div>Товары (без НДС): <span id="shipmentSummaryProducts">0</span> RSD</div>
                                <div>НДС товаров: <span id="shipmentSummaryProductsVAT">0</span> RSD</div>
                                <div>Логистика (без НДС): <span id="shipmentSummaryLogistics">0</span> RSD</div>
                                <div>НДС логистики: <span id="shipmentSummaryLogisticsVAT">0</span> RSD</div>
                                <div>Комиссия: <span id="shipmentSummaryCommission">0</span> RSD</div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="clearShipmentForm()">🗑️ Очистить</button>
                        <button class="btn btn-success" onclick="saveShipment()" style="min-width: 200px;">
                            ✅ Сохранить партию
                        </button>
                    </div>
                </div>

                <!-- Список поставок -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">📋 История поставок</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="shipmentSearchInput" placeholder="🔍 Поиск..." style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px; width: 200px;" oninput="filterShipments()">
                            <select id="shipmentSortOrder" style="padding: 8px 15px; border: 2px solid #dee2e6; border-radius: 8px;" onchange="filterShipments()">
                                <option value="date_desc">По дате (новые)</option>
                                <option value="date_asc">По дате (старые)</option>
                                <option value="total_desc">По сумме (↓)</option>
                                <option value="total_asc">По сумме (↑)</option>
                            </select>
                        </div>
                    </div>
                    <div id="shipmentsListContainer">
                        <div style="text-align: center; padding: 40px; color: #999; background: #f8f9fa; border-radius: 10px;">
                            <span style="font-size: 48px;">📦</span>
                            <p style="margin-top: 15px;">Пока нет сохранённых поставок</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция: Расходники (склад групп) -->
            <div class="section-card" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">🧹 Расходники</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="toggleConsumableCategoryManager()">⚙️ Категории</button>
                        <button class="btn btn-primary" onclick="toggleConsumableGroupForm()" id="toggleConsumableGroupFormBtn">
                            <span id="toggleConsumableGroupIcon">➕</span> Создать группу
                        </button>
                    </div>
                </div>
                
                <!-- Форма создания группы расходников (сворачиваемая) -->
                <div class="warehouse-section" id="consumableGroupCreationForm" style="display: none; background: #e8f5e9; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #4caf50;">
                    <h3 style="margin-bottom: 20px; color: #2e7d32;">📦 Создать группу расходников</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label>Код группы *</label>
                            <input type="text" id="consumableGroupCode" placeholder="RSH-001" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Название *</label>
                            <input type="text" id="consumableGroupName" placeholder="Пакеты для чая">
                        </div>
                        <div class="form-group">
                            <label>Категория</label>
                            <select id="consumableGroupCategory" onchange="loadConsumableSubcategoriesForSelect()">
                                <option value="">Выберите категорию</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Субкатегория</label>
                            <select id="consumableGroupSubcategory">
                                <option value="">Сначала выберите категорию</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="form-group">
                            <label>Единица измерения</label>
                            <select id="consumableGroupUnit" onchange="updateConsumableGroupUnits()">
                                <option value="шт">шт (штуки)</option>
                                <option value="уп">уп (упаковки)</option>
                                <option value="кг">кг (килограммы)</option>
                                <option value="л">л (литры)</option>
                                <option value="м">м (метры)</option>
                                <option value="рул">рул (рулоны)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Поставщик</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input" id="consumableGroupSupplierSearch" placeholder="Введите поставщика..." autocomplete="off" oninput="filterSupplierDropdown('consumableGroupSupplierSearch', 'consumableGroupSupplierDropdown')">
                                <input type="hidden" id="consumableGroupSupplier" value="">
                                <div class="dropdown-menu" id="consumableGroupSupplierDropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Дата поступления</label>
                            <input type="date" id="consumableGroupDate">
                        </div>
                        <div class="form-group">
                            <label>Количество *</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="number" id="consumableGroupQuantity" placeholder="1000" style="flex: 1;">
                                <span id="consumableGroupQuantityUnit" style="color: #666; min-width: 30px;">шт</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label>Цена закупки за ед.</label>
                            <input type="number" id="consumableGroupPrice" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Примечание</label>
                            <input type="text" id="consumableGroupNote" placeholder="Дополнительная информация">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="createConsumableGroup()">✅ Создать группу</button>
                        <button class="btn btn-secondary" onclick="clearConsumableGroupForm()">🔄 Очистить</button>
                        <button class="btn btn-secondary" onclick="toggleConsumableGroupForm()">❌ Свернуть</button>
                    </div>
                </div>

                <!-- Форма управления категориями расходников -->
                <div id="consumableCategoryManagerSection" style="display: none; margin-bottom: 20px; background: #fff3e0; padding: 25px; border-radius: 12px; border: 2px solid #ff9800;">
                    <h3 style="margin-bottom: 20px; color: #e65100;">⚙️ Управление категориями и субкатегориями расходников</h3>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Категории -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 15px; color: #333;">📁 Категории</h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Новая категория</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newConsumableCategoryName" placeholder="Название категории" style="flex: 1;">
                                    <button class="btn btn-success" onclick="addConsumableCategory()" style="white-space: nowrap;">➕</button>
                                </div>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                                <table class="table" style="margin-bottom: 0;">
                                    <thead>
                                        <tr><th>Название</th><th style="width: 60px;">🗑️</th></tr>
                                    </thead>
                                    <tbody id="consumableCategoriesListBody">
                                        <!-- Категории загружаются динамически -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Субкатегории -->
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 15px; color: #333;">📂 Субкатегории</h4>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label>Категория</label>
                                <select id="consumableSubcategoryCategorySelect" onchange="loadConsumableSubcategoriesForManager()">
                                    <option value="">Выберите категорию</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Новая субкатегория</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newConsumableSubcategoryName" placeholder="Название субкатегории" style="flex: 1;">
                                    <button class="btn btn-success" onclick="addConsumableSubcategory()" style="white-space: nowrap;">➕</button>
                                </div>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px;">
                                <table class="table" style="margin-bottom: 0;">
                                    <thead>
                                        <tr><th>Название</th><th style="width: 60px;">🗑️</th></tr>
                                    </thead>
                                    <tbody id="consumableSubcategoriesListBody">
                                        <tr><td colspan="2" style="text-align: center; color: #999;">Выберите категорию</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="toggleConsumableCategoryManager()">❌ Закрыть</button>
                    </div>
                </div>

                <!-- Поиск и фильтры -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" id="consumableGroupSearchInput" placeholder="🔍 Поиск группы расходников..." style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" oninput="filterConsumableGroups()">
                    </div>
                    <div style="min-width: 200px;">
                        <select id="consumableGroupCategoryFilter" style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" onchange="filterConsumableGroups()">
                            <option value="">📁 Все категории</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="resetConsumableGroupFilters()" style="padding: 10px 20px;">
                        🔄 Сбросить
                    </button>
                </div>

                <!-- Карточки групп расходников -->
                <div id="consumableGroupsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Группы загружаются динамически -->
                </div>

                <!-- История операций -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; cursor: pointer;" onclick="toggleConsumableHistory()">
                        📋 История операций <span id="consumableHistoryToggle">▼</span>
                    </h3>
                    <div id="consumableHistorySection" style="display: none;">
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Группа</th>
                                        <th>Операция</th>
                                        <th>Количество</th>
                                        <th>Остаток</th>
                                        <th>Примечание</th>
                                    </tr>
                                </thead>
                                <tbody id="consumableHistoryTableBody">
                                    <!-- История загружается динамически -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div id="statistics" class="tab-content">
            <h2>📊 Статистика</h2>
            
            <!-- Подвкладки статистики -->
            <div style="display: flex; gap: 0; margin-bottom: 25px; border-bottom: 2px solid #e3e8ef;">
                <button id="statsTabSales" onclick="switchStatsTab('sales')" 
                        style="padding: 12px 30px; border: none; background: #114A9F; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-radius: 8px 8px 0 0; border-bottom: 3px solid #114A9F; margin-bottom: -2px;">
                    💰 Статистика продаж
                </button>
                <button id="statsTabExpenses" onclick="switchStatsTab('expenses')" 
                        style="padding: 12px 30px; border: none; background: transparent; color: #666; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-radius: 8px 8px 0 0; border-bottom: 3px solid transparent; margin-bottom: -2px;">
                    📦 Статистика расходников
                </button>
            </div>
            
            <!-- Подвкладка: Статистика продаж -->
            <div id="statsContentSales">
            <div class="filter-section">
                <h3>Фильтры</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Период с:</label>
                        <input type="date" id="statsFromDate">
                    </div>
                    <div class="form-group">
                        <label>Период по:</label>
                        <input type="date" id="statsToDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="updateStatistics()">Обновить</button>
                            <button class="btn btn-success" onclick="exportStatisticsToPDF()">Скачать PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0 RSD</div>
                    <div class="stat-label">Общая выручка</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalInvoices">0</div>
                    <div class="stat-label">Всего инвойсов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Клиентов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageOrder">0 RSD</div>
                    <div class="stat-label">Средний заказ</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Выручка по месяцам</div>
                <div id="revenueChart">График выручки будет отображен здесь</div>
            </div>

            <div class="chart-container">
                <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Топ товаров по продажам</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="productsVatFilter" onchange="updateStatistics()" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="without">Без НДС</option>
                            <option value="with">С НДС (20%)</option>
                        </select>
                    <button class="btn btn-success" onclick="exportProductsToExcel()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                        📊 Экспорт в Excel
                    </button>
                    </div>
                </div>
                <div id="productsChart">График продаж товаров будет отображен здесь</div>
            </div>

            <div class="chart-container">
                <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Продажи по категориям</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="categoriesVatFilter" onchange="updateStatistics()" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="without">Без НДС</option>
                            <option value="with">С НДС (20%)</option>
                        </select>
                    <button class="btn btn-success" onclick="exportCategoriesToExcel()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                        📊 Экспорт в Excel
                    </button>
                    </div>
                </div>
                <div id="categoriesChart">График продаж по категориям будет отображен здесь</div>
            </div>

            <!-- Статистика по субкатегориям -->
            <div class="chart-container">
                <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Продажи по субкатегориям</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="subcategoriesCategoryFilter" onchange="updateSubcategoriesChart(window.currentFilteredInvoices || [])" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="">Все категории</option>
                            <!-- Категории загружаются динамически -->
                        </select>
                        <select id="subcategoriesVatFilter" onchange="updateSubcategoriesChart(window.currentFilteredInvoices || [])" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="without">Без НДС</option>
                            <option value="with">С НДС (20%)</option>
                        </select>
                        <button class="btn btn-success" onclick="exportSubcategoriesToExcel()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                            📊 Экспорт в Excel
                        </button>
                    </div>
                </div>
                <div id="subcategoriesChart">График продаж по субкатегориям будет отображен здесь</div>
            </div>

            <div class="chart-container">
                <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Топ клиентов по выручке</span>
                    <button class="btn btn-success" onclick="exportClientsToExcel()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                        📊 Экспорт в Excel
                    </button>
                </div>
                <div id="clientsChart">График клиентов будет отображен здесь</div>
            </div>

            <!-- Детальная отчетность по клиентам -->
            <div class="chart-container" style="margin-top: 30px;">
                <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span>📊 Детальная отчетность по клиентам</span>
                    <button class="btn btn-success" onclick="exportDetailedClientsToExcel()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                        📊 Экспорт в Excel
                    </button>
                </div>
                
                <!-- Фильтры для отчетности по клиентам -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #e3e8ef;">
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; font-size: 14px; margin-bottom: 8px;">🔍 Поиск по клиенту:</label>
                            <input type="text" id="clientReportSearch" placeholder="Введите название клиента..." style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" oninput="updateClientReport()">
                        </div>
                        <div style="min-width: 180px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; font-size: 14px; margin-bottom: 8px;">🏢 Тип клиента:</label>
                            <select id="clientReportType" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" onchange="updateClientReport()">
                                <option value="">Все типы</option>
                                <option value="Бар">🍺 Бар</option>
                                <option value="Ресторан">🍽️ Ресторан</option>
                                <option value="Отель">🏨 Отель</option>
                                <option value="Кальянная">💨 Кальянная</option>
                                <option value="Кафе">☕ Кафе</option>
                                <option value="Чайная">🍵 Чайная</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; font-size: 14px; margin-bottom: 8px;">📅 Период от:</label>
                            <input type="month" id="clientReportFromMonth" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" onchange="updateClientReport()">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; font-size: 14px; margin-bottom: 8px;">📅 Период до:</label>
                            <input type="month" id="clientReportToMonth" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" onchange="updateClientReport()">
                        </div>
                        <button onclick="resetClientReport()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; height: 42px;" onmouseover="this.style.background='#7f8c8d';" onmouseout="this.style.background='#95a5a6';">
                            🔄 Сбросить
                        </button>
                    </div>
                </div>
                
                <!-- Общая статистика -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #114A9F; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px; color: white;" id="clientReportTotalSum">0 RSD</div>
                        <div style="font-size: 13px; opacity: 0.95; color: white;">Общая сумма заказов</div>
                    </div>
                    <div style="background: #114A9F; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px; color: white;" id="clientReportTotalClients">0</div>
                        <div style="font-size: 13px; opacity: 0.95; color: white;">Всего клиентов</div>
                    </div>
                    <div style="background: #114A9F; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px; color: white;" id="clientReportAvgSum">0 RSD</div>
                        <div style="font-size: 13px; opacity: 0.95; color: white;">Средняя сумма на клиента</div>
                    </div>
                    <div style="background: #114A9F; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 5px; color: white;" id="clientReportTotalInvoices">0</div>
                        <div style="font-size: 13px; opacity: 0.95; color: white;">Всего инвойсов</div>
                    </div>
                </div>
                
                <!-- Таблица клиентов -->
                <div id="clientReportTable" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e3e8ef; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                    Загрузка данных...
                </div>
            </div>

            <div class="invoice-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Утвержденные инвойсы</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn btn-info" onclick="syncInvoiceStatuses()" title="Синхронизировать статусы принятия инвойсов с клиентами">
                            🔄 Обновить статусы
                        </button>
                    <div class="form-group" style="margin: 0; width: 300px;">
                        <input type="text" id="invoiceSearchInput" placeholder="Поиск по номеру инвойса..." style="margin: 0;" oninput="filterInvoicesBySearch()">
                        </div>
                    </div>
                </div>
                <div id="confirmedInvoicesList">
                    <p style="text-align: center; color: #666;">Нет утвержденных инвойсов</p>
                </div>
            </div>
            </div> <!-- Конец statsContentSales -->
            
            <!-- Подвкладка: Статистика расходников -->
            <div id="statsContentExpenses" style="display: none;">
                <div class="filter-section">
                    <h3>Фильтры</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Период с:</label>
                            <input type="date" id="expenseStatsFromDate">
                        </div>
                        <div class="form-group">
                            <label>Период по:</label>
                            <input type="date" id="expenseStatsToDate">
                        </div>
                        <div class="form-group">
                            <label>Категория:</label>
                            <select id="expenseStatsCategoryFilter">
                                <option value="">Все категории</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" onclick="updateExpenseStatistics()">Обновить</button>
                                <button class="btn btn-secondary" onclick="resetExpenseStatsFilters()">Сбросить</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Общая статистика расходников -->
                <div class="stats-container" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <div class="stat-number" id="totalConsumablesExpense" style="color: white;">0 RSD</div>
                        <div class="stat-label" style="color: white; opacity: 0.95;">💰 Стоимость расходов</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                        <div class="stat-number" id="totalConsumablesQuantity" style="color: white;">0</div>
                        <div class="stat-label" style="color: white; opacity: 0.95;">📦 Количество израсходовано</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        <div class="stat-number" id="expenseStatsClients" style="color: white;">0</div>
                        <div class="stat-label" style="color: white; opacity: 0.95;">👥 Клиентов</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                        <div class="stat-number" id="expenseStatsSuppliers" style="color: white;">0</div>
                        <div class="stat-label" style="color: white; opacity: 0.95;">🏭 Поставщиков</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <div class="stat-number" id="totalConsumableGroups" style="color: white;">0</div>
                        <div class="stat-label" style="color: white; opacity: 0.95;">📋 Расходников</div>
                    </div>
                </div>

                <!-- График расходников по категориям -->
                <div class="chart-container">
                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>📦 Расход по категориям</span>
                        <button class="btn btn-success" onclick="exportExpensesByCategory()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                            📊 Экспорт в Excel
                        </button>
                    </div>
                    <div id="expensesByCategoryChart">График расхода по категориям будет отображен здесь</div>
                </div>

                <!-- Топ расходников по использованию -->
                <div class="chart-container">
                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>🔝 Топ расходников по использованию</span>
                        <button class="btn btn-success" onclick="exportTopConsumables()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                            📊 Экспорт в Excel
                        </button>
                    </div>
                    <div id="topConsumablesChart">График топ расходников будет отображен здесь</div>
                </div>

                <!-- Расход расходников по месяцам -->
                <div class="chart-container">
                    <div class="chart-title">📅 Расход по месяцам</div>
                    <div id="expensesByMonthChart">График расхода по месяцам будет отображен здесь</div>
                </div>

                <!-- Таблица истории операций с расходниками -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span>📋 История операций с расходниками</span>
                        <button class="btn btn-success" onclick="exportExpenseHistory()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                            📊 Экспорт в Excel
                        </button>
                    </div>
                    
                    <div id="expenseHistoryTable" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e3e8ef; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.06); max-height: 500px; overflow-y: auto;">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Дата</th>
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Группа</th>
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Операция</th>
                                    <th style="padding: 14px; text-align: center; font-weight: 600;">Кол-во</th>
                                    <th style="padding: 14px; text-align: center; font-weight: 600;">Остаток</th>
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Примечание</th>
                                </tr>
                            </thead>
                            <tbody id="expenseHistoryTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">Нажмите "Обновить" для загрузки данных</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Текущий остаток по группам -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span>📦 Текущий остаток расходников</span>
                        <button class="btn btn-success" onclick="exportCurrentStock()" style="padding: 8px 16px; font-size: 13px; margin: 0;">
                            📊 Экспорт в Excel
                        </button>
                    </div>
                    
                    <div id="currentStockTable" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e3e8ef; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Код</th>
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Название</th>
                                    <th style="padding: 14px; text-align: left; font-weight: 600;">Категория</th>
                                    <th style="padding: 14px; text-align: center; font-weight: 600;">Остаток</th>
                                    <th style="padding: 14px; text-align: center; font-weight: 600;">Ед.</th>
                                    <th style="padding: 14px; text-align: right; font-weight: 600;">Стоимость</th>
                                </tr>
                            </thead>
                            <tbody id="currentStockTableBody">
                                <tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">Нажмите "Обновить" для загрузки данных</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- Конец statsContentExpenses -->
        </div>


    </div>

    <!-- Модальное окно редактирования товара -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Редактировать товар</h2>
                <button class="close" onclick="closeEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Внутренний код *</label>
                        <input type="text" id="editProductInternalCode" placeholder="INT-001">
                    </div>
                    <div class="form-group">
                        <label>Код товара *</label>
                        <input type="text" id="editProductCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="editProductName" placeholder="Tieguanyin/Zeleni Čaj 210g">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Стоимость без НДС (RSD) *</label>
                        <input type="number" id="editProductPrice" placeholder="0.00" step="0.01" onblur="this.value = formatPrice(this.value)">
                    </div>
                    <div class="form-group">
                        <label>Вес (г)</label>
                        <input type="number" id="editProductWeight" placeholder="210" step="0.1">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="editProductCategory" onchange="updateSubcategoryOptions('editProductSubcategory', this.value)">
                            <option value="">Выберите категорию</option>
                            <!-- Категории загружаются динамически -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Субкатегория</label>
                        <select id="editProductSubcategory">
                            <option value="">Сначала выберите категорию</option>
                            <!-- Субкатегории загружаются при выборе категории -->
                        </select>
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Поставщик</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="editProductSupplierSearch" placeholder="Введите поставщика..." autocomplete="off" oninput="filterSupplierDropdown('editProductSupplierSearch', 'editProductSupplierDropdown')">
                            <input type="hidden" id="editProductSupplier" value="">
                            <div class="dropdown-menu" id="editProductSupplierDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Для клиента (опционально)</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="editProductClientSearch" placeholder="Введите клиента..." autocomplete="off">
                            <input type="hidden" id="editProductClient" value="">
                            <div class="dropdown-menu" id="editProductClientDropdown"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveProductChanges()">Сохранить изменения</button>
                <button class="btn btn-secondary" onclick="closeEditProductModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно логов -->
    <div id="logsModal" class="modal">
        <div class="modal-content" style="
            max-width: 90vw; 
            width: 800px; 
            max-height: 85vh; 
            margin: 5vh auto; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        ">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">Логи действий</h2>
                <button class="close" onclick="closeLogsModal()">&times;</button>
            </div>
            <div class="modal-body" style="
                flex: 1; 
                overflow: hidden; 
                padding: 20px; 
                display: flex; 
                flex-direction: column;
            ">
                <div id="logsContainer" style="
                    background: #f8f9fa; 
                    border-radius: 12px; 
                    padding: 20px; 
                    flex: 1; 
                    overflow-y: auto; 
                    border: 2px solid #e9ecef;
                    min-height: 200px;
                ">
                    <ul id="logsList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
            </div>
            <div class="modal-footer" style="
                text-align: center; 
                padding: 20px; 
                border-top: 1px solid #e9ecef; 
                flex-shrink: 0;
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            ">
                <button class="btn btn-success" onclick="exportLogsToExcel()" style="min-width: 150px;">
                    <span style="font-size: 14px; margin-right: 5px;">📊</span>
                    Экспорт в Excel
                </button>
                <button class="btn btn-secondary" onclick="clearLogs()" style="min-width: 120px;">Очистить логи</button>
                <button class="btn btn-secondary" onclick="closeLogsModal()" style="min-width: 100px;">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления пользователя -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Добавить нового пользователя</h2>
                <button class="close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs for user type selection -->
                <div class="user-type-tabs">
                    <button class="user-type-tab active" onclick="switchUserType('regular')" id="regularUserTab">
                        <span>👤</span> Обычный пользователь
                    </button>
                    <button class="user-type-tab" onclick="switchUserType('client')" id="clientUserTab">
                        <span>🏢</span> Профиль клиента
                    </button>
                </div>

                <!-- Regular user form -->
                <div id="regularUserForm" class="user-form-section">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Логин <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newUserLogin" placeholder="Введите логин" autocomplete="off" required>
                        </div>
                        <div class="form-group">
                            <label>Пароль <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="newUserPassword" placeholder="Введите пароль" autocomplete="new-password" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Подтвердите пароль <span style="color: #dc3545;">*</span></label>
                        <input type="password" id="confirmUserPassword" placeholder="Повторите пароль" autocomplete="new-password" required>
                    </div>
                </div>

                <!-- Client profile form -->
                <div id="clientUserForm" class="user-form-section" style="display: none;">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Логин <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newClientUserLogin" placeholder="Введите логин" autocomplete="off" oninput="checkClientMB()" required>
                        </div>
                        <div class="form-group">
                            <label>Пароль <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="newClientUserPassword" placeholder="Введите пароль" autocomplete="new-password" oninput="checkClientMB()" required>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Подтвердите пароль <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="confirmClientUserPassword" placeholder="Повторите пароль" autocomplete="new-password" oninput="checkClientMB()" required>
                        </div>
                        <div class="form-group">
                            <label>Матични број <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newClientUserMB" placeholder="Введите матични број" autocomplete="off" oninput="checkClientMB()" required>
                        </div>
                    </div>
                    
                    <!-- Client data preview -->
                    <div id="clientDataPreview" style="display: none;">
                        <h4>✓ Найден существующий клиент</h4>
                        <div id="clientPreviewData"></div>
                    </div>
                </div>

                <div id="addUserError" class="login-error" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 0 0 0; border-top: 1px solid #dee2e6; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Отмена</button>
                <button class="btn btn-primary" id="addUserButton" onclick="addNewUser()">Добавить пользователя</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования пользователей -->
    <div id="editUsersModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Управление пользователями</h2>
                <button class="close" onclick="closeEditUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Список пользователей будет добавлен динамически -->
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeEditUsersModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления доступом -->
    <div id="userPermissionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="permissionsTitle">Управление доступом</h2>
                <button class="close" onclick="closeUserPermissionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4 style="margin-bottom: 20px; color: #2c3e50; font-size: 16px;">Доступ к вкладкам:</h4>
                    <div style="display: grid; gap: 15px;">
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_clients" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Клиенты</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_products" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Товары</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_warehouse" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Склад</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_invoice" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Инвойс</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_delivery" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Отпремница</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_statistics" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Статистика</span>
                        </label>
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" id="perm_logs" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #333;">Логи</span>
                        </label>
                        <hr style="margin: 10px 0; border: none; border-top: 2px solid #e9ecef;">
                        <label style="display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; background: #fff3cd;" id="editUserPermLabel" onmouseover="if(!this.querySelector('input').disabled) this.style.background='#ffe69c'" onmouseout="if(!this.querySelector('input').disabled) this.style.background='#fff3cd'; else this.style.background='#f8f9fa'">
                            <input type="checkbox" id="perm_editUsers" style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                            <span style="font-size: 15px; color: #856404; font-weight: 600;">Редактировать пользователей</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="saveUserPermissions()">Сохранить</button>
                <button class="btn btn-secondary" onclick="closeUserPermissionsModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно предупреждения о заканчивающихся расходниках -->
    <div id="lowStockModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border-radius: 8px 8px 0 0; padding: 20px;">
                <h2 class="modal-title" style="color: white; margin: 0;">⚠️ Заканчивается!</h2>
                <button class="close" onclick="closeLowStockModal()" style="color: white; opacity: 0.8;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <p style="font-size: 16px; color: #666; margin-bottom: 20px; text-align: center;">
                    Следующие расходники заканчиваются (осталось менее 20%):
                </p>
                <div id="lowStockList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Список расходников будет добавлен динамически -->
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; padding: 15px 25px; background: #f8f9fa; border-radius: 0 0 8px 8px;">
                <button class="btn btn-secondary" onclick="closeLowStockModal()" style="margin-right: 10px;">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно карточки товара -->
    <div id="productProfileModal" class="modal">
        <div class="modal-content client-profile-modal">
            <!-- Заголовок карточки -->
            <div class="client-card-header">
                <div class="client-avatar" id="productAvatar" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ТВ</div>
                <div class="client-title-info">
                    <h2 id="productProfileTitle">Карточка товара</h2>
                    <p id="productProfileSubtitle">Информация и статистика продаж</p>
                </div>
                <button class="close" onclick="closeProductProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            </div>

            <!-- Секции профиля -->
            <div class="profile-sections">
                <!-- Основная информация -->
                <div class="profile-section">
                    <h3>📦 Основная информация</h3>
                    <div class="profile-field">
                        <span class="profile-field-label">Код товара:</span>
                        <span class="profile-field-value" id="profileProductCode">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Название:</span>
                        <span class="profile-field-value" id="profileProductName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Категория:</span>
                        <span class="profile-field-value" id="profileProductCategory">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Субкатегория:</span>
                        <span class="profile-field-value" id="profileProductSubcategory" style="cursor: pointer; color: #6f42c1; text-decoration: underline;" onclick="openSubcategoryFromProduct()">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Цена (RSD):</span>
                        <span class="profile-field-value" id="profileProductPrice">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Вес (г):</span>
                        <span class="profile-field-value" id="profileProductWeight">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Поставщик:</span>
                        <span class="profile-field-value" id="profileProductSupplier" style="cursor: pointer; color: #2e7d32; text-decoration: underline;">-</span>
                    </div>
                </div>

                <!-- Связанные расходники -->
                <div class="profile-section">
                    <h3>🧹 Связанные расходники</h3>
                    <div id="productLinkedConsumablesContainer">
                        <!-- Список связанных расходников -->
                        <div id="productLinkedConsumablesList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                            <p style="color: #999; text-align: center; padding: 20px;">Нет связанных расходников</p>
                        </div>
                        
                        <!-- Добавление расходника -->
                        <div style="border-top: 1px solid #e9ecef; padding-top: 15px;">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">Добавить расходник:</label>
                            <select id="productConsumableSelect" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; margin-bottom: 10px;">
                                <option value="">Выберите группу расходников</option>
                            </select>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 500; white-space: nowrap;">Кол-во на 1 ед. товара:</label>
                                <input type="number" id="productConsumableQuantity" value="1" min="0.01" step="0.01" style="width: 80px; padding: 8px; border: 1px solid #ced4da; border-radius: 6px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="addConsumableToProduct()" style="flex: 1; padding: 8px;">➕ Добавить</button>
                                <button class="btn btn-primary" onclick="saveProductConsumables()" style="flex: 1; padding: 8px;">💾 Сохранить</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Статистика продаж -->
                <div class="profile-section" style="grid-column: 1 / -1;">
                    <h3>📊 Статистика продаж</h3>
                    
                    <!-- Фильтры по датам -->
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #495057; white-space: nowrap;">📅 От:</label>
                            <input type="date" id="productStatsDateFrom" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;" onchange="applyProductDateFilter()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #495057; white-space: nowrap;">До:</label>
                            <input type="date" id="productStatsDateTo" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;" onchange="applyProductDateFilter()">
                        </div>
                        <button class="btn btn-secondary" onclick="resetProductDateFilter()" style="padding: 8px 16px; font-size: 13px;">🔄 Сбросить</button>
                        <span id="productDateFilterStatus" style="color: #6c757d; font-size: 13px; margin-left: auto;"></span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="productTotalSold">0</div>
                            <div class="stat-label">Всего продано (шт)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="productTotalRevenue">0 RSD</div>
                            <div class="stat-label">Общая выручка</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="productUniqueClients">0</div>
                            <div class="stat-label">Уникальных клиентов</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="productAvgQuantity">0</div>
                            <div class="stat-label">Среднее кол-во в заказе</div>
                        </div>
                    </div>
                    
                    <!-- График продаж по месяцам -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #28a745; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            📈 Продажи по месяцам
                        </h4>
                        <div id="productMonthlyChart">График будет отображен здесь</div>
                    </div>
                    
                    <!-- Таблица клиентов купивших товар -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #28a745; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            👥 Клиенты купившие товар
                        </h4>
                        <div id="productClientsTable" style="overflow-x: auto;">
                            Таблица клиентов будет отображена здесь
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно карточки субкатегории -->
    <div id="subcategoryProfileModal" class="modal">
        <div class="modal-content client-profile-modal">
            <!-- Заголовок карточки -->
            <div class="client-card-header" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                <div class="client-avatar" id="subcategoryAvatar" style="background: rgba(255,255,255,0.2);">СК</div>
                <div class="client-title-info">
                    <h2 id="subcategoryProfileTitle">Карточка субкатегории</h2>
                    <p id="subcategoryProfileSubtitle">Статистика продаж по субкатегории</p>
                </div>
                <button class="close" onclick="closeSubcategoryProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            </div>

            <!-- Секции профиля -->
            <div class="profile-sections">
                <!-- Основная информация -->
                <div class="profile-section">
                    <h3>📁 Основная информация</h3>
                    <div class="profile-field">
                        <span class="profile-field-label">Субкатегория:</span>
                        <span class="profile-field-value" id="profileSubcategoryName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Категория:</span>
                        <span class="profile-field-value" id="profileSubcategoryCategory">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Количество товаров:</span>
                        <span class="profile-field-value" id="profileSubcategoryProductCount">0</span>
                    </div>
                </div>

                <!-- Статистика продаж -->
                <div class="profile-section" style="grid-column: 1 / -1;">
                    <h3>📊 Статистика продаж</h3>
                    
                    <!-- Фильтры по датам -->
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #495057; white-space: nowrap;">📅 От:</label>
                            <input type="date" id="subcategoryStatsDateFrom" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;" onchange="applySubcategoryDateFilter()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #495057; white-space: nowrap;">До:</label>
                            <input type="date" id="subcategoryStatsDateTo" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;" onchange="applySubcategoryDateFilter()">
                        </div>
                        <button class="btn btn-secondary" onclick="resetSubcategoryDateFilter()" style="padding: 8px 16px; font-size: 13px;">🔄 Сбросить</button>
                        <span id="subcategoryDateFilterStatus" style="color: #6c757d; font-size: 13px; margin-left: auto;"></span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="border-top: 4px solid #6f42c1;">
                            <div class="stat-number" id="subcategoryTotalSold">0</div>
                            <div class="stat-label">Всего продано (шт)</div>
                        </div>
                        <div class="stat-card" style="border-top: 4px solid #e83e8c;">
                            <div class="stat-number" id="subcategoryTotalRevenue">0 RSD</div>
                            <div class="stat-label">Общая выручка</div>
                        </div>
                        <div class="stat-card" style="border-top: 4px solid #fd7e14;">
                            <div class="stat-number" id="subcategoryUniqueClients">0</div>
                            <div class="stat-label">Уникальных клиентов</div>
                        </div>
                        <div class="stat-card" style="border-top: 4px solid #20c997;">
                            <div class="stat-number" id="subcategoryUniqueProducts">0</div>
                            <div class="stat-label">Уникальных товаров</div>
                        </div>
                    </div>
                    
                    <!-- График продаж по месяцам -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #6f42c1; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            📈 Продажи по месяцам
                        </h4>
                        <div id="subcategoryMonthlyChart">График будет отображен здесь</div>
                    </div>
                    
                    <!-- Таблица клиентов -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #fd7e14; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            👥 Продажи по клиентам
                        </h4>
                        <div id="subcategoryClientsTable" style="overflow-x: auto;">
                            Таблица клиентов будет отображена здесь
                        </div>
                    </div>
                    
                    <!-- Таблица товаров -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #20c997; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            📦 Продажи по товарам
                        </h4>
                        <div id="subcategoryProductsTable" style="overflow-x: auto;">
                            Таблица товаров будет отображена здесь
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно истории клиента -->
    <div id="clientHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="clientHistoryTitle">История инвойсов клиента</h2>
                <button class="close" onclick="closeClientHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="clientHistoryContent" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Загрузка...</p>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeClientHistoryModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для действий с телефоном -->
    <div id="phoneActionModal" class="modal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 320px; padding: 0; border-radius: 16px; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; text-align: center;">
                <div style="font-size: 40px; margin-bottom: 10px;">📞</div>
                <div style="font-size: 18px; font-weight: 600;" id="phoneModalNumber">+381 XX XXX XXXX</div>
            </div>
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 12px;">
                <button onclick="copyPhoneNumber()" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; background: #f0f4f8; color: #2c3e50; transition: all 0.2s;">
                    📋 Копировать
                </button>
                <button onclick="callPhoneNumber()" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; background: #27ae60; color: white; transition: all 0.2s;">
                    📱 Вызов
                </button>
                <button onclick="closePhoneModal()" style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 20px; font-size: 14px; font-weight: 500; border: none; border-radius: 12px; cursor: pointer; background: transparent; color: #7f8c8d; transition: all 0.2s;">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно профиля клиента -->
    <div id="clientProfileModal" class="modal">
        <div class="modal-content client-profile-modal">
            <!-- Заголовок карточки -->
            <div class="client-card-header">
                <div class="client-avatar" id="clientAvatar">КЛ</div>
                <div class="client-title-info">
                    <h2 id="clientProfileTitle">Профиль клиента</h2>
                    <p id="clientProfileSubtitle">Основные данные и статистика</p>
                </div>
                <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            </div>

            <!-- Секции профиля (режим просмотра) -->
            <div id="profile-sections" class="profile-sections">
                <!-- Основная информация -->
                <div class="profile-section">
                    <h3>📋 Основная информация</h3>
                    <div class="profile-field">
                        <span class="profile-field-label">Название:</span>
                        <span class="profile-field-value" id="profileClientName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Юридическое:</span>
                        <span class="profile-field-value" id="profileClientLegalName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">МБ:</span>
                        <span class="profile-field-value" id="profileClientMB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">ПИБ:</span>
                        <span class="profile-field-value" id="profileClientPIB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Тип:</span>
                        <span class="profile-field-value" id="profileClientType">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Контакт. лицо:</span>
                        <span class="profile-field-value" style="display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span id="profileClientContactPerson">-</span>
                            <span id="profileContactPersonStatus"></span>
                        </span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Банк:</span>
                        <span class="profile-field-value" style="display: inline-flex; align-items: center; gap: 8px;">
                            <span id="profileClientBank">-</span>
                            <button id="copyBankBtn" onclick="copyBankAccount()" style="display: none; background: #17a2b8; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; transition: all 0.2s;" title="Скопировать номер счета">📋 Копировать</button>
                        </span>
                    </div>
                </div>

                <!-- Адрес -->
                <div class="profile-section">
                    <h3>📍 Адрес</h3>
                    <div class="profile-address">
                        <span class="address-text" id="profileClientAddress">-</span>
                        <button id="profileGoogleMapsBtn" class="maps-btn" style="display: none;" onclick="openGoogleMaps()" title="Открыть в Google Maps">🗺️</button>
                    </div>
                </div>

                <!-- Контактные данные -->
                <div class="profile-section">
                    <h3>📞 Контактные данные</h3>
                    <div class="contact-grid">
                        <div class="contact-item clickable-contact" id="contactPhone" style="display: none;" onclick="showPhoneModal()">
                            <div class="contact-icon phone">📞</div>
                            <div class="contact-value" id="profileClientPhone">-</div>
                        </div>
                        <div class="contact-item clickable-contact" id="contactEmail" style="display: none;" onclick="copyEmail()">
                            <div class="contact-icon email">✉️</div>
                            <div class="contact-value" id="profileClientEmail">-</div>
                        </div>
                        <div class="contact-item clickable-contact" id="contactTelegram" style="display: none;" onclick="openTelegram()">
                            <div class="contact-icon telegram">✈️</div>
                            <div class="contact-value" id="profileClientTelegram">-</div>
                        </div>
                        <div class="contact-item clickable-contact" id="contactInstagram" style="display: none;" onclick="openInstagram()">
                            <div class="contact-icon instagram">📷</div>
                            <div class="contact-value" id="profileClientInstagram">-</div>
                        </div>
                    </div>
                </div>

                <!-- Дополнительные контакты -->
                <div class="profile-section" id="additionalContactsSection" style="display: none;">
                    <h3>👥 Дополнительные контакты</h3>
                    <div id="profileAdditionalContacts" style="display: grid; gap: 15px;">
                        <!-- Дополнительные контакты будут добавлены динамически -->
                    </div>
                </div>

                <!-- Условия сотрудничества -->
                <div class="profile-section">
                    <h3>🤝 Условия сотрудничества</h3>
                    <div class="collaboration-tags" id="collaborationTags">
                        <!-- Теги будут добавлены динамически -->
                    </div>
                    <div class="profile-notes" id="profileClientNotes" style="display: none;">
                        <!-- Примечания -->
                    </div>
                </div>

                <!-- Статистика -->
                <div class="profile-section" style="grid-column: 1 / -1;">
                    <h3>📊 Статистика клиента</h3>
                    <div class="period-selector">
                        <label>Период:</label>
                        <select id="statisticsPeriod" onchange="updateClientStatistics()">
                            <option value="all">Всё время</option>
                            <option value="year">Текущий год</option>
                            <option value="quarter">Текущий квартал</option>
                            <option value="month">Текущий месяц</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="clientAvgOrderValue">0 RSD</div>
                            <div class="stat-label">Средняя сумма заказа</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientInvoiceCount">0</div>
                            <div class="stat-label">Количество инвойсов</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientTopProduct">-</div>
                            <div class="stat-label">Популярный продукт</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientYearlyConsumption">0 RSD</div>
                            <div class="stat-label">Потребление в год</div>
                        </div>
                    </div>
                    
                    <!-- График заказов клиента по месяцам -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #114A9F; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            📈 График заказов по месяцам
                        </h4>
                        <div id="clientMonthlyChart">График будет отображен здесь</div>
                    </div>
                    
                    <!-- Таблица товаров клиента -->
                    <div style="margin-top: 30px; background: #ffffff; border-radius: 12px; padding: 24px; border: 1px solid #e3e8ef; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 17px; font-weight: 700; border-bottom: 3px solid #114A9F; padding-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            📦 Товары клиента
                        </h4>
                        
                        <!-- Фильтр по месяцам -->
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: 600; color: #2c3e50; font-size: 14px;">От:</label>
                                <input type="month" id="clientProductsFromMonth" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; font-weight: 500; color: #2c3e50;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight: 600; color: #2c3e50; font-size: 14px;">До:</label>
                                <input type="month" id="clientProductsToMonth" style="padding: 8px 12px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; font-weight: 500; color: #2c3e50;">
                            </div>
                            <button onclick="updateClientProductsTable()" style="padding: 8px 20px; background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(17, 74, 159, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(17, 74, 159, 0.3)';">
                                🔍 Применить
                            </button>
                            <button onclick="resetClientProductsFilter()" style="padding: 8px 20px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#7f8c8d';" onmouseout="this.style.background='#95a5a6';">
                                🔄 Сбросить
                            </button>
                        </div>
                        
                        <!-- Таблица товаров -->
                        <div id="clientProductsTable" style="overflow-x: auto;">
                            Таблица товаров будет отображена здесь
                        </div>
                    </div>
                </div>
            </div>

            <!-- Форма редактирования (режим редактирования) -->
            <div id="edit-sections" class="profile-sections" style="display: none;">
                <div class="client-form-grid">
                    <!-- Основная информация -->
                    <div class="form-section">
                        <h4>📋 Основная информация</h4>
                        <div class="form-group">
                            <label>Название компании *</label>
                            <input type="text" id="editClientName" placeholder="Название компании">
                        </div>
                        <div class="form-group">
                            <label>Юридическое название *</label>
                            <input type="text" id="editClientLegalName" placeholder="Полное юридическое название">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Матични број *</label>
                                <input type="text" id="editClientMB" placeholder="Матични број">
                            </div>
                            <div class="form-group">
                                <label>ПИБ *</label>
                                <input type="text" id="editClientPIB" placeholder="ПИБ">
                            </div>
                            <div class="form-group">
                                <label>Аббревиатура (4-5 букв)</label>
                                <input type="text" id="editClientAbbreviation" placeholder="SVDA" maxlength="5" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 5)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Тип клиента</label>
                            <select id="editClientType">
                                <option value="">Выберите тип</option>
                                <option value="Бар">🍺 Бар</option>
                                <option value="Ресторан">🍽️ Ресторан</option>
                                <option value="Отель">🏨 Отель</option>
                                <option value="Кальянная">💨 Кальянная</option>
                                <option value="Кафе">☕ Кафе</option>
                                <option value="Чайная">🍵 Чайная</option>
                            </select>
                        </div>
                        <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label>Контактное лицо</label>
                                <input type="text" id="editClientContactPerson" placeholder="Имя контактного лица">
                            </div>
                            <div class="form-group">
                                <label>Статус контакта</label>
                                <select id="editClientContactPersonStatus">
                                    <option value="">Не указан</option>
                                    <option value="Владелец">👑 Владелец</option>
                                    <option value="Директор">👔 Директор</option>
                                    <option value="Управляющий">📋 Управляющий</option>
                                    <option value="Закупщик">🛒 Закупщик</option>
                                    <option value="Бармен">🍸 Бармен</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Банковский счет</label>
                                <input type="text" id="editClientBank" placeholder="Номер банковского счета">
                            </div>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="form-section">
                        <h4>📍 Адрес</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editManualAddressInput" style="width: auto;">
                                Ручной ввод адреса
                            </label>
                        </div>
                        
                        <!-- Автоматический ввод адреса -->
                        <div id="editAutoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Город *</label>
                                    <input type="text" id="editClientCity" placeholder="Город">
                                </div>
                                <div class="form-group">
                                    <label>Община *</label>
                                    <input type="text" id="editClientMunicipality" placeholder="Община">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Улица *</label>
                                    <input type="text" id="editClientStreet" placeholder="Улица">
                                </div>
                                <div class="form-group">
                                    <label>Номер дома</label>
                                    <input type="text" id="editClientHouseNumber" placeholder="Номер дома">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ручной ввод адреса -->
                        <div id="editManualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>Полный адрес *</label>
                                <textarea id="editClientManualAddress" placeholder="Введите полный адрес" rows="3" style="resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ссылка на Google Maps</label>
                            <input type="text" id="editClientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="form-section">
                        <h4>📞 Контактные данные</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Телефон</label>
                                <input type="text" id="editClientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editClientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="editClientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="editClientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- Дополнительные контакты -->
                    <div class="form-section">
                        <h4 style="display: flex; justify-content: space-between; align-items: center;">
                            👥 Дополнительные контакты
                            <button type="button" onclick="addEditAdditionalContact()" class="btn btn-success" style="padding: 6px 14px; font-size: 13px;">+ Добавить контакт</button>
                        </h4>
                        <div id="editAdditionalContactsContainer" style="display: grid; gap: 15px;">
                            <!-- Дополнительные контакты будут здесь -->
                        </div>
                        <p id="editNoAdditionalContacts" style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">
                            Нет дополнительных контактов. Нажмите "Добавить контакт" для создания.
                        </p>
                    </div>

                    <!-- Условия сотрудничества -->
                    <div class="form-section">
                        <h4>🤝 Условия сотрудничества</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editClientInstallment" style="transform: scale(1.2);">
                                    <span>Рассрочка оплаты</span>
                                </label>
                                <input type="text" id="editClientInstallmentTerm" placeholder="Срок (дни)" style="margin-top: 5px;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientShowcase" style="transform: scale(1.2);">
                                        <span>Витрина</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientBar" style="transform: scale(1.2);">
                                        <span>Бар</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Примечания</label>
                            <textarea id="editClientNotes" placeholder="Дополнительные примечания о клиенте" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки режима просмотра -->
            <div id="viewModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-primary" onclick="switchToEditMode()" style="margin-right: 10px;">✏️ Редактировать</button>
                <button class="btn btn-primary" onclick="switchToClientHistory()" style="margin-right: 10px;">📋 История заказов</button>
                <button class="btn btn-secondary" onclick="closeClientProfileModal()">❌ Закрыть</button>
            </div>

            <!-- Кнопки режима редактирования -->
            <div id="editModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef; display: none;">
                <button class="btn btn-primary" onclick="saveClientChanges()" style="margin-right: 10px;">✅ Сохранить изменения</button>
                <button class="btn btn-secondary" onclick="switchToViewMode()" style="margin-right: 10px;">❌ Отмена</button>
            </div>

            <!-- История заказов -->
            <div id="clientHistorySection" style="display: none;">
                <div class="client-card-header">
                    <div class="client-avatar" id="historyClientAvatar">КЛ</div>
                    <div class="client-title-info">
                        <h2 id="historyClientTitle">История заказов</h2>
                        <p id="historyClientSubtitle">Инвойсы и отпремницы клиента</p>
                    </div>
                    <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
                </div>
                
                <div style="padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="switchToClientProfile()">← Обратно к профилю</button>
                        <button class="btn btn-primary" onclick="exportClientHistoryToPDF()">📄 Экспорт в PDF</button>
                    </div>
                    
                    <!-- Вкладки истории -->
                    <div class="history-tabs" style="margin-bottom: 20px;">
                        <button class="history-tab active" onclick="switchHistoryTab('invoices')" id="invoicesTab">
                            📄 Предрачуны (<span id="invoicesCount">0</span>)
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('racuns')" id="racunsTab">
                            📋 Рачуны (<span id="racunsCount">0</span>)
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('deliveries')" id="deliveriesTab">
                            📦 Отпремницы (<span id="deliveriesCount">0</span>)
                        </button>
                    </div>
                    
                    <!-- Контент предрачунов -->
                    <div id="clientInvoicesContent" style="max-height: 60vh; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">Загрузка...</p>
                    </div>
                    
                    <!-- Контент рачунов -->
                    <div id="clientRacunsContent" style="max-height: 60vh; overflow-y: auto; display: none;">
                        <p style="text-align: center; color: #666;">Загрузка...</p>
                    </div>
                    
                    <!-- Контент отпремниц -->
                    <div id="clientDeliveriesContent" style="max-height: 60vh; overflow-y: auto; display: none;">
                        <p style="text-align: center; color: #666;">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования товара клиента -->
    <div id="clientEditProductModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Редактировать товар</h2>
                <button class="close" onclick="closeClientEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название товара *</label>
                    <input type="text" id="clientEditProductName" placeholder="Название товара">
                </div>
                <div class="form-group">
                    <label>Вес (г) *</label>
                    <input type="number" id="clientEditProductWeight" placeholder="210" step="0.1" min="0.1">
                </div>
                <input type="hidden" id="clientEditProductInternalCode">
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="saveClientProductChanges()">Сохранить</button>
                <button class="btn btn-secondary" onclick="closeClientEditProductModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для пополнения запасов чая -->
    <div id="teaStockModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="teaStockModalTitle">Пополнить запас чая</h3>
                <span class="close" onclick="closeTeaStockModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Категория чая</label>
                    <input type="text" id="teaStockCategory" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>Текущий запас</label>
                    <input type="text" id="teaStockCurrent" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>Добавить количество (г) *</label>
                    <input type="number" id="teaStockAmount" placeholder="1000" min="1" step="1">
                </div>
                <div class="form-group">
                    <label>Комментарий</label>
                    <textarea id="teaStockComment" placeholder="Поступление от поставщика..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 0 0 0; border-top: 1px solid #dee2e6; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeTeaStockModal()">Отмена</button>
                <button class="btn btn-primary" onclick="addTeaStock()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для загрузки предрачуна -->
    <div id="uploadPredracunModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Загрузить предрачун</h3>
                <span class="close" onclick="closeUploadPredracunModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Выберите файл предрачуна (HTML, PDF или изображение)</label>
                    <input type="file" id="predracunFileInput" accept=".html,.pdf,.jpg,.jpeg,.png,.gif" style="width: 100%; padding: 12px; border: 2px dashed #dee2e6; border-radius: 8px; background: #f8f9fa;">
                </div>
                
                <div id="predracunPreview" style="display: none; margin-top: 20px;">
                    <h4>Предпросмотр загруженного предрачуна:</h4>
                    <div id="predracunContent" style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa; max-height: 400px; overflow-y: auto;"></div>
                </div>
                
                <div id="extractedData" style="display: none; margin-top: 20px;">
                    <h4>Извлеченные данные:</h4>
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                        <div class="form-group">
                            <label>Клиент</label>
                            <input type="text" id="extractedClient" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>Товары</label>
                            <div id="extractedItems" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 0 0 0; border-top: 1px solid #dee2e6; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeUploadPredracunModal()">Отмена</button>
                <button class="btn btn-primary" id="generateRacunFromPredracun" onclick="generateRacunFromUploadedPredracun()" style="display: none;">Создать рачун</button>
            </div>
        </div>
    </div>

      <!-- Модальное окно для редактирования клиента -->
      <div id="editClientModal" class="modal">
          <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
              <div class="modal-header">
                  <h3>Редактировать клиента</h3>
                  <span class="close" onclick="closeEditClientModal()">&times;</span>
              </div>
              <div class="modal-body">
                  <div class="client-form-grid">
                      <!-- Основная информация -->
                      <div class="form-section">
                          <h4>📋 Основная информация</h4>
                          <div class="form-group">
                              <label>Название компании *</label>
                              <input type="text" id="editClientName" placeholder="Название компании">
                          </div>
                          <div class="form-group">
                              <label>Юридическое название *</label>
                              <input type="text" id="editClientLegalName" placeholder="Полное юридическое название">
                          </div>
                          <div class="form-row">
                              <div class="form-group">
                                  <label>Матични број *</label>
                                  <input type="text" id="editClientMB" placeholder="Матични број">
                              </div>
                              <div class="form-group">
                                  <label>ПИБ *</label>
                                  <input type="text" id="editClientPIB" placeholder="ПИБ">
                              </div>
                              <div class="form-group">
                                  <label>Аббревиатура (4-5 букв)</label>
                                  <input type="text" id="editClientAbbreviation" placeholder="SVDA" maxlength="5" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 5)">
                              </div>
                          </div>
                          <div class="form-row">
                              <div class="form-group">
                                  <label>Контактное лицо</label>
                                  <input type="text" id="editClientContactPerson" placeholder="Имя контактного лица">
                              </div>
                              <div class="form-group">
                                  <label>Банковский счет</label>
                                  <input type="text" id="editClientBank" placeholder="Номер банковского счета">
                              </div>
                          </div>
                      </div>

                      <!-- Адрес -->
                      <div class="form-section">
                          <h4>📍 Адрес</h4>
                          <div class="form-group">
                              <label style="display: flex; align-items: center; gap: 10px;">
                                  <input type="checkbox" id="editManualAddressInput" style="width: auto;" onchange="toggleEditAddressInput()">
                                  Ручной ввод адреса
                              </label>
                          </div>
                          
                          <!-- Автоматический ввод адреса -->
                          <div id="editAutoAddressSection">
                              <div class="form-row">
                                  <div class="form-group">
                                      <label>Город *</label>
                                      <div class="searchable-select">
                                          <input type="text" class="searchable-input" id="editClientCity" placeholder="Введите название города..." autocomplete="off">
                                          <div class="dropdown-menu" id="editClientCityDropdown"></div>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <label>Община *</label>
                                      <div class="searchable-select">
                                          <input type="text" class="searchable-input" id="editClientMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                                          <div class="dropdown-menu" id="editClientMunicipalityDropdown"></div>
                                      </div>
                                  </div>
                              </div>
                              <div class="form-row">
                                  <div class="form-group">
                                      <label>Улица *</label>
                                      <div class="searchable-select">
                                          <input type="text" class="searchable-input" id="editClientStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                                          <div class="dropdown-menu" id="editClientStreetDropdown"></div>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <label>Номер дома</label>
                                      <input type="text" id="editClientHouseNumber" placeholder="Номер дома">
                                  </div>
                              </div>
                          </div>
                          
                          <!-- Ручной ввод адреса -->
                          <div id="editManualAddressSection" style="display: none;">
                              <div class="form-group">
                                  <label>Полный адрес *</label>
                                  <textarea id="editClientManualAddress" placeholder="Введите полный адрес (например: Beograd, Stari grad, Knez Mihailova 5)" rows="3" style="resize: vertical;"></textarea>
                                  <small style="color: #666; font-size: 12px;">Укажите полный адрес в произвольной форме</small>
                              </div>
                          </div>
                          
                          <div class="form-group">
                              <label>Ссылка на Google Maps</label>
                              <input type="text" id="editClientGoogleMaps" placeholder="https://maps.google.com/...">
                          </div>
                      </div>

                      <!-- Контактные данные -->
                      <div class="form-section">
                          <h4>📞 Контактные данные</h4>
                          <div class="form-row">
                              <div class="form-group">
                                  <label>Телефон</label>
                                  <input type="text" id="editClientPhone" placeholder="+381 XX XXX XXXX">
                              </div>
                              <div class="form-group">
                                  <label>Email</label>
                                  <input type="email" id="editClientEmail" placeholder="email@example.com">
                              </div>
                          </div>
                          <div class="form-row">
                              <div class="form-group">
                                  <label>Telegram</label>
                                  <input type="text" id="editClientTelegram" placeholder="@username">
                              </div>
                              <div class="form-group">
                                  <label>Instagram</label>
                                  <input type="text" id="editClientInstagram" placeholder="@username">
                              </div>
                          </div>
                      </div>

                      <!-- Условия сотрудничества -->
                      <div class="form-section">
                          <h4>🤝 Условия сотрудничества</h4>
                          <div class="form-row">
                              <div class="form-group">
                                  <label style="display: flex; align-items: center; gap: 5px;">
                                      <input type="checkbox" id="editClientInstallment" style="transform: scale(1.2);">
                                      <span>Рассрочка оплаты</span>
                                  </label>
                                  <input type="text" id="editClientInstallmentTerm" placeholder="Срок (дни)" style="margin-top: 5px;">
                              </div>
                              <div class="form-group">
                                  <div style="display: flex; gap: 15px;">
                                      <label style="display: flex; align-items: center; gap: 5px;">
                                          <input type="checkbox" id="editClientShowcase" style="transform: scale(1.2);">
                                          <span>Витрина</span>
                                      </label>
                                      <label style="display: flex; align-items: center; gap: 5px;">
                                          <input type="checkbox" id="editClientBar" style="transform: scale(1.2);">
                                          <span>Бар</span>
                                      </label>
                                  </div>
                              </div>
                          </div>
                          <div class="form-group">
                              <label>Примечания</label>
                              <textarea id="editClientNotes" placeholder="Дополнительные примечания о клиенте" rows="3" style="resize: vertical;"></textarea>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="closeEditClientModal()">❌ Отмена</button>
                  <button class="btn btn-primary" onclick="saveClientChanges()">✅ Сохранить изменения</button>
              </div>
          </div>
      </div>

    <!-- Модальное окно для списания товаров -->
    <div id="deductStockModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>📉 Списать товар со склада</h3>
                <span class="close" onclick="closeDeductStockModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #e3e8ef;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Группа товара:</div>
                    <div id="deductGroupName" style="font-size: 16px; color: #114A9F;"></div>
                    <div id="deductGroupCode" style="font-size: 13px; color: #666; margin-top: 3px;"></div>
                    <div id="deductGroupAvailable" style="font-size: 14px; color: #28a745; margin-top: 8px; font-weight: 600;"></div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Количество для списания *</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="deductQuantityType" style="flex: 0 0 80px; padding: 10px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;">
                            <option value="weight">Вес</option>
                            <option value="pieces">Ед.</option>
                        </select>
                        <input type="number" id="deductQuantity" placeholder="100" style="flex: 1; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" min="0" step="0.1">
                        <span id="deductQuantityUnit" style="align-self: center; color: #666; font-weight: 500;">г</span>
                    </div>
                    <div id="deductQuantityError" style="color: #dc3545; font-size: 13px; margin-top: 5px; display: none;"></div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Основание списания *</label>
                    <select id="deductReason" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;">
                        <option value="">Выберите основание...</option>
                        <option value="sale">📦 Продажа</option>
                        <option value="defect">❌ Брак</option>
                        <option value="return">↩️ Возврат</option>
                        <option value="production">🏭 Использовано в производстве</option>
                        <option value="sampling">🧪 Отбор проб</option>
                        <option value="expired">⏰ Истек срок годности</option>
                        <option value="loss">📉 Потеря/убыль</option>
                        <option value="marketing">📢 Маркетинг</option>
                        <option value="other">📝 Другое</option>
                    </select>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Комментарий</label>
                    <textarea id="deductComment" placeholder="Дополнительная информация о списании (опционально)" rows="3" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div id="deductWarning" style="background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 12px 16px; border-radius: 8px; margin-top: 20px; display: none; font-size: 13px;">
                    <strong>⚠️ Внимание:</strong> После списания товара данное действие нельзя будет отменить.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeductStockModal()">❌ Отмена</button>
                <button class="btn btn-danger" onclick="confirmDeductStock()">📉 Списать</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно истории списаний -->
    <!-- Модальное окно истории группы -->
    <div id="deductHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 950px; max-height: 90vh;">
            <div class="modal-header">
                <h3>📋 История группы</h3>
                <span class="close" onclick="closeDeductHistoryModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Информация о группе -->
                <div style="background: #f8fafc; padding: 15px 20px; border-bottom: 1px solid #e3e8ef;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Группа товара:</div>
                    <div id="historyGroupName" style="font-size: 16px; color: #114A9F;"></div>
                    <div id="historyGroupCode" style="font-size: 13px; color: #666; margin-top: 3px;"></div>
                </div>
                
                <!-- Вкладки -->
                <div style="display: flex; border-bottom: 2px solid #e3e8ef; background: #f8fafc;">
                    <button id="historyTabDeductions" onclick="switchGroupHistoryTab('deductions')" 
                            style="flex: 1; padding: 14px 20px; border: none; background: #114A9F; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid #114A9F;">
                        📉 История списания
                    </button>
                    <button id="historyTabReceipts" onclick="switchGroupHistoryTab('receipts')" 
                            style="flex: 1; padding: 14px 20px; border: none; background: transparent; color: #666; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent;">
                        📥 История поступлений
                    </button>
                </div>
                
                <!-- Содержимое вкладки списаний -->
                <div id="historyContentDeductions" style="padding: 20px;">
                    <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; opacity: 0.95; margin-bottom: 5px;">Всего списано вручную</div>
                            <div id="historyTotalDeducted" style="font-size: 32px; font-weight: 700;">0 г</div>
                        </div>
                    </div>

                    <div id="deductHistoryList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Здесь будет список списаний -->
                    </div>
                </div>
                
                <!-- Содержимое вкладки поступлений -->
                <div id="historyContentReceipts" style="padding: 20px; display: none;">
                    <div style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; opacity: 0.95; margin-bottom: 5px;">Всего поступлений</div>
                            <div id="historyTotalReceipts" style="font-size: 32px; font-weight: 700;">0 г</div>
                        </div>
                    </div>

                    <div id="receiptsHistoryList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Здесь будет список поступлений -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeductHistoryModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для пополнения расходников -->
    <div id="consumableReplenishModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                <h3 style="color: white; margin: 0;">➕ Пополнить расходник</h3>
                <span class="close" onclick="closeConsumableReplenishModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #e3e8ef;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Группа расходников:</div>
                    <div id="replenishConsumableName" style="font-size: 16px; color: #28a745; font-weight: 600;"></div>
                    <div id="replenishConsumableCode" style="font-size: 13px; color: #666; margin-top: 3px;"></div>
                    <div id="replenishConsumableAvailable" style="font-size: 14px; color: #28a745; margin-top: 8px; font-weight: 600;"></div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Количество для пополнения *</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="replenishConsumableQuantity" placeholder="100" style="flex: 1; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" min="0" step="0.1">
                        <span id="replenishConsumableUnit" style="align-self: center; color: #666; font-weight: 500; min-width: 40px;">шт</span>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Цена закупки за единицу</label>
                    <input type="number" id="replenishConsumablePrice" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;">
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Комментарий</label>
                    <textarea id="replenishConsumableComment" placeholder="Дополнительная информация (опционально)" rows="2" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConsumableReplenishModal()">❌ Отмена</button>
                <button class="btn btn-success" onclick="confirmConsumableReplenish()">➕ Пополнить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для списания расходников -->
    <div id="consumableDeductModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                <h3 style="color: white; margin: 0;">📤 Списать расходник</h3>
                <span class="close" onclick="closeConsumableDeductModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #e3e8ef;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Группа расходников:</div>
                    <div id="deductConsumableName" style="font-size: 16px; color: #ff9800; font-weight: 600;"></div>
                    <div id="deductConsumableCode" style="font-size: 13px; color: #666; margin-top: 3px;"></div>
                    <div id="deductConsumableAvailable" style="font-size: 14px; color: #28a745; margin-top: 8px; font-weight: 600;"></div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Количество для списания *</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="deductConsumableQuantity" placeholder="10" style="flex: 1; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;" min="0" step="0.1">
                        <span id="deductConsumableUnit" style="align-self: center; color: #666; font-weight: 500; min-width: 40px;">шт</span>
                    </div>
                    <div id="deductConsumableError" style="color: #dc3545; font-size: 13px; margin-top: 5px; display: none;"></div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Основание списания *</label>
                    <select id="deductConsumableReason" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px;">
                        <option value="">Выберите основание...</option>
                        <option value="production">🏭 Использовано в производстве</option>
                        <option value="sale">📦 Продажа</option>
                        <option value="defect">❌ Брак</option>
                        <option value="expired">⏰ Истек срок годности</option>
                        <option value="loss">📉 Потеря/убыль</option>
                        <option value="other">📝 Другое</option>
                    </select>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 8px;">Комментарий</label>
                    <textarea id="deductConsumableComment" placeholder="Дополнительная информация (опционально)" rows="2" style="width: 100%; padding: 10px 14px; border: 2px solid #e3e8ef; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div id="deductConsumableWarning" style="background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 12px 16px; border-radius: 8px; margin-top: 15px; display: none; font-size: 13px;">
                    <strong>⚠️ Внимание:</strong> После списания данное действие нельзя будет отменить.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConsumableDeductModal()">❌ Отмена</button>
                <button class="btn btn-warning" onclick="confirmConsumableDeduct()" style="background: #ff9800; border-color: #ff9800;">📤 Списать</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра поставки -->
    <div id="shipmentViewModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                <h3 style="color: white; margin: 0;">📦 Детали поставки</h3>
                <button class="close" onclick="closeShipmentViewModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <!-- Основная информация -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">НОМЕР ПОСТАВКИ</div>
                        <div style="font-size: 18px; font-weight: 700; color: #333;" id="viewShipmentNumber">-</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ПОСТАВЩИК</div>
                        <div style="font-size: 18px; font-weight: 700; color: #333;" id="viewShipmentSupplier">-</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">📅 ДАТА ОТПРАВКИ</div>
                        <div style="font-size: 16px; font-weight: 600; color: #f57c00;" id="viewShipmentSendDate">-</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">📅 ДАТА ПРИЁМА</div>
                        <div style="font-size: 16px; font-weight: 600; color: #388e3c;" id="viewShipmentReceiveDate">-</div>
                    </div>
                </div>

                <!-- Товары -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">🛒 Товары в партии</h4>
                    <div id="viewShipmentItems" style="max-height: 250px; overflow-y: auto;">
                        <!-- Товары будут отображены здесь -->
                    </div>
                    <div style="background: #fff8e1; padding: 12px 15px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; font-weight: 600;">
                        <span>Итого товары:</span>
                        <span id="viewShipmentProductsTotal">0 RSD</span>
                    </div>
                </div>

                <!-- Расходы -->
                <div style="margin-bottom: 25px;">
                    <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #17a2b8; padding-bottom: 10px;">💰 Расходы</h4>
                    <div id="viewShipmentExpenses" style="display: grid; gap: 10px;">
                        <!-- Расходы будут отображены здесь -->
                    </div>
                </div>

                <!-- Финальная сумма -->
                <div style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); padding: 20px; border-radius: 10px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ОБЩАЯ СТОИМОСТЬ ПАРТИИ</div>
                            <div style="font-size: 28px; font-weight: 700;" id="viewShipmentTotal">0 RSD</div>
                        </div>
                        <div style="text-align: right; font-size: 13px; opacity: 0.9;">
                            <div>Товары (без НДС): <span id="viewShipmentProductsTotal">0</span> RSD</div>
                            <div>НДС товаров: <span id="viewShipmentProductsVAT">0</span> RSD</div>
                            <div>Логистика (без НДС): <span id="viewShipmentLogisticsTotal">0</span> RSD</div>
                            <div>НДС логистики: <span id="viewShipmentLogisticsVAT">0</span> RSD</div>
                            <div>Комиссия: <span id="viewShipmentCommission">0</span> RSD</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-between; font-size: 13px; opacity: 0.9;">
                        <div>Себестоимость (равном.): <span id="viewShipmentCostPrice1">0</span> RSD/кг</div>
                        <div>Себестоимость (пропорц.): <span id="viewShipmentCostPrice2">0</span> RSD/кг</div>
                    </div>
                </div>

                <!-- Примечание -->
                <div id="viewShipmentNoteSection" style="display: none; margin-top: 15px; background: #f5f5f5; padding: 15px; border-radius: 8px;">
                    <div style="color: #666; font-size: 12px; margin-bottom: 5px;">ПРИМЕЧАНИЕ</div>
                    <div style="color: #333;" id="viewShipmentNote">-</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteShipment()" style="margin-right: auto;">🗑️ Удалить</button>
                <button class="btn btn-warning" onclick="editShipment()" style="background: #ff9800; border-color: #ff9800;">✏️ Редактировать</button>
                <button class="btn btn-secondary" onclick="closeShipmentViewModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования группы склада -->
    <div id="editWarehouseGroupModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                <h3 style="color: white; margin: 0;">✏️ Редактирование группы</h3>
                <button class="modal-close" onclick="closeEditWarehouseGroupModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <input type="hidden" id="editGroupId">
                <div class="form-group">
                    <label>Код группы *</label>
                    <input type="text" id="editGroupCode" placeholder="Введите код группы">
                </div>
                <div class="form-group">
                    <label>Название группы *</label>
                    <input type="text" id="editGroupName" placeholder="Введите название">
                </div>
                <div class="form-group">
                    <label>Поставщик</label>
                    <input type="text" id="editGroupSupplier" placeholder="Поставщик">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="editGroupCategory" onchange="loadEditGroupSubcategories()">
                            <option value="">Выберите категорию</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Субкатегория</label>
                        <select id="editGroupSubcategory">
                            <option value="">Выберите субкатегорию</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Тип количества</label>
                        <select id="editGroupQuantityType">
                            <option value="weight">Вес (граммы)</option>
                            <option value="pieces">Штуки</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Текущий остаток</label>
                        <input type="number" id="editGroupCurrentQuantity" step="0.1">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Себестоимость (равномерная)</label>
                        <input type="number" id="editGroupCostPrice1" step="0.01" placeholder="RSD/кг">
                    </div>
                    <div class="form-group">
                        <label>Себестоимость (пропорц.)</label>
                        <input type="number" id="editGroupCostPrice2" step="0.01" placeholder="RSD/кг">
                    </div>
                </div>
                <div class="form-group">
                    <label>Дата отгрузки</label>
                    <input type="date" id="editGroupShipmentDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditWarehouseGroupModal()">Отмена</button>
                <button class="btn btn-primary" onclick="saveWarehouseGroupChanges()">💾 Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора группы для замены -->
    <div id="replacementGroupModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                <h3 style="color: white; margin: 0;">🔄 Выбор группы для замены</h3>
                <button class="modal-close" onclick="closeReplacementModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <input type="hidden" id="replacementSourceGroupId">
                <p style="margin-bottom: 20px; color: #666;">Выберите группу, на которую был заменён товар:</p>
                
                <!-- DEBUG LOG AREA (hidden) -->
                <div id="replacementDebugLog" style="display: none;"></div>
                
                <div class="form-group">
                    <label>Поиск группы</label>
                    <input type="text" id="replacementGroupSearch" placeholder="Введите код или название группы..." oninput="filterReplacementGroups()" style="width: 100%; padding: 12px; border: 2px solid #ff9800; border-radius: 8px;">
                </div>
                <div id="replacementGroupsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; margin-top: 10px;">
                    <!-- Список групп для выбора -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReplacementModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно информации о замене -->
    <div id="replacementInfoModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                <h3 style="color: white; margin: 0;">🔄 Информация о замене</h3>
                <button class="modal-close" onclick="closeReplacementInfoModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px; text-align: center;">
                <p style="margin-bottom: 15px; color: #666;">Товар был заменён на:</p>
                <div id="replacementInfoContent" style="padding: 20px; background: #fff3e0; border-radius: 12px; border: 2px solid #ff9800;">
                    <!-- Информация о группе замены -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReplacementInfoModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // API CLIENT MODULE
        // ==============================================
        
        // API Configuration
        const API_CONFIG = {
            baseURL: window.location.origin, // Автоматически определяет URL (localhost или prod)
            timeout: 30000, // 30 секунд
            retryAttempts: 3,
            retryDelay: 1000
        };
        
        // API Client с обработкой ошибок и JWT токенов
        class APIClient {
            constructor(config) {
                this.baseURL = config.baseURL;
                this.timeout = config.timeout;
                this.retryAttempts = config.retryAttempts;
                this.retryDelay = config.retryDelay;
            }
            
            // Получить токен из localStorage
            getToken() {
                return localStorage.getItem('authToken');
            }
            
            // Сохранить токен
            setToken(token) {
                localStorage.setItem('authToken', token);
            }
            
            // Удалить токен
            clearToken() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
            }
            
            // Базовый метод для API вызовов
            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const token = this.getToken();
                
                const defaultHeaders = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    defaultHeaders['Authorization'] = `Bearer ${token}`;
                }
                
                const config = {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    }
                };
                
                try {
                    console.log(`🌐 API Call: ${options.method || 'GET'} ${endpoint}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), this.timeout);
                    
                    const response = await fetch(url, {
                        ...config,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // Проверка статуса ответа
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new APIError(
                            errorData.error || `HTTP Error ${response.status}`,
                            response.status,
                            errorData
                        );
                    }
                    
                    const data = await response.json();
                    console.log(`✅ API Success: ${endpoint}`, data);
                    return data;
                    
                } catch (error) {
                    console.error(`❌ API Error: ${endpoint}`, error);
                    
                    // Обработка ошибок
                    if (error.name === 'AbortError') {
                        throw new APIError('Request timeout', 408);
                    }
                    
                    if (error instanceof APIError) {
                        // Если 401 - токен истек, выход
                        if (error.status === 401) {
                            console.warn('🔒 Token expired, logging out...');
                            this.clearToken();
                            // Можно добавить редирект на страницу входа
                        }
                        throw error;
                    }
                    
                    throw new APIError(error.message || 'Network error', 0, error);
                }
            }
            
            // GET запрос
            async get(endpoint, params = {}) {
                const queryString = new URLSearchParams(params).toString();
                const url = queryString ? `${endpoint}?${queryString}` : endpoint;
                return this.request(url, { method: 'GET' });
            }
            
            // POST запрос
            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
            
            // PUT запрос
            async put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }
            
            // DELETE запрос
            async delete(endpoint) {
                return this.request(endpoint, {
                    method: 'DELETE'
                });
            }
            
            // Retry логика для важных запросов
            async requestWithRetry(endpoint, options, attempts = this.retryAttempts) {
                try {
                    return await this.request(endpoint, options);
                } catch (error) {
                    if (attempts > 1 && error.status !== 401 && error.status !== 403) {
                        console.warn(`⚠️ Retrying... (${this.retryAttempts - attempts + 1}/${this.retryAttempts})`);
                        await new Promise(resolve => setTimeout(resolve, this.retryDelay));
                        return this.requestWithRetry(endpoint, options, attempts - 1);
                    }
                    throw error;
                }
            }
        }
        
        // Кастомный класс ошибок API
        class APIError extends Error {
            constructor(message, status = 0, data = null) {
                super(message);
                this.name = 'APIError';
                this.status = status;
                this.data = data;
            }
        }
        
        // Инициализация API клиента
        // TAURI MODE: window.api уже определен в tauri-adapter.js
        if (!window.api) {
            console.error("❌ Tauri API не загружен!");
            alert("Ошибка: Tauri API не доступен. Перезапустите приложение.");
        }
        
        // ==============================================
        // API SERVICE METHODS
        // ==============================================
        // API определения загружаются из tauri-api-wrappers.js
        // (ProductsAPI, ClientsAPI, InvoicesAPI, DeliveriesAPI, TeaStocksAPI, AuthAPI)
        
        // ==============================================
        // GLOBAL VARIABLES
        // ==============================================
        
        let clients = [], products = [], confirmedInvoices = [], confirmedPredracuns = [], confirmedRacuns = [], confirmedDeliveries = [], currentInvoiceData = null, invoiceItems = [];
        
        // ==============================================
        // DATA LOADING HELPERS (API + LocalStorage Fallback)
        // ==============================================
        
        // Проверка аутентификации
        function isAuthenticated() {
            const token = localStorage.getItem('authToken');
            return !!token;
        }
        
        // Показать/скрыть индикатор загрузки
        function showLoadingIndicator(show, message = 'Загрузка...') {
            let indicator = document.getElementById('loadingIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loadingIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    z-index: 10000;
                    font-size: 16px;
                    display: none;
                `;
                document.body.appendChild(indicator);
            }
            indicator.textContent = message;
            indicator.style.display = show ? 'block' : 'none';
        }
        
        // Загрузка клиентов из API или localStorage
        async function loadClients() {
            try {
                console.log('📥 Loading clients from API...');
                const response = await ClientsAPI.getAll({ limit: 1000 });
                clients = response.clients || [];
                console.log(`✅ Loaded ${clients.length} clients from API`);
                
                // Подтягиваем дополнительные контакты из localStorage
                mergeAdditionalContactsFromLocalStorage();
                
                return true;
            } catch (error) {
                console.warn('⚠️ Failed to load clients from API:', error.message);
                // Fallback на localStorage
                const savedClients = localStorage.getItem('clients');
                if (savedClients) {
                    clients = JSON.parse(savedClients);
                    console.log(`📦 Loaded ${clients.length} clients from localStorage (fallback)`);
                } else {
                    // Дефолтные клиенты если ничего нет
                    clients = [
                        { name: "SVDA DOO", mb: "22058282", pib: "114703885", address: "Beograd, Stari grad, Majke Jevrosime 19", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Majke Jevrosime", houseNumber: "19" },
                        { name: "AUDITORIA DOO BEOGRAD", mb: "22043277", pib: "114586673", address: "Beograd, Voždovac, Vojvode Dobrnca 48", contact: "", bank: "190-0000000097100 (Алта банка А.Д.)", city: "Beograd", municipality: "Voždovac", street: "Vojvode Dobrnca", houseNumber: "48" },
                        { name: "Aleksandra Tarasenko PR", mb: "67249208", pib: "114000935", address: "Novi Sad, Novi Sad, Masarikova 18", contact: "Ugostiteljska radnja Seal & Tea", bank: "", city: "Novi Sad", municipality: "Novi Sad", street: "Masarikova", houseNumber: "18" }
                    ];
                    console.log(`📝 Using default clients`);
                }
                return false;
            }
        }
        
        // Функция для объединения дополнительных контактов из localStorage с данными из API
        function mergeAdditionalContactsFromLocalStorage() {
            const savedClients = localStorage.getItem('clients');
            if (!savedClients) return;
            
            try {
                const localClients = JSON.parse(savedClients);
                
                clients.forEach(client => {
                    // Ищем соответствующего клиента в localStorage по ID или MB
                    const localClient = localClients.find(lc => 
                        (lc.id && lc.id === client.id) || 
                        (lc.mb && lc.mb === client.mb)
                    );
                    
                    if (localClient && localClient.additionalContacts && localClient.additionalContacts.length > 0) {
                        client.additionalContacts = localClient.additionalContacts;
                        console.log(`👥 Merged ${localClient.additionalContacts.length} additional contacts for client: ${client.name}`);
                    }
                });
            } catch (e) {
                console.error('Error merging additional contacts:', e);
            }
        }
        
        // Загрузка товаров из API или localStorage
        async function loadProducts() {
            try {
                console.log('📥 Loading products from API...');
                const response = await ProductsAPI.getAll({ limit: 1000 });
                products = response.products || [];
                console.log(`✅ Loaded ${products.length} products from API`);
                return true;
            } catch (error) {
                console.warn('⚠️ Failed to load products from API:', error.message);
                // Дефолтные продукты
                products = [
                    { code: "GF-B-TG210", name: "Tieguanyin/Zeleni Čaj 210g", price: 2297, category: "Zeleni Čaj", weight: 210 },
                    { code: "GF-B-EG210", name: "Earl Grey/Crni Čaj 210g", price: 1850, category: "Crni Čaj", weight: 210 },
                    { code: "GF-G-JG210", name: "Jasmine Green Beverage/Zeleni Čaj 210g", price: 1837, category: "Zeleni Čaj", weight: 210 }
                ];
                console.log(`📝 Using default products`);
                return false;
            }
        }
        
        // Загрузка инвойсов из API
        async function loadInvoices() {
            try {
                console.log('═══════════════════════════════════════');
                console.log('📥 ЗАГРУЗКА ИНВОЙСОВ ИЗ API');
                console.log('═══════════════════════════════════════');
                
                const response = await InvoicesAPI.getAll({ limit: 1000 });
                console.log('📦 Raw response:', response);
                console.log('📦 Response type:', typeof response);
                console.log('📦 Response keys:', Object.keys(response || {}));
                
                const allInvoices = response.invoices || response || [];
                
                console.log('📦 Invoices array:', allInvoices);
                console.log('📦 Invoices count:', allInvoices.length);
                console.log('📦 First invoice:', allInvoices[0]);
                
                if (!Array.isArray(allInvoices)) {
                    console.error('❌ allInvoices is not an array!');
                    throw new Error('Invalid invoices data format');
                }
                
                // Дополняем инвойсы полными данными клиента и items
                for (let inv of allInvoices) {
                    // === ВАЖНО: Добавляем поля для обратной совместимости ===
                    if (!inv.number && inv.invoiceNumber) {
                        // Убираем префиксы p и o для отображения
                        inv.number = inv.invoiceNumber.replace(/^[po]/, '');
                    }
                    
                    // Добавляем дополнительные поля если их нет
                    if (!inv.date && inv.createdAt) {
                        inv.date = inv.createdAt;
                    }
                    if (!inv.total) {
                        inv.total = 0;
                    }
                    if (!inv.vatRate) {
                        inv.vatRate = 20; // Значение по умолчанию
                    }
                    
                    // Добавляем данные клиента
                    if (inv.clientId && !inv.client) {
                        // Ищем клиента по ID (МБ)
                        const client = clients.find(c => c.mb === inv.clientId || String(c.id) === inv.clientId);
                        if (client) {
                            inv.client = client;
                        } else {
                            // Создаем минимальный объект клиента из сохраненных данных
                            inv.client = {
                                name: inv.clientName || 'Unknown',
                                mb: inv.clientId || '',
                                pib: '',
                                address: '',
                                contact: ''
                            };
                        }
                    }
                    
                    // Загружаем items для инвойса если их нет
                    if (!inv.items && inv.id) {
                        try {
                            const invoiceWithItems = await InvoicesAPI.getById(inv.id);
                            if (invoiceWithItems && invoiceWithItems.items) {
                                inv.items = invoiceWithItems.items;
                                
                                // Дополняем каждый item полными данными товара
                                for (let item of inv.items) {
                                    if (item.productId && !item.product) {
                                        // Ищем товар по productId (внутренний код)
                                        const product = products.find(p => p.internalCode === item.productId || p.code === item.productId);
                                        if (product) {
                                            item.product = product;
                                        } else {
                                            // Создаем минимальный объект товара
                                            item.product = {
                                                code: item.productId || '',
                                                internalCode: item.productId || '',
                                                name: item.productName || 'Unknown',
                                                price: item.price || 0
                                            };
                                        }
                                    }
                                }
                            } else {
                                inv.items = [];
                            }
                        } catch (e) {
                            console.warn(`⚠️ Failed to load items for invoice ${inv.id}:`, e);
                            inv.items = [];
                        }
                    } else if (!inv.items) {
                        inv.items = [];
                    }
                }
                
                // Разделяем по типам документов
                confirmedPredracuns = allInvoices.filter(inv => inv.documentType === 'predracun');
                confirmedRacuns = allInvoices.filter(inv => inv.documentType === 'racun');
                confirmedInvoices = allInvoices; // Все инвойсы
                
                // Подсчитываем уникальные инвойсы по видимым номерам
                const uniqueInvoiceNumbers = new Set();
                allInvoices.forEach(inv => {
                    // Убираем префиксы p и o для подсчета уникальных номеров
                    const invoiceNum = inv.invoiceNumber || inv.number || '';
                    if (invoiceNum) {
                        const baseNumber = invoiceNum.replace(/^[po]/, '');
                        uniqueInvoiceNumbers.add(baseNumber);
                    }
                });
                
                console.log(`✅ Loaded ${confirmedPredracuns.length} predracuns, ${confirmedRacuns.length} racuns from API`);
                console.log(`📊 Уникальных инвойсов (по номерам): ${uniqueInvoiceNumbers.size}`);
                
                // Сохраняем количество для отображения
                window.uniqueInvoicesCount = uniqueInvoiceNumbers.size;
                
                // Сохраняем в localStorage для fallback и для истории
                localStorage.setItem('confirmedInvoices', JSON.stringify(confirmedInvoices));
                localStorage.setItem('confirmedPredracuns', JSON.stringify(confirmedPredracuns));
                localStorage.setItem('confirmedRacuns', JSON.stringify(confirmedRacuns));
                console.log('💾 Saved invoices to localStorage');
                
                return true;
            } catch (error) {
                console.error('❌ Failed to load invoices from API:', error);
                console.error('❌ Error stack:', error.stack);
                confirmedInvoices = [];
                confirmedPredracuns = [];
                confirmedRacuns = [];
                window.uniqueInvoicesCount = 0;
                return false;
            }
        }
        
        // Загрузка отпремниц из API
        async function loadDeliveries() {
            try {
                console.log('📥 Loading deliveries from API...');
                const response = await DeliveriesAPI.getAll({ limit: 1000 });
                confirmedDeliveries = response.deliveries || [];
                console.log(`✅ Loaded ${confirmedDeliveries.length} deliveries from API`);
                
                // Сохраняем в localStorage для fallback и для истории
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                console.log('💾 Saved deliveries to localStorage');
                
                return true;
            } catch (error) {
                console.warn('⚠️ Failed to load deliveries from API:', error.message);
                
                // Fallback: загружаем из localStorage
                const savedDeliveries = localStorage.getItem('confirmedDeliveries');
                confirmedDeliveries = savedDeliveries ? JSON.parse(savedDeliveries) : [];
                console.log(`📦 Loaded from localStorage: ${confirmedDeliveries.length} deliveries`);
                
                return false;
            }
        }
        
        // Загрузка запасов чая из API
        async function loadTeaStocks() {
            try {
                console.log('📥 Loading tea stocks from API...');
                const response = await TeaStocksAPI.getAll();
                // response.data = { "Crni Čaj": 5000, "Zeleni Čaj": 3000 }
                if (response.data) {
                    window.teaStocks = response.data;
                    console.log(`✅ Loaded tea stocks from API:`, response.data);
                    return true;
                }
                return false;
            } catch (error) {
                console.warn('⚠️ Failed to load tea stocks from API:', error.message);
                window.teaStocks = { 'Crni Čaj': 0, 'Zeleni Čaj': 0 };
                return false;
            }
        }

        // Полный список всех общин Сербии (независимо от города)
        const allMunicipalities = [
            // Београд - градске општине
            "Barajevo", "Voždovac", "Vračar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", 
            "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", 
            "Sopot", "Stari grad", "Surčin", "Čukarica",
            
            // Градови
            "Novi Sad", "Niš", "Kragujevac", "Subotica", "Pančevo", "Čačak", "Novi Pazar", 
            "Zrenjanin", "Leskovac", "Bor", "Valjevo", "Vranje", "Vršac", "Zaječar", 
            "Jagodina", "Kikinda", "Kraljevo", "Kruševac", "Loznica", "Pirot", "Požarevac", 
            "Priština", "Prokuplje", "Smederevo", "Sombor", "Sremska Mitrovica", "Užice", "Šabac",
            
            // Медијана, Палилула (Ниш)
            "Medijana", "Pantelej", "Crveni Krst", "Niška Banja",
            
            // Врање
            "Vranje grad", "Vranje selo",
            
            // Пожаревац
            "Požarevac grad", "Kostolac",
            
            // Ужице
            "Užice grad", "Sevojno",
            
            // Општине
            "Aleksandrovac", "Aleksinac", "Aranđelovac", "Arilje", "Babušnica", "Bač", 
            "Bačka Palanka", "Bačka Topola", "Bačko Gradište", "Bajina Bašta", "Bela Crkva", 
            "Bela Palanka", "Beočin", "Blace", "Bogatić", "Bojnik", "Boljevac", "Bosilegrad", 
            "Brus", "Bujanovac", "Čajetina", "Čoka", "Ćićevac", "Ćuprija", "Despotovac", 
            "Dimitrovgrad", "Doljevac", "Gadžin Han", "Golubac", "Gornji Milanovac", "Ivanjica", 
            "Irig", "Kanjiža", "Kladovo", "Knjaževac", "Knić", "Koceljeva", "Kosjerić", "Kovin", 
            "Krupanj", "Kučevo", "Kuršumlija", "Lajkovac", "Lapovo", "Lebane", "Ljig", "Ljubovija", 
            "Lučani", "Majdanpek", "Malo Crniće", "Medveđa", "Merošina", "Mionica", "Negotin", 
            "Nova Crnja", "Nova Varoš", "Novi Bečej", "Novi Kneževac", "Odžaci", "Opovo", 
            "Osečina", "Paraćin", "Pećinci", "Petrovac na Mlavi", "Plandište", "Požega", 
            "Preševo", "Priboj", "Prijepolje", "Rača", "Raška", "Ražanj", "Rekovac", "Ruma", 
            "Sečanj", "Senta", "Šid", "Sjenica", "Sokobanja", "Srbobran", "Sremski Karlovci", 
            "Stara Pazova", "Surdulica", "Svilajnac", "Temerin", "Titel", "Topola", "Trstenik", 
            "Tutin", "Ub", "Varvarin", "Velika Plana", "Vladičin Han", "Vladimirci", "Vlasotince", 
            "Vojnik", "Vrbas", "Vrnjačka Banja", "Žabalj", "Žabari", "Žagubica", "Žitište", "Žitorađa",
            
            // Бачки Петровац
            "Bački Petrovac", "Kulpin", "Maglić", "Gložan",
            
            // Ада
            "Ada", "Mol", "Obornjača",
            
            // Алибунар
            "Alibunar", "Banatski Karlovci", "Vladimirovac",
            
            // Апатин
            "Apatin", "Prigrevica", "Kupusina",
            
            // Инђија
            "Inđija", "Beška", "Ljukovo", "Maradik",
            
            // Мали Иђош
            "Mali Iđoš", "Lovćenac", "Feketić"
        ];

        // Основные улицы (общий список для всех общин)
        const commonStreets = [
            "Главна", "Карађорђева", "Краља Петра", "Светог Саве", "Немањина", 
            "Кнеза Милоша", "Железничка", "Партизанска", "Омладинска", "Школска",
            "Трг ослобођења", "Bulevar oslobođenja", "Дунавска", "Моравска", 
            "Првомајска", "Николе Пашића", "Светозара Марковића", "Димитрија Туцовића",
            "Јована Јовановића Змаја", "Вука Караџића", "Доситејева", "Браће Југовића",
            "Кнез Михаилова", "Теразије", "Студентски трг", "Скадарска", "Душанова",
            "Масарикова", "Милетићева", "Фрушкогорска", "Банатска", "Војвођанска",
            "Сремска", "Бачка", "Златиборска", "Копаоничка", "Рудничка", "Шумадијска",
            "Poštanska", "Maksima Gorkog", "Majke Jevrosime", "Kneza Višeslava",
            "Bulevar kralja Aleksandra", "Bulevar Nemanjića", "Bulevar despota Stefana"
        ];

        // Полный список городов и общин Сербии
        const addressData = {
            cities: {
                // ГРАДОВИ (28 + Београд)
                "Beograd": {
                    municipalities: ["Barajevo", "Voždovac", "Vračar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", "Sopot", "Stari grad", "Surčin", "Čukarica"],
                    streets: {
                        "Stari grad": ["Studentski trg", "Knez Mihailova", "Terazije", "Kralja Petra", "Vasa Čarapića", "Makedonska", "Zeleni venac", "Dušanova", "Skadarska", "Kosančićev venac", "Cara Dušana", "Kralja Milana", "Nemanjina", "Resavska", "Balkanska", "Vasina", "Francuska", "Užička", "Pop Lukina", "Dobračina", "Jevremova", "Gospodar Jevremova", "Admirala Geprata", "Gavrila Principa", "Pariska", "Strahinjića Bana", "Rajićeva", "Tadeuša Košćuška", "Čika Ljubina", "Bulevar despota Stefana", "Hilandarska", "Simina", "Braće Jugovića", "Svetogorska", "Dzordza Vašingtona", "Višegradska", "Prizrenska", "Cara Nikolaja II", "Zmaj Jovina", "Braće Baruh", "Kolarčeva", "Venizelosova", "Majke Jevrosime", "Čumićeva", "Dimitrija Tucovića", "Dunavska", "Obilicev venac", "Strahinića Bana"],
                        "Novi Beograd": ["Bulevar Zorana Đinđića", "Bulevar Mihajla Pupina", "Jurija Gagarina", "Gandijeva", "Milentija Popovića", "Antifašističke borbe", "Bulevar Arsenija Čarnojevića", "Dr Ivana Ribara", "Omladinskih brigada", "Narodnih heroja", "Tošin bunar", "Bulevar Nikole Tesle", "Vladimira Popovića", "Đorđa Stanojevića", "Nehruova", "Save Kovačevića", "Kornelija Stankovića", "Partizanske avijacije"],
                        "Voždovac": ["Bulevar oslobođenja", "Ustanička", "Veljka Dugoševića", "Autoput za Niš", "Kumodraška", "Crnotravska", "Trešnjinog cveta", "Patrijarha Dimitrija", "Južni bulevar", "Medakovićeva", "Braće Jerković", "Vojvode Stepe", "Humska", "Banjička"],
                        "Vračar": ["Bulevar kralja Aleksandra", "Krunska", "Kneginje Zorke", "Svetosavska", "Njegoševa", "Čarlija Čaplina", "Maksima Gorkog", "Karađorđeva", "Beogradska", "Neimarska", "Despota Stefana", "Katanićeva", "Kralja Milana", "Dečanska"],
                        "Zvezdara": ["Bulevar kralja Aleksandra", "Dimitrija Tucovića", "Milana Rakića", "Cvijićeva", "Veljka Vlahovića", "Dragoslava Srejovića", "Alekse Nenadovića", "Ruzveltova", "Učiteljska", "Bulevar Mihajla Pupina", "Djure Jakšića"],
                        "Zemun": ["Glavna", "Cara Dušana", "Zemunski kej", "Magistratski trg", "Karamatina", "Dubrovačka", "Gorkoga", "Tošin bunar", "Batajnički drum", "Ugrinovačka", "Bečkerečka", "Prvomajska"],
                        "Čukarica": ["Požeška", "Patrijarha Dimitrija", "Kneza Višeslava", "Ibarska magistrala", "Radnička", "Banovo brdo", "Čukarička", "Banjica", "Sremčica", "Železnička"],
                        "Palilula": ["Dunavska", "Francuska", "Visokog Stevana", "Učiteljska", "Dalmatinska", "Cara Nikolaja II", "Bulevar despota Stefana", "Ruzveltova", "Višnjićeva", "Tadeuša Košćuška"],
                        "Savski venac": ["Nemanjina", "Karađorđeva", "Bulevar vojvode Mišića", "Kneza Miloša", "Sarajevska", "Hajduk Veljkova", "Gavrila Principa", "Resavska", "Prizrenska", "Svetog Save"],
                        "Rakovica": ["Borska", "Patrijarha Dimitrija", "Rakovička", "Ibarska magistrala", "Kneza Višeslava", "Trgovačka", "Miloša Obrenović", "Crnotravska"],
                        "Grocka": ["Smederevski put", "Boljevačka", "Grocka", "Pukovnika Milenka Pavlovića", "Vinička", "Boleč", "Begaljica"],
                        "Lazarevac": ["Kralja Petra", "Svetog Save", "Trg oslobođenja", "Nemanjina", "Bulevar oslobođenja", "Ibarska magistrala", "Stevan Mokranjac"],
                        "Mladenovac": ["Kralja Aleksandra", "Svetog Save", "Nemanjina", "Trg oslobođenja", "Karađorđeva", "Kosmajska", "Jagodinska"],
                        "Obrenovac": ["Kralja Petra", "Miloša Obrenovića", "Vuka Karadžića", "Cara Lazara", "Trg oslobođenja", "Obilićeva", "Zmaj Jovina"],
                        "Sopot": ["Sopot", "Kosmajska", "Nemenikuće", "Dučina", "Parcani", "Rogača"],
                        "Surčin": ["Surčin", "Bečkerečka", "Dobanovci", "Petrovčić", "Boljevci", "Jakovo"],
                        "Barajevo": ["Barajevo", "Arnajevo", "Boždarevac", "Guncati", "Manić", "Šiljakovac"]
                    }
                },
                "Novi Sad": {
                    municipalities: ["Novi Sad"],
                    streets: {
                        "Novi Sad": ["Bulevar oslobođenja", "Zmaj Jovina", "Dunavska", "Kralja Aleksandra", "Miletićeva", "Futoška", "Bulevar cara Lazara", "Narodnog fronta", "Straže Novosadske", "Jevrejska", "Katolička porta", "Grčka", "Masarikova", "Jovana Đorđevića", "Modene", "Ilije Ognjanovića", "Svetozara Miletića", "Vladimira Nazora", "Kisačka", "Bulevar Evrope"]
                    }
                },
                "Niš": {
                    municipalities: ["Medijana", "Palilula", "Pantelej", "Crveni Krst", "Niška Banja"],
                    streets: {
                        "Medijana": ["Bulevar Nemanjića", "Obrenovićeva", "Vozda Karađorđa", "Dr Zoran Đinđić", "Bulevar 12. februar", "Dušanova", "Kneginje Ljubice"],
                        "Palilula": ["Cara Dušana", "Bulevar Evrope", "Jaše Prodanovića", "Stevana Mokranjca", "Vojvode Tankosića", "Hadži Milentijeva"],
                        "Pantelej": ["Bulevar Nemanjića", "Partizanska", "Ćirila i Metodija", "Stevana Sremca", "Kneginje Milice"],
                        "Crveni Krst": ["Bulevar Evrope", "Partizanska", "Vojvode Tankosića", "Stevana Mokranjca"],
                        "Niška Banja": ["Sinđelićeva", "Dr Milutina Ivkovića", "Železnička", "Knjeginje Milice"]
                    }
                },
                "Kragujevac": {
                    municipalities: ["Kragujevac"],
                    streets: {
                        "Kragujevac": ["Kralja Aleksandra", "Svetozara Markovića", "Dositejeva", "Bulevar kraljice Marije", "Jovana Cvijića", "Kneza Mihaila", "Nikole Pašića", "Cara Lazara", "Đure Đakovića", "Kralja Petra"]
                    }
                },
                "Subotica": {
                    municipalities: ["Subotica"],
                    streets: {
                        "Subotica": ["Trg slobode", "Korzo", "Matice srpske", "Segedinski put", "Cara Lazara", "Maksima Gorkog", "Đure Đakovića", "Raše Končara", "Somborska", "Banatska"]
                    }
                },
                "Pančevo": {
                    municipalities: ["Pančevo"],
                    streets: {
                        "Pančevo": ["Trg kralja Petra", "Železnička", "Svetog Save", "Cara Lazara", "Dimitrija Tucovića", "Vojvodine", "Miloša Trebinjca", "Braće Jovanović", "Đure Đakovića"]
                    }
                },
                "Čačak": {
                    municipalities: ["Čačak"],
                    streets: {
                        "Čačak": ["Bulevar oslobodilaca", "Kneza Mihaila", "Žička", "Cara Dušana", "Svetog Save", "Nikole Pašića", "Prvomajska", "Dimitrija Tucovića"]
                    }
                },
                "Novi Pazar": {
                    municipalities: ["Novi Pazar"],
                    streets: {
                        "Novi Pazar": ["28. novembar", "Stevana Nemanje", "Rifata Burdžovića", "Alije Izetbegovića", "Generala Živkovića", "Vuka Karadžića", "Sutjeska"]
                    }
                },
                "Zrenjanin": {
                    municipalities: ["Zrenjanin"],
                    streets: {
                        "Zrenjanin": ["Trg slobode", "Kralja Aleksandra", "Đure Đakovića", "Bulevar Đorđa Vajferta", "Sečanj", "Dimitrija Tucovića", "Maksima Gorkog"]
                    }
                },
                "Leskovac": {
                    municipalities: ["Leskovac"],
                    streets: {
                        "Leskovac": ["Bulevar oslobođenja", "Stevana Mokranjca", "Cara Dušana", "Nikole Pašića", "Bulevar heroes", "Žitni trg", "Svetozara Markovića"]
                    }
                },
                "Bor": {
                    municipalities: ["Bor"],
                    streets: {
                        "Bor": ["Moše Pijade", "7. jula", "Đorđa Vajferta", "Trg oslobođenja", "Kralja Petra"]
                    }
                },
                "Valjevo": {
                    municipalities: ["Valjevo"],
                    streets: {
                        "Valjevo": ["Karađorđeva", "Vladike Nikolaja", "Birčaninova", "Vojvode Mišića", "Kneza Miloša"]
                    }
                },
                "Vranje": {
                    municipalities: ["Vranje grad", "Vranje selo"],
                    streets: {
                        "Vranje grad": ["Kralja Stefana Prvovenčanog", "Svetozara Markovića", "Prvomajska", "Kralja Aleksandra", "Titova"],
                        "Vranje selo": ["Seoska ulica", "Glavna", "Centralna"]
                    }
                },
                "Vršac": {
                    municipalities: ["Vršac"],
                    streets: {
                        "Vršac": ["Svetosavska", "Trg pobede", "Heroja Pinkija", "Abrahama Linkolna", "Vojvođanska"]
                    }
                },
                "Zaječar": {
                    municipalities: ["Zaječar"],
                    streets: {
                        "Zaječar": ["Kralja Aleksandra", "Svetozara Markovića", "Hajduk Veljkova", "Nikole Pašića", "Kneginje Ljubice"]
                    }
                },
                "Jagodina": {
                    municipalities: ["Jagodina"],
                    streets: {
                        "Jagodina": ["Kneginje Milice", "Svetozara Markovića", "Karadjordjeva", "Kralja Petra", "Nikole Pašića"]
                    }
                },
                "Kikinda": {
                    municipalities: ["Kikinda"],
                    streets: {
                        "Kikinda": ["Trg srpskih dobrovoljaca", "Svetosavska", "Gospodara Vučića", "Sečeranska", "Žarka Zrenjanina"]
                    }
                },
                "Kraljevo": {
                    municipalities: ["Kraljevo"],
                    streets: {
                        "Kraljevo": ["Kraljice Marije", "Karađorđeva", "Omladinska", "Trg srpskih ratnika", "Nemanjina"]
                    }
                },
                "Kruševac": {
                    municipalities: ["Kruševac"],
                    streets: {
                        "Kruševac": ["Kneza Miloša", "Gazimestanska", "Vidovdanska", "Ćele kule", "Majke Jugovića"]
                    }
                },
                "Loznica": {
                    municipalities: ["Loznica"],
                    streets: {
                        "Loznica": ["Kneza Miloša", "Karađorđeva", "Vuka Karadžića", "Pasićeva", "Jovan Cvijić"]
                    }
                },
                "Pirot": {
                    municipalities: ["Pirot"],
                    streets: {
                        "Pirot": ["Srpskih vladara", "Kralja Petra", "Nikole Pašića", "Trg pobede", "Beogradska"]
                    }
                },
                "Požarevac": {
                    municipalities: ["Požarevac grad", "Kostolac"],
                    streets: {
                        "Požarevac grad": ["Dunavska", "Karađorđeva", "Svetozara Markovića", "Kneza Miloša", "Drinčićeva"],
                        "Kostolac": ["Glavna", "Termoelektrane", "Rudarska", "Drinčićeva"]
                    }
                },
                "Priština": {
                    municipalities: ["Priština"],
                    streets: {
                        "Priština": ["Kralja Petra", "Lole Ribara", "Omladinska", "Dečanska", "Vidovdanska"]
                    }
                },
                "Prokuplje": {
                    municipalities: ["Prokuplje"],
                    streets: {
                        "Prokuplje": ["Topličina", "Karađorđeva", "Vojvode Stepe", "Svetog Save", "Nikole Pašića"]
                    }
                },
                "Smederevo": {
                    municipalities: ["Smederevo"],
                    streets: {
                        "Smederevo": ["Kralja Petra", "Dunavska", "Omladinska", "Đuriška", "Svetog Đorđa"]
                    }
                },
                "Sombor": {
                    municipalities: ["Sombor"],
                    streets: {
                        "Sombor": ["Trg cara Uroša", "Апатински пут", "Венац војводе Степе", "Војводе Путника", "Кнеза Михаила"]
                    }
                },
                "Sremska Mitrovica": {
                    municipalities: ["Sremska Mitrovica"],
                    streets: {
                        "Sremska Mitrovica": ["Светог Димитрија", "Краља Петра", "Железничка", "Фрушкогорска", "Војвођанска"]
                    }
                },
                "Užice": {
                    municipalities: ["Užice grad", "Sevojno"],
                    streets: {
                        "Užice grad": ["Партизанска", "Димитрија Туцовића", "Милоша Обилића", "Трг партизана", "Немањина"],
                        "Sevojno": ["Златиборска", "Милана Ракића", "Светог Саве", "Железничка"]
                    }
                },
                "Šabac": {
                    municipalities: ["Šabac"],
                    streets: {
                        "Šabac": ["Карађорђева", "Масарикова", "Хајдук Вељкова", "Трг ослобођења", "Војводе Мишића"]
                    }
                },
                // ВЕЋИ ОПШТИНСКИ ЦЕНТРИ
                "Aleksandrovac": {
                    municipalities: ["Aleksandrovac"],
                    streets: {
                        "Aleksandrovac": ["Карађорђева", "Главна", "Жупска", "Немањина", "Топличка"]
                    }
                },
                "Aleksinac": {
                    municipalities: ["Aleksinac"],
                    streets: {
                        "Aleksinac": ["Карађорђева", "Моравска", "Краљевска", "Немањина", "Светог Саве"]
                    }
                },
                "Aranđelovac": {
                    municipalities: ["Aranđelovac"],
                    streets: {
                        "Aranđelovac": ["Карађорђева", "Краља Петра", "Бањска", "Кнеза Милоша", "Омладинска"]
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // loadInitialData() теперь вызывается ПОСЛЕ успешной авторизации
            setCurrentDate();
            generateDocumentNumbers();
            // initializeStatistics() вызывается после загрузки данных
            updateSelectOptions();
            initializeAddressSearch();
            
            // Инициализация кнопки утверждения (по умолчанию для предрачуна)
            updateConfirmButtonText('predracun');
            
            // Инициализация складских данных
            renderProductGroups();
            
            // Инициализация отображения запасов чая
            updateTeaStockDisplay();
            
            // Инициализация чекбокса адреса доставки для инвойса
            document.getElementById('differentDeliveryAddress').addEventListener('change', function() {
                const section = document.getElementById('deliveryAddressSection');
                if (this.checked) {
                    section.style.display = 'block';
                    initializeDeliveryAddressSearch();
                } else {
                    section.style.display = 'none';
                }
            });
            
            // Инициализация чекбокса адреса доставки для отпремницы
            const otpremnicaAddressCheckbox = document.getElementById('otpremnicaDifferentAddress');
            if (otpremnicaAddressCheckbox) {
                otpremnicaAddressCheckbox.addEventListener('change', function() {
                    const section = document.getElementById('otpremnicaDeliveryAddressSection');
                    if (this.checked) {
                        section.style.display = 'block';
                        initializeOtpremnicaDeliveryAddressSearch();
                    } else {
                        section.style.display = 'none';
                    }
                });
            }
            
            // Обработчик изменения клиента в инвойсе для фильтрации товаров
            const invoiceClientSelect = document.getElementById('invoiceClient');
            if (invoiceClientSelect) {
                invoiceClientSelect.addEventListener('change', function() {
                    // Очищаем все поля поиска товаров при смене клиента
                    document.querySelectorAll('.invoice-product-search').forEach(input => {
                        input.value = '';
                        const hidden = input.closest('.searchable-select').querySelector('.invoice-product');
                        if (hidden) hidden.value = '';
                        const dropdown = input.closest('.searchable-select').querySelector('.invoice-product-dropdown');
                        if (dropdown) dropdown.style.display = 'none';
                    });
                });
            }
            
            // Обработчик изменения клиента в отпремнице для фильтрации товаров
            const deliveryClientSelect = document.getElementById('deliveryClient');
            if (deliveryClientSelect) {
                deliveryClientSelect.addEventListener('change', function() {
                    // Очищаем все поля поиска товаров при смене клиента
                    document.querySelectorAll('.delivery-product-search').forEach(input => {
                        input.value = '';
                        const hidden = input.closest('.searchable-select').querySelector('.delivery-product');
                        if (hidden) hidden.value = '';
                        const dropdown = input.closest('.searchable-select').querySelector('.delivery-product-dropdown');
                        if (dropdown) dropdown.style.display = 'none';
                    });
                });
            }
            
            // Инициализация чекбокса ручного ввода адреса
            document.getElementById('manualAddressInput').addEventListener('change', function() {
                const automaticSection = document.getElementById('automaticAddressSection');
                const manualSection = document.getElementById('manualAddressSection');
                
                if (this.checked) {
                    // Переключаемся на ручной ввод
                    automaticSection.style.display = 'none';
                    manualSection.style.display = 'block';
                    
                    // Очищаем поля автоматического ввода
                    document.getElementById('clientCity').value = '';
                    document.getElementById('clientMunicipality').value = '';
                    document.getElementById('clientStreet').value = '';
                    document.getElementById('clientHouseNumber').value = '';
                } else {
                    // Переключаемся на автоматический ввод
                    automaticSection.style.display = 'block';
                    manualSection.style.display = 'none';
                    
                    // Очищаем поле ручного ввода
                    document.getElementById('clientManualAddress').value = '';
                    
                    // Сбрасываем состояние автоматических полей
                    const municipalityInput = document.getElementById('clientMunicipality');
                    const streetInput = document.getElementById('clientStreet');
                    if (municipalityInput) {
                        municipalityInput.disabled = true;
                        municipalityInput.placeholder = 'Выберите сначала город...';
                    }
                    if (streetInput) {
                        streetInput.disabled = true;
                        streetInput.placeholder = 'Выберите сначала общину...';
                    }
                }
            });

            // Закрыть модальное окно при клике вне его
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('invoiceViewModal');
                if (modal && e.target === modal) {
                    closeInvoiceViewModal();
                }
            });

            // Закрыть модальное окно при нажатии Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('invoiceViewModal');
                    if (modal) {
                        closeInvoiceViewModal();
                    }
                }
            });
        });

        function initializeAddressSearch() {
            setupCitySearch('clientCity', 'clientCityDropdown', 'clientMunicipality', 'clientMunicipalityDropdown', 'clientStreet', 'clientStreetDropdown');
        }

        function initializeDeliveryAddressSearch() {
            setupCitySearch('deliveryCity', 'deliveryCityDropdown', 'deliveryMunicipality', 'deliveryMunicipalityDropdown', 'deliveryStreet', 'deliveryStreetDropdown');
        }
        
        function initializeOtpremnicaDeliveryAddressSearch() {
            setupCitySearch('otpremnicaDeliveryCity', 'otpremnicaDeliveryCityDropdown', 'otpremnicaDeliveryMunicipality', 'otpremnicaDeliveryMunicipalityDropdown', 'otpremnicaDeliveryStreet', 'otpremnicaDeliveryStreetDropdown');
        }

        function setupCitySearch(cityInputId, cityDropdownId, municipalityInputId, municipalityDropdownId, streetInputId, streetDropdownId) {
            const cityInput = document.getElementById(cityInputId);
            const cityDropdown = document.getElementById(cityDropdownId);
            const municipalityInput = document.getElementById(municipalityInputId);
            const municipalityDropdown = document.getElementById(municipalityDropdownId);
            const streetInput = document.getElementById(streetInputId);
            const streetDropdown = document.getElementById(streetDropdownId);

            if (!cityInput || !cityDropdown) return;

            // Поиск городов - БЕЗОПАСНЫЕ ОБРАБОТЧИКИ
            const cityInputHandler = function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    cityDropdown.style.display = 'none';
                    enableMunicipalityInput();
                    return;
                }

                const filteredCities = Object.keys(addressData.cities).filter(city => 
                    city.toLowerCase().includes(query)
                );

                if (filteredCities.length === 0) {
                    cityDropdown.style.display = 'none';
                    return;
                }

                // Очищаем предыдущие обработчики для элементов dropdown
                Array.from(cityDropdown.children).forEach(child => {
                    EventManager.removeAllForElement(child);
                });

                cityDropdown.innerHTML = '';
                filteredCities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = city;
                    
                    const clickHandler = function() {
                        cityInput.value = city;
                        cityDropdown.style.display = 'none';
                        enableMunicipalityInput();
                    };
                    
                    EventManager.add(item, 'click', clickHandler);
                    cityDropdown.appendChild(item);
                });

                cityDropdown.style.display = 'block';
            };
            
            const cityBlurHandler = function() {
                setTimeout(() => {
                    cityDropdown.style.display = 'none';
                }, 200);
            };

            EventManager.add(cityInput, 'input', cityInputHandler);
            EventManager.add(cityInput, 'blur', cityBlurHandler);

            // Активируем поле общин после выбора города
            function enableMunicipalityInput() {
                if (!municipalityInput || !municipalityDropdown) return;
                
                municipalityInput.disabled = false;
                municipalityInput.placeholder = 'Введите название общины...';
                municipalityInput.value = '';
                
                setupMunicipalitySearch();
            }

            function setupMunicipalitySearch() {
                if (!municipalityInput || !municipalityDropdown) return;

                // Удаляем старые обработчики
                const newMunicipalityInput = municipalityInput.cloneNode(true);
                municipalityInput.parentNode.replaceChild(newMunicipalityInput, municipalityInput);
                const updatedMunicipalityInput = document.getElementById(municipalityInputId);
                const updatedMunicipalityDropdown = document.getElementById(municipalityDropdownId);

                updatedMunicipalityInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        resetStreet();
                        return;
                    }

                    const filteredMunicipalities = allMunicipalities.filter(municipality => 
                        municipality.toLowerCase().includes(query)
                    );

                    if (filteredMunicipalities.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        return;
                    }

                    updatedMunicipalityDropdown.innerHTML = '';
                    filteredMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });

                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('focus', function() {
                    // Показываем все общины при фокусе
                    updatedMunicipalityDropdown.innerHTML = '';
                    allMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });
                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedMunicipalityDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function enableStreetInput() {
                if (!streetInput || !streetDropdown) return;
                
                streetInput.disabled = false;
                streetInput.placeholder = 'Введите название улицы...';
                streetInput.value = '';
                
                setupStreetSearch();
            }

            function setupStreetSearch() {
                if (!streetInput || !streetDropdown) return;

                // Удаляем старые обработчики
                const newStreetInput = streetInput.cloneNode(true);
                streetInput.parentNode.replaceChild(newStreetInput, streetInput);
                const updatedStreetInput = document.getElementById(streetInputId);
                const updatedStreetDropdown = document.getElementById(streetDropdownId);

                updatedStreetInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    const filteredStreets = commonStreets.filter(street => 
                        street.toLowerCase().includes(query)
                    );

                    if (filteredStreets.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    updatedStreetDropdown.innerHTML = '';
                    filteredStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });

                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('focus', function() {
                    // Показываем все улицы при фокусе
                    updatedStreetDropdown.innerHTML = '';
                    commonStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });
                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedStreetDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function resetStreet() {
                if (streetInput) {
                    streetInput.value = '';
                    streetInput.disabled = true;
                    streetInput.placeholder = 'Выберите сначала общину...';
                }
            }
        }

        // Безопасная функция для работы с localStorage
        function safeLocalStorage(operation, key, data = null) {
            try {
                switch (operation) {
                    case 'get':
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : null;
                    case 'set':
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    case 'remove':
                        localStorage.removeItem(key);
                        return true;
                    default:
                        console.error('Неизвестная операция localStorage:', operation);
                        return null;
                }
            } catch (error) {
                console.error(`Ошибка localStorage (${operation}, ${key}):`, error);
                
                // Если localStorage переполнен, пытаемся очистить старые данные
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorage переполнен, очищаем старые данные...');
                    try {
                        // Удаляем логи (они могут быть большими)
                        localStorage.removeItem('logs');
                        localStorage.removeItem('actionLogs');
                        // Пытаемся снова
                        if (operation === 'set') {
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        }
                    } catch (retryError) {
                        console.error('Не удалось сохранить даже после очистки:', retryError);
                        showAlert('Ошибка сохранения данных. Очистите кеш браузера.', 'danger');
                    }
                }
                return null;
            }
        }

        // НОВАЯ ASYNC ФУНКЦИЯ ЗАГРУЗКИ ДАННЫХ ИЗ API
        async function loadInitialData() {
            console.log('=== 🚀 ЗАГРУЗКА ДАННЫХ (API + FALLBACK) ===');
            showStatus('=== 🚀 ЗАГРУЗКА ДАННЫХ ===', '#ffa500');
            
            showLoadingIndicator(true, 'Загрузка данных из локальной базы...');
            
            try {
                // Инициализируем пустые массивы
                confirmedInvoices = [];
                confirmedPredracuns = [];
                confirmedRacuns = [];
                confirmedDeliveries = [];
                
                showStatus('📥 Загружаем клиентов...', '#3b82f6');
                showStatus('📥 Загружаем товары...', '#3b82f6');
                showStatus('📥 Загружаем инвойсы...', '#3b82f6');
                showStatus('📥 Загружаем отпремницы...', '#3b82f6');
                showStatus('📥 Загружаем запасы...', '#3b82f6');
                
                // НОВЫЙ КОД: Параллельная загрузка всех данных из API
                const [clientsLoaded, productsLoaded, invoicesLoaded, deliveriesLoaded, teaStocksLoaded] = await Promise.all([
                    loadClients().catch(e => { 
                        console.error('❌ loadClients failed:', e); 
                        showStatus('❌ Клиенты: ошибка - ' + e.message, '#ff0000');
                        return false; 
                    }),
                    loadProducts().catch(e => { 
                        console.error('❌ loadProducts failed:', e); 
                        showStatus('❌ Товары: ошибка - ' + e.message, '#ff0000');
                        return false; 
                    }),
                    loadInvoices().catch(e => { 
                        console.error('❌ loadInvoices failed:', e); 
                        showStatus('❌ Инвойсы: ошибка - ' + e.message, '#ff0000');
                        return false; 
                    }),
                    loadDeliveries().catch(e => { 
                        console.error('❌ loadDeliveries failed:', e); 
                        showStatus('❌ Отпремницы: ошибка - ' + e.message, '#ff0000');
                        return false; 
                    }),
                    loadTeaStocks().catch(e => { 
                        console.error('❌ loadTeaStocks failed:', e); 
                        showStatus('❌ Запасы: ошибка - ' + e.message, '#ff0000');
                        return false; 
                    })
                ]);
                
                // Обновляем глобальные переменные
                window.confirmedInvoices = confirmedInvoices;
                window.confirmedPredracuns = confirmedPredracuns;
                window.confirmedRacuns = confirmedRacuns;
                window.confirmedDeliveries = confirmedDeliveries;
                
                // Отображаем данные
                renderClientsTable();
                renderProductsTable();
                updateDeliveryClientFilter();
                updateDeliveriesList();
                updateTeaStockDisplay();
                
                // Инициализация отчета по клиентам
                setTimeout(() => updateClientReport(), 100);
                
                // Инициализация статистики
                initializeStatistics();
                
                // Инициализация категорий
                await initCategories();
                
                // Загружаем фильтр субкатегорий
                loadProductSubcategoryFilter();
                
                // Показываем результат загрузки
                const loadedFromAPI = [clientsLoaded, productsLoaded, invoicesLoaded, deliveriesLoaded, teaStocksLoaded].filter(Boolean).length;
                const totalSources = 5;
                
                showStatus(`✅ Клиенты: ${clientsLoaded ? 'OK' : 'FAIL'} (${clients.length})`, clientsLoaded ? '#00ff00' : '#ff0000');
                showStatus(`✅ Товары: ${productsLoaded ? 'OK' : 'FAIL'} (${products.length})`, productsLoaded ? '#00ff00' : '#ff0000');
                showStatus(`✅ Инвойсы: ${invoicesLoaded ? 'OK' : 'FAIL'} (${confirmedInvoices.length})`, invoicesLoaded ? '#00ff00' : '#ff0000');
                showStatus(`✅ Отпремницы: ${deliveriesLoaded ? 'OK' : 'FAIL'} (${confirmedDeliveries.length})`, deliveriesLoaded ? '#00ff00' : '#ff0000');
                showStatus(`✅ Запасы: ${teaStocksLoaded ? 'OK' : 'FAIL'}`, teaStocksLoaded ? '#00ff00' : '#ff0000');
                showStatus(`📊 ИТОГО: ${loadedFromAPI}/${totalSources} источников`, loadedFromAPI === totalSources ? '#00ff00' : '#ffa500');
                
                if (loadedFromAPI === totalSources) {
                    console.log('✅ Все данные загружены из API');
                    const invoiceMsg = window.uniqueInvoicesCount > 0 ? `, ${window.uniqueInvoicesCount} инвойсов` : '';
                    showAlert(`Данные успешно загружены (${clients.length} клиентов, ${products.length} товаров${invoiceMsg})`, 'success');
                } else if (loadedFromAPI > 0) {
                    console.log(`⚠️ Частичная загрузка: ${loadedFromAPI}/${totalSources} источников из API`);
                    showAlert(`Частичная загрузка данных (${loadedFromAPI}/${totalSources} источников)`, 'warning');
                } else {
                    console.log('📦 Все данные загружены из локального хранилища (fallback)');
                    // TAURI: Всегда локальный режим, сообщение не нужно
                }
                
            } catch (error) {
                console.error('❌ Ошибка загрузки данных:', error);
                console.error('❌ Error stack:', error.stack);
                showAlert(`Ошибка загрузки данных из локальной базы: ${error.message}`, 'danger');
            } finally {
                showLoadingIndicator(false);
            }
        }

        // СТАРАЯ ФУНКЦИЯ (сохранена для reference, удалить после тестирования)
        function loadInitialData_OLD() {
            clients = [
                { name: "SVDA DOO", mb: "22058282", pib: "114703885", address: "Beograd, Stari grad, Majke Jevrosime 19", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Majke Jevrosime", houseNumber: "19" },
                { name: "AUDITORIA DOO BEOGRAD", mb: "22043277", pib: "114586673", address: "Beograd, Voždovac, Vojvode Dobrnca 48", contact: "", bank: "190-0000000097100 (Алта банка А.Д.)", city: "Beograd", municipality: "Voždovac", street: "Vojvode Dobrnca", houseNumber: "48" },
                { name: "Aleksandra Tarasenko PR", mb: "67249208", pib: "114000935", address: "Novi Sad, Novi Sad, Masarikova 18", contact: "Ugostiteljska radnja Seal & Tea", bank: "", city: "Novi Sad", municipality: "Novi Sad", street: "Masarikova", houseNumber: "18" },
                { name: "Vera Organic Coffee and Tea doo", mb: "21886866", pib: "113543561", address: "Beograd, Stari grad, Nikole Spasića 4", contact: "avmofficebg@gmail.com, 063/773-6698", bank: "", city: "Beograd", municipality: "Stari grad", street: "Nikole Spasića", houseNumber: "4" },
                { name: "ČETIRI COFFEE DOO", mb: "22057146", pib: "114695557", address: "Beograd, Stari grad, Terazije 36", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Terazije", houseNumber: "36" }
            ];

            // Загружаем сохраненные данные из localStorage (если есть)
            console.log('Загружаем сохраненные данные...');
            
            // Загружаем инвойсы
            const savedInvoices = localStorage.getItem('confirmedInvoices');
            if (savedInvoices) {
                try {
                    confirmedInvoices = JSON.parse(savedInvoices);
                    console.log('Загружено инвойсов:', confirmedInvoices.length);
                } catch (e) {
                    console.error('Ошибка загрузки инвойсов:', e);
                    confirmedInvoices = [];
                }
            }
            window.confirmedInvoices = confirmedInvoices;

            // Загружаем предрачуны
            const savedPredracuns = localStorage.getItem('confirmedPredracuns');
            if (savedPredracuns) {
                try {
                    confirmedPredracuns = JSON.parse(savedPredracuns);
                    console.log('Загружено предрачунов:', confirmedPredracuns.length);
                } catch (e) {
                    console.error('Ошибка загрузки предрачунов:', e);
                    confirmedPredracuns = [];
                }
            }
            window.confirmedPredracuns = confirmedPredracuns;

            // Загружаем рачуны
            const savedRacuns = localStorage.getItem('confirmedRacuns');
            if (savedRacuns) {
                try {
                    confirmedRacuns = JSON.parse(savedRacuns);
                    console.log('Загружено рачунов:', confirmedRacuns.length);
                } catch (e) {
                    console.error('Ошибка загрузки рачунов:', e);
                    confirmedRacuns = [];
                }
            }
            window.confirmedRacuns = confirmedRacuns;

            // Загружаем отпремницы
            const savedDeliveries = localStorage.getItem('confirmedDeliveries');
            if (savedDeliveries) {
                try {
                    confirmedDeliveries = JSON.parse(savedDeliveries);
                    console.log('Загружено отпремниц:', confirmedDeliveries.length);
                } catch (e) {
                    console.error('Ошибка загрузки отпремниц:', e);
                    confirmedDeliveries = [];
                }
            }
            window.confirmedDeliveries = confirmedDeliveries;

            // Загружаем клиентов из localStorage (если есть сохраненные)
            const savedClients = localStorage.getItem('clients');
            if (savedClients) {
                try {
                    const parsedClients = JSON.parse(savedClients);
                    if (parsedClients && parsedClients.length > 0) {
                        clients = parsedClients;
                        console.log('Загружено клиентов из localStorage:', clients.length);
                    }
                } catch (e) {
                    console.error('Ошибка загрузки клиентов:', e);
                }
            }

            products = [
                { code: "GF-B-TG210", name: "Tieguanyin/Zeleni Čaj 210g", price: 2297, category: "Zeleni Čaj" },
                { code: "GF-B-EG210", name: "Earl Grey/Crni Čaj 210g", price: 1850, category: "Crni Čaj" },
                { code: "GF-G-JG210", name: "Jasmine Green Beverage/Zeleni Čaj 210g", price: 1837, category: "Zeleni Čaj" },
                { code: "GF-G-SN210", name: "Sencha/Zeleni Čaj 210g", price: 1575, category: "Zeleni Čaj" },
                { code: "GF-B-MO210", name: "Milky Oolong/Zeleni Čaj 210g", price: 2167, category: "Zeleni Čaj" },
                { code: "FJN-B-DHP210", name: "Da Hong Pao/Crni Čaj 210g", price: 2691, category: "Crni Čaj" },
                { code: "FJN-B-GAB210", name: "Gaba Oolong АА/Crni Čaj 210g", price: 4854, category: "Crni Čaj" },
                { code: "FJN-B-DHP28", name: "Da Hong Pao/Crni Čaj 28g", price: 359, category: "Crni Čaj" },
                { code: "GF-W-BMD28", name: "Bai mu dan/Zeleni Čaj 28g", price: 332, category: "Zeleni Čaj" },
                { code: "FJN-B-TG28", name: "Tieguanyin/Zeleni Čaj 28g", price: 307, category: "Zeleni Čaj" },
                { code: "CHC-B-LS28", name: "Lapsang Souchong Black Tea/Crni Čaj 28g", price: 315, category: "Crni Čaj" },
                { code: "CHC-G-MPC25-5", name: "Golden tocha round Pu Erh/Crni Čaj 5g", price: 62, category: "Crni Čaj" },
                { code: "CHC-PU-RS10", name: "Puer Chagao Resin Round/Crni Čaj 1g", price: 32, category: "Crni Čaj" },
                { code: "FJN-B-GAB28", name: "Gaba Oolong АА/Crni Čaj 28g", price: 648, category: "Crni Čaj" },
                { code: "FJN-B-MO28", name: "Milky Oolong/Zeleni Čaj 28g", price: 289, category: "Zeleni Čaj" },
                { code: "GF-B-EG28", name: "Earl Grey/Crni Čaj 28g", price: 307, category: "Crni Čaj" },
                { code: "GF-G-SN28", name: "Sencha/Zeleni Čaj 28g", price: 210, category: "Zeleni Čaj" },
                { code: "GF-G-JG28", name: "Jasmine Green Beverage/Zeleni Čaj 28g", price: 245, category: "Zeleni Čaj" },
                { code: "CHC-B-LS210", name: "Lapsang Souchong Black Tea/Crni Čaj 210g", price: 2100, category: "Crni Čaj" },
                { code: "GF-B-KM210", name: "Keemum/Crni Čaj 210g", price: 1950, category: "Crni Čaj" }
            ];
            renderClientsTable();
            renderProductsTable();
            updateDeliveryClientFilter();
            updateDeliveriesList();
            
            // Инициализация отчета по клиентам
            setTimeout(() => updateClientReport(), 100);
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            document.getElementById('invoiceDate').value = today;
            document.getElementById('invoiceDueDate').value = nextWeekStr;
            document.getElementById('deliveryDate').value = today;
            document.getElementById('deliveryDueDate').value = nextWeekStr;
        }

        function generateUniqueDocumentNumber(existingNumbers, prefix = '') {
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            
            let counter = 1;
            let number = `${counter}-${dateStr}`;
            if (prefix) {
                number = `${prefix}-${counter}-${dateStr}`;
            }
            
            while (existingNumbers.includes(number)) {
                counter++;
                number = prefix ? `${prefix}-${counter}-${dateStr}` : `${counter}-${dateStr}`;
            }
            
            return number;
        }

        function generateDocumentNumbers() {
            // Генерируем уникальные номера для инвойсов
            const existingInvoiceNumbers = confirmedInvoices.map(inv => inv.number);
            const invoiceNumber = generateUniqueDocumentNumber(existingInvoiceNumbers);
            document.getElementById('invoiceNumber').value = invoiceNumber;
            
            // Генерируем уникальные номера для отпремниц
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
        }

        function updateSelectOptions() {
            // Инициализируем поисковые поля для клиентов
            initializeClientSearch('invoiceClientSearch', 'invoiceClient', 'invoiceClientDropdown');
            initializeClientSearch('deliveryClientSearch', 'deliveryClient', 'deliveryClientDropdown');
            initializeClientSearch('productClientSearch', 'productClient', 'productClientDropdown');
            
            // Инициализируем поисковые поля для товаров
            initializeProductSearch();
        }

        function initializeClientSearch(inputId, hiddenId, dropdownId) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const filteredClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) ||
                    client.mb.includes(query) ||
                    client.pib.includes(query)
                );

                if (filteredClients.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredClients.forEach((client, index) => {
                    const originalIndex = clients.findIndex(c => c.name === client.name && c.mb === client.mb);
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    const abbrDisplay = client.abbreviation ? ` (${client.abbreviation})` : '';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${client.name}${abbrDisplay}</div>
                        <div style="font-size: 12px; color: #666;">МБ: ${client.mb} | ПИБ: ${client.pib}</div>
                        <div style="font-size: 12px; color: #888;">${client.address}</div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = client.name;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                        
                        // Автозаполнение поля "позив на брой" аббревиатурой + датой
                        if (inputId === 'invoiceClientSearch' && client.abbreviation) {
                            const referenceInput = document.getElementById('invoiceReference');
                            if (referenceInput) {
                                const today = new Date();
                                const day = String(today.getDate()).padStart(2, '0');
                                const month = String(today.getMonth() + 1).padStart(2, '0');
                                const year = today.getFullYear();
                                const dateStr = `${day}${month}${year}`;
                                referenceInput.value = `${client.abbreviation}${dateStr}`;
                            }
                        }
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function initializeProductSearch() {
            // Инициализация для существующих полей товаров
            document.querySelectorAll('.invoice-product-search').forEach(input => {
                setupProductSearch(input);
            });
            
            document.querySelectorAll('.delivery-product-search').forEach(input => {
                setupProductSearch(input);
            });
        }

        function setupProductSearch(input) {
            const container = input.closest('.searchable-select');
            const hidden = container.querySelector('.invoice-product, .delivery-product');
            const dropdown = container.querySelector('.invoice-product-dropdown, .delivery-product-dropdown');
            
            if (!hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Получаем выбранного клиента для фильтрации (инвойс или отпремница)
                const invoiceClientIndex = document.getElementById('invoiceClient')?.value || '';
                const deliveryClientIndex = document.getElementById('deliveryClient')?.value || '';
                const selectedClientIndex = invoiceClientIndex || deliveryClientIndex;
                const selectedClient = selectedClientIndex !== '' ? clients[parseInt(selectedClientIndex)] : null;

                let filteredProducts = products.filter(product => 
                    (product.internalCode && product.internalCode.toLowerCase().includes(query)) ||
                    (product.code && product.code.toLowerCase().includes(query)) ||
                    (product.name && product.name.toLowerCase().includes(query)) ||
                    (product.category && product.category.toLowerCase().includes(query))
                );

                // Если выбран клиент, показываем только его товары
                if (selectedClient) {
                    filteredProducts = filteredProducts.filter(product => {
                        const productUser = getProductUser(product.internalCode);
                        // Для клиентских пользователей скрываем общие товары
                        const isClientUser = window.currentUser && window.currentUser.userType === 'client';
                        if (isClientUser) {
                            return productUser === selectedClient.name;
                        } else {
                            return productUser === selectedClient.name || productUser === 'Общий';
                        }
                    });
                }

                if (filteredProducts.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredProducts.forEach(product => {
                    const originalIndex = products.findIndex(p => p.internalCode === product.internalCode);
                    const productUser = getProductUser(product.internalCode);
                    const weight = product.weight ? `${product.weight}г` : 'N/A';
                    
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${product.code} - ${product.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            Цена: ${formatPriceWithCurrency(product.price)} | Вес: ${weight} | Пользователь: <span style="color: #007bff; font-weight: bold;">${productUser}</span>
                        </div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = `${product.code} - ${product.name}`;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                        
                        // Обновить цену для инвойсов
                        if (hidden.classList.contains('invoice-product')) {
                            updateInvoiceItemPriceFromSearch(hidden);
                        }
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function updateInvoiceItemPriceFromSearch(hiddenInput) {
            const row = hiddenInput.closest('.invoice-items');
            if (!row) return;
            
            const productIndex = hiddenInput.value;
            
            if (productIndex !== '') {
                const product = products[productIndex];
                const priceInput = row.querySelector('.invoice-price');
                const quantityInput = row.querySelector('.invoice-quantity');
                const amountInput = row.querySelector('.invoice-amount');
                
                priceInput.value = formatPrice(product.price);
                const quantity = parseInt(quantityInput.value) || 1;
                amountInput.value = formatPrice(product.price * quantity);
                calculateInvoiceTotals();
            }
        }

        // Переключение внутренних вкладок в разделе Документы (инвойс/отпремница)
        function switchInvoiceInnerTab(tabId) {
            // Скрываем все внутренние вкладки
            document.querySelectorAll('#invoice .inner-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Убираем активный стиль со всех кнопок
            document.querySelectorAll('#invoice .inner-tab-btn').forEach(btn => {
                btn.style.background = '#e9ecef';
                btn.style.color = '#495057';
                btn.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            const targetContent = document.getElementById(tabId + '-content');
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // Активируем кнопку
            const activeBtn = document.getElementById(tabId === 'invoice-form' ? 'invoiceFormTabBtn' : 'deliveryFormTabBtn');
            if (activeBtn) {
                activeBtn.style.background = '#114A9F';
                activeBtn.style.color = 'white';
                activeBtn.classList.add('active');
            }
        }

        function showTab(tabName, event) {
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            
            // Скрываем все контентные блоки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                if (isClientUser) {
                    tab.style.display = 'none';
                } else {
                    // Для обычных пользователей тоже скрываем
                    tab.style.display = 'none';
                }
            });
            
            // Убираем активный класс со всех вкладок
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Показываем нужный контент
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                // Показываем контент для всех типов пользователей
                targetTab.style.display = 'block';
            }
            
            // Активируем нужную вкладку
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Если событие не передано, найдем вкладку по target
                const tabButton = isClientUser ? 
                    document.querySelector(`[onclick*="${tabName}"]`) : 
                    document.querySelector(`.nav-tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            // Для клиентских пользователей скрываем форму создания групп на складе
            if (tabName === 'warehouse' && isClientUser) {
                const groupCreationForm = document.getElementById('groupCreationForm');
                if (groupCreationForm) {
                    groupCreationForm.style.display = 'none';
                }
                
                // Загружаем клиентские группы товаров для конкретного клиента
                const clientMB = window.currentUser?.clientMB;
                if (!clientMB) {
                    console.error('Не найден matični broj клиента');
                    return;
                }
                
                if (!window.clientProductGroups) {
                    window.clientProductGroups = {};
                }
                
                if (!window.clientProductGroups[clientMB]) {
                    const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                    window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                }
                
                console.log('Открыт склад для клиента:', {
                    clientMB: clientMB,
                    groupsLoaded: window.clientProductGroups[clientMB]?.length || 0
                });
                
                renderProductGroups();
            } else if (tabName === 'warehouse') {
                // Для обычных пользователей показываем форму создания групп
                const groupCreationForm = document.getElementById('groupCreationForm');
                if (groupCreationForm) {
                    groupCreationForm.style.display = 'block';
                }
                renderProductGroups();
                // Обновляем отображение запасов чая
                updateTeaStockDisplay();
                // Загружаем категории для формы создания группы
                loadGroupCategories();
            }
            
            // Загружаем данные для соответствующих вкладок
            if (tabName === 'incomingDocuments') {
                loadIncomingDocuments();
            } else if (tabName === 'clientSales' && isClientUser) {
                loadSalesProducts();
                loadSalesHistory();
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => document.body.removeChild(alertDiv), 3000);
        }

        // СИСТЕМА УПРАВЛЕНИЯ ОБРАБОТЧИКАМИ СОБЫТИЙ (предотвращение утечек памяти)
        const EventManager = {
            listeners: [],
            
            // Добавить обработчик с отслеживанием
            add: function(element, event, handler, options = {}) {
                if (!element) {
                    console.warn('EventManager: элемент не найден для добавления обработчика');
                    return;
                }
                
                element.addEventListener(event, handler, options);
                this.listeners.push({
                    element: element,
                    event: event,
                    handler: handler,
                    options: options
                });
                
                console.log(`EventManager: добавлен обработчик ${event} для`, element);
            },
            
            // Удалить конкретный обработчик
            remove: function(element, event, handler) {
                if (!element) return;
                
                element.removeEventListener(event, handler);
                this.listeners = this.listeners.filter(listener => 
                    !(listener.element === element && listener.event === event && listener.handler === handler)
                );
                
                console.log(`EventManager: удален обработчик ${event} для`, element);
            },
            
            // Удалить все обработчики для элемента
            removeAllForElement: function(element) {
                if (!element) return;
                
                const toRemove = this.listeners.filter(listener => listener.element === element);
                toRemove.forEach(listener => {
                    listener.element.removeEventListener(listener.event, listener.handler);
                });
                
                this.listeners = this.listeners.filter(listener => listener.element !== element);
                console.log(`EventManager: удалены все обработчики для`, element);
            },
            
            // Очистить все обработчики
            removeAll: function() {
                this.listeners.forEach(listener => {
                    if (listener.element) {
                        listener.element.removeEventListener(listener.event, listener.handler);
                    }
                });
                this.listeners = [];
                console.log('EventManager: все обработчики очищены');
            },
            
            // Получить статистику
            getStats: function() {
                const stats = {
                    total: this.listeners.length,
                    byEvent: {},
                    byElement: {}
                };
                
                this.listeners.forEach(listener => {
                    // По типам событий
                    stats.byEvent[listener.event] = (stats.byEvent[listener.event] || 0) + 1;
                    
                    // По элементам
                    const elementTag = listener.element.tagName || 'unknown';
                    stats.byElement[elementTag] = (stats.byElement[elementTag] || 0) + 1;
                });
                
                return stats;
            }
        };
        
        // Функция для безопасного добавления обработчиков
        function addSafeEventListener(elementId, event, handler, options = {}) {
            const element = document.getElementById(elementId);
            if (element) {
                EventManager.add(element, event, handler, options);
                return true;
            } else {
                console.warn(`Элемент с ID "${elementId}" не найден`);
                return false;
            }
        }

        // КОМПЛЕКСНАЯ ВАЛИДАЦИЯ ФОРМ
        function validateField(fieldId, fieldName, validationType = 'required') {
            const field = document.getElementById(fieldId);
            if (!field) {
                console.warn(`Поле ${fieldId} не найдено`);
                return { isValid: true, message: '' }; // Пропускаем несуществующие поля
            }
            
            const value = field.value.trim();
            
            switch (validationType) {
                case 'required':
                    if (!value) {
                        return { isValid: false, message: `${fieldName} обязательно для заполнения` };
                    }
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (value && !emailRegex.test(value)) {
                        return { isValid: false, message: `${fieldName} должен быть корректным email адресом` };
                    }
                    break;
                    
                case 'number':
                    if (value && (isNaN(value) || parseFloat(value) < 0)) {
                        return { isValid: false, message: `${fieldName} должно быть положительным числом` };
                    }
                    break;
                    
                case 'positive_number':
                    if (!value || isNaN(value) || parseFloat(value) <= 0) {
                        return { isValid: false, message: `${fieldName} должно быть положительным числом больше 0` };
                    }
                    break;
                    
                case 'mb': // Матични број (8 цифр)
                    const mbRegex = /^\d{8}$/;
                    if (value && !mbRegex.test(value)) {
                        return { isValid: false, message: `${fieldName} должен содержать ровно 8 цифр` };
                    }
                    break;
                    
                case 'pib': // ПИБ (9 цифр)
                    const pibRegex = /^\d{9}$/;
                    if (value && !pibRegex.test(value)) {
                        return { isValid: false, message: `${fieldName} должен содержать ровно 9 цифр` };
                    }
                    break;
                    
                case 'date':
                    if (value && isNaN(Date.parse(value))) {
                        return { isValid: false, message: `${fieldName} должна быть корректной датой` };
                    }
                    break;
            }
            
            return { isValid: true, message: '' };
        }
        
        function validateForm(fields) {
            const errors = [];
            
            fields.forEach(field => {
                const validation = validateField(field.id, field.name, field.type);
                if (!validation.isValid) {
                    errors.push(validation.message);
                    
                    // Подсвечиваем поле с ошибкой
                    const fieldElement = document.getElementById(field.id);
                    if (fieldElement) {
                        fieldElement.style.borderColor = '#dc3545';
                        fieldElement.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                    }
                } else {
                    // Убираем подсветку ошибки
                    const fieldElement = document.getElementById(field.id);
                    if (fieldElement) {
                        fieldElement.style.borderColor = '';
                        fieldElement.style.boxShadow = '';
                    }
                }
            });
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Клиенты
        async function addClient() {
            // Валидация обязательных полей клиента
            const clientFields = [
                { id: 'clientName', name: 'Название компании', type: 'required' },
                { id: 'clientLegalName', name: 'Юридическое название', type: 'required' },
                { id: 'clientMB', name: 'Матични број', type: 'mb' },
                { id: 'clientPIB', name: 'ПИБ', type: 'pib' }
            ];
            
            // Проверяем адрес в зависимости от типа ввода
            const isManualInput = document.getElementById('manualAddressInput').checked;
            if (isManualInput) {
                clientFields.push({ id: 'clientManualAddress', name: 'Полный адрес', type: 'required' });
            } else {
                clientFields.push(
                    { id: 'clientCity', name: 'Город', type: 'required' },
                    { id: 'clientMunicipality', name: 'Община', type: 'required' },
                    { id: 'clientStreet', name: 'Улица', type: 'required' }
                );
            }
            
            const validation = validateForm(clientFields);
            if (!validation.isValid) {
                showAlert('Ошибки валидации:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const name = document.getElementById('clientName').value.trim();
            const legalName = document.getElementById('clientLegalName').value.trim();
            const mb = document.getElementById('clientMB').value.trim();
            const pib = document.getElementById('clientPIB').value.trim();
            const bank = document.getElementById('clientBank').value.trim();
            const clientType = document.getElementById('clientType').value;
            const abbreviation = document.getElementById('clientAbbreviation').value.trim().toUpperCase();
            
            // Новые поля
            const googleMaps = document.getElementById('clientGoogleMaps').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const contactPersonStatus = document.getElementById('clientContactPersonStatus').value;
            const phone = document.getElementById('clientPhone').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const telegram = document.getElementById('clientTelegram').value.trim();
            const instagram = document.getElementById('clientInstagram').value.trim();
            const installment = document.getElementById('clientInstallment').checked;
            const installmentTerm = document.getElementById('clientInstallmentTerm').value.trim();
            const showcase = document.getElementById('clientShowcase').checked;
            const bar = document.getElementById('clientBar').checked;
            const notes = document.getElementById('clientNotes').value.trim();
            const parsedInstallmentTerm = installmentTerm ? parseInt(installmentTerm, 10) : null;
            const normalizedInstallmentTerm = Number.isNaN(parsedInstallmentTerm) ? null : parsedInstallmentTerm;
            const normalizedInstallment = installment ? 1 : 0;
            const normalizedShowcase = showcase ? 1 : 0;
            const normalizedBar = bar ? 1 : 0;
            const normalizedIsManualAddress = isManualInput ? 1 : 0;
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                // Ручной ввод адреса
                address = document.getElementById('clientManualAddress').value.trim();
                
                if (!name || !legalName || !mb || !pib || !address) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }
                
                // Парсим адрес для базовой структуры (опционально)
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
                
            } else {
                // Автоматический ввод адреса
                city = document.getElementById('clientCity').value.trim();
                municipality = document.getElementById('clientMunicipality').value.trim();
                street = document.getElementById('clientStreet').value.trim();
                houseNumber = document.getElementById('clientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }

                // Формируем полный адрес
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            const newClient = { 
                name, 
                legalName,
                mb, 
                pib, 
                address, 
                bank,
                clientType,
                abbreviation,
                city, 
                municipality, 
                street, 
                houseNumber,
                isManualAddress: normalizedIsManualAddress,
                googleMaps,
                contactPerson,
                contactPersonStatus,
                phone,
                email,
                telegram,
                instagram,
                installment: normalizedInstallment,
                installmentTerm: normalizedInstallmentTerm,
                showcase: normalizedShowcase,
                bar: normalizedBar,
                notes,
                // Сохраняем старое поле contact для совместимости
                contact: contactPerson || phone || email || ''
            };
            
            // Отправляем на API
            try {
                showLoadingIndicator(true, 'Создание клиента...');
                
                const response = await ClientsAPI.create(newClient);
                
                // Добавляем клиента с ID от сервера в локальный массив
                clients.push(response.client);
                
                // Сохраняем в localStorage для fallback
                localStorage.setItem('clients', JSON.stringify(clients));
                
                addLog(`Добавлен клиент: ${name}`);
                clearClientForm(); 
                renderClientsTable();
                updateSelectOptions();
                showAlert('Клиент успешно создан!', 'success');
                
                console.log('✅ Client created:', response.client);
                
            } catch (error) {
                console.error('❌ Failed to create client:', error);
                
                // Fallback: сохраняем локально если API недоступен
                newClient.id = Date.now().toString(); // Временный ID
                clients.push(newClient);
                localStorage.setItem('clients', JSON.stringify(clients));
                
                addLog(`Добавлен клиент (локально): ${name}`);
                clearClientForm(); 
                renderClientsTable();
                updateSelectOptions();
                
                showAlert(`❌ Ошибка при создании клиента: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        function clearClientForm() {
            ['clientName', 'clientLegalName', 'clientMB', 'clientPIB', 'clientCity', 'clientMunicipality', 'clientStreet', 'clientHouseNumber', 'clientBank', 'clientType', 'clientAbbreviation', 'clientManualAddress', 'clientGoogleMaps', 'clientContactPerson', 'clientPhone', 'clientEmail', 'clientTelegram', 'clientInstagram', 'clientInstallmentTerm', 'clientNotes'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Сбрасываем чекбоксы
            ['clientInstallment', 'clientShowcase', 'clientBar'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.checked = false;
            });
            
            // Сбрасываем чекбокс ручного ввода
            const manualCheckbox = document.getElementById('manualAddressInput');
            if (manualCheckbox) {
                manualCheckbox.checked = false;
                
                // Показываем автоматический ввод, скрываем ручной
                document.getElementById('automaticAddressSection').style.display = 'block';
                document.getElementById('manualAddressSection').style.display = 'none';
            }
            
            // Сбросить состояние полей адреса
            const municipalityInput = document.getElementById('clientMunicipality');
            const streetInput = document.getElementById('clientStreet');
            if (municipalityInput) {
                municipalityInput.disabled = true;
                municipalityInput.placeholder = 'Выберите сначала город...';
            }
            if (streetInput) {
                streetInput.disabled = true;
                streetInput.placeholder = 'Выберите сначала общину...';
            }
            
            // Сбрасываем подсветку полей
            resetFieldHighlighting(document.getElementById('clients'));
        }

        // Функция для логирования удаления клиентов
        function logClientDelete(message, color = '#00ff00') {
            const debugBlock = document.getElementById('clientDeleteDebugBlock');
            const debugMessages = document.getElementById('clientDeleteMessages');
            
            if (debugBlock && debugMessages) {
                // Логи скрыты - не показываем блок
                // debugBlock.style.display = 'block';
                
                const time = new Date().toLocaleTimeString();
                const line = document.createElement('div');
                line.style.color = color;
                line.style.marginBottom = '5px';
                line.textContent = `[${time}] ${message}`;
                debugMessages.appendChild(line);
                debugMessages.scrollTop = debugMessages.scrollHeight;
            }
            console.log(message);
        }
        
        // Функция для очистки логов
        function clearClientDeleteLogs() {
            const debugMessages = document.getElementById('clientDeleteMessages');
            if (debugMessages) {
                debugMessages.innerHTML = 'Ожидание...';
            }
        }
        
        // Функция для показа модального окна подтверждения
        function showDeleteConfirmModal(message, details, onConfirm) {
            const modal = document.getElementById('deleteConfirmModal');
            const messageEl = document.getElementById('deleteConfirmMessage');
            const detailsEl = document.getElementById('deleteConfirmDetails');
            const confirmBtn = document.getElementById('deleteConfirmButton');
            
            messageEl.textContent = message;
            detailsEl.innerHTML = details;
            
            // Удаляем старые обработчики
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // Добавляем новый обработчик
            newConfirmBtn.onclick = () => {
                closeDeleteConfirmModal();
                onConfirm();
            };
            
            modal.style.display = 'block';
        }
        
        // Функция для закрытия модального окна
        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
        }

        // Функция для показа модального окна подтверждения статуса
        function showStatusConfirmModal(message, details, onConfirm) {
            const modal = document.getElementById('statusConfirmModal');
            const messageEl = document.getElementById('statusConfirmMessage');
            const detailsEl = document.getElementById('statusConfirmDetails');
            const confirmBtn = document.getElementById('statusConfirmButton');
            
            messageEl.textContent = message;
            detailsEl.innerHTML = details;
            
            // Удаляем старые обработчики
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // Добавляем новый обработчик
            newConfirmBtn.onclick = () => {
                closeStatusConfirmModal();
                onConfirm();
            };
            
            modal.style.display = 'block';
        }
        
        // Функция для закрытия модального окна статуса
        function closeStatusConfirmModal() {
            const modal = document.getElementById('statusConfirmModal');
            modal.style.display = 'none';
        }
        
        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('deleteConfirmModal');
            if (event.target === modal) {
                closeDeleteConfirmModal();
            }
        }

        async function deleteClient(index) {
            const client = clients[index];
            
            logClientDelete('═══════════════════════════════════════', '#ffa500');
            logClientDelete('🗑️ НАЧАЛО УДАЛЕНИЯ КЛИЕНТА', '#ffa500');
            logClientDelete(`📋 Индекс: ${index}`, '#00bfff');
            logClientDelete(`📋 Название: ${client.name}`, '#00bfff');
            logClientDelete(`📋 ID: ${client.id} (тип: ${typeof client.id})`, '#00bfff');
            
            // Показываем модальное окно
            const details = `
                <strong>Информация о клиенте:</strong>
                <div>📋 Название: ${client.name}</div>
                <div>🏢 Юр. название: ${client.legalName || '-'}</div>
                <div>🆔 Матични број: ${client.mb || '-'}</div>
                <div>💼 ID в базе: ${client.id} (${typeof client.id})</div>
            `;
            
            showDeleteConfirmModal(
                `Вы уверены, что хотите удалить клиента "${client.name}"?`,
                details,
                async () => {
                    await performClientDelete(index, client);
                }
            );
        }
        
        async function performClientDelete(index, client) {
            logClientDelete('✅ Удаление подтверждено пользователем', '#00ff00');
            
            try {
                showLoadingIndicator(true, 'Удаление клиента...');
                
                // Удаляем через API если есть ID
                if (client.id) {
                    logClientDelete(`🔄 Вызываем ClientsAPI.delete(${client.id})...`, '#ffff00');
                    await ClientsAPI.delete(client.id);
                    logClientDelete('✅ ClientsAPI.delete успешно выполнен', '#00ff00');
                } else {
                    logClientDelete('⚠️ У клиента нет ID, пропускаем API', '#ffa500');
                }
                
                // Удаляем из локального массива
                logClientDelete('🔄 Удаляем из локального массива...', '#ffff00');
                clients.splice(index, 1);
                
                // Сохраняем в localStorage
                logClientDelete('💾 Сохраняем в localStorage...', '#ffff00');
                localStorage.setItem('clients', JSON.stringify(clients));
                
                logClientDelete('🔄 Обновляем UI...', '#ffff00');
                renderClientsTable();
                updateSelectOptions();
                showAlert('Клиент успешно удален!', 'success');
                
                logClientDelete(`✅ КЛИЕНТ "${client.name}" УСПЕШНО УДАЛЕН`, '#00ff00');
                logClientDelete('═══════════════════════════════════════', '#ffa500');
                
            } catch (error) {
                logClientDelete(`❌ ОШИБКА: ${error.message}`, '#ff0000');
                logClientDelete(`❌ Stack: ${error.stack}`, '#ff6b6b');
                
                // Fallback: удаляем локально даже если API недоступен
                logClientDelete('⚠️ Fallback: удаляем локально...', '#ffa500');
                clients.splice(index, 1);
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClientsTable();
                updateSelectOptions();
                
                showAlert(`Клиент удален локально (ошибка API: ${error.message})`, 'warning');
                logClientDelete('═══════════════════════════════════════', '#ffa500');
            } finally {
                showLoadingIndicator(false);
            }
        }

        function renderClientsTable() {
            const container = document.getElementById('clientsCardsContainer');
            if(!container) return;
            container.innerHTML = '';
            
            clients.forEach((client, index) => {
                const card = document.createElement('div');
                card.className = 'client-card';
                card.setAttribute('data-client-index', index);
                card.setAttribute('data-client-type', client.clientType || '');
                
                // Emoji для типов клиентов
                const clientTypeEmojis = {
                    'Бар': '🍺',
                    'Ресторан': '🍽️',
                    'Отель': '🏨',
                    'Кальянная': '💨',
                    'Кафе': '☕'
                };
                const typeEmoji = client.clientType ? clientTypeEmojis[client.clientType] : '';
                
                card.innerHTML = `
                    <div class="client-card-header">
                        <h3 class="client-card-title">
                            <span class="client-name">${client.name || 'Без названия'}${client.abbreviation ? ' <span style="opacity: 0.8; font-weight: 400;">(' + client.abbreviation + ')</span>' : ''}</span>
                            ${client.clientType ? `<span class="client-badge" style="background: #6c757d;">${typeEmoji} ${client.clientType}</span>` : ''}
                            ${client.showcase ? '<span class="client-badge">Витрина</span>' : ''}
                            ${client.bar ? '<span class="client-badge">Бар</span>' : ''}
                        </h3>
                    </div>
                    
                    <div class="client-card-body" id="clientView${index}">
                        <div class="client-info-row">
                            <div class="client-info-label">Юр. название:</div>
                            <div class="client-info-value"><strong>${client.legalName || '-'}</strong></div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">Матични број:</div>
                            <div class="client-info-value">${client.mb || '-'}</div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">ПИБ:</div>
                            <div class="client-info-value">${client.pib || '-'}</div>
                        </div>
                        ${client.clientType ? `
                        <div class="client-info-row">
                            <div class="client-info-label">Тип клиента:</div>
                            <div class="client-info-value">${typeEmoji} ${client.clientType}</div>
                        </div>
                        ` : ''}
                        <div class="client-info-row">
                            <div class="client-info-label">Адрес:</div>
                            <div class="client-info-value">${client.address || '-'}</div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">Контакт:</div>
                            <div class="client-info-value">${client.contactPerson || '-'}</div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">Телефон:</div>
                            <div class="client-info-value">${client.phone || '-'}</div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">Email:</div>
                            <div class="client-info-value">${client.email || '-'}</div>
                        </div>
                        <div class="client-info-row">
                            <div class="client-info-label">Банк:</div>
                            <div class="client-info-value">${client.bank || '-'}</div>
                        </div>
                        ${client.installment ? `
                        <div class="client-info-row">
                            <div class="client-info-label">Рассрочка:</div>
                            <div class="client-info-value">${client.installmentTerm || '-'} дней</div>
                        </div>
                        ` : ''}
                        ${client.notes ? `
                        <div class="client-info-row">
                            <div class="client-info-label">Примечания:</div>
                            <div class="client-info-value">${client.notes}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="client-edit-form" id="clientEdit${index}">
                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            <h4 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;">📋 Основная информация</h4>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Название *</label>
                                <input type="text" id="editName${index}" value="${client.name || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Юридическое название *</label>
                                <input type="text" id="editLegalName${index}" value="${client.legalName || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Аббревиатура (4-5 лат. букв)</label>
                                <input type="text" id="editAbbreviation${index}" value="${client.abbreviation || ''}" maxlength="5" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; text-transform: uppercase;" placeholder="SVDA" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 5)">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">МБ *</label>
                                    <input type="text" id="editMB${index}" value="${client.mb || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">ПИБ *</label>
                                    <input type="text" id="editPIB${index}" value="${client.pib || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Тип клиента</label>
                                <select id="editClientType${index}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="">Выберите тип</option>
                                    <option value="Бар" ${client.clientType === 'Бар' ? 'selected' : ''}>🍺 Бар</option>
                                    <option value="Ресторан" ${client.clientType === 'Ресторан' ? 'selected' : ''}>🍽️ Ресторан</option>
                                    <option value="Отель" ${client.clientType === 'Отель' ? 'selected' : ''}>🏨 Отель</option>
                                    <option value="Кальянная" ${client.clientType === 'Кальянная' ? 'selected' : ''}>💨 Кальянная</option>
                                    <option value="Кафе" ${client.clientType === 'Кафе' ? 'selected' : ''}>☕ Кафе</option>
                                    <option value="Чайная" ${client.clientType === 'Чайная' ? 'selected' : ''}>🍵 Чайная</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Адрес *</label>
                                <textarea id="editAddress${index}" rows="2" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;">${client.address || ''}</textarea>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Google Maps</label>
                                <input type="url" id="editGoogleMaps${index}" value="${client.googleMaps || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="https://maps.google.com/...">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Банк</label>
                                <input type="text" id="editBank${index}" value="${client.bank || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <h4 style="margin: 15px 0 10px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;">👤 Основной контакт</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Контактное лицо</label>
                                    <input type="text" id="editContactPerson${index}" value="${client.contactPerson || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Статус</label>
                                    <select id="editContactPersonStatus${index}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                        <option value="">Не указан</option>
                                        <option value="Владелец" ${client.contactPersonStatus === 'Владелец' ? 'selected' : ''}>👑 Владелец</option>
                                        <option value="Директор" ${client.contactPersonStatus === 'Директор' ? 'selected' : ''}>👔 Директор</option>
                                        <option value="Управляющий" ${client.contactPersonStatus === 'Управляющий' ? 'selected' : ''}>📋 Управляющий</option>
                                        <option value="Закупщик" ${client.contactPersonStatus === 'Закупщик' ? 'selected' : ''}>🛒 Закупщик</option>
                                        <option value="Бармен" ${client.contactPersonStatus === 'Бармен' ? 'selected' : ''}>🍸 Бармен</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Телефон</label>
                                    <input type="text" id="editPhone${index}" value="${client.phone || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Email</label>
                                    <input type="email" id="editEmail${index}" value="${client.email || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Telegram</label>
                                    <input type="text" id="editTelegram${index}" value="${client.telegram || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="@username">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Instagram</label>
                                    <input type="text" id="editInstagram${index}" value="${client.instagram || ''}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="@username">
                                </div>
                            </div>
                            
                            <h4 style="margin: 15px 0 10px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;">
                                👥 Дополнительные контакты
                                <button type="button" onclick="addAdditionalContact(${index})" class="btn btn-success btn-sm" style="float: right; padding: 4px 12px; font-size: 12px;">+ Добавить контакт</button>
                            </h4>
                            
                            <div id="additionalContacts${index}" style="display: grid; gap: 10px;">
                                <!-- Дополнительные контакты будут здесь -->
                            </div>
                            
                            <h4 style="margin: 15px 0 10px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;">🤝 Условия сотрудничества</h4>
                            
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="editInstallment${index}" ${client.installment ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #666; font-size: 13px;">Рассрочка оплаты</span>
                                </label>
                                <input type="number" id="editInstallmentTerm${index}" value="${client.installmentTerm || ''}" placeholder="Срок (дни)" style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="display: flex; gap: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="editShowcase${index}" ${client.showcase ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #666; font-size: 13px;">Витрина</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="editBar${index}" ${client.bar ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #666; font-size: 13px;">Бар</span>
                                </label>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 13px;">Примечания</label>
                                <textarea id="editNotes${index}" rows="3" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;" placeholder="Дополнительные примечания о клиенте...">${client.notes || ''}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <button class="btn btn-success" onclick="saveClientEdit(${index})" style="flex: 1; padding: 12px; font-size: 15px; font-weight: 600;">✓ Сохранить изменения</button>
                                <button class="btn btn-secondary" onclick="cancelClientEdit(${index})" style="flex: 1; padding: 12px; font-size: 15px;">✕ Отмена</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="client-card-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                        <button class="btn btn-primary btn-sm" onclick="toggleClientEdit(${index})">
                            ✏️ Редактировать
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showClientHistory('${client.name.replace(/'/g, "\\'")}')">
                            📊 История
                        </button>
                        <button class="btn btn-success btn-sm" onclick="openClientProfile(${index})">
                            👤 Профиль
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient(${index})">
                            🗑️ Удалить
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Функции для управления карточками клиентов
        function toggleClientEdit(index) {
            const card = document.querySelector(`[data-client-index="${index}"]`);
            const viewSection = document.getElementById(`clientView${index}`);
            const editSection = document.getElementById(`clientEdit${index}`);
            
            const isEditing = editSection.classList.contains('active');
            
            if (isEditing) {
                // Закрываем редактирование
                editSection.classList.remove('active');
                viewSection.style.display = 'block';
                card.classList.remove('editing');
            } else {
                // Открываем редактирование
                editSection.classList.add('active');
                viewSection.style.display = 'none';
                card.classList.add('editing');
                
                // Загружаем дополнительные контакты
                loadAdditionalContacts(index);
            }
        }
        
        // Функции для работы с дополнительными контактами
        function loadAdditionalContacts(clientIndex) {
            const client = clients[clientIndex];
            const container = document.getElementById(`additionalContacts${clientIndex}`);
            container.innerHTML = '';
            
            if (!client.additionalContacts) {
                client.additionalContacts = [];
            }
            
            client.additionalContacts.forEach((contact, contactIndex) => {
                addAdditionalContactHTML(clientIndex, contactIndex, contact);
            });
            
            // Показываем сообщение если нет контактов
            if (client.additionalContacts.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; text-align: center; padding: 10px;">Нет дополнительных контактов. Нажмите "+ Добавить контакт" чтобы добавить.</p>';
            }
        }
        
        function addAdditionalContact(clientIndex) {
            const client = clients[clientIndex];
            if (!client.additionalContacts) {
                client.additionalContacts = [];
            }
            
            if (client.additionalContacts.length >= 5) {
                showAlert('Максимум 5 дополнительных контактов!', 'warning');
                return;
            }
            
            const newContact = {
                name: '',
                phone: '',
                email: '',
                telegram: ''
            };
            
            client.additionalContacts.push(newContact);
            loadAdditionalContacts(clientIndex);
        }
        
        function addAdditionalContactHTML(clientIndex, contactIndex, contact) {
            const container = document.getElementById(`additionalContacts${clientIndex}`);
            
            const contactDiv = document.createElement('div');
            contactDiv.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0; position: relative;';
            contactDiv.innerHTML = `
                <button type="button" onclick="removeAdditionalContact(${clientIndex}, ${contactIndex})" 
                    style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center;"
                    title="Удалить контакт">×</button>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 12px;">Имя контакта ${contactIndex + 1}</label>
                        <input type="text" id="contactName${clientIndex}_${contactIndex}" value="${contact.name || ''}" 
                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="Имя и фамилия">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 12px;">Статус</label>
                        <select id="contactStatus${clientIndex}_${contactIndex}" 
                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white;">
                            <option value="">Не указан</option>
                            <option value="Владелец" ${contact.status === 'Владелец' ? 'selected' : ''}>👑 Владелец</option>
                            <option value="Директор" ${contact.status === 'Директор' ? 'selected' : ''}>👔 Директор</option>
                            <option value="Управляющий" ${contact.status === 'Управляющий' ? 'selected' : ''}>📋 Управляющий</option>
                            <option value="Закупщик" ${contact.status === 'Закупщик' ? 'selected' : ''}>🛒 Закупщик</option>
                            <option value="Бармен" ${contact.status === 'Бармен' ? 'selected' : ''}>🍸 Бармен</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 12px;">Телефон</label>
                        <input type="text" id="contactPhone${clientIndex}_${contactIndex}" value="${contact.phone || ''}" 
                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="+381...">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 12px;">Email</label>
                        <input type="email" id="contactEmail${clientIndex}_${contactIndex}" value="${contact.email || ''}" 
                            style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="email@example.com">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #666; font-size: 12px;">Telegram</label>
                    <input type="text" id="contactTelegram${clientIndex}_${contactIndex}" value="${contact.telegram || ''}" 
                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="@username">
                </div>
            `;
            
            container.appendChild(contactDiv);
        }
        
        function removeAdditionalContact(clientIndex, contactIndex) {
            const client = clients[clientIndex];
            if (!client || !client.additionalContacts) return;
            
            // Удаляем контакт без подтверждения для лучшей работы в Tauri
            client.additionalContacts.splice(contactIndex, 1);
            loadAdditionalContacts(clientIndex);
            
            console.log(`Удален дополнительный контакт ${contactIndex + 1} у клиента ${client.name}`);
        }
        
        async function saveClientEdit(index) {
            const client = clients[index];
            
            // Получаем значения из основных полей
            const name = document.getElementById(`editName${index}`).value.trim();
            const legalName = document.getElementById(`editLegalName${index}`).value.trim();
            const abbreviation = document.getElementById(`editAbbreviation${index}`)?.value.trim().toUpperCase() || '';
            const mb = document.getElementById(`editMB${index}`).value.trim();
            const pib = document.getElementById(`editPIB${index}`).value.trim();
            const address = document.getElementById(`editAddress${index}`).value.trim();
            const googleMaps = document.getElementById(`editGoogleMaps${index}`).value.trim();
            const bank = document.getElementById(`editBank${index}`).value.trim();
            const clientType = document.getElementById(`editClientType${index}`).value;
            
            // Получаем контактные данные
            const contactPerson = document.getElementById(`editContactPerson${index}`).value.trim();
            const contactPersonStatus = document.getElementById(`editContactPersonStatus${index}`).value;
            const phone = document.getElementById(`editPhone${index}`).value.trim();
            const email = document.getElementById(`editEmail${index}`).value.trim();
            const telegram = document.getElementById(`editTelegram${index}`).value.trim();
            const instagram = document.getElementById(`editInstagram${index}`).value.trim();
            
            // Получаем условия сотрудничества
            const installment = document.getElementById(`editInstallment${index}`).checked;
            const installmentTerm = document.getElementById(`editInstallmentTerm${index}`).value.trim();
            const showcase = document.getElementById(`editShowcase${index}`).checked;
            const bar = document.getElementById(`editBar${index}`).checked;
            const notes = document.getElementById(`editNotes${index}`).value.trim();
            const parsedInstallmentTerm = installmentTerm ? parseInt(installmentTerm, 10) : null;
            const normalizedInstallmentTerm = Number.isNaN(parsedInstallmentTerm) ? null : parsedInstallmentTerm;
            const normalizedInstallment = installment ? 1 : 0;
            const normalizedShowcase = showcase ? 1 : 0;
            const normalizedBar = bar ? 1 : 0;
            
            // Валидация обязательных полей
            if (!name || !legalName || !mb || !pib || !address) {
                showAlert('Заполните все обязательные поля (отмечены *)!', 'danger');
                return;
            }
            
            // Собираем дополнительные контакты
            const additionalContacts = [];
            if (client.additionalContacts) {
                client.additionalContacts.forEach((contact, contactIndex) => {
                    const contactName = document.getElementById(`contactName${index}_${contactIndex}`)?.value.trim();
                    const contactStatus = document.getElementById(`contactStatus${index}_${contactIndex}`)?.value || '';
                    const contactPhone = document.getElementById(`contactPhone${index}_${contactIndex}`)?.value.trim();
                    const contactEmail = document.getElementById(`contactEmail${index}_${contactIndex}`)?.value.trim();
                    const contactTelegram = document.getElementById(`contactTelegram${index}_${contactIndex}`)?.value.trim();
                    
                    // Сохраняем только заполненные контакты
                    if (contactName || contactPhone || contactEmail || contactTelegram) {
                        additionalContacts.push({
                            name: contactName,
                            status: contactStatus,
                            phone: contactPhone,
                            email: contactEmail,
                            telegram: contactTelegram
                        });
                    }
                });
            }
            
            // Обновляем данные клиента
            client.name = name;
            client.legalName = legalName;
            client.abbreviation = abbreviation;
            client.mb = mb;
            client.pib = pib;
            client.address = address;
            client.googleMaps = googleMaps;
            client.bank = bank;
            client.clientType = clientType;
            client.contactPerson = contactPerson;
            client.contactPersonStatus = contactPersonStatus;
            client.phone = phone;
            client.email = email;
            client.telegram = telegram;
            client.instagram = instagram;
            client.installment = normalizedInstallment;
            client.installmentTerm = normalizedInstallmentTerm;
            client.showcase = normalizedShowcase;
            client.bar = normalizedBar;
            client.notes = notes;
            client.additionalContacts = additionalContacts;
            client.isManualAddress = true; // Адрес вводится вручную в карточке
            
            // Сохраняем старое поле contact для совместимости
            client.contact = contactPerson || phone || email || '';
            
            // Отправляем на API
            try {
                showLoadingIndicator(true, 'Обновление клиента...');
                
                if (client.id) {
                    const payload = {
                        ...client,
                        isManualAddress: client.isManualAddress ? 1 : 0
                    };
                    const response = await ClientsAPI.update(client.id, payload);
                    // API не возвращает additionalContacts, сохраняем их
                    clients[index] = {
                        ...response.client,
                        additionalContacts: additionalContacts
                    };
                } else {
                    console.warn('⚠️ Client has no ID, saving locally only');
                }
                
                // Сохраняем в localStorage для fallback
                localStorage.setItem('clients', JSON.stringify(clients));
                
                // Перерисовываем карточки
                renderClientsTable();
                updateSelectOptions();
                showAlert('Данные клиента обновлены!', 'success');
                
                console.log('✅ Client updated:', client);
                
            } catch (error) {
                console.error('❌ Failed to update client:', error);
                
                // Fallback: сохраняем локально
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClientsTable();
                updateSelectOptions();
                
                showAlert(`❌ Ошибка при обновлении клиента: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }
        
        function cancelClientEdit(index) {
            toggleClientEdit(index);
        }

        // СТАРАЯ ФУНКЦИЯ - УДАЛЕНА
        function makeEditable_OLD(cell, clientIndex) {
            // Проверяем, не редактируется ли уже другая ячейка
            const existingEdit = document.querySelector('.editing');
            if (existingEdit) {
                cancelEdit(existingEdit);
            }
            
            const field = cell.getAttribute('data-field');
            const client = clients[clientIndex];
            let currentValue = client[field] || '';
            
            // Сохраняем оригинальное содержимое
            const originalContent = cell.innerHTML;
            cell.classList.add('editing');
            cell.style.backgroundColor = '#fff3cd';
            
            // Создаем input или textarea
            let input;
            if (field === 'address') {
                input = document.createElement('textarea');
                input.rows = 3;
                input.style.width = '100%';
                input.style.resize = 'vertical';
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.style.width = '100%';
            }
            
            input.value = currentValue;
            input.style.padding = '5px';
            input.style.border = '2px solid #007bff';
            input.style.borderRadius = '4px';
            input.style.fontSize = '14px';
            
            // Очищаем ячейку и добавляем input
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // Создаем кнопки сохранения и отмены
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '5px';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '5px';
            
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '✓ Сохранить';
            saveBtn.className = 'btn btn-success btn-sm';
            saveBtn.style.padding = '3px 8px';
            saveBtn.style.fontSize = '12px';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.innerHTML = '✕ Отмена';
            cancelBtn.className = 'btn btn-secondary btn-sm';
            cancelBtn.style.padding = '3px 8px';
            cancelBtn.style.fontSize = '12px';
            
            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            cell.appendChild(buttonContainer);
            
            input.focus();
            input.select();
            
            // Обработчик сохранения
            const saveEdit = () => {
                const newValue = input.value.trim();
                
                // Валидация обязательных полей
                if (['name', 'legalName', 'mb', 'pib', 'address'].includes(field) && !newValue) {
                    showAlert('Это обязательное поле!', 'danger');
                    input.focus();
                    return;
                }
                
                // Сохраняем изменения
                client[field] = newValue;
                
                // Если изменили адрес, обновляем также isManualAddress
                if (field === 'address') {
                    client.isManualAddress = true;
                }
                
                // Сохраняем в localStorage
                localStorage.setItem('clients', JSON.stringify(clients));
                
                // Перерисовываем таблицу
                renderClientsTable();
                updateSelectOptions();
                showAlert('Данные обновлены!', 'success');
                
                console.log('Client updated:', client);
            };
            
            // Обработчик отмены
            const cancelEdit = (cellToCancel = cell) => {
                cellToCancel.classList.remove('editing');
                cellToCancel.style.backgroundColor = '';
                renderClientsTable();
            };
            
            // События для кнопок
            saveBtn.onclick = saveEdit;
            cancelBtn.onclick = () => cancelEdit();
            
            // Enter для сохранения (кроме textarea)
            if (field !== 'address') {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveEdit();
                    }
                });
            }
            
            // Escape для отмены
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        // Функция для отладки данных клиентов
        function debugClients() {
            console.log('=== DEBUG: CLIENTS DATA ===');
            console.log('Total clients:', clients.length);
            console.log('Clients array:', JSON.stringify(clients, null, 2));
            console.log('localStorage clients:', localStorage.getItem('clients'));
            
            // Проверяем каждого клиента
            clients.forEach((client, index) => {
                console.log(`\n--- Client ${index} ---`);
                console.log('Name:', client.name);
                console.log('Legal Name:', client.legalName);
                console.log('MB:', client.mb);
                console.log('PIB:', client.pib);
                console.log('Address:', client.address);
                console.log('City:', client.city);
                console.log('Municipality:', client.municipality);
                console.log('Street:', client.street);
                console.log('Is Manual Address:', client.isManualAddress);
            });
            
            return clients;
        }

        // INLINE РЕДАКТИРОВАНИЕ - теперь используется функция makeEditable()
        // Двойной клик по ячейке таблицы для редактирования

        // Товары
        function addProduct() {
            // Валидация полей товара с новой системой
            const client = clients[index];
            
            console.log('=== EDITING CLIENT ===');
            console.log('Index:', index);
            console.log('Client data:', JSON.stringify(client, null, 2));
            
            // Открываем модальное окно
            const modal = document.getElementById('editClientModal');
            if (!modal) {
                console.error('Modal not found!');
                return;
            }
            modal.style.display = 'block';
            
            // Первая задержка для загрузки DOM
            setTimeout(() => {
                try {
                    // === АДРЕС - настраиваем режим СНАЧАЛА ===
                    const manualAddressCheckbox = document.getElementById('editManualAddressInput');
                    const isManualAddress = client.isManualAddress || false;
                    
                    if (manualAddressCheckbox) {
                        manualAddressCheckbox.checked = isManualAddress;
                    }
                    
                    const autoSection = document.getElementById('editAutoAddressSection');
                    const manualSection = document.getElementById('editManualAddressSection');
                    
                    console.log('Address mode:', isManualAddress ? 'manual' : 'automatic');
                    
                    if (isManualAddress) {
                        if (autoSection) autoSection.style.display = 'none';
                        if (manualSection) manualSection.style.display = 'block';
                    } else {
                        if (autoSection) autoSection.style.display = 'block';
                        if (manualSection) manualSection.style.display = 'none';
                        // Инициализируем поиск адресов только для автоматического режима
                        initializeEditAddressSearch();
                    }
                    
                    // Вторая задержка для заполнения полей ПОСЛЕ инициализации
                    setTimeout(() => {
                        // === ОСНОВНАЯ ИНФОРМАЦИЯ ===
                        const nameField = document.getElementById('editClientName');
                        const legalNameField = document.getElementById('editClientLegalName');
                        const mbField = document.getElementById('editClientMB');
                        const pibField = document.getElementById('editClientPIB');
                        const bankField = document.getElementById('editClientBank');
                        const googleMapsField = document.getElementById('editClientGoogleMaps');
                        
                        if (nameField) {
                            nameField.value = client.name || '';
                            console.log('Name field:', nameField, 'Value set:', nameField.value);
                        }
                        if (legalNameField) {
                            legalNameField.value = client.legalName || '';
                            console.log('Legal name field:', legalNameField, 'Value set:', legalNameField.value);
                        }
                        if (mbField) {
                            mbField.value = client.mb || '';
                            console.log('MB field:', mbField, 'Value set:', mbField.value);
                        }
                        if (pibField) {
                            pibField.value = client.pib || '';
                            console.log('PIB field:', pibField, 'Value set:', pibField.value);
                        }
                        if (bankField) {
                            bankField.value = client.bank || '';
                        }
                        if (googleMapsField) {
                            googleMapsField.value = client.googleMaps || '';
                        }
                        
                        console.log('Basic fields check:', {
                            nameElement: !!nameField,
                            nameValue: nameField?.value,
                            legalNameElement: !!legalNameField,
                            legalNameValue: legalNameField?.value,
                            mbElement: !!mbField,
                            mbValue: mbField?.value,
                            pibElement: !!pibField,
                            pibValue: pibField?.value
                        });
                        
                        // === КОНТАКТНАЯ ИНФОРМАЦИЯ ===
                        const contactPersonField = document.getElementById('editClientContactPerson');
                        const phoneField = document.getElementById('editClientPhone');
                        const emailField = document.getElementById('editClientEmail');
                        const telegramField = document.getElementById('editClientTelegram');
                        const instagramField = document.getElementById('editClientInstagram');
                        
                        if (contactPersonField) contactPersonField.value = client.contactPerson || '';
                        if (phoneField) phoneField.value = client.phone || '';
                        if (emailField) emailField.value = client.email || '';
                        if (telegramField) telegramField.value = client.telegram || '';
                        if (instagramField) instagramField.value = client.instagram || '';
                        
                        // === ДОПОЛНИТЕЛЬНЫЕ ПАРАМЕТРЫ ===
                        const installmentField = document.getElementById('editClientInstallment');
                        const installmentTermField = document.getElementById('editClientInstallmentTerm');
                        const showcaseField = document.getElementById('editClientShowcase');
                        const barField = document.getElementById('editClientBar');
                        const notesField = document.getElementById('editClientNotes');
                        
                        if (installmentField) installmentField.checked = client.installment || false;
                        if (installmentTermField) installmentTermField.value = client.installmentTerm || '';
                        if (showcaseField) showcaseField.checked = client.showcase || false;
                        if (barField) barField.checked = client.bar || false;
                        if (notesField) notesField.value = client.notes || '';
                        
                        // === АДРЕС - заполняем данные ===
                        console.log('Address data:', {
                            address: client.address,
                            city: client.city,
                            municipality: client.municipality,
                            street: client.street,
                            houseNumber: client.houseNumber
                        });
                        
                        if (isManualAddress) {
                            // Ручной ввод адреса
                            const manualAddressField = document.getElementById('editClientManualAddress');
                            if (manualAddressField) {
                                manualAddressField.value = client.address || '';
                                console.log('Manual address set:', manualAddressField.value);
                            }
                        } else {
                            // Автоматический ввод адреса
                            const cityField = document.getElementById('editClientCity');
                            const municipalityField = document.getElementById('editClientMunicipality');
                            const streetField = document.getElementById('editClientStreet');
                            const houseNumberField = document.getElementById('editClientHouseNumber');
                            
                            if (cityField) {
                                cityField.value = client.city || '';
                                console.log('City field:', cityField, 'Value set:', cityField.value);
                            }
                            if (municipalityField) {
                                municipalityField.value = client.municipality || '';
                                municipalityField.disabled = false;
                                console.log('Municipality field:', municipalityField, 'Value set:', municipalityField.value);
                            }
                            if (streetField) {
                                streetField.value = client.street || '';
                                streetField.disabled = false;
                                console.log('Street field:', streetField, 'Value set:', streetField.value);
                            }
                            if (houseNumberField) {
                                houseNumberField.value = client.houseNumber || '';
                                console.log('House number set:', houseNumberField.value);
                            }
                        }
                        
                        console.log('=== CLIENT DATA FILLED SUCCESSFULLY ===');
                    }, 200);
                    
                } catch (error) {
                    console.error('Error filling client data:', error);
                }
            }, 100);
        }

        function closeEditClientModal() {
            document.getElementById('editClientModal').style.display = 'none';
            currentEditingClientIndex = -1;
        }

        function toggleEditAddressInput() {
            const isManual = document.getElementById('editManualAddressInput').checked;
            const automaticSection = document.getElementById('editAutoAddressSection');
            const manualSection = document.getElementById('editManualAddressSection');
            
            if (isManual) {
                automaticSection.style.display = 'none';
                manualSection.style.display = 'block';
            } else {
                automaticSection.style.display = 'block';
                manualSection.style.display = 'none';
                initializeEditAddressSearch();
            }
        }

        function initializeEditAddressSearch() {
            setupCitySearch('editClientCity', 'editClientCityDropdown', 'editClientMunicipality', 'editClientMunicipalityDropdown', 'editClientStreet', 'editClientStreetDropdown');
        }

        function populateEditMunicipalitySelect() {
            // Эта функция больше не нужна, так как мы используем searchable-select
            // Оставляем пустой для совместимости
        }

        async function saveClientChanges() {
            if (currentEditingClientIndex === -1) {
                showAlert('Ошибка: клиент не выбран для редактирования', 'danger');
                return;
            }
            
            // Валидация обязательных полей клиента
            const clientFields = [
                { id: 'editClientName', name: 'Название компании', type: 'required' },
                { id: 'editClientLegalName', name: 'Юридическое название', type: 'required' },
                { id: 'editClientMB', name: 'Матични број', type: 'mb' },
                { id: 'editClientPIB', name: 'ПИБ', type: 'pib' }
            ];
            
            // Проверяем адрес в зависимости от типа ввода
            const isManualInput = document.getElementById('editManualAddressInput').checked;
            if (isManualInput) {
                clientFields.push({ id: 'editClientManualAddress', name: 'Полный адрес', type: 'required' });
            } else {
                clientFields.push(
                    { id: 'editClientCity', name: 'Город', type: 'required' },
                    { id: 'editClientMunicipality', name: 'Община', type: 'required' },
                    { id: 'editClientStreet', name: 'Улица', type: 'required' }
                );
            }
            
            const validation = validateForm(clientFields);
            if (!validation.isValid) {
                showAlert('Ошибки валидации:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const name = document.getElementById('editClientName').value.trim();
            const legalName = document.getElementById('editClientLegalName').value.trim();
            const mb = document.getElementById('editClientMB').value.trim();
            const pib = document.getElementById('editClientPIB').value.trim();
            const bank = document.getElementById('editClientBank').value.trim();
            const abbreviation = document.getElementById('editClientAbbreviation').value.trim().toUpperCase();
            
            // Новые поля
            const googleMaps = document.getElementById('editClientGoogleMaps').value.trim();
            const contactPerson = document.getElementById('editClientContactPerson').value.trim();
            const contactPersonStatus = document.getElementById('editClientContactPersonStatus').value;
            const phone = document.getElementById('editClientPhone').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const telegram = document.getElementById('editClientTelegram').value.trim();
            const instagram = document.getElementById('editClientInstagram').value.trim();
            const installment = document.getElementById('editClientInstallment').checked;
            const installmentTerm = document.getElementById('editClientInstallmentTerm').value.trim();
            const showcase = document.getElementById('editClientShowcase').checked;
            const bar = document.getElementById('editClientBar').checked;
            const notes = document.getElementById('editClientNotes').value.trim();
            const parsedInstallmentTerm = installmentTerm ? parseInt(installmentTerm, 10) : null;
            const normalizedInstallmentTerm = Number.isNaN(parsedInstallmentTerm) ? null : parsedInstallmentTerm;
            const normalizedInstallment = installment ? 1 : 0;
            const normalizedShowcase = showcase ? 1 : 0;
            const normalizedBar = bar ? 1 : 0;
            const normalizedIsManualAddress = isManualInput ? 1 : 0;
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                // Ручной ввод адреса
                address = document.getElementById('editClientManualAddress').value.trim();
                
                if (!name || !legalName || !mb || !pib || !address) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }
                
                // Парсим адрес для базовой структуры (опционально)
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
                
            } else {
                // Автоматический ввод адреса
                city = document.getElementById('editClientCity').value.trim();
                municipality = document.getElementById('editClientMunicipality').value.trim();
                street = document.getElementById('editClientStreet').value.trim();
                houseNumber = document.getElementById('editClientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }

                // Формируем полный адрес
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            // Дубликат удален - переменные уже объявлены выше

            const existingId = clients[currentEditingClientIndex]?.id || null;
            const updatedClient = { 
                id: existingId,
                name, 
                legalName,
                mb, 
                pib, 
                address, 
                bank,
                abbreviation, 
                city, 
                municipality, 
                street, 
                houseNumber,
                isManualAddress: normalizedIsManualAddress,
                googleMaps,
                contactPerson,
                contactPersonStatus,
                phone,
                email,
                telegram,
                instagram,
                installment: normalizedInstallment,
                installmentTerm: normalizedInstallmentTerm,
                showcase: normalizedShowcase,
                bar: normalizedBar,
                notes,
                contact: contactPerson || phone || email || ''
            };
            
            try {
                showLoadingIndicator(true, 'Обновление клиента...');
                
                if (updatedClient.id) {
                    const payload = {
                        ...updatedClient,
                        isManualAddress: updatedClient.isManualAddress ? 1 : 0
                    };
                    const response = await ClientsAPI.update(updatedClient.id, payload);
                    clients[currentEditingClientIndex] = response.client;
                } else {
                    clients[currentEditingClientIndex] = updatedClient;
                }
                
            localStorage.setItem('clients', JSON.stringify(clients));
            
            addLog(`Отредактирован клиент: ${name}`);
            closeEditClientModal();
            renderClientsTable();
            updateSelectOptions();
            showAlert('Данные клиента обновлены!', 'success');
                
            } catch (error) {
                console.error('❌ Ошибка при обновлении клиента:', error);
                clients[currentEditingClientIndex] = updatedClient;
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClientsTable();
                updateSelectOptions();
                showAlert(`❌ Ошибка при обновлении клиента: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        // Товары
        async function addProduct() {
            // Валидация полей товара с новой системой
            const productFields = [
                { id: 'productInternalCode', name: 'Внутренний код', type: 'required' },
                { id: 'productCode', name: 'Код товара', type: 'required' },
                { id: 'productName', name: 'Название товара', type: 'required' },
                { id: 'productPrice', name: 'Цена', type: 'positive_number' },
                { id: 'productCategory', name: 'Категория', type: 'required' }
            ];
            
            const validation = validateForm(productFields);
            if (!validation.isValid) {
                showAlert('Ошибки валидации:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const internalCode = document.getElementById('productInternalCode').value.trim();
            const code = document.getElementById('productCode').value.trim();
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            const subcategory = document.getElementById('productSubcategory').value;
            const weight = parseFloat(document.getElementById('productWeight').value) || 0;
            // Берём значение из видимого поля поиска, чтобы всегда получать название
            const supplier = document.getElementById('productSupplierSearch').value.trim();
            let productClientIndex = document.getElementById('productClient').value;
            
            console.log('=== Привязка товара к клиенту ===');
            console.log('productClientIndex из формы:', productClientIndex);
            
            // Если текущий пользователь - клиент, автоматически привязываем товар к нему
            if (window.currentUser && window.currentUser.userType === 'client') {
                const currentClientMB = window.currentUser.clientMB;
                const currentClient = clients.find(c => c.mb === currentClientMB);
                if (currentClient) {
                    productClientIndex = clients.indexOf(currentClient).toString();
                    console.log(`Автоматически привязываем товар к клиенту: ${currentClient.name} (MB: ${currentClientMB})`);
                }
            }
            
            if (!internalCode || !code || !name || !price || price <= 0) { 
                showAlert('Заполните поля корректно!', 'danger'); 
                return; 
            }
            if (products.find(p => p.internalCode === internalCode)) { 
                showAlert('Внутренний код уже существует!', 'danger'); 
                return; 
            }
            
            const newProduct = { internalCode, code, name, price, category, subcategory, weight, supplier };
            
            // Отправляем на API
            try {
                showLoadingIndicator(true, 'Создание товара...');
                
                const response = await ProductsAPI.create(newProduct);
                
                // Добавляем товар с ID от сервера
                products.push(response.product);
                
                addLog(`Добавлен товар: ${name} (внутренний код: ${internalCode}, код товара: ${code}, вес: ${weight}г)`);

                // Если выбран клиент - логируем привязку (клиентские продукты пока локально)
                console.log('Проверка привязки к клиенту...');
                console.log('productClientIndex:', productClientIndex);
                console.log('productClientIndex !== "":', productClientIndex !== '');
                
                if (productClientIndex !== '' && productClientIndex !== null && productClientIndex !== undefined) {
                    const client = clients[parseInt(productClientIndex, 10)];
                    console.log('Найден клиент:', client);
                    if (client) {
                        const clientMB = client.mb;
                        let clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
                        const existing = clientProducts.find(p => p.clientMB === clientMB && p.internalCode === internalCode);
                        const clientProductName = `${name} чайник 500мл`;
                        const defaultWeight = weight > 0 ? weight : 1;

                        if (existing) {
                            existing.name = clientProductName;
                            existing.weight = defaultWeight;
                            existing.availableForSale = true;
                            existing.updatedAt = new Date().toISOString();
                        } else {
                            clientProducts.push({
                                internalCode: internalCode,
                                code: code,
                                name: clientProductName,
                                weight: defaultWeight,
                                warehouseLink: internalCode,
                                warehouseProduct: null,
                                createdAt: new Date().toISOString(),
                                clientMB: clientMB,
                                availableForSale: true,
                                maxQuantity: 0,
                                type: 'clientProduct'
                            });
                        }
                        localStorage.setItem('clientProducts', JSON.stringify(clientProducts));
                        console.log('✅ Товар привязан к клиенту:', client.name);
                        console.log('Сохранено в clientProducts:', clientProducts.filter(p => p.internalCode === internalCode));
                        addLog(`Товар ${code} назначен клиенту ${client.name} (MB ${clientMB})`);
                    }
                } else {
                    console.log('⚠️ Клиент не выбран, товар создан как общий');
                }

                clearProductForm(); 
                loadProductSubcategoryFilter();
                renderProductsTable();
                updateSelectOptions();
                showAlert('Товар успешно создан!', 'success');
                
                console.log('✅ Product created:', response.product);
                
            } catch (error) {
                console.error('❌ Failed to create product:', error);
                
                // Fallback: сохраняем локально
                newProduct.id = Date.now().toString();
                products.push(newProduct);
                
                // Если выбран клиент - привязываем товар (fallback)
                if (productClientIndex !== '' && productClientIndex !== null && productClientIndex !== undefined) {
                    const client = clients[parseInt(productClientIndex, 10)];
                    if (client) {
                        const clientMB = client.mb;
                        let clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
                        const existing = clientProducts.find(p => p.clientMB === clientMB && p.internalCode === internalCode);
                        const clientProductName = `${name} чайник 500мл`;
                        const defaultWeight = weight > 0 ? weight : 1;

                        if (existing) {
                            existing.name = clientProductName;
                            existing.weight = defaultWeight;
                            existing.availableForSale = true;
                            existing.updatedAt = new Date().toISOString();
                        } else {
                            clientProducts.push({
                                internalCode: internalCode,
                                code: code,
                                name: clientProductName,
                                weight: defaultWeight,
                                warehouseLink: internalCode,
                                warehouseProduct: null,
                                createdAt: new Date().toISOString(),
                                clientMB: clientMB,
                                availableForSale: true,
                                maxQuantity: 0,
                                type: 'clientProduct'
                            });
                        }
                        localStorage.setItem('clientProducts', JSON.stringify(clientProducts));
                        console.log('✅ Товар привязан к клиенту (fallback):', client.name);
                        addLog(`Товар ${code} назначен клиенту ${client.name} (MB ${clientMB})`);
                    }
                }
                
                clearProductForm(); 
                renderProductsTable();
                updateSelectOptions();
                
                showAlert(`❌ Ошибка при создании товара: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        function clearProductForm() {
            ['productInternalCode', 'productCode', 'productName', 'productPrice', 'productCategory', 'productSubcategory', 'productWeight', 'productSupplier'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Очищаем поле выбора клиента
            const productClientSearch = document.getElementById('productClientSearch');
            const productClient = document.getElementById('productClient');
            if (productClientSearch) productClientSearch.value = '';
            if (productClient) productClient.value = '';
            
            // Очищаем поле выбора поставщика
            const productSupplierSearch = document.getElementById('productSupplierSearch');
            if (productSupplierSearch) productSupplierSearch.value = '';
            
            // Сбрасываем субкатегорию
            const subcategorySelect = document.getElementById('productSubcategory');
            if (subcategorySelect) subcategorySelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
            
            // Сбрасываем подсветку полей
            resetFieldHighlighting(document.getElementById('products'));
        }

        async function deleteProduct(index) {
            const product = products[index];
            
            // Показываем модальное окно
            const details = `
                <strong>Информация о товаре:</strong>
                <div>📦 Название: ${product.name}</div>
                <div>🔢 Код: ${product.code || '-'}</div>
                <div>🔑 Внутренний код: ${product.internalCode || '-'}</div>
                <div>💰 Цена: ${product.price || 0} RSD</div>
                <div>💼 ID в базе: ${product.id || 'нет'} (${typeof product.id})</div>
            `;
            
            showDeleteConfirmModal(
                `Вы уверены, что хотите удалить товар "${product.name}"?`,
                details,
                async () => {
                    await performProductDelete(index, product);
                }
            );
        }
        
        async function performProductDelete(index, product) {
            console.log('🗑️ performProductDelete для:', product.name);
            
            try {
                showLoadingIndicator(true, 'Удаление товара...');
                
                // Удаляем через API если есть ID
                if (product.id) {
                    console.log('🗑️ Вызываем ProductsAPI.delete с id:', product.id);
                    await ProductsAPI.delete(product.id);
                    console.log('✅ ProductsAPI.delete успешно выполнен');
                }
                
                // Удаляем из локального массива
                products.splice(index, 1); 
                
                // Сохраняем в localStorage
                localStorage.setItem('products', JSON.stringify(products));
                
                renderProductsTable();
                updateSelectOptions();
                showAlert('Товар успешно удален!', 'success');
                
                console.log('✅ Product deleted:', product.name);
                
            } catch (error) {
                console.error('❌ Failed to delete product:', error);
                console.error('❌ Error details:', error.message, error.stack);
                
                // Fallback: удаляем локально даже если API недоступен
                products.splice(index, 1);
                localStorage.setItem('products', JSON.stringify(products));
                renderProductsTable();
                updateSelectOptions();
                
                showAlert(`Товар удален локально (ошибка API: ${error.message})`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        let currentEditingProductIndex = null;

        async function editProduct(index) {
            const product = products[index];
            if (!product) return;

            currentEditingProductIndex = index;

            // Заполняем форму данными товара
            document.getElementById('editProductInternalCode').value = product.internalCode || '';
            document.getElementById('editProductCode').value = product.code || '';
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductPrice').value = product.price || '';
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductWeight').value = product.weight || '';
            document.getElementById('editProductSupplier').value = product.supplier || '';
            document.getElementById('editProductSupplierSearch').value = product.supplier || '';
            
            // Загружаем субкатегории для выбранной категории
            if (product.category) {
                await updateSubcategoryOptions('editProductSubcategory', product.category);
                // Устанавливаем значение субкатегории после загрузки списка
                setTimeout(() => {
                    const subcategorySelect = document.getElementById('editProductSubcategory');
                    if (subcategorySelect && product.subcategory) {
                        subcategorySelect.value = product.subcategory;
                    }
                }, 100);
            } else {
                const subcategorySelect = document.getElementById('editProductSubcategory');
                if (subcategorySelect) {
                    subcategorySelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
                }
            }
            
            // Заполняем поле клиента
            const editProductClientSearch = document.getElementById('editProductClientSearch');
            const editProductClient = document.getElementById('editProductClient');
            
            if (product.clientId && clients.length > 0) {
                const client = clients.find(c => c.id == product.clientId);
                if (client) {
                    editProductClientSearch.value = client.name;
                    editProductClient.value = product.clientId;
                } else {
                    editProductClientSearch.value = '';
                    editProductClient.value = '';
                }
            } else {
                editProductClientSearch.value = '';
                editProductClient.value = '';
            }
            
            // Инициализируем выпадающий список клиентов для редактирования
            initEditProductClientDropdown();

            // Показываем модальное окно
            document.getElementById('editProductModal').style.display = 'block';
            addLog(`Открыто редактирование товара: ${product.name}`);
        }
        
        // Инициализация выпадающего списка клиентов для модального окна редактирования товара
        function initEditProductClientDropdown() {
            const searchInput = document.getElementById('editProductClientSearch');
            const hiddenInput = document.getElementById('editProductClient');
            const dropdown = document.getElementById('editProductClientDropdown');
            
            if (!searchInput || !dropdown) return;
            
            // Удаляем старые обработчики если есть
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Показ списка при клике
            newSearchInput.addEventListener('click', () => {
                renderEditProductClientDropdown('');
                dropdown.style.display = 'block';
            });
            
            // Фильтрация при вводе
            newSearchInput.addEventListener('input', (e) => {
                renderEditProductClientDropdown(e.target.value);
                dropdown.style.display = 'block';
            });
            
            // Скрытие списка при клике вне
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#editProductClientSearch') && !e.target.closest('#editProductClientDropdown')) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        // Рендер выпадающего списка клиентов для редактирования товара
        function renderEditProductClientDropdown(filter) {
            const dropdown = document.getElementById('editProductClientDropdown');
            const hiddenInput = document.getElementById('editProductClient');
            const searchInput = document.getElementById('editProductClientSearch');
            
            if (!dropdown) return;
            
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(filter.toLowerCase())
            );
            
            // Добавляем опцию "Без клиента"
            let html = `<div class="dropdown-item" data-value="" data-name="">— Без клиента —</div>`;
            
            filteredClients.forEach(client => {
                html += `<div class="dropdown-item" data-value="${client.id}" data-name="${client.name}">${client.name}</div>`;
            });
            
            dropdown.innerHTML = html;
            
            // Обработчики кликов
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const newSearchInput = document.getElementById('editProductClientSearch');
                    newSearchInput.value = item.dataset.name;
                    hiddenInput.value = item.dataset.value;
                    dropdown.style.display = 'none';
                });
            });
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            currentEditingProductIndex = null;
        }

        async function saveProductChanges() {
            if (currentEditingProductIndex === null) return;

            // Валидируем обязательные поля в модальном окне
            const editProductModal = document.getElementById('editProductModal');
            if (!validateRequiredFields(editProductModal)) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const internalCode = document.getElementById('editProductInternalCode').value.trim();
            const code = document.getElementById('editProductCode').value.trim();
            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const category = document.getElementById('editProductCategory').value;
            const subcategory = document.getElementById('editProductSubcategory').value;
            const weight = parseFloat(document.getElementById('editProductWeight').value) || 0;
            // Берём значение из видимого поля поиска, чтобы всегда получать название
            const supplier = document.getElementById('editProductSupplierSearch').value.trim();
            const clientId = document.getElementById('editProductClient').value;

            if (!internalCode || !code || !name || !price || price <= 0) {
                showAlert('Заполните все обязательные поля корректно!', 'danger');
                return;
            }

            // Проверяем, не занят ли внутренний код другим товаром
            const existingProduct = products.find((p, idx) => p.internalCode === internalCode && idx !== currentEditingProductIndex);
            if (existingProduct) {
                showAlert('Товар с таким внутренним кодом уже существует!', 'danger');
                return;
            }

            const oldProduct = products[currentEditingProductIndex];
            const oldCode = oldProduct.code;
            const oldName = oldProduct.name;
            const oldClientId = oldProduct.clientId;

            // Обновляем товар
            const updatedProduct = {
                ...oldProduct,
                internalCode,
                code,
                name,
                price,
                category,
                subcategory,
                weight,
                supplier,
                clientId: clientId || null
            };
            
            // Если изменился клиент, обновляем clientProducts
            if (oldClientId !== clientId) {
                const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
                
                // Удаляем из старого клиента
                if (oldClientId) {
                    const oldIndex = clientProducts.findIndex(cp => cp.warehouseLink === internalCode);
                    if (oldIndex !== -1) {
                        clientProducts.splice(oldIndex, 1);
                    }
                }
                
                // Добавляем к новому клиенту
                if (clientId) {
                    const client = clients.find(c => c.id == clientId);
                    if (client) {
                        clientProducts.push({
                            internalCode: `CP-${Date.now()}`,
                            name: name,
                            weight: weight,
                            clientId: clientId,
                            clientName: client.name,
                            warehouseLink: internalCode
                        });
                    }
                }
                
                localStorage.setItem('clientProducts', JSON.stringify(clientProducts));
            }

            // Отправляем на API
            try {
                showLoadingIndicator(true, 'Обновление товара...');
                
                if (oldProduct.id) {
                    const response = await ProductsAPI.update(oldProduct.id, updatedProduct);
                    products[currentEditingProductIndex] = response.product; // Обновляем данными от сервера
                } else {
                    products[currentEditingProductIndex] = updatedProduct;
                    console.warn('⚠️ Product has no ID, saving locally only');
                }
                
                // Сохраняем в localStorage для fallback
            localStorage.setItem('products', JSON.stringify(products));

            // Обновляем интерфейс
            renderProductsTable();
            updateSelectOptions();
            closeEditProductModal();

            addLog(`Обновлен товар: ${oldName} (${oldCode}) → ${name} (${code})`);
            showAlert('Товар успешно обновлен!', 'success');
                
            } catch (error) {
                console.error('❌ Failed to update product:', error);
                
                // Fallback: сохраняем локально
                products[currentEditingProductIndex] = updatedProduct;
                localStorage.setItem('products', JSON.stringify(products));
                renderProductsTable();
                updateSelectOptions();
                closeEditProductModal();
                
                showAlert(`⚠️ Товар обновлен локально (ошибка API: ${error.message})`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        // Функция для определения к какому пользователю привязан товар
        function getProductUser(productInternalCode) {
            // Загружаем клиентские товары
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            
            // Ищем клиентский товар, который связан с данным системным товаром через warehouseLink (внутренний код)
            const linkedClientProduct = clientProducts.find(cp => cp.warehouseLink === productInternalCode);
            
            if (linkedClientProduct) {
                // Находим клиента по MB
                const client = clients.find(c => c.mb === linkedClientProduct.clientMB);
                if (client) {
                    return client.name;
                }
            }
            
            return 'Общий';
        }

        // Функции модального окна редактирования товара клиента
        function openEditProductModal(productInternalCode) {
            console.log('Открываем модальное окно редактирования для товара:', productInternalCode);
            
            // Находим товар в clientProducts
            const clientProduct = window.clientProducts?.find(p => p.internalCode === productInternalCode);
            if (!clientProduct) {
                showAlert('Товар не найден для редактирования.', 'danger');
                return;
            }
            
            // Заполняем поля модального окна
            document.getElementById('clientEditProductName').value = clientProduct.name || '';
            document.getElementById('clientEditProductWeight').value = clientProduct.weight || '';
            document.getElementById('clientEditProductInternalCode').value = productInternalCode;
            
            // Показываем модальное окно
            document.getElementById('clientEditProductModal').style.display = 'block';
        }

        function closeClientEditProductModal() {
            document.getElementById('clientEditProductModal').style.display = 'none';
            // Очищаем поля формы
            document.getElementById('clientEditProductName').value = '';
            document.getElementById('clientEditProductWeight').value = '';
            document.getElementById('clientEditProductInternalCode').value = '';
        }

        function saveClientProductChanges() {
            console.log('=== НАЧАЛО СОХРАНЕНИЯ ИЗМЕНЕНИЙ ТОВАРА ===');
            
            const internalCode = document.getElementById('clientEditProductInternalCode').value;
            const newName = document.getElementById('clientEditProductName').value.trim();
            const newWeight = parseFloat(document.getElementById('clientEditProductWeight').value);
            
            console.log('Данные из формы:', {internalCode, newName, newWeight});
            console.log('Текущие clientProducts:', window.clientProducts);
            
            // Валидация
            if (!newName) {
                console.log('❌ Ошибка валидации: пустое название');
                showAlert('Название товара обязательно для заполнения.', 'danger');
                return;
            }
            
            if (!newWeight || newWeight <= 0) {
                console.log('❌ Ошибка валидации: неверный вес');
                showAlert('Вес должен быть положительным числом.', 'danger');
                return;
            }
            
            // Находим товар для редактирования
            const clientProductIndex = window.clientProducts?.findIndex(p => p.internalCode === internalCode);
            console.log('Поиск товара:', {internalCode, clientProductIndex, clientProductsLength: window.clientProducts?.length});
            
            if (clientProductIndex === -1) {
                console.log('❌ Товар не найден для обновления');
                showAlert('Товар не найден для обновления.', 'danger');
                return;
            }
            
            const oldProduct = window.clientProducts[clientProductIndex];
            const oldWeight = oldProduct.weight;
            const oldName = oldProduct.name;
            
            console.log('Старые данные товара:', {oldName, oldWeight});
            console.log('Новые данные товара:', {newName, newWeight});
            
            // Обновляем товар в clientProducts
            window.clientProducts[clientProductIndex].name = newName;
            window.clientProducts[clientProductIndex].weight = newWeight;
            
            console.log('✅ Товар обновлен в памяти:', window.clientProducts[clientProductIndex]);
            
            // Сохраняем в localStorage
            console.log('Сохраняем в localStorage...');
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            
            // Проверяем, что сохранилось
            const savedData = localStorage.getItem('clientProducts');
            const parsedSaved = JSON.parse(savedData);
            const savedProduct = parsedSaved.find(p => p.internalCode === internalCode);
            console.log('Проверка сохранения в localStorage:', savedProduct);
            
            // Также обновляем в основном массиве products если товар там есть
            const mainProductIndex = products.findIndex(p => p.internalCode === internalCode);
            console.log('Поиск в основном массиве products:', {mainProductIndex, productsLength: products?.length});
            if (mainProductIndex !== -1) {
                console.log('Обновляем товар в основном массиве products');
                products[mainProductIndex].name = newName;
                products[mainProductIndex].weight = newWeight;
                localStorage.setItem('products', JSON.stringify(products));
                console.log('✅ Товар обновлен в основном массиве products');
            }
            
            // Обновляем расчеты склада если вес изменился
            if (oldWeight !== newWeight) {
                console.log('Вес изменился, обновляем складские расчеты...');
                updateWarehouseCalculationsForWeightChange(internalCode, oldWeight, newWeight);
            }
            
            // Обновляем интерфейс
            console.log('Обновляем интерфейс...');
            loadSalesProducts();
            closeClientEditProductModal();
            
            console.log(`✅ ТОВАР УСПЕШНО ОБНОВЛЕН: ${oldName} (${oldWeight}г) → ${newName} (${newWeight}г)`);
            console.log('=== КОНЕЦ СОХРАНЕНИЯ ИЗМЕНЕНИЙ ТОВАРА ===');
            showAlert('Товар успешно обновлен!', 'success');
        }

        // Функции для работы с запасами чая
        function openTeaStockModal(category) {
            console.log('Открываем модальное окно для категории:', category);
            
            // Устанавливаем категорию
            document.getElementById('teaStockCategory').value = category;
            document.getElementById('teaStockModalTitle').textContent = `Пополнить запас: ${category === 'Crni Čaj' ? 'Черный чай' : 'Зеленый чай'}`;
            
            // Получаем текущий запас
            const currentStock = getTeaStockByCategory(category);
            document.getElementById('teaStockCurrent').value = `${currentStock} г`;
            
            // Очищаем поля ввода
            document.getElementById('teaStockAmount').value = '';
            document.getElementById('teaStockComment').value = '';
            
            // Показываем модальное окно
            document.getElementById('teaStockModal').style.display = 'block';
        }

        function closeTeaStockModal() {
            document.getElementById('teaStockModal').style.display = 'none';
        }

        async function addTeaStock() {
            const category = document.getElementById('teaStockCategory').value;
            const amount = parseFloat(document.getElementById('teaStockAmount').value);
            const comment = document.getElementById('teaStockComment').value.trim();
            
            // Валидация
            if (!amount || amount <= 0) {
                showAlert('Введите корректное количество для добавления.', 'danger');
                return;
            }
            
            // Получаем текущие запасы
            let teaStocks = safeLocalStorage('get', 'teaStocks') || {
                'Crni Čaj': 0,
                'Zeleni Čaj': 0
            };
            
            // Добавляем к запасу
            teaStocks[category] = (teaStocks[category] || 0) + amount;
            
            // Сохраняем
            safeLocalStorage('set', 'teaStocks', teaStocks);
            
            // Логируем операцию
            const logEntry = {
                date: new Date().toISOString(),
                category: category,
                operation: 'add',
                amount: amount,
                comment: comment || 'Пополнение запаса',
                newTotal: teaStocks[category]
            };
            
            let stockLogs = safeLocalStorage('get', 'teaStockLogs') || [];
            stockLogs.push(logEntry);
            safeLocalStorage('set', 'teaStockLogs', stockLogs);
            
            // Обновляем отображение
            updateTeaStockDisplay();
            
            // Закрываем модальное окно
            closeTeaStockModal();
            
            showAlert(`Запас ${category === 'Crni Čaj' ? 'черного' : 'зеленого'} чая пополнен на ${amount}г`, 'success');
            
            console.log('Запас чая обновлен:', teaStocks);
        }

        function getTeaStockByCategory(category) {
            const teaStocks = safeLocalStorage('get', 'teaStocks') || {
                'Crni Čaj': 0,
                'Zeleni Čaj': 0
            };
            return teaStocks[category] || 0;
        }

        function updateTeaStockDisplay() {
            console.log('🔄 Обновляем отображение запасов чая...');
            
            const blackTeaStock = getTeaStockByCategory('Crni Čaj');
            const greenTeaStock = getTeaStockByCategory('Zeleni Čaj');
            
            console.log(`📊 Запасы для отображения: Черный чай=${blackTeaStock}г, Зеленый чай=${greenTeaStock}г`);
            
            const blackTeaElement = document.getElementById('blackTeaStock');
            const greenTeaElement = document.getElementById('greenTeaStock');
            
            if (blackTeaElement) {
                const formattedBlack = blackTeaStock.toLocaleString();
                blackTeaElement.textContent = formattedBlack;
                console.log(`✅ Обновлен виджет черного чая: ${formattedBlack}`);
            } else {
                console.log('❌ Элемент blackTeaStock не найден');
            }
            
            if (greenTeaElement) {
                const formattedGreen = greenTeaStock.toLocaleString();
                greenTeaElement.textContent = formattedGreen;
                console.log(`✅ Обновлен виджет зеленого чая: ${formattedGreen}`);
            } else {
                console.log('❌ Элемент greenTeaStock не найден');
            }
            
            console.log('✅ Отображение запасов чая обновлено');
        }

        function reduceTeaStockOnSale(category, weight) {
            console.log(`🔄 Уменьшаем запас ${category} на ${weight}г`);
            
            let teaStocks = safeLocalStorage('get', 'teaStocks') || {
                'Crni Čaj': 0,
                'Zeleni Čaj': 0
            };
            
            console.log(`📊 Текущие запасы до списания:`, teaStocks);
            console.log(`📊 Запас ${category} до списания: ${teaStocks[category] || 0}г`);
            
            // Уменьшаем запас
            const oldStock = teaStocks[category] || 0;
            teaStocks[category] = Math.max(0, oldStock - weight);
            
            console.log(`📊 Запас ${category} после списания: ${teaStocks[category]}г (было ${oldStock}г, списано ${weight}г)`);
            
            // Сохраняем
            safeLocalStorage('set', 'teaStocks', teaStocks);
            console.log(`💾 Запасы сохранены в localStorage`);
            
            // Логируем операцию
            const logEntry = {
                date: new Date().toISOString(),
                category: category,
                operation: 'sale',
                amount: -weight,
                comment: 'Продажа товара',
                newTotal: teaStocks[category]
            };
            
            let stockLogs = safeLocalStorage('get', 'teaStockLogs') || [];
            stockLogs.push(logEntry);
            safeLocalStorage('set', 'teaStockLogs', stockLogs);
            console.log(`📝 Операция записана в лог:`, logEntry);
            
            // Обновляем отображение
            console.log(`🔄 Обновляем отображение виджетов...`);
            updateTeaStockDisplay();
            
            console.log('✅ Запас чая успешно обновлен:', teaStocks);
        }

        function updateTeaStocksOnSale(saleItems) {
            console.log('=== ОБНОВЛЕНИЕ ЗАПАСОВ ЧАЯ ПРИ ПРОДАЖЕ ===');
            console.log('Полученные saleItems:', saleItems);
            console.log('Массив products содержит товаров:', products?.length || 0);
            
            if (!products || products.length === 0) {
                console.log('❌ Массив products пуст или не загружен, загружаем из localStorage...');
                products = safeLocalStorage('get', 'products') || [];
                console.log('📦 Загружено товаров из localStorage:', products.length);
            }
            
            saleItems.forEach(item => {
                console.log(`Обрабатываем товар: код=${item.code}, название=${item.name}, общий вес=${item.totalWeight}г`);
                
                // Находим товар в основном массиве products для получения категории
                // Пробуем найти по internalCode (который в saleItems называется code)
                let product = products.find(p => p.internalCode === item.code);
                
                // Если не нашли по internalCode, пробуем найти по обычному коду
                if (!product) {
                    product = products.find(p => p.code === item.code);
                }
                
                // Если все еще не нашли, пробуем найти по названию
                if (!product) {
                    product = products.find(p => p.name === item.name);
                }
                
                if (!product) {
                    console.log(`❌ Товар ${item.code} (${item.name}) не найден в основном массиве products`);
                    console.log('Доступные товары в products:', products.map(p => ({code: p.code, internalCode: p.internalCode, name: p.name, category: p.category})));
                    return;
                }
                
                console.log(`✅ Найден товар: ${product.name}, категория: ${product.category}, вес для списания: ${item.totalWeight}г`);
                
                // Проверяем категорию и уменьшаем соответствующий запас
                if (product.category === 'Crni Čaj') {
                    console.log(`📉 Уменьшаем запас черного чая на ${item.totalWeight}г`);
                    reduceTeaStockOnSale('Crni Čaj', item.totalWeight);
                } else if (product.category === 'Zeleni Čaj') {
                    console.log(`📉 Уменьшаем запас зеленого чая на ${item.totalWeight}г`);
                    reduceTeaStockOnSale('Zeleni Čaj', item.totalWeight);
                } else {
                    console.log(`ℹ️ Товар ${product.name} не относится к категориям чая (категория: ${product.category})`);
                }
            });
            
            console.log('=== ЗАПАСЫ ЧАЯ ОБНОВЛЕНЫ ===');
        }

        function updateTeaStocksOnInvoiceApproval(invoiceItems) {
            console.log('=== ОБНОВЛЕНИЕ ЗАПАСОВ ЧАЯ ПРИ УТВЕРЖДЕНИИ ИНВОЙСА ===');
            console.log('Товары из инвойса:', invoiceItems);
            console.log('Массив products содержит товаров:', products?.length || 0);
            
            if (!products || products.length === 0) {
                console.log('❌ Массив products пуст или не загружен, загружаем из localStorage...');
                products = safeLocalStorage('get', 'products') || [];
                console.log('📦 Загружено товаров из localStorage:', products.length);
            }
            
            invoiceItems.forEach(item => {
                console.log(`Обрабатываем товар из инвойса: ${item.product?.name || item.name}, количество: ${item.quantity}`);
                
                // Получаем товар из инвойса
                const invoiceProduct = item.product;
                if (!invoiceProduct) {
                    console.log('❌ Нет данных о товаре в позиции инвойса');
                    return;
                }
                
                // Находим товар в основном массиве products для получения категории
                let product = products.find(p => p.internalCode === invoiceProduct.internalCode);
                
                if (!product) {
                    product = products.find(p => p.code === invoiceProduct.code);
                }
                
                if (!product) {
                    product = products.find(p => p.name === invoiceProduct.name);
                }
                
                if (!product) {
                    console.log(`❌ Товар ${invoiceProduct.name} не найден в основном массиве products`);
                    return;
                }
                
                // Вычисляем общий вес для списания
                const totalWeight = item.quantity * (invoiceProduct.weight || 0);
                
                console.log(`✅ Найден товар: ${product.name}, категория: ${product.category}, вес для списания: ${totalWeight}г (${item.quantity} × ${invoiceProduct.weight}г)`);
                
                // Проверяем категорию и уменьшаем соответствующий запас
                if (product.category === 'Crni Čaj') {
                    console.log(`📉 Уменьшаем запас черного чая на ${totalWeight}г`);
                    reduceTeaStockOnSale('Crni Čaj', totalWeight);
                } else if (product.category === 'Zeleni Čaj') {
                    console.log(`📉 Уменьшаем запас зеленого чая на ${totalWeight}г`);
                    reduceTeaStockOnSale('Zeleni Čaj', totalWeight);
                } else {
                    console.log(`ℹ️ Товар ${product.name} не относится к категориям чая (категория: ${product.category})`);
                }
            });
            
            console.log('=== ЗАПАСЫ ЧАЯ ОБНОВЛЕНЫ ПРИ УТВЕРЖДЕНИИ ИНВОЙСА ===');
        }

        // Функции для работы с рачунами
        function createRacunFromPredracun() {
            console.log('Создание рачуна по предрачуну');
            
            // Открываем модальное окно загрузки предрачуна
            openUploadPredracunModal();
        }

        function openUploadPredracunModal() {
            document.getElementById('uploadPredracunModal').style.display = 'block';
            
            // Настраиваем обработчик загрузки файла
            const fileInput = document.getElementById('predracunFileInput');
            fileInput.addEventListener('change', handlePredracunFileUpload);
        }

        function closeUploadPredracunModal() {
            document.getElementById('uploadPredracunModal').style.display = 'none';
            
            // Очищаем данные
            document.getElementById('predracunFileInput').value = '';
            document.getElementById('predracunPreview').style.display = 'none';
            document.getElementById('extractedData').style.display = 'none';
            document.getElementById('generateRacunFromPredracun').style.display = 'none';
        }

        // Функция для обновления информации об оплате (просто для логирования)
        function updatePaymentInfo() {
            const paymentAmount = parseFloat(document.getElementById('predracunPayment').value) || 0;
            console.log('Сумма оплаты обновлена:', paymentAmount);
        }

        function handlePredracunFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                // Если файл не выбран, скрываем кнопку
                document.getElementById('generateRacunFromPredracun').style.display = 'none';
                return;
            }
            
            console.log('Загружен файл:', file.name, file.type);
            
            const reader = new FileReader();
            
            if (file.type === 'text/html' || file.name.toLowerCase().endsWith('.html')) {
                reader.onload = function(e) {
                    const htmlContent = e.target.result;
                    displayPredracunPreview(htmlContent, 'html');
                    extractDataFromHTML(htmlContent);
                };
                reader.readAsText(file);
            } else if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                reader.onload = function(e) {
                    const pdfData = e.target.result;
                    displayPredracunPreview(pdfData, 'pdf');
                    // Пытаемся извлечь текст из PDF
                    extractTextFromPDF(pdfData);
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('image/')) {
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    displayPredracunPreview(imageUrl, 'image');
                    // Для изображений показываем форму ручного ввода
                    showManualDataEntry();
                };
                reader.readAsDataURL(file);
            } else {
                showAlert('Поддерживаются HTML, PDF файлы и изображения', 'warning');
                // Для неподдерживаемых файлов скрываем кнопку
                document.getElementById('generateRacunFromPredracun').style.display = 'none';
            }
        }

        function displayPredracunPreview(content, type) {
            const previewDiv = document.getElementById('predracunPreview');
            const contentDiv = document.getElementById('predracunContent');
            
            if (type === 'html') {
                contentDiv.innerHTML = content;
            } else if (type === 'pdf') {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; border: 2px dashed #dee2e6; border-radius: 8px; background: #f8f9fa;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📄</div>
                        <h4 style="margin: 0 0 10px 0; color: #212529;">PDF файл загружен</h4>
                        <p style="margin: 0; color: #666;">Для создания рачуна введите данные в форму ниже</p>
                        <embed src="${content}" type="application/pdf" width="100%" height="400px" style="margin-top: 15px; border-radius: 4px;" />
                    </div>
                `;
            } else if (type === 'image') {
                contentDiv.innerHTML = `<img src="${content}" style="max-width: 100%; height: auto;" alt="Предрачун">`;
            }
            
            previewDiv.style.display = 'block';
        }

        function extractDataFromHTML(htmlContent) {
            console.log('Извлечение данных из HTML');
            
            // Создаем временный DOM элемент для парсинга
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Пытаемся извлечь данные клиента и товары
            const extractedData = {
                client: extractClientFromHTML(tempDiv),
                items: extractItemsFromHTML(tempDiv)
            };
            
            console.log('Извлеченные данные:', extractedData);
            
            if (extractedData.client || extractedData.items.length > 0) {
                displayExtractedData(extractedData);
            } else {
                // Если автоматическое извлечение не удалось, показываем форму ручного ввода
                showManualDataEntry();
                showAlert('Автоматическое извлечение данных не удалось. Введите данные вручную.', 'info');
            }
            
            // В любом случае показываем кнопку, так как файл загружен
            document.getElementById('generateRacunFromPredracun').style.display = 'inline-block';
        }

        function extractClientFromHTML(dom) {
            // Ищем информацию о клиенте в различных местах HTML
            const clientSelectors = [
                'h4:contains("Poručioc")',
                '.client-info',
                '[class*="client"]',
                'p:contains("Matični broj")'
            ];
            
            // Простой поиск по тексту
            const textContent = dom.textContent || dom.innerText || '';
            const lines = textContent.split('\n').map(line => line.trim()).filter(line => line);
            
            for (let line of lines) {
                if (line.includes('Matični broj:') || line.includes('МБ:')) {
                    const mbMatch = line.match(/(\d{8})/);
                    if (mbMatch) {
                        return `Клиент (МБ: ${mbMatch[1]})`;
                    }
                }
            }
            
            return 'Клиент не определен';
        }

        function extractItemsFromHTML(dom) {
            const items = [];
            
            // Ищем таблицы с товарами
            const tables = dom.querySelectorAll('table');
            
            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const text = Array.from(cells).map(cell => cell.textContent.trim());
                        
                        // Пытаемся найти паттерн: название товара, количество, цена
                        const quantityMatch = text.find(t => /^\d+$/.test(t));
                        const priceMatch = text.find(t => /\d+[.,]\d+.*RSD/.test(t));
                        
                        if (quantityMatch && priceMatch) {
                            items.push({
                                name: text[0] || 'Товар',
                                quantity: parseInt(quantityMatch),
                                price: priceMatch
                            });
                        }
                    }
                }
            }
            
            return items;
        }

        function extractTextFromPDF(pdfData) {
            console.log('Извлечение текста из PDF');
            
            // Настраиваем PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Загружаем PDF
                pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                    console.log('PDF загружен, страниц:', pdf.numPages);
                    
                    let extractedText = '';
                    let pagesProcessed = 0;
                    
                    // Обрабатываем первые 3 страницы (обычно достаточно для предрачуна)
                    const maxPages = Math.min(pdf.numPages, 3);
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        pdf.getPage(pageNum).then(function(page) {
                            page.getTextContent().then(function(textContent) {
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                extractedText += pageText + '\n';
                                pagesProcessed++;
                                
                                // Когда все страницы обработаны
                                if (pagesProcessed === maxPages) {
                                    console.log('Извлеченный текст из PDF:', extractedText);
                                    processPDFText(extractedText);
                                }
                            });
                        });
                    }
                }).catch(function(error) {
                    console.error('Ошибка при обработке PDF:', error);
                    showAlert('Не удалось обработать PDF файл. Введите данные вручную.', 'warning');
                    showManualDataEntry();
                });
            } else {
                console.warn('PDF.js не загружен, показываем форму ручного ввода');
                showManualDataEntry();
            }
        }

        function processPDFText(text) {
            console.log('Обработка текста из PDF');
            
            // Пытаемся извлечь данные из текста
            const extractedData = {
                client: extractClientFromText(text),
                items: extractItemsFromText(text)
            };
            
            console.log('Извлеченные данные из PDF:', extractedData);
            
            if (extractedData.client || extractedData.items.length > 0) {
                displayExtractedData(extractedData);
            } else {
                // Если автоматическое извлечение не удалось, показываем форму ручного ввода
                showManualDataEntry();
                showAlert('Автоматическое извлечение данных из PDF не удалось. Введите данные вручную.', 'info');
            }
            
            // В любом случае показываем кнопку
            document.getElementById('generateRacunFromPredracun').style.display = 'inline-block';
        }

        function extractClientFromText(text) {
            console.log('Извлечение клиента из текста PDF');
            
            // Ищем матичный брой (8 цифр)
            const mbMatch = text.match(/(?:Matični broj|МБ|MB)[\s:]*(\d{8})/i);
            if (mbMatch) {
                return `Клиент (МБ: ${mbMatch[1]})`;
            }
            
            // Ищем PIB
            const pibMatch = text.match(/(?:PIB|ПИБ)[\s:]*(\d{9})/i);
            if (pibMatch) {
                return `Клиент (ПИБ: ${pibMatch[1]})`;
            }
            
            // Ищем название компании (обычно в начале или после "Poručioc")
            const companyMatch = text.match(/(?:Poručioc|Купац|Клиент)[\s:]*([^\n]+)/i);
            if (companyMatch) {
                return companyMatch[1].trim();
            }
            
            return 'Клиент не определен';
        }

        function extractItemsFromText(text) {
            console.log('Извлечение товаров из текста PDF');
            
            const items = [];
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Ищем строки с товарами (содержат цифры и RSD)
                if (line.includes('RSD') && /\d+/.test(line)) {
                    // Пытаемся найти паттерн: название товара, количество, цена
                    const parts = line.split(/\s+/);
                    
                    // Ищем количество (обычно целое число)
                    const quantityMatch = parts.find(part => /^\d+$/.test(part));
                    
                    // Ищем цену (число с RSD)
                    const priceMatch = parts.find(part => /\d+[.,]\d+.*RSD/i.test(part));
                    
                    if (quantityMatch && priceMatch) {
                        // Название товара - все что до количества
                        const quantityIndex = parts.indexOf(quantityMatch);
                        const name = parts.slice(0, quantityIndex).join(' ') || 'Товар';
                        
                        items.push({
                            name: name,
                            quantity: parseInt(quantityMatch),
                            price: priceMatch
                        });
                    }
                }
            }
            
            return items;
        }

        function showManualDataEntry() {
            // Для изображений показываем форму ручного ввода данных
            const extractedDiv = document.getElementById('extractedData');
            extractedDiv.innerHTML = `
                <h4>Введите данные вручную:</h4>
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <div class="form-group">
                        <label>Клиент</label>
                        <input type="text" id="manualClient" placeholder="Название клиента">
                    </div>
                    <div class="form-group">
                        <label>Товары (по одному на строку: название,количество,цена)</label>
                        <textarea id="manualItems" rows="5" placeholder="Earl Grey,2,1850.00&#10;Green Tea,1,2000.00"></textarea>
                    </div>
                </div>
            `;
            extractedDiv.style.display = 'block';
            document.getElementById('generateRacunFromPredracun').style.display = 'inline-block';
        }

        function displayExtractedData(data) {
            document.getElementById('extractedClient').value = data.client;
            
            const itemsDiv = document.getElementById('extractedItems');
            itemsDiv.innerHTML = data.items.map(item => `
                <div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                    <strong>${item.name}</strong><br>
                    Количество: ${item.quantity}, Цена: ${item.price}
                </div>
            `).join('');
            
            document.getElementById('extractedData').style.display = 'block';
        }

        function generateRacun(source) {
            console.log('Генерация рачуна, источник:', source);
            
            if (source === 'products') {
                // Используем товары из формы (аналогично generateInvoice, но с заголовком "Рачун")
                generateInvoiceAsRacun();
            } else if (source === 'predracun') {
                // Используем данные из загруженного предрачуна
                generateRacunFromUploadedPredracun();
            }
        }

        function generateInvoiceAsRacun() {
            // Генерация рачуна из списка товаров
            console.log('=== ГЕНЕРАЦИЯ РАЧУНА ИЗ СПИСКА ТОВАРОВ ===');
            
            const racunFields = [
                { id: 'invoiceNumber', name: 'Номер рачуна', type: 'required' },
                { id: 'invoiceDate', name: 'Дата рачуна', type: 'date' },
                { id: 'invoiceDueDate', name: 'Срок оплаты рачуна', type: 'date' },
                { id: 'invoiceClient', name: 'Клиент', type: 'required' },
                { id: 'invoiceVAT', name: 'НДС', type: 'number' }
            ];
            
            const validation = validateForm(racunFields);
            if (!validation.isValid) {
                showAlert('Ошибки валидации рачуна:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            // Собираем данные товаров для рачуна
            const items = [];
            const invoiceItems = document.querySelectorAll('.invoice-items');
            
            invoiceItems.forEach(item => {
                const productSelect = item.querySelector('.invoice-product');
                const quantityInput = item.querySelector('.invoice-quantity');
                const priceInput = item.querySelector('.invoice-price');
                const amountInput = item.querySelector('.invoice-amount');
                const reservationCheckbox = item.querySelector('.invoice-reservation');
                
                if (productSelect.value !== '') {
                    const product = products[productSelect.value];
                    items.push({
                        product: product,
                        quantity: parseInt(quantityInput.value),
                        price: parseFloat(priceInput.value),
                        amount: parseFloat(amountInput.value),
                        isReservation: reservationCheckbox ? reservationCheckbox.checked : false
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            // Создаем объект рачуна
            console.log('→ Создание объекта рачуна...');
            const racunData = {
                number: document.getElementById('invoiceNumber').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                client: clients.find(c => c.mb === document.getElementById('invoiceClient').value),
                items: items,
                delivery: document.getElementById('invoiceDelivery').value,
                deliveryAddress: '',
                isDifferentDeliveryAddress: false,
                vatRate: parseFloat(document.getElementById('invoiceVAT').value),
                reference: document.getElementById('invoiceReference').value,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').textContent.replace(/[^\d.]/g, '')),
                vatAmount: parseFloat(document.getElementById('invoiceVATAmount').textContent.replace(/[^\d.]/g, '')),
                total: parseFloat(document.getElementById('invoiceTotal').textContent.replace(/[^\d.]/g, '')),
                documentType: 'racun' // ВАЖНО: Тип документа: рачун
            };
            console.log('✓ Объект рачуна создан:', racunData);
            console.log('✓ documentType установлен как:', racunData.documentType);

            // Генерируем HTML рачуна используя общую функцию
            console.log('→ Генерация HTML рачуна...');
            const racunHTML = generateInvoiceHTML(racunData);
            console.log('✓ HTML рачуна сгенерирован');
            
            // Показываем предпросмотр
            document.getElementById('invoiceContent').innerHTML = racunHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            
            // Сохраняем данные для возможного утверждения
            currentInvoiceData = racunData;
            console.log('✓ currentInvoiceData установлен:', currentInvoiceData);
            console.log('✓ currentInvoiceData.documentType:', currentInvoiceData.documentType);
            
            // Обновляем текст кнопки утверждения
            console.log('→ Обновление кнопки утверждения для РАЧУНА...');
            updateConfirmButtonText('racun');
            
            console.log('=== ГЕНЕРАЦИЯ РАЧУНА ЗАВЕРШЕНА ===');
            console.log('Итоговый объект рачуна:', currentInvoiceData);
            showAlert('Рачун сгенерирован! Нажмите "Утвердить рачун" для сохранения.', 'success');
        }

        function generateRacunHTML(racun) {
            // Копируем generateInvoiceHTML, но меняем заголовок на "Рачун"
            let itemsHTML = '';
            racun.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px;">${formatPriceWithCurrencyAndThousands(item.price)}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px; font-weight: bold;">${formatPriceWithCurrencyAndThousands(item.amount)}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <!-- Заголовок с логотипом -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Studentski Trg 4</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">Рачун</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${racun.number}</p>
                            <div style="margin-top: 12px;">
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Date:</strong> ${new Date(racun.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Due Date:</strong> ${new Date(racun.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>Balance Due:</strong> ${formatPriceWithCurrencyAndThousands(racun.total)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Информация о клиенте -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Poručioc:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${(racun.client.legalName || racun.client.name).split(' ')[0]}</p>
                                <p style="margin: 0; font-weight: bold;">${(racun.client.legalName || racun.client.name).split(' ').slice(1).join(' ')}</p>
                                <p style="margin: 0;">Matični broj: ${racun.client.mb}</p>
                                <p style="margin: 0;">PIB: ${racun.client.pib}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Таблица товаров -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Назив артикла</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Количина</th>
                                <th style="padding: 6px; text-align: right; font-size: 10px; font-weight: normal;">Цена</th>
                                <th style="padding: 6px; text-align: right; font-size: 10px; font-weight: normal;">Укупно</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <!-- Итоги -->
                    <div style="text-align: right; margin-bottom: 15px;">
                        <div style="display: inline-block; text-align: right;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>Subtotal:</strong> ${formatPriceWithCurrencyAndThousands(racun.subtotal)}</p>
                            <p style="margin: 2px 0; font-size: 12px;"><strong>PDV (${racun.vatRate}%):</strong> ${formatPriceWithCurrencyAndThousands(racun.vatAmount)}</p>
                            <p style="margin: 6px 0 2px 0; font-size: 14px; font-weight: bold; color: #333;"><strong>Total:</strong> ${formatPriceWithCurrencyAndThousands(racun.total)}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        Овај документ је генерисан електронски и важи без печата и потписа
                    </div>
                </div>
            `;
        }

        function generateRacunFromUploadedPredracun() {
            console.log('Генерация рачуна из загруженного предрачуна');
            
            // Получаем данные из формы
            const clientData = document.getElementById('extractedClient')?.value || 
                              document.getElementById('manualClient')?.value || 'Неизвестный клиент';
            
            let items = [];
            
            // Сначала проверяем ручной ввод
            const manualItems = document.getElementById('manualItems');
            if (manualItems && manualItems.value.trim()) {
                console.log('Используем данные ручного ввода');
                const lines = manualItems.value.split('\n').filter(line => line.trim());
                items = lines.map((line, index) => {
                    const parts = line.split(',').map(p => p.trim());
                    return {
                        product: {
                            code: `IMPORT-${index + 1}`,
                            name: parts[0] || 'Товар',
                            weight: 210 // Значение по умолчанию
                        },
                        quantity: parseInt(parts[1]) || 1,
                        price: parseFloat(parts[2]) || 0,
                        amount: (parseInt(parts[1]) || 1) * (parseFloat(parts[2]) || 0)
                    };
                });
            } else {
                // Если ручного ввода нет, пытаемся использовать автоматически извлеченные данные
                console.log('Используем автоматически извлеченные данные');
                const extractedItemsDiv = document.getElementById('extractedItems');
                if (extractedItemsDiv && extractedItemsDiv.children.length > 0) {
                    // Парсим данные из отображаемых элементов
                    Array.from(extractedItemsDiv.children).forEach((itemDiv, index) => {
                        const text = itemDiv.textContent;
                        const quantityMatch = text.match(/Количество:\s*(\d+)/);
                        const priceMatch = text.match(/Цена:\s*([\d.,]+)/);
                        const nameMatch = itemDiv.querySelector('strong')?.textContent;
                        
                        if (quantityMatch && priceMatch && nameMatch) {
                            const quantity = parseInt(quantityMatch[1]);
                            const price = parseFloat(priceMatch[1].replace(',', '.'));
                            items.push({
                                product: {
                                    code: `AUTO-${index + 1}`,
                                    name: nameMatch,
                                    weight: 210
                                },
                                quantity: quantity,
                                price: price,
                                amount: quantity * price
                            });
                        }
                    });
                }
            }
            
            if (items.length === 0) {
                showAlert('Нет товаров для создания рачуна. Введите данные в форму выше.', 'warning');
                return;
            }
            
            console.log('Товары для рачуна:', items);
            
            // Создаем объект рачуна
            const racunData = {
                number: `RACUN-${Date.now()}`,
                date: new Date().toISOString().split('T')[0],
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +30 дней
                client: {
                    name: clientData,
                    legalName: clientData,
                    mb: '00000000',
                    pib: '000000000'
                },
                items: items,
                subtotal: items.reduce((sum, item) => sum + item.amount, 0),
                vatRate: 20,
                vatAmount: items.reduce((sum, item) => sum + item.amount, 0) * 0.2,
                total: items.reduce((sum, item) => sum + item.amount, 0) * 1.2
            };
            
            // Генерируем HTML рачуна
            const racunHTML = generateRacunHTML(racunData);
            
            // Закрываем модальное окно
            closeUploadPredracunModal();
            
            // Показываем предпросмотр на главной странице
            document.getElementById('invoiceContent').innerHTML = racunHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            
            // Переключаемся на вкладку инвойсов если не на ней
            showTab('invoice');
            
            showAlert('Рачун создан из загруженного предрачуна!', 'success');
        }

        // Функция для обновления складских расчетов при изменении веса
        function updateWarehouseCalculationsForWeightChange(internalCode, oldWeight, newWeight) {
            console.log('Обновляем складские расчеты для изменения веса:', {internalCode, oldWeight, newWeight});
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) return;
            
            // Получаем складские группы клиента
            if (!window.clientProductGroups[currentClientMB]) {
                console.log('Складские группы не найдены для клиента');
                return;
            }
            
            const groups = window.clientProductGroups[currentClientMB];
            
            // Находим группы, где есть этот товар
            groups.forEach(group => {
                const productInGroup = group.products?.find(p => 
                    (p.product?.internalCode === internalCode) || 
                    (p.internalCode === internalCode)
                );
                
                if (productInGroup) {
                    console.log('Найдена группа с товаром для обновления веса:', group.groupName);
                    
                    // Если вес изменился, пересчитываем количество единиц
                    // Логика: сохраняем общий вес в группе, но пересчитываем количество единиц
                    if (oldWeight && newWeight && oldWeight !== newWeight) {
                        // Сохраняем общий вес продукта в группе
                        const totalWeight = (group.quantity || 0) * oldWeight;
                        
                        // Пересчитываем количество единиц по новому весу
                        const newQuantity = Math.floor(totalWeight / newWeight);
                        
                        console.log(`Пересчет: старый вес ${oldWeight}г x ${group.quantity} = ${totalWeight}г общий вес`);
                        console.log(`Новое количество: ${totalWeight}г / ${newWeight}г = ${newQuantity} единиц`);
                        
                        group.quantity = newQuantity;
                        
                        // Также обновляем резервацию пропорционально
                        if (group.reservation) {
                            const reservationWeight = (group.reservation || 0) * oldWeight;
                            const newReservation = Math.floor(reservationWeight / newWeight);
                            group.reservation = newReservation;
                        }
                    }
                }
            });
            
            // Сохраняем обновленные группы
            localStorage.setItem(`clientProductGroups_${currentClientMB}`, JSON.stringify(groups));
            window.clientProductGroups[currentClientMB] = groups;
            
            console.log('Складские расчеты обновлены после изменения веса');
        }

        // Функция для обновления фильтра пользователей в списке товаров
        function updateProductUserFilter() {
            const filterSelect = document.getElementById('productUserFilter');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            
            // Получаем уникальных пользователей из товаров
            const uniqueUsers = new Set();
            uniqueUsers.add('Компания продавец'); // Всегда добавляем компанию
            
            // Загружаем клиентские товары для определения связанных клиентов
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            
            // Проходим по всем товарам и определяем их пользователей
            products.forEach(product => {
                const user = getProductUser(product.internalCode);
                if (user !== 'Компания продавец') {
                    uniqueUsers.add(user);
                }
            });
            
            // Сохраняем существующие опции
            const existingOptions = Array.from(filterSelect.options).map(opt => ({
                value: opt.value,
                text: opt.text
            }));
            
            // Очищаем и заново заполняем select
            filterSelect.innerHTML = '';
            
            // Добавляем базовые опции
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Все товары';
            filterSelect.appendChild(allOption);
            
            const companyOption = document.createElement('option');
            companyOption.value = 'company';
            companyOption.textContent = 'Компания продавец';
            filterSelect.appendChild(companyOption);
            
            // Добавляем клиентов
            Array.from(uniqueUsers).sort().forEach(user => {
                if (user !== 'Компания продавец') {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    filterSelect.appendChild(option);
                }
            });
            
            // Восстанавливаем выбранное значение
            filterSelect.value = currentValue;
        }

        function renderProductsTable() {
            console.log('=== ОТОБРАЖЕНИЕ ТАБЛИЦЫ ТОВАРОВ ===');
            
            const tbody = document.getElementById('productsTableBody');
            if(!tbody) return;
            
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            const currentClientMB = isClientUser ? window.currentUser.clientMB : null;
            const currentClient = isClientUser && currentClientMB ? 
                clients.find(c => c.mb === currentClientMB) : null;
            const currentClientName = currentClient?.name || null;
            
            // Скрываем/показываем фильтр в зависимости от типа пользователя
            const filterContainer = document.getElementById('productUserFilter')?.parentElement;
            if (filterContainer) {
                if (isClientUser) {
                    filterContainer.style.display = 'none';
                } else {
                    filterContainer.style.display = 'block';
                }
            }
            
            // Получаем выбранный фильтр (только для обычных пользователей)
            const filterSelect = document.getElementById('productUserFilter');
            const selectedFilter = !isClientUser && filterSelect ? filterSelect.value : '';
            console.log('Выбранный фильтр:', selectedFilter);
            console.log('Тип пользователя:', isClientUser ? 'клиент' : 'обычный');
            if (isClientUser) {
                console.log('Данные клиента:', { MB: currentClientMB, name: currentClientName });
            }
            
            tbody.innerHTML = '';
            
            // Обновляем список клиентов в фильтре (только для обычных пользователей)
            if (!isClientUser) {
                updateProductUserFilter();
            }
            
            // Для клиентов: если нет данных клиента, показываем пустой список
            if (isClientUser && (!currentClientMB || !currentClient || !currentClientName)) {
                console.log('❌ Данные клиента неполные - показываем пустой список');
                console.log('Таблица товаров обновлена (пустая для клиента без данных)');
                return;
            }
            
            products.forEach((product, index) => {
                const productUser = getProductUser(product.internalCode);
                
                // Применяем фильтрацию
                let shouldShow = true;
                
                if (isClientUser) {
                    // Для клиентов показываем только их товары (строгое сравнение)
                    shouldShow = (productUser === currentClientName);
                    if (shouldShow) {
                        console.log(`✅ Показываем товар ${product.code} клиенту ${currentClientName}`);
                    }
                } else {
                    // Для обычных пользователей применяем фильтр
                    if (selectedFilter) {
                        if (selectedFilter === 'company') {
                            shouldShow = (productUser === 'Компания продавец');
                        } else {
                            // Фильтр по конкретному клиенту
                            shouldShow = (productUser === selectedFilter);
                        }
                    }
                }
                
                if (!shouldShow) {
                    console.log(`Товар ${product.code} скрыт`);
                    return;
                }
                
                const row = tbody.insertRow();
                const subcatClickable = product.subcategory && product.subcategory !== '-' ? 
                    `<span style="cursor: pointer; color: #6f42c1; text-decoration: underline;" onclick="openSubcategoryProfile('${(product.subcategory || '').replace(/'/g, "\\'")}', '${(product.category || '').replace(/'/g, "\\'")}')">${product.subcategory}</span>` : 
                    (product.subcategory || '-');
                row.innerHTML = `
                    <td>
                        ${isClientUser ? 
                            `<strong>${product.code}</strong>` : 
                            `<strong>${product.code}</strong><br><small style="color: #666;">Внутр.: ${product.internalCode || 'N/A'}</small>`
                        }
                    </td>
                    <td><span style="cursor: pointer; color: #28a745; text-decoration: underline;" onclick="openProductProfile(${index})">${product.name}</span></td>
                    <td>${formatPriceWithCurrency(product.price)}</td>
                    <td>${product.category || '-'}</td>
                    <td>${subcatClickable}</td>
                    <td>${product.weight || 0} г</td>
                    <td><strong>${productUser}</strong></td>
                    <td>
                        <button class="btn btn-success" onclick="openProductProfile(${index})" style="margin-right: 5px;">📊 Карточка товара</button>
                        <button class="btn btn-primary" onclick="editProduct(${index})" style="margin-right: 5px;">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${index})">Удалить</button>
                    </td>
                `;
            });
            
            const visibleRowsCount = tbody.children.length;
            console.log(`Таблица товаров обновлена. Отображено товаров: ${visibleRowsCount}`);
            
            if (isClientUser && visibleRowsCount === 0) {
                console.log('🔍 Клиент видит пустой список товаров - это правильно, если у него нет привязанных товаров');
            }
            
            // Обновляем счётчик товаров
            const countLabel = document.getElementById('productsCountLabel');
            if (countLabel) {
                countLabel.textContent = `Найдено товаров: ${tbody.children.length}`;
            }
        }

        // Функция фильтрации и сортировки товаров
        function filterAndSortProducts() {
            console.log('=== ФИЛЬТРАЦИЯ И СОРТИРОВКА ТОВАРОВ ===');
            
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;
            
            const searchInput = document.getElementById('productSearchInput');
            const sortFilter = document.getElementById('productSortFilter');
            const subcategoryFilter = document.getElementById('productSubcategoryFilter');
            const userFilter = document.getElementById('productUserFilter');
            
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const sortValue = sortFilter?.value || 'name_asc';
            const subcategoryValue = subcategoryFilter?.value || '';
            const userValue = userFilter?.value || '';
            
            console.log('Параметры фильтрации:', { searchTerm, sortValue, subcategoryValue, userValue });
            
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            const currentClientMB = isClientUser ? window.currentUser.clientMB : null;
            const currentClient = isClientUser && currentClientMB ? 
                clients.find(c => c.mb === currentClientMB) : null;
            const currentClientName = currentClient?.name || null;
            
            // Фильтруем товары
            let filteredProducts = products.filter((product, index) => {
                const productUser = getProductUser(product.internalCode);
                
                // Для клиентов показываем только их товары
                if (isClientUser) {
                    if (productUser !== currentClientName) return false;
                }
                
                // Поиск по названию
                if (searchTerm && !product.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Фильтр по субкатегории
                if (subcategoryValue && product.subcategory !== subcategoryValue) {
                    return false;
                }
                
                // Фильтр по пользователю (только для обычных пользователей)
                if (!isClientUser && userValue) {
                    if (userValue === 'company') {
                        if (productUser !== 'Компания продавец') return false;
                    } else {
                        if (productUser !== userValue) return false;
                    }
                }
                
                return true;
            });
            
            // Сохраняем оригинальные индексы
            filteredProducts = filteredProducts.map((product, idx) => ({
                ...product,
                originalIndex: products.findIndex(p => p.code === product.code)
            }));
            
            // Сортируем товары
            filteredProducts.sort((a, b) => {
                switch (sortValue) {
                    case 'name_asc':
                        return (a.name || '').localeCompare(b.name || '', 'ru');
                    case 'name_desc':
                        return (b.name || '').localeCompare(a.name || '', 'ru');
                    case 'price_asc':
                        return (a.price || 0) - (b.price || 0);
                    case 'price_desc':
                        return (b.price || 0) - (a.price || 0);
                    default:
                        return 0;
                }
            });
            
            // Отображаем отфильтрованные товары
            tbody.innerHTML = '';
            
            filteredProducts.forEach(product => {
                const productUser = getProductUser(product.internalCode);
                const subcatClickable = product.subcategory && product.subcategory !== '-' ? 
                    `<span style="cursor: pointer; color: #6f42c1; text-decoration: underline;" onclick="openSubcategoryProfile('${(product.subcategory || '').replace(/'/g, "\\'")}', '${(product.category || '').replace(/'/g, "\\'")}')">${product.subcategory}</span>` : 
                    (product.subcategory || '-');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span style="cursor: pointer; color: #114A9F; text-decoration: underline;" onclick="openProductProfile(${product.originalIndex})">${product.code}</span></td>
                    <td><span style="cursor: pointer; color: #28a745; text-decoration: underline;" onclick="openProductProfile(${product.originalIndex})">${product.name}</span></td>
                    <td>${formatPrice(product.price || 0)} RSD</td>
                    <td>${product.category || '-'}</td>
                    <td>${subcatClickable}</td>
                    <td>${product.weight || 0} г</td>
                    <td><strong>${productUser}</strong></td>
                    <td>
                        <button class="btn btn-success" onclick="openProductProfile(${product.originalIndex})" style="margin-right: 5px;">📊 Карточка товара</button>
                        <button class="btn btn-primary" onclick="editProduct(${product.originalIndex})" style="margin-right: 5px;">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.originalIndex})">Удалить</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Обновляем счётчик
            const countLabel = document.getElementById('productsCountLabel');
            if (countLabel) {
                countLabel.textContent = `Найдено товаров: ${filteredProducts.length}`;
            }
            
            console.log(`Отображено товаров после фильтрации: ${filteredProducts.length}`);
        }

        // Сброс фильтров товаров
        function resetProductFilters() {
            const searchInput = document.getElementById('productSearchInput');
            const sortFilter = document.getElementById('productSortFilter');
            const subcategoryFilter = document.getElementById('productSubcategoryFilter');
            const userFilter = document.getElementById('productUserFilter');
            
            if (searchInput) searchInput.value = '';
            if (sortFilter) sortFilter.value = 'name_asc';
            if (subcategoryFilter) subcategoryFilter.value = '';
            if (userFilter) userFilter.value = '';
            
            renderProductsTable();
            showAlert('Фильтры сброшены', 'info');
        }

        // Загрузка субкатегорий в фильтр товаров
        function loadProductSubcategoryFilter() {
            const subcategoryFilter = document.getElementById('productSubcategoryFilter');
            if (!subcategoryFilter) return;
            
            // Собираем уникальные субкатегории из товаров
            const subcategories = new Set();
            products.forEach(product => {
                if (product.subcategory) {
                    subcategories.add(product.subcategory);
                }
            });
            
            // Сохраняем текущее значение
            const currentValue = subcategoryFilter.value;
            
            // Очищаем и заполняем
            subcategoryFilter.innerHTML = '<option value="">Все субкатегории</option>';
            
            Array.from(subcategories).sort((a, b) => a.localeCompare(b, 'ru')).forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategoryFilter.appendChild(option);
            });
            
            // Восстанавливаем значение
            subcategoryFilter.value = currentValue;
        }

        // Функция для принудительного отображения всех товаров для админа
        function showAllProductsForAdmin() {
            console.log('=== ПРИНУДИТЕЛЬНОЕ ОТОБРАЖЕНИЕ ВСЕХ ТОВАРОВ ДЛЯ АДМИНА ===');
            
            // Сбрасываем фильтр
            const filterSelect = document.getElementById('productUserFilter');
            if (filterSelect) {
                filterSelect.value = '';
                filterSelect.style.display = 'block';
            }
            
            // Показываем контейнер фильтра
            const filterContainer = filterSelect?.parentElement;
            if (filterContainer) {
                filterContainer.style.display = 'block';
            }
            
            // Принудительно устанавливаем режим обычного пользователя для отображения
            const originalUser = window.currentUser;
            window.currentUser = { ...originalUser, userType: 'regular' };
            
            // Перерисовываем таблицу
            renderProductsTable();
            
            // Восстанавливаем пользователя
            window.currentUser = originalUser;
            
            console.log('✅ Все товары отображены для админа');
            showAlert('Отображены все товары системы', 'success');
        }

        // Функция для диагностики и исправления интерфейса админа
        function fixAdminInterface() {
            console.log('=== ИСПРАВЛЕНИЕ ИНТЕРФЕЙСА АДМИНА ===');
            
            if (!window.currentUser) {
                console.log('❌ Пользователь не авторизован');
                return;
            }
            
            const isAdmin = window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND';
            if (!isAdmin) {
                console.log('❌ Не администратор');
                return;
            }
            
            // Восстанавливаем стандартные вкладки
            restoreStandardTabs();
            
            // Восстанавливаем стандартный заголовок
            restoreStandardHeader();
            
            // Принудительно показываем все элементы админа
            setTimeout(() => {
                // Показываем фильтр товаров
                const filterContainer = document.getElementById('productUserFilter')?.parentElement;
                if (filterContainer) {
                    filterContainer.style.display = 'block';
                    console.log('✅ Фильтр товаров восстановлен');
                }
                
                // Показываем поле выбора клиента
                const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
                if (clientSelectionGroup) {
                    clientSelectionGroup.style.display = 'block';
                    console.log('✅ Поле выбора клиента восстановлено');
                }
                
                // Показываем кнопку "Показать все товары"
                const showAllProductsBtn = document.getElementById('showAllProductsBtn');
                if (showAllProductsBtn) {
                    showAllProductsBtn.style.display = 'inline-block';
                    console.log('✅ Кнопка "Показать все товары" восстановлена');
                }
                
                // Переключаемся на вкладку товаров и обновляем ее
                showTab('products');
                renderProductsTable();
                
                console.log('✅ Интерфейс админа полностью восстановлен');
                showAlert('Интерфейс админа восстановлен', 'success');
            }, 200);
        }

        // Склад
        let productGroups = JSON.parse(localStorage.getItem('productGroups')) || [];
        window.productGroups = productGroups; // Делаем доступным глобально

        // Обновление единиц измерения при изменении типа количества
        document.addEventListener('DOMContentLoaded', function() {
            const quantityTypeSelect = document.getElementById('groupQuantityType');
            const reservationTypeSelect = document.getElementById('groupReservationType');
            const quantityUnit = document.getElementById('quantityUnit');
            const reservationUnit = document.getElementById('reservationUnit');
            
            if (quantityTypeSelect) {
                quantityTypeSelect.addEventListener('change', function() {
                    quantityUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                    calculateInitialStock();
                });
            }
            
            if (reservationTypeSelect) {
                reservationTypeSelect.addEventListener('change', function() {
                    reservationUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                    calculateInitialStock();
                });
            }
            
            // Обработчики для формы добавления к существующей группе
            const addQuantityTypeSelect = document.getElementById('addQuantityType');
            const addReservationTypeSelect = document.getElementById('addReservationType');
            const addQuantityUnit = document.getElementById('addQuantityUnit');
            const addReservationUnit = document.getElementById('addReservationUnit');
            
            if (addQuantityTypeSelect) {
                addQuantityTypeSelect.addEventListener('change', function() {
                    addQuantityUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                    calculateAdditionStock();
                });
            }
            
            if (addReservationTypeSelect) {
                addReservationTypeSelect.addEventListener('change', function() {
                    addReservationUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                    calculateAdditionStock();
                });
            }
        });

        function createProductGroup() {
            const groupCode = document.getElementById('groupCode').value.trim().toUpperCase();
            const name = document.getElementById('groupName').value.trim();
            // Берём значение из видимого поля поиска, чтобы всегда получать название
            const supplier = document.getElementById('groupSupplierSearch').value.trim();
            const quantityType = document.getElementById('groupQuantityType').value;
            const quantity = parseFloat(document.getElementById('groupQuantity').value);
            const shipmentDate = document.getElementById('groupShipmentDate').value;
            const reservationType = document.getElementById('groupReservationType').value;
            const reservation = parseFloat(document.getElementById('groupReservation').value);
            const deductionType = document.getElementById('groupDeductionType').value;
            const deductionValue = parseFloat(document.getElementById('groupDeduction').value) || 0;
            const category = document.getElementById('groupCategory').value;
            const subcategory = document.getElementById('groupSubcategory').value;

            // Валидируем обязательные поля
            if (!groupCode || !name || !quantity || quantity <= 0) {
                showAlert('Заполните обязательные поля корректно! (Код группы, Название, Количество)', 'danger');
                return;
            }

            // Проверяем уникальность кода группы
            if (productGroups.find(g => g.groupCode === groupCode)) {
                showAlert('Группа с таким кодом уже существует! Используйте функцию "Добавить к существующей группе".', 'warning');
                return;
            }

            // Рассчитываем списание в зависимости от типа
            let deductionAmount = 0;
            if (deductionType === 'percentage') {
                deductionAmount = quantity * (deductionValue / 100);
            } else {
                deductionAmount = deductionValue;
            }
            
            // Рассчитываем изначальный остаток: общее количество - списание - резервации
            const reservationAmount = reservation || 0;
            const initialStock = Math.max(0, quantity - deductionAmount - reservationAmount);
            const initialPercentage = (initialStock / quantity) * 100;

            const newGroup = {
                id: Date.now(),
                groupCode,
                name,
                supplier,
                category,
                subcategory,
                quantityType,
                quantity: initialStock,
                currentQuantity: initialStock,
                originalQuantity: quantity,
                initialStock: initialStock,
                shipmentDate,
                originalShipmentDate: shipmentDate,
                reservationType,
                reservation,
                deductionType,
                deductionValue,
                deductionAmount,
                products: [],
                additions: [],
                remainingPercentage: initialPercentage,
                costPrice1: null, // Себестоимость (равномерная) - заполняется из поставки
                costPrice2: null, // Себестоимость (пропорциональная) - заполняется из поставки
                createdAt: new Date().toISOString()
            };

            productGroups.push(newGroup);
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;
            addLog(`Создана группа товаров: ${name}`);
            clearGroupForm();
            renderProductGroups();
            showAlert('Группа товаров создана!', 'success');
        }

        function clearGroupForm() {
            ['groupCode', 'groupName', 'groupSupplier', 'groupQuantity', 'groupShipmentDate', 'groupReservation', 'groupDeduction'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Очищаем категорию и субкатегорию
            const groupCategory = document.getElementById('groupCategory');
            const groupSubcategory = document.getElementById('groupSubcategory');
            if (groupCategory) groupCategory.value = '';
            if (groupSubcategory) {
                groupSubcategory.innerHTML = '<option value="">Сначала выберите категорию</option>';
            }
            
            // Очищаем поле поставщика с автокомплитом
            const groupSupplierSearch = document.getElementById('groupSupplierSearch');
            if (groupSupplierSearch) groupSupplierSearch.value = '';
            
            // Возвращаем значение списания к 5%
            const deductionInput = document.getElementById('groupDeduction');
            if (deductionInput) deductionInput.value = '5';
            
            // Сбрасываем калькулятор
            const calculatedStock = document.getElementById('calculatedStock');
            if (calculatedStock) calculatedStock.textContent = '0 г';
        }

        // Загрузка категорий для формы создания группы на складе
        async function loadGroupCategories() {
            const select = document.getElementById('groupCategory');
            if (!select) return;
            
            // Если categoriesData ещё не загружены, загружаем
            if (typeof categoriesData === 'undefined' || categoriesData.length === 0) {
                try {
                    categoriesData = await window.api.categories.getAll();
                } catch (error) {
                    console.error('Ошибка загрузки категорий:', error);
                    categoriesData = [];
                }
            }
            
            select.innerHTML = '<option value="">Выберите категорию</option>';
            categoriesData.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
        
        // Загрузка субкатегорий при выборе категории в форме склада
        async function loadGroupSubcategories() {
            const categorySelect = document.getElementById('groupCategory');
            const subcategorySelect = document.getElementById('groupSubcategory');
            if (!categorySelect || !subcategorySelect) return;
            
            const selectedCategory = categorySelect.value;
            
            if (!selectedCategory) {
                subcategorySelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
                return;
            }
            
            // Находим ID категории по имени
            const category = categoriesData.find(c => c.name === selectedCategory);
            if (!category) {
                subcategorySelect.innerHTML = '<option value="">Субкатегории не найдены</option>';
                return;
            }
            
            try {
                const subs = await window.api.subcategories.getByCategory(category.id);
                subcategorySelect.innerHTML = '<option value="">Выберите субкатегорию</option>';
                subs.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки субкатегорий:', error);
                subcategorySelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }

        // Функция для обновления единиц измерения списания
        function updateDeductionUnit() {
            const deductionType = document.getElementById('groupDeductionType').value;
            const deductionUnit = document.getElementById('deductionUnit');
            const quantityType = document.getElementById('groupQuantityType').value;
            
            if (deductionType === 'percentage') {
                deductionUnit.textContent = '%';
            } else if (deductionType === 'weight') {
                deductionUnit.textContent = 'г';
            } else {
                deductionUnit.textContent = 'ед.';
            }
            
            calculateInitialStock();
        }

        // Функция для расчета и отображения остатка на складе
        function calculateInitialStock() {
            const quantity = parseFloat(document.getElementById('groupQuantity').value) || 0;
            const deductionType = document.getElementById('groupDeductionType').value;
            const deductionValue = parseFloat(document.getElementById('groupDeduction').value) || 0;
            const reservation = parseFloat(document.getElementById('groupReservation').value) || 0;
            const quantityType = document.getElementById('groupQuantityType').value;
            
            if (quantity <= 0) {
                document.getElementById('calculatedStock').textContent = '0 ' + (quantityType === 'weight' ? 'г' : 'ед.');
                return;
            }
            
            // Рассчитываем списание
            let deductionAmount = 0;
            if (deductionType === 'percentage') {
                deductionAmount = quantity * (deductionValue / 100);
            } else {
                deductionAmount = deductionValue;
            }
            
            // Рассчитываем остаток на складе
            const stock = Math.max(0, quantity - deductionAmount - reservation);
            const unit = quantityType === 'weight' ? 'г' : 'ед.';
            
            document.getElementById('calculatedStock').textContent = stock.toFixed(1) + ' ' + unit;
        }

        // Функция для переключения отображения формы добавления
        function toggleAdditionForm() {
            const form = document.getElementById('groupAdditionForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                // Скрываем форму создания если открыта
                document.getElementById('groupCreationForm').style.display = 'none';
                document.getElementById('toggleGroupCreationIcon').textContent = '➕';
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                form.style.display = 'none';
            }
        }

        // Функция для закрытия формы добавления
        function closeAdditionForm() {
            document.getElementById('groupAdditionForm').style.display = 'none';
        }
        
        // Функция для переключения отображения формы создания группы
        function toggleGroupCreationForm() {
            const form = document.getElementById('groupCreationForm');
            const icon = document.getElementById('toggleGroupCreationIcon');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                icon.textContent = '➖';
                // Скрываем форму добавления если открыта
                document.getElementById('groupAdditionForm').style.display = 'none';
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                form.style.display = 'none';
                icon.textContent = '➕';
            }
        }
        
        // Переключение вкладок склада (Склад / Списано)
        function switchWarehouseTab(tabId) {
            // Скрываем все контенты
            document.getElementById('warehouseActiveContent').style.display = 'none';
            document.getElementById('warehouseWrittenOffContent').style.display = 'none';
            
            // Убираем активный стиль со всех кнопок
            document.getElementById('warehouseActiveTabBtn').style.background = '#e9ecef';
            document.getElementById('warehouseActiveTabBtn').style.color = '#495057';
            document.getElementById('warehouseWrittenOffTabBtn').style.background = '#e9ecef';
            document.getElementById('warehouseWrittenOffTabBtn').style.color = '#495057';
            
            if (tabId === 'active') {
                document.getElementById('warehouseActiveContent').style.display = 'block';
                document.getElementById('warehouseActiveTabBtn').style.background = '#114A9F';
                document.getElementById('warehouseActiveTabBtn').style.color = 'white';
            } else {
                document.getElementById('warehouseWrittenOffContent').style.display = 'block';
                document.getElementById('warehouseWrittenOffTabBtn').style.background = '#dc3545';
                document.getElementById('warehouseWrittenOffTabBtn').style.color = 'white';
                renderWrittenOffGroups();
            }
        }
        
        // Список списанных групп
        window.writtenOffGroups = JSON.parse(localStorage.getItem('writtenOffGroups') || '[]');
        
        // Отметить группу как отказ
        function markGroupAsRejection(groupId) {
            console.log('=== markGroupAsRejection called ===');
            console.log('groupId:', groupId, 'type:', typeof groupId);
            
            try {
                const group = productGroups.find(g => String(g.id) === String(groupId));
                
                if (!group) {
                    showAlert('Группа не найдена!', 'error');
                    return;
                }
                
                // Создаём новый код для списанной группы: оригинальный код + OT (Отказ)
                const newGroupCode = (group.groupCode || 'GRP') + '-OT';
                
                // Инициализируем writtenOffGroups если нет
                if (!window.writtenOffGroups) {
                    window.writtenOffGroups = [];
                }
                
                // Создаём запись в списанных
                const writtenOffEntry = {
                    ...group,
                    id: Date.now(),
                    originalId: group.id,
                    groupCode: newGroupCode,
                    status: 'rejection',
                    writtenOffDate: new Date().toISOString(),
                    writtenOffReason: 'Отказ от товара'
                };
                
                window.writtenOffGroups.push(writtenOffEntry);
                localStorage.setItem('writtenOffGroups', JSON.stringify(window.writtenOffGroups));
                
                // Удаляем из активных
                const groupIndex = productGroups.findIndex(g => String(g.id) === String(groupId));
                if (groupIndex !== -1) {
                    productGroups.splice(groupIndex, 1);
                    localStorage.setItem('productGroups', JSON.stringify(productGroups));
                    window.productGroups = productGroups;
                }
                
                renderProductGroups();
                showAlert(`Группа "${group.name}" отмечена как ОТКАЗ и перенесена в списанные с кодом ${newGroupCode}`, 'success');
                
            } catch (error) {
                console.error('markGroupAsRejection error:', error);
                showAlert('Ошибка при отказе: ' + error.message, 'error');
            }
        }
        
        // Открыть модальное окно выбора группы для замены
        // Функция для добавления лога в debug область
        function addDebugLog(message, color = '#0f0') {
            const logArea = document.getElementById('replacementDebugLog');
            if (logArea) {
                const time = new Date().toLocaleTimeString();
                logArea.innerHTML += `<div style="color: ${color};">[${time}] ${message}</div>`;
                logArea.scrollTop = logArea.scrollHeight;
            }
            console.log('[DEBUG]', message);
        }
        
        function openReplacementModal(groupId) {
            console.log('=== openReplacementModal called ===');
            console.log('groupId:', groupId, 'type:', typeof groupId);
            
            document.getElementById('replacementSourceGroupId').value = String(groupId);
            document.getElementById('replacementGroupSearch').value = '';
            
            // Очищаем лог
            const logArea = document.getElementById('replacementDebugLog');
            if (logArea) {
                logArea.innerHTML = `<div style="color: #ff0;">🔧 DEBUG MODE ENABLED</div>`;
            }
            
            addDebugLog(`openReplacementModal вызван с groupId: ${groupId} (тип: ${typeof groupId})`, '#0ff');
            addDebugLog(`productGroups.length = ${productGroups ? productGroups.length : 'undefined'}`, '#0ff');
            
            renderReplacementGroupsList();
            document.getElementById('replacementGroupModal').style.display = 'block';
        }
        
        function closeReplacementModal() {
            document.getElementById('replacementGroupModal').style.display = 'none';
        }
        
        // Отрисовка списка групп для выбора замены
        function renderReplacementGroupsList(searchTerm = '') {
            addDebugLog('renderReplacementGroupsList вызвана', '#ff0');
            
            const sourceGroupId = document.getElementById('replacementSourceGroupId').value;
            const container = document.getElementById('replacementGroupsList');
            
            addDebugLog(`sourceGroupId: ${sourceGroupId}`, '#fff');
            addDebugLog(`productGroups доступен: ${!!productGroups}, длина: ${productGroups ? productGroups.length : 0}`, '#fff');
            
            let groups = productGroups.filter(g => 
                String(g.id) !== String(sourceGroupId) && !g.status
            );
            
            addDebugLog(`Групп после фильтрации (без source и без status): ${groups.length}`, '#0f0');
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                groups = groups.filter(g => 
                    (g.name || '').toLowerCase().includes(term) ||
                    (g.groupCode || '').toLowerCase().includes(term)
                );
            }
            
            if (groups.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Нет доступных групп для замены</p>';
                addDebugLog('Нет групп для отображения!', '#f00');
                return;
            }
            
            addDebugLog(`Отрисовываем ${groups.length} групп...`, '#0f0');
            
            // Выводим первые 3 группы в лог
            groups.slice(0, 3).forEach((g, i) => {
                addDebugLog(`  [${i}] id=${g.id}, name="${g.name}", code="${g.groupCode}"`, '#aaa');
            });
            
            container.innerHTML = groups.map(g => {
                const groupIdStr = String(g.id);
                return `
                <div class="replacement-group-item" data-group-id="${groupIdStr}" onclick="handleReplacementItemClick('${groupIdStr}')" style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #333;">${g.name}</strong>
                            ${g.groupCode ? `<span style="background: #114A9F; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">${g.groupCode}</span>` : ''}
                        </div>
                        <span style="color: #666; font-size: 13px;">${(g.currentQuantity || 0).toFixed(1)} ${g.quantityType === 'weight' ? 'г' : 'ед.'}</span>
                    </div>
                    ${g.supplier ? `<div style="color: #888; font-size: 12px; margin-top: 5px;">🏭 ${g.supplier}</div>` : ''}
                </div>
            `}).join('');
            
            addDebugLog(`HTML сгенерирован. Элементов в контейнере: ${container.querySelectorAll('.replacement-group-item').length}`, '#0f0');
            
            // Добавляем обработчики кликов
            const items = container.querySelectorAll('.replacement-group-item');
            addDebugLog(`Добавляем обработчики к ${items.length} элементам...`, '#ff0');
            
            items.forEach((item, index) => {
                const targetId = item.getAttribute('data-group-id');
                addDebugLog(`  Обработчик для элемента ${index}, targetId=${targetId}`, '#aaa');
                
                item.addEventListener('click', function(e) {
                    addDebugLog(`КЛИК! targetId=${targetId}`, '#0f0');
                    selectReplacementGroup(targetId);
                });
                item.addEventListener('mouseover', function() {
                    this.style.background = '#fff3e0';
                });
                item.addEventListener('mouseout', function() {
                    this.style.background = 'white';
                });
            });
            
            addDebugLog('renderReplacementGroupsList завершена успешно', '#0f0');
        }
        
        // Резервный обработчик клика через onclick
        function handleReplacementItemClick(targetId) {
            addDebugLog(`handleReplacementItemClick вызван с targetId=${targetId}`, '#f0f');
            selectReplacementGroup(targetId);
        }
        
        function filterReplacementGroups() {
            const search = document.getElementById('replacementGroupSearch').value;
            renderReplacementGroupsList(search);
        }
        
        // Выбрать группу для замены
        function selectReplacementGroup(targetGroupId) {
            addDebugLog(`=== selectReplacementGroup ВЫЗВАН ===`, '#f0f');
            addDebugLog(`targetGroupId: ${targetGroupId}`, '#f0f');
            
            const sourceGroupId = document.getElementById('replacementSourceGroupId').value;
            addDebugLog(`sourceGroupId: ${sourceGroupId}`, '#f0f');
            
            const sourceGroup = productGroups.find(g => String(g.id) === String(sourceGroupId));
            const targetGroup = productGroups.find(g => String(g.id) === String(targetGroupId));
            
            addDebugLog(`sourceGroup найден: ${!!sourceGroup}`, '#fff');
            addDebugLog(`targetGroup найден: ${!!targetGroup}`, '#fff');
            
            console.log('selectReplacementGroup called:', { sourceGroupId, targetGroupId, sourceGroup, targetGroup });
            
            if (!sourceGroup || !targetGroup) {
                addDebugLog(`ОШИБКА: группа не найдена!`, '#f00');
                showAlert('Ошибка: группа не найдена', 'error');
                return;
            }
            
            addDebugLog(`Выполняем замену...`, '#0f0');
            
            try {
                // Создаём новый код для списанной группы: оригинальный код + ZM (Замена)
                const newGroupCode = (sourceGroup.groupCode || 'GRP') + '-ZM';
                addDebugLog(`Новый код: ${newGroupCode}`, '#0f0');
                
                // Создаём запись в списанных
                const writtenOffEntry = {
                    ...sourceGroup,
                    id: Date.now(),
                    originalId: sourceGroup.id,
                    groupCode: newGroupCode,
                    status: 'replacement',
                    replacementGroupId: targetGroupId,
                    replacementGroupName: targetGroup.name,
                    replacementGroupCode: targetGroup.groupCode,
                    writtenOffDate: new Date().toISOString(),
                    writtenOffReason: `Замена на: ${targetGroup.name} (${targetGroup.groupCode || 'без кода'})`
                };
                addDebugLog(`writtenOffEntry создан, id: ${writtenOffEntry.id}`, '#0f0');
                
                // Инициализируем writtenOffGroups если нет
                if (!window.writtenOffGroups) {
                    window.writtenOffGroups = [];
                    addDebugLog(`Инициализировали пустой массив writtenOffGroups`, '#ff0');
                }
                
                window.writtenOffGroups.push(writtenOffEntry);
                addDebugLog(`Добавлено в writtenOffGroups, длина: ${window.writtenOffGroups.length}`, '#0f0');
                
                localStorage.setItem('writtenOffGroups', JSON.stringify(window.writtenOffGroups));
                addDebugLog(`Сохранено в localStorage`, '#0f0');
                
                // Удаляем из активных
                const groupIndex = productGroups.findIndex(g => String(g.id) === String(sourceGroupId));
                addDebugLog(`Индекс группы в productGroups: ${groupIndex}`, '#0f0');
                
                if (groupIndex !== -1) {
                    productGroups.splice(groupIndex, 1);
                    localStorage.setItem('productGroups', JSON.stringify(productGroups));
                    window.productGroups = productGroups;
                    addDebugLog(`Группа удалена из productGroups`, '#0f0');
                }
                
                closeReplacementModal();
                addDebugLog(`Модальное окно закрыто`, '#0f0');
                
                renderProductGroups();
                addDebugLog(`renderProductGroups вызвана`, '#0f0');
                
                showAlert(`Группа "${sourceGroup.name}" заменена на "${targetGroup.name}" и перенесена в списанные с кодом ${newGroupCode}`, 'success');
                addDebugLog(`=== ЗАМЕНА УСПЕШНО ЗАВЕРШЕНА ===`, '#0f0');
                
            } catch (error) {
                addDebugLog(`ОШИБКА: ${error.message}`, '#f00');
                console.error('selectReplacementGroup error:', error);
                showAlert('Ошибка при замене: ' + error.message, 'error');
            }
        }
        
        // Показать информацию о замене
        function showReplacementInfo(groupId) {
            const group = window.writtenOffGroups.find(g => String(g.id) === String(groupId));
            if (!group) {
                showAlert('Информация о замене не найдена', 'error');
                return;
            }
            
            const content = document.getElementById('replacementInfoContent');
            content.innerHTML = `
                <div style="font-size: 18px; font-weight: 600; color: #e65100; margin-bottom: 10px;">${group.replacementGroupName}</div>
                ${group.replacementGroupCode ? `<div style="background: #114A9F; color: white; padding: 4px 12px; border-radius: 6px; display: inline-block; font-size: 12px;">${group.replacementGroupCode}</div>` : ''}
                <div style="margin-top: 15px; color: #666; font-size: 13px;">Дата замены: ${new Date(group.writtenOffDate).toLocaleDateString('ru-RU')}</div>
            `;
            
            document.getElementById('replacementInfoModal').style.display = 'block';
        }
        
        function closeReplacementInfoModal() {
            document.getElementById('replacementInfoModal').style.display = 'none';
        }
        
        // Рендер списанных групп
        function renderWrittenOffGroups() {
            const container = document.getElementById('writtenOffGroupsList');
            const countDisplay = document.getElementById('writtenOffCountDisplay');
            
            let groups = [...window.writtenOffGroups];
            
            // Фильтры
            const searchTerm = (document.getElementById('writtenOffSearchInput')?.value || '').toLowerCase();
            const reasonFilter = document.getElementById('writtenOffReasonFilter')?.value || '';
            const sortFilter = document.getElementById('writtenOffSortFilter')?.value || 'date_desc';
            
            if (searchTerm) {
                groups = groups.filter(g => 
                    (g.name || '').toLowerCase().includes(searchTerm) ||
                    (g.groupCode || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (reasonFilter) {
                groups = groups.filter(g => g.status === reasonFilter);
            }
            
            // Сортировка
            groups.sort((a, b) => {
                switch (sortFilter) {
                    case 'date_desc':
                        return new Date(b.writtenOffDate || 0) - new Date(a.writtenOffDate || 0);
                    case 'date_asc':
                        return new Date(a.writtenOffDate || 0) - new Date(b.writtenOffDate || 0);
                    case 'name_asc':
                        return (a.name || '').localeCompare(b.name || '', 'ru');
                    default:
                        return 0;
                }
            });
            
            if (countDisplay) countDisplay.textContent = groups.length;
            
            if (groups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 40px 0;">Нет списанных групп</p>';
                return;
            }
            
            container.innerHTML = groups.map(group => {
                const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
                const statusBadge = group.status === 'rejection' 
                    ? '<span class="group-status-badge group-status-rejection">ОТКАЗ</span>'
                    : group.status === 'replacement'
                        ? `<span class="group-status-badge group-status-replacement" onclick="showReplacementInfo(${group.id})">ЗАМЕНА</span>`
                        : '<span class="group-status-badge" style="background: #6c757d; color: white;">СПИСАНИЕ</span>';
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #f5c6cb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span>${group.name}</span>
                                    ${group.groupCode ? `<span class="group-code-badge">${group.groupCode}</span>` : ''}
                                    ${statusBadge}
                                </h4>
                                <div style="color: #666; font-size: 13px; display: flex; gap: 20px; flex-wrap: wrap;">
                                    <span>Количество: ${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</span>
                                    ${group.supplier ? `<span>🏭 ${group.supplier}</span>` : ''}
                                    ${group.category ? `<span>📁 ${group.category}</span>` : ''}
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: #fff5f5; border-radius: 8px; font-size: 13px;">
                                    <strong style="color: #dc3545;">Причина:</strong> ${group.writtenOffReason || 'Не указана'}
                                    <br><span style="color: #888;">Дата: ${group.writtenOffDate ? new Date(group.writtenOffDate).toLocaleDateString('ru-RU') : 'Не указана'}</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="restoreWrittenOffGroup(${group.id})" style="padding: 8px 16px; font-size: 12px;">
                                ↩️ Восстановить
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterWrittenOffGroups() {
            renderWrittenOffGroups();
        }
        
        function resetWrittenOffFilters() {
            document.getElementById('writtenOffSearchInput').value = '';
            document.getElementById('writtenOffReasonFilter').value = '';
            document.getElementById('writtenOffSortFilter').value = 'date_desc';
            renderWrittenOffGroups();
        }
        
        // Восстановить списанную группу
        function restoreWrittenOffGroup(groupId) {
            console.log('=== restoreWrittenOffGroup called ===');
            console.log('groupId:', groupId);
            
            try {
                if (!window.writtenOffGroups) {
                    window.writtenOffGroups = [];
                }
                
                const groupIndex = window.writtenOffGroups.findIndex(g => 
                    String(g.id) === String(groupId)
                );
                
                if (groupIndex === -1) {
                    showAlert('Группа не найдена в списанных!', 'error');
                    return;
                }
                
                const group = window.writtenOffGroups[groupIndex];
                console.log('Found group to restore:', group);
                
                // Восстанавливаем оригинальный ID если есть
                const restoredGroup = { ...group };
                if (restoredGroup.originalId) {
                    restoredGroup.id = restoredGroup.originalId;
                }
                // Восстанавливаем оригинальный код (убираем -OT или -ZM)
                if (restoredGroup.groupCode && (restoredGroup.groupCode.endsWith('-OT') || restoredGroup.groupCode.endsWith('-ZM'))) {
                    restoredGroup.groupCode = restoredGroup.groupCode.slice(0, -3);
                }
                
                // Удаляем служебные поля
                delete restoredGroup.status;
                delete restoredGroup.writtenOffDate;
                delete restoredGroup.writtenOffReason;
                delete restoredGroup.replacementGroupId;
                delete restoredGroup.replacementGroupName;
                delete restoredGroup.replacementGroupCode;
                delete restoredGroup.originalId;
                
                // Добавляем обратно на склад
                productGroups.push(restoredGroup);
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                window.productGroups = productGroups;
                
                // Удаляем из списанных
                window.writtenOffGroups.splice(groupIndex, 1);
                localStorage.setItem('writtenOffGroups', JSON.stringify(window.writtenOffGroups));
                
                renderWrittenOffGroups();
                renderProductGroups();
                showAlert(`Группа "${group.name}" восстановлена на склад`, 'success');
                
            } catch (error) {
                console.error('restoreWrittenOffGroup error:', error);
                showAlert('Ошибка при восстановлении: ' + error.message, 'error');
            }
        }

        // Функция для проверки существования группы по коду
        function checkExistingGroup() {
            const groupCode = document.getElementById('addGroupCode').value.trim().toUpperCase();
            const statusEl = document.getElementById('groupCodeStatus');
            
            if (!groupCode) {
                statusEl.innerHTML = '';
                return;
            }
            
            const existingGroup = productGroups.find(g => g.groupCode === groupCode);
            
            if (existingGroup) {
                statusEl.innerHTML = `<span style="color: #28a745; font-weight: 600;">✓ Группа найдена: ${existingGroup.name}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color: #dc3545; font-weight: 600;">✗ Группа с таким кодом не найдена</span>`;
            }
        }

        // Функция для обновления единиц измерения списания в форме добавления
        function updateAddDeductionUnit() {
            const deductionType = document.getElementById('addDeductionType').value;
            const deductionUnit = document.getElementById('addDeductionUnit');
            
            if (deductionType === 'percentage') {
                deductionUnit.textContent = '%';
            } else if (deductionType === 'weight') {
                deductionUnit.textContent = 'г';
            } else {
                deductionUnit.textContent = 'ед.';
            }
            
            calculateAdditionStock();
        }

        // Функция для расчета добавляемого количества
        function calculateAdditionStock() {
            const quantity = parseFloat(document.getElementById('addQuantity').value) || 0;
            const deductionType = document.getElementById('addDeductionType').value;
            const deductionValue = parseFloat(document.getElementById('addDeduction').value) || 0;
            const reservation = parseFloat(document.getElementById('addReservation').value) || 0;
            const quantityType = document.getElementById('addQuantityType').value;
            
            if (quantity <= 0) {
                document.getElementById('calculatedAddStock').textContent = '0 ' + (quantityType === 'weight' ? 'г' : 'ед.');
                return;
            }
            
            // Рассчитываем списание
            let deductionAmount = 0;
            if (deductionType === 'percentage') {
                deductionAmount = quantity * (deductionValue / 100);
            } else {
                deductionAmount = deductionValue;
            }
            
            // Рассчитываем добавляемый остаток
            const stock = Math.max(0, quantity - deductionAmount - reservation);
            const unit = quantityType === 'weight' ? 'г' : 'ед.';
            
            document.getElementById('calculatedAddStock').textContent = stock.toFixed(1) + ' ' + unit;
        }

        // Функция для очистки формы добавления
        function clearAdditionForm() {
            ['addGroupCode', 'addQuantity', 'addShipmentDate', 'addReservation', 'addDeduction'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Возвращаем значение списания к 5%
            const deductionInput = document.getElementById('addDeduction');
            if (deductionInput) deductionInput.value = '5';
            
            // Сбрасываем калькулятор и статус
            document.getElementById('calculatedAddStock').textContent = '0 г';
            document.getElementById('groupCodeStatus').innerHTML = '';
        }

        // Основная функция для добавления к существующей группе
        function addToExistingGroup() {
            const groupCode = document.getElementById('addGroupCode').value.trim().toUpperCase();
            const quantityType = document.getElementById('addQuantityType').value;
            const quantity = parseFloat(document.getElementById('addQuantity').value);
            const shipmentDate = document.getElementById('addShipmentDate').value;
            const reservationType = document.getElementById('addReservationType').value;
            const reservation = parseFloat(document.getElementById('addReservation').value) || 0;
            const deductionType = document.getElementById('addDeductionType').value;
            const deductionValue = parseFloat(document.getElementById('addDeduction').value) || 0;

            if (!groupCode || !quantity || quantity <= 0) {
                showAlert('Заполните обязательные поля корректно!', 'danger');
                return;
            }

            // Находим группу по коду
            const groupIndex = productGroups.findIndex(g => g.groupCode === groupCode);
            
            if (groupIndex === -1) {
                showAlert('Группа с таким кодом не найдена!', 'danger');
                return;
            }

            const group = productGroups[groupIndex];

            // Рассчитываем списание в зависимости от типа
            let deductionAmount = 0;
            if (deductionType === 'percentage') {
                deductionAmount = quantity * (deductionValue / 100);
            } else {
                deductionAmount = deductionValue;
            }
            
            // Рассчитываем добавляемый остаток
            const addStock = Math.max(0, quantity - deductionAmount - reservation);

            // Суммируем данные с существующей группой
            group.originalQuantity += quantity;
            
            // Инициализируем currentQuantity если его нет (используем старое значение quantity)
            if (!group.currentQuantity) {
                group.currentQuantity = group.quantity || 0;
            }
            
            // Теперь добавляем к обоим
            group.quantity = (group.quantity || 0) + addStock;
            group.currentQuantity += addStock;
            group.reservation = (group.reservation || 0) + reservation;
            group.remainingPercentage = (group.currentQuantity / group.originalQuantity) * 100;
            
            // Сохраняем информацию о дополнении в историю
            const stockBefore = (group.quantity || 0) - addStock;
            const stockAfter = group.quantity || 0;
            
            if (!group.additions) {
                group.additions = [];
            }
            
            group.additions.push({
                date: new Date().toISOString(),
                shipmentDate: shipmentDate || null,
                originalQuantity: quantity,
                quantity: addStock,
                deduction: deductionAmount,
                reservation: reservation,
                stockBefore: stockBefore,
                stockAfter: stockAfter
            });

            // Сохраняем обновленные данные
            productGroups[groupIndex] = group;
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;
            
            addLog(`Добавлено к группе ${group.name} (${groupCode}): +${addStock.toFixed(1)} ${quantityType === 'weight' ? 'г' : 'ед.'}`);
            
            clearAdditionForm();
            closeAdditionForm();
            renderProductGroups();
            showAlert(`Добавлено к группе "${group.name}"!`, 'success');
        }

        // Загрузка фильтров для групп
        function loadGroupFilters() {
            const categoryFilter = document.getElementById('groupCategoryFilter');
            const supplierFilter = document.getElementById('groupSupplierFilter');
            
            if (!categoryFilter || !supplierFilter) return;
            
            // Собираем уникальные категории и поставщиков
            const categories = new Set();
            const suppliers = new Set();
            
            productGroups.forEach(group => {
                if (group.category) categories.add(group.category);
                if (group.supplier) suppliers.add(group.supplier);
            });
            
            // Заполняем фильтр категорий
            const currentCategory = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">Все категории</option>';
            [...categories].sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === currentCategory) option.selected = true;
                categoryFilter.appendChild(option);
            });
            
            // Заполняем фильтр поставщиков
            const currentSupplier = supplierFilter.value;
            supplierFilter.innerHTML = '<option value="">Все поставщики</option>';
            [...suppliers].sort().forEach(sup => {
                const option = document.createElement('option');
                option.value = sup;
                option.textContent = sup;
                if (sup === currentSupplier) option.selected = true;
                supplierFilter.appendChild(option);
            });
        }
        
        // Фильтрация и сортировка групп
        function filterAndSortGroups() {
            const searchInput = document.getElementById('groupSearchInput');
            const categoryFilter = document.getElementById('groupCategoryFilter');
            const supplierFilter = document.getElementById('groupSupplierFilter');
            const sortFilter = document.getElementById('groupSortFilter');
            
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const categoryValue = categoryFilter?.value || '';
            const supplierValue = supplierFilter?.value || '';
            const sortValue = sortFilter?.value || 'name_asc';
            
            let filtered = [...productGroups];
            
            // Фильтр по поиску (название или код)
            if (searchTerm) {
                filtered = filtered.filter(g => 
                    (g.name || '').toLowerCase().includes(searchTerm) ||
                    (g.groupCode || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Фильтр по категории
            if (categoryValue) {
                filtered = filtered.filter(g => g.category === categoryValue);
            }
            
            // Фильтр по поставщику
            if (supplierValue) {
                filtered = filtered.filter(g => g.supplier === supplierValue);
            }
            
            // Сортировка
            filtered.sort((a, b) => {
                switch (sortValue) {
                    case 'name_asc':
                        return (a.name || '').localeCompare(b.name || '', 'ru');
                    case 'name_desc':
                        return (b.name || '').localeCompare(a.name || '', 'ru');
                    case 'code_asc':
                        return (a.groupCode || '').localeCompare(b.groupCode || '', 'ru');
                    case 'code_desc':
                        return (b.groupCode || '').localeCompare(a.groupCode || '', 'ru');
                    case 'quantity_asc':
                        return (a.currentQuantity || 0) - (b.currentQuantity || 0);
                    case 'quantity_desc':
                        return (b.currentQuantity || 0) - (a.currentQuantity || 0);
                    case 'date_asc':
                        return new Date(a.shipmentDate || 0) - new Date(b.shipmentDate || 0);
                    case 'date_desc':
                        return new Date(b.shipmentDate || 0) - new Date(a.shipmentDate || 0);
                    default:
                        return 0;
                }
            });
            
            // Обновляем счётчик
            const countDisplay = document.getElementById('groupsCountDisplay');
            if (countDisplay) {
                countDisplay.textContent = filtered.length;
            }
            
            // Рендерим отфильтрованные группы
            renderProductGroupsFiltered(filtered);
        }
        
        // Сброс фильтров групп
        function resetGroupFilters() {
            const searchInput = document.getElementById('groupSearchInput');
            const categoryFilter = document.getElementById('groupCategoryFilter');
            const supplierFilter = document.getElementById('groupSupplierFilter');
            const sortFilter = document.getElementById('groupSortFilter');
            
            if (searchInput) searchInput.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (supplierFilter) supplierFilter.value = '';
            if (sortFilter) sortFilter.value = 'name_asc';
            
            renderProductGroups();
            showAlert('Фильтры сброшены', 'info');
        }
        
        // Рендер отфильтрованных групп
        function renderProductGroupsFiltered(groupsToShow) {
            const container = document.getElementById('productGroupsList');
            if (!container) return;
            
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            
            if (groupsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">Группы не найдены</p>';
                return;
            }
            
            renderGroupsHTML(container, groupsToShow, isClientUser);
        }

        function renderProductGroups() {
            const container = document.getElementById('productGroupsList');
            if (!container) return;

            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            
            let groupsToShow = [];
            
            if (isClientUser) {
                const clientMB = window.currentUser?.clientMB;
                if (!clientMB) {
                    console.error('Не найден matični broj клиента');
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">Ошибка: клиент не определен</p>';
                    return;
                }
                
                // Инициализируем клиентские группы как объект если нужно
                if (!window.clientProductGroups) {
                    window.clientProductGroups = {};
                }
                
                // Загружаем группы конкретного клиента
                if (!window.clientProductGroups[clientMB]) {
                    const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                    window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                    console.log(`Загружены клиентские группы для ${clientMB}:`, window.clientProductGroups[clientMB].length);
                }
                
                groupsToShow = window.clientProductGroups[clientMB] || [];
            } else {
                groupsToShow = productGroups;
            }
            
            // Отладочная информация
            if (isClientUser) {
                console.log('Отображение склада для клиента:', {
                    clientMB: window.currentUser?.clientMB,
                    groupsCount: groupsToShow.length,
                    groups: groupsToShow
                });
            }

            // Загружаем фильтры
            if (!isClientUser) {
                loadGroupFilters();
            }
            
            // Обновляем счётчик
            const countDisplay = document.getElementById('groupsCountDisplay');
            if (countDisplay) {
                countDisplay.textContent = groupsToShow.length;
            }

            if (groupsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">Группы товаров не созданы</p>';
                return;
            }
            
            renderGroupsHTML(container, groupsToShow, isClientUser);
        }
        
        function renderGroupsHTML(container, groupsToShow, isClientUser) {

            container.innerHTML = groupsToShow.map((group, index) => {
                const percentageClass = group.remainingPercentage > 50 ? '' : 
                                      group.remainingPercentage > 20 ? 'medium' : 'low';
                
                const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
                const reservationUnit = group.reservationType === 'weight' ? 'г' : 'ед.';
                const groupId = group.id || index;
                
                return `
                    <div class="product-group" id="group-${groupId}">
                        <div class="group-header" onclick="toggleGroup('${groupId}')">
                            <div>
                                <h4>
                                    <span style="flex: 1; min-width: 0; word-break: break-word;">${group.name}</span>
                                    ${group.groupCode ? `<span class="group-code-badge">${group.groupCode}</span>` : ''}
                                    ${group.status === 'rejection' ? `<span class="group-status-badge group-status-rejection">ОТКАЗ</span>` : ''}
                                    ${group.status === 'replacement' ? `<span class="group-status-badge group-status-replacement" onclick="event.stopPropagation(); showReplacementInfo('${groupId}')">ЗАМЕНА</span>` : ''}
                                </h4>
                                <div class="group-info">
                                    <span>Общее количество: ${group.originalQuantity} ${quantityUnit}</span>
                                    <span>Остаток на складе: ${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</span>
                                    ${group.supplier ? `<span>🏭 Поставщик: <strong>${group.supplier}</strong></span>` : ''}
                                    ${group.category ? `<span>📁 ${group.category}${group.subcategory ? ' / ' + group.subcategory : ''}</span>` : ''}
                                    ${group.shipmentDate ? `<span>Отгрузка: ${new Date(group.shipmentDate).toLocaleDateString()}</span>` : ''}
                                    <span>Товаров в группе: ${(group.products || []).length}</span>
                                </div>
                            </div>
                            <span class="group-expand-icon">▶</span>
                        </div>
                        <div class="group-content">
                            <div class="group-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Общее количество</div>
                                    <div class="stat-value">${group.originalQuantity} ${quantityUnit}</div>
                                </div>
                                ${!isClientUser ? `
                                <div class="stat-item">
                                    <div class="stat-label">Списание ${group.deductionType === 'percentage' ? group.deductionValue + '%' : ''}</div>
                                    <div class="stat-value">-${(group.deductionAmount || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Резервации на месяц</div>
                                    <div class="stat-value">-${(group.reservation || 0).toFixed(1)} ${reservationUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Поступило на склад</div>
                                    <div class="stat-value">${(group.originalQuantity - (group.deductionAmount || 0) - (group.reservation || 0)).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                ` : ''}
                                <div class="stat-item">
                                    <div class="stat-label">Остаток на складе</div>
                                    <div class="stat-value">${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item" style="background: linear-gradient(135deg, ${group.costPrice1 ? '#e8f5e9' : '#f5f5f5'} 0%, ${group.costPrice1 ? '#c8e6c9' : '#eeeeee'} 100%); border: 1px solid ${group.costPrice1 ? '#4caf50' : '#ccc'};">
                                    <div class="stat-label" style="color: ${group.costPrice1 ? '#2e7d32' : '#999'};">💰 Себестоимость (равн.)</div>
                                    <div class="stat-value" style="color: ${group.costPrice1 ? '#2e7d32' : '#999'};">${group.costPrice1 ? group.costPrice1 + ' RSD/кг' : '—'}</div>
                                </div>
                                <div class="stat-item" style="background: linear-gradient(135deg, ${group.costPrice2 ? '#fff3e0' : '#f5f5f5'} 0%, ${group.costPrice2 ? '#ffe0b2' : '#eeeeee'} 100%); border: 1px solid ${group.costPrice2 ? '#ff9800' : '#ccc'};">
                                    <div class="stat-label" style="color: ${group.costPrice2 ? '#e65100' : '#999'};">💰 Себестоимость (пропорц.)</div>
                                    <div class="stat-value" style="color: ${group.costPrice2 ? '#e65100' : '#999'};">${group.costPrice2 ? group.costPrice2 + ' RSD/кг' : '—'}</div>
                                </div>
                                ${!isClientUser ? `
                                <div class="stat-item">
                                    <div class="stat-label">Продано</div>
                                    <div class="stat-value">${(() => {
                                        const arrivedToWarehouse = group.originalQuantity - (group.deductionAmount || 0) - (group.reservation || 0);
                                        const currentStock = group.quantity || 0;
                                        const manualDeductions = (group.deductions || []).reduce((sum, d) => sum + (d.quantity || 0), 0);
                                        const sold = arrivedToWarehouse - currentStock - manualDeductions;
                                        return Math.max(0, sold).toFixed(1);
                                    })()} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
                                    <div class="stat-label" style="color: white;">Списано вручную</div>
                                    <div class="stat-value" style="color: white;">${(() => {
                                        if (!group.deductions || group.deductions.length === 0) return '0';
                                        const totalDeducted = group.deductions.reduce((sum, d) => sum + (d.quantity || 0), 0);
                                        return totalDeducted.toFixed(1);
                                    })()} ${quantityUnit}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Товары в группе -->
                            <div class="add-products-section">
                                <h5>Товары в группе (${(group.products || []).length})</h5>
                                <div class="products-in-group" style="margin-bottom: 20px;">
                                    ${(group.products || []).length === 0 ? 
                                        '<p style="color: #666; margin: 10px 0; text-align: center; font-style: italic;">Товары не добавлены в группу</p>' :
                                        (group.products || []).map((productInGroup, productIndex) => {
                                            // Определяем товар в зависимости от типа пользователя и структуры данных
                                            let product;
                                            if (isClientUser) {
                                                // Для клиентов: товар может быть в productInGroup.product или сам productInGroup может быть товаром
                                                product = productInGroup.product || productInGroup;
                                                // Дополнительная проверка: если у нас все еще нет валидных данных
                                                if (!product || !product.name) {
                                                    console.warn('Некорректные данные товара в группе:', productInGroup);
                                                    return '';
                                                }
                                            } else {
                                                // Для обычных пользователей: ищем по internalCode
                                                product = products.find(p => p.internalCode === productInGroup.internalCode);
                                            }
                                            return product && product.name ? `
                                                <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #007bff;">
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${product.name}</div>
                                                        <div style="font-size: 12px; color: #666;">
                                                            <span style="margin-right: 15px;"><strong>Код:</strong> ${product.code || 'Не указан'}</span>
                                                            <span style="margin-right: 15px;"><strong>Вес:</strong> ${product.weight || 0}г</span>
                                                            <span style="margin-right: 15px;"><strong>Цена:</strong> ${product.price ? formatPriceWithCurrency(product.price) : 'Не указана'}</span>
                                                            <span style="margin-right: 15px;"><strong>Количество:</strong> ${productInGroup.quantity || 1}</span>
                                                            <span><strong>Категория:</strong> ${product.category || 'Не указана'}</span>
                                                        </div>
                                                    </div>
                                                    ${!isClientUser ? `<button class="btn btn-danger btn-sm" onclick="removeProductFromGroup(${groupId}, ${productIndex})" style="margin-left: 10px;">Удалить</button>` : ''}
                                                </div>
                                            ` : '';
                                        }).join('')
                                    }
                                </div>
                                
                                ${!isClientUser ? `
                                <h5>Добавить товар</h5>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <div class="searchable-select" style="flex: 1;">
                                        <input type="text" class="searchable-input group-product-search" id="groupProductSearch-${groupId}" placeholder="Введите код или название товара..." autocomplete="off">
                                        <input type="hidden" class="group-product-code" id="groupProductCode-${groupId}" value="">
                                        <div class="dropdown-menu group-product-dropdown" id="groupProductDropdown-${groupId}"></div>
                                    </div>
                                    <button class="btn btn-primary" onclick="addProductToGroup(${groupId})" style="min-width: 100px;">Добавить</button>
                                </div>
                                ` : ''}
                            </div>
                            
                            ${!isClientUser ? `
                            <div style="margin-top: 15px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                <button class="btn btn-info" onclick="openEditWarehouseGroupModal('${groupId}')" style="background: #2196f3; border-color: #2196f3;">✏️ Редактировать</button>
                                <button class="btn btn-warning" onclick="openDeductStockModal('${groupId}')" style="background: #ff9800; border-color: #ff9800;">📉 Списать</button>
                                <button class="btn btn-primary" onclick="openDeductHistoryModal('${groupId}')" style="background: #114A9F; border-color: #114A9F;">📋 История</button>
                                <button class="btn" onclick="markGroupAsRejection('${groupId}')" style="background: #dc3545; border-color: #dc3545; color: white;">❌ Отказ</button>
                                <button class="btn" onclick="openReplacementModal('${groupId}')" style="background: #fd7e14; border-color: #fd7e14; color: white;">🔄 Замена</button>
                                <button class="btn btn-danger" onclick="deleteProductGroup('${groupId}')">🗑️ Удалить</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGroup(groupId) {
            console.log('toggleGroup вызвана для группы:', groupId);
            const groupElement = document.getElementById(`group-${groupId}`);
            console.log('groupElement:', groupElement);
            
            if (groupElement) {
                const wasExpanded = groupElement.classList.contains('group-expanded');
                groupElement.classList.toggle('group-expanded');
                const isNowExpanded = groupElement.classList.contains('group-expanded');
                
                console.log('Состояние группы:', wasExpanded ? 'была открыта' : 'была закрыта', '→', isNowExpanded ? 'теперь открыта' : 'теперь закрыта');
                
                // Проверяем содержимое группы
                const groupContent = groupElement.querySelector('.group-content');
                console.log('groupContent:', groupContent);
                
                if (groupContent) {
                    const computedStyle = window.getComputedStyle(groupContent);
                    console.log('display:', computedStyle.display);
                    
                    const productsSection = groupContent.querySelector('.products-in-group');
                    console.log('productsSection:', productsSection);
                    
                    if (productsSection) {
                        console.log('Содержимое productsSection:', productsSection.innerHTML.substring(0, 200));
                    }
                }
            } else {
                console.error('Элемент группы не найден!');
            }
        }

        function addProductToGroup(groupId) {
            const productCodeElement = document.getElementById(`groupProductCode-${groupId}`);
            const productSearchElement = document.getElementById(`groupProductSearch-${groupId}`);
            const productCode = productCodeElement.value;
            
            if (!productCode) {
                showAlert('Выберите товар!', 'warning');
                return;
            }

            const product = products.find(p => p.internalCode === productCode);
            if (!product) {
                showAlert('Товар не найден!', 'danger');
                return;
            }

            if (!product.weight || product.weight <= 0) {
                showAlert('Товар должен иметь указанный вес!', 'warning');
                return;
            }

            const group = productGroups.find(g => g.id === groupId);
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                return;
            }

            // Проверяем, не добавлен ли уже этот товар
            if (group.products.find(p => p.internalCode === productCode)) {
                showAlert('Товар уже добавлен в группу!', 'warning');
                return;
            }

            group.products.push({
                internalCode: productCode,
                addedAt: new Date().toISOString()
            });

            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;
            addLog(`Товар ${product.name} добавлен в группу ${group.name}`);
            productCodeElement.value = '';
            productSearchElement.value = '';
            renderProductGroups();
            showAlert('Товар добавлен в группу!', 'success');
        }

        function removeProductFromGroup(groupId, productIndex) {
            const group = productGroups.find(g => g.id === groupId);
            if (!group) return;

            const product = products.find(p => p.internalCode === group.products[productIndex].internalCode);
            group.products.splice(productIndex, 1);
            
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;
            addLog(`Товар ${product ? product.name : 'неизвестный'} удален из группы ${group.name}`);
            renderProductGroups();
            showAlert('Товар удален из группы!', 'success');
        }

        async function deleteProductGroup(groupId) {
            const groupIndex = productGroups.findIndex(g => String(g.id) === String(groupId));
            if (groupIndex === -1) return;

            const group = productGroups[groupIndex];
            
            // Показываем модальное окно
            const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
            const details = `
                <strong>Информация о группе:</strong>
                <div>📦 Название: ${group.name}</div>
                <div>🔢 Код группы: ${group.groupCode || '-'}</div>
                ${group.supplier ? `<div>🏭 Поставщик: ${group.supplier}</div>` : ''}
                <div>📊 Товаров в группе: ${(group.products || []).length}</div>
                <div>📦 Общее количество: ${group.originalQuantity || 0} ${quantityUnit}</div>
                <div>📦 Остаток: ${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</div>
                <div>💼 ID в базе: ${group.id || 'нет'} (${typeof group.id})</div>
            `;
            
            showDeleteConfirmModal(
                `Вы уверены, что хотите удалить группу "${group.name}"?`,
                details,
                async () => {
                    await performGroupDelete(groupIndex, group);
                }
            );
        }
        
        async function performGroupDelete(groupIndex, group) {
            console.log('🗑️ performGroupDelete для:', group.name);
            
            try {
                showLoadingIndicator(true, 'Удаление группы...');
                
                // Удаляем через API если есть ID
                if (group.id) {
                    await window.api.warehouseGroups.delete(group.id);
                }
                
                // Удаляем из локального массива
            productGroups.splice(groupIndex, 1);
            
                // Сохраняем в localStorage
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;
                
            addLog(`Удалена группа товаров: ${group.name}`);
            renderProductGroups();
            showAlert('Группа товаров удалена!', 'success');
                
                console.log('✅ Warehouse group deleted:', group.name);
                
            } catch (error) {
                console.error('❌ Failed to delete warehouse group:', error);
                
                // Fallback: удаляем локально даже если API недоступен
                productGroups.splice(groupIndex, 1);
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                window.productGroups = productGroups;
                renderProductGroups();
                
                showAlert(`❌ Ошибка при удалении группы: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }
        
        // Функция удаления инвойса (универсальная)
        async function deleteInvoice(invoiceId) {
            console.log('🗑️ deleteInvoice вызвана для ID:', invoiceId);
            
            // Находим инвойс во всех массивах
            let invoice = confirmedInvoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) {
                // Пробуем найти в отдельных массивах
                invoice = confirmedPredracuns.find(inv => inv.id === invoiceId) ||
                         confirmedRacuns.find(inv => inv.id === invoiceId) ||
                         confirmedDeliveries.find(inv => inv.id === invoiceId);
            }
            
            if (!invoice) {
                console.error('❌ Инвойс не найден в массивах:', {
                    confirmedInvoices: confirmedInvoices.length,
                    confirmedPredracuns: confirmedPredracuns.length,
                    confirmedRacuns: confirmedRacuns.length,
                    confirmedDeliveries: confirmedDeliveries.length
                });
                showAlert('Инвойс не найден', 'danger');
                return;
            }
            
            console.log('✅ Инвойс найден:', invoice);
            
            // Определяем тип документа
            const docTypeNames = {
                'racun': 'Рачун',
                'predracun': 'Предрачун',
                'delivery': 'Отпремница'
            };
            const docTypeName = docTypeNames[invoice.documentType] || 'Документ';
            
            // Показываем модальное окно
            const details = `
                <strong>Информация о документе:</strong>
                <div>📄 Тип: ${docTypeName}</div>
                <div>🔢 Номер: ${invoice.invoiceNumber || invoice.invoice_number || '-'}</div>
                <div>👤 Клиент: ${invoice.clientName || invoice.client?.name || '-'}</div>
                <div>📅 Дата: ${invoice.date ? new Date(invoice.date).toLocaleDateString() : '-'}</div>
                <div>💰 Сумма: ${invoice.total || 0} RSD</div>
                <div>📊 Статус: ${invoice.status || '-'}</div>
                <div>💼 ID в базе: ${invoice.id || 'нет'} (${typeof invoice.id})</div>
            `;
            
            showDeleteConfirmModal(
                `Вы уверены, что хотите удалить ${docTypeName.toLowerCase()} №${invoice.invoiceNumber || invoice.invoice_number}?`,
                details,
                async () => {
                    await performInvoiceDelete(invoice);
                }
            );
        }
        
        async function performInvoiceDelete(invoice) {
            console.log('🗑️ performInvoiceDelete для:', invoice.invoiceNumber || invoice.invoice_number);
            
            try {
                showLoadingIndicator(true, 'Удаление документа...');
                
                // Удаляем через API если есть ID
                if (invoice.id) {
                    await InvoicesAPI.delete(invoice.id);
                }
                
                // === УДАЛЯЕМ HTML ФАЙЛ ===
                try {
                    const invoiceNumber = invoice.invoiceNumber || invoice.invoice_number;
                    const docType = invoice.documentType || 'predracun';
                    
                    if (invoiceNumber) {
                        const docDate = new Date(invoice.date);
                        const year = docDate.getFullYear().toString();
                        const month = (docDate.getMonth() + 1).toString().padStart(2, '0');
                        
                        await window.api.invoiceHtml.delete(invoiceNumber, docType, year, month);
                        console.log('✅ HTML файл удален');
                    }
                } catch (htmlError) {
                    console.warn('⚠️ Не удалось удалить HTML файл:', htmlError);
                    // Продолжаем удаление даже если HTML не удалился
                }
                // === КОНЕЦ УДАЛЕНИЯ HTML ===
                
                // Удаляем из всех локальных массивов
                console.log('🗑️ Удаляем из локальных массивов...');
                
                // Удаляем из confirmedInvoices
                let index = confirmedInvoices.findIndex(inv => inv.id === invoice.id);
                if (index !== -1) {
                    confirmedInvoices.splice(index, 1);
                    console.log('✅ Удалено из confirmedInvoices');
                }
                
                // Удаляем из специфичных массивов
                if (invoice.documentType === 'predracun') {
                    index = confirmedPredracuns.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) {
                        confirmedPredracuns.splice(index, 1);
                        console.log('✅ Удалено из confirmedPredracuns');
                    }
                } else if (invoice.documentType === 'racun') {
                    index = confirmedRacuns.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) {
                        confirmedRacuns.splice(index, 1);
                        console.log('✅ Удалено из confirmedRacuns');
                    }
                } else if (invoice.documentType === 'delivery') {
                    index = confirmedDeliveries.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) {
                        confirmedDeliveries.splice(index, 1);
                        console.log('✅ Удалено из confirmedDeliveries');
                    }
                }
                
                // Сохраняем в localStorage
                localStorage.setItem('confirmedInvoices', JSON.stringify(confirmedInvoices));
                localStorage.setItem('confirmedPredracuns', JSON.stringify(confirmedPredracuns));
                localStorage.setItem('confirmedRacuns', JSON.stringify(confirmedRacuns));
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                console.log('💾 Сохранено в localStorage');
                
                // Обновляем глобальные переменные
                window.confirmedInvoices = confirmedInvoices;
                window.confirmedPredracuns = confirmedPredracuns;
                window.confirmedRacuns = confirmedRacuns;
                window.confirmedDeliveries = confirmedDeliveries;
                console.log('🔄 Глобальные переменные обновлены');
                
                // Обновляем UI
                updateStatistics();
                updateClientReport(); // Явно обновляем отчет по клиентам
                showAlert('Документ успешно удален!', 'success');
                
                console.log('✅ Invoice deleted:', invoice.invoiceNumber || invoice.invoice_number);
                
            } catch (error) {
                console.error('❌ Failed to delete invoice:', error);
                
                // Fallback: удаляем локально даже если API недоступен
                let index = confirmedInvoices.findIndex(inv => inv.id === invoice.id);
                if (index !== -1) {
                    confirmedInvoices.splice(index, 1);
                }
                
                if (invoice.documentType === 'predracun') {
                    index = confirmedPredracuns.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) confirmedPredracuns.splice(index, 1);
                } else if (invoice.documentType === 'racun') {
                    index = confirmedRacuns.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) confirmedRacuns.splice(index, 1);
                } else if (invoice.documentType === 'delivery') {
                    index = confirmedDeliveries.findIndex(inv => inv.id === invoice.id);
                    if (index !== -1) confirmedDeliveries.splice(index, 1);
                }
                
                localStorage.setItem('confirmedInvoices', JSON.stringify(confirmedInvoices));
                localStorage.setItem('confirmedPredracuns', JSON.stringify(confirmedPredracuns));
                localStorage.setItem('confirmedRacuns', JSON.stringify(confirmedRacuns));
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                // Обновляем глобальные переменные
                window.confirmedInvoices = confirmedInvoices;
                window.confirmedPredracuns = confirmedPredracuns;
                window.confirmedRacuns = confirmedRacuns;
                window.confirmedDeliveries = confirmedDeliveries;
                
                updateStatistics();
                updateClientReport(); // Явно обновляем отчет по клиентам
                
                showAlert(`Документ удален локально (ошибка API: ${error.message})`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        // Функция для обновления остатков при создании инвойса
        function updateGroupStockOnInvoice(invoiceItems) {
            console.log('=== updateGroupStockOnInvoice вызвана ===');
            console.log('invoiceItems:', invoiceItems);
            console.log('Количество товаров в инвойсе:', invoiceItems.length);
            
            let updated = false;
            
            invoiceItems.forEach((item, itemIndex) => {
                console.log(`\n--- Обработка товара ${itemIndex + 1} ---`);
                console.log('item:', item);
                
                // Товар хранится в item.product, а не item.code
                const product = item.product;
                console.log('product:', product);
                
                if (!product) {
                    console.warn('⚠️ Товар не найден в item.product');
                    return;
                }
                
                if (!product.weight) {
                    console.warn('⚠️ У товара нет веса:', product);
                    return;
                }
                
                console.log(`✓ Товар: ${product.name} (${product.code}), вес: ${product.weight}г, количество: ${item.quantity}`);
                
                // Находим все группы, которые содержат этот товар
                let foundInGroups = 0;
                productGroups.forEach((group, groupIndex) => {
                    const productInGroup = group.products.find(p => p.internalCode === product.internalCode);
                    
                    if (productInGroup) {
                        console.log(`  → Товар найден в группе "${group.name}" (индекс ${groupIndex})`);
                        
                        if (group.quantityType === 'weight') {
                            foundInGroups++;
                            
                            // Уменьшаем количество в группе на основе веса товара и количества в инвойсе
                            const weightUsed = product.weight * item.quantity;
                            
                            console.log(`  → Тип группы: weight`);
                            console.log(`  → Вес используемый: ${product.weight}г × ${item.quantity} = ${weightUsed}г`);
                            console.log(`  → Текущий остаток группы: ${group.quantity}г`);
                            console.log(`  → Резервация: ${item.isReservation ? 'ДА' : 'НЕТ'}`);
                            
                            // Если товар отмечен как резервация, вычитаем из резервации, иначе из обычного остатка
                            if (item.isReservation) {
                                // Вычитаем из резервации
                                const oldReservation = group.reservation || 0;
                                const newReservation = Math.max(0, oldReservation - weightUsed);
                                console.log(`  → Обновление резервации: ${oldReservation}г → ${newReservation}г (разница: -${weightUsed}г)`);
                                group.reservation = newReservation;
                            } else {
                                // Вычитаем из обычного остатка
                                const oldQuantity = group.quantity;
                                const oldCurrentQuantity = group.currentQuantity || group.quantity;
                                const newQuantity = Math.max(0, oldQuantity - weightUsed);
                                const newCurrentQuantity = Math.max(0, oldCurrentQuantity - weightUsed);
                                
                                console.log(`  → Обновление остатка (quantity): ${oldQuantity}г → ${newQuantity}г (разница: -${weightUsed}г)`);
                                console.log(`  → Обновление остатка (currentQuantity): ${oldCurrentQuantity}г → ${newCurrentQuantity}г (разница: -${weightUsed}г)`);
                                
                                group.quantity = newQuantity;
                                group.currentQuantity = newCurrentQuantity;
                            }
                            
                            // Пересчитываем процент остатка
                            const oldPercentage = group.remainingPercentage;
                            group.remainingPercentage = (group.quantity / group.originalQuantity) * 100;
                            console.log(`  → Процент остатка: ${oldPercentage?.toFixed(1)}% → ${group.remainingPercentage.toFixed(1)}%`);
                            
                            updated = true;
                        } else {
                            console.log(`  → Тип группы: ${group.quantityType} (не weight, пропускаем)`);
                        }
                    }
                });
                
                if (foundInGroups === 0) {
                    console.warn(`⚠️ Товар ${product.code} не найден ни в одной группе с типом weight`);
                } else {
                    console.log(`✓ Товар обработан в ${foundInGroups} группе(ах)`);
                }
            });
            
            console.log('\n=== Итоги обновления ===');
            console.log('Были обновления:', updated);
            
            if (updated) {
                console.log('Сохраняем productGroups в localStorage...');
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                window.productGroups = productGroups;
                console.log('✓ Сохранено');
                
                console.log('Обновляем отображение групп...');
                renderProductGroups(); // Обновляем отображение групп
                console.log('✓ Отображение обновлено');
                
                addLog(`Обновлены остатки склада после утверждения инвойса`);
            } else {
                console.warn('⚠️ Ни одна группа не была обновлена!');
            }
            
            console.log('=== updateGroupStockOnInvoice завершена ===\n');
        }

        // Модальное окно списания товаров
        let currentDeductGroupId = null;

        function openDeductStockModal(groupId) {
            currentDeductGroupId = groupId;
            const group = productGroups.find(g => String(g.id) === String(groupId));
            
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                return;
            }

            // Заполняем информацию о группе
            document.getElementById('deductGroupName').textContent = group.name;
            document.getElementById('deductGroupCode').textContent = group.groupCode ? `Код группы: ${group.groupCode}` : '';
            
            const currentStock = group.currentQuantity || group.quantity || 0;
            const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
            document.getElementById('deductGroupAvailable').textContent = `Доступно на складе: ${currentStock.toFixed(1)} ${quantityUnit}`;
            
            // Устанавливаем тип количества в соответствии с типом группы
            const deductQuantityType = document.getElementById('deductQuantityType');
            if (group.quantityType === 'weight') {
                deductQuantityType.value = 'weight';
                document.getElementById('deductQuantityUnit').textContent = 'г';
            } else {
                deductQuantityType.value = 'pieces';
                document.getElementById('deductQuantityUnit').textContent = 'ед.';
            }
            
            // Очищаем форму
            document.getElementById('deductQuantity').value = '';
            document.getElementById('deductReason').value = '';
            document.getElementById('deductComment').value = '';
            document.getElementById('deductQuantityError').style.display = 'none';
            document.getElementById('deductWarning').style.display = 'none';
            
            // Показываем модальное окно
            document.getElementById('deductStockModal').style.display = 'block';
        }

        function closeDeductStockModal() {
            document.getElementById('deductStockModal').style.display = 'none';
            currentDeductGroupId = null;
        }

        function confirmDeductStock() {
            const groupId = currentDeductGroupId;
            if (!groupId) return;

            const group = productGroups.find(g => String(g.id) === String(groupId));
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                closeDeductStockModal();
                return;
            }

            const deductQuantity = parseFloat(document.getElementById('deductQuantity').value);
            const deductReason = document.getElementById('deductReason').value;
            const deductComment = document.getElementById('deductComment').value;

            // Валидация
            if (!deductQuantity || deductQuantity <= 0) {
                document.getElementById('deductQuantityError').textContent = 'Укажите корректное количество!';
                document.getElementById('deductQuantityError').style.display = 'block';
                return;
            }

            if (!deductReason) {
                showAlert('Выберите основание списания!', 'warning');
                return;
            }

            const currentStock = group.currentQuantity || group.quantity || 0;
            
            if (deductQuantity > currentStock) {
                document.getElementById('deductQuantityError').textContent = `Недостаточно товара! Доступно: ${currentStock.toFixed(1)}`;
                document.getElementById('deductQuantityError').style.display = 'block';
                return;
            }

            // Выполняем списание сразу (без дополнительного подтверждения)
            const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
            const reasonNames = {
                'sale': 'Продажа',
                'defect': 'Брак',
                'return': 'Возврат',
                'production': 'Использовано в производстве',
                'sampling': 'Отбор проб',
                'expired': 'Истек срок годности',
                'loss': 'Потеря/убыль',
                'marketing': 'Маркетинг',
                'other': 'Другое'
            };
            
            console.log(`📉 Списываем ${deductQuantity} ${quantityUnit} из группы "${group.name}"`);

            // Выполняем списание
            const newStock = currentStock - deductQuantity;
            group.currentQuantity = newStock;
            group.quantity = newStock; // Обновляем также quantity для обратной совместимости
            group.remainingPercentage = (newStock / group.originalQuantity) * 100;

            // Сохраняем запись о списании
            if (!group.deductions) {
                group.deductions = [];
            }
            
            const deductionEntry = {
                date: new Date().toISOString(),
                quantity: deductQuantity,
                quantityType: group.quantityType,
                reason: deductReason,
                reasonName: reasonNames[deductReason],
                comment: deductComment,
                stockBefore: currentStock,
                stockAfter: newStock
            };
            
            group.deductions.push(deductionEntry);
            
            // Коды для разных оснований списания
            const reasonCodes = {
                'sale': 'PR', // Продажа
                'defect': 'BR', // Брак
                'return': 'VZ', // Возврат
                'production': 'PD', // Производство
                'sampling': 'SP', // Отбор проб
                'expired': 'SG', // Срок годности
                'loss': 'PT', // Потеря
                'marketing': 'MK', // Маркетинг
                'other': 'DR'  // Другое
            };
            
            // Создаём запись в списанных группах
            const writtenOffGroupCode = (group.groupCode || 'GRP') + '-' + (reasonCodes[deductReason] || 'SP');
            
            const writtenOffEntry = {
                id: Date.now(),
                originalId: group.id,
                groupCode: writtenOffGroupCode,
                name: group.name,
                supplier: group.supplier,
                category: group.category,
                subcategory: group.subcategory,
                quantityType: group.quantityType,
                currentQuantity: deductQuantity,
                quantity: deductQuantity,
                originalQuantity: deductQuantity,
                status: 'manual',
                writtenOffDate: new Date().toISOString(),
                writtenOffReason: `${reasonNames[deductReason]}${deductComment ? ': ' + deductComment : ''}`
            };
            
            window.writtenOffGroups.push(writtenOffEntry);
            localStorage.setItem('writtenOffGroups', JSON.stringify(window.writtenOffGroups));

            // Сохраняем изменения
            const groupIndex = productGroups.findIndex(g => String(g.id) === String(groupId));
            if (groupIndex !== -1) {
                productGroups[groupIndex] = group;
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                window.productGroups = productGroups;
            }

            // Логируем
            addLog(`Списание со склада: ${group.name} (${group.groupCode || 'без кода'}), -${deductQuantity} ${quantityUnit}, основание: ${reasonNames[deductReason]}`);

            // Обновляем отображение и закрываем окно
            renderProductGroups();
            closeDeductStockModal();
            showAlert(`Товар успешно списан! Новый остаток: ${newStock.toFixed(1)} ${quantityUnit}. Создана группа списания: ${writtenOffGroupCode}`, 'success');
        }

        // Модальное окно истории списаний
        let currentHistoryGroupId = null;

        function openDeductHistoryModal(groupId) {
            currentHistoryGroupId = groupId;
            const group = productGroups.find(g => String(g.id) === String(groupId));
            
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                return;
            }

            // Заполняем информацию о группе
            document.getElementById('historyGroupName').textContent = group.name;
            document.getElementById('historyGroupCode').textContent = group.groupCode ? `Код группы: ${group.groupCode}` : '';
            
            // Рассчитываем общее количество списанного вручную
            const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
            let totalDeducted = 0;
            
            if (group.deductions && group.deductions.length > 0) {
                totalDeducted = group.deductions.reduce((sum, d) => sum + (d.quantity || 0), 0);
            }
            
            document.getElementById('historyTotalDeducted').textContent = `${totalDeducted.toFixed(1)} ${quantityUnit}`;
            
            // Формируем список списаний
            const historyList = document.getElementById('deductHistoryList');
            
            if (!group.deductions || group.deductions.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📋</div>
                        <div style="font-size: 16px; font-weight: 500;">История списаний пуста</div>
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.8;">Списания еще не производились</div>
                    </div>
                `;
            } else {
                const reasonNames = {
                    'sale': '📦 Продажа',
                    'defect': '❌ Брак',
                    'return': '↩️ Возврат',
                    'production': '🏭 Использовано в производстве',
                    'sampling': '🧪 Отбор проб',
                    'expired': '⏰ Истек срок годности',
                    'loss': '📉 Потеря/убыль',
                    'marketing': '📢 Маркетинг',
                    'other': '📝 Другое'
                };
                
                // Сортируем по дате (новые сверху)
                const sortedDeductions = [...group.deductions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                historyList.innerHTML = sortedDeductions.map((deduction, index) => {
                    const date = new Date(deduction.date);
                    const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    const unit = deduction.quantityType === 'weight' ? 'г' : 'ед.';
                    
                    return `
                        <div style="background: white; border-radius: 10px; padding: 18px; margin-bottom: 12px; border: 1px solid #e3e8ef; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='0 2px 6px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 5px;">
                                        ${reasonNames[deduction.reason] || deduction.reasonName || 'Не указано'}
                                    </div>
                                    <div style="font-size: 13px; color: #666;">
                                        <span style="margin-right: 15px;">📅 ${dateStr}</span>
                                        <span>🕐 ${timeStr}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 22px; font-weight: 700; color: #dc3545;">-${deduction.quantity.toFixed(1)} ${unit}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: ${deduction.comment ? '12px' : '0'};">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Было на складе</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #28a745;">${deduction.stockBefore.toFixed(1)} ${unit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Осталось</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #007bff;">${deduction.stockAfter.toFixed(1)} ${unit}</div>
                                </div>
                            </div>
                            
                            ${deduction.comment ? `
                                <div style="padding: 10px 12px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #856404; text-transform: uppercase; margin-bottom: 3px; font-weight: 600;">💬 Комментарий:</div>
                                    <div style="font-size: 13px; color: #856404; line-height: 1.4;">${deduction.comment}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // Загружаем историю поступлений
            renderReceiptsHistory(group);
            
            // Сбрасываем на вкладку списаний
            switchGroupHistoryTab('deductions');
            
            // Показываем модальное окно
            document.getElementById('deductHistoryModal').style.display = 'block';
        }

        // Переключение вкладок истории группы (списания/поступления)
        function switchGroupHistoryTab(tab) {
            const tabDeductions = document.getElementById('historyTabDeductions');
            const tabReceipts = document.getElementById('historyTabReceipts');
            const contentDeductions = document.getElementById('historyContentDeductions');
            const contentReceipts = document.getElementById('historyContentReceipts');
            
            if (!tabDeductions || !tabReceipts || !contentDeductions || !contentReceipts) {
                console.error('Элементы вкладок не найдены');
                return;
            }
            
            if (tab === 'deductions') {
                tabDeductions.style.background = '#114A9F';
                tabDeductions.style.color = 'white';
                tabDeductions.style.borderBottom = '3px solid #114A9F';
                tabReceipts.style.background = 'transparent';
                tabReceipts.style.color = '#666';
                tabReceipts.style.borderBottom = '3px solid transparent';
                contentDeductions.style.display = 'block';
                contentReceipts.style.display = 'none';
            } else if (tab === 'receipts') {
                tabReceipts.style.background = '#28a745';
                tabReceipts.style.color = 'white';
                tabReceipts.style.borderBottom = '3px solid #28a745';
                tabDeductions.style.background = 'transparent';
                tabDeductions.style.color = '#666';
                tabDeductions.style.borderBottom = '3px solid transparent';
                contentDeductions.style.display = 'none';
                contentReceipts.style.display = 'block';
            }
        }

        // Рендеринг истории поступлений
        function renderReceiptsHistory(group) {
            const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
            const receiptsHistoryList = document.getElementById('receiptsHistoryList');
            
            // Собираем все поступления
            const receipts = [];
            
            // 1. Создание группы - первоначальное поступление
            const initialQuantity = group.originalQuantity || group.initialStock || group.quantity || 0;
            const initialDeduction = group.deductionAmount || 0;
            const initialReservation = group.reservation || group.reserved || 0;
            const initialStock = group.initialStock || (initialQuantity - initialDeduction - initialReservation);
            
            // Всегда показываем создание группы
            receipts.push({
                type: 'creation',
                date: group.createdAt || group.dateReceived || new Date().toISOString(),
                shipmentDate: group.originalShipmentDate || group.shipmentDate || null,
                supplier: group.supplier || null,
                originalQuantity: initialQuantity,
                quantity: initialStock,
                deduction: initialDeduction,
                deductionType: group.deductionType || 'percentage',
                deductionValue: group.deductionValue || 0,
                reserved: initialReservation,
                notes: group.notes || '',
                source: 'Создание группы',
                groupCode: group.groupCode
            });
            
            // 2. История дополнений (если есть)
            if (group.additions && group.additions.length > 0) {
                group.additions.forEach(addition => {
                    // Определяем тип поступления
                    const isShipment = addition.type === 'shipment';
                    
                    receipts.push({
                        type: isShipment ? 'shipment' : 'addition',
                        date: addition.date,
                        shipmentDate: addition.shipmentDate || null,
                        shipmentId: addition.shipmentId || null,
                        shipmentNumber: addition.shipmentNumber || null,
                        originalQuantity: addition.originalQuantity || addition.quantity || 0,
                        quantity: addition.quantity || 0,
                        quantityKg: addition.quantityKg || (addition.quantity / 1000),
                        deduction: addition.deduction || 0,
                        reservation: addition.reservation || 0,
                        stockBefore: addition.stockBefore || 0,
                        stockAfter: addition.stockAfter || 0,
                        notes: addition.notes || addition.comment || '',
                        supplier: addition.supplier || null,
                        price: addition.price || 0,
                        vatRate: addition.vatRate || 0,
                        itemCostPrice1: addition.itemCostPrice1 || 0,
                        itemCostPrice2: addition.itemCostPrice2 || 0,
                        costPrice1: addition.costPrice1 || 0,
                        costPrice2: addition.costPrice2 || 0,
                        unit: addition.unit || (group.quantityType === 'weight' ? 'г' : 'шт'),
                        source: isShipment ? `Поставка ${addition.shipmentNumber || ''}` : 'Дополнение запаса'
                    });
                });
            }
            
            // Считаем общее количество поступлений
            const totalReceipts = receipts.reduce((sum, r) => sum + (r.quantity || 0), 0);
            document.getElementById('historyTotalReceipts').textContent = `${totalReceipts.toFixed(1)} ${quantityUnit}`;
            
            if (receipts.length === 0) {
                receiptsHistoryList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📥</div>
                        <div style="font-size: 16px; font-weight: 500;">История поступлений пуста</div>
                        <div style="font-size: 14px; margin-top: 8px; opacity: 0.8;">Нет данных о поступлениях</div>
                    </div>
                `;
                return;
            }
            
            // Сортируем по дате (новые сверху)
            receipts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            receiptsHistoryList.innerHTML = receipts.map((receipt, index) => {
                const date = new Date(receipt.date);
                const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                
                // Форматируем дату отгрузки если есть
                let shipmentDateStr = '';
                if (receipt.shipmentDate) {
                    const shipDate = new Date(receipt.shipmentDate);
                    shipmentDateStr = shipDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                
                const isCreation = receipt.type === 'creation';
                const isShipment = receipt.type === 'shipment';
                
                // Цвета в зависимости от типа
                let bgColor, borderColor, icon, labelColor;
                if (isCreation) {
                    bgColor = '#e8f5e9'; borderColor = '#4caf50'; icon = '🆕'; labelColor = '#2e7d32';
                } else if (isShipment) {
                    bgColor = '#fff3e0'; borderColor = '#ff9800'; icon = '📦'; labelColor = '#e65100';
                } else {
                    bgColor = '#fff'; borderColor = '#e3e8ef'; icon = '➕'; labelColor = '#1976d2';
                }
                
                return `
                    <div style="background: ${bgColor}; border-radius: 10px; padding: 18px; margin-bottom: 12px; border: 2px solid ${borderColor}; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='0 2px 6px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: ${labelColor}; margin-bottom: 5px;">
                                    ${icon} ${receipt.source}
                                </div>
                                <div style="font-size: 13px; color: #666;">
                                    <span style="margin-right: 15px;">📅 Добавлено: ${dateStr}</span>
                                    <span>🕐 ${timeStr}</span>
                                </div>
                                ${shipmentDateStr ? `
                                    <div style="font-size: 13px; color: #1976d2; margin-top: 4px;">
                                        <span>🚚 Дата отгрузки: ${shipmentDateStr}</span>
                                    </div>
                                ` : ''}
                                ${receipt.supplier ? `
                                    <div style="font-size: 13px; color: #6f42c1; margin-top: 4px;">
                                        <span>🏭 Поставщик: ${receipt.supplier}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 22px; font-weight: 700; color: #28a745;">+${(isCreation ? (receipt.originalQuantity || receipt.quantity) : receipt.quantity).toFixed(1)} ${quantityUnit}</div>
                                ${isCreation && receipt.deduction > 0 ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">→ на склад: ${receipt.quantity.toFixed(1)} ${quantityUnit}</div>` : ''}
                                ${isShipment && receipt.quantityKg ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">(${receipt.quantityKg.toFixed(2)} кг)</div>` : ''}
                            </div>
                        </div>
                        
                        ${isCreation ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">📦 Поступило</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #2e7d32;">${(receipt.originalQuantity || receipt.quantity).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">📉 Списание при поступлении</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #dc3545;">-${(receipt.deduction || 0).toFixed(1)} ${quantityUnit} ${receipt.deductionType === 'percentage' ? '(' + (receipt.deductionValue || 0) + '%)' : ''}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 12px; background: #f0f7f0; border-radius: 8px; margin-bottom: ${receipt.notes ? '12px' : '0'};">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">🏦 Резервация</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #ff9800;">${(receipt.reserved || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">✅ На склад</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #28a745;">${receipt.quantity.toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">📊 Доступно</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #007bff;">${(receipt.quantity - (receipt.reserved || 0)).toFixed(1)} ${quantityUnit}</div>
                                </div>
                            </div>
                        ` : isShipment ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">💰 Цена закупки</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">${receipt.price ? formatPriceWithCurrency(receipt.price) + '/' + receipt.unit : '—'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">📊 НДС</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">${receipt.vatRate}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">💵 Себестоимость (этой партии)</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #e65100;">${receipt.itemCostPrice1 ? receipt.itemCostPrice1 + ' RSD/кг' : '—'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 12px; background: #fff8e1; border-radius: 8px; margin-bottom: ${receipt.notes ? '12px' : '0'};">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Было на складе</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #666;">${(receipt.stockBefore || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Стало на складе</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #28a745;">${(receipt.stockAfter || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">💵 Новая средн. себест.</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #2e7d32;">${receipt.costPrice1 ? receipt.costPrice1 + ' RSD/кг' : '—'}</div>
                                </div>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: ${receipt.notes ? '12px' : '0'};">
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Было на складе</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #666;">${(receipt.stockBefore || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px;">Стало на складе</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #28a745;">${(receipt.stockAfter || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                            </div>
                        `}
                        
                        ${receipt.notes ? `
                            <div style="padding: 10px 12px; background: ${isCreation ? 'white' : isShipment ? '#fff' : '#e3f2fd'}; border-left: 3px solid ${isCreation ? '#4caf50' : isShipment ? '#ff9800' : '#2196f3'}; border-radius: 6px;">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 3px; font-weight: 600;">📝 Примечание:</div>
                                <div style="font-size: 13px; color: #333; line-height: 1.4;">${receipt.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function closeDeductHistoryModal() {
            document.getElementById('deductHistoryModal').style.display = 'none';
            currentHistoryGroupId = null;
        }

        // Обработчик изменения типа количества в модальном окне списания
        document.addEventListener('DOMContentLoaded', function() {
            const deductQuantityType = document.getElementById('deductQuantityType');
            if (deductQuantityType) {
                deductQuantityType.addEventListener('change', function() {
                    const unit = this.value === 'weight' ? 'г' : 'ед.';
                    document.getElementById('deductQuantityUnit').textContent = unit;
                });
            }

            // Закрытие модального окна списания при клике вне его
            const deductModal = document.getElementById('deductStockModal');
            if (deductModal) {
                window.addEventListener('click', function(event) {
                    if (event.target === deductModal) {
                        closeDeductStockModal();
                    }
                });
            }

            // Закрытие модального окна истории при клике вне его
            const historyModal = document.getElementById('deductHistoryModal');
            if (historyModal) {
                window.addEventListener('click', function(event) {
                    if (event.target === historyModal) {
                        closeDeductHistoryModal();
                    }
                });
            }
        });

        // Инвойсы
        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            if(!container) return;

            const itemIndex = container.children.length;
            const newItem = document.createElement('div');
            newItem.className = 'invoice-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Товар *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                        <input type="hidden" class="invoice-product" value="">
                        <div class="dropdown-menu invoice-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Количество</label>
                    <input type="number" class="invoice-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Цена (RSD)</label>
                    <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Сумма (RSD)</label>
                    <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                </div>
                <div class="reservation-checkbox">
                    <input type="checkbox" class="invoice-reservation" id="reservation-${itemIndex}">
                    <label for="reservation-${itemIndex}">Резервация</label>
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // Инициализировать поиск для нового поля
            const newSearch = newItem.querySelector('.invoice-product-search');
            setupProductSearch(newSearch);
            addLog('Добавлен товар в инвойс');
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.invoice-items').remove();
                calculateInvoiceTotals();
            } else {
                showAlert('Должен остаться хотя бы один товар!', 'danger');
            }
        }

        // Функция форматирования цен с двумя десятичными знаками
        function formatPrice(price) {
            const numPrice = parseFloat(price) || 0;
            return numPrice.toFixed(2);
        }

        // Функция форматирования цен с разделителями тысяч и двумя десятичными знаками
        function formatPriceWithThousands(price) {
            const numPrice = parseFloat(price) || 0;
            return numPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Функция форматирования цен с валютой
        function formatPriceWithCurrency(price) {
            return formatPrice(price) + ' RSD';
        }

        // Функция форматирования цен с валютой и разделителями тысяч
        function formatPriceWithCurrencyAndThousands(price) {
            return formatPriceWithThousands(price) + ' RSD';
        }

        function calculateInvoiceTotals() {
            const amounts = document.querySelectorAll('.invoice-amount');
            let subtotal = 0;
            amounts.forEach(input => subtotal += parseFloat(input.value) || 0);
            
            const vatRate = parseFloat(document.getElementById('invoiceVAT').value) || 0;
            const vatAmount = subtotal * (vatRate / 100);
            const total = subtotal + vatAmount;

            document.getElementById('invoiceSubtotal').textContent = formatPriceWithCurrency(subtotal);
            document.getElementById('invoiceVATAmount').textContent = formatPriceWithCurrency(vatAmount);
            document.getElementById('invoiceTotal').textContent = formatPriceWithCurrency(total);
        }

        function generateInvoice() {
            console.log('=== generateInvoice вызвана ===');
            
            // Валидация полей инвойса с новой системой
            const invoiceFields = [
                { id: 'invoiceNumber', name: 'Номер инвойса', type: 'required' },
                { id: 'invoiceDate', name: 'Дата инвойса', type: 'date' },
                { id: 'invoiceDueDate', name: 'Дата платежа', type: 'date' },
                { id: 'invoiceClient', name: 'Клиент', type: 'required' },
                { id: 'invoiceVAT', name: 'НДС', type: 'number' }
            ];
            
            console.log('Валидация формы...');
            const validation = validateForm(invoiceFields);
            console.log('Результат валидации:', validation);
            
            if (!validation.isValid) {
                console.error('Валидация не прошла:', validation.errors);
                showAlert('Ошибки валидации:\n' + validation.errors.join('\n'), 'danger');
                return;
            }
            
            console.log('✅ Валидация прошла успешно');

            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const vatRate = document.getElementById('invoiceVAT').value;
            const reference = document.getElementById('invoiceReference').value.trim();

            console.log('Собранные данные формы:', {
                invoiceNumber,
                invoiceDate,
                invoiceDueDate,
                clientIndex,
                delivery,
                vatRate
            });

            console.log('Проверка товаров...');
            console.log('invoiceItems (глобальный массив):', invoiceItems);
            
            const items = [];
            
            // Используем глобальный массив invoiceItems если он не пустой
            if (invoiceItems && invoiceItems.length > 0) {
                console.log('Используем глобальный массив invoiceItems');
                invoiceItems.forEach((item, index) => {
                    console.log(`  Товар ${index}:`, item);
                    items.push({
                        product: item.product,
                        quantity: item.quantity,
                        price: item.price,
                        amount: item.quantity * item.price * (1 - (item.discount || 0) / 100),
                        discount: item.discount || 0,
                        isReservation: item.isReservation || false
                    });
                });
            } else {
                // Fallback: используем старую систему с DOM элементами
                console.log('Используем старую систему с DOM элементами');
                const itemRows = document.querySelectorAll('.invoice-items');
                console.log('Найдено строк товаров:', itemRows.length);
                
                itemRows.forEach((row, index) => {
                    const hiddenProduct = row.querySelector('.invoice-product');
                    const productIndex = hiddenProduct.value;
                    const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                    const amount = parseFloat(row.querySelector('.invoice-amount').value) || 0;
                    const isReservation = row.querySelector('.invoice-reservation')?.checked || false;

                    console.log(`  Строка ${index}: productIndex=${productIndex}, quantity=${quantity}`);

                    if (productIndex !== '' && quantity > 0) {
                        const product = products[productIndex];
                        items.push({
                            product: product,
                            quantity: quantity,
                            price: product.price,
                            amount: amount,
                            isReservation: isReservation
                        });
                    }
                });
            }

            console.log('Всего товаров для инвойса:', items.length);

            if (items.length === 0) {
                console.error('Нет товаров для создания инвойса!');
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            const client = clients[clientIndex];
            
            // Проверяем адрес доставки
            let deliveryAddress = client.address;
            const isDifferentAddress = document.getElementById('differentDeliveryAddress').checked;
            
            if (isDifferentAddress) {
                const deliveryCity = document.getElementById('deliveryCity').value.trim();
                const deliveryMunicipality = document.getElementById('deliveryMunicipality').value.trim();
                const deliveryStreet = document.getElementById('deliveryStreet').value.trim();
                const deliveryHouseNumber = document.getElementById('deliveryHouseNumber').value.trim();
                
                if (!deliveryCity || !deliveryMunicipality || !deliveryStreet) {
                    showAlert('Заполните все поля адреса доставки!', 'danger');
                    return;
                }
                
                deliveryAddress = `${deliveryCity}, ${deliveryMunicipality}, ${deliveryStreet}`;
                if (deliveryHouseNumber) {
                    deliveryAddress += ` ${deliveryHouseNumber}`;
                }
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vatAmount = subtotal * (parseFloat(vatRate) / 100);
            const total = subtotal + vatAmount;

            // Получаем сумму оплаты из поля
            const paymentAmount = parseFloat(document.getElementById('predracunPayment').value) || total;

            currentInvoiceData = {
                number: invoiceNumber,
                date: invoiceDate,
                dueDate: invoiceDueDate,
                client: client,
                items: items,
                delivery: delivery,
                deliveryAddress: deliveryAddress,
                isDifferentDeliveryAddress: isDifferentAddress,
                vatRate: parseFloat(vatRate),
                reference: reference,
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                documentType: 'predracun', // Тип документа: предрачун
                paymentInfo: {
                    amountToPay: paymentAmount // За уплату
                }
            };

            const invoiceHTML = generateInvoiceHTML(currentInvoiceData);
            document.getElementById('invoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('invoiceConfirmMessage').style.display = 'none';
            
            // Обновляем текст кнопки утверждения
            updateConfirmButtonText('predracun');
        }

        function generateInvoiceHTML(invoice) {
            // Определяем заголовок документа в зависимости от типа
            console.log('→ generateInvoiceHTML вызвана');
            console.log('  invoice.documentType:', invoice.documentType);
            const documentTitle = (invoice.documentType === 'racun') ? 'Račun' : 'Predračun';
            console.log('  Установлен заголовок:', documentTitle);
            
            let itemsHTML = '';
            invoice.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px;">${formatPriceWithCurrencyAndThousands(item.price)}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px; font-weight: bold;">${formatPriceWithCurrencyAndThousands(item.amount)}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <!-- Заголовок с логотипом -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Studentski Trg 4</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">${documentTitle}</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${invoice.number}</p>
                            <div style="margin-top: 12px;">
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Datum:</strong> ${new Date(invoice.date).toLocaleDateString('sr-RS', { day: 'numeric', month: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Datum dospeća:</strong> ${new Date(invoice.dueDate).toLocaleDateString('sr-RS', { day: 'numeric', month: 'numeric', year: 'numeric' })}</p>
                                ${invoice.paymentInfo ? `
                                    ${invoice.documentType === 'predracun' ? `
                                        <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>За уплату:</strong> ${formatPriceWithCurrencyAndThousands(invoice.paymentInfo.amountToPay)}</p>
                                    ` : `
                                        <p style="margin: 2px 0; font-size: 11px; color: #333;"><strong>Плаћено:</strong> ${formatPriceWithCurrencyAndThousands(invoice.paymentInfo.paidBefore)}</p>
                                        <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>За уплату:</strong> ${formatPriceWithCurrencyAndThousands(invoice.paymentInfo.remaining)}</p>
                                    `}
                                ` : `
                                    <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>За уплату:</strong> ${formatPriceWithCurrencyAndThousands(invoice.total)}</p>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Информация о клиенте и доставке -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Poručioc:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ')[0]}</p>
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ').slice(1).join(' ')}</p>
                                ${invoice.client.contact && invoice.client.contact.includes('Ugostiteljska') ? '<p style="margin: 0;">Ugostiteljska radnja</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Seal') ? '<p style="margin: 0;">Seal</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Tea') ? '<p style="margin: 0;">& Tea</p>' : ''}
                                <p style="margin: 0;">${invoice.client.address.split(',')[1] ? invoice.client.address.split(',')[1].trim() : 'Novi Sad'}</p>
                                <p style="margin: 0;">Matični broj: ${invoice.client.mb}</p>
                                <p style="margin: 0;">PIB: ${invoice.client.pib}</p>
                                <p style="margin: 0;">Sedište: ${invoice.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Isporuka na adresu::</h4>
                            <p style="margin: 0; font-size: 10px;">${invoice.deliveryAddress || invoice.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Način:</strong> ${invoice.delivery}</p>
                        </div>
                    </div>

                    <!-- Таблица товаров -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Proizvod</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">količina</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">cena</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">iznos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <!-- Итоги -->
                    <div style="text-align: right; margin-bottom: 15px;">
                        <div style="display: inline-block; text-align: right;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>Međuzbir:</strong> ${formatPriceWithCurrencyAndThousands(invoice.subtotal)}</p>
                            <p style="margin: 2px 0; font-size: 12px;"><strong>PDV (${invoice.vatRate}%):</strong> ${formatPriceWithCurrencyAndThousands(invoice.vatAmount)}</p>
                            <p style="margin: 6px 0 2px 0; font-size: 14px; font-weight: bold; color: #333;"><strong>Ukupno:</strong> ${formatPriceWithCurrencyAndThousands(invoice.total)}</p>
                        </div>
                    </div>
                    
                    <!-- Банковские реквизиты -->
                    <div style="margin-top: 15px;">
                        <h4 style="margin: 0 0 4px 0; font-size: 10px;">Podaci o računima za prijem naknade :</h4>
                        <p style="margin: 1px 0; font-size: 10px;">Broj računa: 190-0000000085540-29</p>
                        <p style="margin: 1px 0; font-size: 10px;">Kod: Alta Banka ad Beograd</p>
                        <p style="margin: 1px 0; font-size: 10px;">Adresa banke: Beograd, Novi Beograd, Bulevar Zorana Đinđića 121</p>
                        <p style="margin: 8px 0 1px 0; font-size: 10px;">Plaćanje sa pozivom na broj: ${invoice.reference || 'ATSNS' + invoice.number.replace(/-/g, '')}</p>
                    </div>
                    
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                    </style>
                </div>
            `;
        }

        // Функция для логирования в debug блок инвойса
        function logInvoiceDebug(message, color = '#0f0') {
            const debugBlock = document.getElementById('invoiceDebugBlock');
            const debugContent = document.getElementById('invoiceDebugContent');
            if (debugBlock && debugContent) {
                // Логи скрыты - не показываем блок
                // debugBlock.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString('ru-RU');
                const logLine = `[${timestamp}] ${message}\n`;
                debugContent.innerHTML += `<span style="color: ${color}">${logLine}</span>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            console.log(message);
        }

        async function confirmInvoice(forcedDocumentType) {
            logInvoiceDebug('=== ПОДТВЕРЖДЕНИЕ ДОКУМЕНТА ===', '#ff0');
            console.log('=== ПОДТВЕРЖДЕНИЕ ДОКУМЕНТА ===');
            console.log('currentInvoiceData:', currentInvoiceData);
            console.log('forcedDocumentType:', forcedDocumentType);
            
            if (!currentInvoiceData) { 
                console.error('Нет данных документа!');
                logInvoiceDebug('❌ ОШИБКА: Нет данных документа!', '#f00');
                showAlert('Нет данных документа!', 'danger'); 
                return; 
            }
            
            logInvoiceDebug(`📄 Тип документа: ${forcedDocumentType || 'predracun'}`, '#0ff');
            
            // Используем принудительный тип или берем из данных документа
            const documentType = forcedDocumentType || currentInvoiceData.documentType || 'predracun';
            console.log('Тип документа для утверждения:', documentType);
            console.log('Текущие данные документа:', currentInvoiceData);
            
            // ВАЖНО: Обновляем тип документа в currentInvoiceData
            currentInvoiceData.documentType = documentType;
            
            // Проверяем, не утвержден ли уже этот документ
            let targetArray, storageKey, documentName;
            
            if (documentType === 'racun') {
                targetArray = confirmedRacuns;
                storageKey = 'confirmedRacuns';
                documentName = 'Рачун';
                console.log('→ Будет сохранен как РАЧУН');
            } else {
                targetArray = confirmedPredracuns;
                storageKey = 'confirmedPredracuns';
                documentName = 'Предрачун';
                console.log('→ Будет сохранен как ПРЕДРАЧУН');
            }
            
            console.log(`Текущие утвержденные ${documentName.toLowerCase()}ы:`, targetArray);
            
            if (targetArray.find(doc => doc.number === currentInvoiceData.number)) { 
                console.error(`${documentName} уже утвержден:`, currentInvoiceData.number);
                showAlert(`${documentName} уже утвержден!`, 'danger'); 
                return; 
            }
            
            // Проверяем, не был ли уже утвержден документ с таким же номером
            // (чтобы избежать двойного списания при утверждении Предрачуна и Рачуна)
            const sameNumberInPredracuns = confirmedPredracuns.find(doc => doc.number === currentInvoiceData.number);
            const sameNumberInRacuns = confirmedRacuns.find(doc => doc.number === currentInvoiceData.number);
            
            const alreadyProcessed = (documentType === 'racun' && sameNumberInPredracuns) || 
                                    (documentType === 'predracun' && sameNumberInRacuns);
            
            if (alreadyProcessed) {
                console.log('⚠️ ВНИМАНИЕ: Документ с номером', currentInvoiceData.number, 'уже был утвержден ранее');
                console.log('Пропускаем обновление остатков склада (избегаем двойного списания)');
            } else {
                // Обновляем остатки в группах товаров только если это первый документ с таким номером
                console.log('Обновляем остатки товаров...');
                updateGroupStockOnInvoice(currentInvoiceData.items);
            }
            
            // Обновляем запасы чая при утверждении
            console.log('Обновляем запасы чая...');
            updateTeaStocksOnInvoiceApproval(currentInvoiceData.items);
            
            // Списываем связанные расходники при утверждении инвойса
            if (!alreadyProcessed) {
                console.log('Списываем расходники...');
                deductConsumablesOnInvoice(currentInvoiceData.items);
            }
            
            // Создаем копию документа с полной структурой данных для копирования
            const newDocument = { 
                ...currentInvoiceData,
                confirmedDate: new Date().toISOString(),
                status: 'confirmed',
                clientStatus: null, // Ожидает действия клиента
                documentType: documentType,
                // Убеждаемся что items - это массив с полной структурой
                items: currentInvoiceData.items.map(item => ({
                    product: {
                        internalCode: item.product?.internalCode || item.internalCode,
                        code: item.product?.code || item.code,
                        name: item.product?.name || item.name,
                        price: item.product?.price || item.price,
                        weight: item.product?.weight,
                        category: item.product?.category
                    },
                    quantity: item.quantity,
                    price: item.price,
                    amount: item.amount,
                    discount: item.discount || 0,
                    isReservation: item.isReservation || false
                }))
            };
            
            console.log(`Добавляем новый ${documentName.toLowerCase()}:`, newDocument);
            console.log('Структура items:', newDocument.items);
            
            // === НОВЫЙ КОД: Отправляем на API ===
            try {
                logInvoiceDebug(`💾 Начинаем сохранение ${documentName.toLowerCase()}а...`, '#ff0');
                showLoadingIndicator(true, `Сохранение ${documentName.toLowerCase()}а...`);
                
                // Подготавливаем данные для API - разделяем invoice и items
                // Добавляем префикс к номеру в зависимости от типа документа
                let invoiceNumberWithPrefix = newDocument.number;
                if (documentType === 'predracun' && !invoiceNumberWithPrefix.startsWith('p')) {
                    invoiceNumberWithPrefix = 'p' + invoiceNumberWithPrefix;
                } else if (documentType === 'delivery' && !invoiceNumberWithPrefix.startsWith('o')) {
                    invoiceNumberWithPrefix = 'o' + invoiceNumberWithPrefix;
                }
                // racun остается без префикса
                
                const invoice = {
                    invoiceNumber: invoiceNumberWithPrefix,
                    documentType: documentType, // 'racun' или 'predracun'
                    date: newDocument.date,
                    dueDate: newDocument.dueDate || null,
                    clientId: String(newDocument.client?.mb || newDocument.client?.id || newDocument.clientId || ''),
                    clientName: newDocument.client?.name || newDocument.clientName || '',
                    total: newDocument.total || 0,
                    status: 'confirmed',
                    notes: newDocument.notes || ''
                };
                
                const items = newDocument.items.map(item => ({
                    invoiceId: '',  // Будет установлен на сервере
                    productId: String(item.product?.internalCode || item.internalCode || item.product?.code || item.code || ''),
                    productName: item.product?.name || item.name || '',
                    quantity: item.quantity || 0,
                    price: item.price || 0,
                    total: item.amount || 0
                }));
                
                logInvoiceDebug(`📤 Отправляем invoice #${invoice.invoiceNumber} (${invoice.documentType})`, '#0ff');
                logInvoiceDebug(`   Клиент: ${invoice.clientName}`, '#0ff');
                logInvoiceDebug(`   Позиций: ${items.length}, Сумма: ${invoice.total}`, '#0ff');
                console.log('📤 Отправляем на сервер invoice:', invoice);
                console.log('📤 Отправляем на сервер items:', items);
                
                const response = await InvoicesAPI.create({ invoice, items });
                
                // Добавляем ID от сервера
                newDocument.id = response.invoice.id;
                
                logInvoiceDebug(`✅ ${documentName} сохранен с ID: ${response.invoice.id}`, '#0f0');
                console.log(`✅ ${documentName} сохранен на сервере с ID:`, response.invoice.id);
                showStatus(`✅ ${documentName} сохранен в базу данных`, '#00ff00');
                
                // === СОХРАНЕНИЕ HTML ФАЙЛА ===
                try {
                    logInvoiceDebug(`💾 Сохраняем HTML версию...`, '#ff0');
                    
                    // Получаем HTML содержимое инвойса
                    const invoiceContent = document.getElementById('invoiceContent')?.innerHTML || '';
                    
                    if (invoiceContent) {
                        // Создаем полный HTML документ
                        const fullHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${documentName} ${newDocument.number}</title>
    <style>
        @page {
            size: A4;
            margin: 15mm;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    ${invoiceContent}
</body>
</html>`;
                        
                        // Определяем год и месяц
                        const invoiceDate = new Date(newDocument.date);
                        const year = invoiceDate.getFullYear().toString();
                        const month = (invoiceDate.getMonth() + 1).toString().padStart(2, '0');
                        
                        // Сохраняем через API
                        const htmlPath = await window.api.invoiceHtml.save(
                            invoiceNumberWithPrefix,
                            documentType,
                            year,
                            month,
                            fullHTML
                        );
                        
                        logInvoiceDebug(`✅ HTML сохранен: ${htmlPath}`, '#0f0');
                        console.log(`✅ HTML файл сохранен:`, htmlPath);
                    } else {
                        console.warn('⚠️ Содержимое инвойса не найдено, HTML не сохранен');
                    }
                } catch (htmlError) {
                    console.error('❌ Ошибка сохранения HTML:', htmlError);
                    logInvoiceDebug(`⚠️ HTML не сохранен: ${htmlError.message}`, '#fa0');
                    // Не прерываем процесс, просто логируем ошибку
                }
                // === КОНЕЦ СОХРАНЕНИЯ HTML ===
                
            } catch (error) {
                logInvoiceDebug(`❌ ОШИБКА сохранения: ${error.message}`, '#f00');
                console.error(`❌ Failed to save ${documentName.toLowerCase()} to API:`, error);
                showAlert(`Предупреждение: ${documentName} не сохранен на сервер (${error.message})`, 'warning');
                // Продолжаем с локальным сохранением
            } finally {
                showLoadingIndicator(false);
            }
            // === КОНЕЦ НОВОГО КОДА ===
            
            targetArray.push(newDocument);
            
            // Также сохраняем в общий массив confirmedInvoices для обратной совместимости
            confirmedInvoices.push(newDocument);
            
            console.log('Сохраняем в localStorage...');
            console.log(`Всего ${documentName.toLowerCase()}ов для сохранения:`, targetArray.length);
            
            try {
                // Сохраняем в специфичный массив
                localStorage.setItem(storageKey, JSON.stringify(targetArray));
                console.log(`${documentName}ы успешно сохранены в localStorage`);
                
                // Сохраняем также в общий массив
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
                console.log('Общий массив инвойсов обновлен');
                
                // Проверяем, что данные действительно сохранились
                const saved = localStorage.getItem(storageKey);
                const parsed = JSON.parse(saved);
                console.log(`Проверка: количество сохраненных ${documentName.toLowerCase()}ов:`, parsed.length);
                
            } catch (error) {
                console.error('Ошибка сохранения в localStorage:', error);
                showAlert(`Ошибка сохранения ${documentName.toLowerCase()}а!`, 'danger');
                return;
            }
            
            // Обновляем глобальные переменные
            if (documentType === 'racun') {
                window.confirmedRacuns = confirmedRacuns;
            } else {
                window.confirmedPredracuns = confirmedPredracuns;
            }
            window.confirmedInvoices = confirmedInvoices;
            console.log('Глобальные переменные обновлены');
            
            updateStatistics();
            document.getElementById('invoiceConfirmMessage').style.display = 'block';
            showAlert(`${documentName} утвержден и добавлен в историю клиента!`, 'success');
            
            // Сбрасываем текст кнопки на значение по умолчанию
            updateConfirmButtonText('predracun');
            
            console.log('=== ПОДТВЕРЖДЕНИЕ ЗАВЕРШЕНО ===');
        }

        // Функция для обновления текста и логики кнопки утверждения
        function updateConfirmButtonText(documentType) {
            const btn = document.getElementById('confirmInvoiceBtn');
            if (!btn) {
                console.warn('Кнопка confirmInvoiceBtn не найдена');
                return;
            }
            
            if (documentType === 'racun') {
                btn.textContent = 'Утвердить рачун';
                btn.className = 'btn btn-success';
                btn.onclick = function() { confirmInvoice('racun'); };
                console.log('✓ Кнопка настроена на утверждение РАЧУНА');
            } else {
                btn.textContent = 'Утвердить предрачун';
                btn.className = 'btn btn-success';
                btn.onclick = function() { confirmInvoice('predracun'); };
                console.log('✓ Кнопка настроена на утверждение ПРЕДРАЧУНА');
            }
        }

        // ============================================
        // ФУНКЦИИ ДЛЯ СОЗДАНИЯ РАЧУНА
        // ============================================

        function generateRacun() {
            // Валидация полей инвойса (используем те же поля формы)
            const invoiceFields = [
                { id: 'invoiceNumber', name: 'Номер рачуна', type: 'required' },
                { id: 'invoiceDate', name: 'Дата рачуна', type: 'date' },
                { id: 'invoiceDueDate', name: 'Дата платежа', type: 'date' },
                { id: 'invoiceClient', name: 'Клиент', type: 'required' },
                { id: 'invoiceVAT', name: 'НДС', type: 'number' }
            ];
            
            const validation = validateForm(invoiceFields);
            if (!validation.isValid) {
                showAlert('Ошибки валидации:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const vatRate = document.getElementById('invoiceVAT').value;
            const reference = document.getElementById('invoiceReference').value.trim();

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                const amount = parseFloat(row.querySelector('.invoice-amount').value) || 0;
                const isReservation = row.querySelector('.invoice-reservation')?.checked || false;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        price: product.price,
                        amount: amount,
                        isReservation: isReservation
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            const client = clients[clientIndex];
            
            // Проверяем адрес доставки
            let deliveryAddress = client.address;
            const isDifferentAddress = document.getElementById('differentDeliveryAddress').checked;
            
            if (isDifferentAddress) {
                const deliveryCity = document.getElementById('deliveryCity').value.trim();
                const deliveryMunicipality = document.getElementById('deliveryMunicipality').value.trim();
                const deliveryStreet = document.getElementById('deliveryStreet').value.trim();
                const deliveryHouseNumber = document.getElementById('deliveryHouseNumber').value.trim();
                
                if (!deliveryCity || !deliveryMunicipality || !deliveryStreet) {
                    showAlert('Заполните все поля адреса доставки!', 'danger');
                    return;
                }
                
                deliveryAddress = `${deliveryCity}, ${deliveryMunicipality}, ${deliveryStreet}`;
                if (deliveryHouseNumber) {
                    deliveryAddress += ` ${deliveryHouseNumber}`;
                }
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vatAmount = subtotal * (parseFloat(vatRate) / 100);
            const total = subtotal + vatAmount;

            // Получаем сумму оплаты из поля (плаћено)
            const paidAmount = parseFloat(document.getElementById('predracunPayment').value) || 0;
            const remaining = total - paidAmount;

            currentInvoiceData = {
                number: invoiceNumber,
                date: invoiceDate,
                dueDate: invoiceDueDate,
                client: client,
                items: items,
                delivery: delivery,
                deliveryAddress: deliveryAddress,
                isDifferentDeliveryAddress: isDifferentAddress,
                vatRate: parseFloat(vatRate),
                reference: reference,
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                paymentInfo: {
                    paidBefore: paidAmount,  // Плаћено
                    remaining: remaining      // За уплату
                }
            };

            // ВАЖНО: Устанавливаем тип документа КАК РАЧУН
            currentInvoiceData.documentType = 'racun';
            console.log('✓ documentType установлен как:', currentInvoiceData.documentType);

            const racunHTML = generateInvoiceHTML(currentInvoiceData);
            document.getElementById('invoiceContent').innerHTML = racunHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('invoiceConfirmMessage').style.display = 'none';
            
            // Обновляем кнопку утверждения для РАЧУНА
            console.log('→ Обновление кнопки утверждения для РАЧУНА...');
            updateConfirmButtonText('racun');
            
            console.log('=== РАЧУН СГЕНЕРИРОВАН ЧЕРЕЗ КНОПКУ ===');
            showAlert('Рачун сгенерирован! Нажмите "Утвердить рачун" для сохранения.', 'success');
        }

        function generateRacunHTML(invoice) {
            let itemsHTML = '';
            invoice.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px;">${formatPriceWithCurrencyAndThousands(item.price)}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px; font-weight: bold;">${formatPriceWithCurrencyAndThousands(item.amount)}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <!-- Заголовок с логотипом -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Studentski Trg 4</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">Рачун</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${invoice.number}</p>
                            <div style="margin-top: 12px;">
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>Balance Due:</strong> ${formatPriceWithCurrencyAndThousands(invoice.total)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Информация о клиенте и доставке -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Poručioc:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ')[0]}</p>
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ').slice(1).join(' ')}</p>
                                ${invoice.client.contact && invoice.client.contact.includes('Ugostiteljska') ? '<p style="margin: 0;">Ugostiteljska radnja</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Seal') ? '<p style="margin: 0;">Seal</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Tea') ? '<p style="margin: 0;">& Tea</p>' : ''}
                                <p style="margin: 0;">${invoice.client.address.split(',')[1] ? invoice.client.address.split(',')[1].trim() : 'Novi Sad'}</p>
                                <p style="margin: 0;">Matični broj: ${invoice.client.mb}</p>
                                <p style="margin: 0;">PIB: ${invoice.client.pib}</p>
                                <p style="margin: 0;">Sedište: ${invoice.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Isporuka na adresu::</h4>
                            <p style="margin: 0; font-size: 10px;">${invoice.deliveryAddress || invoice.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Način:</strong> ${invoice.delivery}</p>
                        </div>
                    </div>

                    <!-- Таблица товаров -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Proizvod</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">količina</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">cena</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">iznos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <!-- Итоги -->
                    <div style="text-align: right; margin-bottom: 15px;">
                        <div style="display: inline-block; text-align: right;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>Međuzbir:</strong> ${formatPriceWithCurrencyAndThousands(invoice.subtotal)}</p>
                            <p style="margin: 2px 0; font-size: 12px;"><strong>PDV (${invoice.vatRate}%):</strong> ${formatPriceWithCurrencyAndThousands(invoice.vatAmount)}</p>
                            <p style="margin: 6px 0 2px 0; font-size: 14px; font-weight: bold; color: #333;"><strong>Ukupno:</strong> ${formatPriceWithCurrencyAndThousands(invoice.total)}</p>
                        </div>
                    </div>
                    
                    <!-- Банковские реквизиты -->
                    <div style="margin-top: 15px;">
                        <h4 style="margin: 0 0 4px 0; font-size: 10px;">Podaci o računima za prijem naknade :</h4>
                        <p style="margin: 1px 0; font-size: 10px;">Broj računa: 190-0000000085540-29</p>
                        <p style="margin: 1px 0; font-size: 10px;">Kod: Alta Banka ad Beograd</p>
                        <p style="margin: 1px 0; font-size: 10px;">Adresa banke: Beograd, Novi Beograd, Bulevar Zorana Đinđića 121</p>
                        <p style="margin: 8px 0 1px 0; font-size: 10px;">Plaćanje sa pozivom na broj: ${invoice.reference || 'ATSNS' + invoice.number.replace(/-/g, '')}</p>
                    </div>
                    
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                    </style>
                </div>
            `;
        }

        function exportInvoiceToPDF() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            // Определяем название документа в зависимости от типа
            const documentType = currentInvoiceData?.documentType || 'predracun';
            const documentName = (documentType === 'racun') ? 'Račun' : 'Predračun';
            console.log('→ Экспорт PDF, тип документа:', documentType, 'название:', documentName);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${documentName} ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // Создаем временное окно для печати
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                // Ждем загрузки содержимого и запускаем печать
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // Автоматически закрываем окно после печати (если пользователь не отменил)
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback для браузеров, блокирующих попапы
                downloadInvoiceAsHTML();
            }
            
            showAlert('Инвойс готов для экспорта!', 'success');
        }

        function downloadInvoiceAsHTML() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            // Определяем название документа в зависимости от типа
            const documentType = currentInvoiceData?.documentType || 'predracun';
            const documentName = (documentType === 'racun') ? 'Račun' : 'Predračun';
            console.log('→ Скачивание HTML, тип документа:', documentType, 'название:', documentName);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${documentName} ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // Создаем blob и скачиваем файл
            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${documentName}_${currentInvoiceData.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Освобождаем память
            URL.revokeObjectURL(url);
            showAlert(`HTML файл ${documentName.toLowerCase()}а скачан!`, 'success');
        }

        function copyInvoiceToClipboard() {
            const invoiceContent = document.getElementById('invoiceContent');
            if (!invoiceContent) {
                showAlert('Нет содержимого для копирования!', 'danger');
                return;
            }

            // Создаем временный элемент для копирования
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = invoiceContent.innerHTML;
            
            // Убираем стили для чистого текста
            const textContent = tempDiv.innerText || tempDiv.textContent;
            
            // Пытаемся скопировать в буфер обмена
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textContent).then(() => {
                    showAlert('Инвойс скопирован в буфер обмена!', 'success');
                }).catch(err => {
                    console.error('Ошибка копирования:', err);
                    fallbackCopyTextToClipboard(textContent);
                });
            } else {
                fallbackCopyTextToClipboard(textContent);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('Инвойс скопирован в буфер обмена!', 'success');
                } else {
                    showAlert('Не удалось скопировать в буфер обмена', 'danger');
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                showAlert('Не удалось скопировать в буфер обмена', 'danger');
            }
            
            document.body.removeChild(textArea);
        }

        function generateDeliveryFromInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const reference = document.getElementById('invoiceReference').value.trim();

            if (!invoiceNumber || !invoiceDate || !invoiceDueDate || clientIndex === '') {
                showAlert('Сначала заполните данные инвойса!', 'danger');
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const productIndex = row.querySelector('.invoice-product').value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                const isReservation = row.querySelector('.invoice-reservation')?.checked || false;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        isReservation: isReservation
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте товары в инвойс!', 'danger');
                return;
            }

            showTab('invoice');
            switchInvoiceInnerTab('delivery-form');
            
            // Генерируем уникальный номер для отпремницы
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
            document.getElementById('deliveryDate').value = invoiceDate;
            document.getElementById('deliveryDueDate').value = invoiceDueDate;
            document.getElementById('deliveryClient').value = clientIndex;
            document.getElementById('deliveryMethod').value = delivery;
            
            // Копируем адрес доставки если он отличается от адреса компании
            const isDifferentAddress = document.getElementById('differentDeliveryAddress').checked;
            if (isDifferentAddress) {
                // Получаем данные адреса доставки из инвойса
                const invoiceDeliveryCity = document.getElementById('deliveryCity').value;
                const invoiceDeliveryMunicipality = document.getElementById('deliveryMunicipality').value;
                const invoiceDeliveryStreet = document.getElementById('deliveryStreet').value;
                const invoiceDeliveryHouseNumber = document.getElementById('deliveryHouseNumber')?.value || '';
                
                // Включаем чекбокс другого адреса в отпремнице
                const otpremnicaCheckbox = document.getElementById('otpremnicaDifferentAddress');
                if (otpremnicaCheckbox) {
                    otpremnicaCheckbox.checked = true;
                    
                    // Показываем секцию адреса доставки
                    const section = document.getElementById('otpremnicaDeliveryAddressSection');
                    if (section) {
                        section.style.display = 'block';
                    }
                    
                    // Инициализируем поиск адресов
                    initializeOtpremnicaDeliveryAddressSearch();
                    
                    // Копируем данные в поля отпремницы
                    if (invoiceDeliveryCity) {
                        document.getElementById('otpremnicaDeliveryCity').value = invoiceDeliveryCity;
                        document.getElementById('otpremnicaDeliveryMunicipality').disabled = false;
                    }
                    if (invoiceDeliveryMunicipality) {
                        document.getElementById('otpremnicaDeliveryMunicipality').value = invoiceDeliveryMunicipality;
                        document.getElementById('otpremnicaDeliveryStreet').disabled = false;
                    }
                    if (invoiceDeliveryStreet) {
                        document.getElementById('otpremnicaDeliveryStreet').value = invoiceDeliveryStreet;
                    }
                    if (invoiceDeliveryHouseNumber) {
                        document.getElementById('otpremnicaDeliveryHouseNumber').value = invoiceDeliveryHouseNumber;
                    }
                    
                    console.log('Адрес доставки скопирован в отпремницу:', invoiceDeliveryCity, invoiceDeliveryMunicipality, invoiceDeliveryStreet, invoiceDeliveryHouseNumber);
                }
            }

            const container = document.getElementById('deliveryItems');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.internalCode === item.product.internalCode);
                
                const newItem = document.createElement('div');
                newItem.className = 'delivery-items';
                newItem.innerHTML = `
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Товар *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                            <input type="hidden" class="delivery-product" value="${productIndex}">
                            <div class="dropdown-menu delivery-product-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Количество</label>
                        <input type="number" class="delivery-quantity" value="${item.quantity}" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Единица</label>
                        <input type="text" class="delivery-unit" value="ком" readonly>
                    </div>
                    <div style="padding-top: 25px;">
                        <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                    </div>
                `;
                container.appendChild(newItem);
                
                // Инициализировать поиск для нового поля
                const newSearch = newItem.querySelector('.delivery-product-search');
                setupProductSearch(newSearch);
            });

            showAlert('Данные инвойса скопированы в отпремницу!', 'success');
        }

        // Отпремницы
        function addDeliveryItem() {
            const container = document.getElementById('deliveryItems');
            if(!container) return;

            const newItem = document.createElement('div');
            newItem.className = 'delivery-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Товар *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                        <input type="hidden" class="delivery-product" value="">
                        <div class="dropdown-menu delivery-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Количество</label>
                    <input type="number" class="delivery-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Единица</label>
                    <input type="text" class="delivery-unit" value="ком" readonly>
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // Инициализировать поиск для нового поля
            const newSearch = newItem.querySelector('.delivery-product-search');
            setupProductSearch(newSearch);
            addLog('Добавлен товар в отпремницу');
        }

        function removeDeliveryItem(button) {
            const container = document.getElementById('deliveryItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.delivery-items').remove();
            } else {
                showAlert('Должен остаться хотя бы один товар!', 'danger');
            }
        }

        function generateDelivery() {
            const deliveryNumber = document.getElementById('deliveryNumber').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryDueDate = document.getElementById('deliveryDueDate').value;
            const clientIndex = document.getElementById('deliveryClient').value;
            const method = document.getElementById('deliveryMethod').value;

            if (!deliveryNumber || !deliveryDate || !deliveryDueDate || clientIndex === '') {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }
            
            // Проверяем адрес доставки для отпремницы
            const client = clients[clientIndex];
            let deliveryAddress = client.address;
            const isDifferentAddress = document.getElementById('otpremnicaDifferentAddress')?.checked;
            
            if (isDifferentAddress) {
                const city = document.getElementById('otpremnicaDeliveryCity')?.value?.trim() || '';
                const municipality = document.getElementById('otpremnicaDeliveryMunicipality')?.value?.trim() || '';
                const street = document.getElementById('otpremnicaDeliveryStreet')?.value?.trim() || '';
                const houseNumber = document.getElementById('otpremnicaDeliveryHouseNumber')?.value?.trim() || '';
                
                if (!city || !municipality || !street) {
                    showAlert('Заполните все поля адреса доставки!', 'danger');
                    return;
                }
                
                deliveryAddress = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    deliveryAddress += ` ${houseNumber}`;
                }
            }

            const items = [];
            const itemRows = document.querySelectorAll('.delivery-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.delivery-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.delivery-quantity').value);
                const unit = row.querySelector('.delivery-unit').value;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            let itemsHTML = '';
            items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.unit}</td>
                    </tr>
                `;
            });

            const deliveryHTML = `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Мајке Јевросиме 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">ОТПРЕМНИЦА</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${deliveryNumber}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Поручилац:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${client.legalName || client.name}</p>
                                <p style="margin: 0;">Matični broj: ${client.mb}</p>
                                <p style="margin: 0;">PIB: ${client.pib}</p>
                                <p style="margin: 0;">Sedište: ${client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Испорука на адресу:</h4>
                            <p style="margin: 0; font-size: 10px;">${deliveryAddress}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Начин:</strong> ${method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Дата:</strong> ${new Date(deliveryDate).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Рок испоруке:</strong> ${new Date(deliveryDueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Назив артикла</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Количина</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Јединица мере</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Издао</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Примио</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        Овај документ је генерисан електронски и важи без печата и потписа
                    </div>
                </div>
            `;

            document.getElementById('deliveryContent').innerHTML = deliveryHTML;
            document.getElementById('deliveryPreview').style.display = 'block';
            document.getElementById('deliveryPreview').scrollIntoView({ behavior: 'smooth' });
            
            // Сохраняем данные отпремницы для возможного утверждения
            window.currentDeliveryData = {
                number: deliveryNumber,
                date: deliveryDate,
                dueDate: deliveryDueDate,
                client: client,
                method: method,
                items: items,
                deliveryAddress: deliveryAddress,
                isDifferentDeliveryAddress: isDifferentAddress,
                signed: false
            };
        }

        async function confirmDelivery() {
            console.log('=== ПОДТВЕРЖДЕНИЕ ОТПРЕМНИЦЫ ===');
            console.log('currentDeliveryData:', window.currentDeliveryData);
            
            if (!window.currentDeliveryData) {
                console.error('Нет данных отпремницы!');
                showAlert('Сначала сгенерируйте отпремницу!', 'danger');
                return;
            }
            
            console.log('Текущие утвержденные отпремницы:', confirmedDeliveries);
            
            // Проверяем, не утверждена ли уже эта отпремница
            if (confirmedDeliveries.find(del => del.number === window.currentDeliveryData.number)) {
                console.error('Отпремница уже утверждена:', window.currentDeliveryData.number);
                showAlert('Отпремница уже утверждена!', 'danger');
                return;
            }
            
            const newDelivery = { 
                ...window.currentDeliveryData,
                confirmedDate: new Date().toISOString(),
                status: 'confirmed',
                clientStatus: null,
                signed: false
            };
            
            console.log('Добавляем новую отпремницу:', newDelivery);
            
            // === НОВЫЙ КОД: Отправляем на API ===
            try {
                showLoadingIndicator(true, 'Сохранение отпремницы...');
                
                // Подготавливаем данные для API
                const deliveryData = {
                    number: newDelivery.number,
                    date: newDelivery.date,
                    client_name: newDelivery.client?.name || '',
                    delivery_address: newDelivery.deliveryAddress || '',
                    notes: newDelivery.notes || '',
                    items: newDelivery.items?.map(item => ({
                        product_code: item.code,
                        product_name: item.name,
                        quantity: item.quantity,
                        unit: item.unit || 'kg'
                    })) || [],
                    status: 'confirmed',
                    signed: false
                };
                
                const response = await DeliveriesAPI.create(deliveryData);
                
                // Добавляем ID от сервера
                newDelivery.id = response.delivery.id;
                
                console.log('✅ Отпремница сохранена на сервере:', response.delivery);
                
            } catch (error) {
                console.error('❌ Failed to save delivery to API:', error);
                showAlert(`Предупреждение: Отпремница не сохранена на сервер (${error.message})`, 'warning');
                // Продолжаем с локальным сохранением
            } finally {
                showLoadingIndicator(false);
            }
            // === КОНЕЦ НОВОГО КОДА ===
            
            confirmedDeliveries.push(newDelivery);
            
            console.log('Сохраняем в localStorage...');
            console.log('Всего отпремниц для сохранения:', confirmedDeliveries.length);
            
            try {
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                console.log('Отпремницы успешно сохранены в localStorage');
                
                const saved = localStorage.getItem('confirmedDeliveries');
                const parsed = JSON.parse(saved);
                console.log('Проверка: в localStorage сохранено отпремниц:', parsed.length);
            } catch (e) {
                console.error('Ошибка сохранения в localStorage:', e);
                showAlert('Ошибка сохранения отпремницы!', 'danger');
                return;
            }
            
            updateDeliveriesList();
            updateDeliveryClientFilter();
            
            addLog(`Утверждена отпремница #${window.currentDeliveryData.number} для клиента ${window.currentDeliveryData.client?.name || 'N/A'}`);
            showAlert('Отпремница утверждена и добавлена в историю клиента!', 'success');
            
            window.currentDeliveryData = null;
            
            console.log('=== ПОДТВЕРЖДЕНИЕ ЗАВЕРШЕНО ===');
        }

        function printDelivery() {
            const deliveryContent = document.getElementById('deliveryContent').innerHTML;
            const deliveryNumber = document.getElementById('deliveryNumber').value;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отпремница ${deliveryNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - скачивание HTML файла
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Otpremnica_${deliveryNumber.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            }
            
            showAlert('Отпремница готова для экспорта!', 'success');
        }

        function exportDeliveryToPDF() {
            if (!window.currentDeliveryData) {
                showAlert('Нет данных отпремницы для экспорта!', 'danger');
                return;
            }

            const delivery = window.currentDeliveryData;
            const deliveryContent = generateDeliveryHTMLForModal(delivery);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отпремница ${delivery.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - скачивание HTML файла
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Otpremnica_${delivery.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            }
            
            showAlert('Отпремница готова для экспорта!', 'success');
            addLog(`Экспортирована отпремница #${delivery.number} для клиента ${delivery.client.name}`);
        }

        // Статистика
        function initializeStatistics() {
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            
            document.getElementById('statsFromDate').value = firstDayOfYear.toISOString().split('T')[0];
            document.getElementById('statsToDate').value = today.toISOString().split('T')[0];
            
            updateStatistics();
        }

        let currentFilteredInvoices = []; // Глобальная переменная для хранения текущих отфильтрованных инвойсов

        // Функция для дедупликации документов с одинаковым номером
        // Если есть предрачун и рачун с одним номером - берем тот что утвержден раньше
        function deduplicateInvoices(invoices) {
            const invoiceMap = new Map();
            
            invoices.forEach(invoice => {
                const number = invoice.number;
                
                if (!invoiceMap.has(number)) {
                    // Первый документ с таким номером - добавляем
                    invoiceMap.set(number, invoice);
                } else {
                    // Уже есть документ с таким номером - берем тот что утвержден раньше
                    const existing = invoiceMap.get(number);
                    const existingDate = new Date(existing.confirmedDate || existing.date);
                    const currentDate = new Date(invoice.confirmedDate || invoice.date);
                    
                    if (currentDate < existingDate) {
                        // Текущий документ утвержден раньше - заменяем
                        invoiceMap.set(number, invoice);
                    }
                    // Иначе оставляем существующий
                }
            });
            
            return Array.from(invoiceMap.values());
        }
        
        // ============================================
        // ПЕРЕКЛЮЧЕНИЕ ПОДВКЛАДОК СТАТИСТИКИ
        // ============================================
        
        function switchStatsTab(tabName) {
            const tabSales = document.getElementById('statsTabSales');
            const tabExpenses = document.getElementById('statsTabExpenses');
            const contentSales = document.getElementById('statsContentSales');
            const contentExpenses = document.getElementById('statsContentExpenses');
            
            if (!tabSales || !tabExpenses || !contentSales || !contentExpenses) return;
            
            if (tabName === 'sales') {
                // Активируем вкладку продаж
                tabSales.style.background = '#114A9F';
                tabSales.style.color = 'white';
                tabSales.style.borderBottom = '3px solid #114A9F';
                tabExpenses.style.background = 'transparent';
                tabExpenses.style.color = '#666';
                tabExpenses.style.borderBottom = '3px solid transparent';
                
                contentSales.style.display = 'block';
                contentExpenses.style.display = 'none';
            } else {
                // Активируем вкладку расходников
                tabExpenses.style.background = '#ff9800';
                tabExpenses.style.color = 'white';
                tabExpenses.style.borderBottom = '3px solid #ff9800';
                tabSales.style.background = 'transparent';
                tabSales.style.color = '#666';
                tabSales.style.borderBottom = '3px solid transparent';
                
                contentSales.style.display = 'none';
                contentExpenses.style.display = 'block';
                
                // Загружаем категории в фильтр
                updateExpenseStatsCategoryFilter();
            }
        }
        
        // Обновление фильтра категорий для статистики расходников
        function updateExpenseStatsCategoryFilter() {
            const select = document.getElementById('expenseStatsCategoryFilter');
            if (!select) return;
            
            // Загружаем категории
            const categories = JSON.parse(localStorage.getItem('consumableCategories') || '[]');
            
            select.innerHTML = '<option value="">Все категории</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
        
        // Обновление статистики расходников
        async function updateExpenseStatistics() {
            const fromDate = document.getElementById('expenseStatsFromDate').value;
            const toDate = document.getElementById('expenseStatsToDate').value;
            const categoryFilter = document.getElementById('expenseStatsCategoryFilter').value;
            
            // Загружаем данные расходников
            const consumableGroups = JSON.parse(localStorage.getItem('consumableGroups') || '[]');
            const consumableCategories = JSON.parse(localStorage.getItem('consumableCategories') || '[]');
            let consumableHistory = JSON.parse(localStorage.getItem('consumableHistory') || '[]');
            
            // Загружаем данные клиентов и поставщиков из API
            let clientsCount = 0;
            let suppliersCount = 0;
            
            try {
                // Получаем клиентов
                if (window.api && window.api.clients) {
                    const clientsData = await window.api.clients.getAll();
                    clientsCount = clientsData.length;
                } else if (clients && clients.length) {
                    clientsCount = clients.length;
                }
                
                // Получаем поставщиков
                if (window.api && window.api.suppliers) {
                    const suppliersData = await window.api.suppliers.getAll();
                    suppliersCount = suppliersData.length;
                } else if (window.allSuppliers && window.allSuppliers.length) {
                    suppliersCount = window.allSuppliers.length;
                }
            } catch (err) {
                console.error('Ошибка загрузки данных для статистики:', err);
                // Используем кешированные данные
                clientsCount = clients ? clients.length : 0;
                suppliersCount = window.allSuppliers ? window.allSuppliers.length : 0;
            }
            
            // Применяем фильтры к истории
            if (fromDate) {
                const from = new Date(fromDate);
                consumableHistory = consumableHistory.filter(h => new Date(h.date) >= from);
            }
            if (toDate) {
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999);
                consumableHistory = consumableHistory.filter(h => new Date(h.date) <= to);
            }
            if (categoryFilter) {
                const groupsInCategory = consumableGroups.filter(g => g.categoryId === categoryFilter).map(g => g.id);
                consumableHistory = consumableHistory.filter(h => groupsInCategory.includes(h.groupId));
            }
            
            // Подсчитываем статистику расходников
            let totalExpenseValue = 0;
            let totalQuantityUsed = 0;
            
            consumableHistory.forEach(entry => {
                if (entry.quantity < 0) {
                    totalQuantityUsed += Math.abs(entry.quantity);
                    // Находим группу для подсчета стоимости
                    const group = consumableGroups.find(g => g.id === entry.groupId);
                    if (group && group.purchasePrice) {
                        totalExpenseValue += Math.abs(entry.quantity) * group.purchasePrice;
                    }
                }
            });
            
            // Обновляем карточки статистики
            document.getElementById('totalConsumablesExpense').textContent = formatPriceWithCurrency(totalExpenseValue);
            document.getElementById('totalConsumablesQuantity').textContent = totalQuantityUsed.toFixed(1);
            document.getElementById('expenseStatsClients').textContent = clientsCount;
            document.getElementById('expenseStatsSuppliers').textContent = suppliersCount;
            document.getElementById('totalConsumableGroups').textContent = consumableGroups.length;
            
            // Обновляем графики и таблицы
            updateExpensesByCategoryChart(consumableHistory, consumableGroups, consumableCategories);
            updateTopConsumablesChart(consumableHistory, consumableGroups);
            updateExpensesByMonthChart(consumableHistory);
            updateExpenseHistoryTable(consumableHistory);
            updateCurrentStockTable(consumableGroups, consumableCategories, categoryFilter);
        }
        
        // График расхода по категориям
        function updateExpensesByCategoryChart(history, groups, categories) {
            const chartEl = document.getElementById('expensesByCategoryChart');
            if (!chartEl) return;
            
            // Считаем расход по категориям
            const categoryExpenses = {};
            history.filter(h => h.quantity < 0).forEach(entry => {
                const group = groups.find(g => g.id === entry.groupId);
                if (group && group.categoryId) {
                    const cat = categories.find(c => c.id === group.categoryId);
                    const catName = cat ? cat.name : 'Без категории';
                    categoryExpenses[catName] = (categoryExpenses[catName] || 0) + Math.abs(entry.quantity);
                }
            });
            
            if (Object.keys(categoryExpenses).length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }
            
            const maxValue = Math.max(...Object.values(categoryExpenses));
            const colors = ['#ff9800', '#ff5722', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3'];
            
            let chartHTML = '<div style="display: flex; flex-direction: column; gap: 12px; padding: 20px;">';
            Object.entries(categoryExpenses).sort((a, b) => b[1] - a[1]).forEach(([catName, value], index) => {
                const width = (value / maxValue * 100).toFixed(1);
                const color = colors[index % colors.length];
                chartHTML += `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 150px; font-weight: 600; color: #333; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${catName}</div>
                        <div style="flex: 1; background: #f0f0f0; border-radius: 8px; height: 30px; overflow: hidden;">
                            <div style="width: ${width}%; height: 100%; background: ${color}; border-radius: 8px; transition: width 0.5s;"></div>
                        </div>
                        <div style="width: 80px; font-weight: 700; color: ${color};">${value.toFixed(1)}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }
        
        // График топ расходников
        function updateTopConsumablesChart(history, groups) {
            const chartEl = document.getElementById('topConsumablesChart');
            if (!chartEl) return;
            
            // Считаем использование по группам
            const groupUsage = {};
            history.filter(h => h.quantity < 0).forEach(entry => {
                groupUsage[entry.groupId] = (groupUsage[entry.groupId] || 0) + Math.abs(entry.quantity);
            });
            
            if (Object.keys(groupUsage).length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }
            
            // Сортируем и берем топ-10
            const sortedGroups = Object.entries(groupUsage)
                .map(([groupId, usage]) => {
                    const group = groups.find(g => g.id === groupId);
                    return { groupId, name: group ? group.name : 'Неизвестно', code: group ? group.code : '', unit: group ? group.unit : '', usage };
                })
                .sort((a, b) => b.usage - a.usage)
                .slice(0, 10);
            
            const maxValue = sortedGroups[0].usage;
            
            let chartHTML = '<div style="display: flex; flex-direction: column; gap: 10px; padding: 20px;">';
            sortedGroups.forEach((item, index) => {
                const width = (item.usage / maxValue * 100).toFixed(1);
                const hue = 30 - (index * 3);
                chartHTML += `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 200px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <strong>${item.code}</strong> - ${item.name}
                        </div>
                        <div style="flex: 1; background: #f0f0f0; border-radius: 8px; height: 24px; overflow: hidden;">
                            <div style="width: ${width}%; height: 100%; background: hsl(${hue}, 100%, 50%); border-radius: 8px; transition: width 0.5s;"></div>
                        </div>
                        <div style="width: 100px; font-weight: 600; color: #333;">${item.usage.toFixed(1)} ${item.unit}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }
        
        // График расхода по месяцам
        function updateExpensesByMonthChart(history) {
            const chartEl = document.getElementById('expensesByMonthChart');
            if (!chartEl) return;
            
            const deductions = history.filter(h => h.quantity < 0);
            
            if (deductions.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }
            
            // Группируем по месяцам
            const monthlyData = {};
            deductions.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + Math.abs(entry.quantity);
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const maxValue = Math.max(...Object.values(monthlyData));
            const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
            
            let chartHTML = '<div style="display: flex; align-items: end; justify-content: center; height: 220px; gap: 12px; padding: 20px; overflow-x: auto;">';
            sortedMonths.forEach((monthKey) => {
                const value = monthlyData[monthKey];
                const [year, month] = monthKey.split('-');
                const monthName = months[parseInt(month) - 1];
                const height = maxValue > 0 ? (value / maxValue) * 160 : 0;
                
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                        <div style="width: 50px; height: ${height}px; background: linear-gradient(to top, #ff9800, #ff5722); border-radius: 8px 8px 0 0; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(255, 152, 0, 0.5)';" 
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(255, 152, 0, 0.3)';"></div>
                        <div style="font-size: 11px; font-weight: 600; color: #6c757d; margin-top: 8px; text-align: center;">
                            ${monthName}<br><span style="font-size: 10px; color: #95a5a6;">${year}</span>
                        </div>
                        <div style="font-size: 11px; font-weight: 700; color: #2c3e50; margin-top: 6px;">${value.toFixed(1)}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }
        
        // Таблица истории операций
        function updateExpenseHistoryTable(history) {
            const tbody = document.getElementById('expenseHistoryTableBody');
            if (!tbody) return;
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">Нет данных за выбранный период</td></tr>';
                return;
            }
            
            const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.slice(0, 100).map(entry => {
                const dateStr = new Date(entry.date).toLocaleString('ru-RU');
                const isNegative = entry.quantity < 0;
                const bgColor = isNegative ? '#fff5f5' : '#f5fff5';
                return `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef;">${dateStr}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef;"><strong>${entry.groupCode}</strong> - ${entry.groupName}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; color: ${isNegative ? '#dc3545' : '#28a745'};">${entry.operation}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; font-weight: bold; color: ${isNegative ? '#dc3545' : '#28a745'};">${entry.quantity > 0 ? '+' : ''}${entry.quantity}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center;">${entry.balance}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; color: #666; font-size: 12px;">${entry.note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Таблица текущего остатка
        function updateCurrentStockTable(groups, categories, categoryFilter) {
            const tbody = document.getElementById('currentStockTableBody');
            if (!tbody) return;
            
            let filteredGroups = groups;
            if (categoryFilter) {
                filteredGroups = groups.filter(g => g.categoryId === categoryFilter);
            }
            
            if (filteredGroups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 40px;">Нет групп расходников</td></tr>';
                return;
            }
            
            // Сортируем по остатку (по возрастанию - сначала заканчивающиеся)
            const sorted = [...filteredGroups].sort((a, b) => a.currentQuantity - b.currentQuantity);
            
            tbody.innerHTML = sorted.map(group => {
                const cat = categories.find(c => c.id === group.categoryId);
                const value = group.currentQuantity * (group.purchasePrice || 0);
                const lowStock = group.currentQuantity < (group.initialQuantity * 0.2);
                const bgColor = lowStock ? '#fff3cd' : 'white';
                return `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #114A9F;">${group.code}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef;">${group.name}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; color: #666;">${cat ? cat.name : '-'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; font-weight: bold; color: ${lowStock ? '#dc3545' : '#28a745'};">${group.currentQuantity}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center;">${group.unit}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: right; font-weight: 600; color: #2e7d32;">${formatPriceWithCurrency(value)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Сброс фильтров статистики расходников
        function resetExpenseStatsFilters() {
            document.getElementById('expenseStatsFromDate').value = '';
            document.getElementById('expenseStatsToDate').value = '';
            document.getElementById('expenseStatsCategoryFilter').value = '';
            updateExpenseStatistics();
        }
        
        // Экспорт функции (заглушки)
        function exportExpensesByCategory() {
            showAlert('Экспорт расходов по категориям будет добавлен', 'info');
        }
        
        function exportTopConsumables() {
            showAlert('Экспорт топ расходников будет добавлен', 'info');
        }
        
        function exportExpenseHistory() {
            showAlert('Экспорт истории операций будет добавлен', 'info');
        }
        
        function exportCurrentStock() {
            showAlert('Экспорт текущего остатка будет добавлен', 'info');
        }
        
        function updateStatistics() {
            const fromDate = new Date(document.getElementById('statsFromDate').value);
            const toDate = new Date(document.getElementById('statsToDate').value);
            toDate.setHours(23, 59, 59, 999);
            
            let filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= fromDate && invoiceDate <= toDate;
            });
            
            // Дедупликация: если предрачун и рачун с одним номером - берем тот что утвержден раньше
            filteredInvoices = deduplicateInvoices(filteredInvoices);

            currentFilteredInvoices = filteredInvoices; // Сохраняем для поиска

            const totalRevenue = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = filteredInvoices.length;
            const uniqueClients = new Set(filteredInvoices.map(inv => inv.clientName || inv.client?.name || 'Unknown')).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            document.getElementById('totalRevenue').textContent = formatPriceWithCurrency(totalRevenue);
            document.getElementById('totalInvoices').textContent = totalInvoicesCount;
            document.getElementById('totalClients').textContent = uniqueClients;
            document.getElementById('averageOrder').textContent = formatPriceWithCurrency(averageOrder);

            // Очищаем поле поиска при обновлении статистики
            document.getElementById('invoiceSearchInput').value = '';
            
            updateInvoicesList(filteredInvoices);
            updateRevenueChart(filteredInvoices);
            updateProductsChart(filteredInvoices);
            updateCategoriesChart(filteredInvoices);
            updateSubcategoriesChart(filteredInvoices);
            updateClientsChart(filteredInvoices);
            updateClientReport();
        }

        function filterInvoicesBySearch() {
            const searchTerm = document.getElementById('invoiceSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                // Если поле поиска пустое, показываем все инвойсы из текущего фильтра
                updateInvoicesList(currentFilteredInvoices);
                return;
            }

            // Фильтруем инвойсы по номеру
            const searchResults = currentFilteredInvoices.filter(invoice => 
                invoice.number.toLowerCase().includes(searchTerm)
            );

            updateInvoicesList(searchResults);
        }

        function updateRevenueChart(invoices) {
            const chartEl = document.getElementById('revenueChart');
            if(!chartEl) return;

            if (invoices.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            let chartHTML = '<div style="display: flex; align-items: end; height: 200px; gap: 10px; padding: 20px;">';
            const maxValue = Math.max(...Object.values(monthlyData));
            const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
            
            Object.entries(monthlyData).forEach(([monthKey, value]) => {
                const [year, month] = monthKey.split('-');
                const monthName = months[parseInt(month) - 1];
                const height = (value / maxValue) * 150;
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="font-size: 12px; margin-bottom: 5px; font-weight: bold;">${formatPriceWithCurrency(value)}</div>
                        <div style="width: 40px; height: ${height}px; background: linear-gradient(to top, #212529, #343a40); border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 12px; margin-top: 5px; text-align: center;">${monthName}<br>${year}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateProductsChart(invoices) {
            const chartEl = document.getElementById('productsChart');
            if(!chartEl) return;

            // Проверяем фильтр НДС
            const vatFilter = document.getElementById('productsVatFilter')?.value || 'without';
            const vatMultiplier = vatFilter === 'with' ? 1.20 : 1.0;

            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    // Получаем код товара с fallback
                    const key = item.product?.code || item.productId || item.product?.internalCode || 'Unknown';
                    const name = item.product?.name || item.productName || 'Unknown';
                    let itemTotal = item.amount || item.total || (item.quantity * item.price) || 0;
                    
                    // Применяем НДС если выбрано
                    itemTotal = itemTotal * vatMultiplier;
                    
                    if (!productData[key]) {
                        productData[key] = {
                            name: name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity || 0;
                    productData[key].revenue += itemTotal;
                });
            });

            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            if (sortedProducts.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const maxRevenue = sortedProducts[0][1].revenue;
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedProducts.forEach(([code, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px; color: #007bff; cursor: pointer; text-decoration: underline;" onclick="openProductProfileByCode('${code.replace(/'/g, "\\'")}')">
                                ${code}
                            </span>
                            <span style="font-size: 14px;">${formatPriceWithCurrency(data.revenue)} (${data.quantity} шт)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #28a745, #20c997); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateCategoriesChart(invoices) {
            const chartEl = document.getElementById('categoriesChart');
            if(!chartEl) return;

            // Проверяем фильтр НДС
            const vatFilter = document.getElementById('categoriesVatFilter')?.value || 'without';
            const vatMultiplier = vatFilter === 'with' ? 1.20 : 1.0;

            const categoryData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    // Получаем категорию с fallback
                    const category = item.product?.category || 'Без категории';
                    let itemTotal = item.amount || item.total || (item.quantity * item.price) || 0;
                    
                    // Применяем НДС если выбрано
                    itemTotal = itemTotal * vatMultiplier;
                    
                    if (!categoryData[category]) {
                        categoryData[category] = {
                            revenue: 0,
                            quantity: 0
                        };
                    }
                    categoryData[category].revenue += itemTotal;
                    categoryData[category].quantity += item.quantity || 0;
                });
            });

            const sortedCategories = Object.entries(categoryData)
                .sort((a, b) => b[1].revenue - a[1].revenue);

            if (sortedCategories.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const totalRevenue = sortedCategories.reduce((sum, [, data]) => sum + data.revenue, 0);
            const maxRevenue = sortedCategories[0][1].revenue;
            
            // Цвета для разных категорий
            const categoryColors = {
                'Zeleni Čaj': 'linear-gradient(to right, #32CD32, #20c997)',
                'Crni Čaj': 'linear-gradient(to right, #8B4513, #A0522D)',
                'Printing': 'linear-gradient(to right, #6c757d, #495057)',
                'Посуда': 'linear-gradient(to right, #17a2b8, #138496)',
                'Other': 'linear-gradient(to right, #ffc107, #ff9800)',
                'Без категории': 'linear-gradient(to right, #e9ecef, #ced4da)'
            };
            
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedCategories.forEach(([category, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                const percentageOfTotal = (data.revenue / totalRevenue * 100).toFixed(1);
                const color = categoryColors[category] || 'linear-gradient(to right, #28a745, #20c997)';
                
                // Названия категорий на русском
                const categoryNames = {
                    'Zeleni Čaj': '🍵 Зеленый чай',
                    'Crni Čaj': '☕ Черный чай',
                    'Printing': '🖨️ Полиграфия',
                    'Посуда': '🍽️ Посуда',
                    'Other': '📦 Другое',
                    'Без категории': '❓ Без категории'
                };
                const displayName = categoryNames[category] || category;
                
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">${displayName}</span>
                            <span style="font-size: 14px;">${formatPriceWithCurrency(data.revenue)} (${percentageOfTotal}%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; color: #666;">
                            <span>Количество товаров: ${data.quantity} шт</span>
                        </div>
                        <div style="width: 100%; height: 10px; background: #e9ecef; border-radius: 5px;">
                            <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 5px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateSubcategoriesChart(invoices) {
            const chartEl = document.getElementById('subcategoriesChart');
            if(!chartEl) return;

            // Сохраняем инвойсы для повторного использования при фильтрации
            window.currentFilteredInvoices = invoices;

            // Обновляем фильтр категорий
            updateSubcategoriesCategoryFilter();

            // Проверяем фильтр НДС
            const vatFilter = document.getElementById('subcategoriesVatFilter')?.value || 'without';
            const vatMultiplier = vatFilter === 'with' ? 1.20 : 1.0;
            
            // Проверяем фильтр по категории
            const categoryFilter = document.getElementById('subcategoriesCategoryFilter')?.value || '';

            const subcategoryData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    // Получаем категорию и субкатегорию
                    const category = item.product?.category || 'Без категории';
                    const subcategory = item.product?.subcategory || 'Без субкатегории';
                    
                    // Применяем фильтр по категории
                    if (categoryFilter && category !== categoryFilter) {
                        return;
                    }
                    
                    let itemTotal = item.amount || item.total || (item.quantity * item.price) || 0;
                    
                    // Применяем НДС если выбрано
                    itemTotal = itemTotal * vatMultiplier;
                    
                    // Создаем ключ для группировки (категория + субкатегория)
                    const key = `${category}|||${subcategory}`;
                    
                    if (!subcategoryData[key]) {
                        subcategoryData[key] = {
                            category: category,
                            subcategory: subcategory,
                            revenue: 0,
                            quantity: 0
                        };
                    }
                    subcategoryData[key].revenue += itemTotal;
                    subcategoryData[key].quantity += item.quantity || 0;
                });
            });

            const sortedSubcategories = Object.values(subcategoryData)
                .sort((a, b) => b.revenue - a.revenue);

            if (sortedSubcategories.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const totalRevenue = sortedSubcategories.reduce((sum, data) => sum + data.revenue, 0);
            const maxRevenue = sortedSubcategories[0].revenue;
            
            // Цвета для разных категорий
            const categoryColors = {
                'Zeleni Čaj': ['#32CD32', '#2ECC71', '#27AE60', '#1ABC9C', '#16A085'],
                'Crni Čaj': ['#8B4513', '#A0522D', '#CD853F', '#D2691E', '#B8860B'],
                'Printing': ['#6c757d', '#495057', '#343a40', '#212529', '#5a6268'],
                'Посуда': ['#17a2b8', '#138496', '#0c5460', '#1e7e96', '#5fc8e0'],
                'Other': ['#ffc107', '#ff9800', '#fd7e14', '#e67e22', '#f1c40f'],
                'Без категории': ['#e9ecef', '#ced4da', '#adb5bd', '#6c757d', '#495057']
            };
            
            // Названия категорий на русском
            const categoryNames = {
                'Zeleni Čaj': '🍵 Зеленый чай',
                'Crni Čaj': '☕ Черный чай',
                'Printing': '🖨️ Полиграфия',
                'Посуда': '🍽️ Посуда',
                'Other': '📦 Другое',
                'Без категории': '❓ Без категории'
            };

            // Группируем по категориям для отображения
            const groupedByCategory = {};
            sortedSubcategories.forEach(item => {
                if (!groupedByCategory[item.category]) {
                    groupedByCategory[item.category] = [];
                }
                groupedByCategory[item.category].push(item);
            });
            
            let chartHTML = '<div style="padding: 20px;">';
            let categoryIndex = 0;
            
            // Отображаем каждую категорию с её субкатегориями
            Object.entries(groupedByCategory).forEach(([category, subcategories]) => {
                const categoryDisplayName = categoryNames[category] || category;
                const colors = categoryColors[category] || categoryColors['Other'];
                const catId = `subcatGroup_${categoryIndex}`;
                categoryIndex++;
                
                // Заголовок категории
                const categoryTotal = subcategories.reduce((sum, s) => sum + s.revenue, 0);
                const categoryPercentage = (categoryTotal / totalRevenue * 100).toFixed(1);
                const subcatCount = subcategories.length;
                
                chartHTML += `
                    <div style="margin-bottom: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e3e8ef; overflow: hidden;">
                        <div onclick="toggleSubcategoryGroup('${catId}')" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; user-select: none; transition: background 0.2s;" onmouseover="this.style.background='#eef2f7'" onmouseout="this.style.background='transparent'">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="${catId}_arrow" style="font-size: 12px; transition: transform 0.3s; display: inline-block;">▶</span>
                                <span style="font-weight: bold; font-size: 16px; color: #2c3e50;">${categoryDisplayName}</span>
                                <span style="font-size: 12px; color: #888; background: #e3e8ef; padding: 2px 8px; border-radius: 10px;">${subcatCount}</span>
                            </div>
                            <span style="font-size: 14px; color: #666; font-weight: 600;">${formatPriceWithCurrency(categoryTotal)} <span style="font-weight: normal;">(${categoryPercentage}%)</span></span>
                        </div>
                        <div id="${catId}" style="display: none; padding: 0 15px 15px 15px; border-top: 1px solid #e3e8ef;">
                `;
                
                // Субкатегории внутри категории
                subcategories.forEach((data, idx) => {
                    const percentage = maxRevenue > 0 ? (data.revenue / maxRevenue) * 100 : 0;
                    const percentageOfTotal = (data.revenue / totalRevenue * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    const subcategoryDisplay = data.subcategory === 'Без субкатегории' ? '📌 Без субкатегории' : `📎 ${data.subcategory}`;
                    const isClickable = data.subcategory !== 'Без субкатегории';
                    const clickStyle = isClickable ? 'cursor: pointer; color: #6f42c1; text-decoration: underline;' : '';
                    const clickHandler = isClickable ? `onclick="event.stopPropagation(); openSubcategoryProfile('${data.subcategory.replace(/'/g, "\\'")}', '${data.category.replace(/'/g, "\\'")}')"` : '';
                    
                    chartHTML += `
                        <div style="margin-top: 12px; padding-left: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 500; font-size: 14px; ${clickStyle}" ${clickHandler}>${subcategoryDisplay}</span>
                                <span style="font-size: 13px; color: #555;">${formatPriceWithCurrency(data.revenue)} (${percentageOfTotal}%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 12px; color: #888;">
                                <span>Количество: ${data.quantity} шт</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                                <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
                            </div>
                        </div>
                    `;
                });
                
                chartHTML += '</div></div>';
            });
            
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }
        
        // Функция сворачивания/разворачивания субкатегорий
        function toggleSubcategoryGroup(groupId) {
            const content = document.getElementById(groupId);
            const arrow = document.getElementById(groupId + '_arrow');
            if (!content || !arrow) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Обновление фильтра категорий в статистике субкатегорий
        function updateSubcategoriesCategoryFilter() {
            const select = document.getElementById('subcategoriesCategoryFilter');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">Все категории</option>';
            
            // Добавляем категории из categoriesData если они есть
            if (typeof categoriesData !== 'undefined' && categoriesData.length > 0) {
                categoriesData.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } else {
                // Дефолтные категории
                ['Zeleni Čaj', 'Crni Čaj', 'Printing', 'Посуда', 'Other'].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
            
            // Восстанавливаем выбранное значение
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Экспорт статистики по субкатегориям в Excel
        function exportSubcategoriesToExcel() {
            console.log('Экспорт статистики продаж по субкатегориям в Excel');
            
            // Получаем отфильтрованные инвойсы по датам
            const fromDate = document.getElementById('statsFromDate')?.value;
            const toDate = document.getElementById('statsToDate')?.value;
            let filteredInvoices = [...confirmedInvoices];
            
            if (fromDate || toDate) {
                filteredInvoices = confirmedInvoices.filter(inv => {
                    const invDate = new Date(inv.date);
                    if (fromDate && toDate) {
                        const from = new Date(fromDate);
                        const to = new Date(toDate);
                        to.setHours(23, 59, 59, 999);
                        return invDate >= from && invDate <= to;
                    } else if (fromDate) {
                        return invDate >= new Date(fromDate);
                    } else if (toDate) {
                        const to = new Date(toDate);
                        to.setHours(23, 59, 59, 999);
                        return invDate <= to;
                    }
                    return true;
                });
            }
            
            // Проверяем фильтр по категории
            const categoryFilter = document.getElementById('subcategoriesCategoryFilter')?.value || '';
            
            // Собираем данные о субкатегориях
            const subcategoryData = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const category = item.product?.category || 'Без категории';
                    const subcategory = item.product?.subcategory || 'Без субкатегории';
                    
                    // Применяем фильтр по категории
                    if (categoryFilter && category !== categoryFilter) {
                        return;
                    }
                    
                    const key = `${category}|||${subcategory}`;
                    if (!subcategoryData[key]) {
                        subcategoryData[key] = {
                            category: category,
                            subcategory: subcategory,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    subcategoryData[key].quantity += item.quantity || 0;
                    subcategoryData[key].revenue += item.amount || item.total || (item.quantity * item.price) || 0;
                });
            });
            
            // Сортируем по категории, затем по выручке внутри категории
            const sortedData = Object.values(subcategoryData).sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return b.revenue - a.revenue;
            });
            
            if (sortedData.length === 0) {
                showAlert('Нет данных для экспорта!', 'warning');
                return;
            }
            
            // Подсчитываем общую выручку
            const totalRevenue = sortedData.reduce((sum, item) => sum + item.revenue, 0);
            
            // Названия категорий на русском для Excel
            const categoryNames = {
                'Zeleni Čaj': 'Зеленый чай',
                'Crni Čaj': 'Черный чай',
                'Printing': 'Полиграфия',
                'Посуда': 'Посуда',
                'Other': 'Другое',
                'Без категории': 'Без категории'
            };
            
            // Подготавливаем данные для Excel
            const excelData = sortedData.map((item, index) => ({
                '№': index + 1,
                'Категория': categoryNames[item.category] || item.category,
                'Субкатегория': item.subcategory,
                'Количество товаров': item.quantity,
                'Выручка (RSD)': item.revenue.toFixed(2),
                '% от общей выручки': ((item.revenue / totalRevenue) * 100).toFixed(2) + '%'
            }));
            
            // Добавляем итоговую строку
            const totalQuantity = sortedData.reduce((sum, item) => sum + item.quantity, 0);
            excelData.push({
                '№': '',
                'Категория': 'ИТОГО:',
                'Субкатегория': '',
                'Количество товаров': totalQuantity,
                'Выручка (RSD)': totalRevenue.toFixed(2),
                '% от общей выручки': '100%'
            });
            
            // Создаем workbook и worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Настраиваем ширину колонок
            ws['!cols'] = [
                { wch: 5 },
                { wch: 18 },
                { wch: 25 },
                { wch: 18 },
                { wch: 18 },
                { wch: 20 }
            ];
            
            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Продажи по субкатегориям');
            
            // Формируем имя файла с датой
            let periodStr = '';
            if (fromDate && toDate) {
                periodStr = `${fromDate}_${toDate}`;
            } else if (fromDate) {
                periodStr = `от_${fromDate}`;
            } else if (toDate) {
                periodStr = `до_${toDate}`;
            } else {
                periodStr = 'Все_время';
            }
            const categorySuffix = categoryFilter ? `_${categoryFilter}` : '';
            const fileName = `Продажи_по_субкатегориям${categorySuffix}_${periodStr}_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;
            
            // Скачиваем файл
            XLSX.writeFile(wb, fileName);
            
            showAlert('Статистика по субкатегориям экспортирована в Excel!', 'success');
        }

        function updateClientsChart(invoices) {
            const chartEl = document.getElementById('clientsChart');
            if(!chartEl) return;

            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const sortedClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedClients.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const maxRevenue = sortedClients[0][1];
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedClients.forEach(([clientName, revenue]) => {
                const percentage = (revenue / maxRevenue) * 100;
                const escapedName = clientName.replace(/'/g, "\\'");
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px; cursor: pointer; color: #007bff; transition: color 0.2s;" 
                                  onclick="openClientProfileByName('${escapedName}')" 
                                  onmouseover="this.style.color='#0056b3'; this.style.textDecoration='underline';" 
                                  onmouseout="this.style.color='#007bff'; this.style.textDecoration='none';"
                                  title="Открыть профиль клиента">${clientName}</span>
                            <span style="font-size: 14px;">${formatPriceWithCurrency(revenue)}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #212529, #343a40); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        // Функция для обновления отчета по клиентам
        function updateClientReport() {
            const tableEl = document.getElementById('clientReportTable');
            if (!tableEl) return;

            // Получаем значения фильтров
            const searchTerm = document.getElementById('clientReportSearch').value.toLowerCase().trim();
            const clientType = document.getElementById('clientReportType').value;
            const fromMonth = document.getElementById('clientReportFromMonth').value;
            const toMonth = document.getElementById('clientReportToMonth').value;

            // Фильтруем клиентов по типу и поиску
            let filteredClients = clients.filter(client => {
                const matchesSearch = !searchTerm || client.name.toLowerCase().includes(searchTerm);
                const matchesType = !clientType || client.clientType === clientType;
                return matchesSearch && matchesType;
            });

            // Фильтруем инвойсы по периоду
            let filteredInvoices = confirmedInvoices;
            if (fromMonth || toMonth) {
                if (fromMonth && toMonth) {
                    const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                    const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                    const startDate = new Date(fromYear, fromMonthNum - 1, 1);
                    const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59);
                    filteredInvoices = confirmedInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= startDate && invDate <= endDate;
                    });
                } else if (fromMonth) {
                    const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                    const startDate = new Date(fromYear, fromMonthNum - 1, 1);
                    filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) >= startDate);
                } else if (toMonth) {
                    const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                    const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59);
                    filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) <= endDate);
                }
            }
            
            // Дедупликация: если предрачун и рачун с одним номером - берем тот что утвержден раньше
            filteredInvoices = deduplicateInvoices(filteredInvoices);

            // Собираем статистику по клиентам
            const clientStats = {};
            filteredInvoices.forEach(invoice => {
                const clientName = invoice.client.name;
                if (!clientStats[clientName]) {
                    clientStats[clientName] = {
                        totalSum: 0,
                        invoiceCount: 0
                    };
                }
                clientStats[clientName].totalSum += invoice.total;
                clientStats[clientName].invoiceCount++;
            });

            // Фильтруем клиентов, у которых есть заказы
            const clientsWithOrders = filteredClients.filter(client => clientStats[client.name]);

            // Считаем общую статистику
            const totalSum = Object.values(clientStats).reduce((sum, stat) => sum + stat.totalSum, 0);
            const totalInvoices = Object.values(clientStats).reduce((sum, stat) => sum + stat.invoiceCount, 0);
            const avgSum = clientsWithOrders.length > 0 ? totalSum / clientsWithOrders.length : 0;

            // Обновляем карточки статистики
            document.getElementById('clientReportTotalSum').textContent = formatPriceWithCurrency(totalSum);
            document.getElementById('clientReportTotalClients').textContent = clientsWithOrders.length;
            document.getElementById('clientReportAvgSum').textContent = formatPriceWithCurrency(avgSum);
            document.getElementById('clientReportTotalInvoices').textContent = totalInvoices;

            // Создаем таблицу
            if (clientsWithOrders.length === 0) {
                tableEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Нет данных по выбранным фильтрам</div>';
                return;
            }

            // Сортируем клиентов по сумме заказов (убывание)
            const sortedClients = clientsWithOrders.sort((a, b) => {
                return clientStats[b.name].totalSum - clientStats[a.name].totalSum;
            });

            // Формируем HTML таблицы
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%); color: white;">
                            <th style="padding: 14px; text-align: left; font-weight: 700; border-radius: 8px 0 0 0;">№</th>
                            <th style="padding: 14px; text-align: left; font-weight: 700;">Клиент</th>
                            <th style="padding: 14px; text-align: center; font-weight: 700;">Тип</th>
                            <th style="padding: 14px; text-align: center; font-weight: 700;">Кол-во инвойсов</th>
                            <th style="padding: 14px; text-align: right; font-weight: 700;">Сумма заказов</th>
                            <th style="padding: 14px; text-align: right; font-weight: 700; border-radius: 0 8px 0 0;">% от общей суммы</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedClients.forEach((client, index) => {
                const stats = clientStats[client.name];
                const percentage = totalSum > 0 ? (stats.totalSum / totalSum * 100).toFixed(1) : 0;
                const bgColor = index % 2 === 0 ? '#f8fafc' : '#ffffff';
                const clientTypeEmoji = {
                    'Бар': '🍺',
                    'Ресторан': '🍽️',
                    'Отель': '🏨',
                    'Кальянная': '💨',
                    'Кафе': '☕'
                }[client.clientType] || '🏢';

                const escapedClientName = client.name.replace(/'/g, "\\'");
                tableHTML += `
                    <tr style="background: ${bgColor}; transition: background 0.2s ease;" 
                        onmouseover="this.style.background='#e3f2fd';" 
                        onmouseout="this.style.background='${bgColor}';">
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #6c757d;">${index + 1}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; font-weight: 600;">
                            <span style="cursor: pointer; color: #007bff; transition: color 0.2s;" 
                                  onclick="openClientProfileByName('${escapedClientName}')" 
                                  onmouseover="this.style.color='#0056b3'; this.style.textDecoration='underline';" 
                                  onmouseout="this.style.color='#007bff'; this.style.textDecoration='none';"
                                  title="Открыть профиль клиента">${client.name}</span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; font-size: 18px;">${clientTypeEmoji} ${client.clientType || '-'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; font-weight: 600; color: #495057;">${stats.invoiceCount}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: right; font-weight: 700; color: #114A9F; font-size: 15px;">${formatPriceWithCurrency(stats.totalSum)}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: right;">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                <div style="flex: 0 0 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #114A9F, #0d3a7f); border-radius: 4px;"></div>
                                </div>
                                <span style="font-weight: 600; color: #495057; min-width: 45px;">${percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableEl.innerHTML = tableHTML;
        }

        // Функция для сброса фильтров отчета по клиентам
        function resetClientReport() {
            document.getElementById('clientReportSearch').value = '';
            document.getElementById('clientReportType').value = '';
            document.getElementById('clientReportFromMonth').value = '';
            document.getElementById('clientReportToMonth').value = '';
            updateClientReport();
        }

        // ============================================
        // ФУНКЦИИ ЭКСПОРТА В EXCEL
        // ============================================

        // Экспорт статистики продаж товаров в Excel
        function exportProductsToExcel() {
            console.log('Экспорт статистики продаж товаров в Excel');
            
            // Получаем отфильтрованные инвойсы
            const period = document.getElementById('analyticsPeriod').value;
            let filteredInvoices = confirmedInvoices;
            
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                if (period === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (period === 'week') {
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (period === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) >= startDate);
            }
            
            // Собираем данные о товарах
            const productData = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            code: item.product.code,
                            name: item.product.name,
                            category: item.product.category || 'Не указана',
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });
            
            // Сортируем по выручке
            const sortedProducts = Object.values(productData).sort((a, b) => b.revenue - a.revenue);
            
            if (sortedProducts.length === 0) {
                showAlert('Нет данных для экспорта!', 'warning');
                return;
            }
            
            // Подготавливаем данные для Excel
            const excelData = sortedProducts.map((product, index) => ({
                '№': index + 1,
                'Код товара': product.code,
                'Название': product.name,
                'Категория': product.category,
                'Количество': product.quantity,
                'Выручка (RSD)': product.revenue.toFixed(2)
            }));
            
            // Добавляем итоговую строку
            const totalQuantity = sortedProducts.reduce((sum, p) => sum + p.quantity, 0);
            const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
            excelData.push({
                '№': '',
                'Код товара': '',
                'Название': 'ИТОГО:',
                'Категория': '',
                'Количество': totalQuantity,
                'Выручка (RSD)': totalRevenue.toFixed(2)
            });
            
            // Создаем workbook и worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Настраиваем ширину колонок
            ws['!cols'] = [
                { wch: 5 },   // №
                { wch: 15 },  // Код товара
                { wch: 40 },  // Название
                { wch: 20 },  // Категория
                { wch: 12 },  // Количество
                { wch: 18 }   // Выручка
            ];
            
            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Статистика продаж');
            
            // Формируем имя файла с датой
            const periodNames = {
                'all': 'Все_время',
                'today': 'Сегодня',
                'week': 'Неделя',
                'month': 'Месяц',
                'year': 'Год'
            };
            const fileName = `Статистика_продаж_${periodNames[period]}_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;
            
            // Скачиваем файл
            XLSX.writeFile(wb, fileName);
            
            showAlert('Статистика продаж экспортирована в Excel!', 'success');
        }

        // Экспорт статистики по категориям в Excel
        function exportCategoriesToExcel() {
            console.log('Экспорт статистики продаж по категориям в Excel');
            
            // Получаем отфильтрованные инвойсы
            const period = document.getElementById('analyticsPeriod').value;
            let filteredInvoices = confirmedInvoices;
            
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                if (period === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (period === 'week') {
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (period === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) >= startDate);
            }
            
            // Собираем данные о категориях
            const categoryData = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const category = item.product.category || 'Без категории';
                    if (!categoryData[category]) {
                        categoryData[category] = {
                            category: category,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    categoryData[category].quantity += item.quantity;
                    categoryData[category].revenue += item.amount;
                });
            });
            
            // Сортируем по выручке
            const sortedCategories = Object.values(categoryData).sort((a, b) => b.revenue - a.revenue);
            
            if (sortedCategories.length === 0) {
                showAlert('Нет данных для экспорта!', 'warning');
                return;
            }
            
            // Подсчитываем общую выручку
            const totalRevenue = sortedCategories.reduce((sum, cat) => sum + cat.revenue, 0);
            
            // Названия категорий на русском для Excel
            const categoryNames = {
                'Zeleni Čaj': 'Зеленый чай',
                'Crni Čaj': 'Черный чай',
                'Printing': 'Полиграфия',
                'Посуда': 'Посуда',
                'Other': 'Другое',
                'Без категории': 'Без категории'
            };
            
            // Подготавливаем данные для Excel
            const excelData = sortedCategories.map((cat, index) => ({
                '№': index + 1,
                'Категория': categoryNames[cat.category] || cat.category,
                'Количество товаров': cat.quantity,
                'Выручка (RSD)': cat.revenue.toFixed(2),
                '% от общей выручки': ((cat.revenue / totalRevenue) * 100).toFixed(2) + '%'
            }));
            
            // Добавляем итоговую строку
            const totalQuantity = sortedCategories.reduce((sum, cat) => sum + cat.quantity, 0);
            excelData.push({
                '№': '',
                'Категория': 'ИТОГО:',
                'Количество товаров': totalQuantity,
                'Выручка (RSD)': totalRevenue.toFixed(2),
                '% от общей выручки': '100%'
            });
            
            // Создаем workbook и worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Настраиваем ширину колонок
            ws['!cols'] = [
                { wch: 5 },   // №
                { wch: 20 },  // Категория
                { wch: 18 },  // Количество товаров
                { wch: 18 },  // Выручка
                { wch: 20 }   // % от общей выручки
            ];
            
            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Продажи по категориям');
            
            // Формируем имя файла с датой
            const periodNames = {
                'all': 'Все_время',
                'today': 'Сегодня',
                'week': 'Неделя',
                'month': 'Месяц',
                'year': 'Год'
            };
            const fileName = `Продажи_по_категориям_${periodNames[period]}_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;
            
            // Скачиваем файл
            XLSX.writeFile(wb, fileName);
            
            showAlert('Статистика по категориям экспортирована в Excel!', 'success');
        }

        // Экспорт статистики клиентов в Excel
        function exportClientsToExcel() {
            console.log('Экспорт статистики клиентов в Excel');
            
            // Получаем отфильтрованные инвойсы
            const period = document.getElementById('analyticsPeriod').value;
            let filteredInvoices = confirmedInvoices;
            
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                if (period === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (period === 'week') {
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (period === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) >= startDate);
            }
            
            // Собираем данные о клиентах
            const clientData = {};
            filteredInvoices.forEach(invoice => {
                const clientName = invoice.client.name;
                const client = clients.find(c => c.name === clientName);
                
                if (!clientData[clientName]) {
                    clientData[clientName] = {
                        name: clientName,
                        type: client?.clientType || 'Не указан',
                        mb: client?.mb || 'Не указан',
                        pib: client?.pib || 'Не указан',
                        address: client?.address || 'Не указан',
                        phone: client?.phone || 'Не указан',
                        invoiceCount: 0,
                        revenue: 0
                    };
                }
                clientData[clientName].invoiceCount++;
                clientData[clientName].revenue += invoice.total;
            });
            
            // Сортируем по выручке
            const sortedClients = Object.values(clientData).sort((a, b) => b.revenue - a.revenue);
            
            if (sortedClients.length === 0) {
                showAlert('Нет данных для экспорта!', 'warning');
                return;
            }
            
            // Подготавливаем данные для Excel
            const excelData = sortedClients.map((client, index) => ({
                '№': index + 1,
                'Название клиента': client.name,
                'Тип': client.type,
                'МБ': client.mb,
                'ПИБ': client.pib,
                'Адрес': client.address,
                'Телефон': client.phone,
                'Кол-во инвойсов': client.invoiceCount,
                'Выручка (RSD)': client.revenue.toFixed(2)
            }));
            
            // Добавляем итоговую строку
            const totalInvoices = sortedClients.reduce((sum, c) => sum + c.invoiceCount, 0);
            const totalRevenue = sortedClients.reduce((sum, c) => sum + c.revenue, 0);
            excelData.push({
                '№': '',
                'Название клиента': '',
                'Тип': '',
                'МБ': '',
                'ПИБ': 'ИТОГО:',
                'Адрес': '',
                'Телефон': '',
                'Кол-во инвойсов': totalInvoices,
                'Выручка (RSD)': totalRevenue.toFixed(2)
            });
            
            // Создаем workbook и worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Настраиваем ширину колонок
            ws['!cols'] = [
                { wch: 5 },   // №
                { wch: 35 },  // Название клиента
                { wch: 15 },  // Тип
                { wch: 12 },  // МБ
                { wch: 12 },  // ПИБ
                { wch: 40 },  // Адрес
                { wch: 15 },  // Телефон
                { wch: 16 },  // Кол-во инвойсов
                { wch: 18 }   // Выручка
            ];
            
            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Статистика клиентов');
            
            // Формируем имя файла с датой
            const periodNames = {
                'all': 'Все_время',
                'today': 'Сегодня',
                'week': 'Неделя',
                'month': 'Месяц',
                'year': 'Год'
            };
            const fileName = `Статистика_клиентов_${periodNames[period]}_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;
            
            // Скачиваем файл
            XLSX.writeFile(wb, fileName);
            
            showAlert('Статистика клиентов экспортирована в Excel!', 'success');
        }

        // Экспорт детальной отчетности по клиентам в Excel
        function exportDetailedClientsToExcel() {
            console.log('Экспорт детальной отчетности по клиентам в Excel');
            
            // Получаем значения фильтров
            const searchTerm = document.getElementById('clientReportSearch').value.toLowerCase().trim();
            const clientType = document.getElementById('clientReportType').value;
            const fromMonth = document.getElementById('clientReportFromMonth').value;
            const toMonth = document.getElementById('clientReportToMonth').value;

            // Фильтруем клиентов по типу и поиску
            let filteredClients = clients.filter(client => {
                const matchesSearch = !searchTerm || client.name.toLowerCase().includes(searchTerm);
                const matchesType = !clientType || client.clientType === clientType;
                return matchesSearch && matchesType;
            });

            // Фильтруем инвойсы по периоду
            let filteredInvoices = confirmedInvoices;
            if (fromMonth || toMonth) {
                if (fromMonth && toMonth) {
                    const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                    const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                    const startDate = new Date(fromYear, fromMonthNum - 1, 1);
                    const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59);
                    filteredInvoices = confirmedInvoices.filter(inv => {
                        const invDate = new Date(inv.date);
                        return invDate >= startDate && invDate <= endDate;
                    });
                } else if (fromMonth) {
                    const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                    const startDate = new Date(fromYear, fromMonthNum - 1, 1);
                    filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) >= startDate);
                } else if (toMonth) {
                    const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                    const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59);
                    filteredInvoices = confirmedInvoices.filter(inv => new Date(inv.date) <= endDate);
                }
            }
            
            // Дедупликация: если предрачун и рачун с одним номером - берем тот что утвержден раньше
            filteredInvoices = deduplicateInvoices(filteredInvoices);

            // Собираем статистику по клиентам
            const clientStats = {};
            filteredInvoices.forEach(invoice => {
                const clientName = invoice.client.name;
                if (!clientStats[clientName]) {
                    clientStats[clientName] = {
                        totalSum: 0,
                        invoiceCount: 0
                    };
                }
                clientStats[clientName].totalSum += invoice.total;
                clientStats[clientName].invoiceCount++;
            });

            // Фильтруем клиентов, у которых есть заказы
            const clientsWithOrders = filteredClients.filter(client => clientStats[client.name]);

            if (clientsWithOrders.length === 0) {
                showAlert('Нет данных для экспорта!', 'warning');
                return;
            }

            // Считаем общую статистику
            const totalSum = Object.values(clientStats).reduce((sum, stat) => sum + stat.totalSum, 0);

            // Сортируем клиентов по сумме заказов (убывание)
            const sortedClients = clientsWithOrders.sort((a, b) => {
                return clientStats[b.name].totalSum - clientStats[a.name].totalSum;
            });

            // Подготавливаем данные для Excel
            const excelData = sortedClients.map((client, index) => {
                const stats = clientStats[client.name];
                const percentage = totalSum > 0 ? (stats.totalSum / totalSum * 100).toFixed(1) : 0;
                
                return {
                    '№': index + 1,
                    'Название клиента': client.name,
                    'Тип': client.clientType || 'Не указан',
                    'МБ': client.mb || 'Не указан',
                    'ПИБ': client.pib || 'Не указан',
                    'Адрес': client.address || 'Не указан',
                    'Телефон': client.phone || 'Не указан',
                    'Email': client.email || 'Не указан',
                    'Контактное лицо': client.contactPerson || 'Не указан',
                    'Кол-во инвойсов': stats.invoiceCount,
                    'Сумма заказов (RSD)': stats.totalSum.toFixed(2),
                    '% от общей суммы': percentage + '%'
                };
            });

            // Добавляем итоговую строку
            const totalInvoices = Object.values(clientStats).reduce((sum, stat) => sum + stat.invoiceCount, 0);
            excelData.push({
                '№': '',
                'Название клиента': '',
                'Тип': '',
                'МБ': '',
                'ПИБ': '',
                'Адрес': '',
                'Телефон': '',
                'Email': '',
                'Контактное лицо': 'ИТОГО:',
                'Кол-во инвойсов': totalInvoices,
                'Сумма заказов (RSD)': totalSum.toFixed(2),
                '% от общей суммы': '100%'
            });

            // Создаем workbook и worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Настраиваем ширину колонок
            ws['!cols'] = [
                { wch: 5 },   // №
                { wch: 35 },  // Название клиента
                { wch: 15 },  // Тип
                { wch: 12 },  // МБ
                { wch: 12 },  // ПИБ
                { wch: 40 },  // Адрес
                { wch: 15 },  // Телефон
                { wch: 25 },  // Email
                { wch: 25 },  // Контактное лицо
                { wch: 16 },  // Кол-во инвойсов
                { wch: 20 },  // Сумма заказов
                { wch: 18 }   // % от общей суммы
            ];

            // Добавляем worksheet в workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Детальная отчетность');

            // Формируем имя файла с датой и периодом
            let periodStr = '';
            if (fromMonth && toMonth) {
                periodStr = `_${fromMonth}_${toMonth}`;
            } else if (fromMonth) {
                periodStr = `_от_${fromMonth}`;
            } else if (toMonth) {
                periodStr = `_до_${toMonth}`;
            }
            
            const fileName = `Детальная_отчетность_клиенты${periodStr}_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;

            // Скачиваем файл
            XLSX.writeFile(wb, fileName);

            showAlert('Детальная отчетность экспортирована в Excel!', 'success');
        }

        function updateInvoicesList(invoices) {
            const container = document.getElementById('confirmedInvoicesList');
            if(!container) return;

            if (invoices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Нет утвержденных инвойсов за выбранный период</p>';
                return;
            }

            let listHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                const isDelivered = invoice.delivered || false;
                const isPaid = invoice.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Инвойс #${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} • ${date} • ${formatPriceWithCurrency(invoice.total)}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${invoice.items.length} • НДС: ${invoice.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                ${isDelivered ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Доставлен</span>' : '<span style="padding: 4px 12px; background: #e9ecef; color: #6c757d; border-radius: 4px; font-size: 12px; font-weight: 600;">Не доставлен</span>'}
                                ${isPaid ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Оплачен</span>' : '<span style="padding: 4px 12px; background: #e9ecef; color: #6c757d; border-radius: 4px; font-size: 12px; font-weight: 600;">Не оплачен</span>'}
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="Просмотреть инвойс">Просмотр</button>
                            <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="Копировать данные в новый инвойс">Копировать</button>
                            <span class="invoice-status">Утвержден</span>
                            ${invoice.clientStatus ? `<span class="status-badge ${getDocumentStatusClass(invoice.clientStatus)}">${getDocumentStatusText(invoice.clientStatus)}</span>` : '<span class="status-badge status-pending">Ожидает</span>'}
                            <button class="btn btn-danger" onclick="removeInvoiceFromStats('${invoice.number}')">Удалить</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleInvoiceStatus(invoiceNumber, statusType, isChecked) {
            const invoice = confirmedInvoices.find(inv => inv.number === invoiceNumber);
            if (invoice) {
                if (statusType === 'delivered') {
                    invoice.delivered = isChecked;
                    addLog(`Инвойс #${invoiceNumber} отмечен как ${isChecked ? 'доставленный' : 'недоставленный'}`);
                } else if (statusType === 'paid') {
                    invoice.paid = isChecked;
                    addLog(`Инвойс #${invoiceNumber} отмечен как ${isChecked ? 'оплаченный' : 'неоплаченный'}`);
                }
                
                // Сохраняем обновленные данные в localStorage
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
                
                // Обновляем отображение для изменения цвета текста
                updateStatistics();
            }
        }

        function removeInvoiceFromStats(invoiceNumber) {
            if (confirm('Удалить инвойс из статистики?')) {
                confirmedInvoices = confirmedInvoices.filter(inv => inv.number !== invoiceNumber);
                updateStatistics();
                addLog(`Инвойс #${invoiceNumber} удален из статистики`);
                showAlert('Инвойс удален из статистики!', 'success');
            }
        }

        function syncInvoiceStatuses() {
            console.log('🔄 Начинаем синхронизацию статусов инвойсов...');
            
            // Перезагружаем данные из localStorage для получения актуальных статусов
            const savedInvoices = localStorage.getItem('confirmedInvoices');
            if (!savedInvoices) {
                showAlert('Нет данных инвойсов для синхронизации', 'info');
                return;
            }
            
            try {
                const freshInvoices = JSON.parse(savedInvoices);
                let syncedCount = 0;
                let statusChanges = 0;
                
                console.log('Старые данные инвойсов:', confirmedInvoices.length);
                console.log('Свежие данные из localStorage:', freshInvoices.length);
                
                // Обновляем статусы существующих инвойсов
                confirmedInvoices.forEach((invoice, index) => {
                    const freshInvoice = freshInvoices.find(fresh => fresh.number === invoice.number);
                    if (freshInvoice) {
                        const oldStatus = invoice.clientStatus;
                        const newStatus = freshInvoice.clientStatus;
                        
                        if (oldStatus !== newStatus) {
                            confirmedInvoices[index].clientStatus = newStatus;
                            statusChanges++;
                            console.log(`Обновлен статус инвойса ${invoice.number}: ${oldStatus || 'null'} → ${newStatus || 'null'}`);
                        }
                        syncedCount++;
                    }
                });
                
                // Обновляем глобальную переменную
                window.confirmedInvoices = confirmedInvoices;
                
                // Обновляем отображение статистики
                updateStatistics();
                
                console.log(`Синхронизация завершена: ${syncedCount} инвойсов проверено, ${statusChanges} статусов обновлено`);
                
                if (statusChanges > 0) {
                    showAlert(`Синхронизация завершена! Обновлено статусов: ${statusChanges}`, 'success');
                    addLog(`Синхронизированы статусы инвойсов: ${statusChanges} изменений`);
                } else {
                    showAlert('Синхронизация завершена. Изменений статусов не обнаружено.', 'info');
                }
                
            } catch (error) {
                console.error('Ошибка при синхронизации статусов:', error);
                showAlert('Ошибка при синхронизации данных', 'danger');
            }
        }

        function viewConfirmedInvoice(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('Инвойс не найден!', 'danger');
                return;
            }

            // Создаем модальное окно для просмотра
            const modalHTML = `
                <div id="invoiceViewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e9ecef; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #212529;">Просмотр инвойса #${invoice.number}</h3>
                            <div>
                                <button class="btn btn-primary" onclick="exportModalInvoiceToPDF()">Экспорт PDF</button>
                                <button class="btn btn-success" onclick="copyInvoiceData(${invoiceIndex})">Копировать данные</button>
                                <button class="btn btn-danger" onclick="closeInvoiceViewModal()">Закрыть</button>
                            </div>
                        </div>
                        <div id="modalInvoiceContent" style="padding: 20px;">
                            ${generateInvoiceHTML(invoice)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Сохраняем данные инвойса для экспорта
            window.currentModalInvoice = invoice;
        }

        function closeInvoiceViewModal() {
            const modal = document.getElementById('invoiceViewModal');
            if (modal) {
                modal.remove();
            }
            window.currentModalInvoice = null;
        }

        function exportModalInvoiceToPDF() {
            if (!window.currentModalInvoice) {
                showAlert('Нет данных для экспорта!', 'danger');
                return;
            }

            const invoice = window.currentModalInvoice;
            const invoiceContent = generateInvoiceHTML(invoice);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Предрачун ${invoice.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            }
            
            showAlert('Инвойс готов для экспорта!', 'success');
        }

        function copyInvoiceData(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('Инвойс не найден!', 'danger');
                return;
            }

            // Переключаемся на вкладку создания инвойса
            showTab('invoice');
            
            // Закрываем модальное окно если оно открыто
            closeInvoiceViewModal();

            // Генерируем новый номер инвойса
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            const newInvoiceNumber = `${confirmedInvoices.length + 1}-${dateStr}`;

            // Заполняем основные данные (с новым номером и текущей датой)
            document.getElementById('invoiceNumber').value = newInvoiceNumber;
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Устанавливаем срок оплаты через 7 дней
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('invoiceDueDate').value = nextWeek.toISOString().split('T')[0];

            // Находим индекс клиента
            const clientIndex = clients.findIndex(c => c.name === invoice.client.name && c.mb === invoice.client.mb);
            if (clientIndex !== -1) {
                document.getElementById('invoiceClientSearch').value = invoice.client.name;
                document.getElementById('invoiceClient').value = clientIndex;
            }

            // Устанавливаем способ доставки, НДС и позив на број
            document.getElementById('invoiceDelivery').value = invoice.delivery;
            document.getElementById('invoiceVAT').value = invoice.vatRate;
            document.getElementById('invoiceReference').value = invoice.reference || '';

            // Устанавливаем адрес доставки если он отличается
            if (invoice.isDifferentDeliveryAddress) {
                document.getElementById('differentDeliveryAddress').checked = true;
                document.getElementById('deliveryAddressSection').style.display = 'block';
                
                // Заполняем поля адреса доставки если данные есть
                if (invoice.deliveryAddress) {
                    if (typeof invoice.deliveryAddress === 'string') {
                        // Если адрес - строка, заполняем ручной ввод
                        document.getElementById('deliveryManualAddressInput').checked = true;
                        document.getElementById('deliveryManualAddressSection').style.display = 'block';
                        document.getElementById('deliveryAutoAddressSection').style.display = 'none';
                        document.getElementById('deliveryClientManualAddress').value = invoice.deliveryAddress;
                    } else if (typeof invoice.deliveryAddress === 'object') {
                        // Если адрес - объект, заполняем структурированные поля
                        if (invoice.deliveryAddress.city) document.getElementById('deliveryClientCity').value = invoice.deliveryAddress.city;
                        if (invoice.deliveryAddress.municipality) document.getElementById('deliveryClientMunicipality').value = invoice.deliveryAddress.municipality;
                        if (invoice.deliveryAddress.street) document.getElementById('deliveryClientStreet').value = invoice.deliveryAddress.street;
                        if (invoice.deliveryAddress.houseNumber) document.getElementById('deliveryClientHouseNumber').value = invoice.deliveryAddress.houseNumber;
                    }
                }
            }

            // Очищаем текущие товары и добавляем товары из инвойса
            const container = document.getElementById('invoiceItems');
            container.innerHTML = '';

            invoice.items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.internalCode === item.product.internalCode);
                
                if (productIndex !== -1) {
                    const newItem = document.createElement('div');
                    newItem.className = 'invoice-items';
                    newItem.innerHTML = `
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                                <input type="hidden" class="invoice-product" value="${productIndex}">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="invoice-quantity" value="${item.quantity}" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Цена (RSD)</label>
                            <input type="number" class="invoice-price" value="${formatPrice(item.price)}" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Сумма (RSD)</label>
                            <input type="number" class="invoice-amount" value="${formatPrice(item.amount)}" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="reservation-checkbox">
                            <input type="checkbox" class="invoice-reservation" id="reservation-${index}" ${item.isReservation ? 'checked' : ''}>
                            <label for="reservation-${index}">Резервация</label>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                        </div>
                    `;
                    container.appendChild(newItem);
                    
                    // Инициализируем поиск для нового поля
                    const newSearch = newItem.querySelector('.invoice-product-search');
                    setupProductSearch(newSearch);
                }
            });

            // Пересчитываем итоги
            calculateInvoiceTotals();

            showAlert('Данные инвойса скопированы! Обновлены номер и дата.', 'success');
        }

        function exportStatisticsToPDF() {
            const fromDate = document.getElementById('statsFromDate').value;
            const toDate = document.getElementById('statsToDate').value;
            
            if (!fromDate || !toDate) { 
                showAlert('Выберите период!', 'danger'); 
                return; 
            }
            
            const filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999);
                return invoiceDate >= from && invoiceDate <= to;
            });

            if (filteredInvoices.length === 0) { 
                showAlert('Нет данных для экспорта!', 'danger'); 
                return; 
            }
            
            const reportContent = generatePDFReport(filteredInvoices, fromDate, toDate);
            
            const printWindow = window.open('', '_blank');
            if(printWindow) {
                printWindow.document.write(reportContent);
                printWindow.document.close();
                setTimeout(() => { printWindow.print(); }, 500);
            }
            
            showAlert('PDF отчет создан и готов к скачиванию!', 'success');
        }

        function generatePDFReport(invoices, fromDate, toDate) {
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = invoices.length;
            const uniqueClients = new Set(invoices.map(inv => inv.clientName || inv.client?.name || 'Unknown')).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            // Статистика по товарам
            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            name: item.product.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });

            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            // Статистика по клиентам
            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const topClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Статистика по месяцам
            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('sr-RS');
            };

            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

            // Генерация диаграммы выручки по месяцам (текстовая)
            let monthlyChartHTML = '';
            if (Object.keys(monthlyData).length > 0) {
                const maxValue = Math.max(...Object.values(monthlyData));
                Object.entries(monthlyData).forEach(([monthKey, value]) => {
                    const [year, month] = monthKey.split('-');
                    const monthName = months[parseInt(month) - 1];
                    const percentage = (value / maxValue) * 100;
                    monthlyChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${monthName} ${year}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatPriceWithCurrencyAndThousands(value)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 20px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${((value / totalRevenue) * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
            }

            // Генерация диаграммы товаров
            let productsChartHTML = '';
            if (topProducts.length > 0) {
                const maxRevenue = topProducts[0][1].revenue;
                topProducts.forEach(([code, data]) => {
                    const percentage = (data.revenue / maxRevenue) * 100;
                    const revenuePercentage = ((data.revenue / totalRevenue) * 100).toFixed(1);
                    productsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${code}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${data.name}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${data.quantity}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatPriceWithCurrencyAndThousands(data.revenue)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #28a745, #20c997); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            // Генерация диаграммы клиентов
            let clientsChartHTML = '';
            if (topClients.length > 0) {
                const maxRevenue = topClients[0][1];
                topClients.forEach(([clientName, revenue]) => {
                    const percentage = (revenue / maxRevenue) * 100;
                    const revenuePercentage = ((revenue / totalRevenue) * 100).toFixed(1);
                    const orderCount = invoices.filter(inv => (inv.clientName || inv.client?.name) === clientName).length;
                    clientsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${clientName}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatPriceWithCurrencyAndThousands(revenue)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${orderCount}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            let invoicesListHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(invoice => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                invoicesListHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 6px; border: 1px solid #ddd;"><strong>${invoice.number}</strong></td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${date}</td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${invoice.client.name}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.items.length}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatPriceWithCurrencyAndThousands(invoice.total)}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.vatRate}%</td>
                    </tr>
                `;
            });

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отчет по продажам</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 11px; line-height: 1.3; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #212529; padding-bottom: 15px; }
                        .logo { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; page-break-inside: avoid; }
                        th { background: #212529; color: white; padding: 8px; text-align: left; font-size: 10px; }
                        td { border: 1px solid #ddd; padding: 6px; font-size: 10px; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
                        .stat-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; text-align: center; border-left: 3px solid #212529; }
                        .stat-number { font-size: 16px; font-weight: bold; color: #212529; margin-bottom: 3px; }
                        .stat-label { font-size: 9px; color: #666; }
                        h2 { color: #212529; border-bottom: 1px solid #212529; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 14px; }
                        h3 { color: #212529; margin: 15px 0 8px 0; font-size: 12px; }
                        .section { page-break-inside: avoid; margin-bottom: 20px; }
                        .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #212529; color: #666; font-size: 9px; }
                    </style>
                </head>
                <body>
                    <!-- Заголовок с логотипом -->
                    <div class="header">
                        <div class="logo">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="Среħа 2024 ДОО" style="width: 60px; height: auto; background: #000; border-radius: 8px; padding: 6px;">
                            <div style="text-align: left;">
                                <h1 style="margin: 0; color: #212529; font-size: 18px;">Среħа 2024 ДОО</h1>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">Београд, Стари Град, Мајке Јевросиме 35</p>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">МБ: 22019309 | ПИБ: 114407658</p>
                            </div>
                        </div>
                        <h2 style="margin: 10px 0 5px 0; font-size: 16px; border: none;">ОТЧЕТ ПО ПРОДАЖАМ</h2>
                        <p style="margin: 0; color: #666; font-size: 11px;">
                            Период: ${formatDate(fromDate)} - ${formatDate(toDate)} | 
                            Сгенерировано: ${new Date().toLocaleDateString('sr-RS')} в ${new Date().toLocaleTimeString('sr-RS')}
                        </p>
                    </div>

                    <!-- Общая статистика -->
                    <div class="section">
                        <h2>КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-number">${formatPriceWithCurrencyAndThousands(totalRevenue)}</div>
                                <div class="stat-label">Общая выручка</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${totalInvoicesCount}</div>
                                <div class="stat-label">Количество инвойсов</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${uniqueClients}</div>
                                <div class="stat-label">Уникальных клиентов</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${formatPriceWithCurrencyAndThousands(averageOrder)}</div>
                                <div class="stat-label">Средний заказ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Выручка по месяцам -->
                    ${Object.keys(monthlyData).length > 0 ? `
                    <div class="section">
                        <h2>ВЫРУЧКА ПО МЕСЯЦАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Месяц</th>
                                    <th>Выручка</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Топ товаров -->
                    ${topProducts.length > 0 ? `
                    <div class="section">
                        <h2>ТОП ТОВАРОВ ПО ПРОДАЖАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Код</th>
                                    <th>Название</th>
                                    <th>Кол-во</th>
                                    <th>Выручка</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Топ клиентов -->
                    ${topClients.length > 0 ? `
                    <div class="section">
                        <h2>ТОП КЛИЕНТОВ ПО ВЫРУЧКЕ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Клиент</th>
                                    <th>Выручка</th>
                                    <th>Заказов</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clientsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Детализация инвойсов -->
                    <div class="section">
                        <h2>ДЕТАЛИЗАЦИЯ ПО ИНВОЙСАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>№ Инвойса</th>
                                    <th>Дата</th>
                                    <th>Клиент</th>
                                    <th>Товаров</th>
                                    <th>Сумма</th>
                                    <th>НДС</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoicesListHTML}
                            </tbody>
                        </table>
                    </div>

                    <!-- Подвал -->
                    <div class="footer">
                        <p><strong>Среħа 2024 ДОО</strong> | Београд, Стари Град, Мајке Јевросиме 35 | МБ: 22019309 | ПИБ: 114407658</p>
                        <p>Этот отчет содержит ${totalInvoicesCount} инвойсов на общую сумму ${formatPriceWithCurrencyAndThousands(totalRevenue)}</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Обработчики событий
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('invoice-quantity')) {
                const row = e.target.closest('.invoice-items');
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                
                if (productIndex !== '') {
                    const product = products[productIndex];
                    const quantity = parseInt(e.target.value) || 1;
                    const amountInput = row.querySelector('.invoice-amount');
                    amountInput.value = formatPrice(product.price * quantity);
                }
                calculateInvoiceTotals();
            }

            if (e.target.id === 'invoiceVAT') {
                calculateInvoiceTotals();
            }
        });

        // Логи действий
        function addLog(message) {
            const logsList = document.getElementById('logsList');
            const li = document.createElement('li');
            li.textContent = message;
            logsList.appendChild(li);
            logsList.scrollTop = logsList.scrollHeight;
        }

        function clearLogs() {
            if(confirm('Очистить все логи?')) {
                localStorage.removeItem('actionLogs');
                updateLogsList();
            }
        }

        function exportLogsToExcel() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            
            if (logs.length === 0) {
                showAlert('Нет логов для экспорта!', 'danger');
                return;
            }

            // Создаем CSV контент
            let csvContent = '\uFEFF'; // BOM для правильного отображения кириллицы в Excel
            csvContent += 'Время,Действие\n';
            
            logs.forEach(log => {
                // Экранируем кавычки и переносы строк
                const time = `"${log.time.replace(/"/g, '""')}"`;
                const action = `"${log.action.replace(/"/g, '""')}"`;
                csvContent += `${time},${action}\n`;
            });

            // Создаем Blob с типом для Excel
            const blob = new Blob([csvContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            
            // Создаем ссылку для скачивания
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Генерируем имя файла с текущей датой
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
            const filename = `logs_${dateStr}_${timeStr}.csv`;
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // Добавляем в DOM, кликаем и удаляем
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Освобождаем URL
            URL.revokeObjectURL(url);
            
            addLog(`Экспортировано ${logs.length} записей логов в файл ${filename}`);
            showAlert(`Логи экспортированы в файл ${filename}!`, 'success');
        }

        async function authenticate() {
            showStatus('🔐 authenticate() вызвана', '#3b82f6');
            
            // Проверяем что API загружен
            if (!window.api) {
                showStatus('❌ window.api не найден!', '#ff0000');
                document.getElementById('loginError').textContent = 'Ошибка: API не загружен';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            showStatus('✅ window.api найден', '#00ff00');
            
            if (!window.api.auth) {
                showStatus('❌ window.api.auth не найден!', '#ff0000');
                document.getElementById('loginError').textContent = 'Ошибка: API авторизации не найден';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            showStatus('✅ window.api.auth найден', '#00ff00');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            showStatus(`📝 Логин: ${username}, Пароль: ${password.length} символов`, '#3b82f6');
            
            if (!username || !password) {
                showStatus('❌ Пустые поля', '#ff0000');
                document.getElementById('loginError').textContent = 'Введите логин и пароль';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            
            try {
                showStatus('📡 Вызываем window.api.auth.login...', '#3b82f6');
                // Вызываем API авторизации через Tauri
                const user = await window.api.auth.login(username, password);
                showStatus('✅ Получен ответ от API: ' + JSON.stringify(user), '#00ff00');
                
                // Успешная авторизация
                window.currentUser = {
                    username: user.username,
                    isAdmin: user.role === 'admin',
                    userType: 'regular',
                    permissions: {
                        clients: true,
                        products: true,
                        warehouse: true,
                        invoice: true,
                        delivery: true,
                        statistics: true,
                        logs: true,
                        editUsers: user.role === 'admin'
                    }
                };
                
                showStatus('🎯 Скрываем форму входа...', '#3b82f6');
                // Скрываем форму входа и показываем главное окно
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('loginError').style.display = 'none';
                
                showStatus('📦 Загружаем данные из базы...', '#3b82f6');
                // Загружаем данные из базы
                await loadInitialData();
                
                showStatus('🎨 Инициализируем интерфейс...', '#3b82f6');
                // Инициализируем интерфейс
                initializeUserInterface();
                addLog(`Пользователь "${username}" вошёл в систему`);
                showStatus('✅ Авторизация завершена успешно!', '#00ff00');
                
            } catch (error) {
                // Ошибка авторизации
                showStatus('❌ ОШИБКА: ' + error.message, '#ff0000');
                showStatus('Stack: ' + (error.stack || 'нет'), '#ff0000');
                document.getElementById('loginError').textContent = 'Неверный логин или пароль';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            
            // Reset regular user form
            document.getElementById('newUserLogin').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('confirmUserPassword').value = '';
            
            // Reset client user form
            document.getElementById('newClientUserLogin').value = '';
            document.getElementById('newClientUserPassword').value = '';
            document.getElementById('confirmClientUserPassword').value = '';
            document.getElementById('newClientUserMB').value = '';
            document.getElementById('clientDataPreview').style.display = 'none';
            
            // Reset to regular user tab
            switchUserType('regular');
            
            document.getElementById('addUserError').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        function switchUserType(type) {
            // Update tab appearance
            document.getElementById('regularUserTab').classList.remove('active');
            document.getElementById('clientUserTab').classList.remove('active');
            document.getElementById(type + 'UserTab').classList.add('active');
            
            const addUserButton = document.getElementById('addUserButton');
            
            // Show/hide forms
            if (type === 'regular') {
                document.getElementById('regularUserForm').style.display = 'block';
                document.getElementById('clientUserForm').style.display = 'none';
                addUserButton.style.display = 'block';
                addUserButton.textContent = 'Добавить пользователя';
            } else {
                document.getElementById('regularUserForm').style.display = 'none';
                document.getElementById('clientUserForm').style.display = 'block';
                addUserButton.style.display = 'none'; // Скрываем кнопку для клиентов
            }
            
            // Скрываем превью при переключении
            document.getElementById('clientDataPreview').style.display = 'none';
        }

        function checkClientMB() {
            const mb = document.getElementById('newClientUserMB').value.trim();
            const previewDiv = document.getElementById('clientDataPreview');
            
            if (!mb) {
                previewDiv.style.display = 'none';
                return;
            }
            
            // Find client with matching MB
            const matchingClient = clients.find(client => client.mb === mb);
            
            if (matchingClient) {
                // Автоматически создаем клиентского пользователя
                const login = document.getElementById('newClientUserLogin').value.trim();
                const password = document.getElementById('newClientUserPassword').value.trim();
                const confirmPassword = document.getElementById('confirmClientUserPassword').value.trim();
                
                // Проверяем, заполнены ли обязательные поля
                if (!login || !password || !confirmPassword) {
                    // Показываем превью, если поля не заполнены
                    document.getElementById('clientPreviewData').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div><strong>Название:</strong> ${matchingClient.name}</div>
                            <div><strong>ПИБ:</strong> ${matchingClient.pib}</div>
                            <div><strong>Адрес:</strong> ${matchingClient.address}</div>
                            <div><strong>Контакт:</strong> ${matchingClient.contact || 'Не указан'}</div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                            💡 Заполните логин и пароль, чтобы автоматически создать профиль для этого клиента
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    return;
                }
                
                // Проверяем валидность данных
                if (password !== confirmPassword) {
                    showAlert('Пароли не совпадают', 'danger');
                    return;
                }
                
                if (login.length < 3 || password.length < 3) {
                    showAlert('Логин и пароль должны содержать минимум 3 символа', 'danger');
                    return;
                }
                
                // Проверяем, не существует ли уже такой пользователь
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (users.some(user => user.login === login)) {
                    showAlert('Пользователь с таким логином уже существует', 'danger');
                    return;
                }
                
                // Создаем клиентского пользователя автоматически
                const newUser = {
                    login: login,
                    password: password,
                    username: login,
                    isAdmin: false,
                    userType: 'client',
                    clientMB: mb,
                    permissions: {
                        warehouse: true,
                        incomingDocuments: true,
                        sales: true,
                        clients: false,
                        products: true,
                        invoice: false,
                        delivery: false,
                        statistics: false,
                        logs: false,
                        editUsers: false
                    },
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                
                console.log('Автоматически создан клиентский пользователь:', newUser);
                addLog(`Автоматически создан клиентский профиль: ${login} для ${matchingClient.name}`);
                showAlert(`Клиентский профиль для "${matchingClient.name}" успешно создан!`, 'success');
                closeAddUserModal();
                
                // Обновляем список пользователей если окно открыто
                if (document.getElementById('editUsersModal').style.display === 'block') {
                    loadUsersList();
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function addNewUser() {
            const errorDiv = document.getElementById('addUserError');
            const isClientUser = document.getElementById('clientUserForm').style.display !== 'none';
            
            console.log('=== СОЗДАНИЕ НОВОГО ПОЛЬЗОВАТЕЛЯ ===');
            console.log('isClientUser:', isClientUser);
            console.log('clientUserForm display:', document.getElementById('clientUserForm').style.display);
            console.log('regularUserForm display:', document.getElementById('regularUserForm').style.display);
            
            let login, password, confirmPassword, mb = null;
            let userFields = [];
            
            if (isClientUser) {
                login = document.getElementById('newClientUserLogin').value.trim();
                password = document.getElementById('newClientUserPassword').value.trim();
                confirmPassword = document.getElementById('confirmClientUserPassword').value.trim();
                mb = document.getElementById('newClientUserMB').value.trim();
                
                // Валидация для клиентского пользователя
                userFields = [
                    { id: 'newClientUserLogin', name: 'Логин', type: 'required' },
                    { id: 'newClientUserPassword', name: 'Пароль', type: 'required' },
                    { id: 'confirmClientUserPassword', name: 'Подтверждение пароля', type: 'required' },
                    { id: 'newClientUserMB', name: 'Матични број', type: 'mb' }
                ];
            } else {
                login = document.getElementById('newUserLogin').value.trim();
                password = document.getElementById('newUserPassword').value.trim();
                confirmPassword = document.getElementById('confirmUserPassword').value.trim();
                
                // Валидация для обычного пользователя
                userFields = [
                    { id: 'newUserLogin', name: 'Логин', type: 'required' },
                    { id: 'newUserPassword', name: 'Пароль', type: 'required' },
                    { id: 'confirmUserPassword', name: 'Подтверждение пароля', type: 'required' }
                ];
            }
            
            // Валидация с новой системой
            const validation = validateForm(userFields);
            if (!validation.isValid) {
                errorDiv.textContent = validation.errors.join('; ');
                errorDiv.style.display = 'block';
                return;
            }
            
            // Дополнительные проверки
            if (login.length < 3) {
                errorDiv.textContent = 'Логин должен содержать минимум 3 символа';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 3) {
                errorDiv.textContent = 'Пароль должен содержать минимум 3 символа';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Пароли не совпадают';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Проверяем зарезервированные логины
            if (login === 'тест' || login === 'BrankoFND') {
                errorDiv.textContent = 'Этот логин зарезервирован';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Проверяем, не существует ли уже такой пользователь
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            if (users.some(user => user.login === login)) {
                errorDiv.textContent = 'Пользователь с таким логином уже существует';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Для клиентского профиля проверяем, существует ли клиент с таким МБ
            if (isClientUser) {
                const matchingClient = clients.find(client => client.mb === mb);
                if (!matchingClient) {
                    errorDiv.textContent = 'Клиент с указанным Матични број не найден';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            // Создаем нового пользователя
            const newUser = {
                login: login,
                password: password,
                username: login,
                isAdmin: false,
                userType: isClientUser ? 'client' : 'regular',
                clientMB: isClientUser ? mb : null,
                permissions: isClientUser ? {
                    // Клиентские права доступа
                    warehouse: true,
                    incomingDocuments: true,
                    sales: true,
                    clients: false,
                    products: false,
                    invoice: false,
                    delivery: false,
                    statistics: false,
                    logs: false,
                    editUsers: false
                } : {
                    // Обычные права доступа
                    clients: true,
                    products: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    warehouse: true,
                    logs: false,
                    editUsers: false
                },
                createdAt: new Date().toISOString()
            };
            
            console.log('Создан пользователь:', newUser);
            console.log('Тип пользователя:', newUser.userType);
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            console.log('Все пользователи после добавления:', users);
            
            addLog(`Добавлен новый ${isClientUser ? 'клиентский' : 'обычный'} пользователь: ${login}`);
            showAlert('Пользователь успешно добавлен!', 'success');
            closeAddUserModal();
        }

        function openEditUsersModal() {
            // Проверяем права доступа
            if (!window.currentUser || !window.currentUser.permissions.editUsers) {
                showAlert('У вас нет прав для редактирования пользователей', 'warning');
                return;
            }
            
            document.getElementById('editUsersModal').style.display = 'block';
            loadUsersList();
        }

        function closeEditUsersModal() {
            document.getElementById('editUsersModal').style.display = 'none';
        }

        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const container = document.getElementById('usersList');
            
            console.log('=== ЗАГРУЗКА СПИСКА ПОЛЬЗОВАТЕЛЕЙ ===');
            console.log('Пользователи из localStorage:', users);
            
            let usersHTML = '';
            
            // Добавляем основного администратора
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">BF</div>
                        <div class="user-details">
                            <h5>BrankoFND</h5>
                            <p>Главный администратор</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('BrankoFND', true)">Доступ</button>
                        <button class="btn btn-danger" disabled title="Нельзя удалить администратора">Удалить</button>
                    </div>
                </div>
            `;
            
            // Добавляем тестового пользователя
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">ТУ</div>
                        <div class="user-details">
                            <h5>тест</h5>
                            <p>Тестовый пользователь (обычный)</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('тест', false)">Доступ</button>
                        <button class="btn btn-danger" disabled title="Нельзя удалить тестового пользователя">Удалить</button>
                    </div>
                </div>
            `;
            
            // Добавляем тестовый клиентский профиль
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">SV</div>
                        <div class="user-details">
                            <h5>SVDA DOO</h5>
                            <p>Тестовый клиентский профиль (МБ: 22058282)</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('SVDA DOO', true)">Доступ</button>
                        <button class="btn btn-danger" disabled title="Нельзя удалить тестовый профиль">Удалить</button>
                    </div>
                </div>
            `;
            
            // Добавляем пользователей из localStorage
            users.forEach((user, index) => {
                console.log(`Пользователь ${index}:`, user);
                console.log(`userType: "${user.userType}"`);
                
                const avatar = user.login.substring(0, 2).toUpperCase();
                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ru-RU') : 'Неизвестно';
                const userTypeText = user.userType === 'client' ? 'Клиентский профиль' : 'Обычный пользователь';
                const clientInfo = user.userType === 'client' && user.clientMB ? ` (МБ: ${user.clientMB})` : '';
                
                console.log(`userTypeText: "${userTypeText}"`);
                console.log(`clientInfo: "${clientInfo}"`);
                
                usersHTML += `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-details">
                                <h5>${user.login}</h5>
                                <p>${userTypeText}${clientInfo}</p>
                                <small>Создан: ${createdDate}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-primary" onclick="editUserPermissions('${user.login}', false, ${index})">Доступ</button>
                            <button class="btn btn-danger" onclick="deleteUser(${index})">Удалить</button>
                        </div>
                    </div>
                `;
            });
            
            if (users.length === 0) {
                usersHTML += '<p style="text-align: center; color: #666; padding: 20px;">Дополнительных пользователей нет</p>';
            }
            
            container.innerHTML = usersHTML;
        }

        function deleteUser(userIndex) {
            if (confirm('Удалить этого пользователя?')) {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const deletedUser = users[userIndex];
                
                users.splice(userIndex, 1);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                
                addLog(`Удален пользователь: ${deletedUser.login}`);
                showAlert('Пользователь удален!', 'success');
                loadUsersList();
            }
        }

        function editUserPermissions(username, isBuiltIn = false, userIndex = null) {
            window.currentEditingUser = { username, isBuiltIn, userIndex };
            
            document.getElementById('permissionsTitle').textContent = `Управление доступом - ${username}`;
            
            // Получаем текущие права пользователя
            let permissions = {};
            
            if (username === 'BrankoFND') {
                permissions = {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: true
                };
            } else if (username === 'тест') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                permissions = builtInPermissions[username] || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: false
                };
            } else if (username === 'SVDA DOO') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                permissions = builtInPermissions[username] || {
                    warehouse: true,
                    incomingDocuments: true,
                    sales: true,
                    clients: false,
                    products: false,
                    invoice: false,
                    delivery: false,
                    statistics: false,
                    logs: false,
                    editUsers: false
                };
            } else {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const user = users[userIndex];
                permissions = user.permissions || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: false,
                    editUsers: false
                };
            }
            
            // Заполняем чекбоксы
            document.getElementById('perm_clients').checked = permissions.clients || false;
            document.getElementById('perm_products').checked = permissions.products || false;
            document.getElementById('perm_warehouse').checked = permissions.warehouse || false;
            document.getElementById('perm_invoice').checked = permissions.invoice || false;
            document.getElementById('perm_delivery').checked = permissions.delivery || false;
            document.getElementById('perm_statistics').checked = permissions.statistics || false;
            document.getElementById('perm_logs').checked = permissions.logs || false;
            document.getElementById('perm_editUsers').checked = permissions.editUsers || false;
            
            // Блокируем права администратора для всех кроме BrankoFND
            const editUserLabel = document.getElementById('editUserPermLabel');
            const editUsersCheckbox = document.getElementById('perm_editUsers');
            
            if (username !== 'BrankoFND') {
                editUsersCheckbox.disabled = true;
                editUserLabel.style.opacity = '0.5';
                editUserLabel.style.background = '#f8f9fa';
                editUserLabel.style.cursor = 'not-allowed';
                editUserLabel.title = 'Только для главного администратора';
                editUsersCheckbox.style.cursor = 'not-allowed';
            } else {
                editUsersCheckbox.disabled = false;
                editUserLabel.style.opacity = '1';
                editUserLabel.style.background = '#fff3cd';
                editUserLabel.style.cursor = 'pointer';
                editUserLabel.title = '';
                editUsersCheckbox.style.cursor = 'pointer';
            }
            
            document.getElementById('userPermissionsModal').style.display = 'block';
        }

        function closeUserPermissionsModal() {
            document.getElementById('userPermissionsModal').style.display = 'none';
            window.currentEditingUser = null;
        }

        function saveUserPermissions() {
            if (!window.currentEditingUser) return;
            
            const { username, isBuiltIn, userIndex } = window.currentEditingUser;
            
            const permissions = {
                clients: document.getElementById('perm_clients').checked,
                products: document.getElementById('perm_products').checked,
                warehouse: document.getElementById('perm_warehouse').checked,
                invoice: document.getElementById('perm_invoice').checked,
                delivery: document.getElementById('perm_delivery').checked,
                statistics: document.getElementById('perm_statistics').checked,
                logs: document.getElementById('perm_logs').checked,
                editUsers: document.getElementById('perm_editUsers').checked
            };
            
            if (username === 'BrankoFND' || username === 'тест' || username === 'SVDA DOO') {
                // Для встроенных пользователей сохраняем настройки отдельно
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                builtInPermissions[username] = permissions;
                localStorage.setItem('builtInPermissions', JSON.stringify(builtInPermissions));
            } else {
                // Для обычных пользователей обновляем в основном списке
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (users[userIndex]) {
                    users[userIndex].permissions = permissions;
                    localStorage.setItem('systemUsers', JSON.stringify(users));
                }
            }
            
            addLog(`Обновлены права доступа для пользователя: ${username}`);
            showAlert('Права доступа сохранены!', 'success');
            closeUserPermissionsModal();
        }

        function initializeUserInterface() {
            // Скрываем/показываем элементы интерфейса в зависимости от прав пользователя
            if (!window.currentUser) return;
            
            const permissions = window.currentUser.permissions;
            const isClientUser = window.currentUser.userType === 'client';
            
            // Обновляем заголовок для клиентских пользователей
            if (isClientUser) {
                updateHeaderForClient();
            } else {
                // ВАЖНО: Всегда восстанавливаем стандартный заголовок для обычных пользователей,
                // иначе после предыдущего клиентского входа останутся данные клиента
                restoreStandardHeader();
            }
            
            // Для клиентских пользователей создаем специальные вкладки
            if (isClientUser) {
                createClientTabs();
            } else {
                // ВАЖНО: Всегда восстанавливаем стандартные вкладки при входе обычного пользователя,
                // иначе после предыдущего клиентского входа останется клиентская навигация
                restoreStandardTabs();
                // Скрываем/показываем навигационные вкладки для обычных пользователей
                const tabs = document.querySelectorAll('.nav-tab');
                tabs.forEach(tab => {
                    const tabName = tab.textContent.toLowerCase();
                    let hasAccess = true;
                    
                    if (tabName.includes('клиенты')) hasAccess = permissions.clients;
                    else if (tabName.includes('товары')) hasAccess = permissions.products;
                    else if (tabName.includes('склад')) hasAccess = permissions.warehouse;
                    else if (tabName.includes('инвойс')) hasAccess = permissions.invoice;
                    else if (tabName.includes('отпремница')) hasAccess = permissions.delivery;
                    else if (tabName.includes('статистика')) hasAccess = permissions.statistics;
                    
                    if (!hasAccess) {
                        tab.style.display = 'none';
                    } else {
                        tab.style.display = 'block';
                    }
                });
            }
            
            // Скрываем кнопку логов если нет доступа
            const logsBtn = document.querySelector('[onclick="openLogsModal()"]');
            if (logsBtn) {
                if (permissions.logs) {
                    logsBtn.style.display = 'block';
                } else {
                    logsBtn.style.display = 'none';
                }
            }
            
            // Скрываем поле выбора клиента для клиентских пользователей
            const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
            if (clientSelectionGroup) {
                if (isClientUser) {
                    clientSelectionGroup.style.display = 'none';
                } else {
                    clientSelectionGroup.style.display = 'block';
                }
            }
            
            // Показываем кнопку "Показать все товары" только для админов
            const showAllProductsBtn = document.getElementById('showAllProductsBtn');
            
            if (window.currentUser && (window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND')) {
                if (showAllProductsBtn) showAllProductsBtn.style.display = 'inline-block';
            } else {
                if (showAllProductsBtn) showAllProductsBtn.style.display = 'none';
            }
            
            // Скрываем кнопку редактирования пользователей
            const editUsersBtn = document.querySelector('[onclick="openEditUsersModal()"]');
            if (editUsersBtn) {
                if (permissions.editUsers) {
                    editUsersBtn.style.display = 'block';
                } else {
                    editUsersBtn.style.display = 'none';
                }
            }
            
            // Скрываем кнопку добавления пользователя для клиентов
            const addUserBtn = document.querySelector('[onclick="openAddUserModal()"]');
            if (addUserBtn) {
                if (isClientUser) {
                    addUserBtn.style.display = 'none';
                } else {
                    addUserBtn.style.display = 'block';
                }
            }
            
            // Проверяем расходники с низким остатком (только для обычных пользователей)
            if (!isClientUser) {
                setTimeout(() => {
                    checkLowStockConsumables();
                }, 1500); // Задержка для загрузки данных
            }
        }

        function updateHeaderForClient() {
            if (!window.currentUser || !window.currentUser.clientMB) return;
            
            // Находим клиента по МБ
            const client = clients.find(c => c.mb === window.currentUser.clientMB);
            if (!client) return;
            
            // Обновляем заголовок
            const headerTitle = document.querySelector('.header h1');
            const headerSubtitle = document.querySelector('.header p');
            
            if (headerTitle) {
                headerTitle.textContent = client.legalName || client.name;
            }
            
            if (headerSubtitle) {
                headerSubtitle.textContent = `МБ: ${client.mb} | ПИБ: ${client.pib} | ${client.address}`;
            }
        }

        // Функция для восстановления стандартного заголовка
        function restoreStandardHeader() {
            console.log('=== ВОССТАНОВЛЕНИЕ СТАНДАРТНОГО ЗАГОЛОВКА ===');
            
            const headerTitle = document.querySelector('.header h1');
            const headerSubtitles = document.querySelectorAll('.header p');
            
            if (headerTitle) {
                headerTitle.textContent = 'Среħа 2024 ДОО';
                console.log('✅ Заголовок восстановлен: Среħа 2024 ДОО');
            }
            
            // Восстанавливаем все подзаголовки
            if (headerSubtitles.length >= 1) {
                headerSubtitles[0].textContent = 'Система управления инвойсами и отпремницами';
                console.log('✅ Первый подзаголовок восстановлен');
            }
            
            if (headerSubtitles.length >= 2) {
                headerSubtitles[1].textContent = 'Београд, Стари Град, Мајке Јевросиме 35 | МБ: 22019309 | ПИБ: 114407658';
                headerSubtitles[1].style.fontSize = '14px';
                headerSubtitles[1].style.opacity = '0.8';
                console.log('✅ Второй подзаголовок восстановлен');
            }
            
            console.log('✅ Стандартный заголовок полностью восстановлен');
        }

        function createClientTabs() {
            const navigation = document.querySelector('.nav-tabs');
            if (!navigation) return;
            
            // Полностью очищаем навигацию
            navigation.innerHTML = '';
            
            // Скрываем все стандартные контентные блоки
            const standardTabContents = document.querySelectorAll('.tab-content');
            standardTabContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Создаем клиентские вкладки
            const clientTabs = [
                { id: 'clientWarehouseTab', text: 'Склад', target: 'warehouse' },
                { id: 'clientMainProductsTab', text: 'Товары', target: 'products' }
                // Убрали дублирующие вкладки - они добавляются в createClientTabContent()
            ];
            
            clientTabs.forEach((tabInfo, index) => {
                const tab = document.createElement('button');
                tab.id = tabInfo.id;
                tab.className = 'nav-tab';
                if (index === 0) tab.classList.add('active'); // Первая вкладка активна
                tab.textContent = tabInfo.text;
                tab.onclick = (e) => showTab(tabInfo.target, e);
                navigation.appendChild(tab);
            });
            
            // Создаем контент для новых вкладок
            createClientTabContent();
            
            // Скрываем форму создания групп для клиентов
            const groupCreationForm = document.getElementById('groupCreationForm');
            if (groupCreationForm) {
                groupCreationForm.style.display = 'none';
            }
            
            // Показываем первую вкладку по умолчанию
            setTimeout(() => {
                showTab('warehouse');
            }, 100);
        }

        function restoreStandardTabs() {
            console.log('=== ВОССТАНОВЛЕНИЕ СТАНДАРТНЫХ ВКЛАДОК ===');
            
            const navigation = document.querySelector('.nav-tabs');
            if (!navigation) return;
            
            // Восстанавливаем стандартные вкладки
            navigation.innerHTML = `
                <button class="nav-tab active" onclick="showTab('clients')">Клиенты</button>
                <button class="nav-tab" onclick="showTab('products')">Товары</button>
                <button class="nav-tab" onclick="showTab('warehouse')">Склад</button>
                <button class="nav-tab" onclick="showTab('invoice')">Документы</button>
                <button class="nav-tab" onclick="showTab('orders')">Заказы</button>
                <button class="nav-tab" onclick="showTab('expenses')">Расходы</button>
                <button class="nav-tab" onclick="showTab('statistics')">Статистика</button>
            `;
            
            // Сбрасываем стили для стандартных контентных блоков (скрываем все)
            const standardTabContents = document.querySelectorAll('.tab-content');
            standardTabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Удаляем только специфичные клиентские контентные блоки (не трогаем products)
            const clientTabs = ['incomingDocuments', 'clientSales'];
            clientTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) tab.remove();
            });
            
            // Восстанавливаем отображение фильтра товаров для обычных пользователей
            const filterContainer = document.getElementById('productUserFilter')?.parentElement;
            if (filterContainer) {
                filterContainer.style.display = 'block';
            }
            
            // Показываем поле выбора клиента для товаров
            const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
            if (clientSelectionGroup) {
                clientSelectionGroup.style.display = 'block';
            }
            
            // Восстанавливаем стандартный заголовок
            restoreStandardHeader();
            
            // Делаем активной первую стандартную вкладку
            showTab('clients');
            
            // Принудительно обновляем интерфейс для админа
            setTimeout(() => {
                if (window.currentUser && (window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND')) {
                    // Показываем кнопку "Показать все товары"
                    const showAllProductsBtn = document.getElementById('showAllProductsBtn');
                    if (showAllProductsBtn) {
                        showAllProductsBtn.style.display = 'inline-block';
                    }
                    
                    // Обновляем таблицу товаров в обычном режиме
                    if (document.getElementById('products')?.style.display !== 'none') {
                        renderProductsTable();
                    }
                }
            }, 100);
            
            console.log('✅ Стандартные вкладки восстановлены');
        }

        function createClientTabContent() {
            const container = document.querySelector('.container');
            if (!container) return;

            // Добавляем навигацию для клиентских вкладок
            const navTabs = document.querySelector('.nav-tabs');
            if (navTabs) {
                // Добавляем кнопки для клиентских функций
                const incomingDocsBtn = document.createElement('button');
                incomingDocsBtn.className = 'nav-tab';
                incomingDocsBtn.textContent = 'Входящие документы';
                incomingDocsBtn.onclick = () => showTab('incomingDocuments');
                
                const salesBtn = document.createElement('button');
                salesBtn.className = 'nav-tab';
                salesBtn.textContent = 'Продажи';
                salesBtn.onclick = () => {
                    showTab('clientSales');
                    // Обновляем товары при переходе на вкладку продаж
                    setTimeout(() => loadSalesProducts(), 100);
                };
                
                const orderBtn = document.createElement('button');
                orderBtn.className = 'nav-tab';
                orderBtn.textContent = 'Заказ';
                orderBtn.onclick = () => {
                    showTab('clientOrder');
                    // Обновляем товары при переходе на вкладку заказов
                    setTimeout(() => loadOrderProducts(), 100);
                };
                
                navTabs.appendChild(incomingDocsBtn);
                navTabs.appendChild(salesBtn);
                navTabs.appendChild(orderBtn);
            }

            // Создаем вкладку "Входящие документы"
            const incomingDocsTab = document.createElement('div');
            incomingDocsTab.id = 'incomingDocuments';
            incomingDocsTab.className = 'tab-content';
            incomingDocsTab.innerHTML = `
                <h2>Входящие документы</h2>
                <div class="section-card">
                    <h3>Инвойсы</h3>
                    <div id="incomingInvoicesList" class="table-container">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            Нет входящих инвойсов
                        </div>
                    </div>
                </div>
                <div class="section-card">
                    <h3>Отпремницы</h3>
                    <div id="incomingDeliveriesList" class="table-container">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            Нет входящих отпремниц
                        </div>
                    </div>
                </div>
            `;
            
            // Создаем вкладку "Продажи"
            const salesTab = document.createElement('div');
            salesTab.id = 'clientSales';
            salesTab.className = 'tab-content';
            salesTab.innerHTML = `
                <h2>Продажи</h2>
                
                <!-- Список товаров для продажи -->
                <div class="section-card">
                    <h3>Выберите товары для продажи</h3>
                    <div id="salesProductsList" class="table-container">
                        <table class="table" id="salesProductsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Выбрать</th>
                                    <th>Код</th>
                                    <th>Название</th>
                                    <th>Вес (г)</th>
                                    <th style="width: 120px;">Количество</th>
                                    <th style="width: 100px;">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="salesProductsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #666;">Товары для продажи не найдены</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="processSale()">Учесть продажу</button>
                        <button class="btn btn-secondary" onclick="clearSalesForm()">Очистить выбор</button>
                        <button class="btn btn-info" onclick="debugSalesProducts()" style="margin-left: 10px;">Отладка товаров</button>
                    </div>
                </div>

                <!-- История продаж -->
                <div class="section-card" style="margin-top: 30px;">
                    <h3>История продаж</h3>
                    <div id="clientSalesHistory" class="table-container">
                        <table class="table" id="salesHistoryTable">
                            <thead>
                                <tr>
                                    <th>Дата и время</th>
                                    <th>Товары</th>
                                    <th>Общее количество</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="salesHistoryTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #666;">История продаж пуста</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Создаем вкладку "Заказ"
            const orderTab = document.createElement('div');
            orderTab.id = 'clientOrder';
            orderTab.className = 'tab-content';
            orderTab.innerHTML = `
                <h2>Заказ</h2>
                
                <!-- Список товаров для заказа -->
                <div class="section-card">
                    <h3>Выберите товары для заказа</h3>
                    <div id="orderProductsList" class="table-container">
                        <table class="table" id="orderProductsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Выбрать</th>
                                    <th>Код</th>
                                    <th>Название</th>
                                    <th>Вес (г)</th>
                                    <th style="width: 120px;">Количество</th>
                                </tr>
                            </thead>
                            <tbody id="orderProductsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #666;">Товары для заказа не найдены</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="placeOrder()">Разместить товар</button>
                        <button class="btn btn-secondary" onclick="clearOrderForm()">Очистить выбор</button>
                    </div>
                </div>
            `;
            
            // Добавляем новые вкладки в контейнер
            const existingTabs = container.querySelector('.tab-content');
            if (existingTabs && existingTabs.parentNode) {
                existingTabs.parentNode.appendChild(incomingDocsTab);
                existingTabs.parentNode.appendChild(salesTab);
                existingTabs.parentNode.appendChild(orderTab);
            }
            
            // Загружаем входящие документы и товары для продаж
            loadIncomingDocuments();
            console.log('Загружаем товары для продаж при создании вкладки...');
            loadSalesProducts();
            
            // Загружаем товары для продаж с задержкой
            setTimeout(() => {
                loadSalesProducts();
            }, 200);
        }

        function loadOrderProducts() {
            const tableBody = document.getElementById('orderProductsTableBody');
            if (!tableBody) return;
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Ошибка: клиент не определен</td></tr>';
                return;
            }
            
            // Используем clientProducts для загрузки товаров
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('Инициализированы товары клиентов из localStorage для заказов:', window.clientProducts);
            }
            
            // Проверяем и исправляем товары без internalCode
            migrateClientProductsInternalCodes();
            
            // Фильтруем товары для текущего клиента
            const clientSpecificProducts = window.clientProducts.filter(product => {
                const isForCurrentClient = product.clientMB === currentClientMB;
                const hasInternalCode = product.internalCode;
                const isAvailableForSale = product.availableForSale;
                
                console.log(`Товар ${product.name}: клиент=${isForCurrentClient}, internalCode=${hasInternalCode}, доступен=${isAvailableForSale}`);
                
                return isForCurrentClient && hasInternalCode && isAvailableForSale;
            });
            
            console.log(`Найдено товаров для заказа клиента ${currentClientMB}:`, clientSpecificProducts.length);
            
            if (clientSpecificProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">У вас нет товаров для заказа</td></tr>';
                return;
            }
            
            // Отображаем товары в таблице
            tableBody.innerHTML = clientSpecificProducts.map(product => {
                const availableQuantity = calculateAvailableQuantityForSale(product.internalCode || product.warehouseLink);
                
                return `
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" class="order-product-checkbox" data-product-code="${product.internalCode}" id="order-${product.internalCode}">
                        </td>
                        <td>${product.code || 'Не указан'}</td>
                        <td>${product.name}</td>
                        <td>${product.weight || 'Не указан'}</td>
                        <td>
                            <input type="number" 
                                   class="quantity-input" 
                                   id="quantity-${product.internalCode}" 
                                   min="1" 
                                   max="${availableQuantity}" 
                                   value="1" 
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #666; font-size: 11px;">Доступно: ${availableQuantity}</small>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('✅ Товары для заказа загружены успешно');
        }

        function clearOrderForm() {
            // Снимаем все галочки
            const checkboxes = document.querySelectorAll('.order-product-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Сбрасываем количества на 1
            const quantityInputs = document.querySelectorAll('#orderProductsTable .quantity-input');
            quantityInputs.forEach(input => {
                input.value = 1;
            });
            
            console.log('Форма заказа очищена');
        }

        function placeOrder() {
            console.log('=== РАЗМЕЩЕНИЕ ЗАКАЗА ===');
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                showAlert('Ошибка: клиент не определен', 'danger');
                return;
            }
            
            // Собираем выбранные товары
            const selectedItems = [];
            const checkboxes = document.querySelectorAll('.order-product-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showAlert('Выберите хотя бы один товар для заказа', 'warning');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const productCode = checkbox.dataset.productCode;
                const quantityInput = document.getElementById(`quantity-${productCode}`);
                const quantity = parseInt(quantityInput.value) || 1;
                
                // Находим товар в списке клиентских товаров
                const product = window.clientProducts.find(p => p.internalCode === productCode);
                if (product) {
                    selectedItems.push({
                        internalCode: product.internalCode,
                        code: product.code,
                        name: product.name,
                        weight: product.weight,
                        quantity: quantity,
                        clientMB: currentClientMB
                    });
                }
            });
            
            if (selectedItems.length === 0) {
                showAlert('Не удалось найти выбранные товары', 'danger');
                return;
            }
            
            // Создаем поруџбеницу (заказ)
            const orderForm = {
                id: generateOrderId(),
                clientMB: currentClientMB,
                clientName: getClientNameByMB(currentClientMB),
                date: new Date().toISOString(),
                items: selectedItems,
                status: 'pending' // pending, accepted, rejected
            };
            
            // Сохраняем в localStorage
            let orders = safeLocalStorage('get', 'orders') || [];
            orders.push(orderForm);
            safeLocalStorage('set', 'orders', orders);
            
            console.log('Заказ создан:', orderForm);
            
            // Очищаем форму
            clearOrderForm();
            
            // Показываем уведомление
            showAlert(`Заказ #${orderForm.id} успешно размещен!`, 'success');
            
            console.log('=== ЗАКАЗ УСПЕШНО РАЗМЕЩЕН ===');
        }

        function generateOrderId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `ORDER-${timestamp}-${random}`;
        }

        function getClientNameByMB(clientMB) {
            const clients = safeLocalStorage('get', 'clients') || [];
            const client = clients.find(c => c.mb === clientMB);
            return client ? client.name : 'Неизвестный клиент';
        }



        function loadWarehouseProductsForBinding() {
            const select = document.getElementById('clientProductWarehouseLink');
            if (!select) {
                console.error('Элемент clientProductWarehouseLink не найден');
                return;
            }
            
            console.log('Загружаем товары со склада для привязки...');
            
            // Очищаем список
            select.innerHTML = '<option value="">Выберите товар со склада...</option>';
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return;
            }
            
            // Загружаем клиентские группы для конкретного клиента
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // Получаем все товары из групп на складе
            const warehouseProducts = [];
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                window.clientProductGroups[clientMB].forEach(group => {
                    if (group.products && group.products.length > 0) {
                        group.products.forEach(productInGroup => {
                            const product = productInGroup.product;
                            if (product && !warehouseProducts.find(p => p.internalCode === product.internalCode)) {
                                // Добавляем информацию о количестве на складе
                                warehouseProducts.push({
                                    ...product,
                                    availableQuantity: group.currentQuantity,
                                    groupName: group.name
                                });
                            }
                        });
                    }
                });
            }
            
            if (warehouseProducts.length === 0) {
                const noProductsOption = document.createElement('option');
                noProductsOption.value = '';
                noProductsOption.textContent = 'Нет товаров на складе (сначала примите инвойс)';
                noProductsOption.disabled = true;
                select.appendChild(noProductsOption);
            } else {
                // Добавляем товары со склада в select
                warehouseProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.internalCode;
                    option.textContent = `${product.code} - ${product.name} (${product.weight}г) - Остаток: ${product.availableQuantity}г`;
                    select.appendChild(option);
                });
            }
            
            console.log('Загружено товаров со склада:', warehouseProducts.length);
        }

        // ===== НОВЫЕ ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ПРОДУКТАМИ КЛИЕНТА =====
        // Полностью отдельные от функций основных товаров

        function showAddClientProductForm() {
            console.log('=== ПОКАЗАТЬ ФОРМУ ДОБАВЛЕНИЯ ПРОДУКТА ===');
            const form = document.getElementById('clientProductAddForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                if (form.style.display === 'block') {
                    loadWarehouseOptionsForNewProduct();
                }
            }
        }

        function loadWarehouseOptionsForNewProduct() {
            console.log('=== ЗАГРУЗКА ОПЦИЙ СКЛАДА ДЛЯ НОВОГО ПРОДУКТА ===');
            const select = document.getElementById('newClientProductWarehouseLink');
            if (!select) return;

            // Очищаем существующие опции
            select.innerHTML = '<option value="">Без связи со складом</option>';

            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return;
            }
            
            // Загружаем клиентские группы товаров для конкретного клиента
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }

            // Добавляем опции из групп товаров на складе
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                window.clientProductGroups[clientMB].forEach(group => {
                    if (group.products && group.products.length > 0) {
                        group.products.forEach(productInGroup => {
                            const option = document.createElement('option');
                            option.value = productInGroup.product.code;
                            option.textContent = `${productInGroup.product.name} (${productInGroup.product.code}) - ${group.currentQuantity}г`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            console.log('Загружено опций склада:', select.options.length - 1);
        }

        function saveNewClientProduct() {
            console.log('=== СОХРАНЕНИЕ НОВОГО ПРОДУКТА КЛИЕНТА ===');
            
            const code = document.getElementById('newClientProductCode').value.trim();
            const name = document.getElementById('newClientProductName').value.trim();
            const weight = parseFloat(document.getElementById('newClientProductWeight').value);
            const warehouseLink = document.getElementById('newClientProductWarehouseLink').value;

            // Валидация
            if (!code) {
                showAlert('Введите код продукта!', 'danger');
                return;
            }
            if (!name) {
                showAlert('Введите название продукта!', 'danger');
                return;
            }
            if (!weight || weight <= 0) {
                showAlert('Введите корректный вес/объем!', 'danger');
                return;
            }

            // Инициализируем массив продуктов клиента
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                showAlert('Ошибка: не определен клиент!', 'danger');
                return;
            }

            // Проверяем уникальность кода
            const existingProduct = window.clientProducts.find(p => 
                p.clientMB === clientMB && p.code === code
            );
            if (existingProduct) {
                showAlert('Продукт с таким кодом уже существует!', 'danger');
                return;
            }

            // Создаем новый продукт
            const newProduct = {
                code: code,
                name: name,
                weight: weight,
                warehouseLink: warehouseLink || null,
                warehouseProduct: null,
                createdAt: new Date().toISOString(),
                clientMB: clientMB,
                autoCreated: false,
                type: 'clientProduct'
            };

            // Если есть связь со складом, находим соответствующий товар
            if (warehouseLink) {
                const warehouseProduct = findWarehouseProductByCode(warehouseLink);
                if (warehouseProduct) {
                    newProduct.warehouseProduct = warehouseProduct;
                    console.log('Продукт связан со складом:', warehouseProduct);
                }
            }

            // Сохраняем продукт
            window.clientProducts.push(newProduct);
            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('Новый продукт сохранен:', newProduct);
            addLog(`Клиент создал продукт: ${name} (${code})`);
            showAlert('Продукт успешно добавлен!', 'success');

            // Очищаем форму и обновляем отображение
            clearNewClientProductForm();
            refreshClientProductsList();
            cancelAddClientProduct();
        }

        function clearNewClientProductForm() {
            document.getElementById('newClientProductCode').value = '';
            document.getElementById('newClientProductName').value = '';
            document.getElementById('newClientProductWeight').value = '';
            document.getElementById('newClientProductWarehouseLink').value = '';
        }

        function cancelAddClientProduct() {
            const form = document.getElementById('clientProductAddForm');
            if (form) {
                form.style.display = 'none';
            }
        }

        function refreshClientProductsList() {
            console.log('=== ОБНОВЛЕНИЕ СПИСКА ПРОДУКТОВ КЛИЕНТА ===');
            renderClientProductsTable();
        }

        function editClientProduct(code) {
            console.log('=== РЕДАКТИРОВАНИЕ ПРОДУКТА КЛИЕНТА ===', code);
            
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            const product = window.clientProducts.find(p => 
                p.clientMB === clientMB && p.code === code
            );

            if (!product) {
                showAlert('Продукт не найден!', 'danger');
                return;
            }

            // Заполняем модальное окно редактирования
            document.getElementById('editClientProductName').value = product.name;
            document.getElementById('editClientProductWeight').value = product.weight;

            // Сохраняем код для последующего использования
            window.editingProductCode = code;

            // Показываем модальное окно
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function saveClientProductChangesForClient() {
            console.log('=== СОХРАНЕНИЕ ИЗМЕНЕНИЙ ПРОДУКТА (ДЛЯ КЛИЕНТА) ===');
            
            const code = window.editingProductCode;
            const name = document.getElementById('editClientProductName').value.trim();
            const weight = parseFloat(document.getElementById('editClientProductWeight').value);

            if (!name) {
                showAlert('Введите название продукта!', 'danger');
                return;
            }
            if (!weight || weight <= 0) {
                showAlert('Введите корректный вес/объем!', 'danger');
                return;
            }

            const clientMB = window.currentUser?.clientMB;
            const productIndex = window.clientProducts.findIndex(p => 
                p.clientMB === clientMB && p.code === code
            );

            if (productIndex === -1) {
                showAlert('Продукт не найден!', 'danger');
                return;
            }

            // Обновляем продукт
            window.clientProducts[productIndex].name = name;
            window.clientProducts[productIndex].weight = weight;

            // Сохраняем изменения
            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('Продукт обновлен:', window.clientProducts[productIndex]);
            addLog(`Клиент отредактировал продукт: ${name} (${code})`);
            showAlert('Продукт успешно обновлен!', 'success');

            // Закрываем модальное окно и обновляем список
            closeEditClientProductModal();
            refreshClientProductsList();

            // Обновляем список продаж если открыт
            if (document.getElementById('clientSales') && document.getElementById('clientSales').classList.contains('active')) {
                loadSalesProducts();
            }
        }

        function closeEditClientProductModal() {
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'none';
            }
            window.editingProductCode = null;
        }

        function removeClientProduct(code) {
            console.log('=== УДАЛЕНИЕ ПРОДУКТА КЛИЕНТА ===', code);
            
            if (!confirm('Вы уверены, что хотите удалить этот продукт?')) return;

            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            const initialLength = window.clientProducts.length;
            
            window.clientProducts = window.clientProducts.filter(p => 
                !(p.clientMB === clientMB && p.code === code)
            );

            if (window.clientProducts.length === initialLength) {
                showAlert('Продукт не найден!', 'danger');
                return;
            }

            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('Продукт удален:', code);
            addLog(`Клиент удалил продукт: ${code}`);
            showAlert('Продукт удален!', 'success');

            refreshClientProductsList();
        }

        function debugClientProducts() {
            console.log('=== ОТЛАДКА ПРОДУКТОВ КЛИЕНТА ===');
            console.log('Текущий пользователь:', window.currentUser);
            console.log('Все продукты клиентов:', window.clientProducts);
            
            const clientMB = window.currentUser?.clientMB;
            if (clientMB) {
                const myProducts = window.clientProducts?.filter(p => p.clientMB === clientMB) || [];
                console.log(`Продукты клиента ${clientMB}:`, myProducts);
                showAlert(`Найдено продуктов: ${myProducts.length}. Проверьте консоль браузера.`, 'info');
            } else {
                showAlert('Ошибка: клиент не определен!', 'danger');
            }
        }

        // Функции для работы с продажами
        
        // Функция для расчета доступного количества для продажи
        function calculateAvailableQuantityForSale(clientProduct) {
            console.log('Расчет доступного количества для:', clientProduct);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return 0;
            }
            
            // Загружаем клиентские группы для конкретного клиента
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // Находим группу на складе, связанную с данным товаром клиента
            // ИСПРАВЛЕНИЕ: Проверяем и по internalCode, и по code для обратной совместимости
            const warehouseLink = clientProduct.warehouseLink || clientProduct.internalCode || clientProduct.code;
            const matchingGroup = window.clientProductGroups[clientMB].find(group => 
                group.products && group.products.some(p => {
                    // Проверяем по internalCode товара в группе
                    if (p.product && p.product.internalCode === warehouseLink) return true;
                    // Fallback: проверяем по коду товара
                    if (p.product && p.product.code === warehouseLink) return true;
                    // Для старых групп: проверяем по internalCode напрямую
                    if (p.internalCode === warehouseLink) return true;
                    return false;
                })
            );
            
            if (!matchingGroup) {
                console.log(`Группа на складе не найдена для товара: ${clientProduct.code}, warehouseLink: ${warehouseLink}`);
                return 0;
            }
            
            // Получаем количество на складе (в граммах)
            const warehouseQuantity = matchingGroup.currentQuantity || 0;
            
            // Получаем вес одной единицы товара для продажи (в граммах)
            const productWeight = clientProduct.weight || 1;
            
            // Рассчитываем доступное количество = количество на складе / вес одной единицы
            const availableUnits = Math.floor(warehouseQuantity / productWeight);
            
            console.log(`Расчет для ${clientProduct.code}:`, {
                warehouseQuantity: warehouseQuantity,
                productWeight: productWeight,
                availableUnits: availableUnits
            });
            
            return Math.max(0, availableUnits);
        }
        
        function loadSalesProducts() {
            const tableBody = document.getElementById('salesProductsTableBody');
            if (!tableBody) return;
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Ошибка: клиент не определен</td></tr>';
                return;
            }
            
            // ИСПРАВЛЕНИЕ: Используем ТОЛЬКО clientProducts, НЕ window.products
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('Инициализированы товары клиентов из localStorage для продаж:', window.clientProducts);
            }
            
            // ВАЖНО: Проверяем и исправляем товары без internalCode
            migrateClientProductsInternalCodes();
            
            // Фильтруем товары только для текущего клиента
            // После миграции все товары должны иметь internalCode
            const currentClientProducts = window.clientProducts.filter(product => 
                product.clientMB === currentClientMB && 
                product.availableForSale
            );
            
            // ОТЛАДКА: Логируем товары без internalCode (если есть)
            const productsWithoutInternalCode = currentClientProducts.filter(p => !p.internalCode);
            if (productsWithoutInternalCode.length > 0) {
                console.warn('Найдены товары без internalCode после миграции:', productsWithoutInternalCode);
            }
            
            console.log('Загружаем товары для продаж (ТОЛЬКО clientProducts):', currentClientProducts.length);
            console.log('Отфильтрованные товары текущего клиента:', currentClientProducts);
            
            // Дополнительная отладка - проверяем складские группы
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            if (!window.clientProductGroups[currentClientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${currentClientMB}`);
                window.clientProductGroups[currentClientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            console.log('Складские группы для клиента:', window.clientProductGroups[currentClientMB]);
            
            if (currentClientProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Товары клиента для продажи не найдены. Товары будут созданы при принятии инвойсов.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = currentClientProducts.map(product => {
                // Рассчитываем доступное количество для продажи
                const availableQuantity = calculateAvailableQuantityForSale(product);
                const availabilityColor = availableQuantity > 0 ? '#28a745' : '#dc3545';
                const availabilityText = availableQuantity > 0 ? `Доступно: ${availableQuantity} шт.` : 'Не доступно';
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" id="sale_${product.internalCode}" class="sale-checkbox" data-product-code="${product.internalCode}" ${availableQuantity <= 0 ? 'disabled' : ''}>
                        </td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.weight}${typeof product.weight === 'number' ? 'г' : ''}</td>
                        <td>
                            <input type="number" id="qty_${product.internalCode}" class="sale-quantity" min="1" max="${availableQuantity}" placeholder="Кол-во" style="width: 100px;" ${availableQuantity <= 0 ? 'disabled' : ''}>
                            <br><small style="color: ${availabilityColor}; font-weight: bold;">${availabilityText}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditProductModal('${product.internalCode}')" title="Редактировать товар">
                                ✏️ редактируй
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function migrateClientProductsInternalCodes() {
            console.log('=== МИГРАЦИЯ ТОВАРОВ КЛИЕНТОВ ===');
            
            if (!window.clientProducts || window.clientProducts.length === 0) {
                console.log('Нет товаров клиентов для миграции');
                return;
            }
            
            let migrationNeeded = false;
            const productsToRemove = [];
            
            window.clientProducts.forEach((clientProduct, index) => {
                if (!clientProduct.internalCode) {
                    console.warn(`Товар клиента ${clientProduct.code} не имеет internalCode.`);
                    
                    // Пытаемся найти соответствующий основной товар по коду
                    const mainProduct = window.products?.find(p => p.code === clientProduct.code);
                    if (mainProduct) {
                        // ИСПРАВЛЕНИЕ: Если у основного товара нет internalCode, используем его код как internalCode
                        const internalCode = mainProduct.internalCode || mainProduct.code;
                        console.log(`Исправляем товар ${clientProduct.code}: добавляем internalCode = ${internalCode}`);
                        clientProduct.internalCode = internalCode;
                        
                        // Обновляем warehouseLink если он не определен
                        if (!clientProduct.warehouseLink) {
                            clientProduct.warehouseLink = internalCode;
                        }
                        
                        migrationNeeded = true;
                    } else {
                        console.warn(`Не удалось найти основной товар для ${clientProduct.code}. Используем код товара как internalCode.`);
                        // Используем код товара как fallback для internalCode
                        clientProduct.internalCode = clientProduct.code;
                        if (!clientProduct.warehouseLink) {
                            clientProduct.warehouseLink = clientProduct.code;
                        }
                        migrationNeeded = true;
                    }
                }
                
                // ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА: Убеждаемся, что товар имеет необходимые поля для продажи
                if (!clientProduct.availableForSale) {
                    clientProduct.availableForSale = true;
                    migrationNeeded = true;
                }
            });
            
            if (migrationNeeded) {
                console.log('Сохраняем обновленные товары клиентов после миграции');
                console.log('Товары после миграции:', window.clientProducts.filter(p => p.clientMB === window.currentUser?.clientMB));
                safeLocalStorage('set', 'clientProducts', window.clientProducts);
                showAlert('Данные товаров обновлены для совместимости с новой системой внутренних кодов.', 'info');
            } else {
                console.log('Миграция не требуется - все товары клиентов имеют корректные внутренние коды');
            }
        }

        function loadSalesHistory() {
            console.log('=== ЗАГРУЗКА ИСТОРИИ ПРОДАЖ ===');
            const tableBody = document.getElementById('salesHistoryTableBody');
            if (!tableBody) {
                console.log('Таблица истории продаж не найдена');
                return;
            }
            
            // Загружаем историю продаж
            const salesHistory = safeLocalStorage('get', 'clientSalesHistory') || [];
            const clientMB = window.currentUser?.clientMB;
            console.log('Всего записей в истории продаж:', salesHistory.length);
            console.log('Текущий клиент МБ:', clientMB);
            
            const clientSales = salesHistory.filter(sale => sale.clientMB === clientMB);
            console.log('Продажи для текущего клиента:', clientSales.length);
            
            if (clientSales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">История продаж пуста</td></tr>';
                return;
            }
            
            tableBody.innerHTML = clientSales.map((sale, index) => {
                const saleDate = new Date(sale.date).toLocaleString('ru-RU');
                const totalQuantity = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                const itemsText = sale.items.map(item => `${item.name} (${item.quantity} шт.)`).join(', ');
                
                return `
                    <tr>
                        <td>${saleDate}</td>
                        <td>${itemsText}</td>
                        <td>${totalQuantity} шт.</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteSale(${index})">Удалить</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function processSale() {
            console.log('=== НАЧАЛО ОБРАБОТКИ ПРОДАЖИ ===');
            const checkboxes = document.querySelectorAll('.sale-checkbox:checked');
            console.log('Выбранные чекбоксы:', checkboxes.length);
            
            if (checkboxes.length === 0) {
                showAlert('Выберите товары для продажи!', 'danger');
                return;
            }
            
            const saleItems = [];
            let hasErrors = false;
            
            checkboxes.forEach(checkbox => {
                const productCode = checkbox.dataset.productCode;
                
                // ВАЖНО: Проверяем, что productCode определен
                if (!productCode || productCode === 'undefined') {
                    console.error('Ошибка: productCode не определен для чекбокса:', checkbox);
                    showAlert('Ошибка: не удалось определить код товара. Попробуйте обновить страницу.', 'danger');
                    hasErrors = true;
                    return;
                }
                
                const quantityInput = document.getElementById(`qty_${productCode}`);
                if (!quantityInput) {
                    console.error(`Ошибка: не найден input для количества товара ${productCode}`);
                    showAlert(`Ошибка: не найдено поле количества для товара ${productCode}!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                const quantity = parseInt(quantityInput.value);
                
                console.log(`Обработка товара: ${productCode}, количество: ${quantity}`);
                
                if (!quantity || quantity <= 0) {
                    console.log(`Ошибка: неверное количество для товара ${productCode}`);
                    showAlert(`Укажите количество для товара ${productCode}!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                // Находим товар клиента (фильтруем по коду И по clientMB)
                console.log('Поиск товара в window.clientProducts:', window.clientProducts?.length || 0, 'товаров');
                const currentClientMB = window.currentUser?.clientMB;
                const clientProduct = window.clientProducts.find(p => p.internalCode === productCode && p.clientMB === currentClientMB);
                if (!clientProduct) {
                    console.log(`Ошибка: товар ${productCode} не найден в clientProducts`);
                    console.log('Доступные товары клиента:', window.clientProducts.filter(p => p.clientMB === currentClientMB));
                    showAlert(`Товар ${productCode} не найден!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                // Проверяем доступное количество
                const availableQuantity = calculateAvailableQuantityForSale(clientProduct);
                if (quantity > availableQuantity) {
                    console.log(`Ошибка: запрошенное количество ${quantity} превышает доступное ${availableQuantity} для товара ${productCode}`);
                    showAlert(`Недостаточно товара ${clientProduct.code}! Доступно: ${availableQuantity} шт., запрошено: ${quantity} шт.`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                console.log(`Найден товар: ${clientProduct.name}`);
                
                // ИСПРАВЛЕНО: Убираем проверку количества, просто продаем любое количество
                
                const totalWeight = quantity * clientProduct.weight;
                
                saleItems.push({
                    code: productCode,
                    name: clientProduct.name,
                    quantity: quantity,
                    weight: clientProduct.weight,
                    totalWeight: totalWeight,
                    warehouseLink: clientProduct.warehouseLink
                });
            });
            
            if (hasErrors) {
                console.log('Прерывание обработки продажи из-за ошибок');
                return;
            }
            
            console.log('Создание записи о продаже, товаров:', saleItems.length);
            console.log('Товары для продажи:', saleItems);
            
            // Создаем запись о продаже
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                clientMB: window.currentUser?.clientMB,
                items: saleItems
            };
            
            console.log('Сохранение в историю продаж, клиент МБ:', sale.clientMB);
            
            // Сохраняем в историю продаж
            let salesHistory = safeLocalStorage('get', 'clientSalesHistory') || [];
            salesHistory.push(sale);
            safeLocalStorage('set', 'clientSalesHistory', salesHistory);
            
            console.log('История продаж сохранена, всего записей:', salesHistory.length);
            
            // Уменьшаем остатки на складе
            console.log('Обновление складских остатков...');
            updateWarehouseStock(saleItems);
            
            // Запасы чая обновляются только при утверждении инвойсов администратором
            // (не при продажах клиентов)
            
            // Очищаем форму
            clearSalesForm();
            
            // Обновляем отображение
            console.log('Обновление отображения...');
            loadSalesProducts(); // Пересчитает доступные количества
            loadSalesHistory();
            
            // Обновляем склад если он открыт
            if (document.getElementById('warehouse') && document.getElementById('warehouse').classList.contains('active')) {
                renderProductGroups();
            }
            
            addLog(`Учтена продажа: ${saleItems.length} товаров`);
            showAlert('Продажа успешно учтена!', 'success');
            console.log('=== ПРОДАЖА УСПЕШНО ОБРАБОТАНА ===');
        }

        function updateWarehouseStock(saleItems) {
            console.log('=== ОБНОВЛЕНИЕ СКЛАДСКИХ ОСТАТКОВ ===');
            console.log('Товары для обновления:', saleItems);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return;
            }
            
            // Загружаем клиентские группы товаров для конкретного клиента
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                console.log(`Загружены группы товаров для ${clientMB} из localStorage:`, window.clientProductGroups[clientMB].length);
            }
            
            console.log(`Доступные группы товаров для ${clientMB}:`, window.clientProductGroups[clientMB].length);
            
            saleItems.forEach(item => {
                console.log(`Поиск группы для товара ${item.code} (warehouse link: ${item.warehouseLink})`);
                
                // Находим группу товаров на складе по внутреннему коду товара
                const group = window.clientProductGroups[clientMB].find(group => 
                    group.products && group.products.some(p => p.product.internalCode === item.warehouseLink)
                );
                
                if (group) {
                    const oldQuantity = group.currentQuantity;
                    // Уменьшаем количество в группе
                    group.currentQuantity = Math.max(0, group.currentQuantity - item.totalWeight);
                    console.log(`✅ Уменьшен остаток группы "${group.name}": ${oldQuantity}г -> ${group.currentQuantity}г (-${item.totalWeight}г)`);
                } else {
                    console.log(`❌ Группа для товара ${item.code} (warehouse link: ${item.warehouseLink}) не найдена`);
                }
            });
            
            // Сохраняем обновленные группы для конкретного клиента
            localStorage.setItem(`clientProductGroups_${clientMB}`, JSON.stringify(window.clientProductGroups[clientMB]));
            console.log(`✅ Группы товаров для ${clientMB} сохранены в localStorage`);
            
            // Обновляем максимальное количество товаров клиента для продаж
            updateClientProductsMaxQuantity();
        }

        function updateClientProductsMaxQuantity() {
            console.log('=== ОБНОВЛЕНИЕ ТОВАРОВ КЛИЕНТА (БЕЗ ОГРАНИЧЕНИЙ КОЛИЧЕСТВА) ===');
            
            // ИСПРАВЛЕНО: Убираем расчет максимального количества
            // Теперь все товары доступны без ограничений
            
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) return;
            
            // Просто убеждаемся что товары клиента сохранены
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            console.log('✅ Товары клиента обновлены (без ограничений количества)');
        }

        function clearSalesForm() {
            // Снимаем все чекбоксы
            document.querySelectorAll('.sale-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Очищаем все поля количества
            document.querySelectorAll('.sale-quantity').forEach(input => {
                input.value = '';
            });
        }

        function deleteSale(index) {
            if (!confirm('Удалить запись о продаже?')) return;
            
            let salesHistory = JSON.parse(localStorage.getItem('clientSalesHistory') || '[]');
            const clientMB = window.currentUser?.clientMB;
            const clientSales = salesHistory.filter(sale => sale.clientMB === clientMB);
            
            if (index >= 0 && index < clientSales.length) {
                const saleToDelete = clientSales[index];
                
                // Удаляем из общего массива
                salesHistory = salesHistory.filter(sale => sale.id !== saleToDelete.id);
                localStorage.setItem('clientSalesHistory', JSON.stringify(salesHistory));
                
                // Обновляем отображение
                loadSalesHistory();
                
                addLog(`Удалена запись о продаже от ${new Date(saleToDelete.date).toLocaleString('ru-RU')}`);
                showAlert('Запись о продаже удалена!', 'success');
            }
        }



        function findWarehouseProductByCode(internalCode) {
            console.log('Ищем товар на складе по внутреннему коду:', internalCode);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return null;
            }
            
            // Загружаем клиентские группы для конкретного клиента если их нет
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // Ищем товар в группах на складе
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                for (const group of window.clientProductGroups[clientMB]) {
                    if (group.products && group.products.length > 0) {
                        for (const productInGroup of group.products) {
                            if (productInGroup.product && productInGroup.product.internalCode === internalCode) {
                                const foundProduct = {
                                    ...productInGroup.product,
                                    availableQuantity: group.currentQuantity,
                                    groupName: group.name,
                                    groupId: group.id || group.name // для связи с группой
                                };
                                console.log('Найденный товар на складе:', foundProduct);
                                return foundProduct;
                            }
                        }
                    }
                }
            }
            
            console.log('Товар не найден на складе');
            return null;
        }



        function renderClientProductsTable() {
            console.log('=== ОТОБРАЖЕНИЕ ТОВАРОВ КЛИЕНТА (ТОЛЬКО clientProducts) ===');
            
            const tbody = document.getElementById('clientProductsTableBody');
            if (!tbody) {
                console.error('Элемент clientProductsTableBody не найден');
                return;
            }
            
            const currentClientMB = window.currentUser?.clientMB;
            console.log('Текущий клиент МБ:', currentClientMB);
            
            if (!currentClientMB) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 40px;">Ошибка: клиент не определен</td></tr>';
                return;
            }
            
            // ИСПРАВЛЕНИЕ: Используем ТОЛЬКО clientProducts, НЕ window.products
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('Инициализированы товары клиентов из localStorage:', window.clientProducts);
            }
            
            // Фильтруем товары только для текущего клиента
            const currentClientProducts = window.clientProducts.filter(product => 
                product.clientMB === currentClientMB
            );
            
            console.log(`Найдено товаров для клиента ${currentClientMB}:`, currentClientProducts.length);
            console.log('Товары клиента:', currentClientProducts);
            
            if (currentClientProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                            <div style="font-size: 16px; margin-bottom: 10px;">📦 Товары клиента не найдены</div>
                            <div style="font-size: 14px;">Товары будут созданы автоматически при принятии инвойсов</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Отображаем ТОЛЬКО товары клиента
            tbody.innerHTML = currentClientProducts.map((product, index) => {
                const createdDate = product.createdAt ? 
                    new Date(product.createdAt).toLocaleDateString('ru-RU') : 
                    new Date().toLocaleDateString('ru-RU');
                
                const statusText = product.warehouseProduct ? 'Привязан к складу' : 'Не привязан';
                const statusColor = product.warehouseProduct ? '#28a745' : '#ffc107';
                
                return `
                    <tr>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.weight}${typeof product.weight === 'number' ? 'г' : ''}</td>
                        <td>
                            <span class="status-badge" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${statusText}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editClientProduct('${product.code}', ${index})" title="Редактировать">
                                ✏️
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('✅ Таблица товаров клиента обновлена (ТОЛЬКО clientProducts)');
        }
        
        function editClientProduct(productCode, productIndex) {
            console.log('Редактирование товара клиента:', productCode);
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                showAlert('Ошибка: клиент не определен', 'danger');
                return;
            }
            
            // Найдем товар среди товаров текущего клиента
            const currentClientProducts = window.clientProducts.filter(p => p.clientMB === currentClientMB);
            const product = currentClientProducts[productIndex];
            
            if (!product) {
                showAlert('Товар клиента не найден', 'danger');
                return;
            }
            
            // Открываем модальное окно редактирования с предзаполненными данными
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('editClientProductCode').value = product.code;
                document.getElementById('editClientProductName').value = product.name;
                document.getElementById('editClientProductWeight').value = product.weight;
                
                // Сохраняем данные для последующего обновления
                window.editingClientProduct = {
                    originalCode: product.code,
                    clientMB: currentClientMB,
                    productIndex: productIndex
                };
            } else {
                console.error('Модальное окно editClientProductModal не найдено');
                showAlert('Ошибка интерфейса: модальное окно не найдено', 'danger');
            }
        }







        function loadIncomingDocuments() {
            if (!window.currentUser || window.currentUser.userType !== 'client') return;
            
            const clientMB = window.currentUser.clientMB;
            const client = clients.find(c => c.mb === clientMB);
            if (!client) return;
            
            console.log('Загружаем входящие документы для клиента:', clientMB);
            console.log('Всего утвержденных инвойсов:', window.confirmedInvoices?.length || 0);
            console.log('Всего утвержденных отпремниц:', window.confirmedDeliveries?.length || 0);
            
            // Используем глобальные переменные или загружаем из localStorage
            const allInvoices = window.confirmedInvoices || JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            const allDeliveries = window.confirmedDeliveries || JSON.parse(localStorage.getItem('confirmedDeliveries') || '[]');
            
            // Загружаем утвержденные инвойсы для этого клиента
            const clientInvoices = allInvoices.filter(invoice => 
                invoice.client && invoice.client.mb === clientMB && invoice.status === 'confirmed'
            );
            
            // Загружаем утвержденные отпремницы для этого клиента
            const clientDeliveries = allDeliveries.filter(delivery => 
                delivery.client && delivery.client.mb === clientMB && delivery.status === 'confirmed'
            );
            
            console.log('Инвойсы для клиента:', clientInvoices);
            console.log('Отпремницы для клиента:', clientDeliveries);
            
            renderIncomingInvoices(clientInvoices);
            renderIncomingDeliveries(clientDeliveries);
        }

        function renderIncomingInvoices(invoices) {
            const container = document.getElementById('incomingInvoicesList');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        Нет входящих инвойсов
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Номер</th>
                            <th>Дата</th>
                            <th>Сумма</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(invoice => `
                            <tr>
                                <td>${invoice.number}</td>
                                <td>${invoice.date}</td>
                                <td>${invoice.total} RSD</td>
                                <td>
                                    <span class="status-badge ${getDocumentStatusClass(invoice.clientStatus)}">
                                        ${getDocumentStatusText(invoice.clientStatus)}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${!invoice.clientStatus ? `
                                            <button class="btn btn-success btn-sm" onclick="acceptDocument('invoice', '${invoice.number}')">Принять</button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectDocument('invoice', '${invoice.number}')">Отклонить</button>
                                        ` : ''}
                                        <button class="btn btn-info btn-sm" onclick="exportDocumentPDF('invoice', '${invoice.number}')">PDF</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function renderIncomingDeliveries(deliveries) {
            const container = document.getElementById('incomingDeliveriesList');
            if (!container) return;
            
            if (deliveries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        Нет входящих отпремниц
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Номер</th>
                            <th>Дата</th>
                            <th>Товары</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${deliveries.map(delivery => `
                            <tr>
                                <td>${delivery.number}</td>
                                <td>${delivery.date}</td>
                                <td>${delivery.items.length} товар(ов)</td>
                                <td>
                                    <span class="status-badge ${getDocumentStatusClass(delivery.clientStatus)}">
                                        ${getDocumentStatusText(delivery.clientStatus)}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${!delivery.clientStatus ? `
                                            <button class="btn btn-success btn-sm" onclick="acceptDocument('delivery', '${delivery.number}')">Принять</button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectDocument('delivery', '${delivery.number}')">Отклонить</button>
                                        ` : ''}
                                        <button class="btn btn-info btn-sm" onclick="exportDocumentPDF('delivery', '${delivery.number}')">PDF</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getDocumentStatusClass(status) {
            switch(status) {
                case 'accepted': return 'status-accepted';
                case 'rejected': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        function getDocumentStatusText(status) {
            switch(status) {
                case 'accepted': return 'Принят';
                case 'rejected': return 'Отклонен';
                default: return 'Ожидает';
            }
        }

        function acceptDocument(type, number) {
            console.log('=== ПРИНЯТИЕ ДОКУМЕНТА ===');
            console.log('Тип:', type, 'Номер:', number);
            console.log('Текущий пользователь:', window.currentUser);
            
            // Используем глобальные переменные или загружаем из localStorage
            const allInvoices = window.confirmedInvoices || JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            const allDeliveries = window.confirmedDeliveries || JSON.parse(localStorage.getItem('confirmedDeliveries') || '[]');
            
            const documents = type === 'invoice' ? allInvoices : allDeliveries;
            const targetDocument = documents.find(doc => doc.number === number);
            
            console.log('Найден документ:', targetDocument);
            
            if (!targetDocument) {
                console.error('Документ не найден');
                showAlert('Документ не найден', 'error');
                return;
            }
            
            // Проверяем, не был ли документ уже принят
            if (targetDocument.clientStatus === 'accepted') {
                console.log('Документ уже принят');
                showAlert('Документ уже принят!', 'info');
                return;
            }
            
            // Блокируем кнопку на время обработки
            const acceptButton = document.querySelector(`button[onclick="acceptDocument('${type}', '${number}')"]`);
            if (acceptButton) {
                acceptButton.disabled = true;
                acceptButton.textContent = 'Обработка...';
            }
            
            // Обновляем статус документа
            targetDocument.clientStatus = 'accepted';
            console.log('Статус документа обновлен на accepted');
            
            // Для инвойсов создаем группы товаров на складе клиента
            if (type === 'invoice') {
                console.log('Создаем группы товаров для инвойса...');
                createWarehouseGroupsFromInvoice(targetDocument);
            }
            
            // Сохраняем изменения
            if (type === 'invoice') {
                safeLocalStorage('set', 'confirmedInvoices', allInvoices);
                window.confirmedInvoices = allInvoices;
            } else {
                localStorage.setItem('confirmedDeliveries', JSON.stringify(allDeliveries));
                window.confirmedDeliveries = allDeliveries;
            }
            
            addLog(`Клиент принял ${type === 'invoice' ? 'инвойс' : 'отпремницу'} ${number}`);
            showAlert('Документ принят!', 'success');
            
            // Обновляем отображение
            loadIncomingDocuments();
            
            console.log('=== ПРИНЯТИЕ ДОКУМЕНТА ЗАВЕРШЕНО ===');
        }

        function rejectDocument(type, number) {
            const documents = type === 'invoice' ? confirmedInvoices : confirmedDeliveries;
            const document = documents.find(doc => doc.number === number);
            
            if (!document) {
                showAlert('Документ не найден', 'error');
                return;
            }
            
            // Обновляем статус документа
            document.clientStatus = 'rejected';
            
            // Сохраняем изменения
            if (type === 'invoice') {
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
            } else {
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
            }
            
            addLog(`Клиент отклонил ${type === 'invoice' ? 'инвойс' : 'отпремницу'} ${number}`);
            showAlert('Документ отклонен!', 'info');
            
            // Обновляем отображение
            loadIncomingDocuments();
        }

        function createWarehouseGroupsFromInvoice(invoice) {
            console.log('=== СОЗДАНИЕ ГРУПП ТОВАРОВ ИЗ ИНВОЙСА ===');
            console.log('Инвойс:', invoice);
            console.log('Текущий пользователь:', window.currentUser);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('Не найден matični broj клиента');
                return;
            }
            
            // Инициализируем клиентские группы для конкретного клиента
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                console.log(`Загружены клиентские группы для ${clientMB} из localStorage:`, window.clientProductGroups[clientMB]);
            } else {
                console.log(`Используем существующие клиентские группы для ${clientMB}:`, window.clientProductGroups[clientMB]);
            }
            
            // Обрабатываем каждый товар из инвойса
            invoice.items.forEach(item => {
                const product = item.product;
                const productCode = product.code;
                
                // Ищем существующую группу с таким же внутренним кодом товара
                let existingGroup = window.clientProductGroups[clientMB].find(group => {
                    // Проверяем, есть ли в группе товар с таким же внутренним кодом
                    return group.products && group.products.some(p => p.product.internalCode === product.internalCode);
                });
                
                const totalQuantity = item.quantity * (product.weight || 1);
                
                if (existingGroup) {
                    // Если группа существует, суммируем количество
                    existingGroup.originalQuantity += totalQuantity;
                    existingGroup.currentQuantity += totalQuantity;
                    
                    // Обновляем дату поставки на более позднюю
                    if (new Date(invoice.date) > new Date(existingGroup.shipmentDate)) {
                        existingGroup.shipmentDate = invoice.date;
                    }
                    
                    // Добавляем информацию о поставке
                    const existingProduct = existingGroup.products.find(p => p.product.internalCode === product.internalCode);
                    if (existingProduct) {
                        existingProduct.quantity += item.quantity;
                    } else {
                        existingGroup.products.push({
                            product: product,
                            quantity: item.quantity
                        });
                    }
                    
                    console.log(`Товар ${product.name} (внутренний код: ${product.internalCode}) добавлен к существующей группе. Новое количество: ${existingGroup.currentQuantity}`);
                } else {
                    // Создаем новую группу для этого товара
                    const newGroup = {
                        name: `${product.name} (код: ${productCode})`,
                        quantityType: product.weight > 0 ? 'weight' : 'units',
                        originalQuantity: totalQuantity,
                        currentQuantity: totalQuantity,
                        shipmentDate: invoice.date,
                        reservationType: 'units',
                        reservationAmount: 0,
                        products: [{
                            product: product,
                            quantity: item.quantity
                        }]
                    };
                    
                    window.clientProductGroups[clientMB].push(newGroup);
                    console.log(`Создана новая группа для товара ${product.name} (внутренний код: ${product.internalCode}) с количеством: ${totalQuantity}`);
                }
            });
            
            // Сохраняем клиентские группы для конкретного клиента
            localStorage.setItem(`clientProductGroups_${clientMB}`, JSON.stringify(window.clientProductGroups[clientMB]));
            console.log(`Клиентские группы для ${clientMB} сохранены в localStorage`);
            
            // Автоматически создаем товары клиента для новых позиций
            console.log('Вызываем autoCreateClientProducts...');
            autoCreateClientProducts(invoice);
            
            // Обновляем отображение склада если он открыт
            if (document.getElementById('warehouse') && document.getElementById('warehouse').classList.contains('active')) {
                renderProductGroups();
            }
            
            // ИСПРАВЛЕНИЕ: Принудительно обновляем продажи (так как это клиентский профиль)
            console.log('Принудительное обновление списка товаров для продаж после добавления на склад...');
            if (document.getElementById('clientSales')) {
                loadSalesProducts();
            }
            
            console.log(`Обновленные клиентские группы для ${clientMB}:`, window.clientProductGroups[clientMB]);
        }

        function autoCreateClientProducts(invoice) {
            console.log('=== АВТОМАТИЧЕСКОЕ СОЗДАНИЕ ТОВАРОВ КЛИЕНТА ===');
            console.log('Инвойс для обработки:', invoice);
            
            const clientMB = window.currentUser?.clientMB;
            console.log('Матични број клиента:', clientMB);
            
            if (!clientMB) {
                console.error('Не найден матични број клиента - функция вызвана не из клиентского аккаунта');
                return;
            }
            
            // ВАЖНО: Инициализируем товары клиентов отдельно от товаров основных пользователей
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('Инициализированы товары клиентов из localStorage:', window.clientProducts);
            }
            
            console.log('Текущие товары всех клиентов:', window.clientProducts);
            console.log('Товары текущего клиента:', window.clientProducts.filter(p => p.clientMB === clientMB));
            
            // Обрабатываем каждый товар из инвойса
            invoice.items.forEach((item, index) => {
                console.log(`\n--- Обрабатываем товар ${index + 1} ---`);
                const product = item.product;
                const productCode = product.code;
                const productInternalCode = product.internalCode;
                
                console.log(`Товар из инвойса: ${product.name}, код: ${productCode}, внутренний код: ${productInternalCode}`);
                
                // ВАЖНО: Проверяем наличие внутреннего кода и выдаем предупреждение если его нет
                if (!productInternalCode) {
                    console.warn(`ВНИМАНИЕ: У товара ${productCode} отсутствует внутренний код. Это может быть товар, созданный до внедрения системы внутренних кодов.`);
                    console.warn('Пропускаем создание товара клиента для этого товара. Обновите товар, добавив внутренний код.');
                    return; // Пропускаем товары без внутреннего кода
                }
                
                // Проверяем, есть ли уже товар клиента с таким кодом
                const existingClientProduct = window.clientProducts.find(clientProduct => 
                    clientProduct.clientMB === clientMB && clientProduct.code === productCode
                );
                
                console.log('Существующий товар клиента с таким warehouseLink:', existingClientProduct);
                
                if (!existingClientProduct) {
                    console.log('Создаем новый товар клиента...');
                    
                    // ШАГ 1: Создаем товар клиента на основе данных из инвойса
                    console.log('--- ШАГ 1: Создание товара на основе инвойса ---');
                    
                    // Определяем вес/количество по умолчанию
                    const isWeightBased = product.weight && product.weight > 0;
                    const defaultWeight = isWeightBased ? product.weight : 1; // Используем оригинальный вес товара или 1 единица
                    
                    console.log(`Товар из инвойса - название: ${product.name}, код: ${productCode}, вес: ${product.weight}`);
                    console.log(`Определен тип: ${isWeightBased ? 'весовой' : 'штучный'}, вес по умолчанию: ${defaultWeight}`);
                    
                    // Создаем название товара клиента
                    const clientProductName = `${product.name} чайник 500мл`;
                    console.log('Название товара клиента:', clientProductName);
                    
                    // ИСПРАВЛЕНО: Используем оригинальный код товара из инвойса, как в инвойсе
                    console.log('Код товара клиента (как в инвойсе):', productCode);
                    
                    // Создаем базовый товар клиента (пока без привязки к складу)
                    const newClientProduct = {
                        code: productCode, // ИСПРАВЛЕНО: Используем оригинальный код из инвойса
                        internalCode: productInternalCode, // Добавляем внутренний код для совместимости
                        name: clientProductName,
                        weight: defaultWeight,
                        warehouseLink: productInternalCode, // Связь с товаром основной системы по внутреннему коду
                        warehouseProduct: null, // Пока без привязки
                        createdAt: new Date().toISOString(),
                        clientMB: clientMB,
                        autoCreated: true,
                        type: 'clientProduct', // Явно указываем тип
                        // Добавляем поля для продаж
                        availableForSale: true,
                        maxQuantity: 0 // Будет обновлено после привязки к складу
                    };
                    
                    console.log('Базовый товар клиента создан:', newClientProduct);
                    
                    // ШАГ 2: Ищем и связываем с соответствующей группой на складе
                    console.log('--- ШАГ 2: Поиск и связывание с группой на складе ---');
                    console.log('Ищем группу с товаром внутренний код:', productInternalCode);
                    
                    // Инициализируем клиентские группы для конкретного клиента
                    if (!window.clientProductGroups) {
                        window.clientProductGroups = {};
                    }
                    
                    if (!window.clientProductGroups[clientMB]) {
                        const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                        window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                        console.log(`Загружены клиентские группы для ${clientMB} из localStorage:`, window.clientProductGroups[clientMB]);
                    }
                    
                    console.log('Доступные группы клиента:', window.clientProductGroups[clientMB]);
                    
                    if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                        const matchingGroup = window.clientProductGroups[clientMB].find(group => 
                            group.products && group.products.some(p => p.product.internalCode === productInternalCode)
                        );
                        
                        console.log('Найденная группа на складе:', matchingGroup);
                        
                        if (matchingGroup) {
                            const productInGroup = matchingGroup.products.find(p => p.product.internalCode === productInternalCode);
                            console.log('Товар в найденной группе:', productInGroup);
                            
                            if (productInGroup) {
                                // Создаем привязку к складу
                                const warehouseProduct = {
                                    ...productInGroup.product,
                                    availableQuantity: matchingGroup.currentQuantity,
                                    groupName: matchingGroup.name,
                                    groupId: matchingGroup.id || matchingGroup.name
                                };
                                
                                // Связываем товар клиента с группой на складе
                                newClientProduct.warehouseProduct = warehouseProduct;
                                
                                // ИСПРАВЛЕНО: Убираем расчет максимального количества
                                // Товар доступен без ограничений
                                
                                console.log('✅ Товар клиента успешно связан с группой на складе:', warehouseProduct);
                                console.log('✅ Товар доступен для продажи без ограничений');
                            } else {
                                console.log('⚠️ Товар найден в группе, но не удалось извлечь данные');
                            }
                        } else {
                            console.log('⚠️ Группа с товаром не найдена на складе клиента');
                        }
                    } else {
                        console.log('⚠️ Нет доступных групп на складе клиента');
                    }
                    
                    // ШАГ 3: Добавляем товар в список товаров клиента
                    console.log('--- ШАГ 3: Сохранение товара клиента ---');
                    window.clientProducts.push(newClientProduct);
                    
                    const linkStatus = newClientProduct.warehouseProduct ? 'с привязкой к складу' : 'без привязки к складу';
                    console.log(`✅ Товар клиента создан ${linkStatus}: ${clientProductName} (код: ${newClientProduct.code})`);
                } else {
                    console.log(`ℹ️ Товар клиента для склада ${productCode} уже существует: ${existingClientProduct.name}`);
                }
            });
            
            // Сохраняем обновленные товары клиентов в отдельном ключе localStorage
            console.log('\n--- ФИНАЛЬНОЕ СОХРАНЕНИЕ ---');
            console.log('Товары клиентов для сохранения:', window.clientProducts);
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            console.log('✅ Товары клиентов сохранены в localStorage под ключом "clientProducts"');
            
            // Проверяем что сохранилось
            const savedCheck = localStorage.getItem('clientProducts');
            const parsedCheck = JSON.parse(savedCheck || '[]');
            console.log('Проверка сохранения - количество товаров в localStorage:', parsedCheck.length);
            
            // Подсчитываем результаты для текущего клиента
            const currentClientProducts = window.clientProducts.filter(p => p.clientMB === clientMB);
            const linkedProducts = currentClientProducts.filter(p => p.warehouseProduct);
            const unlinkedProducts = currentClientProducts.filter(p => !p.warehouseProduct);
            
            console.log('\n--- ИТОГОВАЯ СВОДКА ---');
            console.log(`📊 Всего товаров у клиента ${clientMB}: ${currentClientProducts.length}`);
            console.log(`🔗 Товаров с привязкой к складу: ${linkedProducts.length}`);
            console.log(`⚠️ Товаров без привязки к складу: ${unlinkedProducts.length}`);
            
            if (linkedProducts.length > 0) {
                console.log('✅ Товары с привязкой:', linkedProducts.map(p => `${p.name} → ${p.warehouseProduct.groupName}`));
            }
            if (unlinkedProducts.length > 0) {
                console.log('⚠️ Товары без привязки:', unlinkedProducts.map(p => p.name));
            }
            
            // Обновляем отображение товаров если вкладка активна
            if (document.getElementById('clientProducts') && document.getElementById('clientProducts').classList.contains('active')) {
                console.log('\n--- ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ---');
                console.log('Обновляем таблицу товаров клиента...');
                renderClientProductsTable();
            }
            
            console.log('\n🎉 === АВТОМАТИЧЕСКОЕ СОЗДАНИЕ ТОВАРОВ КЛИЕНТА ЗАВЕРШЕНО ===');
        }

        function testAutoProductCreation() {
            console.log('=== ТЕСТ АВТОСОЗДАНИЯ ТОВАРОВ ===');
            
            // Проверяем текущего пользователя
            console.log('Текущий пользователь:', window.currentUser);
            
            // Проверяем клиентские группы
            if (!window.clientProductGroups) {
                window.clientProductGroups = JSON.parse(localStorage.getItem('clientProductGroups') || '[]');
            }
            console.log('Клиентские группы:', window.clientProductGroups);
            
            // Проверяем товары клиента
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }
            console.log('Товары клиента:', window.clientProducts);
            
            // Создаем тестовый инвойс
            const testInvoice = {
                number: 'TEST-001',
                date: new Date().toISOString().split('T')[0],
                items: [
                    {
                        product: {
                            code: 'TEA001',
                            name: 'Зеленый чай премиум',
                            weight: 10
                        },
                        quantity: 5
                    }
                ]
            };
            
            console.log('Тестовый инвойс:', testInvoice);
            
            // Вызываем функцию автосоздания
            autoCreateClientProducts(testInvoice);
            
            // Обновляем таблицу
            renderClientProductsTable();
            
            showAlert('Тест автосоздания товаров выполнен! Проверьте консоль браузера для деталей.', 'info');
        }

        function debugSalesProducts() {
            console.log('=== ОТЛАДКА ТОВАРОВ ДЛЯ ПРОДАЖ ===');
            
            const currentClientMB = window.currentUser?.clientMB;
            console.log('Текущий клиент МБ:', currentClientMB);
            
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            
            const allClientProducts = window.clientProducts.filter(p => p.clientMB === currentClientMB);
            console.log('Все товары клиента:', allClientProducts);
            
            const availableForSale = allClientProducts.filter(p => p.availableForSale);
            console.log('Товары доступные для продажи:', availableForSale);
            
            const withInternalCode = availableForSale.filter(p => p.internalCode);
            console.log('Товары с внутренним кодом:', withInternalCode);
            
            // Проверяем складские группы
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[currentClientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${currentClientMB}`);
                window.clientProductGroups[currentClientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            console.log('Складские группы клиента:', window.clientProductGroups[currentClientMB]);
            
            // Проверяем доступные количества
            withInternalCode.forEach(product => {
                const availableQuantity = calculateAvailableQuantityForSale(product);
                console.log(`${product.code} (${product.name}): ${availableQuantity} шт. доступно`);
            });
            
            showAlert('Отладка завершена! Проверьте консоль браузера для подробностей.', 'info');
        }

        function checkLocalStorage() {
            console.log('=== ПРОВЕРКА LOCALSTORAGE ===');
            
            // Проверяем все ключи localStorage
            console.log('Все ключи в localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`${i + 1}. ${key}`);
            }
            
            // Проверяем конкретно инвойсы
            const invoicesData = localStorage.getItem('confirmedInvoices');
            console.log('Данные confirmedInvoices в localStorage:', invoicesData);
            
            if (invoicesData) {
                try {
                    const parsed = JSON.parse(invoicesData);
                    console.log('Количество инвойсов в localStorage:', parsed.length);
                    console.log('Инвойсы:', parsed);
                } catch (e) {
                    console.error('Ошибка парсинга данных:', e);
                }
            } else {
                console.log('Нет данных confirmedInvoices в localStorage');
            }
            
            // Проверяем глобальные переменные
            console.log('Глобальная переменная confirmedInvoices:', window.confirmedInvoices);
            console.log('Локальная переменная confirmedInvoices:', confirmedInvoices);
            
            // Проверяем размер localStorage
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            console.log('Общий размер localStorage:', totalSize, 'символов');
            
            showAlert('Проверка localStorage завершена! Смотрите консоль для деталей.', 'info');
        }

        function fixUserTypes() {
            console.log('=== ИСПРАВЛЕНИЕ ТИПОВ ПОЛЬЗОВАТЕЛЕЙ ===');
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            console.log('Пользователи до исправления:', users);
            
            let fixed = false;
            users.forEach((user, index) => {
                // Если у пользователя нет userType, устанавливаем 'regular'
                if (!user.userType) {
                    console.log(`Исправляем пользователя ${user.login}: добавляем userType = 'regular'`);
                    user.userType = 'regular';
                    fixed = true;
                }
                
                // Если пользователь имеет clientMB, но userType не 'client'
                if (user.clientMB && user.userType !== 'client') {
                    console.log(`Исправляем пользователя ${user.login}: устанавливаем userType = 'client'`);
                    user.userType = 'client';
                    fixed = true;
                }
                
                // Если пользователь не имеет clientMB, но userType = 'client'
                if (!user.clientMB && user.userType === 'client') {
                    console.log(`Исправляем пользователя ${user.login}: устанавливаем userType = 'regular'`);
                    user.userType = 'regular';
                    fixed = true;
                }
            });
            
            if (fixed) {
                localStorage.setItem('systemUsers', JSON.stringify(users));
                console.log('Пользователи после исправления:', users);
                showAlert('Типы пользователей исправлены!', 'success');
                loadUsersList(); // Обновляем список
            } else {
                console.log('Исправления не требуются');
                showAlert('Все типы пользователей корректны', 'info');
            }
        }

        // ФУНКЦИЯ: Проверка правильного разделения системы продуктов
        function checkProductSeparation() {
            console.log('=== ПРОВЕРКА РАЗДЕЛЕНИЯ СИСТЕМЫ ПРОДУКТОВ ===');
            
            const issues = [];
            
            // 1. Проверяем основные товары (products)
            console.log('🔍 ОСНОВНЫЕ ТОВАРЫ (products):');
            console.log(`   - Количество: ${products ? products.length : 0}`);
            console.log('   - Используются в: инвойсах, основных пользователях');
            console.log('   - НЕ должны использоваться клиентами');
            
            // 2. Проверяем клиентские товары
            const clientProductsInStorage = safeLocalStorage('get', 'clientProducts') || [];
            console.log('🔍 КЛИЕНТСКИЕ ТОВАРЫ (clientProducts):');
            console.log(`   - Количество в localStorage: ${clientProductsInStorage.length}`);
            console.log('   - Используются в: клиентских интерфейсах (продукты, продажи)');
            console.log('   - НЕ должны смешиваться с основными товарами');
            
            if (window.clientProducts) {
                console.log(`   - Количество в памяти: ${window.clientProducts.length}`);
            } else {
                console.log('   - В памяти не инициализированы');
            }
            
            // 3. Проверяем функции отображения
            console.log('🔍 ФУНКЦИИ ОТОБРАЖЕНИЯ:');
            console.log('   - renderClientProductsTable() использует: clientProducts ✅');
            console.log('   - loadSalesProducts() использует: clientProducts ✅');
            console.log('   - renderProductsTable() использует: products ✅');
            
            // 4. Проверяем автосоздание
            console.log('🔍 АВТОСОЗДАНИЕ ТОВАРОВ:');
            console.log('   - autoCreateClientProducts() создает товары в clientProducts ✅');
            console.log('   - Товары создаются при принятии инвойсов');
            console.log('   - Привязываются к складским группам');
            
            // 5. Проверяем текущего пользователя
            if (window.currentUser) {
                console.log('🔍 ТЕКУЩИЙ ПОЛЬЗОВАТЕЛЬ:');
                console.log(`   - Тип: ${window.currentUser.userType}`);
                if (window.currentUser.userType === 'client') {
                    console.log(`   - МБ клиента: ${window.currentUser.clientMB}`);
                    const clientProducts = clientProductsInStorage.filter(p => p.clientMB === window.currentUser.clientMB);
                    console.log(`   - Товаров клиента: ${clientProducts.length}`);
                }
            }
            
            // 6. Проверяем на смешивание данных
            console.log('🔍 ПРОВЕРКА НА СМЕШИВАНИЕ:');
            let mixingDetected = false;
            
            // Проверяем, не используются ли products в клиентских функциях
            if (typeof window.products !== 'undefined') {
                issues.push('ПРЕДУПРЕЖДЕНИЕ: window.products определена, но не должна использоваться клиентами');
                mixingDetected = true;
            }
            
            if (!mixingDetected) {
                console.log('   ✅ Смешивание данных не обнаружено');
            }
            
            // Выводим результаты
            if (issues.length === 0) {
                console.log('🎉 СИСТЕМА ПРОДУКТОВ ПРАВИЛЬНО РАЗДЕЛЕНА!');
                showAlert('✅ Проверка завершена: система продуктов корректно разделена', 'success');
            } else {
                console.log('⚠️  ОБНАРУЖЕНЫ ПРОБЛЕМЫ:');
                issues.forEach((issue, index) => {
                    console.log(`   ${index + 1}. ${issue}`);
                });
                showAlert(`⚠️ Найдено проблем: ${issues.length}. Проверьте консоль браузера.`, 'warning');
            }
            
            return issues;
        }

        // ФУНКЦИЯ: Диагностика утечек памяти
        function checkMemoryLeaks() {
            console.log('=== ДИАГНОСТИКА УТЕЧЕК ПАМЯТИ ===');
            
            const stats = EventManager.getStats();
            console.log('📊 СТАТИСТИКА ОБРАБОТЧИКОВ СОБЫТИЙ:');
            console.log(`   Всего активных обработчиков: ${stats.total}`);
            console.log('   По типам событий:', stats.byEvent);
            console.log('   По элементам:', stats.byElement);
            
            // Проверяем потенциальные проблемы
            const issues = [];
            
            if (stats.total > 100) {
                issues.push(`ПРЕДУПРЕЖДЕНИЕ: Слишком много активных обработчиков (${stats.total})`);
            }
            
            if (stats.byEvent.click > 50) {
                issues.push(`ПРЕДУПРЕЖДЕНИЕ: Много click обработчиков (${stats.byEvent.click})`);
            }
            
            // Проверяем DOM элементы без обработчиков (потенциальные утечки)
            const allElements = document.querySelectorAll('*');
            let elementsWithoutTrackedListeners = 0;
            
            allElements.forEach(element => {
                const hasTrackedListeners = EventManager.listeners.some(listener => listener.element === element);
                const hasInlineHandlers = element.onclick || element.onchange || element.oninput || element.onblur;
                
                if (hasInlineHandlers && !hasTrackedListeners) {
                    elementsWithoutTrackedListeners++;
                }
            });
            
            if (elementsWithoutTrackedListeners > 0) {
                issues.push(`УТЕЧКА ПАМЯТИ: ${elementsWithoutTrackedListeners} элементов с неотслеживаемыми обработчиками`);
            }
            
            // Проверяем глобальные переменные
            const globalVars = Object.keys(window).filter(key => 
                key.startsWith('current') || key.startsWith('confirmed') || key.includes('Products')
            );
            console.log('🌐 ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ:', globalVars.length, 'найдено');
            globalVars.forEach(varName => {
                const value = window[varName];
                if (Array.isArray(value)) {
                    console.log(`   ${varName}: массив [${value.length} элементов]`);
                } else if (typeof value === 'object' && value !== null) {
                    console.log(`   ${varName}: объект`);
                } else {
                    console.log(`   ${varName}: ${typeof value}`);
                }
            });
            
            // Выводим результаты
            if (issues.length === 0) {
                console.log('🎉 УТЕЧЕК ПАМЯТИ НЕ ОБНАРУЖЕНО!');
                showAlert('✅ Диагностика завершена: утечек памяти не найдено', 'success');
            } else {
                console.log('⚠️  ОБНАРУЖЕНЫ ПОТЕНЦИАЛЬНЫЕ УТЕЧКИ:');
                issues.forEach((issue, index) => {
                    console.log(`   ${index + 1}. ${issue}`);
                });
                showAlert(`⚠️ Найдено потенциальных утечек: ${issues.length}. Проверьте консоль браузера.`, 'warning');
            }
            
            return {
                stats: stats,
                issues: issues,
                elementsWithoutTrackedListeners: elementsWithoutTrackedListeners,
                globalVars: globalVars
            };
        }

        function debugProductCreation() {
            console.log('=== ОТЛАДКА СОЗДАНИЯ ТОВАРОВ КЛИЕНТА ===');
            
            // Проверяем текущего пользователя
            console.log('1. Текущий пользователь:', window.currentUser);
            console.log('   - Тип пользователя:', window.currentUser?.userType);
            console.log('   - Матични број:', window.currentUser?.clientMB);
            
            // Проверяем утвержденные инвойсы
            const confirmedInvoices = JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            console.log('2. Утвержденные инвойсы:', confirmedInvoices);
            console.log('   - Количество:', confirmedInvoices.length);
            
            if (confirmedInvoices.length > 0) {
                const lastInvoice = confirmedInvoices[confirmedInvoices.length - 1];
                console.log('   - Последний инвойс:', lastInvoice);
                console.log('   - Статус клиента:', lastInvoice.clientStatus);
                console.log('   - Товары в инвойсе:', lastInvoice.items);
            }
            
            // Проверяем группы товаров клиента
            const clientProductGroups = JSON.parse(localStorage.getItem('clientProductGroups') || '[]');
            console.log('3. Группы товаров клиента:', clientProductGroups);
            console.log('   - Количество групп:', clientProductGroups.length);
            
            // Проверяем товары клиента
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            console.log('4. Товары клиента:', clientProducts);
            console.log('   - Количество товаров:', clientProducts.length);
            
            if (window.currentUser?.clientMB) {
                const myProducts = clientProducts.filter(p => p.clientMB === window.currentUser.clientMB);
                console.log('   - Мои товары:', myProducts);
                console.log('   - Количество моих товаров:', myProducts.length);
            }
            
            // Проверяем основные товары системы
            const systemProducts = JSON.parse(localStorage.getItem('products') || '[]');
            console.log('5. Товары системы:', systemProducts);
            console.log('   - Количество товаров системы:', systemProducts.length);
            
            // Тестируем создание товара
            if (window.currentUser?.userType === 'client' && confirmedInvoices.length > 0) {
                console.log('6. ТЕСТИРУЕМ СОЗДАНИЕ ТОВАРА...');
                const testInvoice = confirmedInvoices.find(inv => inv.clientStatus === 'accepted');
                if (testInvoice) {
                    console.log('   - Найден принятый инвойс для теста:', testInvoice);
                    console.log('   - Вызываем autoCreateClientProducts...');
                    autoCreateClientProducts(testInvoice);
                } else {
                    console.log('   - Нет принятых инвойсов для теста');
                }
            }
            
            showAlert('Отладка завершена! Смотрите консоль браузера.', 'info');
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                // Очищаем все обработчики событий для предотвращения утечек памяти
                EventManager.removeAll();
                console.log('🧹 Все обработчики событий очищены при выходе');
                
                // Очищаем данные текущего пользователя
                window.currentUser = null;
                
                // Восстанавливаем стандартный заголовок
                restoreStandardHeader();
                
                // Скрываем основной контент и показываем форму входа
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginForm').style.display = 'flex';
                
                // Очищаем поля формы входа
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
                
                console.log('Пользователь вышел из системы');
                addLog('Пользователь вышел из системы');
            }
        }

        function exportDocumentPDF(type, number) {
            // Используем существующие функции экспорта
            if (type === 'invoice') {
                const invoice = confirmedInvoices.find(inv => inv.number === number);
                if (invoice) {
                    window.currentInvoiceData = invoice;
                    exportInvoiceToPDF();
                }
            } else {
                const delivery = confirmedDeliveries.find(del => del.number === number);
                if (delivery) {
                    window.currentDeliveryData = delivery;
                    exportDeliveryToPDF();
                }
            }
        }

        function openLogsModal() {
            // Проверяем права доступа
            if (!window.currentUser || !window.currentUser.permissions.logs) {
                showAlert('У вас нет прав для просмотра логов', 'warning');
                return;
            }
            
            document.getElementById('logsModal').style.display = 'block';
            updateLogsList(); // Обновляем список логов при открытии
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        // Функция удаления инвойса из истории
        async function deleteInvoiceFromHistory(invoiceId, docType) {
            console.log('🗑️ deleteInvoiceFromHistory:', invoiceId, docType);
            
            // Находим инвойс в соответствующем массиве
            let invoice;
            if (docType === 'predracun') {
                invoice = confirmedPredracuns.find(inv => (inv.id || inv.number) === invoiceId);
            } else if (docType === 'racun') {
                invoice = confirmedRacuns.find(inv => (inv.id || inv.number) === invoiceId);
            } else if (docType === 'delivery') {
                invoice = confirmedDeliveries.find(inv => (inv.id || inv.number) === invoiceId);
            }
            
            if (!invoice) {
                // Пробуем найти в общем массиве invoices
                invoice = invoices.find(inv => inv.id === invoiceId);
            }
            
            if (!invoice) {
                showAlert('Документ не найден', 'danger');
                return;
            }
            
            // Вызываем универсальную функцию удаления
            await deleteInvoice(invoice.id || invoiceId);
            
            // Закрываем модальное окно истории и обновляем
            document.getElementById('clientHistoryModal').style.display = 'none';
        }

        function showClientHistory(clientName) {
            const clientPredracuns = confirmedPredracuns.filter(doc => 
                doc.client && doc.client.name === clientName
            );
            const clientRacuns = confirmedRacuns.filter(doc => 
                doc.client && doc.client.name === clientName
            );
            const clientDeliveries = confirmedDeliveries.filter(doc => 
                doc.client && doc.client.name === clientName
            );

            document.getElementById('clientHistoryTitle').textContent = `История документов клиента: ${clientName}`;
            
            const totalDocs = clientPredracuns.length + clientRacuns.length + clientDeliveries.length;
            
            if (totalDocs === 0) {
                document.getElementById('clientHistoryContent').innerHTML = 
                    '<p style="text-align: center; color: #666;">У данного клиента нет утвержденных документов</p>';
            } else {
                // Создаем табы для разных типов документов
                let tabsHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                        <button class="history-tab active" onclick="switchHistoryTab('predracuns')" data-tab="predracuns" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #114A9F; color: #114A9F; font-weight: bold;">
                            Предрачуны (${clientPredracuns.length})
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('racuns')" data-tab="racuns" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #666;">
                            Рачуны (${clientRacuns.length})
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('deliveries')" data-tab="deliveries" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #666;">
                            Отпремницы (${clientDeliveries.length})
                        </button>
                    </div>
                `;
                
                // Предрачуны
                let predracunsHTML = '<div id="history-predracuns" class="history-tab-content">';
                if (clientPredracuns.length === 0) {
                    predracunsHTML += '<p style="text-align: center; color: #666;">Нет предрачунов</p>';
                } else {
                    clientPredracuns.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((doc, index) => {
                        const date = new Date(doc.date).toLocaleDateString('sr-RS');
                        const originalIndex = confirmedPredracuns.findIndex(inv => inv.number === doc.number);
                        const isDelivered = doc.delivered || false;
                        const isPaid = doc.paid || false;
                        
                        predracunsHTML += `
                            <div class="invoice-item">
                                <div class="invoice-info">
                                    <div style="font-weight: bold; color: #212529;">Предрачун #${doc.number}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">${doc.client.name} • ${date} • ${formatPriceWithCurrency(doc.total)}</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${doc.items.length} • НДС: ${doc.vatRate}%</div>
                                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="toggleDocumentStatusButton('predracun', '${doc.number}', 'delivered', true)" 
                                                    style="padding: 4px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; ${isDelivered ? 'display: none;' : ''}">
                                                Доставлен
                                            </button>
                                            <button onclick="toggleDocumentStatusButton('predracun', '${doc.number}', 'paid', true)" 
                                                    style="padding: 4px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; ${isPaid ? 'display: none;' : ''}">
                                                Оплачен
                                            </button>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            ${isDelivered ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Доставлен</span>' : ''}
                                            ${isPaid ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Оплачен</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="invoice-actions">
                                    <button class="btn btn-secondary" onclick="viewDocument('predracun', ${originalIndex})" title="Просмотреть предрачун">Просмотр</button>
                                    <button class="btn btn-success" onclick="copyDocumentData('predracun', ${originalIndex})" title="Копировать данные в новый документ">Копировать</button>
                                    <button class="btn btn-danger" onclick="deleteInvoiceFromHistory('${doc.id || doc.number}', 'predracun')" title="Удалить предрачун">🗑️ Удалить</button>
                                    <span class="invoice-status">Утвержден</span>
                                </div>
                            </div>
                        `;
                    });
                }
                predracunsHTML += '</div>';
                
                // Рачуны
                let racunsHTML = '<div id="history-racuns" class="history-tab-content" style="display: none;">';
                if (clientRacuns.length === 0) {
                    racunsHTML += '<p style="text-align: center; color: #666;">Нет рачунов</p>';
                } else {
                    clientRacuns.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((doc, index) => {
                        const date = new Date(doc.date).toLocaleDateString('sr-RS');
                        const originalIndex = confirmedRacuns.findIndex(inv => inv.number === doc.number);
                        const isDelivered = doc.delivered || false;
                        const isPaid = doc.paid || false;
                        
                        racunsHTML += `
                            <div class="invoice-item">
                                <div class="invoice-info">
                                    <div style="font-weight: bold; color: #212529;">Рачун #${doc.number}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">${doc.client.name} • ${date} • ${formatPriceWithCurrency(doc.total)}</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${doc.items.length} • НДС: ${doc.vatRate}%</div>
                                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="toggleDocumentStatusButton('racun', '${doc.number}', 'delivered', true)" 
                                                    style="padding: 4px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; ${isDelivered ? 'display: none;' : ''}">
                                                Доставлен
                                            </button>
                                            <button onclick="toggleDocumentStatusButton('racun', '${doc.number}', 'paid', true)" 
                                                    style="padding: 4px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; ${isPaid ? 'display: none;' : ''}">
                                                Оплачен
                                            </button>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            ${isDelivered ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Доставлен</span>' : ''}
                                            ${isPaid ? '<span style="padding: 4px 12px; background: #28a745; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Оплачен</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="invoice-actions">
                                    <button class="btn btn-secondary" onclick="viewDocument('racun', ${originalIndex})" title="Просмотреть рачун">Просмотр</button>
                                    <button class="btn btn-success" onclick="copyDocumentData('racun', ${originalIndex})" title="Копировать данные в новый документ">Копировать</button>
                                    <button class="btn btn-danger" onclick="deleteInvoiceFromHistory('${doc.id || doc.number}', 'racun')" title="Удалить рачун">🗑️ Удалить</button>
                                    <span class="invoice-status">Утвержден</span>
                                </div>
                            </div>
                        `;
                    });
                }
                racunsHTML += '</div>';
                
                // Отпремницы
                let deliveriesHTML = '<div id="history-deliveries" class="history-tab-content" style="display: none;">';
                if (clientDeliveries.length === 0) {
                    deliveriesHTML += '<p style="text-align: center; color: #666;">Нет отпремниц</p>';
                } else {
                    clientDeliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((doc, index) => {
                        const date = new Date(doc.date).toLocaleDateString('sr-RS');
                        const dueDate = new Date(doc.dueDate).toLocaleDateString('sr-RS');
                        const originalIndex = confirmedDeliveries.findIndex(del => del.number === doc.number);
                        const isSigned = doc.signed || false;
                        
                        deliveriesHTML += `
                            <div class="invoice-item">
                                <div class="invoice-info">
                                    <div style="font-weight: bold; color: #212529;">Отпремница #${doc.number}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">${doc.client.name} • ${date} • Срок: ${dueDate}</div>
                                    <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${doc.items.length} • Способ: ${doc.method}</div>
                                    <div style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                            <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${doc.number}', this.checked)" style="transform: scale(1.2);">
                                            <span style="color: ${isSigned ? '#28a745' : '#6c757d'};">Подписана</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="invoice-actions">
                                    <button class="btn btn-secondary" onclick="viewDelivery(${originalIndex})" title="Просмотреть отпремницу">Просмотр</button>
                                    <button class="btn btn-danger" onclick="deleteInvoiceFromHistory('${doc.id || doc.number}', 'delivery')" title="Удалить отпремницу">🗑️ Удалить</button>
                                    <span class="invoice-status">Утверждена</span>
                                </div>
                            </div>
                        `;
                    });
                }
                deliveriesHTML += '</div>';
                
                document.getElementById('clientHistoryContent').innerHTML = tabsHTML + predracunsHTML + racunsHTML + deliveriesHTML;
            }
            
            document.getElementById('clientHistoryModal').style.display = 'block';
            addLog(`Просмотрена история документов клиента: ${clientName}`);
        }
        
        function switchHistoryTab(tabName) {
            // Скрываем все табы
            document.querySelectorAll('.history-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.history-tab').forEach(btn => {
                btn.style.borderBottom = '3px solid transparent';
                btn.style.color = '#666';
                btn.style.fontWeight = 'normal';
            });
            
            // Показываем выбранный таб
            const selectedTab = document.getElementById(`history-${tabName}`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Активируем кнопку
            const activeBtn = document.querySelector(`.history-tab[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.style.borderBottom = '3px solid #114A9F';
                activeBtn.style.color = '#114A9F';
                activeBtn.style.fontWeight = 'bold';
            }
        }
        
        // Новая функция для кнопок статуса
        function toggleDocumentStatusButton(docType, docNumber, statusType, newValue) {
            const docArray = docType === 'predracun' ? confirmedPredracuns : confirmedRacuns;
            const doc = docArray.find(d => d.number === docNumber);
            
            if (!doc) return;
            
            // Определяем текст для модального окна
            const docName = docType === 'predracun' ? 'Предрачун' : 'Рачун';
            const statusName = statusType === 'delivered' ? 'доставлен' : 'оплачен';
            
            const message = `Вы уверены, что хотите отметить ${docName.toLowerCase()} #${docNumber} как "${statusName}"?`;
            
            // Показываем модальное окно подтверждения
            showStatusConfirmModal(
                message,
                `<div style="margin-top: 10px;">📄 <strong>Документ:</strong> ${docName} #${docNumber}</div>
                 <div style="margin-top: 5px;">📋 <strong>Статус:</strong> ${statusName}</div>`,
                async () => {
                    // При подтверждении - меняем статус
                    doc[statusType] = newValue;
                
                // Сохраняем в localStorage
                const storageKey = docType === 'predracun' ? 'confirmedPredracuns' : 'confirmedRacuns';
                localStorage.setItem(storageKey, JSON.stringify(docArray));
                
                    // Также сохраняем в общий массив confirmedInvoices
                    const invoiceInGeneral = confirmedInvoices.find(inv => inv.number === docNumber && inv.documentType === docType);
                    if (invoiceInGeneral) {
                        invoiceInGeneral[statusType] = newValue;
                        localStorage.setItem('confirmedInvoices', JSON.stringify(confirmedInvoices));
                    }
                    
                    // Сохраняем в базу данных через API
                    try {
                        if (doc.id) {
                            await InvoicesAPI.update(doc.id, {
                                ...doc,
                                [statusType]: newValue
                            });
                            console.log(`✅ Статус "${statusName}" сохранен в базу данных для ${docName} #${docNumber}`);
                        }
                    } catch (error) {
                        console.error('❌ Ошибка сохранения статуса в базу:', error);
                        showAlert('Статус изменен локально, но не сохранен в базу данных', 'warning');
                    }
                    
                    addLog(`${docName} #${docNumber} отмечен как ${statusName}`);
                    
                    // Обновляем отображение истории клиента
                    const clientName = doc.client?.name;
                    if (clientName) {
                        showClientHistory(clientName);
                    }
                }
            );
        }
        
        function toggleDocumentStatus(docType, docNumber, statusType, isChecked, checkboxElement) {
            // Старая функция для обратной совместимости
            toggleDocumentStatusButton(docType, docNumber, statusType, isChecked);
        }
        
        // Обертки для обратной совместимости
        function togglePredracunStatus(docNumber, statusType, isChecked) {
            toggleDocumentStatus('predracun', docNumber, statusType, isChecked);
        }
        
        function toggleRacunStatus(docNumber, statusType, isChecked) {
            toggleDocumentStatus('racun', docNumber, statusType, isChecked);
        }
        
        async function viewDocument(docType, docIndex) {
            console.log('=== viewDocument вызвана ===');
            console.log('docType:', docType);
            console.log('docIndex:', docIndex);
            
            const docArray = docType === 'predracun' ? confirmedPredracuns : confirmedRacuns;
            console.log('docArray length:', docArray.length);
            
            const doc = docArray[docIndex];
            console.log('doc:', doc);
            
            if (!doc) {
                console.error('Документ не найден!');
                showAlert('Документ не найден!', 'danger');
                return;
            }
            
            // Закрываем модальное окно истории
            closeClientHistoryModal();
            
            // Устанавливаем тип документа если его нет
            if (!doc.documentType) {
                doc.documentType = docType;
            }
            
            const docTitle = docType === 'predracun' ? 'Предрачун' : 'Рачун';
            
            // === НОВЫЙ КОД: Загружаем HTML из файла ===
            let invoiceHTML = '';
            try {
                showLoadingIndicator(true, `Загрузка ${docTitle.toLowerCase()}а...`);
                
                // Определяем номер инвойса с префиксом
                let invoiceNumber = doc.number;
                if (docType === 'predracun' && !invoiceNumber.startsWith('p')) {
                    invoiceNumber = 'p' + invoiceNumber;
                }
                
                // Определяем год и месяц из даты документа
                const docDate = new Date(doc.date);
                const year = docDate.getFullYear().toString();
                const month = (docDate.getMonth() + 1).toString().padStart(2, '0');
                
                console.log(`📂 Загружаем HTML: ${invoiceNumber}, ${docType}, ${year}, ${month}`);
                
                // Загружаем HTML файл
                const fullHTML = await window.api.invoiceHtml.load(invoiceNumber, docType, year, month);
                
                // Извлекаем содержимое body
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(fullHTML, 'text/html');
                invoiceHTML = htmlDoc.body.innerHTML;
                
                console.log(`✅ HTML загружен (${invoiceHTML.length} символов)`);
                
            } catch (error) {
                console.warn('⚠️ Не удалось загрузить HTML файл, генерируем заново:', error);
                // Fallback: генерируем HTML из данных
                invoiceHTML = generateInvoiceHTML(doc);
            } finally {
                showLoadingIndicator(false);
            }
            // === КОНЕЦ НОВОГО КОДА ===
            
            // Создаем модальное окно для просмотра
            const modalHTML = `
                <div id="invoiceViewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e9ecef; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; z-index: 1;">
                            <h3 style="margin: 0; color: #212529;">Просмотр ${docTitle} #${doc.number}</h3>
                            <div>
                                <button class="btn btn-primary" onclick="exportDocumentToPDF('${docType}', ${docIndex})">Экспорт PDF</button>
                                <button class="btn btn-success" onclick="copyDocumentData('${docType}', ${docIndex})">Копировать данные</button>
                                <button class="btn btn-danger" onclick="closeInvoiceViewModal()">Закрыть</button>
                            </div>
                        </div>
                        <div id="modalInvoiceContent" style="padding: 20px;">
                            ${invoiceHTML}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Сохраняем данные документа для экспорта
            window.currentModalInvoice = doc;
            
            addLog(`Открыт для просмотра ${docTitle} #${doc.number}`);
        }
        
        function exportDocumentToPDF(docType, docIndex) {
            const docArray = docType === 'predracun' ? confirmedPredracuns : confirmedRacuns;
            const doc = docArray[docIndex];
            
            if (!doc) {
                showAlert('Документ не найден!', 'danger');
                return;
            }

            const docTitle = docType === 'predracun' ? 'Предрачун' : 'Рачун';
            const invoiceContent = generateInvoiceHTML(doc);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${docTitle} ${doc.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            }
            
            showAlert(`${docTitle} готов для экспорта!`, 'success');
        }
        
        function copyDocumentData(docType, docIndex) {
            const docArray = docType === 'predracun' ? confirmedPredracuns : confirmedRacuns;
            const doc = docArray[docIndex];
            
            if (!doc) {
                showAlert('Документ не найден!', 'danger');
                return;
            }

            // Закрываем все модальные окна
            closeClientHistoryModal();
            closeInvoiceViewModal();
            
            // Переключаемся на вкладку создания инвойса
            showTab('invoice');

            // Генерируем новый номер инвойса
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            const totalDocs = confirmedPredracuns.length + confirmedRacuns.length;
            const newInvoiceNumber = `${totalDocs + 1}-${dateStr}`;

            // Заполняем основные данные (с новым номером и текущей датой)
            document.getElementById('invoiceNumber').value = newInvoiceNumber;
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Устанавливаем срок оплаты через 7 дней
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('invoiceDueDate').value = nextWeek.toISOString().split('T')[0];

            // Находим индекс клиента
            const clientIndex = clients.findIndex(c => c.name === doc.client.name && c.mb === doc.client.mb);
            if (clientIndex !== -1) {
                document.getElementById('invoiceClientSearch').value = doc.client.name;
                document.getElementById('invoiceClient').value = clientIndex;
            }

            // Устанавливаем способ доставки, НДС и позив на број
            document.getElementById('invoiceDelivery').value = doc.delivery || 'Лична испорука';
            document.getElementById('invoiceVAT').value = doc.vatRate || '20';
            document.getElementById('invoiceReference').value = doc.reference || '';

            // Устанавливаем адрес доставки если он отличается
            if (doc.isDifferentDeliveryAddress) {
                document.getElementById('differentDeliveryAddress').checked = true;
                document.getElementById('deliveryAddressSection').style.display = 'block';
                
                // Заполняем поля адреса доставки если данные есть
                if (doc.deliveryAddress) {
                    if (typeof doc.deliveryAddress === 'string') {
                        // Если адрес - строка, заполняем ручной ввод
                        document.getElementById('deliveryManualAddressInput').checked = true;
                        document.getElementById('deliveryManualAddressSection').style.display = 'block';
                        document.getElementById('deliveryAutoAddressSection').style.display = 'none';
                        document.getElementById('deliveryClientManualAddress').value = doc.deliveryAddress;
                    } else if (typeof doc.deliveryAddress === 'object') {
                        // Если адрес - объект, заполняем структурированные поля
                        if (doc.deliveryAddress.city) document.getElementById('deliveryClientCity').value = doc.deliveryAddress.city;
                        if (doc.deliveryAddress.municipality) document.getElementById('deliveryClientMunicipality').value = doc.deliveryAddress.municipality;
                        if (doc.deliveryAddress.street) document.getElementById('deliveryClientStreet').value = doc.deliveryAddress.street;
                        if (doc.deliveryAddress.houseNumber) document.getElementById('deliveryClientHouseNumber').value = doc.deliveryAddress.houseNumber;
                    }
                }
            }

            // Очищаем текущие товары и добавляем товары из документа
            const container = document.getElementById('invoiceItems');
            container.innerHTML = '';

            doc.items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.internalCode === item.product.internalCode);
                
                if (productIndex !== -1) {
                    const newItem = document.createElement('div');
                    newItem.className = 'invoice-items';
                    newItem.innerHTML = `
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                                <input type="hidden" class="invoice-product" value="${productIndex}">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="invoice-quantity" value="${item.quantity}" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Цена (RSD)</label>
                            <input type="number" class="invoice-price" value="${formatPrice(item.price)}" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Сумма (RSD)</label>
                            <input type="number" class="invoice-amount" value="${formatPrice(item.amount)}" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="reservation-checkbox">
                            <input type="checkbox" class="invoice-reservation" id="reservation-${index}" ${item.isReservation ? 'checked' : ''}>
                            <label for="reservation-${index}">Резервация</label>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                        </div>
                    `;
                    container.appendChild(newItem);
                    
                    // Инициализируем поиск для этого товара
                    const searchInput = newItem.querySelector('.invoice-product-search');
                    const dropdown = newItem.querySelector('.invoice-product-dropdown');
                    const hiddenInput = newItem.querySelector('.invoice-product');
                    
                    searchInput.addEventListener('input', function() {
                        filterInvoiceProducts(this.value, dropdown, hiddenInput, searchInput);
                    });
                    
                    searchInput.addEventListener('focus', function() {
                        filterInvoiceProducts(this.value, dropdown, hiddenInput, searchInput);
                    });
                    
                    document.addEventListener('click', function(e) {
                        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                            dropdown.style.display = 'none';
                        }
                    });
                }
            });

            // Пересчитываем итоги
            calculateInvoiceTotals();
            
            const docTitle = docType === 'predracun' ? 'предрачуна' : 'рачуна';
            showAlert(`Данные из ${docTitle} #${doc.number} скопированы!`, 'success');
            addLog(`Скопированы данные из ${docTitle} #${doc.number}`);
        }

        function closeClientHistoryModal() {
            document.getElementById('clientHistoryModal').style.display = 'none';
        }

        function updateDeliveryClientFilter() {
            const filter = document.getElementById('deliveryClientFilter');
            if (!filter) return;
            
            // Очищаем текущие опции, кроме "Все клиенты"
            filter.innerHTML = '<option value="">Все клиенты</option>';
            
            // Получаем уникальных клиентов из отпремниц
            const uniqueClients = [...new Set(confirmedDeliveries.map(delivery => delivery.client.name))];
            
            uniqueClients.forEach(clientName => {
                const option = document.createElement('option');
                option.value = clientName;
                option.textContent = clientName;
                filter.appendChild(option);
            });
        }

        function filterDeliveriesByClient() {
            const selectedClient = document.getElementById('deliveryClientFilter').value;
            
            if (!selectedClient) {
                updateDeliveriesList();
                return;
            }
            
            const filteredDeliveries = confirmedDeliveries.filter(delivery => 
                delivery.client.name === selectedClient
            );
            
            updateDeliveriesList(filteredDeliveries);
        }

        function updateDeliveriesList(deliveries = confirmedDeliveries) {
            const container = document.getElementById('confirmedDeliveriesList');
            if (!container) return;

            if (deliveries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Нет утвержденных отпремниц</p>';
                return;
            }

            let listHTML = '';
            deliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Отпремница #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} • ${date} • Срок: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${delivery.items.length} • Способ: ${delivery.method}</div>
                            <div style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#28a745' : '#6c757d'};">Подписана</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDelivery(${originalIndex})" title="Просмотреть отпремницу">Просмотр</button>
                            <span class="invoice-status">Утверждена</span>
                            ${delivery.clientStatus ? `<span class="status-badge ${getDocumentStatusClass(delivery.clientStatus)}">${getDocumentStatusText(delivery.clientStatus)}</span>` : '<span class="status-badge status-pending">Ожидает</span>'}
                            <button class="btn btn-danger" onclick="removeDelivery('${delivery.number}')">Удалить</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleDeliveryStatus(deliveryNumber, isChecked) {
            const delivery = confirmedDeliveries.find(del => del.number === deliveryNumber);
            if (delivery) {
                delivery.signed = isChecked;
                
                // Сохраняем обновленные данные в localStorage
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                addLog(`Отпремница #${deliveryNumber} отмечена как ${isChecked ? 'подписанная' : 'неподписанная'}`);
                
                // Обновляем отображение для изменения цвета текста
                filterDeliveriesByClient();
            }
        }

        function viewDelivery(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) {
                showAlert('Отпремница не найдена!', 'danger');
                return;
            }
            
            // Заполняем форму данными отпремницы для просмотра
            document.getElementById('deliveryNumber').value = delivery.number;
            document.getElementById('deliveryDate').value = delivery.date;
            document.getElementById('deliveryDueDate').value = delivery.dueDate;
            document.getElementById('deliveryMethod').value = delivery.method;
            
            // Устанавливаем клиента
            const clientIndex = clients.findIndex(c => c.name === delivery.client.name);
            if (clientIndex !== -1) {
                document.getElementById('deliveryClient').value = clientIndex;
                document.getElementById('deliveryClientSearch').value = delivery.client.name;
            }
            
            showAlert('Данные отпремницы загружены для просмотра', 'success');
        }

        function removeDelivery(deliveryNumber) {
            if (confirm(`Удалить отпремницу #${deliveryNumber} из списка?`)) {
                confirmedDeliveries = confirmedDeliveries.filter(del => del.number !== deliveryNumber);
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                updateDeliveriesList();
                updateDeliveryClientFilter();
                
                // Обновляем историю клиента, если она открыта
                if (window.currentClientProfile && document.getElementById('clientHistorySection').style.display === 'block') {
                    loadClientHistory(window.currentClientProfile.name);
                }
                
                addLog(`Отпремница #${deliveryNumber} удалена из списка`);
                showAlert('Отпремница удалена из списка!', 'success');
            }
        }

        // Закрытие модального окна при клике на фон
        window.onclick = function(event) {
            const addUserModal = document.getElementById('addUserModal');
            const clientHistoryModal = document.getElementById('clientHistoryModal');
            const racunModal = document.getElementById('racunModal');
            const uploadPredracunModal = document.getElementById('uploadPredracunModal');
            const editClientModal = document.getElementById('editClientModal');
            
            if (event.target === addUserModal) {
                closeAddUserModal();
            }
            if (event.target === clientHistoryModal) {
                closeClientHistoryModal();
            }
            if (event.target === racunModal) {
                closeRacunModal();
            }
            if (event.target === uploadPredracunModal) {
                closeUploadPredracunModal();
            }
            if (event.target === editClientModal) {
                closeEditClientModal();
            }
        }

        // Проверяем авторизацию при загрузке страницы
        window.onload = function() {
            // По умолчанию показываем форму входа
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function addLog(action) {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const now = new Date();
            logs.unshift({
                time: now.toLocaleString(),
                action
            });
            localStorage.setItem('actionLogs', JSON.stringify(logs));
        }

        function updateLogsList() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const logsList = document.getElementById('logsList');
            if (!logsList) return;
            logsList.innerHTML = logs.length ? logs.map(log => `<li style='padding:10px 0; border-bottom:1px solid #dee2e6;'><b>${log.time}</b>: ${log.action}</li>`).join('') : '<li style="color:#888;">Нет логов действий</li>';
        }

        // Глобальный обработчик для логирования всех кликов
        document.addEventListener('click', function(event) {
            // Не логируем клики по элементам внутри модального окна логов, чтобы избежать зацикливания
            let el = event.target;
            let inLogsModal = false;
            while (el) {
                if (el.id === 'logsModal') { inLogsModal = true; break; }
                el = el.parentElement;
            }
            if (inLogsModal) return;

            let desc = '';
            if (event.target.closest('button')) {
                const btn = event.target.closest('button');
                desc = `Клик по кнопке: "${btn.textContent.trim()}"`;
            } else if (event.target.closest('a')) {
                const a = event.target.closest('a');
                desc = `Клик по ссылке: "${a.textContent.trim()}" (${a.href})`;
            } else if (event.target.closest('input, select, textarea')) {
                const input = event.target.closest('input, select, textarea');
                desc = `Клик по полю: <${input.tagName.toLowerCase()}> (name/id: ${input.name || input.id})`;
            } else {
                desc = `Клик по элементу: <${event.target.tagName.toLowerCase()}>`;
            }
            addLog(desc);
        }, true);

        // Функции профиля клиента
        window.currentClientProfile = null;

        function toggleClientForm() {
            const formSection = document.getElementById('clientFormSection');
            const toggleBtn = document.getElementById('toggleFormBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (formSection.style.display === 'none' || formSection.style.display === '') {
                formSection.style.display = 'block';
                toggleIcon.textContent = '➖';
                toggleBtn.innerHTML = '<span id="toggleIcon">➖</span> Свернуть форму';
            } else {
                formSection.style.display = 'none';
                toggleIcon.textContent = '➕';
                toggleBtn.innerHTML = '<span id="toggleIcon">➕</span> Добавить клиента';
            }
        }

        function toggleProductForm() {
            const formSection = document.getElementById('productFormSection');
            const toggleBtn = document.getElementById('toggleProductFormBtn');
            const toggleIcon = document.getElementById('toggleProductIcon');
            
            if (formSection.style.display === 'none' || formSection.style.display === '') {
                formSection.style.display = 'block';
                toggleIcon.textContent = '➖';
                toggleBtn.innerHTML = '<span id="toggleProductIcon">➖</span> Свернуть форму';
            } else {
                formSection.style.display = 'none';
                toggleIcon.textContent = '➕';
                toggleBtn.innerHTML = '<span id="toggleProductIcon">➕</span> Добавить товар';
            }
        }

        function openClientProfile(clientIndex) {
            const client = clients[clientIndex];
            if (!client) return;
            
            window.currentClientProfile = { ...client, index: clientIndex };
            
            // Генерируем аватар из первых букв
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('clientAvatar').textContent = avatar;
            
            // Заполняем основную информацию
            const clientNameWithAbbr = client.abbreviation 
                ? `${client.name || '-'} (${client.abbreviation})` 
                : (client.name || '-');
            document.getElementById('profileClientName').textContent = clientNameWithAbbr;
            document.getElementById('profileClientLegalName').textContent = client.legalName || '-';
            document.getElementById('profileClientMB').textContent = client.mb || '-';
            document.getElementById('profileClientPIB').textContent = client.pib || '-';
            
            // Тип клиента с emoji
            const clientTypeEmojis = {
                'Бар': '🍺',
                'Ресторан': '🍽️',
                'Отель': '🏨',
                'Кальянная': '💨',
                'Кафе': '☕'
            };
            const typeText = client.clientType ? `${clientTypeEmojis[client.clientType] || ''} ${client.clientType}` : '-';
            document.getElementById('profileClientType').textContent = typeText;
            
            document.getElementById('profileClientContactPerson').textContent = client.contactPerson || '-';
            
            // Отображаем статус основного контактного лица
            const contactStatusConfig = {
                'Владелец': { emoji: '👑', color: '#ffd700', bg: '#fff8e1' },
                'Директор': { emoji: '👔', color: '#1976d2', bg: '#e3f2fd' },
                'Управляющий': { emoji: '📋', color: '#7b1fa2', bg: '#f3e5f5' },
                'Закупщик': { emoji: '🛒', color: '#388e3c', bg: '#e8f5e9' },
                'Бармен': { emoji: '🍸', color: '#f57c00', bg: '#fff3e0' }
            };
            const contactStatusElement = document.getElementById('profileContactPersonStatus');
            if (client.contactPersonStatus && contactStatusConfig[client.contactPersonStatus]) {
                const cfg = contactStatusConfig[client.contactPersonStatus];
                contactStatusElement.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; background: ${cfg.bg}; color: ${cfg.color}; border: 1px solid ${cfg.color}40;">${cfg.emoji} ${client.contactPersonStatus}</span>`;
            } else {
                contactStatusElement.innerHTML = '';
            }
            
            document.getElementById('profileClientBank').textContent = client.bank || '-';
            const copyBankBtn = document.getElementById('copyBankBtn');
            if (client.bank && copyBankBtn) {
                copyBankBtn.style.display = 'inline-block';
            } else if (copyBankBtn) {
                copyBankBtn.style.display = 'none';
            }
            
            // Заполняем адрес
            document.getElementById('profileClientAddress').textContent = client.address || '-';
            const googleMapsBtn = document.getElementById('profileGoogleMapsBtn');
            if (client.googleMaps) {
                googleMapsBtn.style.display = 'block';
                googleMapsBtn.onclick = () => openGoogleMaps(); // Используем функцию с поддержкой Tauri
            } else {
                googleMapsBtn.style.display = 'none';
            }
            
            // Заполняем контактные данные
            const contactFields = [
                { id: 'contactPhone', valueId: 'profileClientPhone', value: client.phone },
                { id: 'contactEmail', valueId: 'profileClientEmail', value: client.email },
                { id: 'contactTelegram', valueId: 'profileClientTelegram', value: client.telegram },
                { id: 'contactInstagram', valueId: 'profileClientInstagram', value: client.instagram }
            ];
            
            contactFields.forEach(field => {
                const element = document.getElementById(field.id);
                const valueElement = document.getElementById(field.valueId);
                if (field.value) {
                    element.style.display = 'flex';
                    valueElement.textContent = field.value;
                } else {
                    element.style.display = 'none';
                }
            });
            
            // Заполняем дополнительные контакты
            const additionalContactsSection = document.getElementById('additionalContactsSection');
            const additionalContactsContainer = document.getElementById('profileAdditionalContacts');
            
            // Статусы с эмодзи и цветами
            const statusConfig = {
                'Владелец': { emoji: '👑', color: '#ffd700', bg: '#fff8e1' },
                'Директор': { emoji: '👔', color: '#1976d2', bg: '#e3f2fd' },
                'Управляющий': { emoji: '📋', color: '#7b1fa2', bg: '#f3e5f5' },
                'Закупщик': { emoji: '🛒', color: '#388e3c', bg: '#e8f5e9' },
                'Бармен': { emoji: '🍸', color: '#f57c00', bg: '#fff3e0' }
            };
            
            if (client.additionalContacts && client.additionalContacts.length > 0) {
                additionalContactsSection.style.display = 'block';
                additionalContactsContainer.innerHTML = '';
                
                client.additionalContacts.forEach((contact, index) => {
                    const contactCard = document.createElement('div');
                    contactCard.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;';
                    
                    // Заголовок с именем и статусом
                    let contactHTML = `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">`;
                    contactHTML += `<h4 style="margin: 0; color: #333; font-size: 15px;">👤 ${contact.name || 'Контакт ' + (index + 1)}</h4>`;
                    
                    // Бейдж статуса
                    if (contact.status && statusConfig[contact.status]) {
                        const cfg = statusConfig[contact.status];
                        contactHTML += `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${cfg.bg}; color: ${cfg.color}; border: 1px solid ${cfg.color}40;">${cfg.emoji} ${contact.status}</span>`;
                    }
                    
                    contactHTML += `</div>`;
                    contactHTML += '<div style="display: grid; gap: 8px;">';
                    
                    if (contact.phone) {
                        contactHTML += `
                            <div onclick="copyAdditionalContactData('${contact.phone.replace(/'/g, "\\'")}', 'Телефон')" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='transparent'" title="Нажмите чтобы скопировать">
                                <span style="font-size: 18px;">📞</span>
                                <span style="color: #666; font-size: 14px;">${contact.phone}</span>
                                <span style="color: #17a2b8; font-size: 12px; margin-left: auto;">📋</span>
                            </div>
                        `;
                    }
                    
                    if (contact.email) {
                        contactHTML += `
                            <div onclick="copyAdditionalContactData('${contact.email.replace(/'/g, "\\'")}', 'Email')" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='transparent'" title="Нажмите чтобы скопировать">
                                <span style="font-size: 18px;">✉️</span>
                                <span style="color: #666; font-size: 14px;">${contact.email}</span>
                                <span style="color: #17a2b8; font-size: 12px; margin-left: auto;">📋</span>
                            </div>
                        `;
                    }
                    
                    if (contact.telegram) {
                        contactHTML += `
                            <div onclick="copyAdditionalContactData('${contact.telegram.replace(/'/g, "\\'")}', 'Telegram')" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='transparent'" title="Нажмите чтобы скопировать">
                                <span style="font-size: 18px;">✈️</span>
                                <span style="color: #666; font-size: 14px;">${contact.telegram}</span>
                                <span style="color: #17a2b8; font-size: 12px; margin-left: auto;">📋</span>
                            </div>
                        `;
                    }
                    
                    contactHTML += '</div>';
                    contactCard.innerHTML = contactHTML;
                    additionalContactsContainer.appendChild(contactCard);
                });
            } else {
                additionalContactsSection.style.display = 'none';
            }
            
            // Заполняем условия сотрудничества
            const collaborationTags = document.getElementById('collaborationTags');
            const notesElement = document.getElementById('profileClientNotes');
            
            let tagsHTML = '';
            if (client.installment) {
                const term = client.installmentTerm ? ` (${client.installmentTerm} дней)` : '';
                tagsHTML += `<span class="collab-tag installment">Рассрочка${term}</span>`;
            }
            if (client.showcase) {
                tagsHTML += `<span class="collab-tag showcase">Витрина</span>`;
            }
            if (client.bar) {
                tagsHTML += `<span class="collab-tag bar">Бар</span>`;
            }
            
            collaborationTags.innerHTML = tagsHTML || '<span style="color: #6c757d; font-style: italic;">Нет особых условий</span>';
            
            if (client.notes) {
                notesElement.style.display = 'block';
                notesElement.textContent = client.notes;
            } else {
                notesElement.style.display = 'none';
            }
            
            // Обновляем заголовки
            document.getElementById('clientProfileTitle').textContent = client.name;
            document.getElementById('clientProfileSubtitle').textContent = `${client.legalName || client.name} • МБ: ${client.mb}`;
            
            // Показываем модальное окно
            document.getElementById('clientProfileModal').style.display = 'block';
            
            // Обновляем статистику
            updateClientStatistics();
            
            addLog(`Открыт профиль клиента: ${client.name}`);
        }

        function closeClientProfileModal() {
            document.getElementById('clientProfileModal').style.display = 'none';
            window.currentClientProfile = null;
            // Сбрасываем вид на профиль
            switchToClientProfile();
            // Сбрасываем режим просмотра
            switchToViewMode();
        }

        // ==================== КАРТОЧКА ТОВАРА ====================
        
        function openProductProfile(productIndex) {
            const product = products[productIndex];
            if (!product) return;
            
            window.currentProductProfile = { ...product, index: productIndex };
            
            // Генерируем аватар из первых букв
            const avatar = product.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('productAvatar').textContent = avatar;
            
            // Заполняем основную информацию
            document.getElementById('profileProductCode').textContent = product.code || '-';
            document.getElementById('profileProductName').textContent = product.name || '-';
            document.getElementById('profileProductCategory').textContent = product.category || '-';
            document.getElementById('profileProductSubcategory').textContent = product.subcategory || '-';
            document.getElementById('profileProductPrice').textContent = product.price ? formatPrice(product.price) + ' RSD' : '-';
            document.getElementById('profileProductWeight').textContent = product.weight ? product.weight + ' г' : '-';
            
            // Поставщик - кликабельный если есть в базе
            const supplierElement = document.getElementById('profileProductSupplier');
            supplierElement.textContent = product.supplier || '-';
            
            if (product.supplier) {
                // Ищем поставщика в базе
                const matchedSupplier = (window.allSuppliers || []).find(s => 
                    s.name && s.name.toLowerCase() === product.supplier.toLowerCase()
                );
                
                if (matchedSupplier) {
                    supplierElement.style.cursor = 'pointer';
                    supplierElement.style.color = '#2e7d32';
                    supplierElement.style.textDecoration = 'underline';
                    supplierElement.onclick = () => {
                        closeProductProfileModal();
                        openSupplierProfile(matchedSupplier.id);
                    };
                } else {
                    supplierElement.style.cursor = 'default';
                    supplierElement.style.color = 'inherit';
                    supplierElement.style.textDecoration = 'none';
                    supplierElement.onclick = null;
                }
            } else {
                supplierElement.style.cursor = 'default';
                supplierElement.style.color = 'inherit';
                supplierElement.style.textDecoration = 'none';
                supplierElement.onclick = null;
            }
            
            // Открываем модальное окно
            document.getElementById('productProfileModal').style.display = 'block';
            
            // Обновляем статистику
            updateProductStatistics(product);
            
            // Загружаем связанные расходники
            loadProductLinkedConsumables(product);
            
            console.log(`Открыта карточка товара: ${product.name}`);
        }

        function closeProductProfileModal() {
            document.getElementById('productProfileModal').style.display = 'none';
            window.currentProductProfile = null;
            window.productConsumablesTemp = [];
        }

        // ==================== СВЯЗАННЫЕ РАСХОДНИКИ В КАРТОЧКЕ ТОВАРА ====================

        // Загрузка связанных расходников для товара
        function loadProductLinkedConsumables(product) {
            // Загружаем группы расходников если еще не загружены
            if (!window.consumableGroups || window.consumableGroups.length === 0) {
                window.consumableGroups = JSON.parse(localStorage.getItem('consumableGroups') || '[]');
            }
            
            // Загружаем связи товар-расходники
            const productConsumables = JSON.parse(localStorage.getItem('productConsumables') || '{}');
            const linkedData = productConsumables[product.internalCode] || [];
            
            // Конвертируем старый формат (массив ID) в новый (массив объектов)
            window.productConsumablesTemp = linkedData.map(item => {
                if (typeof item === 'string') {
                    // Старый формат - просто ID, ставим количество по умолчанию 1
                    return { groupId: item, quantity: 1 };
                }
                // Новый формат - объект с groupId и quantity
                return item;
            });
            
            // Обновляем селект доступных расходников
            updateProductConsumableSelect();
            
            // Отрисовываем список связанных расходников
            renderProductLinkedConsumables();
        }

        // Обновление селекта расходников для карточки товара
        function updateProductConsumableSelect() {
            const select = document.getElementById('productConsumableSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Выберите группу расходников</option>';
            
            // Получаем список уже добавленных ID
            const addedIds = window.productConsumablesTemp.map(item => 
                typeof item === 'string' ? item : item.groupId
            );
            
            // Показываем только те, что еще не добавлены
            const availableGroups = window.consumableGroups.filter(g => 
                !addedIds.includes(g.id)
            );
            
            availableGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.code} - ${group.name} (${group.currentQuantity} ${group.unit})`;
                select.appendChild(option);
            });
        }

        // Отрисовка списка связанных расходников
        function renderProductLinkedConsumables() {
            const container = document.getElementById('productLinkedConsumablesList');
            if (!container) return;
            
            if (window.productConsumablesTemp.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Нет связанных расходников</p>';
                return;
            }
            
            // productConsumablesTemp теперь содержит объекты {groupId, quantity}
            const linkedItems = window.productConsumablesTemp.map(item => {
                const groupId = typeof item === 'string' ? item : item.groupId;
                const quantity = typeof item === 'string' ? 1 : (item.quantity || 1);
                const group = window.consumableGroups.find(g => g.id === groupId);
                return group ? { group, quantity } : null;
            }).filter(Boolean);
            
            container.innerHTML = linkedItems.map(({ group, quantity }) => {
                const category = window.consumableCategories?.find(c => c.id === group.categoryId);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #ff9800;">
                        <div style="flex: 1;">
                            <strong style="color: #333;">${group.name}</strong>
                            <span style="color: #666; margin-left: 8px; font-size: 12px;">${group.code}</span>
                            <br>
                            <small style="color: #888;">${category ? category.name : '-'} • Остаток: ${group.currentQuantity} ${group.unit}</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ×${quantity} ${group.unit}/ед.
                            </span>
                            <button class="btn btn-danger" onclick="removeConsumableFromProduct('${group.id}')" style="padding: 4px 8px; font-size: 11px;">✕</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Добавление расходника к товару (временно)
        function addConsumableToProduct() {
            const select = document.getElementById('productConsumableSelect');
            const groupId = select.value;
            const quantityInput = document.getElementById('productConsumableQuantity');
            const quantity = parseFloat(quantityInput.value) || 1;
            
            if (!groupId) {
                showAlert('Выберите группу расходников', 'warning');
                return;
            }
            
            if (quantity <= 0) {
                showAlert('Укажите корректное количество', 'warning');
                return;
            }
            
            // Проверяем, не добавлен ли уже этот расходник
            const existingIndex = window.productConsumablesTemp.findIndex(item => {
                const id = typeof item === 'string' ? item : item.groupId;
                return id === groupId;
            });
            
            if (existingIndex === -1) {
                // Добавляем объект с groupId и quantity
                window.productConsumablesTemp.push({ groupId, quantity });
            } else {
                // Обновляем количество существующего
                window.productConsumablesTemp[existingIndex] = { groupId, quantity };
            }
            
            // Сбрасываем форму
            select.value = '';
            quantityInput.value = '1';
            
            // Обновляем отображение
            updateProductConsumableSelect();
            renderProductLinkedConsumables();
            
            showAlert('Расходник добавлен. Нажмите "Сохранить" для подтверждения.', 'info');
        }

        // Удаление расходника из товара (временно)
        function removeConsumableFromProduct(groupId) {
            window.productConsumablesTemp = window.productConsumablesTemp.filter(item => {
                const id = typeof item === 'string' ? item : item.groupId;
                return id !== groupId;
            });
            
            // Обновляем отображение
            updateProductConsumableSelect();
            renderProductLinkedConsumables();
        }

        // Сохранение связанных расходников для товара
        function saveProductConsumables() {
            if (!window.currentProductProfile) {
                showAlert('Ошибка: товар не выбран', 'danger');
                return;
            }
            
            const productCode = window.currentProductProfile.internalCode;
            const productConsumables = JSON.parse(localStorage.getItem('productConsumables') || '{}');
            
            // Сохраняем в новом формате (объекты с groupId и quantity)
            productConsumables[productCode] = window.productConsumablesTemp.map(item => ({
                groupId: typeof item === 'string' ? item : item.groupId,
                quantity: typeof item === 'string' ? 1 : (item.quantity || 1)
            }));
            
            localStorage.setItem('productConsumables', JSON.stringify(productConsumables));
            
            showAlert('Связанные расходники сохранены!', 'success');
        }

        // ==================== УПРАВЛЕНИЕ КАТЕГОРИЯМИ ====================
        
        // Глобальные переменные для категорий
        let categoriesData = [];
        let subcategoriesData = [];
        
        // Переключение формы управления категориями
        function toggleCategoryManager() {
            const managerSection = document.getElementById('categoryManagerSection');
            const toggleBtn = document.getElementById('toggleCategoryManagerBtn');
            
            if (managerSection.style.display === 'none' || managerSection.style.display === '') {
                managerSection.style.display = 'block';
                toggleBtn.innerHTML = '<span id="toggleCategoryIcon">➖</span> Скрыть категории';
                loadCategoriesForManager();
            } else {
                managerSection.style.display = 'none';
                toggleBtn.innerHTML = '<span id="toggleCategoryIcon">⚙️</span> Управление категориями';
            }
        }
        
        // Загрузка категорий для менеджера
        async function loadCategoriesForManager() {
            try {
                categoriesData = await window.api.categories.getAll();
                renderCategoriesList();
                updateCategorySelects();
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
                // Если API недоступен, используем дефолтные
                categoriesData = [
                    { id: '1', name: 'Zeleni Čaj' },
                    { id: '2', name: 'Crni Čaj' },
                    { id: '3', name: 'Printing' },
                    { id: '4', name: 'Посуда' },
                    { id: '5', name: 'Other' }
                ];
                renderCategoriesList();
                updateCategorySelects();
            }
        }
        
        // Отрисовка списка категорий
        function renderCategoriesList() {
            const tbody = document.getElementById('categoriesListBody');
            if (!tbody) return;
            
            if (categoriesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">Нет категорий</td></tr>';
                return;
            }
            
            tbody.innerHTML = categoriesData.map(cat => `
                <tr>
                    <td>${cat.name}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCategory('${cat.id}')" style="padding: 5px 10px; font-size: 12px;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Обновление всех селектов категорий
        function updateCategorySelects() {
            const selectIds = ['productCategory', 'editProductCategory', 'subcategoryCategorySelect'];
            
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Выберите категорию</option>';
                
                categoriesData.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
                
                // Восстанавливаем выбранное значение если было
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        // Добавление новой категории
        async function addNewCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showAlert('Введите название категории!', 'warning');
                return;
            }
            
            // Проверяем на дубликат
            if (categoriesData.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                showAlert('Категория с таким названием уже существует!', 'warning');
                return;
            }
            
            try {
                const newCategory = await window.api.categories.create({ name });
                categoriesData.push(newCategory);
                renderCategoriesList();
                updateCategorySelects();
                nameInput.value = '';
                showAlert(`Категория "${name}" добавлена!`, 'success');
            } catch (error) {
                console.error('Ошибка создания категории:', error);
                // Fallback - локальное добавление
                const newCategory = { id: Date.now().toString(), name };
                categoriesData.push(newCategory);
                renderCategoriesList();
                updateCategorySelects();
                nameInput.value = '';
                showAlert(`Категория "${name}" добавлена (локально)!`, 'success');
            }
        }
        
        // Удаление категории
        async function deleteCategory(id) {
            const category = categoriesData.find(c => c.id === id);
            if (!category) return;
            
            if (!confirm(`Удалить категорию "${category.name}"?\nВсе связанные субкатегории также будут удалены!`)) {
                return;
            }
            
            try {
                await window.api.categories.delete(id);
                categoriesData = categoriesData.filter(c => c.id !== id);
                // Удаляем связанные субкатегории
                subcategoriesData = subcategoriesData.filter(s => s.categoryId !== id);
                renderCategoriesList();
                renderSubcategoriesList();
                updateCategorySelects();
                showAlert(`Категория "${category.name}" удалена!`, 'success');
            } catch (error) {
                console.error('Ошибка удаления категории:', error);
                // Fallback - локальное удаление
                categoriesData = categoriesData.filter(c => c.id !== id);
                subcategoriesData = subcategoriesData.filter(s => s.categoryId !== id);
                renderCategoriesList();
                renderSubcategoriesList();
                updateCategorySelects();
                showAlert(`Категория "${category.name}" удалена (локально)!`, 'success');
            }
        }
        
        // Загрузка субкатегорий для менеджера
        async function loadSubcategoriesForManager() {
            const categorySelect = document.getElementById('subcategoryCategorySelect');
            const selectedCategory = categorySelect.value;
            
            if (!selectedCategory) {
                subcategoriesData = [];
                renderSubcategoriesList();
                return;
            }
            
            // Находим ID категории по имени
            const category = categoriesData.find(c => c.name === selectedCategory);
            if (!category) {
                subcategoriesData = [];
                renderSubcategoriesList();
                return;
            }
            
            try {
                subcategoriesData = await window.api.subcategories.getByCategory(category.id);
                renderSubcategoriesList();
            } catch (error) {
                console.error('Ошибка загрузки субкатегорий:', error);
                subcategoriesData = [];
                renderSubcategoriesList();
            }
        }
        
        // Отрисовка списка субкатегорий
        function renderSubcategoriesList() {
            const tbody = document.getElementById('subcategoriesListBody');
            if (!tbody) return;
            
            if (subcategoriesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">Нет субкатегорий</td></tr>';
                return;
            }
            
            tbody.innerHTML = subcategoriesData.map(sub => `
                <tr>
                    <td>${sub.name}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteSubcategory('${sub.id}')" style="padding: 5px 10px; font-size: 12px;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Добавление новой субкатегории
        async function addNewSubcategory() {
            const categorySelect = document.getElementById('subcategoryCategorySelect');
            const nameInput = document.getElementById('newSubcategoryName');
            const name = nameInput.value.trim();
            const categoryName = categorySelect.value;
            
            if (!categoryName) {
                showAlert('Сначала выберите категорию!', 'warning');
                return;
            }
            
            if (!name) {
                showAlert('Введите название субкатегории!', 'warning');
                return;
            }
            
            const category = categoriesData.find(c => c.name === categoryName);
            if (!category) {
                showAlert('Категория не найдена!', 'danger');
                return;
            }
            
            // Проверяем на дубликат
            if (subcategoriesData.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                showAlert('Субкатегория с таким названием уже существует!', 'warning');
                return;
            }
            
            try {
                const newSubcategory = await window.api.subcategories.create({ 
                    name, 
                    categoryId: category.id 
                });
                subcategoriesData.push(newSubcategory);
                renderSubcategoriesList();
                nameInput.value = '';
                showAlert(`Субкатегория "${name}" добавлена!`, 'success');
            } catch (error) {
                console.error('Ошибка создания субкатегории:', error);
                // Fallback - локальное добавление
                const newSubcategory = { id: Date.now().toString(), name, categoryId: category.id };
                subcategoriesData.push(newSubcategory);
                renderSubcategoriesList();
                nameInput.value = '';
                showAlert(`Субкатегория "${name}" добавлена (локально)!`, 'success');
            }
        }
        
        // Удаление субкатегории
        async function deleteSubcategory(id) {
            const subcategory = subcategoriesData.find(s => s.id === id);
            if (!subcategory) return;
            
            if (!confirm(`Удалить субкатегорию "${subcategory.name}"?`)) {
                return;
            }
            
            try {
                await window.api.subcategories.delete(id);
                subcategoriesData = subcategoriesData.filter(s => s.id !== id);
                renderSubcategoriesList();
                showAlert(`Субкатегория "${subcategory.name}" удалена!`, 'success');
            } catch (error) {
                console.error('Ошибка удаления субкатегории:', error);
                // Fallback - локальное удаление
                subcategoriesData = subcategoriesData.filter(s => s.id !== id);
                renderSubcategoriesList();
                showAlert(`Субкатегория "${subcategory.name}" удалена (локально)!`, 'success');
            }
        }
        
        // Обновление опций субкатегорий при выборе категории
        async function updateSubcategoryOptions(subcategorySelectId, categoryName) {
            const subcategorySelect = document.getElementById(subcategorySelectId);
            if (!subcategorySelect) return;
            
            subcategorySelect.innerHTML = '<option value="">Загрузка...</option>';
            
            if (!categoryName) {
                subcategorySelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
                return;
            }
            
            // Находим категорию
            const category = categoriesData.find(c => c.name === categoryName);
            if (!category) {
                subcategorySelect.innerHTML = '<option value="">Выберите субкатегорию</option>';
                return;
            }
            
            try {
                const subs = await window.api.subcategories.getByCategory(category.id);
                
                subcategorySelect.innerHTML = '<option value="">Выберите субкатегорию</option>';
                subs.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
                
                if (subs.length === 0) {
                    subcategorySelect.innerHTML = '<option value="">Нет субкатегорий</option>';
                }
            } catch (error) {
                console.error('Ошибка загрузки субкатегорий:', error);
                subcategorySelect.innerHTML = '<option value="">Выберите субкатегорию</option>';
            }
        }
        
        // Инициализация категорий при загрузке страницы
        async function initCategories() {
            try {
                categoriesData = await window.api.categories.getAll();
                updateCategorySelects();
                console.log('✅ Категории загружены:', categoriesData.length);
            } catch (error) {
                console.error('Ошибка инициализации категорий:', error);
                // Дефолтные категории
                categoriesData = [
                    { id: '1', name: 'Zeleni Čaj' },
                    { id: '2', name: 'Crni Čaj' },
                    { id: '3', name: 'Printing' },
                    { id: '4', name: 'Посуда' },
                    { id: '5', name: 'Other' }
                ];
                updateCategorySelects();
            }
        }

        // ==================== КАРТОЧКА СУБКАТЕГОРИИ ====================
        
        function openSubcategoryFromProduct() {
            const product = window.currentProductProfile;
            if (!product || !product.subcategory || product.subcategory === '-') {
                showAlert('У этого товара не указана субкатегория', 'warning');
                return;
            }
            openSubcategoryProfile(product.subcategory, product.category);
        }

        function openSubcategoryProfile(subcategoryName, categoryName) {
            if (!subcategoryName || subcategoryName === 'Без субкатегории') {
                showAlert('Нет данных по этой субкатегории', 'warning');
                return;
            }
            
            window.currentSubcategoryProfile = { 
                subcategory: subcategoryName, 
                category: categoryName 
            };
            
            // Генерируем аватар из первых букв
            const avatar = subcategoryName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('subcategoryAvatar').textContent = avatar;
            
            // Заполняем основную информацию
            document.getElementById('profileSubcategoryName').textContent = subcategoryName;
            document.getElementById('profileSubcategoryCategory').textContent = categoryName || '-';
            
            // Подсчитываем количество товаров в этой субкатегории
            const productCount = products.filter(p => p.subcategory === subcategoryName).length;
            document.getElementById('profileSubcategoryProductCount').textContent = productCount;
            
            // Обновляем заголовок
            document.getElementById('subcategoryProfileTitle').textContent = subcategoryName;
            document.getElementById('subcategoryProfileSubtitle').textContent = `Категория: ${categoryName || 'Не указана'}`;
            
            // Открываем модальное окно
            document.getElementById('subcategoryProfileModal').style.display = 'block';
            
            // Обновляем статистику
            updateSubcategoryStatistics(subcategoryName, categoryName);
            
            console.log(`Открыта карточка субкатегории: ${subcategoryName}`);
        }

        function closeSubcategoryProfileModal() {
            document.getElementById('subcategoryProfileModal').style.display = 'none';
            window.currentSubcategoryProfile = null;
        }

        function applySubcategoryDateFilter() {
            if (!window.currentSubcategoryProfile) return;
            updateSubcategoryStatistics(
                window.currentSubcategoryProfile.subcategory,
                window.currentSubcategoryProfile.category
            );
        }

        function resetSubcategoryDateFilter() {
            document.getElementById('subcategoryStatsDateFrom').value = '';
            document.getElementById('subcategoryStatsDateTo').value = '';
            document.getElementById('subcategoryDateFilterStatus').textContent = '';
            applySubcategoryDateFilter();
        }

        function updateSubcategoryStatistics(subcategoryName, categoryName, dateFrom = null, dateTo = null) {
            // Получаем даты из фильтров если не переданы
            if (!dateFrom) {
                const dateFromInput = document.getElementById('subcategoryStatsDateFrom');
                dateFrom = dateFromInput?.value ? new Date(dateFromInput.value) : null;
            }
            if (!dateTo) {
                const dateToInput = document.getElementById('subcategoryStatsDateTo');
                dateTo = dateToInput?.value ? new Date(dateToInput.value + 'T23:59:59') : null;
            }
            
            let totalSold = 0;
            let totalRevenue = 0;
            const clientsMap = new Map();
            const productsMap = new Map();
            const monthlyData = {};
            
            confirmedInvoices.forEach(invoice => {
                if (!invoice.items) return;
                
                // Проверяем фильтр по датам
                const invoiceDate = new Date(invoice.date);
                if (dateFrom && invoiceDate < dateFrom) return;
                if (dateTo && invoiceDate > dateTo) return;
                
                invoice.items.forEach(item => {
                    const itemSubcategory = item.product?.subcategory || item.subcategory;
                    const itemCategory = item.product?.category || item.category;
                    
                    // Проверяем соответствие субкатегории (и категории если указана)
                    if (itemSubcategory !== subcategoryName) return;
                    if (categoryName && itemCategory !== categoryName) return;
                    
                    const quantity = parseFloat(item.quantity) || 0;
                    const price = parseFloat(item.price) || 0;
                    const itemTotal = quantity * price;
                    
                    totalSold += quantity;
                    totalRevenue += itemTotal;
                    
                    // Считаем клиентов
                    const clientName = invoice.client?.name || invoice.clientName || 'Неизвестный';
                    if (!clientsMap.has(clientName)) {
                        clientsMap.set(clientName, { name: clientName, quantity: 0, revenue: 0 });
                    }
                    const clientData = clientsMap.get(clientName);
                    clientData.quantity += quantity;
                    clientData.revenue += itemTotal;
                    
                    // Считаем товары
                    const productCode = item.code || item.product?.code || 'N/A';
                    const productName = item.name || item.product?.name || 'Неизвестный товар';
                    if (!productsMap.has(productCode)) {
                        productsMap.set(productCode, { code: productCode, name: productName, quantity: 0, revenue: 0 });
                    }
                    const productData = productsMap.get(productCode);
                    productData.quantity += quantity;
                    productData.revenue += itemTotal;
                    
                    // Считаем по месяцам
                    const date = new Date(invoice.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = 0;
                    }
                    monthlyData[monthKey] += quantity;
                });
            });
            
            // Обновляем карточки статистики
            document.getElementById('subcategoryTotalSold').textContent = totalSold;
            document.getElementById('subcategoryTotalRevenue').textContent = formatPriceWithCurrency(totalRevenue);
            document.getElementById('subcategoryUniqueClients').textContent = clientsMap.size;
            document.getElementById('subcategoryUniqueProducts').textContent = productsMap.size;
            
            // Обновляем статус фильтра
            const filterStatus = document.getElementById('subcategoryDateFilterStatus');
            if (dateFrom || dateTo) {
                const fromStr = dateFrom ? dateFrom.toLocaleDateString('ru-RU') : 'начала';
                const toStr = dateTo ? dateTo.toLocaleDateString('ru-RU') : 'конца';
                filterStatus.textContent = `Фильтр: с ${fromStr} по ${toStr}`;
            } else {
                filterStatus.textContent = '';
            }
            
            // Строим график по месяцам
            renderSubcategoryMonthlyChart(monthlyData);
            
            // Строим таблицу клиентов
            renderSubcategoryClientsTable(clientsMap);
            
            // Строим таблицу товаров
            renderSubcategoryProductsTable(productsMap);
        }

        function renderSubcategoryMonthlyChart(monthlyData) {
            const chartEl = document.getElementById('subcategoryMonthlyChart');
            if (!chartEl) return;
            
            const sortedMonths = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            
            if (sortedMonths.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">Нет данных о продажах</div>';
                return;
            }
            
            const maxValue = Math.max(...sortedMonths.map(([, v]) => v));
            const maxBarHeight = 160;
            
            const monthNames = {
                '01': 'Янв', '02': 'Фев', '03': 'Мар', '04': 'Апр',
                '05': 'Май', '06': 'Июн', '07': 'Июл', '08': 'Авг',
                '09': 'Сен', '10': 'Окт', '11': 'Ноя', '12': 'Дек'
            };
            
            let chartHTML = '<div style="display: flex; align-items: flex-end; justify-content: center; gap: 20px; padding: 20px 30px; min-height: 220px;">';
            
            sortedMonths.forEach(([month, value]) => {
                const [year, m] = month.split('-');
                const barHeight = maxValue > 0 ? Math.round((value / maxValue) * maxBarHeight) : 10;
                const finalHeight = Math.max(barHeight, 10);
                const monthName = monthNames[m];
                
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px; max-width: 70px;">
                        <div style="font-weight: 600; color: #6f42c1; font-size: 12px; margin-bottom: 8px;">${value}</div>
                        <div style="width: 35px; height: ${finalHeight}px; background: linear-gradient(to top, #6f42c1, #e83e8c); border-radius: 4px 4px 0 0; box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);"></div>
                        <div style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">${monthName}<br><span style="font-size: 10px;">${year}</span></div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function renderSubcategoryClientsTable(clientsMap) {
            const tableEl = document.getElementById('subcategoryClientsTable');
            if (!tableEl) return;
            
            const sortedClients = Array.from(clientsMap.values()).sort((a, b) => b.revenue - a.revenue);
            
            if (sortedClients.length === 0) {
                tableEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">Нет данных о клиентах</div>';
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e3e8ef; font-weight: 600;">№</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Клиент</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Количество</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Выручка</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedClients.forEach((client, idx) => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e3e8ef;">
                        <td style="padding: 10px;">${idx + 1}</td>
                        <td style="padding: 10px;"><span style="cursor: pointer; color: #007bff; text-decoration: underline; font-weight: 500;" onclick="openClientProfileByName('${client.name.replace(/'/g, "\\'")}')">${client.name}</span></td>
                        <td style="padding: 10px; text-align: right;">${client.quantity} шт</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600; color: #28a745;">${formatPriceWithCurrency(client.revenue)}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableEl.innerHTML = tableHTML;
        }

        function renderSubcategoryProductsTable(productsMap) {
            const tableEl = document.getElementById('subcategoryProductsTable');
            if (!tableEl) return;
            
            const sortedProducts = Array.from(productsMap.values()).sort((a, b) => b.revenue - a.revenue);
            
            if (sortedProducts.length === 0) {
                tableEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">Нет данных о товарах</div>';
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e3e8ef; font-weight: 600;">№</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Код</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Название</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Количество</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e3e8ef; font-weight: 600;">Выручка</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedProducts.forEach((product, idx) => {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e3e8ef;">
                        <td style="padding: 10px;">${idx + 1}</td>
                        <td style="padding: 10px; color: #6f42c1; font-weight: 500;">${product.code}</td>
                        <td style="padding: 10px;"><span style="cursor: pointer; color: #28a745; text-decoration: underline;" onclick="openProductProfileByCode('${product.code}')">${product.name}</span></td>
                        <td style="padding: 10px; text-align: right;">${product.quantity} шт</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600; color: #28a745;">${formatPriceWithCurrency(product.revenue)}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableEl.innerHTML = tableHTML;
        }

        function openClientProfileByName(clientName) {
            // Ищем клиента по имени
            const clientIndex = clients.findIndex(c => c.name === clientName);
            if (clientIndex === -1) {
                showAlert('Клиент не найден', 'error');
                return;
            }
            openClientProfile(clientIndex);
        }

        function openProductProfileByCode(productCode) {
            // Ищем товар по коду
            const productIndex = products.findIndex(p => p.code === productCode);
            if (productIndex === -1) {
                showAlert('Товар не найден', 'error');
                return;
            }
            openProductProfile(productIndex);
        }

        function updateProductStatistics(product, dateFrom = null, dateTo = null) {
            // Получаем даты из фильтров если не переданы
            if (!dateFrom) {
                const dateFromInput = document.getElementById('productStatsDateFrom');
                dateFrom = dateFromInput?.value ? new Date(dateFromInput.value) : null;
            }
            if (!dateTo) {
                const dateToInput = document.getElementById('productStatsDateTo');
                dateTo = dateToInput?.value ? new Date(dateToInput.value + 'T23:59:59') : null;
            }
            
            // Собираем все инвойсы с этим товаром
            const allInvoices = [
                ...confirmedPredracuns,
                ...confirmedRacuns,
                ...confirmedDeliveries
            ];
            
            let totalSold = 0;
            let totalRevenue = 0;
            const clientsMap = new Map();
            const monthlyData = {};
            let filteredCount = 0;
            let totalCount = 0;
            
            allInvoices.forEach(invoice => {
                if (!invoice.items) return;
                
                // Проверяем фильтр по датам
                const invoiceDate = new Date(invoice.date);
                if (dateFrom && invoiceDate < dateFrom) return;
                if (dateTo && invoiceDate > dateTo) return;
                
                invoice.items.forEach(item => {
                    if (item.code === product.code || item.product?.code === product.code) {
                        totalCount++;
                        filteredCount++;
                        
                        const quantity = parseFloat(item.quantity) || 0;
                        const price = parseFloat(item.price) || 0;
                        const itemTotal = quantity * price;
                        
                        totalSold += quantity;
                        totalRevenue += itemTotal;
                        
                        // Считаем клиентов
                        const clientName = invoice.client?.name || invoice.clientName || 'Неизвестный';
                        if (!clientsMap.has(clientName)) {
                            clientsMap.set(clientName, { name: clientName, quantity: 0, revenue: 0 });
                        }
                        const clientData = clientsMap.get(clientName);
                        clientData.quantity += quantity;
                        clientData.revenue += itemTotal;
                        
                        // Считаем по месяцам
                        const date = new Date(invoice.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = 0;
                        }
                        monthlyData[monthKey] += quantity;
                    }
                });
            });
            
            // Обновляем карточки статистики
            document.getElementById('productTotalSold').textContent = totalSold.toFixed(2);
            document.getElementById('productTotalRevenue').textContent = formatPrice(totalRevenue) + ' RSD';
            document.getElementById('productUniqueClients').textContent = clientsMap.size;
            document.getElementById('productAvgQuantity').textContent = clientsMap.size > 0 ? (totalSold / clientsMap.size).toFixed(2) : '0';
            
            // Обновляем статус фильтра
            const statusEl = document.getElementById('productDateFilterStatus');
            if (statusEl) {
                if (dateFrom || dateTo) {
                    const fromStr = dateFrom ? dateFrom.toLocaleDateString('ru-RU') : 'начала';
                    const toStr = dateTo ? dateTo.toLocaleDateString('ru-RU') : 'сегодня';
                    statusEl.textContent = `📊 Период: ${fromStr} — ${toStr}`;
                    statusEl.style.color = '#28a745';
                } else {
                    statusEl.textContent = 'За всё время';
                    statusEl.style.color = '#6c757d';
                }
            }
            
            // Обновляем график
            updateProductMonthlyChart(monthlyData);
            
            // Обновляем таблицу клиентов
            updateProductClientsTable(Array.from(clientsMap.values()));
        }
        
        // Применить фильтр по датам в карточке товара
        function applyProductDateFilter() {
            if (!window.currentProductProfile) return;
            updateProductStatistics(window.currentProductProfile);
        }
        
        // Сбросить фильтр по датам в карточке товара
        function resetProductDateFilter() {
            document.getElementById('productStatsDateFrom').value = '';
            document.getElementById('productStatsDateTo').value = '';
            if (window.currentProductProfile) {
                updateProductStatistics(window.currentProductProfile);
            }
        }

        function updateProductMonthlyChart(monthlyData) {
            const chartContainer = document.getElementById('productMonthlyChart');
            
            if (Object.keys(monthlyData).length === 0) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Нет данных о продажах</p>';
                return;
            }
            
            // Сортируем месяцы
            const sortedMonths = Object.keys(monthlyData).sort();
            const maxValue = Math.max(...Object.values(monthlyData));
            
            let chartHTML = '<div style="display: flex; align-items: flex-end; gap: 8px; height: 250px; padding: 20px 0;">';
            
            sortedMonths.forEach(month => {
                const value = monthlyData[month];
                const height = (value / maxValue) * 100;
                const [year, monthNum] = month.split('-');
                const monthNames = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
                const label = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                
                chartHTML += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="font-weight: 600; color: #2c3e50; font-size: 14px;">${value.toFixed(1)}</div>
                        <div style="width: 100%; height: ${height}%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 8px 8px 0 0; min-height: 20px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);"></div>
                        <div style="font-size: 11px; color: #666; transform: rotate(-45deg); white-space: nowrap; margin-top: 20px;">${label}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        function updateProductClientsTable(clientsData) {
            const tableContainer = document.getElementById('productClientsTable');
            
            if (clientsData.length === 0) {
                tableContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Нет данных о покупках</p>';
                return;
            }
            
            // Сортируем по количеству
            clientsData.sort((a, b) => b.quantity - a.quantity);
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; font-weight: 700; color: #2c3e50;">Клиент</th>
                            <th style="padding: 12px; text-align: right; font-weight: 700; color: #2c3e50;">Количество</th>
                            <th style="padding: 12px; text-align: right; font-weight: 700; color: #2c3e50;">Выручка (RSD)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            clientsData.forEach((client, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                const escapedName = client.name.replace(/'/g, "\\'");
                tableHTML += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px;">
                            <span style="cursor: pointer; color: #007bff; font-weight: 600; transition: color 0.2s;" 
                                  onclick="openClientProfileByName('${escapedName}')" 
                                  onmouseover="this.style.color='#0056b3'; this.style.textDecoration='underline';" 
                                  onmouseout="this.style.color='#007bff'; this.style.textDecoration='none';"
                                  title="Открыть профиль клиента">${client.name}</span>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${client.quantity.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #007bff;">${formatPrice(client.revenue)} RSD</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableContainer.innerHTML = tableHTML;
        }

        function switchToClientHistory() {
            if (!window.currentClientProfile) return;
            
            // Скрываем профиль и показываем историю
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('clientHistorySection').style.display = 'block';
            
            // Обновляем заголовок истории
            const client = window.currentClientProfile;
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('historyClientAvatar').textContent = avatar;
            document.getElementById('historyClientTitle').textContent = `История заказов`;
            document.getElementById('historyClientSubtitle').textContent = `${client.name} • Инвойсы и отпремницы`;
            
            // Загружаем историю заказов
            loadClientHistory(client.name);
            
            addLog(`Просмотрена история заказов клиента: ${client.name}`);
        }

        function switchToClientProfile() {
            // Показываем профиль и скрываем историю
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('clientHistorySection').style.display = 'none';
            // Скрываем форму редактирования если она была открыта
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }

        function switchToEditMode() {
            if (!window.currentClientProfile) return;
            
            const client = clients[window.currentClientProfile.index];
            if (!client) return;
            
            // Заполняем форму редактирования данными клиента
            document.getElementById('editClientName').value = client.name || '';
            document.getElementById('editClientLegalName').value = client.legalName || '';
            document.getElementById('editClientMB').value = client.mb || '';
            document.getElementById('editClientPIB').value = client.pib || '';
            document.getElementById('editClientAbbreviation').value = client.abbreviation || '';
            document.getElementById('editClientContactPerson').value = client.contactPerson || '';
            document.getElementById('editClientContactPersonStatus').value = client.contactPersonStatus || '';
            document.getElementById('editClientBank').value = client.bank || '';
            document.getElementById('editClientType').value = client.clientType || '';
            
            // Адрес
            const isManualAddress = client.isManualAddress || false;
            document.getElementById('editManualAddressInput').checked = isManualAddress;
            
            if (isManualAddress) {
                document.getElementById('editAutoAddressSection').style.display = 'none';
                document.getElementById('editManualAddressSection').style.display = 'block';
                document.getElementById('editClientManualAddress').value = client.address || '';
            } else {
                document.getElementById('editAutoAddressSection').style.display = 'block';
                document.getElementById('editManualAddressSection').style.display = 'none';
                document.getElementById('editClientCity').value = client.city || '';
                document.getElementById('editClientMunicipality').value = client.municipality || '';
                document.getElementById('editClientStreet').value = client.street || '';
                document.getElementById('editClientHouseNumber').value = client.houseNumber || '';
            }
            
            document.getElementById('editClientGoogleMaps').value = client.googleMaps || '';
            
            // Контактные данные
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientTelegram').value = client.telegram || '';
            document.getElementById('editClientInstagram').value = client.instagram || '';
            
            // Условия сотрудничества
            document.getElementById('editClientInstallment').checked = client.installment || false;
            document.getElementById('editClientInstallmentTerm').value = client.installmentTerm || '';
            document.getElementById('editClientShowcase').checked = client.showcase || false;
            document.getElementById('editClientBar').checked = client.bar || false;
            document.getElementById('editClientNotes').value = client.notes || '';
            
            // Загружаем дополнительные контакты
            loadEditAdditionalContacts(client);
            
            // Обработчик переключения типа адреса
            document.getElementById('editManualAddressInput').onchange = function() {
                if (this.checked) {
                    document.getElementById('editAutoAddressSection').style.display = 'none';
                    document.getElementById('editManualAddressSection').style.display = 'block';
                } else {
                    document.getElementById('editAutoAddressSection').style.display = 'block';
                    document.getElementById('editManualAddressSection').style.display = 'none';
                }
            };
            
            // Переключаем интерфейс
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('edit-sections').style.display = 'block';
            document.getElementById('editModeFooter').style.display = 'block';
            
            addLog(`Открыто редактирование клиента: ${client.name}`);
        }

        function switchToViewMode() {
            // Переключаемся обратно к режиму просмотра
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }
        
        // ==================== ДОПОЛНИТЕЛЬНЫЕ КОНТАКТЫ (РЕДАКТИРОВАНИЕ) ====================
        
        // Загрузка дополнительных контактов в форму редактирования
        function loadEditAdditionalContacts(client) {
            const container = document.getElementById('editAdditionalContactsContainer');
            const noContactsMsg = document.getElementById('editNoAdditionalContacts');
            
            container.innerHTML = '';
            
            if (!client.additionalContacts || client.additionalContacts.length === 0) {
                noContactsMsg.style.display = 'block';
                return;
            }
            
            noContactsMsg.style.display = 'none';
            
            client.additionalContacts.forEach((contact, index) => {
                const contactCard = createEditContactCard(contact, index);
                container.appendChild(contactCard);
            });
        }
        
        // Создание карточки контакта для редактирования
        function createEditContactCard(contact, index) {
            const div = document.createElement('div');
            div.className = 'additional-contact-card';
            div.id = `editContactCard_${index}`;
            div.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e0e0e0; position: relative;';
            
            div.innerHTML = `
                <button type="button" onclick="removeEditAdditionalContact(${index})" 
                    style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">×</button>
                <div style="font-weight: 600; margin-bottom: 12px; color: #495057;">Контакт ${index + 1}</div>
                <div style="display: grid; gap: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Имя</label>
                            <input type="text" id="editContactName_${index}" value="${contact.name || ''}" placeholder="Имя контакта" style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Статус</label>
                            <select id="editContactStatus_${index}" style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white; width: 100%;">
                                <option value="">Не указан</option>
                                <option value="Владелец" ${contact.status === 'Владелец' ? 'selected' : ''}>👑 Владелец</option>
                                <option value="Директор" ${contact.status === 'Директор' ? 'selected' : ''}>👔 Директор</option>
                                <option value="Управляющий" ${contact.status === 'Управляющий' ? 'selected' : ''}>📋 Управляющий</option>
                                <option value="Закупщик" ${contact.status === 'Закупщик' ? 'selected' : ''}>🛒 Закупщик</option>
                                <option value="Бармен" ${contact.status === 'Бармен' ? 'selected' : ''}>🍸 Бармен</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Телефон</label>
                            <input type="text" id="editContactPhone_${index}" value="${contact.phone || ''}" placeholder="+381..." style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Email</label>
                            <input type="email" id="editContactEmail_${index}" value="${contact.email || ''}" placeholder="email@..." style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; margin-bottom: 4px;">Telegram</label>
                        <input type="text" id="editContactTelegram_${index}" value="${contact.telegram || ''}" placeholder="@username" style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Добавление нового контакта
        function addEditAdditionalContact() {
            if (!window.currentClientProfile) return;
            
            const client = clients[window.currentClientProfile.index];
            if (!client.additionalContacts) {
                client.additionalContacts = [];
            }
            
            if (client.additionalContacts.length >= 5) {
                showAlert('Максимум 5 дополнительных контактов', 'warning');
                return;
            }
            
            const newContact = { name: '', phone: '', email: '', telegram: '' };
            client.additionalContacts.push(newContact);
            
            const container = document.getElementById('editAdditionalContactsContainer');
            const noContactsMsg = document.getElementById('editNoAdditionalContacts');
            
            noContactsMsg.style.display = 'none';
            
            const contactCard = createEditContactCard(newContact, client.additionalContacts.length - 1);
            container.appendChild(contactCard);
            
            // Фокус на новом поле имени
            setTimeout(() => {
                document.getElementById(`editContactName_${client.additionalContacts.length - 1}`)?.focus();
            }, 100);
        }
        
        // Удаление контакта
        function removeEditAdditionalContact(index) {
            if (!window.currentClientProfile) return;
            
            const client = clients[window.currentClientProfile.index];
            if (!client.additionalContacts) return;
            
            client.additionalContacts.splice(index, 1);
            loadEditAdditionalContacts(client);
        }
        
        // Сбор данных дополнительных контактов из формы
        function collectEditAdditionalContacts() {
            if (!window.currentClientProfile) return [];
            
            const client = clients[window.currentClientProfile.index];
            if (!client.additionalContacts) return [];
            
            const contacts = [];
            
            client.additionalContacts.forEach((_, index) => {
                const nameEl = document.getElementById(`editContactName_${index}`);
                const statusEl = document.getElementById(`editContactStatus_${index}`);
                const phoneEl = document.getElementById(`editContactPhone_${index}`);
                const emailEl = document.getElementById(`editContactEmail_${index}`);
                const telegramEl = document.getElementById(`editContactTelegram_${index}`);
                
                if (nameEl) {
                    const contact = {
                        name: nameEl.value.trim(),
                        status: statusEl?.value || '',
                        phone: phoneEl?.value.trim() || '',
                        email: emailEl?.value.trim() || '',
                        telegram: telegramEl?.value.trim() || ''
                    };
                    
                    // Добавляем только если есть хотя бы имя или телефон
                    if (contact.name || contact.phone) {
                        contacts.push(contact);
                    }
                }
            });
            
            return contacts;
        }

        function loadClientHistory(clientName) {
            // Загружаем данные для всех вкладок
            loadClientPredracuns(clientName);
            loadClientRacuns(clientName);
            loadClientDeliveries(clientName);
            
            // Обновляем счетчики в вкладках
            updateHistoryTabCounts(clientName);
        }

        function loadClientPredracuns(clientName) {
            const clientPredracuns = confirmedPredracuns.filter(doc => doc.client.name === clientName);
            const contentElement = document.getElementById('clientInvoicesContent');
            
            if (clientPredracuns.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">У данного клиента пока нет предрачунов</p>';
                return;
            }

            let listHTML = '';
            clientPredracuns.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((predracun, index) => {
                const date = new Date(predracun.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedPredracuns.findIndex(doc => doc.number === predracun.number);
                const isDelivered = predracun.delivered || false;
                const isPaid = predracun.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Предрачун #${predracun.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${predracun.client.name} • ${date} • ${formatPriceWithCurrency(predracun.total)}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${predracun.items.length} • НДС: ${predracun.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="togglePredracunStatus('${predracun.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#333' : '#6c757d'};">Доставлен</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="togglePredracunStatus('${predracun.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#333' : '#6c757d'};">Оплачен</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDocument('predracun', ${originalIndex})" title="Просмотреть предрачун">Просмотр</button>
                            <button class="btn btn-success" onclick="copyDocumentData('predracun', ${originalIndex})" title="Копировать данные в новый предрачун">Копировать</button>
                            <span class="invoice-status">Утвержден</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function loadClientRacuns(clientName) {
            const clientRacuns = confirmedRacuns.filter(doc => doc.client.name === clientName);
            const contentElement = document.getElementById('clientRacunsContent');
            
            if (clientRacuns.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">У данного клиента пока нет рачунов</p>';
                return;
            }

            let listHTML = '';
            clientRacuns.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((racun, index) => {
                const date = new Date(racun.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedRacuns.findIndex(doc => doc.number === racun.number);
                const isDelivered = racun.delivered || false;
                const isPaid = racun.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Рачун #${racun.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${racun.client.name} • ${date} • ${formatPriceWithCurrency(racun.total)}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${racun.items.length} • НДС: ${racun.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleRacunStatus('${racun.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#333' : '#6c757d'};">Доставлен</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleRacunStatus('${racun.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#333' : '#6c757d'};">Оплачен</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDocument('racun', ${originalIndex})" title="Просмотреть рачун">Просмотр</button>
                            <button class="btn btn-success" onclick="copyDocumentData('racun', ${originalIndex})" title="Копировать данные в новый рачун">Копировать</button>
                            <span class="invoice-status">Утвержден</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function loadClientDeliveries(clientName) {
            const clientDeliveries = confirmedDeliveries.filter(delivery => delivery.client.name === clientName);
            const contentElement = document.getElementById('clientDeliveriesContent');
            
            if (clientDeliveries.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">У данного клиента пока нет отпремниц</p>';
                return;
            }

            let listHTML = '';
            clientDeliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Отпремница #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} • ${date} • Срок: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${delivery.items.length} • Способ: ${delivery.method}</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#333' : '#6c757d'};">Подписана</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDeliveryFromHistory(${originalIndex})" title="Просмотреть отпремницу">Просмотр</button>
                            <span class="invoice-status">Утверждена</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function updateHistoryTabCounts(clientName) {
            const predracunsCount = confirmedPredracuns.filter(doc => doc.client.name === clientName).length;
            const racunsCount = confirmedRacuns.filter(doc => doc.client.name === clientName).length;
            const deliveriesCount = confirmedDeliveries.filter(delivery => delivery.client.name === clientName).length;
            
            document.getElementById('invoicesCount').textContent = predracunsCount;
            document.getElementById('racunsCount').textContent = racunsCount;
            document.getElementById('deliveriesCount').textContent = deliveriesCount;
        }




        function viewDeliveryFromHistory(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) return;
            
            // Открываем модальное окно просмотра отпремницы (аналогично инвойсам)
            showDeliveryModal(delivery, deliveryIndex);
        }

        function showDeliveryModal(delivery, deliveryIndex) {
            const modalHTML = `
                <div class="modal" id="deliveryViewModal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">Отпремница #${delivery.number}</h2>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="printDeliveryFromModal()">Экспорт PDF</button>
                                <button class="btn btn-danger" onclick="closeDeliveryViewModal()">Закрыть</button>
                            </div>
                        </div>
                        <div id="modalDeliveryContent" style="padding: 20px;">
                            ${generateDeliveryHTMLForModal(delivery)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Сохраняем данные отпремницы для экспорта
            window.currentModalDelivery = delivery;
        }

        function generateDeliveryHTMLForModal(delivery) {
            let itemsHTML = '';
            delivery.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.product.unit || 'ком'}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Мајке Јевросиме 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">ОТПРЕМНИЦА</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${delivery.number}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Поручилац:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${delivery.client.legalName || delivery.client.name}</p>
                                <p style="margin: 0;">Matični broj: ${delivery.client.mb}</p>
                                <p style="margin: 0;">PIB: ${delivery.client.pib}</p>
                                <p style="margin: 0;">Sedište: ${delivery.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Испорука на адресу:</h4>
                            <p style="margin: 0; font-size: 10px;">${delivery.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Начин:</strong> ${delivery.method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Дата:</strong> ${new Date(delivery.date).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Рок испоруке:</strong> ${new Date(delivery.dueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Назив артикла</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Количина</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Јединица мере</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Издао</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Примио</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        Овај документ је генерисан електронски и важи без печата и потписа
                    </div>
                </div>
            `;
        }

        function closeDeliveryViewModal() {
            const modal = document.getElementById('deliveryViewModal');
            if (modal) {
                document.body.removeChild(modal);
                window.currentModalDelivery = null;
            }
        }

        function printDeliveryFromModal() {
            if (!window.currentModalDelivery) {
                showAlert('Нет данных для экспорта!', 'danger');
                return;
            }

            const delivery = window.currentModalDelivery;
            const deliveryContent = generateDeliveryHTMLForModal(delivery);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отпремница ${delivery.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 10mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;

            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Отпремница_${delivery.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog(`Экспортирована отпремница #${delivery.number}`);
        }

        function exportClientHistoryToPDF() {
            if (!window.currentClientProfile) return;
            
            const client = window.currentClientProfile;
            showAlert('Функция экспорта истории заказов в PDF будет реализована в следующих версиях', 'info');
            addLog(`Экспорт истории заказов в PDF: ${client.name}`);
        }



        async function saveClientChanges() {
            if (!window.currentClientProfile) return;
            
            const clientIndex = window.currentClientProfile.index;
            const client = clients[clientIndex];
            if (!client) return;
            
            // Получаем данные из формы
            const name = document.getElementById('editClientName').value.trim();
            const legalName = document.getElementById('editClientLegalName').value.trim();
            const mb = document.getElementById('editClientMB').value.trim();
            const pib = document.getElementById('editClientPIB').value.trim();
            const contactPerson = document.getElementById('editClientContactPerson').value.trim();
            const contactPersonStatus = document.getElementById('editClientContactPersonStatus').value;
            const bank = document.getElementById('editClientBank').value.trim();
            const clientType = document.getElementById('editClientType').value;
            const isManualInput = document.getElementById('editManualAddressInput').checked;
            
            // Новые поля
            const googleMaps = document.getElementById('editClientGoogleMaps').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const telegram = document.getElementById('editClientTelegram').value.trim();
            const instagram = document.getElementById('editClientInstagram').value.trim();
            const installment = document.getElementById('editClientInstallment').checked;
            const installmentTerm = document.getElementById('editClientInstallmentTerm').value.trim();
            const showcase = document.getElementById('editClientShowcase').checked;
            const bar = document.getElementById('editClientBar').checked;
            const notes = document.getElementById('editClientNotes').value.trim();
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                address = document.getElementById('editClientManualAddress').value.trim();
                if (!name || !legalName || !mb || !pib || !address) {
                    showAlert('Заполните обязательные поля!', 'danger');
                    return;
                }
                // Парсим адрес для базовой структуры
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
            } else {
                city = document.getElementById('editClientCity').value.trim();
                municipality = document.getElementById('editClientMunicipality').value.trim();
                street = document.getElementById('editClientStreet').value.trim();
                houseNumber = document.getElementById('editClientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) {
                    showAlert('Заполните обязательные поля!', 'danger');
                    return;
                }
                
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            // Проверяем уникальность МБ и ПИБ (исключая текущего клиента)
            const existingClient = clients.find((c, index) => 
                index !== clientIndex && (c.mb === mb || c.pib === pib)
            );
            
            if (existingClient) {
                showAlert('Клиент с таким МБ или ПИБ уже существует!', 'danger');
                return;
            }
            
            // Собираем дополнительные контакты
            const additionalContacts = collectEditAdditionalContacts();
            
            // Нормализуем значения для API
            const normalizedIsManualAddress = isManualInput ? 1 : 0;
            const normalizedInstallment = installment ? 1 : 0;
            const normalizedInstallmentTerm = installmentTerm ? parseInt(installmentTerm) : null;
            const normalizedShowcase = showcase ? 1 : 0;
            const normalizedBar = bar ? 1 : 0;
            
            const oldName = client.name;
            const updatedClient = {
                ...client,
                name,
                legalName,
                mb,
                pib,
                address,
                bank,
                clientType,
                city,
                municipality,
                street,
                houseNumber,
                isManualAddress: normalizedIsManualAddress,
                googleMaps,
                contactPerson,
                contactPersonStatus,
                phone,
                email,
                telegram,
                instagram,
                installment: normalizedInstallment,
                installmentTerm: normalizedInstallmentTerm,
                showcase: normalizedShowcase,
                bar: normalizedBar,
                notes,
                contact: contactPerson || phone || email || '',
                additionalContacts: additionalContacts
            };
            
            try {
                showLoadingIndicator(true, 'Обновление клиента...');
                
                if (updatedClient.id) {
                    const payload = {
                        ...updatedClient,
                        isManualAddress: updatedClient.isManualAddress ? 1 : 0
                    };
                    const response = await ClientsAPI.update(updatedClient.id, payload);
                    // API не возвращает additionalContacts, поэтому сохраняем их отдельно
                    clients[clientIndex] = {
                        ...response.client,
                        additionalContacts: additionalContacts
                    };
                } else {
                    clients[clientIndex] = updatedClient;
                }
                
            localStorage.setItem('clients', JSON.stringify(clients));
            
            renderClientsTable();
            updateSelectOptions();
            
            window.currentClientProfile = { ...clients[clientIndex], index: clientIndex };
            
            if (document.getElementById('clientProfileModal').style.display === 'block') {
                openClientProfile(clientIndex);
                switchToViewMode();
            }
            
            addLog(`Обновлен клиент: ${oldName} → ${name}`);
            showAlert('Данные клиента успешно обновлены!', 'success');
                
            } catch (error) {
                console.error('❌ Ошибка при обновлении клиента:', error);
                clients[clientIndex] = updatedClient;
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClientsTable();
                updateSelectOptions();
                showAlert(`❌ Ошибка при обновлении клиента: ${error.message}`, 'warning');
            } finally {
                showLoadingIndicator(false);
            }
        }

        // ==================== УНИВЕРСАЛЬНАЯ ФУНКЦИЯ ОТКРЫТИЯ URL ====================
        
        // Открывает URL в браузере по умолчанию (Tauri 2 совместимая)
        async function openUrlInDefaultBrowser(url) {
            if (!url) {
                console.error('openUrlInDefaultBrowser: URL не указан');
                return false;
            }
            
            console.log('🌐 Открываем URL:', url);
            
            try {
                // Способ 1: Tauri 2 plugin:shell через invoke
                if (window.__TAURI_INTERNALS__) {
                    console.log('Используем __TAURI_INTERNALS__.invoke для shell|open');
                    await window.__TAURI_INTERNALS__.invoke('plugin:shell|open', { path: url });
                    console.log('✅ URL открыт через plugin:shell|open');
                    return true;
                }
                
                // Способ 2: Tauri 2 через __TAURI__.shell.open
                if (window.__TAURI__ && window.__TAURI__.shell && window.__TAURI__.shell.open) {
                    console.log('Используем __TAURI__.shell.open');
                    await window.__TAURI__.shell.open(url);
                    console.log('✅ URL открыт через __TAURI__.shell.open');
                    return true;
                }
                
                // Способ 3: Tauri 2 через core.invoke
                if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                    console.log('Используем __TAURI__.core.invoke для shell|open');
                    await window.__TAURI__.core.invoke('plugin:shell|open', { path: url });
                    console.log('✅ URL открыт через core.invoke');
                    return true;
                }
                
                // Fallback: обычный window.open
                console.log('Используем fallback window.open');
                window.open(url, '_blank');
                return true;
                
            } catch (error) {
                console.error('Ошибка при открытии URL:', error);
                // Финальный fallback
                try {
                    window.open(url, '_blank');
                    return true;
                } catch (e) {
                    console.error('Финальный fallback тоже не сработал:', e);
                    return false;
                }
            }
        }

        // Открыть Google Maps
        async function openGoogleMaps() {
            if (!window.currentClientProfile || !window.currentClientProfile.googleMaps) {
                showAlert('Ссылка на Google Maps не указана', 'warning');
                return;
            }
            
            const url = window.currentClientProfile.googleMaps;
            const success = await openUrlInDefaultBrowser(url);
            
            if (success) {
                addLog(`Открыт Google Maps для клиента: ${window.currentClientProfile.name}`);
            } else {
                showAlert('Не удалось открыть Google Maps', 'error');
            }
        }

        // ==================== КОНТАКТНЫЕ ДАННЫЕ ====================

        // Показать модальное окно для телефона
        function showPhoneModal() {
            if (!window.currentClientProfile || !window.currentClientProfile.phone) return;
            
            const phone = window.currentClientProfile.phone;
            document.getElementById('phoneModalNumber').textContent = phone;
            document.getElementById('phoneActionModal').style.display = 'block';
        }

        // Закрыть модальное окно телефона
        function closePhoneModal() {
            document.getElementById('phoneActionModal').style.display = 'none';
        }

        // Копировать номер телефона
        async function copyPhoneNumber() {
            if (!window.currentClientProfile || !window.currentClientProfile.phone) return;
            
            const phone = window.currentClientProfile.phone;
            try {
                await navigator.clipboard.writeText(phone);
                showAlert('📋 Номер скопирован: ' + phone, 'success');
                closePhoneModal();
            } catch (error) {
                console.error('Ошибка копирования:', error);
                showAlert('Не удалось скопировать номер', 'error');
            }
        }

        // Позвонить по номеру телефона
        async function callPhoneNumber() {
            if (!window.currentClientProfile || !window.currentClientProfile.phone) return;
            
            const phone = window.currentClientProfile.phone.replace(/\s+/g, '');
            const telUrl = `tel:${phone}`;
            
            try {
                await openUrlInDefaultBrowser(telUrl);
                closePhoneModal();
            } catch (error) {
                console.error('Ошибка при вызове:', error);
                // Fallback через location.href для tel:
                window.location.href = telUrl;
                closePhoneModal();
            }
        }

        // Копировать email в буфер обмена
        async function copyEmail() {
            if (!window.currentClientProfile || !window.currentClientProfile.email) return;
            
            const email = window.currentClientProfile.email;
            try {
                await navigator.clipboard.writeText(email);
                showAlert('📋 Email скопирован: ' + email, 'success');
            } catch (error) {
                console.error('Ошибка копирования:', error);
                // Fallback способ копирования
                const textArea = document.createElement('textarea');
                textArea.value = email;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('📋 Email скопирован: ' + email, 'success');
                } catch (e) {
                    showAlert('Не удалось скопировать email', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Копировать номер банковского счета
        async function copyBankAccount() {
            if (!window.currentClientProfile || !window.currentClientProfile.bank) return;
            
            const bank = window.currentClientProfile.bank;
            try {
                await navigator.clipboard.writeText(bank);
                showAlert('📋 Банковский счет скопирован: ' + bank, 'success');
            } catch (error) {
                console.error('Ошибка копирования:', error);
                // Fallback способ копирования
                const textArea = document.createElement('textarea');
                textArea.value = bank;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('📋 Банковский счет скопирован: ' + bank, 'success');
                } catch (e) {
                    showAlert('Не удалось скопировать банковский счет', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Копировать данные дополнительного контакта
        async function copyAdditionalContactData(value, type) {
            if (!value) return;
            
            try {
                await navigator.clipboard.writeText(value);
                showAlert(`📋 ${type} скопирован: ${value}`, 'success');
            } catch (error) {
                console.error('Ошибка копирования:', error);
                // Fallback способ копирования
                const textArea = document.createElement('textarea');
                textArea.value = value;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert(`📋 ${type} скопирован: ${value}`, 'success');
                } catch (e) {
                    showAlert(`Не удалось скопировать ${type}`, 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Открыть Telegram в браузере по умолчанию
        async function openTelegram() {
            if (!window.currentClientProfile || !window.currentClientProfile.telegram) {
                showAlert('Telegram не указан', 'warning');
                return;
            }
            
            let telegram = window.currentClientProfile.telegram.trim();
            let url;
            
            // Определяем формат ссылки
            if (telegram.startsWith('http://') || telegram.startsWith('https://')) {
                url = telegram;
            } else if (telegram.startsWith('@')) {
                url = `https://t.me/${telegram.substring(1)}`;
            } else if (telegram.startsWith('t.me/')) {
                url = `https://${telegram}`;
            } else {
                url = `https://t.me/${telegram}`;
            }
            
            console.log('📱 Открываем Telegram:', url);
            const success = await openUrlInDefaultBrowser(url);
            
            if (success) {
                addLog(`Открыт Telegram: ${telegram}`);
            } else {
                showAlert('Не удалось открыть Telegram', 'error');
            }
        }

        // Открыть Instagram в браузере по умолчанию
        async function openInstagram() {
            if (!window.currentClientProfile || !window.currentClientProfile.instagram) {
                showAlert('Instagram не указан', 'warning');
                return;
            }
            
            let instagram = window.currentClientProfile.instagram.trim();
            let url;
            
            // Определяем формат ссылки
            if (instagram.startsWith('http://') || instagram.startsWith('https://')) {
                url = instagram;
            } else if (instagram.startsWith('@')) {
                url = `https://www.instagram.com/${instagram.substring(1)}`;
            } else if (instagram.startsWith('instagram.com/') || instagram.startsWith('www.instagram.com/')) {
                url = `https://${instagram}`;
            } else {
                url = `https://www.instagram.com/${instagram}`;
            }
            
            console.log('📷 Открываем Instagram:', url);
            const success = await openUrlInDefaultBrowser(url);
            
            if (success) {
                addLog(`Открыт Instagram: ${instagram}`);
            } else {
                showAlert('Не удалось открыть Instagram', 'error');
            }
        }

        function updateClientStatistics() {
            if (!window.currentClientProfile) return;
            
            const clientName = window.currentClientProfile.name;
            const period = document.getElementById('statisticsPeriod').value;
            
            // Получаем инвойсы клиента
            const clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);
            
            // Фильтруем по периоду
            let filteredInvoices = clientInvoices;
            const now = new Date();
            
            if (period === 'year') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            } else if (period === 'quarter') {
                const currentQuarter = Math.floor(now.getMonth() / 3);
                const startOfQuarter = new Date(now.getFullYear(), currentQuarter * 3, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfQuarter);
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfMonth);
            }
            
            // Дедупликация: если предрачун и рачун с одним номером - берем тот что утвержден раньше
            filteredInvoices = deduplicateInvoices(filteredInvoices);
            
            // Считаем статистику
            const invoiceCount = filteredInvoices.length;
            const totalSum = filteredInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const avgOrderValue = invoiceCount > 0 ? totalSum / invoiceCount : 0;
            
            // Находим самый популярный продукт
            const productCounts = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const productName = item.name || item.product?.name || 'Неизвестный продукт';
                    productCounts[productName] = (productCounts[productName] || 0) + item.quantity;
                });
            });
            
            let topProduct = '-';
            let maxCount = 0;
            for (const [product, count] of Object.entries(productCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topProduct = product;
                }
            }
            
            // Годовое потребление (всегда за год)
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            let yearlyInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            // Дедупликация для годового потребления
            yearlyInvoices = deduplicateInvoices(yearlyInvoices);
            const yearlyConsumption = yearlyInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            
            // Обновляем UI
            document.getElementById('clientAvgOrderValue').textContent = formatPriceWithCurrency(avgOrderValue);
            document.getElementById('clientInvoiceCount').textContent = invoiceCount;
            document.getElementById('clientTopProduct').textContent = topProduct;
            document.getElementById('clientYearlyConsumption').textContent = formatPriceWithCurrency(yearlyConsumption);
            
            // Обновляем график заказов по месяцам
            updateClientMonthlyChart(filteredInvoices);
            
            // Обновляем таблицу товаров
            updateClientProductsTable();
        }

        // Функция для обновления графика заказов клиента по месяцам
        function updateClientMonthlyChart(invoices) {
            const chartEl = document.getElementById('clientMonthlyChart');
            if (!chartEl) return;

            if (invoices.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            // Группируем заказы по месяцам
            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            // Сортируем месяцы по порядку
            const sortedMonths = Object.keys(monthlyData).sort();

            // Создаем HTML для графика
            let chartHTML = '<div style="display: flex; align-items: end; justify-content: center; height: 220px; gap: 12px; padding: 20px; overflow-x: auto;">';
            const maxValue = Math.max(...Object.values(monthlyData));
            const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
            
            sortedMonths.forEach((monthKey) => {
                const value = monthlyData[monthKey];
                const [year, month] = monthKey.split('-');
                const monthName = months[parseInt(month) - 1];
                const height = maxValue > 0 ? (value / maxValue) * 160 : 0;
                
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                        <div style="width: 50px; height: ${height}px; background: linear-gradient(to top, #114A9F, #0d3a7f); border-radius: 8px 8px 0 0; box-shadow: 0 4px 12px rgba(17, 74, 159, 0.3); transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.5)';" 
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';"></div>
                        <div style="font-size: 11px; font-weight: 600; color: #6c757d; margin-top: 8px; text-align: center;">
                            ${monthName}<br><span style="font-size: 10px; color: #95a5a6;">${year}</span>
                        </div>
                        <div style="font-size: 11px; font-weight: 700; color: #2c3e50; margin-top: 6px;">${formatPriceWithCurrency(value)}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        // Функция для обновления таблицы товаров клиента
        function updateClientProductsTable() {
            const tableEl = document.getElementById('clientProductsTable');
            if (!tableEl || !window.currentClientProfile) return;

            const clientName = window.currentClientProfile.name;
            let clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);

            // Применяем фильтр по месяцам
            const fromMonth = document.getElementById('clientProductsFromMonth').value;
            const toMonth = document.getElementById('clientProductsToMonth').value;

            if (fromMonth && toMonth) {
                // Создаем даты начала и конца периода
                const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                
                const startDate = new Date(fromYear, fromMonthNum - 1, 1); // Первый день месяца "от"
                const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59); // Последний день месяца "до"

                clientInvoices = clientInvoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    return invoiceDate >= startDate && invoiceDate <= endDate;
                });
            } else if (fromMonth) {
                const [fromYear, fromMonthNum] = fromMonth.split('-').map(Number);
                const startDate = new Date(fromYear, fromMonthNum - 1, 1);
                clientInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startDate);
            } else if (toMonth) {
                const [toYear, toMonthNum] = toMonth.split('-').map(Number);
                const endDate = new Date(toYear, toMonthNum, 0, 23, 59, 59);
                clientInvoices = clientInvoices.filter(invoice => new Date(invoice.date) <= endDate);
            }
            
            // Дедупликация: если предрачун и рачун с одним номером - берем тот что утвержден раньше
            clientInvoices = deduplicateInvoices(clientInvoices);

            if (clientInvoices.length === 0) {
                tableEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            // Собираем все товары и подсчитываем количество
            const productStats = {};
            clientInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const productCode = item.code || item.product?.code || 'N/A';
                    const productName = item.name || item.product?.name || 'Неизвестный товар';
                    const key = `${productCode}|${productName}`;

                    if (!productStats[key]) {
                        productStats[key] = {
                            code: productCode,
                            name: productName,
                            quantity: 0
                        };
                    }
                    productStats[key].quantity += item.quantity || 0;
                });
            });

            // Преобразуем в массив и сортируем по количеству (убывание)
            const sortedProducts = Object.values(productStats).sort((a, b) => b.quantity - a.quantity);

            // Создаем HTML таблицы
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #114A9F 0%, #0d3a7f 100%); color: white;">
                            <th style="padding: 14px; text-align: left; font-weight: 700; border-radius: 8px 0 0 0;">Код товара</th>
                            <th style="padding: 14px; text-align: left; font-weight: 700;">Название товара</th>
                            <th style="padding: 14px; text-align: center; font-weight: 700; border-radius: 0 8px 0 0;">Количество</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedProducts.forEach((product, index) => {
                const bgColor = index % 2 === 0 ? '#f8fafc' : '#ffffff';
                tableHTML += `
                    <tr style="background: ${bgColor}; transition: background 0.2s ease;" 
                        onmouseover="this.style.background='#e3f2fd';" 
                        onmouseout="this.style.background='${bgColor}';">
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50;">${product.code}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; color: #495057;">${product.name}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e9ecef; text-align: center; font-weight: 700; color: #114A9F;">${product.quantity}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; text-align: center; font-size: 13px; color: #6c757d;">
                    Всего товаров: <strong style="color: #2c3e50;">${sortedProducts.length}</strong> | 
                    Общее количество: <strong style="color: #2c3e50;">${sortedProducts.reduce((sum, p) => sum + p.quantity, 0)}</strong>
                </div>
            `;

            tableEl.innerHTML = tableHTML;
        }

        // Функция для сброса фильтра товаров клиента
        function resetClientProductsFilter() {
            document.getElementById('clientProductsFromMonth').value = '';
            document.getElementById('clientProductsToMonth').value = '';
            updateClientProductsTable();
        }

        // Обработчики для поиска товаров в группах
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('group-product-search')) {
                const searchInput = event.target;
                const groupId = searchInput.id.replace('groupProductSearch-', '');
                const dropdown = document.getElementById(`groupProductDropdown-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                const query = searchInput.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    hiddenInput.value = '';
                    return;
                }
                
                // Фильтруем товары с весом по внутреннему коду, коду товара или названию
                const filteredProducts = products.filter(product => 
                    product.weight > 0 && (
                        (product.internalCode && product.internalCode.toLowerCase().includes(query)) ||
                        (product.code && product.code.toLowerCase().includes(query)) || 
                        (product.name && product.name.toLowerCase().includes(query))
                    )
                ).slice(0, 10); // Ограничиваем до 10 результатов
                
                if (filteredProducts.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item disabled">Товары не найдены</div>';
                } else {
                    dropdown.innerHTML = filteredProducts.map(product => 
                        `<div class="dropdown-item" data-internal-code="${product.internalCode}" data-code="${product.code}" data-name="${product.name}" data-weight="${product.weight}">
                            <strong>${product.code}</strong> - ${product.name} (${product.weight}г)
                        </div>`
                    ).join('');
                }
                
                dropdown.style.display = 'block';
            }
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('dropdown-item') && event.target.closest('.group-product-dropdown')) {
                const item = event.target;
                const dropdown = item.closest('.group-product-dropdown');
                const groupId = dropdown.id.replace('groupProductDropdown-', '');
                const searchInput = document.getElementById(`groupProductSearch-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                
                const internalCode = item.getAttribute('data-internal-code');
                const code = item.getAttribute('data-code');
                const name = item.getAttribute('data-name');
                const weight = item.getAttribute('data-weight');
                
                searchInput.value = `${code} - ${name} (${weight}г)`;
                hiddenInput.value = internalCode;
                dropdown.style.display = 'none';
            }
            
            // Закрытие dropdown при клике вне его
            if (!event.target.closest('.searchable-select')) {
                document.querySelectorAll('.group-product-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Функции для подсветки обязательных полей
        function highlightRequiredFields() {
            // Находим все обязательные поля по лейблам со звездочкой
            const requiredLabels = document.querySelectorAll('label');
            
            requiredLabels.forEach(label => {
                if (label.textContent.includes('*')) {
                    // Находим связанное поле ввода
                    const fieldId = label.getAttribute('for') || label.nextElementSibling?.id;
                    let field = null;
                    
                    if (fieldId) {
                        field = document.getElementById(fieldId);
                    } else {
                        // Ищем поле ввода в том же form-group
                        const formGroup = label.closest('.form-group');
                        if (formGroup) {
                            field = formGroup.querySelector('input, select, textarea');
                        }
                    }
                    
                    if (field) {
                        field.classList.add('required-field');
                        label.classList.add('required-label');
                    }
                }
            });
        }

        function validateRequiredFields(container = document) {
            let isValid = true;
            const requiredFields = container.querySelectorAll('.required-field');
            
            requiredFields.forEach(field => {
                const value = field.value.trim();
                
                if (!value) {
                    field.classList.add('required-field-error');
                    field.classList.remove('required-field');
                    isValid = false;
                    
                    // Убираем класс ошибки через 3 секунды
                    setTimeout(() => {
                        field.classList.remove('required-field-error');
                        field.classList.add('required-field');
                    }, 3000);
                } else {
                    field.classList.remove('required-field-error');
                    field.classList.add('required-field');
                }
            });
            
            return isValid;
        }

        function resetFieldHighlighting(container = document) {
            const fields = container.querySelectorAll('.required-field, .required-field-error');
            fields.forEach(field => {
                field.classList.remove('required-field-error');
                field.classList.add('required-field');
            });
        }

        // Инициализация подсветки при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                highlightRequiredFields();
            }, 500);
        });

        // Обработчики для снятия подсветки ошибки при вводе
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('required-field-error')) {
                event.target.classList.remove('required-field-error');
                event.target.classList.add('required-field');
            }
        });

        // Закрытие модальных окон по клику вне их
        window.onclick = function(event) {
            const clientProfileModal = document.getElementById('clientProfileModal');
            const editProductModal = document.getElementById('editProductModal');
            const clientEditProductModal = document.getElementById('clientEditProductModal');
            const teaStockModal = document.getElementById('teaStockModal');
            const phoneActionModal = document.getElementById('phoneActionModal');
            const subcategoryProfileModal = document.getElementById('subcategoryProfileModal');
            const consumableReplenishModal = document.getElementById('consumableReplenishModal');
            const consumableDeductModal = document.getElementById('consumableDeductModal');
            
            if (event.target === clientProfileModal) {
                closeClientProfileModal();
            }
            
            if (event.target === editProductModal) {
                closeEditProductModal();
            }
            
            if (event.target === clientEditProductModal) {
                closeClientEditProductModal();
            }
            
            if (event.target === teaStockModal) {
                closeTeaStockModal();
            }
            
            if (event.target === phoneActionModal) {
                closePhoneModal();
            }
            
            if (event.target === consumableReplenishModal) {
                closeConsumableReplenishModal();
            }
            
            if (event.target === consumableDeductModal) {
                closeConsumableDeductModal();
            }
            
            if (event.target === subcategoryProfileModal) {
                closeSubcategoryProfileModal();
            }

            const shipmentViewModal = document.getElementById('shipmentViewModal');
            if (event.target === shipmentViewModal) {
                closeShipmentViewModal();
            }
        }
        // Диагностическая функция для проверки связи товаров со складом
        function checkProductWarehouseConnection() {
            console.log('=== ДИАГНОСТИКА СВЯЗИ ТОВАРОВ СО СКЛАДОМ ===');
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.log('❌ Нет данных о текущем клиенте');
                return;
            }
            
            // Загружаем данные
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            if (!window.clientProductGroups) {
                window.clientProductGroups = safeLocalStorage('get', 'clientProductGroups') || [];
            }
            
            console.log(`\n🔍 Проверяем товары клиента ${clientMB}:`);
            const clientProducts = window.clientProducts.filter(p => p.clientMB === clientMB);
            console.log(`Найдено товаров клиента: ${clientProducts.length}`);
            
            console.log(`\n📦 Проверяем группы на складе:`);
            console.log(`Всего групп на складе: ${window.clientProductGroups.length}`);
            
            clientProducts.forEach((clientProduct, index) => {
                console.log(`\n--- ТОВАР ${index + 1} ---`);
                console.log(`Код товара: ${clientProduct.code}`);
                console.log(`Название: ${clientProduct.name}`);
                console.log(`Вес: ${clientProduct.weight}г`);
                console.log(`Макс. количество: ${clientProduct.maxQuantity}`);
                console.log(`Warehouse Link: ${clientProduct.warehouseLink}`);
                
                // Ищем соответствующую группу
                const matchingGroup = window.clientProductGroups.find(group => 
                    group.products && group.products.some(p => p.product.internalCode === clientProduct.warehouseLink)
                );
                
                if (matchingGroup) {
                    console.log(`✅ НАЙДЕНА ГРУППА: ${matchingGroup.name}`);
                    console.log(`   Доступно на складе: ${matchingGroup.currentQuantity}г`);
                    console.log(`   Расчетное макс. кол-во: ${Math.floor(matchingGroup.currentQuantity / clientProduct.weight)} шт.`);
                    
                    // Проверяем соответствие
                    const expectedMaxQty = Math.floor(matchingGroup.currentQuantity / clientProduct.weight);
                    if (clientProduct.maxQuantity !== expectedMaxQty) {
                        console.log(`⚠️  НЕСООТВЕТСТВИЕ! Ожидается: ${expectedMaxQty}, фактически: ${clientProduct.maxQuantity}`);
                    } else {
                        console.log(`✅ Количество корректное`);
                    }
                } else {
                    console.log(`❌ ГРУППА НЕ НАЙДЕНА для warehouseLink: ${clientProduct.warehouseLink}`);
                    console.log(`   Доступные группы:`);
                    window.clientProductGroups.forEach(group => {
                        const productCodes = group.products ? group.products.map(p => p.product.code).join(', ') : 'нет товаров';
                        console.log(`   - ${group.name}: коды товаров [${productCodes}]`);
                    });
                }
            });
            
            console.log('\n=== КОНЕЦ ДИАГНОСТИКИ ===');
        }
        
        // ============================================
        // ФУНКЦИИ ФИЛЬТРАЦИИ КЛИЕНТОВ
        // ============================================

        function filterClients() {
            const searchValue = document.getElementById('clientSearchInput').value.toLowerCase().trim();
            const typeFilter = document.getElementById('clientTypeFilter').value;
            
            const clientCards = document.querySelectorAll('.client-card');
            let visibleCount = 0;
            
            clientCards.forEach(card => {
                const clientName = card.querySelector('.client-name')?.textContent.toLowerCase() || '';
                const clientType = card.dataset.clientType || '';
                
                const matchesSearch = clientName.includes(searchValue);
                const matchesType = !typeFilter || clientType === typeFilter;
                
                if (matchesSearch && matchesType) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Показываем сообщение если ничего не найдено
            const clientsList = document.getElementById('clientsList');
            let noResultsMsg = clientsList.querySelector('.no-results-message');
            
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; color: #666; padding: 40px; font-size: 16px;';
                    noResultsMsg.textContent = '🔍 Клиенты не найдены';
                    clientsList.appendChild(noResultsMsg);
                }
            } else {
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }
        }

        function resetClientFilters() {
            document.getElementById('clientSearchInput').value = '';
            document.getElementById('clientTypeFilter').value = '';
            filterClients();
        }

        // Добавляем функцию в глобальную область для вызова из консоли
        window.checkProductWarehouseConnection = checkProductWarehouseConnection;

        // ============================================
        // ФУНКЦИИ РАБОТЫ С ПОСТАВЩИКАМИ
        // ============================================
        
        // Глобальные переменные для поставщиков
        window.allSuppliers = [];
        window.allSupplierSectors = [];
        window.allSupplierProducts = [];
        window.allCountries = [];
        window.currentEditingSupplier = null;

        // Загрузка всех данных поставщиков
        async function loadSuppliersData() {
            try {
                console.log('📦 Загружаем данные поставщиков...');
                
                // Загружаем параллельно
                const [sectors, products, suppliers, countries] = await Promise.all([
                    window.api.supplierSectors.getAll(),
                    window.api.supplierProducts.getAll(),
                    window.api.suppliers.getAll(),
                    window.api.countries.getAll()
                ]);
                
                window.allSupplierSectors = sectors;
                window.allSupplierProducts = products;
                window.allSuppliers = suppliers;
                window.allCountries = countries;
                
                console.log(`✅ Загружено: ${sectors.length} секторов, ${products.length} продукции, ${suppliers.length} поставщиков, ${countries.length} стран`);
                
                // Обновляем UI
                updateSectorSelects();
                updateCountrySelect();
                renderSupplierCards();
                updateSectorFilter();
                
            } catch (error) {
                console.error('❌ Ошибка загрузки данных поставщиков:', error);
                showAlert('Ошибка загрузки данных поставщиков', 'error');
            }
        }
        
        // Обновление селекта стран
        function updateCountrySelect() {
            const select = document.getElementById('supplierCountry');
            if (!select) return;
            
            // Сортируем страны: Сербия первая, потом по алфавиту
            const sortedCountries = [...window.allCountries].sort((a, b) => {
                if (a.name === 'Сербия') return -1;
                if (b.name === 'Сербия') return 1;
                return a.name.localeCompare(b.name, 'ru');
            });
            
            select.innerHTML = '<option value="">Выберите страну</option>' + 
                sortedCountries.map(country => 
                    `<option value="${country.name}">${country.name}</option>`
                ).join('');
        }
        
        // Обработчик изменения страны
        function onSupplierCountryChange() {
            const country = document.getElementById('supplierCountry').value;
            const isSerbia = country === 'Сербия';
            
            const mbGroup = document.getElementById('supplierMBGroup');
            const pibGroup = document.getElementById('supplierPIBGroup');
            const regNumberGroup = document.getElementById('supplierRegNumberGroup');
            const mbLabel = document.getElementById('supplierMBLabel');
            const mbInput = document.getElementById('supplierMB');
            const pibLabel = document.getElementById('supplierPIBLabel');
            
            if (isSerbia) {
                // Сербия: показываем Матични број и ПИБ
                mbGroup.style.display = 'block';
                pibGroup.style.display = 'block';
                regNumberGroup.style.display = 'none';
                
                mbLabel.textContent = 'Матични број';
                mbInput.placeholder = 'Матични број';
                pibLabel.textContent = 'ПИБ';
            } else if (country) {
                // Другая страна: показываем Рег. номер, ПИБ опционален
                mbGroup.style.display = 'none';
                pibGroup.style.display = 'block';
                regNumberGroup.style.display = 'block';
                
                pibLabel.textContent = 'ПИБ (опционально)';
            } else {
                // Страна не выбрана: показываем поля для Сербии по умолчанию
                mbGroup.style.display = 'block';
                pibGroup.style.display = 'block';
                regNumberGroup.style.display = 'none';
                
                mbLabel.textContent = 'Матични број';
                mbInput.placeholder = 'Матични број';
                pibLabel.textContent = 'ПИБ';
            }
        }

        // Обновление селектов секторов
        function updateSectorSelects() {
            const selects = [
                'supplierSector',
                'productSectorSelect',
                'supplierSectorFilter'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const isFilter = selectId === 'supplierSectorFilter';
                const firstOption = isFilter ? '<option value="">🏭 Все секторы</option>' : '<option value="">Выберите сектор</option>';
                
                select.innerHTML = firstOption + window.allSupplierSectors.map(sector => 
                    `<option value="${sector.id}">${sector.name}</option>`
                ).join('');
            });
        }

        // Обновление фильтра секторов
        function updateSectorFilter() {
            const filter = document.getElementById('supplierSectorFilter');
            if (!filter) return;
            
            filter.innerHTML = '<option value="">🏭 Все секторы</option>' + 
                window.allSupplierSectors.map(sector => 
                    `<option value="${sector.id}">${sector.name}</option>`
                ).join('');
        }

        // Обновление опций продукции при выборе сектора
        function updateSupplierProductOptions() {
            const sectorId = document.getElementById('supplierSector').value;
            const productSelect = document.getElementById('supplierProduct');
            
            if (!sectorId) {
                productSelect.innerHTML = '<option value="">Сначала выберите сектор</option>';
                return;
            }
            
            const products = window.allSupplierProducts.filter(p => p.sectorId === sectorId);
            productSelect.innerHTML = '<option value="">Выберите продукцию</option>' + 
                products.map(product => `<option value="${product.id}">${product.name}</option>`).join('');
        }

        // Переключение формы создания поставщика
        function toggleSupplierForm() {
            const section = document.getElementById('supplierFormSection');
            const icon = document.getElementById('toggleSupplierIcon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '➖';
            } else {
                section.style.display = 'none';
                icon.textContent = '➕';
                clearSupplierForm();
            }
        }

        // Переключение менеджера секторов
        function toggleSupplierSectorManager() {
            const section = document.getElementById('sectorManagerSection');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadSectorsForManager();
            } else {
                section.style.display = 'none';
            }
        }

        // Загрузка секторов для менеджера
        function loadSectorsForManager() {
            const tbody = document.getElementById('sectorsListBody');
            
            if (window.allSupplierSectors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #666;">Нет секторов</td></tr>';
                return;
            }
            
            tbody.innerHTML = window.allSupplierSectors.map(sector => `
                <tr>
                    <td>${sector.name}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSector('${sector.id}')" title="Удалить">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        // Загрузка продукции для менеджера
        function loadProductsForSectorManager() {
            const sectorId = document.getElementById('productSectorSelect').value;
            const tbody = document.getElementById('supplierProductsListBody');
            
            if (!sectorId) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #666;">Выберите сектор</td></tr>';
                return;
            }
            
            const products = window.allSupplierProducts.filter(p => p.sectorId === sectorId);
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #666;">Нет продукции</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.name}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplierProduct('${product.id}')" title="Удалить">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        // Добавление нового сектора
        async function addNewSector() {
            const nameInput = document.getElementById('newSectorName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showAlert('Введите название сектора', 'warning');
                return;
            }
            
            try {
                const sector = await window.api.supplierSectors.create({ name });
                window.allSupplierSectors.push(sector);
                
                nameInput.value = '';
                loadSectorsForManager();
                updateSectorSelects();
                
                showAlert('✅ Сектор добавлен', 'success');
            } catch (error) {
                console.error('Ошибка добавления сектора:', error);
                showAlert('Ошибка добавления сектора', 'error');
            }
        }

        // Удаление сектора
        async function deleteSector(id) {
            if (!confirm('Удалить сектор? Все связанные продукции также будут удалены.')) return;
            
            try {
                await window.api.supplierSectors.delete(id);
                
                window.allSupplierSectors = window.allSupplierSectors.filter(s => s.id !== id);
                window.allSupplierProducts = window.allSupplierProducts.filter(p => p.sectorId !== id);
                
                loadSectorsForManager();
                updateSectorSelects();
                
                showAlert('✅ Сектор удален', 'success');
            } catch (error) {
                console.error('Ошибка удаления сектора:', error);
                showAlert('Ошибка удаления сектора', 'error');
            }
        }

        // Добавление новой продукции
        async function addNewSupplierProduct() {
            const sectorId = document.getElementById('productSectorSelect').value;
            const nameInput = document.getElementById('newSupplierProductName');
            const name = nameInput.value.trim();
            
            if (!sectorId) {
                showAlert('Выберите сектор', 'warning');
                return;
            }
            
            if (!name) {
                showAlert('Введите название продукции', 'warning');
                return;
            }
            
            try {
                const product = await window.api.supplierProducts.create({ name, sectorId });
                window.allSupplierProducts.push(product);
                
                nameInput.value = '';
                loadProductsForSectorManager();
                
                showAlert('✅ Продукция добавлена', 'success');
            } catch (error) {
                console.error('Ошибка добавления продукции:', error);
                showAlert('Ошибка добавления продукции', 'error');
            }
        }

        // Удаление продукции
        async function deleteSupplierProduct(id) {
            if (!confirm('Удалить продукцию?')) return;
            
            try {
                await window.api.supplierProducts.delete(id);
                window.allSupplierProducts = window.allSupplierProducts.filter(p => p.id !== id);
                loadProductsForSectorManager();
                
                showAlert('✅ Продукция удалена', 'success');
            } catch (error) {
                console.error('Ошибка удаления продукции:', error);
                showAlert('Ошибка удаления продукции', 'error');
            }
        }

        // Очистка формы поставщика
        function clearSupplierForm() {
            const fields = [
                'supplierName', 'supplierLegalName', 'supplierMB', 'supplierPIB',
                'supplierRegNumber', 'supplierAddress', 'supplierCity', 'supplierPhone', 'supplierEmail',
                'supplierTelegram', 'supplierInstagram', 'supplierWechat', 'supplierWebsite', 'supplierBank',
                'supplierContactPerson', 'supplierGoogleMaps', 'supplierNotes'
            ];
            
            fields.forEach(field => {
                const el = document.getElementById(field);
                if (el) el.value = '';
            });
            
            document.getElementById('supplierCountry').value = '';
            document.getElementById('supplierSector').value = '';
            document.getElementById('supplierProduct').innerHTML = '<option value="">Сначала выберите сектор</option>';
            document.getElementById('supplierContactPersonStatus').value = '';
            
            // Сбрасываем отображение полей
            onSupplierCountryChange();
            
            window.currentEditingSupplier = null;
        }

        // Добавление поставщика
        async function addSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const country = document.getElementById('supplierCountry').value;
            
            if (!name) {
                showAlert('Введите название поставщика', 'warning');
                return;
            }
            
            if (!country) {
                showAlert('Выберите страну поставщика', 'warning');
                return;
            }
            
            const isSerbia = country === 'Сербия';
            
            const supplierData = {
                name,
                legalName: document.getElementById('supplierLegalName').value.trim() || null,
                mb: isSerbia ? (document.getElementById('supplierMB').value.trim() || null) : null,
                pib: document.getElementById('supplierPIB').value.trim() || null,
                regNumber: !isSerbia ? (document.getElementById('supplierRegNumber').value.trim() || null) : null,
                address: document.getElementById('supplierAddress').value.trim() || null,
                city: document.getElementById('supplierCity').value.trim() || null,
                country: country,
                phone: document.getElementById('supplierPhone').value.trim() || null,
                email: document.getElementById('supplierEmail').value.trim() || null,
                telegram: document.getElementById('supplierTelegram').value.trim() || null,
                instagram: document.getElementById('supplierInstagram').value.trim() || null,
                wechat: document.getElementById('supplierWechat').value.trim() || null,
                website: document.getElementById('supplierWebsite').value.trim() || null,
                bank: document.getElementById('supplierBank').value.trim() || null,
                sectorId: document.getElementById('supplierSector').value || null,
                productId: document.getElementById('supplierProduct').value || null,
                contactPerson: document.getElementById('supplierContactPerson').value.trim() || null,
                contactPersonStatus: document.getElementById('supplierContactPersonStatus').value || null,
                googleMaps: document.getElementById('supplierGoogleMaps').value.trim() || null,
                notes: document.getElementById('supplierNotes').value.trim() || null,
                isActive: 1
            };
            
            try {
                const supplier = await window.api.suppliers.create(supplierData);
                window.allSuppliers.unshift(supplier);
                
                renderSupplierCards();
                clearSupplierForm();
                toggleSupplierForm();
                
                showAlert('✅ Поставщик добавлен', 'success');
            } catch (error) {
                console.error('Ошибка добавления поставщика:', error);
                showAlert('Ошибка добавления поставщика: ' + error.message, 'error');
            }
        }

        // Отрисовка карточек поставщиков
        function renderSupplierCards() {
            const container = document.getElementById('suppliersCardsContainer');
            
            if (window.allSuppliers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">📭 Нет поставщиков. Добавьте первого!</p>';
                return;
            }
            
            container.innerHTML = window.allSuppliers.map(supplier => {
                const sector = window.allSupplierSectors.find(s => s.id === supplier.sectorId);
                const product = window.allSupplierProducts.find(p => p.id === supplier.productId);
                const isSerbia = supplier.country === 'Сербия';
                
                return `
                    <div class="client-card" data-supplier-id="${supplier.id}" data-sector-id="${supplier.sectorId || ''}">
                        <div class="client-card-header">
                            <h3 class="client-card-title">
                                <span class="client-name">${supplier.name || 'Без названия'}</span>
                                ${sector ? `<span class="client-badge" style="background: #2e7d32;">🏭 ${sector.name}</span>` : ''}
                                ${supplier.country ? `<span class="client-badge" style="background: #6c757d;">🌍 ${supplier.country}</span>` : ''}
                            </h3>
                        </div>
                        
                        <div class="client-card-body">
                            <div class="client-info-row">
                                <div class="client-info-label">Юр. название:</div>
                                <div class="client-info-value"><strong>${supplier.legalName || '-'}</strong></div>
                            </div>
                            ${isSerbia ? `
                            <div class="client-info-row">
                                <div class="client-info-label">Матични број:</div>
                                <div class="client-info-value">${supplier.mb || '-'}</div>
                            </div>
                            ` : `
                            <div class="client-info-row">
                                <div class="client-info-label">Рег. номер:</div>
                                <div class="client-info-value">${supplier.regNumber || '-'}</div>
                            </div>
                            `}
                            <div class="client-info-row">
                                <div class="client-info-label">ПИБ:</div>
                                <div class="client-info-value">${supplier.pib || '-'}</div>
                            </div>
                            ${product ? `
                            <div class="client-info-row">
                                <div class="client-info-label">Продукция:</div>
                                <div class="client-info-value">📦 ${product.name}</div>
                            </div>
                            ` : ''}
                            <div class="client-info-row">
                                <div class="client-info-label">Адрес:</div>
                                <div class="client-info-value">${[supplier.city, supplier.address].filter(Boolean).join(', ') || '-'}</div>
                            </div>
                            ${supplier.contactPerson ? `
                            <div class="client-info-row">
                                <div class="client-info-label">Контакт:</div>
                                <div class="client-info-value">${supplier.contactPerson}${supplier.contactPersonStatus ? ` (${supplier.contactPersonStatus})` : ''}</div>
                            </div>
                            ` : ''}
                            <div class="client-info-row">
                                <div class="client-info-label">Телефон:</div>
                                <div class="client-info-value">${supplier.phone || '-'}</div>
                            </div>
                            <div class="client-info-row">
                                <div class="client-info-label">Email:</div>
                                <div class="client-info-value">${supplier.email || '-'}</div>
                            </div>
                            ${supplier.bank ? `
                            <div class="client-info-row">
                                <div class="client-info-label">Банк:</div>
                                <div class="client-info-value">${supplier.bank}</div>
                            </div>
                            ` : ''}
                            ${supplier.notes ? `
                            <div class="client-info-row">
                                <div class="client-info-label">Примечания:</div>
                                <div class="client-info-value">${supplier.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="client-card-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                            <button class="btn btn-success btn-sm" onclick="openSupplierProfile(${supplier.id})">
                                👤 Профиль
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editSupplier(${supplier.id})">
                                ✏️ Редактировать
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${supplier.id})">
                                🗑️ Удалить
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Фильтрация поставщиков
        function filterSuppliers() {
            const searchValue = document.getElementById('supplierSearchInput').value.toLowerCase().trim();
            const sectorFilter = document.getElementById('supplierSectorFilter').value;
            
            const supplierCards = document.querySelectorAll('#suppliersCardsContainer .client-card');
            let visibleCount = 0;
            
            supplierCards.forEach(card => {
                const supplierName = card.querySelector('.client-name')?.textContent.toLowerCase() || '';
                const sectorId = card.dataset.sectorId || '';
                
                const matchesSearch = supplierName.includes(searchValue);
                const matchesSector = !sectorFilter || sectorId === sectorFilter;
                
                if (matchesSearch && matchesSector) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Показываем сообщение если ничего не найдено
            const container = document.getElementById('suppliersCardsContainer');
            let noResultsMsg = container.querySelector('.no-results-message');
            
            if (visibleCount === 0 && window.allSuppliers.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; color: #666; padding: 40px; font-size: 16px;';
                    noResultsMsg.textContent = '🔍 Поставщики не найдены';
                    container.appendChild(noResultsMsg);
                }
            } else {
                if (noResultsMsg) noResultsMsg.remove();
            }
        }

        // Сброс фильтров поставщиков
        function resetSupplierFilters() {
            document.getElementById('supplierSearchInput').value = '';
            document.getElementById('supplierSectorFilter').value = '';
            filterSuppliers();
        }

        // Открыть профиль поставщика
        function openSupplierProfile(id) {
            const supplier = window.allSuppliers.find(s => s.id === id);
            if (!supplier) return;
            
            window.currentSupplierProfile = supplier;
            
            const sector = window.allSupplierSectors.find(s => s.id === supplier.sectorId);
            const product = window.allSupplierProducts.find(p => p.id === supplier.productId);
            const isSerbia = supplier.country === 'Сербия';
            
            // Инициалы для аватара
            const initials = supplier.name ? supplier.name.substring(0, 2).toUpperCase() : 'ПС';
            
            // Создаем модальное окно по аналогии с профилем клиента
            const content = `
                <!-- Заголовок карточки -->
                <div class="client-card-header" style="background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);">
                    <div class="client-avatar" style="background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);">${initials}</div>
                    <div class="client-title-info">
                        <h2>${supplier.name || 'Без названия'}</h2>
                        <p>${supplier.legalName || 'Поставщик'} ${supplier.country ? '• ' + supplier.country : ''}</p>
                    </div>
                    <button class="close" onclick="closeSupplierProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
                </div>

                <!-- Секции профиля -->
                <div class="profile-sections">
                    <!-- Основная информация -->
                    <div class="profile-section">
                        <h3>📋 Основная информация</h3>
                        <div class="profile-field">
                            <span class="profile-field-label">Название:</span>
                            <span class="profile-field-value">${supplier.name || '-'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Юридическое:</span>
                            <span class="profile-field-value">${supplier.legalName || '-'}</span>
                        </div>
                        ${isSerbia ? `
                        <div class="profile-field">
                            <span class="profile-field-label">Матични број:</span>
                            <span class="profile-field-value">${supplier.mb || '-'}</span>
                        </div>
                        ` : `
                        <div class="profile-field">
                            <span class="profile-field-label">Рег. номер:</span>
                            <span class="profile-field-value">${supplier.regNumber || '-'}</span>
                        </div>
                        `}
                        <div class="profile-field">
                            <span class="profile-field-label">ПИБ:</span>
                            <span class="profile-field-value">${supplier.pib || '-'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Сектор:</span>
                            <span class="profile-field-value">${sector ? '🏭 ' + sector.name : '-'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Продукция:</span>
                            <span class="profile-field-value">${product ? '📦 ' + product.name : '-'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Контакт. лицо:</span>
                            <span class="profile-field-value">
                                ${supplier.contactPerson || '-'}
                                ${supplier.contactPersonStatus ? `<span class="client-badge" style="background: #6c757d; margin-left: 8px;">${supplier.contactPersonStatus}</span>` : ''}
                            </span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Банк:</span>
                            <span class="profile-field-value">${supplier.bank || '-'}</span>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="profile-section">
                        <h3>📍 Адрес</h3>
                        <div class="profile-field">
                            <span class="profile-field-label">Страна:</span>
                            <span class="profile-field-value">🌍 ${supplier.country || '-'}</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Город:</span>
                            <span class="profile-field-value">${supplier.city || '-'}</span>
                        </div>
                        <div class="profile-address">
                            <span class="address-text">${supplier.address || 'Адрес не указан'}</span>
                            ${supplier.googleMaps ? `<button class="maps-btn" onclick="openUrlInDefaultBrowser('${supplier.googleMaps}')" title="Открыть в Google Maps">🗺️</button>` : ''}
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="profile-section">
                        <h3>📞 Контактные данные</h3>
                        <div class="contact-grid">
                            ${supplier.phone ? `
                            <div class="contact-item clickable-contact" onclick="copyToClipboard('${supplier.phone}', 'Телефон')">
                                <div class="contact-icon phone">📞</div>
                                <div class="contact-value">${supplier.phone}</div>
                            </div>
                            ` : ''}
                            ${supplier.email ? `
                            <div class="contact-item clickable-contact" onclick="copyToClipboard('${supplier.email}', 'Email')">
                                <div class="contact-icon email">✉️</div>
                                <div class="contact-value">${supplier.email}</div>
                            </div>
                            ` : ''}
                            ${supplier.telegram ? `
                            <div class="contact-item clickable-contact" onclick="openSupplierTelegram('${supplier.telegram}')">
                                <div class="contact-icon telegram">✈️</div>
                                <div class="contact-value">${supplier.telegram}</div>
                            </div>
                            ` : ''}
                            ${supplier.instagram ? `
                            <div class="contact-item clickable-contact" onclick="openSupplierInstagram('${supplier.instagram}')">
                                <div class="contact-icon instagram">📷</div>
                                <div class="contact-value">${supplier.instagram}</div>
                            </div>
                            ` : ''}
                            ${supplier.wechat ? `
                            <div class="contact-item clickable-contact" onclick="copyToClipboard('${supplier.wechat}', 'WeChat ID')">
                                <div class="contact-icon" style="background: linear-gradient(135deg, #09b83e, #04862c);">💬</div>
                                <div class="contact-value">${supplier.wechat}</div>
                            </div>
                            ` : ''}
                            ${supplier.website ? `
                            <div class="contact-item clickable-contact" onclick="openUrlInDefaultBrowser('${supplier.website}')">
                                <div class="contact-icon" style="background: linear-gradient(135deg, #607d8b, #455a64);">🌐</div>
                                <div class="contact-value">${supplier.website}</div>
                            </div>
                            ` : ''}
                            ${!supplier.phone && !supplier.email && !supplier.telegram && !supplier.instagram && !supplier.wechat && !supplier.website ? `
                            <p style="color: #666; text-align: center; grid-column: 1 / -1;">Контактные данные не указаны</p>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Примечания -->
                    ${supplier.notes ? `
                    <div class="profile-section" style="grid-column: 1 / -1;">
                        <h3>📝 Примечания</h3>
                        <div class="profile-notes" style="display: block; background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <p style="margin: 0; white-space: pre-wrap; color: #333;">${supplier.notes}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Связанные товары и группы -->
                    <div class="profile-section" style="grid-column: 1 / -1;">
                        <div class="collapsible-header" onclick="toggleSupplierLinkedItems()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                            <h3 style="margin: 0;">📦 Связанные товары и группы</h3>
                            <span id="supplierLinkedItemsToggle" style="font-size: 18px; transition: transform 0.3s;">▼</span>
                        </div>
                        <div id="supplierLinkedItemsContent" style="display: none; margin-top: 15px;">
                            ${getSupplierLinkedItems(supplier)}
                        </div>
                    </div>
                </div>

                <!-- Кнопки -->
                <div class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                    <button class="btn btn-primary" onclick="editSupplier(${supplier.id}); closeSupplierProfileModal();" style="margin-right: 10px;">✏️ Редактировать</button>
                    <button class="btn btn-secondary" onclick="closeSupplierProfileModal()">❌ Закрыть</button>
                </div>
            `;
            
            // Создаем модальное окно
            let modal = document.getElementById('supplierProfileModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'supplierProfileModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content client-profile-modal"></div>`;
                document.body.appendChild(modal);
                
                // Закрытие по клику вне окна
                modal.onclick = (e) => {
                    if (e.target === modal) closeSupplierProfileModal();
                };
            }
            
            modal.querySelector('.modal-content').innerHTML = content;
            modal.style.display = 'block';
        }

        // Закрыть профиль поставщика
        function closeSupplierProfileModal() {
            const modal = document.getElementById('supplierProfileModal');
            if (modal) modal.style.display = 'none';
            window.currentSupplierProfile = null;
        }

        // Переключение видимости связанных товаров/групп
        function toggleSupplierLinkedItems() {
            const content = document.getElementById('supplierLinkedItemsContent');
            const toggle = document.getElementById('supplierLinkedItemsToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        // Получить связанные товары и группы поставщика
        function getSupplierLinkedItems(supplier) {
            const supplierName = supplier.name || '';
            let html = '';
            
            // Находим товары с этим поставщиком
            const linkedProducts = (window.allProducts || []).filter(p => 
                p.supplier && p.supplier.toLowerCase() === supplierName.toLowerCase()
            );
            
            // Находим группы на складе с этим поставщиком
            const productGroups = JSON.parse(localStorage.getItem('productGroups') || '[]');
            const linkedGroups = productGroups.filter(g => 
                g.supplier && g.supplier.toLowerCase() === supplierName.toLowerCase()
            );
            
            // Секция товаров
            html += `<div style="margin-bottom: 20px;">
                <h4 style="color: #1976d2; margin-bottom: 10px; font-size: 14px;">🛒 Товары (${linkedProducts.length})</h4>`;
            
            if (linkedProducts.length > 0) {
                html += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                linkedProducts.forEach(product => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #1976d2;">
                            <div>
                                <strong style="color: #333;">${product.name || '-'}</strong>
                                <span style="color: #666; margin-left: 10px; font-size: 12px;">${product.code || ''}</span>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #666;">
                                ${product.category || ''} ${product.subcategory ? '/ ' + product.subcategory : ''}
                            </div>
                        </div>`;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: #999; font-style: italic; margin: 0;">Нет связанных товаров</p>`;
            }
            html += `</div>`;
            
            // Секция групп на складе
            html += `<div>
                <h4 style="color: #2e7d32; margin-bottom: 10px; font-size: 14px;">📦 Группы на складе (${linkedGroups.length})</h4>`;
            
            if (linkedGroups.length > 0) {
                html += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                linkedGroups.forEach(group => {
                    const totalQty = (group.quantity || 0) - (group.soldQuantity || 0) - (group.reservedQuantity || 0);
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 6px; border-left: 3px solid #2e7d32;">
                            <div>
                                <strong style="color: #333;">${group.groupName || group.name || '-'}</strong>
                                <span style="color: #666; margin-left: 10px; font-size: 12px;">${group.groupCode || ''}</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                    ${totalQty.toFixed(2)} кг
                                </span>
                                ${group.shipmentDate ? `<span style="color: #666; margin-left: 10px; font-size: 11px;">📅 ${group.shipmentDate}</span>` : ''}
                            </div>
                        </div>`;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: #999; font-style: italic; margin: 0;">Нет связанных групп</p>`;
            }
            html += `</div>`;
            
            return html;
        }
        
        // Вспомогательные функции для профиля поставщика
        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert(`📋 ${label} скопирован: ${text}`, 'success');
            }).catch(() => {
                showAlert(`Не удалось скопировать ${label}`, 'error');
            });
        }
        
        function openSupplierTelegram(telegram) {
            let url;
            if (telegram.startsWith('http://') || telegram.startsWith('https://')) {
                url = telegram;
            } else if (telegram.startsWith('@')) {
                url = `https://t.me/${telegram.substring(1)}`;
            } else if (telegram.startsWith('t.me/')) {
                url = `https://${telegram}`;
            } else {
                url = `https://t.me/${telegram}`;
            }
            openUrlInDefaultBrowser(url);
        }
        
        function openSupplierInstagram(instagram) {
            let url;
            if (instagram.startsWith('http://') || instagram.startsWith('https://')) {
                url = instagram;
            } else if (instagram.startsWith('@')) {
                url = `https://instagram.com/${instagram.substring(1)}`;
            } else if (instagram.startsWith('instagram.com/')) {
                url = `https://${instagram}`;
            } else {
                url = `https://instagram.com/${instagram}`;
            }
            openUrlInDefaultBrowser(url);
        }

        // ============================================
        // АВТОКОМПЛИТ ПОСТАВЩИКОВ
        // ============================================
        
        // Фильтрация выпадающего списка поставщиков
        function filterSupplierDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const query = input.value.toLowerCase().trim();
            
            if (query.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Фильтруем поставщиков
            const filtered = window.allSuppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(query) ||
                (supplier.legalName && supplier.legalName.toLowerCase().includes(query))
            );
            
            if (filtered.length === 0) {
                // Показываем возможность использовать введенное значение
                dropdown.innerHTML = `
                    <div class="dropdown-item" style="color: #666; font-style: italic;" onclick="selectSupplierFromDropdown('${inputId}', '${dropdownId}', '', '${input.value}')">
                        Использовать: "${input.value}"
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }
            
            // Показываем найденных поставщиков
            dropdown.innerHTML = filtered.slice(0, 10).map(supplier => {
                const sector = window.allSupplierSectors.find(s => s.id === supplier.sectorId);
                return `
                    <div class="dropdown-item" onclick="selectSupplierFromDropdown('${inputId}', '${dropdownId}', '${supplier.id}', '${supplier.name.replace(/'/g, "\\'")}')">
                        <strong>${supplier.name}</strong>
                        ${supplier.country ? `<span style="color: #888; font-size: 12px;"> • ${supplier.country}</span>` : ''}
                        ${sector ? `<span style="color: #2e7d32; font-size: 11px; margin-left: 5px;">${sector.name}</span>` : ''}
                    </div>
                `;
            }).join('');
            
            // Добавляем опцию использовать введенное значение если оно не совпадает с найденными
            const exactMatch = filtered.some(s => s.name.toLowerCase() === query);
            if (!exactMatch && query.length > 0) {
                dropdown.innerHTML += `
                    <div class="dropdown-item" style="color: #666; border-top: 1px solid #eee; font-style: italic;" onclick="selectSupplierFromDropdown('${inputId}', '${dropdownId}', '', '${input.value}')">
                        Использовать: "${input.value}"
                    </div>
                `;
            }
            
            dropdown.style.display = 'block';
        }
        
        // Выбор поставщика из выпадающего списка
        function selectSupplierFromDropdown(inputId, dropdownId, supplierId, supplierName) {
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(inputId.replace('Search', ''));
            const dropdown = document.getElementById(dropdownId);
            
            input.value = supplierName;
            if (hiddenInput) {
                // Всегда записываем имя поставщика - товары используют имя, не ID
                hiddenInput.value = supplierName;
            }
            dropdown.style.display = 'none';
        }
        
        // Закрытие dropdown при клике вне его
        document.addEventListener('click', function(event) {
            const dropdowns = ['productSupplierDropdown', 'editProductSupplierDropdown', 'groupSupplierDropdown', 'consumableGroupSupplierDropdown'];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                const input = document.getElementById(dropdownId.replace('Dropdown', 'Search'));
                
                if (dropdown && input && !dropdown.contains(event.target) && event.target !== input) {
                    dropdown.style.display = 'none';
                    // Записываем введенное значение в скрытое поле если оно не было выбрано из списка
                    const hiddenInput = document.getElementById(dropdownId.replace('Dropdown', ''));
                    if (hiddenInput && !hiddenInput.value && input.value.trim()) {
                        hiddenInput.value = input.value.trim();
                    }
                }
            });
        });
        
        // Обработчик blur для полей автокомплита поставщика
        ['productSupplierSearch', 'editProductSupplierSearch', 'groupSupplierSearch'].forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        const hiddenInput = document.getElementById(inputId.replace('Search', ''));
                        if (hiddenInput && input.value.trim()) {
                            // Если скрытое поле пустое, записываем введенное значение
                            if (!hiddenInput.value) {
                                hiddenInput.value = input.value.trim();
                            }
                        }
                    }, 200); // Небольшая задержка чтобы успел сработать клик по dropdown
                });
            }
        });

        // ============================================
        // РАСХОДНИКИ (система групп)
        // ============================================
        
        // Глобальные переменные для расходников
        window.consumableGroups = [];
        window.consumableCategories = [];
        window.consumableSubcategories = [];
        window.consumableHistory = [];
        window.productConsumablesTemp = []; // Временный список для редактирования связей

        // Загрузка групп расходников
        function loadConsumableGroups() {
            window.consumableGroups = JSON.parse(localStorage.getItem('consumableGroups') || '[]');
            window.consumableCategories = JSON.parse(localStorage.getItem('consumableCategories') || '[]');
            window.consumableSubcategories = JSON.parse(localStorage.getItem('consumableSubcategories') || '[]');
            window.consumableHistory = JSON.parse(localStorage.getItem('consumableHistory') || '[]');
            
            loadConsumableCategories();
            renderConsumableGroups();
        }

        // Переключение формы создания группы расходников
        function toggleConsumableGroupForm() {
            const section = document.getElementById('consumableGroupCreationForm');
            const icon = document.getElementById('toggleConsumableGroupIcon');
            const btn = document.getElementById('toggleConsumableGroupFormBtn');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                icon.textContent = '➖';
                document.getElementById('consumableGroupDate').value = new Date().toISOString().split('T')[0];
                loadConsumableCategories();
            } else {
                section.style.display = 'none';
                icon.textContent = '➕';
            }
        }

        // Переключение менеджера категорий расходников
        function toggleConsumableCategoryManager() {
            const section = document.getElementById('consumableCategoryManagerSection');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                loadConsumableCategories();
                updateConsumableSubcategoryCategorySelect();
            } else {
                section.style.display = 'none';
            }
        }

        // Загрузка категорий расходников
        function loadConsumableCategories() {
            window.consumableCategories = JSON.parse(localStorage.getItem('consumableCategories') || '[]');
            renderConsumableCategoriesList();
            updateConsumableCategorySelects();
        }

        // Отрисовка списка категорий расходников
        function renderConsumableCategoriesList() {
            const tbody = document.getElementById('consumableCategoriesListBody');
            if (!tbody) return;
            
            if (window.consumableCategories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">Нет категорий</td></tr>';
                return;
            }
            
            tbody.innerHTML = window.consumableCategories.map(cat => `
                <tr>
                    <td>${cat.name}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteConsumableCategory('${cat.id}')" style="padding: 5px 10px; font-size: 12px;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        // Обновление селектов категорий расходников
        function updateConsumableCategorySelects() {
            const selects = ['consumableGroupCategory', 'consumableGroupCategoryFilter', 'consumableSubcategoryCategorySelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isFilter = selectId.includes('Filter');
                
                select.innerHTML = isFilter ? 
                    '<option value="">📁 Все категории</option>' : 
                    '<option value="">Выберите категорию</option>';
                
                window.consumableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // Обновление селекта категорий для субкатегорий в менеджере
        function updateConsumableSubcategoryCategorySelect() {
            const select = document.getElementById('consumableSubcategoryCategorySelect');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">Выберите категорию</option>';
            
            window.consumableCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        // Загрузка субкатегорий для менеджера
        function loadConsumableSubcategoriesForManager() {
            const categoryId = document.getElementById('consumableSubcategoryCategorySelect').value;
            const tbody = document.getElementById('consumableSubcategoriesListBody');
            
            if (!categoryId) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">Выберите категорию</td></tr>';
                return;
            }
            
            const subs = window.consumableSubcategories.filter(s => s.categoryId === categoryId);
            
            if (subs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">Нет субкатегорий</td></tr>';
                return;
            }
            
            tbody.innerHTML = subs.map(sub => `
                <tr>
                    <td>${sub.name}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteConsumableSubcategory('${sub.id}')" style="padding: 3px 8px; font-size: 11px;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        // Загрузка субкатегорий для формы создания группы
        function loadConsumableSubcategoriesForSelect() {
            const categoryId = document.getElementById('consumableGroupCategory').value;
            const select = document.getElementById('consumableGroupSubcategory');
            
            if (!categoryId) {
                select.innerHTML = '<option value="">Сначала выберите категорию</option>';
                return;
            }
            
            const subs = window.consumableSubcategories.filter(s => s.categoryId === categoryId);
            
            select.innerHTML = '<option value="">Выберите субкатегорию</option>';
            subs.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                select.appendChild(option);
            });
        }

        // Добавление субкатегории расходников
        function addConsumableSubcategory() {
            const categoryId = document.getElementById('consumableSubcategoryCategorySelect').value;
            const input = document.getElementById('newConsumableSubcategoryName');
            const name = input.value.trim();
            
            if (!categoryId) {
                showAlert('Сначала выберите категорию', 'warning');
                return;
            }
            
            if (!name) {
                showAlert('Введите название субкатегории', 'warning');
                return;
            }
            
            if (window.consumableSubcategories.some(s => s.categoryId === categoryId && s.name.toLowerCase() === name.toLowerCase())) {
                showAlert('Субкатегория с таким названием уже существует в этой категории', 'warning');
                return;
            }
            
            const newSub = {
                id: Date.now().toString(),
                categoryId,
                name,
                createdAt: new Date().toISOString()
            };
            
            window.consumableSubcategories.push(newSub);
            localStorage.setItem('consumableSubcategories', JSON.stringify(window.consumableSubcategories));
            
            input.value = '';
            loadConsumableSubcategoriesForManager();
            showAlert('Субкатегория добавлена', 'success');
        }

        // Удаление субкатегории расходников
        function deleteConsumableSubcategory(id) {
            if (!confirm('Удалить эту субкатегорию?')) return;
            
            window.consumableSubcategories = window.consumableSubcategories.filter(s => s.id !== id);
            localStorage.setItem('consumableSubcategories', JSON.stringify(window.consumableSubcategories));
            
            loadConsumableSubcategoriesForManager();
            showAlert('Субкатегория удалена', 'success');
        }

        // Добавление новой категории расходников
        function addConsumableCategory() {
            const input = document.getElementById('newConsumableCategoryName');
            const name = input.value.trim();
            
            if (!name) {
                showAlert('Введите название категории', 'warning');
                return;
            }
            
            if (window.consumableCategories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showAlert('Категория с таким названием уже существует', 'warning');
                return;
            }
            
            const newCategory = {
                id: Date.now().toString(),
                name: name,
                createdAt: new Date().toISOString()
            };
            
            window.consumableCategories.push(newCategory);
            localStorage.setItem('consumableCategories', JSON.stringify(window.consumableCategories));
            
            input.value = '';
            renderConsumableCategoriesList();
            updateConsumableCategorySelects();
            showAlert('Категория добавлена', 'success');
        }

        // Удаление категории расходников
        function deleteConsumableCategory(id) {
            if (!confirm('Удалить эту категорию?')) return;
            
            window.consumableCategories = window.consumableCategories.filter(c => c.id !== id);
            localStorage.setItem('consumableCategories', JSON.stringify(window.consumableCategories));
            
            renderConsumableCategoriesList();
            updateConsumableCategorySelects();
            showAlert('Категория удалена', 'success');
        }

        // Обновление единиц измерения в форме группы
        function updateConsumableGroupUnits() {
            const unit = document.getElementById('consumableGroupUnit').value;
            document.getElementById('consumableGroupQuantityUnit').textContent = unit;
        }

        // Создание группы расходников
        function createConsumableGroup() {
            const code = document.getElementById('consumableGroupCode').value.trim().toUpperCase();
            const name = document.getElementById('consumableGroupName').value.trim();
            const categoryId = document.getElementById('consumableGroupCategory').value;
            const subcategoryId = document.getElementById('consumableGroupSubcategory').value;
            const unit = document.getElementById('consumableGroupUnit').value;
            const supplier = document.getElementById('consumableGroupSupplierSearch').value.trim();
            const date = document.getElementById('consumableGroupDate').value || new Date().toISOString().split('T')[0];
            const quantity = parseFloat(document.getElementById('consumableGroupQuantity').value) || 0;
            const price = parseFloat(document.getElementById('consumableGroupPrice').value) || 0;
            const note = document.getElementById('consumableGroupNote').value.trim();
            
            if (!code || !name || quantity <= 0) {
                showAlert('Заполните обязательные поля (Код, Название, Количество)', 'danger');
                return;
            }
            
            if (window.consumableGroups.some(g => g.code.toLowerCase() === code.toLowerCase())) {
                showAlert('Группа с таким кодом уже существует', 'danger');
                return;
            }
            
            const newGroup = {
                id: Date.now().toString(),
                code,
                name,
                categoryId,
                subcategoryId,
                unit,
                supplier,
                date,
                initialQuantity: quantity,
                currentQuantity: quantity,
                purchasePrice: price,
                note,
                createdAt: new Date().toISOString()
            };
            
            window.consumableGroups.push(newGroup);
            localStorage.setItem('consumableGroups', JSON.stringify(window.consumableGroups));
            
            // Добавляем в историю
            addConsumableHistoryEntry(newGroup.id, 'Поступление', quantity, quantity, `Создание группы. ${note}`);
            
            clearConsumableGroupForm();
            toggleConsumableGroupForm(); // Сворачиваем форму после создания
            renderConsumableGroups();
            showAlert('Группа расходников создана', 'success');
        }

        // Очистка формы группы
        function clearConsumableGroupForm() {
            ['consumableGroupCode', 'consumableGroupName', 'consumableGroupQuantity', 'consumableGroupPrice', 'consumableGroupNote'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('consumableGroupCategory').value = '';
            document.getElementById('consumableGroupSubcategory').innerHTML = '<option value="">Сначала выберите категорию</option>';
            document.getElementById('consumableGroupUnit').value = 'шт';
            document.getElementById('consumableGroupSupplierSearch').value = '';
            document.getElementById('consumableGroupSupplier').value = '';
            document.getElementById('consumableGroupDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('consumableGroupQuantityUnit').textContent = 'шт';
        }

        // Проверка расходников с низким остатком и показ предупреждения
        function checkLowStockConsumables() {
            // Загружаем данные расходников
            const consumableGroups = JSON.parse(localStorage.getItem('consumableGroups') || '[]');
            
            if (consumableGroups.length === 0) {
                console.log('📦 Нет групп расходников для проверки');
                return;
            }
            
            // Находим расходники с остатком менее 20%
            const lowStockItems = consumableGroups.filter(group => {
                if (!group.initialQuantity || group.initialQuantity === 0) return false;
                const percentRemaining = (group.currentQuantity / group.initialQuantity) * 100;
                return percentRemaining < 20;
            });
            
            if (lowStockItems.length === 0) {
                console.log('✅ Все расходники в норме');
                return;
            }
            
            console.log('⚠️ Найдены расходники с низким остатком:', lowStockItems.length);
            
            // Формируем список для модального окна
            const listContainer = document.getElementById('lowStockList');
            if (!listContainer) return;
            
            listContainer.innerHTML = lowStockItems.map(group => {
                const percentRemaining = (group.currentQuantity / group.initialQuantity * 100).toFixed(1);
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff5f5; border-left: 4px solid #f44336; border-radius: 4px; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; color: #333; font-size: 15px;">${group.name}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                Остаток: <strong style="color: #f44336;">${group.currentQuantity} ${group.unit}</strong> (${percentRemaining}%)
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="goToConsumable('${group.id}')" style="padding: 8px 15px; font-size: 13px;">
                            Перейти →
                        </button>
                    </div>
                `;
            }).join('');
            
            // Показываем модальное окно
            document.getElementById('lowStockModal').style.display = 'flex';
        }
        
        // Закрыть модальное окно предупреждения о расходниках
        function closeLowStockModal() {
            document.getElementById('lowStockModal').style.display = 'none';
        }
        
        // Перейти к конкретному расходнику
        function goToConsumable(groupId) {
            closeLowStockModal();
            
            // Переключаемся на вкладку склада
            showTab('warehouse');
            
            // Переключаемся на подвкладку расходников
            setTimeout(() => {
                switchWarehouseTab('consumables');
                
                // Прокручиваем к нужной карточке
                setTimeout(() => {
                    const card = document.querySelector(`.consumable-group-card[data-group-id="${groupId}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Подсвечиваем карточку
                        card.style.boxShadow = '0 0 20px rgba(244, 67, 54, 0.5)';
                        setTimeout(() => {
                            card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                        }, 3000);
                    }
                }, 300);
            }, 100);
        }
        
        // Расчёт среднего потребления в месяц для расходника
        function calculateAverageMonthlyConsumption(groupId) {
            if (!window.consumableHistory || window.consumableHistory.length === 0) {
                return 0;
            }
            
            // Фильтруем записи списания для данной группы (отрицательное количество = списание)
            const usageHistory = window.consumableHistory.filter(h => 
                h.groupId === groupId && h.quantity < 0
            );
            
            if (usageHistory.length === 0) {
                return 0;
            }
            
            // Группируем по месяцам
            const monthlyUsage = {};
            usageHistory.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyUsage[monthKey] = (monthlyUsage[monthKey] || 0) + Math.abs(entry.quantity);
            });
            
            const months = Object.keys(monthlyUsage);
            if (months.length === 0) return 0;
            
            // Среднее потребление
            const totalUsage = Object.values(monthlyUsage).reduce((sum, val) => sum + val, 0);
            return totalUsage / months.length;
        }

        // Отрисовка карточек групп расходников
        function renderConsumableGroups() {
            const container = document.getElementById('consumableGroupsContainer');
            if (!container) return;
            
            if (window.consumableGroups.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📦</div>
                        <h3 style="margin-bottom: 10px; color: #495057;">Нет групп расходников</h3>
                        <p>Нажмите "Создать группу" для добавления</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.consumableGroups.map(group => {
                const category = window.consumableCategories.find(c => c.id === group.categoryId);
                const subcategory = window.consumableSubcategories.find(s => s.id === group.subcategoryId);
                const totalValue = group.currentQuantity * (group.purchasePrice || 0);
                
                // Процент ОСТАТКА (а не использованного)
                const percentRemaining = group.initialQuantity > 0 ? (group.currentQuantity / group.initialQuantity * 100).toFixed(1) : 100;
                
                // Рассчитываем среднее потребление в месяц
                const avgMonthlyConsumption = calculateAverageMonthlyConsumption(group.id);
                
                // Определяем цвет прогресс-бара в зависимости от остатка
                let progressColor = 'linear-gradient(90deg, #4caf50, #8bc34a)'; // Зеленый
                if (percentRemaining < 20) {
                    progressColor = 'linear-gradient(90deg, #f44336, #e57373)'; // Красный
                } else if (percentRemaining < 40) {
                    progressColor = 'linear-gradient(90deg, #ff9800, #ffb74d)'; // Оранжевый
                }
                
                return `
                    <div class="consumable-group-card" data-group-id="${group.id}" data-category-id="${group.categoryId || ''}" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                        <div style="background: linear-gradient(135deg, ${percentRemaining < 20 ? '#f44336 0%, #d32f2f' : '#ff9800 0%, #f57c00'} 100%); color: white; padding: 15px 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px;">${group.name}</h3>
                                    <span style="font-size: 12px; opacity: 0.9;">${group.code}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: bold;">${group.currentQuantity}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">${group.unit}</div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 15px 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; margin-bottom: 15px;">
                                <div>
                                    <span style="color: #666;">Категория:</span><br>
                                    <strong>${category ? category.name : '-'}${subcategory ? ' / ' + subcategory.name : ''}</strong>
                                </div>
                                <div>
                                    <span style="color: #666;">Поставщик:</span><br>
                                    <strong>${group.supplier || '-'}</strong>
                                </div>
                                <div>
                                    <span style="color: #666;">Цена за ед.:</span><br>
                                    <strong>${group.purchasePrice ? formatPrice(group.purchasePrice) + ' RSD' : '-'}</strong>
                                </div>
                                <div>
                                    <span style="color: #666;">Сумма остатка:</span><br>
                                    <strong style="color: #2e7d32;">${formatPrice(totalValue)} RSD</strong>
                                </div>
                                <div>
                                    <span style="color: #666;">Остаток:</span><br>
                                    <strong style="color: ${percentRemaining < 20 ? '#f44336' : percentRemaining < 40 ? '#ff9800' : '#4caf50'};">${group.currentQuantity} ${group.unit} (${percentRemaining}%)</strong>
                                </div>
                                <div>
                                    <span style="color: #666;">Расход/мес:</span><br>
                                    <strong>${avgMonthlyConsumption > 0 ? avgMonthlyConsumption.toFixed(1) + ' ' + group.unit : '-'}</strong>
                                </div>
                            </div>
                            
                            <!-- Прогресс-бар остатка -->
                            <div style="background: #e9ecef; border-radius: 4px; height: 8px; margin-bottom: 15px; overflow: hidden;">
                                <div style="background: ${progressColor}; height: 100%; width: ${percentRemaining}%; transition: width 0.3s;"></div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="addToConsumableGroup('${group.id}')" style="padding: 6px 12px; font-size: 12px;">➕ Пополнить</button>
                                <button class="btn btn-warning" onclick="useFromConsumableGroup('${group.id}')" style="padding: 6px 12px; font-size: 12px;">📤 Списать</button>
                                <button class="btn btn-primary" onclick="editConsumableGroup('${group.id}')" style="padding: 6px 12px; font-size: 12px;">✏️</button>
                                <button class="btn btn-danger" onclick="deleteConsumableGroup('${group.id}')" style="padding: 6px 12px; font-size: 12px;">🗑️</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Переменные для модальных окон расходников
        let currentConsumableGroupId = null;

        // Автоматическое списание расходников при утверждении инвойса
        function deductConsumablesOnInvoice(invoiceItems) {
            if (!invoiceItems || invoiceItems.length === 0) {
                console.log('📦 Нет товаров в инвойсе для списания расходников');
                return;
            }
            
            // Загружаем группы расходников и связи товар-расходники
            let consumableGroups = JSON.parse(localStorage.getItem('consumableGroups') || '[]');
            const productConsumables = JSON.parse(localStorage.getItem('productConsumables') || '{}');
            let consumableHistory = JSON.parse(localStorage.getItem('consumableHistory') || '[]');
            
            if (consumableGroups.length === 0) {
                console.log('📦 Нет групп расходников для списания');
                return;
            }
            
            console.log('📦 Начинаем автоматическое списание расходников...');
            let totalDeductions = [];
            
            // Проходим по каждому товару в инвойсе
            invoiceItems.forEach(item => {
                const productCode = item.product?.internalCode || item.internalCode;
                const productName = item.product?.name || item.name;
                const productQty = item.quantity || 1;
                
                // Проверяем, есть ли связанные расходники для этого товара
                const linkedConsumables = productConsumables[productCode];
                
                if (!linkedConsumables || linkedConsumables.length === 0) {
                    console.log(`  ⏭️ Товар "${productName}" не имеет связанных расходников`);
                    return;
                }
                
                console.log(`  📦 Товар "${productName}" (x${productQty}) имеет ${linkedConsumables.length} связанных расходников`);
                
                // Списываем расходники
                linkedConsumables.forEach(consumableLink => {
                    const groupId = typeof consumableLink === 'string' ? consumableLink : consumableLink.groupId;
                    const perUnitQty = typeof consumableLink === 'string' ? 1 : (consumableLink.quantity || 1);
                    const totalToDeduct = perUnitQty * productQty;
                    
                    const group = consumableGroups.find(g => g.id === groupId);
                    
                    if (!group) {
                        console.log(`    ⚠️ Группа расходников ${groupId} не найдена`);
                        return;
                    }
                    
                    // Проверяем достаточно ли расходников
                    if (group.currentQuantity < totalToDeduct) {
                        console.log(`    ⚠️ Недостаточно "${group.name}": нужно ${totalToDeduct} ${group.unit}, доступно ${group.currentQuantity}`);
                        // Списываем что есть
                        const actualDeduct = group.currentQuantity;
                        if (actualDeduct > 0) {
                            group.currentQuantity = 0;
                            totalDeductions.push({
                                groupId: group.id,
                                groupName: group.name,
                                groupCode: group.code,
                                amount: actualDeduct,
                                unit: group.unit,
                                productName: productName
                            });
                            
                            // Добавляем в историю
                            consumableHistory.push({
                                id: Date.now().toString() + '_' + group.id,
                                groupId: group.id,
                                groupName: group.name,
                                groupCode: group.code,
                                operation: 'Авто-списание (продажа)',
                                quantity: -actualDeduct,
                                balance: 0,
                                note: `Продажа: ${productName} x${productQty} (частичное списание)`,
                                date: new Date().toISOString()
                            });
                        }
                        return;
                    }
                    
                    // Списываем расходники
                    group.currentQuantity -= totalToDeduct;
                    
                    totalDeductions.push({
                        groupId: group.id,
                        groupName: group.name,
                        groupCode: group.code,
                        amount: totalToDeduct,
                        unit: group.unit,
                        productName: productName
                    });
                    
                    // Добавляем в историю
                    consumableHistory.push({
                        id: Date.now().toString() + '_' + group.id,
                        groupId: group.id,
                        groupName: group.name,
                        groupCode: group.code,
                        operation: 'Авто-списание (продажа)',
                        quantity: -totalToDeduct,
                        balance: group.currentQuantity,
                        note: `Продажа: ${productName} x${productQty}`,
                        date: new Date().toISOString()
                    });
                    
                    console.log(`    ✅ Списано "${group.name}": -${totalToDeduct} ${group.unit} (осталось: ${group.currentQuantity})`);
                });
            });
            
            // Сохраняем обновленные данные
            if (totalDeductions.length > 0) {
                localStorage.setItem('consumableGroups', JSON.stringify(consumableGroups));
                localStorage.setItem('consumableHistory', JSON.stringify(consumableHistory));
                
                // Обновляем глобальные переменные
                window.consumableGroups = consumableGroups;
                window.consumableHistory = consumableHistory;
                
                console.log(`📦 Списание расходников завершено. Всего списаний: ${totalDeductions.length}`);
                
                // Показываем уведомление о списании
                const deductionSummary = totalDeductions.map(d => `${d.groupName}: -${d.amount} ${d.unit}`).join(', ');
                showAlert(`Расходники списаны: ${deductionSummary}`, 'info');
            } else {
                console.log('📦 Расходники не были списаны (нет связанных расходников)');
            }
        }

        // Пополнение группы расходников - открытие модального окна
        function addToConsumableGroup(groupId) {
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) return;
            
            currentConsumableGroupId = groupId;
            
            // Заполняем информацию о группе
            document.getElementById('replenishConsumableName').textContent = group.name;
            document.getElementById('replenishConsumableCode').textContent = `Код: ${group.code}`;
            document.getElementById('replenishConsumableAvailable').textContent = `Текущий остаток: ${group.currentQuantity} ${group.unit}`;
            document.getElementById('replenishConsumableUnit').textContent = group.unit;
            
            // Очищаем форму
            document.getElementById('replenishConsumableQuantity').value = '';
            document.getElementById('replenishConsumablePrice').value = group.purchasePrice || '';
            document.getElementById('replenishConsumableComment').value = '';
            
            // Показываем модальное окно
            document.getElementById('consumableReplenishModal').style.display = 'block';
        }

        // Закрытие модального окна пополнения
        function closeConsumableReplenishModal() {
            document.getElementById('consumableReplenishModal').style.display = 'none';
            currentConsumableGroupId = null;
        }

        // Подтверждение пополнения расходника
        function confirmConsumableReplenish() {
            const groupId = currentConsumableGroupId;
            if (!groupId) return;
            
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                closeConsumableReplenishModal();
                return;
            }
            
            const addAmount = parseFloat(document.getElementById('replenishConsumableQuantity').value);
            const newPrice = parseFloat(document.getElementById('replenishConsumablePrice').value);
            const comment = document.getElementById('replenishConsumableComment').value.trim();
            
            if (!addAmount || addAmount <= 0) {
                showAlert('Укажите корректное количество!', 'warning');
                return;
            }
            
            // Обновляем количество
            group.currentQuantity += addAmount;
            group.initialQuantity += addAmount;
            
            // Обновляем цену если указана
            if (newPrice && newPrice > 0) {
                group.purchasePrice = newPrice;
            }
            
            localStorage.setItem('consumableGroups', JSON.stringify(window.consumableGroups));
            addConsumableHistoryEntry(groupId, 'Пополнение', addAmount, group.currentQuantity, comment);
            
            renderConsumableGroups();
            closeConsumableReplenishModal();
            showAlert(`Пополнено: +${addAmount} ${group.unit}. Новый остаток: ${group.currentQuantity} ${group.unit}`, 'success');
        }

        // Списание из группы расходников - открытие модального окна
        function useFromConsumableGroup(groupId) {
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) return;
            
            currentConsumableGroupId = groupId;
            
            // Заполняем информацию о группе
            document.getElementById('deductConsumableName').textContent = group.name;
            document.getElementById('deductConsumableCode').textContent = `Код: ${group.code}`;
            document.getElementById('deductConsumableAvailable').textContent = `Доступно для списания: ${group.currentQuantity} ${group.unit}`;
            document.getElementById('deductConsumableUnit').textContent = group.unit;
            
            // Очищаем форму
            document.getElementById('deductConsumableQuantity').value = '';
            document.getElementById('deductConsumableReason').value = '';
            document.getElementById('deductConsumableComment').value = '';
            document.getElementById('deductConsumableError').style.display = 'none';
            document.getElementById('deductConsumableWarning').style.display = 'none';
            
            // Показываем модальное окно
            document.getElementById('consumableDeductModal').style.display = 'block';
        }

        // Закрытие модального окна списания
        function closeConsumableDeductModal() {
            document.getElementById('consumableDeductModal').style.display = 'none';
            currentConsumableGroupId = null;
        }

        // Подтверждение списания расходника
        function confirmConsumableDeduct() {
            const groupId = currentConsumableGroupId;
            if (!groupId) return;
            
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                closeConsumableDeductModal();
                return;
            }
            
            const deductAmount = parseFloat(document.getElementById('deductConsumableQuantity').value);
            const reason = document.getElementById('deductConsumableReason').value;
            const comment = document.getElementById('deductConsumableComment').value.trim();
            
            // Валидация
            if (!deductAmount || deductAmount <= 0) {
                document.getElementById('deductConsumableError').textContent = 'Укажите корректное количество!';
                document.getElementById('deductConsumableError').style.display = 'block';
                return;
            }
            
            if (!reason) {
                showAlert('Выберите основание списания!', 'warning');
                return;
            }
            
            if (deductAmount > group.currentQuantity) {
                document.getElementById('deductConsumableError').textContent = `Недостаточно! Доступно: ${group.currentQuantity} ${group.unit}`;
                document.getElementById('deductConsumableError').style.display = 'block';
                return;
            }
            
            const reasonNames = {
                'production': 'Использовано в производстве',
                'sale': 'Продажа',
                'defect': 'Брак',
                'expired': 'Истек срок годности',
                'loss': 'Потеря/убыль',
                'other': 'Другое'
            };
            
            // Выполняем списание
            group.currentQuantity -= deductAmount;
            
            localStorage.setItem('consumableGroups', JSON.stringify(window.consumableGroups));
            addConsumableHistoryEntry(groupId, 'Списание: ' + reasonNames[reason], -deductAmount, group.currentQuantity, comment);
            
            renderConsumableGroups();
            closeConsumableDeductModal();
            showAlert(`Списано: ${deductAmount} ${group.unit}. Остаток: ${group.currentQuantity} ${group.unit}`, 'success');
        }

        // Редактирование группы расходников
        function editConsumableGroup(groupId) {
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) return;
            
            // Заполняем форму
            document.getElementById('consumableGroupCode').value = group.code;
            document.getElementById('consumableGroupName').value = group.name;
            document.getElementById('consumableGroupCategory').value = group.categoryId || '';
            document.getElementById('consumableGroupUnit').value = group.unit;
            document.getElementById('consumableGroupSupplierSearch').value = group.supplier || '';
            document.getElementById('consumableGroupDate').value = group.date || '';
            document.getElementById('consumableGroupQuantity').value = group.currentQuantity;
            document.getElementById('consumableGroupPrice').value = group.purchasePrice || '';
            document.getElementById('consumableGroupNote').value = group.note || '';
            updateConsumableGroupUnits();
            
            // Удаляем старую группу
            window.consumableGroups = window.consumableGroups.filter(g => g.id !== groupId);
            localStorage.setItem('consumableGroups', JSON.stringify(window.consumableGroups));
            
            renderConsumableGroups();
            
            // Прокручиваем к форме
            document.getElementById('consumableGroupCreationForm').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Редактирование группы. После изменений нажмите "Создать группу"', 'info');
        }

        // Удаление группы расходников
        function deleteConsumableGroup(groupId) {
            const group = window.consumableGroups.find(g => g.id === groupId);
            if (!group) return;
            
            if (!confirm(`Удалить группу "${group.name}"?`)) return;
            
            window.consumableGroups = window.consumableGroups.filter(g => g.id !== groupId);
            localStorage.setItem('consumableGroups', JSON.stringify(window.consumableGroups));
            
            renderConsumableGroups();
            showAlert('Группа удалена', 'success');
        }

        // Фильтрация групп расходников
        function filterConsumableGroups() {
            const search = document.getElementById('consumableGroupSearchInput').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('consumableGroupCategoryFilter').value;
            
            const cards = document.querySelectorAll('.consumable-group-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const categoryId = card.dataset.categoryId || '';
                
                const matchesSearch = text.includes(search);
                const matchesCategory = !categoryFilter || categoryId === categoryFilter;
                
                card.style.display = (matchesSearch && matchesCategory) ? '' : 'none';
            });
        }

        // Сброс фильтров групп расходников
        function resetConsumableGroupFilters() {
            document.getElementById('consumableGroupSearchInput').value = '';
            document.getElementById('consumableGroupCategoryFilter').value = '';
            filterConsumableGroups();
        }

        // Добавление записи в историю расходников
        function addConsumableHistoryEntry(groupId, operation, quantity, balance, note) {
            const group = window.consumableGroups.find(g => g.id === groupId);
            
            const entry = {
                id: Date.now().toString(),
                groupId,
                groupName: group ? group.name : 'Неизвестно',
                groupCode: group ? group.code : '',
                operation,
                quantity,
                balance,
                note,
                date: new Date().toISOString()
            };
            
            window.consumableHistory.push(entry);
            localStorage.setItem('consumableHistory', JSON.stringify(window.consumableHistory));
            renderConsumableHistoryTable();
        }

        // Переключение истории операций
        function toggleConsumableHistory() {
            const section = document.getElementById('consumableHistorySection');
            const toggle = document.getElementById('consumableHistoryToggle');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                toggle.textContent = '▲';
                renderConsumableHistoryTable();
            } else {
                section.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        // Отрисовка истории операций
        function renderConsumableHistoryTable() {
            const tbody = document.getElementById('consumableHistoryTableBody');
            if (!tbody) return;
            
            if (window.consumableHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">История операций пуста</td></tr>';
                return;
            }
            
            // Сортируем по дате (новые первые)
            const sorted = [...window.consumableHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.slice(0, 50).map(entry => {
                const dateStr = new Date(entry.date).toLocaleDateString('ru-RU');
                const isPositive = entry.quantity > 0;
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td><strong>${entry.groupCode}</strong> - ${entry.groupName}</td>
                        <td style="color: ${entry.operation === 'Списание' ? '#dc3545' : '#28a745'};">${entry.operation}</td>
                        <td style="color: ${isPositive ? '#28a745' : '#dc3545'}; font-weight: bold;">${isPositive ? '+' : ''}${entry.quantity}</td>
                        <td>${entry.balance}</td>
                        <td>${entry.note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Редактирование поставщика
        function editSupplier(id) {
            const supplier = window.allSuppliers.find(s => s.id === id);
            if (!supplier) return;
            
            window.currentEditingSupplier = supplier;
            
            // Открываем форму
            const section = document.getElementById('supplierFormSection');
            const icon = document.getElementById('toggleSupplierIcon');
            section.style.display = 'block';
            icon.textContent = '➖';
            
            // Заполняем поля
            document.getElementById('supplierName').value = supplier.name || '';
            document.getElementById('supplierLegalName').value = supplier.legalName || '';
            document.getElementById('supplierCountry').value = supplier.country || '';
            
            // Обновляем отображение полей в зависимости от страны
            onSupplierCountryChange();
            
            document.getElementById('supplierMB').value = supplier.mb || '';
            document.getElementById('supplierPIB').value = supplier.pib || '';
            document.getElementById('supplierRegNumber').value = supplier.regNumber || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierCity').value = supplier.city || '';
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierTelegram').value = supplier.telegram || '';
            document.getElementById('supplierInstagram').value = supplier.instagram || '';
            document.getElementById('supplierWechat').value = supplier.wechat || '';
            document.getElementById('supplierWebsite').value = supplier.website || '';
            document.getElementById('supplierBank').value = supplier.bank || '';
            document.getElementById('supplierContactPerson').value = supplier.contactPerson || '';
            document.getElementById('supplierContactPersonStatus').value = supplier.contactPersonStatus || '';
            document.getElementById('supplierGoogleMaps').value = supplier.googleMaps || '';
            document.getElementById('supplierNotes').value = supplier.notes || '';
            
            // Устанавливаем сектор и продукцию
            document.getElementById('supplierSector').value = supplier.sectorId || '';
            updateSupplierProductOptions();
            setTimeout(() => {
                document.getElementById('supplierProduct').value = supplier.productId || '';
            }, 100);
            
            // Меняем кнопку на "Сохранить"
            const addBtn = section.querySelector('.btn-primary');
            addBtn.textContent = '💾 Сохранить изменения';
            addBtn.onclick = updateSupplier;
            
            // Скроллим к форме
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Обновление поставщика
        async function updateSupplier() {
            if (!window.currentEditingSupplier) return;
            
            const name = document.getElementById('supplierName').value.trim();
            
            if (!name) {
                showAlert('Введите название поставщика', 'warning');
                return;
            }
            
            const country = document.getElementById('supplierCountry').value;
            const isSerbia = country === 'Сербия';
            
            const supplierData = {
                id: window.currentEditingSupplier.id,
                name,
                legalName: document.getElementById('supplierLegalName').value.trim() || null,
                mb: isSerbia ? (document.getElementById('supplierMB').value.trim() || null) : null,
                pib: document.getElementById('supplierPIB').value.trim() || null,
                regNumber: !isSerbia ? (document.getElementById('supplierRegNumber').value.trim() || null) : null,
                address: document.getElementById('supplierAddress').value.trim() || null,
                city: document.getElementById('supplierCity').value.trim() || null,
                country: country || null,
                phone: document.getElementById('supplierPhone').value.trim() || null,
                email: document.getElementById('supplierEmail').value.trim() || null,
                telegram: document.getElementById('supplierTelegram').value.trim() || null,
                instagram: document.getElementById('supplierInstagram').value.trim() || null,
                wechat: document.getElementById('supplierWechat').value.trim() || null,
                website: document.getElementById('supplierWebsite').value.trim() || null,
                bank: document.getElementById('supplierBank').value.trim() || null,
                sectorId: document.getElementById('supplierSector').value || null,
                productId: document.getElementById('supplierProduct').value || null,
                contactPerson: document.getElementById('supplierContactPerson').value.trim() || null,
                contactPersonStatus: document.getElementById('supplierContactPersonStatus').value || null,
                googleMaps: document.getElementById('supplierGoogleMaps').value.trim() || null,
                notes: document.getElementById('supplierNotes').value.trim() || null
            };
            
            try {
                await window.api.suppliers.update(window.currentEditingSupplier.id, supplierData);
                
                // Обновляем в локальном массиве
                const index = window.allSuppliers.findIndex(s => s.id === window.currentEditingSupplier.id);
                if (index !== -1) {
                    window.allSuppliers[index] = { ...window.allSuppliers[index], ...supplierData };
                }
                
                renderSupplierCards();
                clearSupplierForm();
                toggleSupplierForm();
                
                // Возвращаем кнопку в исходное состояние
                const section = document.getElementById('supplierFormSection');
                const addBtn = section.querySelector('.btn-primary');
                addBtn.textContent = '✅ Добавить поставщика';
                addBtn.onclick = addSupplier;
                
                showAlert('✅ Поставщик обновлен', 'success');
            } catch (error) {
                console.error('Ошибка обновления поставщика:', error);
                showAlert('Ошибка обновления поставщика: ' + error.message, 'error');
            }
        }

        // Удаление поставщика
        async function deleteSupplier(id) {
            if (!confirm('Вы уверены, что хотите удалить этого поставщика?')) return;
            
            try {
                await window.api.suppliers.delete(id);
                window.allSuppliers = window.allSuppliers.filter(s => s.id !== id);
                renderSupplierCards();
                
                showAlert('✅ Поставщик удален', 'success');
            } catch (error) {
                console.error('Ошибка удаления поставщика:', error);
                showAlert('Ошибка удаления поставщика', 'error');
            }
        }

        // Загружаем данные при переключении на вкладку Расходы
        const originalShowTab = window.showTab;
        window.showTab = function(tabName) {
            originalShowTab(tabName);
            
            // Загружаем поставщиков при переходе на вкладки где нужен автокомплит
            if ((tabName === 'expenses' || tabName === 'products' || tabName === 'warehouse') && window.allSuppliers.length === 0) {
                loadSuppliersData();
            }
            
            // Загружаем группы расходников при переходе на вкладку Расходы
            if (tabName === 'expenses') {
                loadConsumableGroups();
                loadShipments();
            }
        };

        // ==============================================
        // СИСТЕМА ПОСТАВОК (SHIPMENTS)
        // ==============================================

        // Глобальные переменные поставок
        window.shipments = [];
        window.currentShipmentItems = [];
        window.currentShipmentExtraExpenses = [];
        window.currentViewingShipmentId = null;

        // Загрузка поставок
        function loadShipments() {
            window.shipments = JSON.parse(localStorage.getItem('shipments') || '[]');
            renderShipmentsList();
        }

        // Переключение формы поставки
        function toggleShipmentForm() {
            const form = document.getElementById('shipmentFormSection');
            const btn = document.getElementById('toggleShipmentFormBtn');
            const icon = document.getElementById('toggleShipmentIcon');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                icon.textContent = '✖️';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                
                // Устанавливаем сегодняшнюю дату
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('shipmentSendDate').value = today;
            } else {
                form.style.display = 'none';
                icon.textContent = '➕';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
            }
        }

        // Переключение секции логистики
        function toggleShipmentLogistics() {
            const section = document.getElementById('shipmentLogisticsSection');
            const btn = document.getElementById('toggleLogisticsBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = '🚚 Скрыть логистику';
            } else {
                section.style.display = 'none';
                btn.textContent = '🚚 Добавить логистику и расходы';
            }
        }

        // Поиск поставщиков для формы поставки
        function filterShipmentSuppliers() {
            const search = document.getElementById('shipmentSupplierSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('shipmentSupplierDropdown');
            
            if (search.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = window.allSuppliers.filter(s => 
                s.name.toLowerCase().includes(search)
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = filtered.map(s => `
                <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#f5f5f5'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectShipmentSupplier('${s.name.replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600;">${s.name}</div>
                    <div style="font-size: 12px; color: #666;">${s.sector || ''} ${s.product ? '• ' + s.product : ''}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectShipmentSupplier(name) {
            document.getElementById('shipmentSupplierSearch').value = name;
            document.getElementById('shipmentSupplierDropdown').style.display = 'none';
        }

        // Показать все группы со склада
        function showAllShipmentProducts() {
            const dropdown = document.getElementById('shipmentProductDropdown');
            
            // Читаем из localStorage
            let groups = [];
            try {
                const stored = localStorage.getItem('productGroups');
                console.log('showAllShipmentProducts: raw localStorage data:', stored);
                if (stored) {
                    groups = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Ошибка чтения productGroups:', e);
            }
            
            console.log('showAllShipmentProducts: найдено групп:', groups.length, groups);
            
            if (groups.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="color: #dc3545; font-weight: bold;">⚠️ На складе нет групп товаров!</div>
                        <div style="color: #666; font-size: 12px; margin-top: 10px;">
                            Сначала создайте группы во вкладке "Склад".<br>
                            <small>localStorage key: productGroups</small>
                        </div>
                    </div>
                `;
                dropdown.style.display = 'block';
                return;
            }

            const getUnit = (g) => g.quantityType === 'pieces' ? 'шт' : 'г';

            dropdown.innerHTML = `
                <div style="padding: 8px 15px; background: #f5f5f5; border-bottom: 2px solid #ffc107; font-weight: 600; color: #333;">
                    📦 Всего групп на складе: ${groups.length}
                </div>
            ` + groups.slice(0, 20).map(g => `
                <div style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#fff8e1'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectShipmentProduct('${g.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; color: #f57c00;">${g.groupCode || 'N/A'}</span>
                            <span style="margin-left: 10px; color: #333;">${g.name || 'Без названия'}</span>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            ${(g.currentQuantity || g.quantity || 0).toFixed(1)} ${getUnit(g)}
                        </div>
                    </div>
                    ${g.supplier ? `<div style="font-size: 11px; color: #999; margin-top: 3px;">Поставщик: ${g.supplier}</div>` : ''}
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        // Поиск товаров (групп со склада) для поставки
        function filterShipmentProducts() {
            const search = document.getElementById('shipmentProductSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('shipmentProductDropdown');
            
            if (search.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // ВСЕГДА читаем напрямую из localStorage для актуальности данных
            let groups = [];
            try {
                const stored = localStorage.getItem('productGroups');
                if (stored) {
                    groups = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Ошибка чтения productGroups из localStorage:', e);
            }
            
            // Также обновляем глобальную переменную
            if (groups.length > 0) {
                window.productGroups = groups;
                productGroups = groups;
            }
            
            console.log('filterShipmentProducts: найдено групп на складе:', groups.length);
            
            if (groups.length === 0) {
                dropdown.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">На складе нет групп товаров. Сначала создайте группы во вкладке "Склад".</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            const filtered = groups.filter(g => 
                (g.name && g.name.toLowerCase().includes(search)) || 
                (g.groupCode && g.groupCode.toLowerCase().includes(search))
            ).slice(0, 15);

            if (filtered.length === 0) {
                dropdown.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">Нет результатов для "${search}". Всего групп на складе: ${groups.length}</div>`;
                dropdown.style.display = 'block';
                return;
            }

            // Определяем единицу измерения
            const getUnit = (g) => {
                if (g.quantityType === 'pieces') return 'шт';
                return 'г';
            };

            dropdown.innerHTML = filtered.map(g => `
                <div style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#fff8e1'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectShipmentProduct('${g.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; color: #f57c00;">${g.groupCode}</span>
                            <span style="margin-left: 10px; color: #333;">${g.name}</span>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            На складе: ${(g.currentQuantity || g.quantity || 0).toFixed(1)} ${getUnit(g)}
                        </div>
                    </div>
                    ${g.supplier ? `<div style="font-size: 11px; color: #999; margin-top: 3px;">Поставщик: ${g.supplier}</div>` : ''}
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectShipmentProduct(groupId) {
            // Читаем напрямую из localStorage
            let groups = [];
            try {
                groups = JSON.parse(localStorage.getItem('productGroups') || '[]');
            } catch (e) {
                console.error('Ошибка чтения productGroups:', e);
            }
            const group = groups.find(g => String(g.id) === String(groupId));
            
            if (group) {
                document.getElementById('shipmentProductSearch').value = `${group.groupCode} - ${group.name}`;
                document.getElementById('shipmentProductSearch').dataset.groupId = groupId;
                document.getElementById('shipmentProductSearch').dataset.groupCode = group.groupCode;
                document.getElementById('shipmentProductSearch').dataset.groupName = group.name;
                
                // Устанавливаем единицу измерения по умолчанию на основе типа количества группы
                if (group.quantityType === 'pieces') {
                    document.getElementById('shipmentProductUnit').value = 'шт';
                } else {
                    document.getElementById('shipmentProductUnit').value = 'кг';
                }
                
                // Если у группы уже есть поставщик, подставляем его
                if (group.supplier) {
                    document.getElementById('shipmentItemSupplierSearch').value = group.supplier;
                }
            }
            
            document.getElementById('shipmentProductDropdown').style.display = 'none';
        }

        // Добавление товара в партию
        function addShipmentItem() {
            const searchInput = document.getElementById('shipmentProductSearch');
            const groupId = searchInput.dataset.groupId;
            const groupCode = searchInput.dataset.groupCode;
            const groupName = searchInput.dataset.groupName;
            const quantity = parseFloat(document.getElementById('shipmentProductQuantity').value);
            const unit = document.getElementById('shipmentProductUnit').value;
            const price = parseFloat(document.getElementById('shipmentProductPrice').value);
            const supplier = document.getElementById('shipmentItemSupplierSearch').value.trim();
            const vatRate = parseInt(document.getElementById('shipmentProductVAT').value) || 0;

            if (!groupId || !groupCode) {
                showAlert('Выберите товар из списка!', 'warning');
                return;
            }

            if (!quantity || quantity <= 0) {
                showAlert('Укажите количество!', 'warning');
                return;
            }

            if (!price || price < 0) {
                showAlert('Укажите цену!', 'warning');
                return;
            }

            // Проверяем, нет ли уже этого товара
            const existingIndex = window.currentShipmentItems.findIndex(item => item.groupId === groupId);
            if (existingIndex !== -1) {
                showAlert('Этот товар уже добавлен в партию!', 'warning');
                return;
            }

            // Рассчитываем количество в граммах для сохранения на склад
            let quantityInGrams = quantity;
            if (unit === 'кг') {
                quantityInGrams = quantity * 1000;
            }

            const subtotal = quantity * price;
            const vatAmount = subtotal * vatRate / 100;

            window.currentShipmentItems.push({
                groupId,
                groupCode,
                groupName,
                quantity,
                quantityInGrams,
                unit,
                price,
                supplier,
                vatRate,
                subtotal,
                vatAmount,
                total: subtotal + vatAmount
            });

            renderShipmentItems();
            updateShipmentTotals();

            // Очищаем поля
            searchInput.value = '';
            searchInput.dataset.groupId = '';
            searchInput.dataset.groupCode = '';
            searchInput.dataset.groupName = '';
            document.getElementById('shipmentProductQuantity').value = '';
            document.getElementById('shipmentProductPrice').value = '';
            document.getElementById('shipmentItemSupplierSearch').value = '';
            document.getElementById('shipmentProductVAT').value = '20';
        }

        // Фильтрация поставщиков для товара в партии
        function filterShipmentItemSuppliers() {
            const search = document.getElementById('shipmentItemSupplierSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('shipmentItemSupplierDropdown');
            
            if (search.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = window.allSuppliers.filter(s => 
                s.name.toLowerCase().includes(search)
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = filtered.map(s => `
                <div style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#f5f5f5'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectShipmentItemSupplier('${s.name.replace(/'/g, "\\'")}')">
                    <div style="font-weight: 600;">${s.name}</div>
                    <div style="font-size: 12px; color: #666;">${s.sector || ''} ${s.product ? '• ' + s.product : ''}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }

        function selectShipmentItemSupplier(name) {
            document.getElementById('shipmentItemSupplierSearch').value = name;
            document.getElementById('shipmentItemSupplierDropdown').style.display = 'none';
        }

        // Удаление товара из партии
        function removeShipmentItem(index) {
            window.currentShipmentItems.splice(index, 1);
            renderShipmentItems();
            updateShipmentTotals();
        }

        // Рендеринг списка товаров в партии
        function renderShipmentItems() {
            const container = document.getElementById('shipmentItemsList');
            const countEl = document.getElementById('shipmentItemsCount');
            const totalContainer = document.getElementById('shipmentItemsTotal');

            countEl.textContent = window.currentShipmentItems.length;

            if (window.currentShipmentItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <span style="font-size: 32px;">📋</span>
                        <p>Добавьте товары в партию</p>
                    </div>
                `;
                totalContainer.style.display = 'none';
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 8px; text-align: left; font-weight: 600;">Код</th>
                            <th style="padding: 8px; text-align: left; font-weight: 600;">Название</th>
                            <th style="padding: 8px; text-align: left; font-weight: 600;">Поставщик</th>
                            <th style="padding: 8px; text-align: right; font-weight: 600;">Кол-во</th>
                            <th style="padding: 8px; text-align: right; font-weight: 600;">Цена/ед.</th>
                            <th style="padding: 8px; text-align: center; font-weight: 600;">НДС</th>
                            <th style="padding: 8px; text-align: right; font-weight: 600;">Сумма</th>
                            <th style="padding: 8px; width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            window.currentShipmentItems.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; font-weight: 600; color: #f57c00;">${item.groupCode}</td>
                        <td style="padding: 8px;">${item.groupName}</td>
                        <td style="padding: 8px; color: #666; font-size: 12px;">${item.supplier || '-'}</td>
                        <td style="padding: 8px; text-align: right;">${item.quantity} ${item.unit}</td>
                        <td style="padding: 8px; text-align: right;">${formatPriceWithCurrency(item.price)}</td>
                        <td style="padding: 8px; text-align: center;">
                            <span style="background: ${item.vatRate > 0 ? '#e3f2fd' : '#f5f5f5'}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${item.vatRate}%</span>
                        </td>
                        <td style="padding: 8px; text-align: right;">
                            <div style="font-weight: 600; color: #28a745;">${formatPriceWithCurrency(item.total)}</div>
                            ${item.vatAmount > 0 ? `<div style="font-size: 11px; color: #17a2b8;">НДС: ${formatPriceWithCurrency(item.vatAmount)}</div>` : ''}
                        </td>
                        <td style="padding: 8px; text-align: center;">
                            <button onclick="removeShipmentItem(${index})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">✖</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            totalContainer.style.display = 'block';
        }

        // Добавление дополнительного расхода
        function addShipmentExtraExpense() {
            const container = document.getElementById('shipmentExtraExpensesList');
            const index = window.currentShipmentExtraExpenses.length;
            
            window.currentShipmentExtraExpenses.push({ description: '', amount: 0 });

            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            div.id = `extraExpense${index}`;
            div.innerHTML = `
                <input type="text" placeholder="Описание расхода" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" 
                       onchange="updateShipmentExtraExpense(${index}, 'description', this.value)">
                <input type="number" placeholder="Сумма (RSD)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" step="0.01"
                       onchange="updateShipmentExtraExpense(${index}, 'amount', this.value); updateShipmentTotals()">
                <button onclick="removeShipmentExtraExpense(${index})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">✖</button>
            `;
            container.appendChild(div);
        }

        function updateShipmentExtraExpense(index, field, value) {
            if (window.currentShipmentExtraExpenses[index]) {
                window.currentShipmentExtraExpenses[index][field] = field === 'amount' ? parseFloat(value) || 0 : value;
            }
        }

        function removeShipmentExtraExpense(index) {
            const el = document.getElementById(`extraExpense${index}`);
            if (el) el.remove();
            window.currentShipmentExtraExpenses[index] = null;
            updateShipmentTotals();
        }

        // Обновление итогов
        function updateShipmentTotals() {
            // Товары - считаем с НДС по каждому товару отдельно
            const productsSubtotal = window.currentShipmentItems.reduce((sum, item) => sum + (item.subtotal || item.total), 0);
            const productsVATTotal = window.currentShipmentItems.reduce((sum, item) => sum + (item.vatAmount || 0), 0);
            const productsTotal = productsSubtotal + productsVATTotal;
            
            document.getElementById('shipmentProductsSubtotal').textContent = formatPriceWithCurrency(productsSubtotal);
            document.getElementById('shipmentProductsVATTotal').textContent = formatPriceWithCurrency(productsVATTotal);
            document.getElementById('shipmentProductsTotal').textContent = formatPriceWithCurrency(productsTotal);

            // Логистика
            const delivery = parseFloat(document.getElementById('shipmentDeliveryCost')?.value) || 0;
            const customs = parseFloat(document.getElementById('shipmentCustomsCost')?.value) || 0;
            const sanitary = parseFloat(document.getElementById('shipmentSanitaryCost')?.value) || 0;
            const other = parseFloat(document.getElementById('shipmentOtherCost')?.value) || 0;
            const extraExpenses = window.currentShipmentExtraExpenses
                .filter(e => e !== null)
                .reduce((sum, e) => sum + (e.amount || 0), 0);
            
            const logisticsSubtotal = delivery + customs + sanitary + other + extraExpenses;
            const logisticsVATRate = parseInt(document.getElementById('shipmentLogisticsVAT')?.value) || 0;
            const logisticsVATAmount = logisticsSubtotal * logisticsVATRate / 100;
            const logisticsTotal = logisticsSubtotal + logisticsVATAmount;
            
            const logisticsSubtotalEl = document.getElementById('shipmentLogisticsSubtotal');
            const logisticsVATTotalEl = document.getElementById('shipmentLogisticsVATTotal');
            const logisticsTotalEl = document.getElementById('shipmentLogisticsTotal');
            
            if (logisticsSubtotalEl) logisticsSubtotalEl.textContent = formatPriceWithCurrency(logisticsSubtotal);
            if (logisticsVATTotalEl) logisticsVATTotalEl.textContent = formatPriceWithCurrency(logisticsVATAmount);
            if (logisticsTotalEl) logisticsTotalEl.textContent = formatPriceWithCurrency(logisticsTotal);

            // Комиссия
            const commission = parseFloat(document.getElementById('shipmentCommission')?.value) || 0;

            // Общая сумма
            const grandTotal = productsTotal + logisticsTotal + commission;

            document.getElementById('shipmentGrandTotal').textContent = formatPriceWithCurrency(grandTotal);
            document.getElementById('shipmentSummaryProducts').textContent = formatPrice(productsSubtotal);
            document.getElementById('shipmentSummaryProductsVAT').textContent = formatPrice(productsVATTotal);
            document.getElementById('shipmentSummaryLogistics').textContent = formatPrice(logisticsSubtotal);
            document.getElementById('shipmentSummaryLogisticsVAT').textContent = formatPrice(logisticsVATAmount);
            document.getElementById('shipmentSummaryCommission').textContent = formatPrice(commission);
        }

        // Очистка формы
        function clearShipmentForm() {
            window.currentShipmentItems = [];
            window.currentShipmentExtraExpenses = [];
            
            document.getElementById('shipmentSendDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('shipmentReceiveDate').value = '';
            document.getElementById('shipmentProductSearch').value = '';
            document.getElementById('shipmentProductQuantity').value = '';
            document.getElementById('shipmentProductPrice').value = '';
            document.getElementById('shipmentItemSupplierSearch').value = '';
            document.getElementById('shipmentProductVAT').value = '20';
            document.getElementById('shipmentDeliveryCost').value = '';
            document.getElementById('shipmentCustomsCost').value = '';
            document.getElementById('shipmentSanitaryCost').value = '';
            document.getElementById('shipmentOtherCost').value = '';
            document.getElementById('shipmentLogisticsVAT').value = '20';
            document.getElementById('shipmentCommission').value = '';
            document.getElementById('shipmentNote').value = '';
            document.getElementById('shipmentExtraExpensesList').innerHTML = '';
            
            renderShipmentItems();
            updateShipmentTotals();
            
            // Скрываем логистику
            document.getElementById('shipmentLogisticsSection').style.display = 'none';
            document.getElementById('toggleLogisticsBtn').textContent = '🚚 Добавить логистику и расходы';
        }

        // Сохранение поставки
        function saveShipment() {
            if (window.currentShipmentItems.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'warning');
                return;
            }

            const sendDate = document.getElementById('shipmentSendDate').value;
            if (!sendDate) {
                showAlert('Укажите дату отправки!', 'warning');
                return;
            }

            const receiveDate = document.getElementById('shipmentReceiveDate').value;
            const note = document.getElementById('shipmentNote').value;

            // Расходы на логистику
            const delivery = parseFloat(document.getElementById('shipmentDeliveryCost')?.value) || 0;
            const customs = parseFloat(document.getElementById('shipmentCustomsCost')?.value) || 0;
            const sanitary = parseFloat(document.getElementById('shipmentSanitaryCost')?.value) || 0;
            const other = parseFloat(document.getElementById('shipmentOtherCost')?.value) || 0;
            const extraExpenses = window.currentShipmentExtraExpenses.filter(e => e !== null && e.description);
            const logisticsVATRate = parseInt(document.getElementById('shipmentLogisticsVAT')?.value) || 0;
            
            const commission = parseFloat(document.getElementById('shipmentCommission')?.value) || 0;

            // Расчеты с НДС по каждому товару отдельно
            const productsSubtotal = window.currentShipmentItems.reduce((sum, item) => sum + (item.subtotal || item.total), 0);
            const productsVATTotal = window.currentShipmentItems.reduce((sum, item) => sum + (item.vatAmount || 0), 0);
            const productsTotal = productsSubtotal + productsVATTotal;

            // Логистика с НДС
            const logisticsSubtotal = delivery + customs + sanitary + other + extraExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const logisticsVATAmount = logisticsSubtotal * logisticsVATRate / 100;
            const logisticsTotal = logisticsSubtotal + logisticsVATAmount;

            const grandTotal = productsTotal + logisticsTotal + commission;

            // Общее количество в граммах для расчета себестоимости
            const totalQuantityGrams = window.currentShipmentItems.reduce((sum, item) => sum + item.quantityInGrams, 0);
            
            // Себестоимость 1: равномерное распределение всех расходов
            const allExpenses = logisticsTotal + commission;
            const costPrice1 = totalQuantityGrams > 0 ? (productsTotal + allExpenses) / (totalQuantityGrams / 1000) : 0;

            // Себестоимость 2: пропорциональное распределение расходов по цене товара
            let costPrice2Items = window.currentShipmentItems.map(item => {
                const itemTotal = item.total || (item.subtotal + item.vatAmount);
                const priceShare = productsTotal > 0 ? itemTotal / productsTotal : 0;
                const expenseShare = allExpenses * priceShare;
                const itemCostPrice = item.quantityInGrams > 0 ? (itemTotal + expenseShare) / (item.quantityInGrams / 1000) : 0;
                return { ...item, costPrice2: itemCostPrice };
            });

            // Средневзвешенная себестоимость 2
            const costPrice2 = totalQuantityGrams > 0 ? costPrice2Items.reduce((sum, item) => {
                return sum + (item.costPrice2 * item.quantityInGrams);
            }, 0) / totalQuantityGrams : 0;

            const isEditing = !!window.editingShipmentId;
            let shipment;
            let oldShipment = null;

            if (isEditing) {
                // Режим редактирования
                const shipmentIndex = window.shipments.findIndex(s => s.id === window.editingShipmentId);
                if (shipmentIndex === -1) {
                    showAlert('Поставка не найдена!', 'error');
                    return;
                }

                oldShipment = { ...window.shipments[shipmentIndex] };
                
                // Откатываем старые изменения на складе
                revertWarehouseFromShipment(oldShipment);

                shipment = {
                    ...window.shipments[shipmentIndex],
                    sendDate,
                    receiveDate,
                    items: window.currentShipmentItems,
                    expenses: {
                        delivery,
                        customs,
                        sanitary,
                        other,
                        extra: extraExpenses,
                        logisticsVATRate,
                        logisticsVATAmount
                    },
                    commission,
                    productsSubtotal,
                    productsVATTotal,
                    productsTotal,
                    logisticsSubtotal,
                    logisticsTotal,
                    grandTotal,
                    costPrice1: Math.round(costPrice1 * 100) / 100,
                    costPrice2: Math.round(costPrice2 * 100) / 100,
                    note,
                    updatedAt: new Date().toISOString()
                };

                window.shipments[shipmentIndex] = shipment;
                window.editingShipmentId = null;
            } else {
                // Режим создания новой поставки
                shipment = {
                    id: 'SHP-' + Date.now(),
                    number: 'П-' + (window.shipments.length + 1).toString().padStart(4, '0'),
                    sendDate,
                    receiveDate,
                    items: window.currentShipmentItems,
                    expenses: {
                        delivery,
                        customs,
                        sanitary,
                        other,
                        extra: extraExpenses,
                        logisticsVATRate,
                        logisticsVATAmount
                    },
                    commission,
                    productsSubtotal,
                    productsVATTotal,
                    productsTotal,
                    logisticsSubtotal,
                    logisticsTotal,
                    grandTotal,
                    costPrice1: Math.round(costPrice1 * 100) / 100,
                    costPrice2: Math.round(costPrice2 * 100) / 100,
                    note,
                    createdAt: new Date().toISOString()
                };

                window.shipments.push(shipment);
            }

            localStorage.setItem('shipments', JSON.stringify(window.shipments));

            // Обновляем склад - добавляем товары с пересчетом средневзвешенной себестоимости
            updateWarehouseFromShipment(shipment);

            // Очищаем и закрываем форму
            clearShipmentForm();
            toggleShipmentForm();
            renderShipmentsList();

            // Восстанавливаем текст кнопки
            const saveBtn = document.querySelector('#shipmentFormSection button[onclick="saveShipment()"]');
            if (saveBtn) {
                saveBtn.innerHTML = '💾 Сохранить поставку';
            }

            const message = isEditing ? 
                `Поставка ${shipment.number} обновлена!` : 
                `Поставка ${shipment.number} сохранена! Товары добавлены на склад.`;
            showAlert(message, 'success');
            addLog(isEditing ? `Обновлена поставка ${shipment.number}` : `Создана поставка ${shipment.number}`);
        }

        // Откат изменений склада для редактирования поставки
        function revertWarehouseFromShipment(shipment) {
            let groups = JSON.parse(localStorage.getItem('productGroups') || '[]');
            
            shipment.items.forEach(item => {
                const groupIndex = groups.findIndex(g => String(g.id) === String(item.groupId));
                if (groupIndex !== -1) {
                    const group = groups[groupIndex];
                    const qtyToRemove = group.quantityType === 'pieces' ? item.quantity : item.quantityInGrams;
                    group.currentQuantity = Math.max(0, (group.currentQuantity || 0) - qtyToRemove);
                    
                    // Удаляем запись из истории поступлений
                    if (group.additions) {
                        group.additions = group.additions.filter(a => a.shipmentId !== shipment.id);
                    }
                }
            });

            localStorage.setItem('productGroups', JSON.stringify(groups));
            window.productGroups = groups;
        }

        // Обновление склада после сохранения поставки
        function updateWarehouseFromShipment(shipment) {
            // Читаем напрямую из localStorage
            let groups = [];
            try {
                groups = JSON.parse(localStorage.getItem('productGroups') || '[]');
            } catch (e) {
                console.error('Ошибка чтения productGroups:', e);
                return;
            }
            
            shipment.items.forEach(item => {
                const groupIndex = groups.findIndex(g => String(g.id) === String(item.groupId));
                if (groupIndex !== -1) {
                    const group = groups[groupIndex];
                    
                    // Сохраняем старые значения для расчета средневзвешенной
                    const oldQuantity = group.currentQuantity || group.quantity || 0;
                    const oldCostPrice1 = group.costPrice1 || 0;
                    const oldCostPrice2 = group.costPrice2 || 0;
                    
                    // Добавляем количество (в граммах для веса или штуках)
                    let newItemQuantity;
                    if (group.quantityType === 'pieces') {
                        newItemQuantity = item.quantity;
                        group.currentQuantity = oldQuantity + item.quantity;
                    } else {
                        newItemQuantity = item.quantityInGrams;
                        group.currentQuantity = oldQuantity + item.quantityInGrams;
                    }
                    
                    // Рассчитываем себестоимость этого поступления
                    const itemTotal = item.total || (item.subtotal + item.vatAmount);
                    const totalExpenses = (shipment.logisticsTotal || 0) + (shipment.commission || 0);
                    const productsTotal = shipment.productsTotal || 0;
                    
                    // Равномерное распределение для этой партии
                    const totalQtyKg = shipment.items.reduce((sum, i) => sum + (i.quantityInGrams / 1000), 0);
                    const itemQtyKg = item.quantityInGrams / 1000;
                    const expenseShareUniform = totalQtyKg > 0 ? (totalExpenses / totalQtyKg) * itemQtyKg : 0;
                    const newCostPrice1 = itemQtyKg > 0 ? (itemTotal + expenseShareUniform) / itemQtyKg : 0;
                    
                    // Пропорциональное распределение для этой партии
                    const priceShare = productsTotal > 0 ? itemTotal / productsTotal : 0;
                    const expenseShareProportional = totalExpenses * priceShare;
                    const newCostPrice2 = itemQtyKg > 0 ? (itemTotal + expenseShareProportional) / itemQtyKg : 0;
                    
                    // СРЕДНЕВЗВЕШЕННАЯ себестоимость: (старый_объем * старая_цена + новый_объем * новая_цена) / общий_объем
                    // Используем граммы для веса, штуки для штук
                    const totalQuantity = group.currentQuantity;
                    
                    if (oldCostPrice1 > 0 && oldQuantity > 0) {
                        // Есть предыдущая себестоимость - считаем средневзвешенную
                        group.costPrice1 = Math.round(((oldQuantity * oldCostPrice1 + newItemQuantity * newCostPrice1) / totalQuantity) * 100) / 100;
                        group.costPrice2 = Math.round(((oldQuantity * oldCostPrice2 + newItemQuantity * newCostPrice2) / totalQuantity) * 100) / 100;
                    } else {
                        // Первая поставка с ценой - просто записываем
                        group.costPrice1 = Math.round(newCostPrice1 * 100) / 100;
                        group.costPrice2 = Math.round(newCostPrice2 * 100) / 100;
                    }
                    
                    // Добавляем в историю поступлений группы
                    if (!group.additions) {
                        group.additions = [];
                    }
                    group.additions.push({
                        date: new Date().toISOString(),
                        type: 'shipment',
                        shipmentId: shipment.id,
                        shipmentNumber: shipment.number,
                        quantity: newItemQuantity,
                        quantityKg: itemQtyKg,
                        unit: item.unit,
                        price: item.price,
                        vatRate: item.vatRate,
                        supplier: item.supplier,
                        itemCostPrice1: Math.round(newCostPrice1 * 100) / 100,
                        itemCostPrice2: Math.round(newCostPrice2 * 100) / 100,
                        costPrice1: group.costPrice1,
                        costPrice2: group.costPrice2,
                        stockBefore: oldQuantity,
                        stockAfter: group.currentQuantity
                    });
                    
                    // Обновляем процент остатка
                    if (group.originalQuantity > 0) {
                        group.remainingPercentage = (group.currentQuantity / group.originalQuantity) * 100;
                    }
                }
            });

            // Сохраняем в правильное хранилище
            window.productGroups = groups;
            localStorage.setItem('productGroups', JSON.stringify(groups));
            
            // Обновляем отображение склада если функция доступна
            if (typeof renderProductGroups === 'function') {
                renderProductGroups();
            }
        }

        // Рендеринг списка поставок
        function renderShipmentsList() {
            const container = document.getElementById('shipmentsListContainer');
            if (!container) return;

            if (window.shipments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; background: #f8f9fa; border-radius: 10px;">
                        <span style="font-size: 48px;">📦</span>
                        <p style="margin-top: 15px;">Пока нет сохранённых поставок</p>
                    </div>
                `;
                return;
            }

            // Фильтрация и сортировка
            const search = document.getElementById('shipmentSearchInput')?.value.toLowerCase().trim() || '';
            const sortOrder = document.getElementById('shipmentSortOrder')?.value || 'date_desc';

            let filtered = window.shipments.filter(s => 
                s.number.toLowerCase().includes(search) ||
                (s.supplier && s.supplier.toLowerCase().includes(search)) ||
                s.items.some(i => i.groupCode.toLowerCase().includes(search) || i.groupName.toLowerCase().includes(search))
            );

            // Сортировка
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'date_asc': return new Date(a.sendDate) - new Date(b.sendDate);
                    case 'total_desc': return b.grandTotal - a.grandTotal;
                    case 'total_asc': return a.grandTotal - b.grandTotal;
                    default: return new Date(b.sendDate) - new Date(a.sendDate);
                }
            });

            let html = '<div style="display: grid; gap: 15px;">';

            filtered.forEach(shipment => {
                const sendDate = new Date(shipment.sendDate).toLocaleDateString('ru-RU');
                const receiveDate = shipment.receiveDate ? new Date(shipment.receiveDate).toLocaleDateString('ru-RU') : '-';
                const itemsCount = shipment.items.length;

                html += `
                    <div style="background: white; border-radius: 10px; padding: 20px; border: 1px solid #e0e0e0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: #f57c00;">${shipment.number}</div>
                                <div style="color: #666; font-size: 13px; margin-top: 3px;">${shipment.supplier || 'Поставщик не указан'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: #28a745;">${formatPriceWithCurrency(shipment.grandTotal)}</div>
                                <div style="color: #666; font-size: 12px;">${itemsCount} товар(ов)</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 13px;">
                            <div>
                                <span style="color: #999;">Отправка:</span>
                                <span style="font-weight: 600; color: #f57c00;">${sendDate}</span>
                            </div>
                            <div>
                                <span style="color: #999;">Приём:</span>
                                <span style="font-weight: 600; color: #28a745;">${receiveDate}</span>
                            </div>
                            <div>
                                <span style="color: #999;">Себест. (равн.):</span>
                                <span style="font-weight: 600;">${shipment.costPrice1} RSD/кг</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="viewShipment('${shipment.id}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                                👁️ Просмотр
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Фильтрация поставок
        function filterShipments() {
            renderShipmentsList();
        }

        // Просмотр поставки
        function viewShipment(shipmentId) {
            const shipment = window.shipments.find(s => s.id === shipmentId);
            if (!shipment) {
                showAlert('Поставка не найдена!', 'error');
                return;
            }

            window.currentViewingShipmentId = shipmentId;

            // Заполняем модальное окно
            document.getElementById('viewShipmentNumber').textContent = shipment.number;
            document.getElementById('viewShipmentSupplier').textContent = shipment.supplier || 'Не указан';
            document.getElementById('viewShipmentSendDate').textContent = new Date(shipment.sendDate).toLocaleDateString('ru-RU');
            document.getElementById('viewShipmentReceiveDate').textContent = shipment.receiveDate ? new Date(shipment.receiveDate).toLocaleDateString('ru-RU') : 'Не указана';

            // Товары
            let itemsHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; text-align: left;">Код</th>
                            <th style="padding: 10px; text-align: left;">Название</th>
                            <th style="padding: 10px; text-align: right;">Кол-во</th>
                            <th style="padding: 10px; text-align: right;">Цена</th>
                            <th style="padding: 10px; text-align: right;">Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            shipment.items.forEach(item => {
                itemsHtml += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: 600; color: #f57c00;">${item.groupCode}</td>
                        <td style="padding: 10px;">${item.groupName}</td>
                        <td style="padding: 10px; text-align: right;">${item.quantity} ${item.unit}</td>
                        <td style="padding: 10px; text-align: right;">${formatPriceWithCurrency(item.price)}</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600;">${formatPriceWithCurrency(item.total)}</td>
                    </tr>
                `;
            });
            itemsHtml += '</tbody></table>';
            document.getElementById('viewShipmentItems').innerHTML = itemsHtml;
            document.getElementById('viewShipmentProductsTotal').textContent = formatPriceWithCurrency(shipment.productsTotal);

            // Расходы
            let expensesHtml = '';
            const exp = shipment.expenses;
            if (exp.delivery > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #f5f5f5; border-radius: 6px;"><span>🚚 Доставка</span><span>${formatPriceWithCurrency(exp.delivery)}</span></div>`;
            if (exp.customs > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #f5f5f5; border-radius: 6px;"><span>🛃 Таможня</span><span>${formatPriceWithCurrency(exp.customs)}</span></div>`;
            if (exp.sanitary > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #f5f5f5; border-radius: 6px;"><span>🏥 Санпид</span><span>${formatPriceWithCurrency(exp.sanitary)}</span></div>`;
            if (exp.other > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #f5f5f5; border-radius: 6px;"><span>📝 Прочие</span><span>${formatPriceWithCurrency(exp.other)}</span></div>`;
            if (exp.extra && exp.extra.length > 0) {
                exp.extra.forEach(e => {
                    expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #fff8e1; border-radius: 6px;"><span>${e.description}</span><span>${formatPriceWithCurrency(e.amount)}</span></div>`;
                });
            }
            if (shipment.vatAmount > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #e3f2fd; border-radius: 6px;"><span>НДС (${shipment.vatRate}%)</span><span>${formatPriceWithCurrency(shipment.vatAmount)}</span></div>`;
            if (shipment.commission > 0) expensesHtml += `<div style="display: flex; justify-content: space-between; padding: 8px; background: #fce4ec; border-radius: 6px;"><span>Комиссия</span><span>${formatPriceWithCurrency(shipment.commission)}</span></div>`;
            
            if (!expensesHtml) expensesHtml = '<div style="text-align: center; color: #999; padding: 20px;">Нет дополнительных расходов</div>';
            document.getElementById('viewShipmentExpenses').innerHTML = expensesHtml;

            // Итого - детальная разбивка как при создании
            document.getElementById('viewShipmentTotal').textContent = formatPriceWithCurrency(shipment.grandTotal);
            document.getElementById('viewShipmentProductsTotal').textContent = formatPriceWithCurrency(shipment.productsSubtotal || 0);
            document.getElementById('viewShipmentProductsVAT').textContent = formatPriceWithCurrency(shipment.productsVATTotal || 0);
            document.getElementById('viewShipmentLogisticsTotal').textContent = formatPriceWithCurrency(shipment.logisticsSubtotal || 0);
            document.getElementById('viewShipmentLogisticsVAT').textContent = formatPriceWithCurrency(shipment.expenses?.logisticsVATAmount || 0);
            document.getElementById('viewShipmentCommission').textContent = formatPriceWithCurrency(shipment.commission || 0);
            document.getElementById('viewShipmentCostPrice1').textContent = shipment.costPrice1;
            document.getElementById('viewShipmentCostPrice2').textContent = shipment.costPrice2;

            // Примечание
            const noteSection = document.getElementById('viewShipmentNoteSection');
            if (shipment.note) {
                noteSection.style.display = 'block';
                document.getElementById('viewShipmentNote').textContent = shipment.note;
            } else {
                noteSection.style.display = 'none';
            }

            // Показываем модальное окно
            document.getElementById('shipmentViewModal').style.display = 'block';
        }

        function closeShipmentViewModal() {
            document.getElementById('shipmentViewModal').style.display = 'none';
            window.currentViewingShipmentId = null;
        }

        // Удаление поставки
        function deleteShipment() {
            if (!window.currentViewingShipmentId) return;

            const shipment = window.shipments.find(s => s.id === window.currentViewingShipmentId);
            if (!shipment) return;

            if (!confirm(`Удалить поставку ${shipment.number}? Количество товаров на складе будет уменьшено.`)) return;

            // Читаем группы из правильного localStorage
            let groups = JSON.parse(localStorage.getItem('productGroups') || '[]');
            
            // Отменяем изменения на складе с пересчетом себестоимости
            shipment.items.forEach(item => {
                const groupIndex = groups.findIndex(g => String(g.id) === String(item.groupId));
                if (groupIndex !== -1) {
                    const group = groups[groupIndex];
                    const qtyToRemove = group.quantityType === 'pieces' ? item.quantity : item.quantityInGrams;
                    group.currentQuantity = Math.max(0, (group.currentQuantity || 0) - qtyToRemove);
                    
                    // Удаляем запись из истории поступлений
                    if (group.additions) {
                        group.additions = group.additions.filter(a => a.shipmentId !== shipment.id);
                    }
                    
                    // Пересчитываем себестоимость на основе оставшихся поставок
                    recalculateGroupCostPrice(group);
                }
            });

            window.productGroups = groups;
            localStorage.setItem('productGroups', JSON.stringify(groups));

            // Удаляем поставку
            window.shipments = window.shipments.filter(s => s.id !== window.currentViewingShipmentId);
            localStorage.setItem('shipments', JSON.stringify(window.shipments));

            closeShipmentViewModal();
            renderShipmentsList();
            
            if (typeof renderWarehouseGroups === 'function') {
                renderWarehouseGroups();
            }

            showAlert('Поставка удалена', 'success');
            addLog(`Удалена поставка ${shipment.number}`);
        }

        // Пересчет средневзвешенной себестоимости группы
        function recalculateGroupCostPrice(group) {
            if (!group.additions || group.additions.length === 0) {
                group.costPrice1 = null;
                group.costPrice2 = null;
                return;
            }

            // Фильтруем только поступления из поставок с ценой
            const shipmentsAdditions = group.additions.filter(a => a.type === 'shipment' && a.costPrice1);
            
            if (shipmentsAdditions.length === 0) {
                group.costPrice1 = null;
                group.costPrice2 = null;
                return;
            }

            // Средневзвешенная себестоимость по объему
            let totalWeight = 0;
            let weightedCost1 = 0;
            let weightedCost2 = 0;

            shipmentsAdditions.forEach(addition => {
                const qty = addition.quantity || 0; // в граммах
                const cost1 = addition.costPrice1 || 0;
                const cost2 = addition.costPrice2 || 0;
                
                totalWeight += qty;
                weightedCost1 += qty * cost1;
                weightedCost2 += qty * cost2;
            });

            if (totalWeight > 0) {
                group.costPrice1 = Math.round((weightedCost1 / totalWeight) * 100) / 100;
                group.costPrice2 = Math.round((weightedCost2 / totalWeight) * 100) / 100;
            }
        }

        // Редактирование поставки
        function editShipment() {
            if (!window.currentViewingShipmentId) return;

            const shipment = window.shipments.find(s => s.id === window.currentViewingShipmentId);
            if (!shipment) return;

            // Сохраняем ID редактируемой поставки
            window.editingShipmentId = shipment.id;

            // Закрываем просмотр
            closeShipmentViewModal();

            // Открываем форму добавления поставки
            const form = document.getElementById('shipmentFormSection');
            if (form.style.display === 'none') {
                toggleShipmentForm();
            }

            // Заполняем форму данными поставки
            document.getElementById('shipmentSendDate').value = shipment.sendDate || '';
            document.getElementById('shipmentReceiveDate').value = shipment.receiveDate || '';

            // Заполняем товары
            window.currentShipmentItems = [...shipment.items];
            renderShipmentItems();

            // Заполняем расходы
            if (shipment.expenses) {
                document.getElementById('shipmentDeliveryCost').value = shipment.expenses.delivery || '';
                document.getElementById('shipmentCustomsCost').value = shipment.expenses.customs || '';
                document.getElementById('shipmentSanitaryCost').value = shipment.expenses.sanitary || '';
                document.getElementById('shipmentOtherCost').value = shipment.expenses.other || '';
                document.getElementById('shipmentLogisticsVAT').value = shipment.expenses.vatRate || '20';
                
                // Показываем секцию логистики если есть расходы
                const logisticsSection = document.getElementById('shipmentLogisticsSection');
                if (logisticsSection.style.display === 'none') {
                    toggleShipmentLogistics();
                }
            }

            // Комиссия и примечание
            document.getElementById('shipmentCommission').value = shipment.commission || '';
            document.getElementById('shipmentNote').value = shipment.note || '';

            // Обновляем итоги
            updateShipmentTotals();

            // Меняем текст кнопки сохранения
            const saveBtn = document.querySelector('#shipmentFormSection button[onclick="saveShipment()"]');
            if (saveBtn) {
                saveBtn.innerHTML = '💾 Сохранить изменения';
            }

            showAlert('Редактирование поставки ' + shipment.number, 'info');
        }

        // Открытие модального окна редактирования группы склада
        async function openEditWarehouseGroupModal(groupId) {
            const group = productGroups.find(g => g.id === groupId || g.id === String(groupId));
            if (!group) {
                showAlert('Группа не найдена!', 'error');
                return;
            }

            document.getElementById('editGroupId').value = group.id;
            document.getElementById('editGroupCode').value = group.groupCode || '';
            document.getElementById('editGroupName').value = group.name || '';
            document.getElementById('editGroupSupplier').value = group.supplier || '';
            document.getElementById('editGroupQuantityType').value = group.quantityType || 'weight';
            document.getElementById('editGroupCurrentQuantity').value = group.currentQuantity || 0;
            document.getElementById('editGroupCostPrice1').value = group.costPrice1 || '';
            document.getElementById('editGroupCostPrice2').value = group.costPrice2 || '';
            document.getElementById('editGroupShipmentDate').value = group.shipmentDate || '';

            // Загружаем категории
            const categorySelect = document.getElementById('editGroupCategory');
            if (categorySelect) {
                // Если categoriesData ещё не загружены, загружаем
                if (typeof categoriesData === 'undefined' || categoriesData.length === 0) {
                    try {
                        categoriesData = await window.api.categories.getAll();
                    } catch (error) {
                        console.error('Ошибка загрузки категорий:', error);
                        categoriesData = [];
                    }
                }
                
                categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
                categoriesData.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    if (cat.name === group.category) option.selected = true;
                    categorySelect.appendChild(option);
                });
                
                // Загружаем субкатегории если есть категория
                if (group.category) {
                    await loadEditGroupSubcategories(group.subcategory);
                }
            }

            document.getElementById('editWarehouseGroupModal').style.display = 'block';
        }
        
        // Загрузка субкатегорий для редактирования
        async function loadEditGroupSubcategories(selectedSubcategory = null) {
            const categorySelect = document.getElementById('editGroupCategory');
            const subcategorySelect = document.getElementById('editGroupSubcategory');
            if (!categorySelect || !subcategorySelect) return;
            
            const selectedCategory = categorySelect.value;
            
            if (!selectedCategory) {
                subcategorySelect.innerHTML = '<option value="">Сначала выберите категорию</option>';
                return;
            }
            
            // Находим ID категории по имени
            const category = categoriesData.find(c => c.name === selectedCategory);
            if (!category) {
                subcategorySelect.innerHTML = '<option value="">Субкатегории не найдены</option>';
                return;
            }
            
            try {
                const subs = await window.api.subcategories.getByCategory(category.id);
                subcategorySelect.innerHTML = '<option value="">Выберите субкатегорию</option>';
                subs.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.name;
                    option.textContent = sub.name;
                    if (sub.name === selectedSubcategory) option.selected = true;
                    subcategorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки субкатегорий:', error);
                subcategorySelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }

        function closeEditWarehouseGroupModal() {
            document.getElementById('editWarehouseGroupModal').style.display = 'none';
        }

        // Сохранение изменений группы склада
        function saveWarehouseGroupChanges() {
            const groupId = document.getElementById('editGroupId').value;
            const groupIndex = productGroups.findIndex(g => String(g.id) === String(groupId));
            
            if (groupIndex === -1) {
                showAlert('Группа не найдена!', 'error');
                return;
            }

            const groupCode = document.getElementById('editGroupCode').value.trim().toUpperCase();
            const name = document.getElementById('editGroupName').value.trim();

            if (!groupCode || !name) {
                showAlert('Заполните код и название группы!', 'warning');
                return;
            }

            const group = productGroups[groupIndex];
            const oldName = group.name;

            group.groupCode = groupCode;
            group.name = name;
            group.supplier = document.getElementById('editGroupSupplier').value.trim();
            group.category = document.getElementById('editGroupCategory').value;
            group.subcategory = document.getElementById('editGroupSubcategory').value;
            group.quantityType = document.getElementById('editGroupQuantityType').value;
            group.currentQuantity = parseFloat(document.getElementById('editGroupCurrentQuantity').value) || 0;
            group.shipmentDate = document.getElementById('editGroupShipmentDate').value;
            
            // Себестоимость можно редактировать вручную
            const costPrice1 = document.getElementById('editGroupCostPrice1').value;
            const costPrice2 = document.getElementById('editGroupCostPrice2').value;
            group.costPrice1 = costPrice1 ? parseFloat(costPrice1) : null;
            group.costPrice2 = costPrice2 ? parseFloat(costPrice2) : null;

            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            window.productGroups = productGroups;

            closeEditWarehouseGroupModal();
            renderProductGroups();
            
            addLog(`Отредактирована группа товаров: ${oldName} → ${name}`);
            showAlert('Изменения сохранены!', 'success');
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            loadShipments();
        });
    </script>
    
    <!-- Модальное окно подтверждения удаления -->
    <div id="deleteConfirmModal" class="delete-confirm-modal">
        <div class="delete-confirm-content">
            <div class="delete-confirm-header">
                <span style="font-size: 32px;">🗑️</span>
                <h3>Подтверждение удаления</h3>
            </div>
            <div class="delete-confirm-body">
                <div class="delete-confirm-message" id="deleteConfirmMessage">
                    Вы уверены, что хотите удалить этот элемент?
                </div>
                <div class="delete-confirm-details" id="deleteConfirmDetails">
                    <!-- Детали будут добавлены динамически -->
                </div>
                <div class="delete-confirm-footer">
                    <button class="delete-confirm-btn-cancel" onclick="closeDeleteConfirmModal()">
                        ❌ Отмена
                    </button>
                    <button class="delete-confirm-btn-delete" id="deleteConfirmButton">
                        🗑️ Удалить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения статусов -->
    <div id="statusConfirmModal" class="delete-confirm-modal">
        <div class="delete-confirm-content">
            <div class="delete-confirm-header">
                <span style="font-size: 32px;">✅</span>
                <h3>Подтверждение статуса</h3>
            </div>
            <div class="delete-confirm-body">
                <div class="delete-confirm-message" id="statusConfirmMessage">
                    Вы уверены?
                </div>
                <div class="delete-confirm-details" id="statusConfirmDetails">
                    <!-- Детали будут добавлены динамически -->
                </div>
                <div class="delete-confirm-footer">
                    <button class="delete-confirm-btn-cancel" onclick="closeStatusConfirmModal()">
                        ❌ Нет
                    </button>
                    <button class="delete-confirm-btn-delete" id="statusConfirmButton" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                        ✅ Да
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Electron API Adapter -->
    <script src="tauri-adapter.js"></script>
    <script src="tauri-api-wrappers.js"></script></body>
</html>